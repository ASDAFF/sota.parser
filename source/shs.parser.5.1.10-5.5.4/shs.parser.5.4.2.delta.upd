BITRIX41   1212|/shs.parser/updater5.4.2.php|58bd623<?
if(IsModuleInstalled('shs.parser'))
{
	if (is_dir(dirname(__FILE__).'/install/components'))
		$updater->CopyFiles("install/components", "components/");

	if (is_dir(dirname(__FILE__).'/install/js'))
		$updater->CopyFiles("install/js", "js/shs.parser/");
}


/* 

// 
// Sample database update
//


if($updater->CanUpdateDatabase())
{
	if($updater->TableExists("b_iblock_element_property"))
	{
		if(!$DB->IndexExists("b_iblock_element_property", array("VALUE_NUM", "IBLOCK_PROPERTY_ID")))
		{
			$updater->Query(array(
				"MySQL" => "CREATE INDEX ix_iblock_element_prop_num ON b_iblock_element_property(VALUE_NUM, IBLOCK_PROPERTY_ID)",
				"MSSQL" => "CREATE INDEX IX_B_IBLOCK_ELEMENT_PROPERTY_4 ON B_IBLOCK_ELEMENT_PROPERTY(VALUE_NUM, IBLOCK_PROPERTY_ID)",
				"Oracle" => "CREATE INDEX IX_IBLOCK_ELEMENT_PROP_NUM ON B_IBLOCK_ELEMENT_PROPERTY(VALUE_NUM, IBLOCK_PROPERTY_ID)",
			));
		}
        }
	if($updater->TableExists("b_iblock_property"))
	{
		if(!$DB->IndexExists("b_iblock_property", array("UPPER(\"CODE\")")))
		{
			$updater->Query(array(
				"Oracle" => "CREATE INDEX ix_iblock_property_2 ON B_IBLOCK_PROPERTY(UPPER(CODE))",
			));
		}
        }
}

*/
?>56   58099|/shs.parser/lang/ru/admin/parser_edit.php|131a9561<?
$MESS ['parser_tab'] = "Парсер";
$MESS ['parser_settings_tab'] = "Дополнительные настройки";
$MESS ['parser_uniq_tab'] = "Обновление / Уникальность";
$MESS ['parser_save_error'] = "Ошибка сохранения парсера";
$MESS ['parser_title_add'] = "Добавление парсера";
$MESS ['parser_title_edit'] = "Редактирование парсера";
$MESS ['parser_list'] = "Список";
$MESS ['parser_list_title'] = "Список парсеров";
$MESS ['parser_add'] = "Добавить";
$MESS ['parser_copy'] = "Копировать";
$MESS ['parser_mnu_add'] = "Добавить новый парсер";
$MESS ['parser_mnu_copy'] = "Копировать парсер";
$MESS ['parser_delete'] = "Удалить";
$MESS ['parser_mnu_del_conf'] = "Удалить парсер?";
$MESS ['parser_mnu_del_conf'] = "Удалить парсер?";
$MESS ['parser_start'] = "Запустить";
$MESS ['parser_start_title'] = "Запустить парсер";
$MESS ['parser_stop'] = "Остановить";
$MESS ['parser_stop_title'] = "Остановить парсер";
$MESS ['parser_saved'] = "Парсер успешно сохранен.";
$MESS ['parser_act'] = "Активен:";
$MESS ['parser_name'] = "Название:";
$MESS ['parser_rss'] = "RSS канал:";
$MESS["parser_selector_preview_id_xml"] = "Селектор-атрибут, содержащий id товара:";
$MESS["parser_selector_id_xml_descr"] = "Если пусто, то товары выгружаться не будут. Например: id, [id]";
$MESS ['parser_rss_page'] = "URL страницы:";
$MESS ['parser_rss_catalog'] = "URL раздела каталога:";
$MESS ['parser_xml_catalog'] = "URL XML файла:";
$MESS ['parser_selector_catalog_xml_descr'] = "Например: offer. Далее все селектора в этой закладке идут относительно заданного параметра.";
$MESS ['parser_sort'] = "Сортировка:";
$MESS ['parser_iblock_id'] = "ID инфоблока:";
$MESS ['parser_iblock_id_catalog'] = "ID инфоблока-каталога:";
$MESS ['parser_section_id'] = "ID раздела:";
$MESS ['parser_selector'] = "Селектор контента:";
$MESS ['parser_selector_page'] = "Селектор новости на странице списка новостей:";
$MESS ['parser_selector_preview_catalog'] = "Селектор товара на странице каталога:";
$MESS ['parser_selector_preview_xml'] = "Селектор конкретного товара:";
$MESS ['parser_selector_detail_catalog'] = "Селектор товара на детальной странице:";
$MESS ['parser_first_url'] = "URL в rss ленте:";
$MESS ['parser_first_url_page'] = "URL на странице:";
$MESS ['parser_href_page'] = "Селектор ссылки:";
$MESS ['parser_href_descr_page'] = "Если ничего не задано, то переход по страницам будет осуществляться по первой найденной ссылке в селекторе списка новостей. Селектор указывается относительно селектора новости. <br/>Если селектор сам является ссылкой, то необходимо указать: a:parent";
$MESS ['parser_name_page'] = "Селектор наименования новости:";
$MESS ['parser_name_descr_page'] = "Если ничего не задано, то название новости будет браться, как текст селектора ссылки. Селектор указывается относительно селектора новости.";
$MESS ['parser_name_descr_xml'] = "Если наименование находится в атрибуте, то атрибут указываем в квадратных скобках, например: [name].";
$MESS ['parser_encoding'] = "Кодировка:";
$MESS ['parser_delete_tag'] = "Удалять все теги:";
$MESS ['parser_pagenavigation_tab'] = "Постраничная навигация";
$MESS ['parser_preview_tab'] = "Превью";
$MESS ['parser_selector_section_catalog'] = "Селектор одной категории:";
$MESS ['parser_attr_name_section_catalog'] = "Селектор-атрибут названия категории:";
$MESS ['parser_attr_category_descr'] = "Если пусто, то название берется из значения самой категории.";
$MESS ['parser_attr_id_section_catalog'] = "Селектор-атрибут, содержащий id категории:";
$MESS ['parser_attr_id_category_descr'] = "Если пусто, то категории не будут выгружаться. Например: categoryId, [id]";
$MESS ['parser_field_id_category_catalog'] = "Записывать id категории в:";
$MESS ['parser_field_id_category_descr'] = "Указывается поле, в которое будет записан id категории из xml.";
$MESS ['parser_attr_id_parrent_category_catalog'] = "Селектор-атрибут, содержащий id родительской категории:";
$MESS ['field_xml_id'] = "внешний код раздела";
$MESS ['field_ext'] = "пользовательское поле раздела";
$MESS ['parser_attr_id_parrent_category_descr'] = "Если пусто, то категории будут выгружаться без сохранения вложенности. Например: parent, [parentId]";
$MESS ['parser_selector_section_descr'] = "Указывается селектор одной категории. Если пусто, то категории товаров выгружаться не будут.";
$MESS ['parser_basic_settings_tab'] = "Основные настройки";
$MESS ['parser_detail_tab'] = "Детально";
$MESS ['parser_preview_delete_tag'] = "Удалять теги:";
$MESS ['parser_preview_delete_tag_descr'] = htmlspecialcharsEx('Пример: "<div>", "<p>", "<br>"');
$MESS ['parser_page_uniq'] = "Уникализация по:"; 
$MESS ['parser_page_uniq_url'] = "Урлу";
$MESS ['parser_page_uniq_name'] = "Названию";

$MESS ['parser_detail_delete_tag'] = "Удалять теги:";
$MESS ['parser_preview_text_type'] = "Тип поля:";
$MESS ['parser_detail_text_type'] = "Тип поля:";
$MESS ['parser_bool_preview_delete_tag'] = "Кроме следующих:";
$MESS ['parser_bool_detail_delete_tag'] = "Кроме следующих:";
$MESS ['parser_preview_delete_element'] = "Удалять элементы:";
$MESS ['parser_detail_delete_element'] = "Удалять элементы:";
$MESS ['parser_preview_delete_attribute'] = "Удалять атрибуты элементов:";
$MESS ['parser_detail_delete_attribute'] = "Удалять атрибуты элементов:";
$MESS ['parser_preview_first_img'] = "Первая картинка как превью:";
$MESS ['parser_detail_first_img'] = "Первая картинка как детальная:";
$MESS ['parser_preview_first_img_catalog'] = "Селектор-атрибут превью картинки:";
$MESS ['parser_preview_first_img_xml'] = "Селектор-атрибут превью картинки:";
$MESS ['parser_detail_first_img_catalog'] = "Селектор-атрибут детальной картинки:";
$MESS ['parser_detail_first_img_xml'] = "Селектор-атрибут детальной картинки:";
$MESS ['parser_preview_save_img'] = "Заменять пути/сохранять картинки на сервер:";
$MESS ['parser_detail_save_img'] = "Заменять пути/сохранять картинки на сервер:";
$MESS ['parser_index_element'] = "Индексировать элементы в поиске:";
$MESS ['parser_code_element'] = "Создавать символьный код из названия:";
$MESS ['parser_resize_image'] = "Использовать настройки инфоблока для обработки изображений:";
$MESS ['parser_create_sitemap'] = "По окончании создавать карту сайта:";
$MESS ['parser_meta_description'] = "Парсить мета-описание страниц:";
$MESS ['parser_meta_keywords'] = "Парсить ключевые слова страниц:";
$MESS ['parser_meta_description_text'] = "Описание страницы:";
$MESS ['parser_meta_keywords_text'] = "Ключевые слова:";
$MESS ['parser_meta_title'] = "Парсить заголовок страниц:";
$MESS ['parser_first_title'] = "Записывать ссылку на первоисточник:";
$MESS ['parser_meta_description'] = "Парсить мета-описание страниц:";
$MESS ['parser_meta_keywords'] = "Парсить ключевые слова страниц:";
$MESS ['parser_start_agent'] = "Запускать по агенту:";
$MESS ['parser_time_agent'] = "Периодичность запуска(в секундах):";
$MESS ['parser_active_element'] = "Создавать активные элементы:";
$MESS ['parser_start_last_time'] = "Время последнего запуска:";
$MESS ['parser_sleep'] = "Время задержки(сек):";
$MESS ['parser_sleep_descr'] = "Некоторые сайты осуществляют контроль активности, то есть, если количество обращений к сайту за единицу времени будет более установленного значения, то пользователь будет блокирован. Для обхода данной защиты установите временные задержки между обращениями парсера к сайту.:";

$MESS ['parser_sleep_descr_xml'] = "Некоторые сайты осуществляют контроль активности, то есть, если количество обращений к сайту за единицу времени будет более установленного значения, то пользователь будет блокирован. Для обхода данной защиты установите временные задержки между обращениями парсера к сайту. Актуальна только при удаленном размещении XML файла.";

$MESS ['parser_selector_descr'] = 'Полный путь к селектору контента обозначается аналогично JQuery. <br/>Примеры: div#simpleid div.content; div#simpleid div.content:eq(0); div#simpleid div.content[style="margin-top:30px"]:eq(1)';
$MESS ['parser_first_url_descr'] = 'Не обязательное поле. Применяется, если rss лента включает в себя информацию с различных источников. Это поле позволяет указать URL, по которому будет производиться парсинг. То есть парсинг будет осуществляться, если в rss ленте будут найдены совпадения по указанному урлу. Пример: 1с-bitrix.ru(без указания www и http)';
$MESS ['parser_first_url_descr_page'] = 'Не обязательное поле. Применяется, если страница включает в себя информацию с различных источников. Это поле позволяет указать URL, по которому будет производиться парсинг. То есть парсинг будет осуществляться, если на странице будут найдены совпадения по указанному урлу. Пример: 1с-bitrix.ru(без указания www и http)';


$MESS ['parser_encoding_descr'] = "Кодировка сайта, который собираемся парсить. Определяется автоматически. Если не определена, то будет учитываться именно установленное вами значение.";

$MESS ['parser_preview_first_img_descr'] = "Картинка для превью будет браться первой из описания. Если таковой нет, то будет произведен поиск по всем атрибутам rss элементов потока.";
$MESS ['parser_preview_save_img_descr'] = "Сохранять все картинки из описания на сервер и заменять их пути своими.";
$MESS ['parser_preview_delete_element_descr'] = 'Удаляет перечисленные элементы. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a, div.simpleclass:eq(5), div.simpleclass[align="left"]:eq(0)';
$MESS ['parser_preview_delete_attribute_descr'] = 'Удаляет перечисленные атрибуты элементов. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a[href]';

$MESS ['parser_detail_first_img_descr'] = "Картинка для превью будет браться первой из контента.";
$MESS ['parser_detail_save_img_descr'] = "Сохранять все картинки из описания на сервер и заменять их пути своими.";
$MESS ['parser_detail_delete_element_descr'] = 'Удаляет перечисленные элементы. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a, div.simpleclass:eq(5), div.simpleclass[align="left"]:eq(1)';
$MESS ['parser_detail_delete_attribute_descr'] = 'Удаляет перечисленные атрибуты элементов. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a[href]';
$MESS["parser_category_select"] = "Выберите категорию парсера";
$MESS["parser_category_title"] = "Категория:";
$MESS ['parser_prop_id'] = "Выбор свойства из списка";
$MESS ['parser_date_type'] = "Выбор типа даты";
$MESS ['parser_date_public'] = "Записывать дату публикации:";
$MESS ['parser_date_active'] = "Устанавливать дату начала активности:";
$MESS ['parser_date_active_now'] = "Текущая дата";
$MESS ['parser_date_active_now_time'] = "Текущая дата и время";
$MESS ['parser_date_active_public'] = "Дата публикации в источнике";
$MESS ['parser_demo'] = "Модуль \"Парсер контента\" работает в демо-режиме.";

$MESS ['parser_type'] = "Тип парсера:";
$MESS ['parser_catalog_message'] = "Функционал парсинга каталога будет реализован в новом 2104 году! Следите за новостями и подписывайтесь на обновления модуля. Компания «Сотбит» работает для Вас.";

$MESS ['parser_pagenavigation_selector'] = "Селектор навигации:";
$MESS ['parser_pagenavigation_begin'] = "Начинать со страницы:";
$MESS ['parser_pagenavigation_one'] = "Селектор-атрибут пункта навигации:";
$MESS ['parser_pagenavigation_selector_descr'] = "Пример: .pagenavigation";
$MESS ['parser_pagenavigation_one_descr'] = "Задается относительно предыдущего параметра. Например: a[href]. Если поле пустое или нет атрибута, то по умолчанию a[href]. Если ссылка отсутствует и постраничная навигация отрабатывается скриптами, то необходимо воспользоваться блоком Работа с постраничной навигацией, расположенным ниже.";
$MESS ['parser_pagenavigation_delete'] = "Удалять элементы навигации:";
$MESS ['parser_preview_text_selector'] = "Селектор превью описания:";
$MESS ['parser_xml_text_selector'] = "Селектор-атрибут описания:";
$MESS ['parser_detail_text_selector'] = "Селектор детального описания:";
$MESS ['parser_selector_catalog_descr'] = "Пример: .catalog-section. Далее все селектора в этой закладке идут относительно заданного параметра ";
$MESS ['parser_selector_detail_catalog_descr'] = "Пример: .catalog-detail. Далее все селектора в этой закладке идут относительно заданного параметра ";
$MESS ['parser_preview_text_type_catalog'] = "Тип превью описания:";
$MESS ['parser_preview_delete_tag_catalog'] = "Удалять теги из описания:";
$MESS ['parser_preview_first_img_descr_catalog'] = "По умолчанию img:eq(0)[src]. Если картинка находится в другом элементе или атрибуте, то записываем, например: a:eq(0)[href]";
$MESS ['parser_preview_first_img_descr_xml'] = "Если картинки находится в атрибуте, то атрибут указываем в квадратных скобках, например: picture:eq(0), picture:eq(0)[src].";
$MESS ['parser_detail_first_img_descr_catalog'] = "По умолчанию img:eq(0)[src]. Если картинка находится в другом элементе или атрибуте, то записываем, например: a:eq(0)[href]. Также может возникнуть ситуация, когда селекторы детальной картинки могут отличаться в зависимости от ряда условия(одна картинка или их несколько). В этом случае перечисление селекторов идет через запятую.";
$MESS ['parser_detail_text_type_catalog'] = "Тип детального описания:";
$MESS ['parser_preview_price'] = "Селектор цены:";
$MESS ['parser_preview_price_xml'] = "Селектор-атрибут цены:";
$MESS ['parser_categoryId_catalog'] = "Селектор-атрибут категории товара:";
$MESS ['parser_selector_description_xml_descr'] = "Если описание находится в атрибуте, то атрибут указываем в квадратных скобках, например: description[name].";
$MESS ['parser_props_tab'] = "Свойства";
$MESS ['parser_preview_price_descr'] = "Если пустое, то селектор цены надо указывать на детальной странице товара. Если оба поля заполнены, то предпочтение отдается детальной странице.";
$MESS ['parser_preview_price_descr_xml'] = "Если цена находится в атрибуте, то атрибут указываем в квадратных скобках, например: [price].";
$MESS ['parser_price_type'] = "Тип цены:";
$MESS ['parser_currency'] = "Валюта:";
$MESS ['parser_catalog_tab'] = "Торговый каталог";
$MESS ['parser_catalog_koef'] = "Коэффициент единицы измерения:";
$MESS ['parser_measure'] = "Единица измерения:";

$MESS ['parser_href_catalog'] = "Селектор ссылки товара:";
$MESS ['parser_name_catalog'] = "Селектор названия товара:";
$MESS ['parser_name_catalog_xml'] = "Селектор-атрибут названия товара:";
$MESS ['parser_href_descr_catalog'] = "Если ничего не задано, то переход по страницам будет осуществляться по первой найденной ссылке в селекторе списка товаров. Селектор указывается относительно селектора товара.";
$MESS ['parser_categoryId_descr_catalog'] = "Айди категории, к которой будет прикреплен товар. Если айди находится в атрибуте, то атрибут указываем в квадратных скобках, например: [categoryId].";
$MESS ['parser_name_descr_catalog'] = "Если ничего не задано, то название товара будет браться, как текст селектора ссылки. Селектор указывается относительно селектора товара.";
$MESS ['parser_size_selector'] = "Парсинг размеров по селектору";

$MESS ['parser_size_length'] = "Длина, мм:";
$MESS ['parser_size_width'] = "Ширина, мм:";
$MESS ['parser_size_height'] = "Высота, мм:";
$MESS ['parser_size_weight'] = "Вес, гр:";
$MESS ['parser_selector_size_descr'] = "Парсинг размеров будет осуществляться по конкретным селекторам. Селектора идут относительно главного селектора товара. Также можно удалить лишние символы(двоеточие, точки с запятой и подобные). При удалении символы чередуются через запятую. Если необходимо удалить запятую, то дважды экранируем ее(\\\,).";

$MESS ['parser_size_find'] = "Парсинг размеров по названию";
$MESS ['parser_selector_find'] = "Селектор перечисления размеров:";
$MESS ['parser_find_size_descr'] = "Парсинг осуществляется по селектору перечисления размеров. И уже в нем осуществляется поиск размеров по конкретным названиям. Также можно удалить лишние символы(ед. измерения, двоеточия, точки с запятой и подобные). При удалении символы чередуются через запятую. Если необходимо удалить запятую, то дважды экранируем ее(\\\,).";

$MESS ['parser_more_image'] = "Доп. картинки";
$MESS ['parser_selector_more_image'] = "Селектор-атрибут перечисления доп. картинок:";
$MESS ['parser_selector_more_image_xml'] = "Селектор-атрибут перечисления доп. картинок:";
$MESS ['parser_selector_more_image_descr'] = "Пример: .image_list img[src]";
$MESS ['parser_selector_more_image_xml_descr'] = "Если картинки находится в атрибуте, то атрибут указываем в квадратных скобках, например: picture, picture[src].";

$MESS ['parser_selector_props'] = "Парсинг свойств из деталки по селектору";
$MESS ['parser_selector_props_xml'] = "Парсинг свойств по селектору";
$MESS ['parser_more_image_prop'] = "Свойство доп. картинок:";
$MESS ['parser_find_props'] = "Парсинг свойств из деталки по названию";
$MESS ['parser_find_props_xml'] = "Парсинг свойств и автоматическое создание";
$MESS ['parser_add_auto_props'] = "Автоматическое создание свойств:";
$MESS ['parser_add_auto_props_descr'] = "При включении несуществующие свойства будут создаваться автоматически, исходя из настроек ниже. ";
$MESS ['parser_selector_props_preview'] = 'Парсинг свойств из превью по селектору';
$MESS ['parser_find_props_preview'] = 'Парсинг свойств из превью по названию';
$MESS ['parser_selector_find_props'] = "Селектор перечисления свойств:";
$MESS ['parser_selector_find_props_xml'] = "Селектор перечисления свойств:";
$MESS ['parser_attr_auto_props'] = "Селектор-атрибут названия свойства:";
$MESS ['parser_attr_auto_props_descr'] = "Укажите селектор-атрибут, в котором находится название свойства.<br /><br />Если название свойства находится в атрибуте \"Селектор перечисления свойств:\", то укажите этот атрибут, например: [name]. <br /> Во всех остальных случаях укажите селектор и атрибут, например: value[name], или просто селектор, например: value<br /><br />
Если свойство или несколько свойств с таким названием существует, то текущее значение будет записано во все свойства. Поиск свойств по названию происходит среди свойств типа S - строка, N - числовое и L - список.";
$MESS ['parser_type_list'] = "[L]-список";
$MESS ['parser_selector_attr_value_auto_props'] = "Селектор-атрибут значения свойства:";
$MESS ['parser_selector_attr_value_auto_props_descr'] = "Если пусто, то значение свойства будет браться как текст из \"Селектор перечисления свойств.\"<br />Если значение свойства находиться в атрибуте \"Селектор перечисления свойств\", то укажите атрибут, например: [value]<br /><br />Во всех остальных случаях укажите селектор и атрибут, например: value, value_props[value]";

$MESS ['parser_uniq_descr_xml'] = "По умолчанию при выгрузке товаров заполняется внешний код XML_ID элемента, как md5(название+id элемента xml файла). Далее при обновлении уникализация осуществляется именно по внешнему коду. <br/><br /><b>Внимание! Если вы не хотите делать запись во внешний код и уникализировать по нему товар, то укажите, по какому полю производить уникализацию элементов. В этом случае внешний код XML_ID затираться не будет.</b>";

$MESS ['parser_type_string'] = "[S]-строка";
$MESS ['parser_category_description'] = "Категории";
$MESS ['parser_offer_description'] = "Товары";
$MESS ['parser_mode'] = "Режим парсера:";
$MESS ['parser_mode_descr'] = "При debug режиме осуществляется парсинг первых 3 страниц и 3 товаров каждой страницы. Debug режим необходим для отладки парсера. В рабочий режим парсер необходимо переводить, если вы полностью отладили и настроили парсинг!!!<br/><b>Работа парсера в демо-режиме ограничена и фактически аналогична работе парсера в debug режиме.</b>"; 

$MESS ['parser_header_uniq'] = "Проверка уникальности";
$MESS ['parser_uniq_update'] = "Обновлять товары";
$MESS ['parser_header_uniq_field'] = "Обновлять поля";
$MESS ['parser_header_uniq_field_preview_descr'] = "Превью описание:";
$MESS ['parser_header_uniq_field_detail_descr'] = "Детальное описание:";
$MESS ['parser_header_uniq_field_preview_img'] = "Превью картинка:";
$MESS ['parser_header_uniq_field_detail_img'] = "Детальное картинка:";
$MESS ['parser_header_uniq_field_price'] = "Цена:";
$MESS ['parser_header_uniq_field_name'] = "Наименование:";
$MESS ['parser_header_uniq_field_descr'] = "Отмеченные поля будут обновляться при обновлении товаров.";
$MESS ['parser_uniq_name'] = "По названию:";
$MESS ['parser_uniq_prop'] = "По свойству:";
//$MESS ['parser_uniq_descr'] = "По умолчанию уникальность элементов проверяется по md5 от названия элемента и урла первоисточника. Эти данные заносятся в XML_ID и далее уже по XML_ID проверяется уникальность. Вы можете изменить поля, по которым будет проверяться уникальность. Если выбрано несколько полей, то проверка уникальности будет по логике И. Если вы не хотите использовать поле XML_ID для проверки уникальности(как по умолчанию), то вам надо переопределить, по каким полям будет проверяться уникальность.";
$MESS ['parser_uniq_descr'] = "По умолчанию при выгрузке товаров заполняется внешний код XML_ID элемента, как md5(название+url страницы). Далее при обновлении уникализация осуществляется именно по внешнему коду. <br/><b>Внимание! Если вы не хотите делать запись во внешний код и уникализировать по нему товар, то укажите, по какому полю производить уникализацию элементов. В этом случае внешний код XML_ID затираться не будет.</b>";


$MESS ['parser_preview_from_detail'] = "Создавать превью картинку из детальной:";
$MESS ['parser_preview_from_detail_text'] = "Создавать превью описание из детального:";
$MESS ['parser_catalog_delete_symb'] = "Удалять символы:";
$MESS ['parser_delete_symb_descr'] = "Удаление символов позволяет удалять лишние символы из общего селектора свойства(названия ед. измерения, двоеточия, точки с запятой и подобное). Перечисление идет через запятую. Если необходжимо удалить саму запятую, то производим двойное экранирование(\\\,).";

$MESS ['parser_delete_symb_xml_descr'] = "Удаление символов позволяет удалять лишние символы из свойства(названия ед. измерения, двоеточия, точки с запятой и подобное). Перечисление идет через запятую. Если необходжимо удалить саму запятую, то производим двойное экранирование(\\\,).";
$MESS ['parser_delete_symb_descr_offer'] = "Удаление символов позволяет удалять лишние символы из общего селектора свойства(названия ед. измерения, двоеточия, точки с запятой и подобное). Перечисление идет через ||.<br><br>Также возможно указание регулярных выражений. Регулярка заключается в кавычки //. Пример: /(.)*/";

$MESS ['parser_header_uniq_field_more_img'] = "Доп. картинки:";
$MESS ['parser_cat_vat_id'] = "Ставка НДС:";
$MESS ['parser_cat_vat_included'] = "Включать НДС в цену:";
$MESS ['parser_proxy'] = "Прокси-сервер:";
$MESS ['parser_proxy_descr'] = "Указывается прокси-сервер. Пример: 109.194.20.27:3128";
$MESS ['parser_header_uniq_field_param'] = "Параметры каталога:";
$MESS ['parser_header_uniq_field_props'] = "Свойства товара:";
$MESS ['parser_pagenavigation_end'] = "по страницу:";
$MESS ['parser_pagenavigation_begin_descr'] = "Если ничего не задано, то будет парсится весь раздел каталога.";
$MESS ['parser_404_error'] = "Парсить при возникновении 404 ошибки:";
$MESS ['parser_404_descr'] = "Некоторые сайты при переходе по страницам навигации отдают 404 ошибку из-за SEO заморочек. Именно для таких случаев и предназначен выше приведенный параметр.";
$MESS ['parser_logs_tab'] = "Логи";
$MESS ['parser_header_logs'] = "Включить логирование:";
$MESS ['parser_header_logs_download'] = "Скачать лог:"; 
$MESS ['parser_header_log_descr'] = "Производится логирование последней выгрузки. Лог записывается файл."; 
$MESS ['btn_stop_catalog'] = "Остановить";
$MESS ['parser_load_page'] = "Обработано страниц: ";    
$MESS ['parser_load_product'] = " Импортировано товаров: ";
$MESS ['parser_load_product_error'] = " Из них с ошибками: ";
$MESS ['parser_all_error'] = " Всего ошибок: ";
$MESS['parser_instructions'] = "Инструкция";
$MESS['parser_instructions_title'] = "Инструкция пользователя";
$MESS['parser_loading_end'] = "Загрузка завершена"; 

$MESS['parser_update_N'] = "Не обновлять";
$MESS['parser_update_Y'] = "Обновлять";
$MESS['parser_update_empty'] = "Обновлять пустое значение";

$MESS['parser_work_price'] = "Работа с ценами";

$MESS['parser_price_terms_no'] = "Без условия";
$MESS['parser_price_terms_up'] = "Если цена выше";
$MESS['parser_price_terms_down'] = "Если цена ниже";
$MESS['parser_price_updown_no'] = "Не изменять";
$MESS['parser_price_updown_up'] = "Увеличить";
$MESS['parser_price_updown_down'] = "Уменьшить";
$MESS['parser_price_percent'] = "Проценты";
$MESS['parser_price_abs_value'] = "Абсолютная величина";
$MESS['parser_price_updown'] = 'Изменять цену:';
$MESS['parser_price_terms'] = 'Условие изменения цены:';
$MESS['parser_price_type_value'] = 'Тип изменения:';
$MESS['parser_price_value'] = 'Величина изменения:';
$MESS['parser_convert_currency'] = 'Конвертировать в валюту:'; 
$MESS['parser_convert_no'] = 'Нет';
$MESS['parser_step'] = 'Количество товаров, выгружаемых за один шаг парсера:';
$MESS['parser_start_agent_descr'] = 'Рекомендуется запускать агенты из под крона.';
$MESS['parser_auth'] = 'Авторизация';
$MESS['parser_auth_active'] = 'Производить авторизацию на стороннем сайте:';
$MESS['parser_auth_url'] = 'URL авторизационной страницы:';
$MESS['parser_auth_url_descr'] = 'URL страницы, на которой происходит авторизация. Если пустое, то авторизация происходит на странице раздела.';
$MESS['parser_auth_url_xml_descr'] = 'URL страницы, на которой происходит авторизация.';
$MESS['parser_auth_selector'] = 'Селектор формы авторизации:';
$MESS['parser_auth_login'] = 'Логин:';
$MESS['parser_auth_login_name'] = 'Имя поля логина:';
$MESS['parser_auth_password'] = 'Пароль:';
$MESS['parser_auth_password_name'] = 'Имя поля пароля:';
$MESS['parser_auth_password_descr'] = 'Если форма авторизации стандартная, то по-умолчанию достаточно указать лишь логин и пароль. Если же для авторизации не используются такие типы полей, как text, password, то необходимо указать имена полей.';
$MESS['parser_auth_check'] = 'Проверить авторизацию';
$MESS['parser_work_price_num'] = 'Условие';
$MESS['parser_price_num_add'] = 'Добавить условие';
$MESS['parser_price_num_del'] = 'Удалить условие';
$MESS['parser_price_terms_delta'] = 'Если цена в промежутке';
$MESS['parser_price_from'] = 'От';
$MESS['parser_price_to'] = 'До';
$MESS['parser_auth_no'] = 'Неудачная авторизация. Ключи доступа не подходят.';
$MESS['parser_auth_ok'] = 'Авторизация прошла успешно. Ключи доступа актуальные.';
$MESS['parser_auth_error_selector'] = 'Селектор формы авторизации не определен.';
$MESS['parser_selector_find_descr'] = 'Если общий селектор отсутствует и перечисление идет через тег &lt;br&gt;, то пишем примерно следующее: .props br';
$MESS['parser_selector_find_xml_descr'] = 'Укажите селектор, который является контейнером для одного свойства. Например: param';
$MESS['type_add_auto_props'] = 'Выберите тип создаваемых свойств:';
$MESS['type_add_auto_props_description'] = 'Все созданные свойства будут иметь указанный тип. S - строка, L - список. Если свойство уже есть в системе, то оно не будет менять свой тип.';
$MESS['parser_detail_name'] = 'Селектор названия товара';
$MESS['parser_detail_name_descr'] = 'Если указан, то селектор названия товара в превьюшке будет игнорироваться.';

$MESS['parser_cat_price_offer'] = 'Цены только в инфоблоке торговых предложений:';
$MESS['parser_url_dop'] = 'Дополнительные урлы разделов:';
$MESS['parser_url_xml_dop'] = 'Дополнительные урлы XML файлов:';
$MESS['parser_add_section'] = "Создавать разделы из XML файла";
$MESS['parser_url_dop_descr'] = 'Поле предназначено для парса нескольких разделов одновременно. Каждый урл пишется с новой строки.';
$MESS['parser_url_dop_descr_xml'] = 'Поле предназначено для парса нескольких XML файлов одновременно. Каждый урл файла пишется с новой строки.';
$MESS['parser_add_section_descr'] = 'При включении парсер создаст категории внутри инфоблока и распределит товары согласно данным из XML.';
$MESS['parser_prop_default'] = "Значение по умолчанию";

$MESS ['parser_video_tab'] = "Видео-инструкции";
$MESS ['parser_video_catalog_descr'] = "Видео-урок: Парcер контента в режиме работы с каталогами. Сотбит. 1С-Битрикс.";
$MESS ['parser_video_xml_descr'] = "Видео-урок: Парcер контента в режиме работы с xml. Сотбит. 1С-Битрикс.";
$MESS ['parser_video_page_descr'] = "Видео-урок: Парcер контента в режиме работы с новостными страницами. Сотбит. 1С-Битрикс.";
$MESS ['parser_video_rss_descr'] = "Видео-урок: Парcер контента в режиме работы с rss лентами. Сотбит. 1С-Битрикс. ";

$MESS ['parser_price_format'] = "Формат цены(разделители):";
$MESS ['parser_price_format1'] = " тысячи ";
$MESS ['parser_price_format2'] = " копейки ";
$MESS ['parser_price_format_descr'] = "Заполняется в том случае, если цена состоит из тысяч и копеек со своими разделителями. В большинстве случаев можно оставлять пустым.";

$MESS["shs_parser_select_prop"] = "Выберите свойство";
$MESS["shs_parser_select_prop_new"] = "[Создать]";
$MESS["parser_iblock_id_descr"] = "При изменении инфоблока необходимо сохранить настройки.";
$MESS["parser_price_okrug"] = "Округление цены:";
$MESS["parser_price_okrug_no"] = "Не округлять";
$MESS["parser_price_okrug_up"] = "Округлять с указанной точностью";
$MESS["parser_price_okrug_ceil"] = "Округление в большую сторону до целого";
$MESS["parser_price_okrug_floor"] = "Округление в меньшую сторону до целого";
$MESS["parser_price_okrug_delta1"] = "до";
$MESS["parser_price_okrug_delta2"] = "знаков после запятой";
$MESS["parser_price_okrug_descr"] = "Округления до целых чисел точность(количество знаков после запятой) не учитывают.";

$MESS["shs_parser_select_prop_but"] = "Добавить";
$MESS["parser_prop_detail_preview_descr"] = "Внимание! Свойства, выгруженные с детальной страницы, являются приоритетными.";
$MESS["parser_prop_detail_preview_descr_file"] = "<br/><br/>При парсинге свойств по селектору возможен парсинг свойств типа файл(F). Для этого необходимо указать селектор элемента и атрибут, например: .instructions[href]<br><br>Также возможен парсинг свойств из атрибутов элементов: a[title], img[title].";
$MESS["parser_prop_detail_preview_descr_file_xml"] = "Если значение свойства находится непосредственно в селекторе, то пишем, например, следующее: param, если значение свойства находится в атрибуте, то например: param[title]";
$MESS["parser_offer_tab"] = "Торговые предложения";
$MESS["parser_offer_selector"] = "Главный селектор контейнера торговых предложений:";
$MESS["parser_offer_selector_item"] = "Селектор отдельного оффера:";
$MESS["parser_offer_table_desc"] = "Торговые предложения табличного вида";
$MESS["parser_offer_load_no"] = "Не выгружать";
$MESS["parser_offer_load_table"] = "Выгружать из табличного вида";
$MESS["parser_offer_load"] = "Выгружать офферы:";
$MESS["parser_offer_selector_head"] = "Селектор блока шапки таблицы:";
$MESS["parser_offer_selector_head_th"] = "Селектор наименования параметра в шапке таблицы:";
$MESS["parser_offer_selector_head_th_descr"] = "Необходим, если поля и свойства определяются по названию. Относительно предыдущего поля. Пример: th, td";
$MESS["parser_offer_selector_item_td"] = "Селектор значения параметра в теле таблицы:";
$MESS["parser_offer_selector_item_td_descr"] = "Необходим, если поля и свойства определяются по названию. Считается относительно предыдущего поля. Пример: td";
$MESS["parser_offer_parsing_selector"] = "Парсинг полей и свойств по селектору";
$MESS["parser_offer_parsing_find"] = "Парсинг полей и свойств по названию";
$MESS["parser_offer_parsing_selector_name"] = "Наименование:";
$MESS["parser_offer_parsing_selector_price"] = "Цена:";
$MESS["parser_offer_load_descr"] = "После изменения параметра необходимо Применить настройки.";
$MESS["parser_offer_selector_descr"] = "Относительно селектора товара на детальной странице. Пример: table, .mainOfferTable";
$MESS["parser_offer_selector_head_descr"] = "Необходим, если поля и свойства определяются по названию. Считается относительно предыдущего параметра. Данный параметр необходим, если парсинг полей и свойств осуществляется по названию. Пример: thead tr, tr:eq(0)";
$MESS["parser_offer_selector_item_descr"] = "Считается относительно главного контейнера офферов. Пример: tbody tr, tr:eq(0)+tr";
$MESS["parser_offer_parsing_selector_prop"] = "Парсинг свойств по селектору";
$MESS["parser_offer_table_desc_1"] = "Артикул";
$MESS["parser_offer_table_desc_2"] = "Цвет";
$MESS["parser_offer_table_desc_3"] = "Формат, мм";
$MESS["parser_offer_table_desc_4"] = "Кол-во страниц";
$MESS["parser_offer_table_desc_5"] = "Кол-во языков";
$MESS["parser_offer_table_desc_6"] = "Плотность бумаги";
$MESS["parser_offer_table_desc_7"] = "Блок";
$MESS["parser_offer_table_desc_8"] = "Цена (без НДС), руб.";
$MESS["parser_offer_table_desc_9"] = "коричневый";
$MESS["parser_offer_table_desc_10"] = "70 г/м";
$MESS["parser_offer_table_desc_11"] = "шитый";
$MESS["parser_offer_table_desc_12"] = "А5";
$MESS["parser_offer_parsing_find_prop"] = "Парсинг свойств по названию";
$MESS["parser_header_element_action"] = "Действия над элементами";
$MESS["parser_element_action"] = "Что делать с товарами, присутствующими в предыдущей выгрузке и отсутствующими в текущей:";
$MESS["parser_offer_add_name"] = "Параметр уникализации офферов:";
$MESS["parser_default_props"] = "Значения свойств по умолчанию";
$MESS["parser_action_N"] = "ничего";
$MESS["parser_action_A"] = "деактивировать";
$MESS["parser_action_D"] = "удалить";
$MESS["parser_add_delete_symb_props"] = "Добавление/удаление символов полей и свойств";
$MESS["parser_SOTBIT_PARSER_NAME_E"] = "Название товара";
$MESS["parser_action_props_delete"] = "Удалить";
$MESS["parser_action_props_add_begin"] = "Добавить в начало";
$MESS["parser_action_props_add_end"] = "Добавить в конец";
$MESS["shs_parser_select_action_props"] = "Выберите действие";
$MESS["shs_parser_action_props_descr"] = htmlspecialchars("Укажите необходимые символы или слова, если вы хотите удалить/добавить их к указанному полю или свойству. Если необходимо записать пробел, то укажите его спец. символ: &nbsp;")."<br><br>Внимание! Действия возможны только над свойствами и полями типа Строка(S)";
$MESS["parser_element_action_descr"] = "Работает в том случае, если отмечена галочка Обновлять товары. Товары из предыдущей выгрузки сравниваются с товарами из текущей. На основании этого и производятся действия над элементами.";
$MESS["parser_offer_add_name_descr"] = "<b>Важный параметр!!! Особенности:</b><br>1. Указанные свойства добавляются в название оффера.<br>2. Если название оффера отсутствует, то название полностью будет состоять из значений указанных свойств.<br>3. По данному параметру происходит уникализации офферов.<br>4. Если ничего не указано, то уникальность будет определяться по названию оффера.";
$MESS["parser_offer_add_name_one_descr"] = "<b>Важный параметр!!! Особенности:</b><br>1. Указанные свойства добавляются в название оффера.<br>2. По данному параметру происходит уникализации офферов.";

$MESS["parser_offer_parsing_selector_name_descr"] = "Название торгового предложения. Может быть пустое, если отмечены свойства параметра уникализации. Тогда название будет состоять из значений казанных свойств.";
$MESS["parser_offer_parsing_selector_price_descr"] = "Если пусто, то цена будет браться из блока Превью или Детально";
$MESS["parser_offer_load_one"] = "Офферы с одной характеристикой";
$MESS["parser_offer_one_selector"] = "Селектор контейнера отдельной характеристики оффера";
$MESS["parser_offer_one_selector_descr"] = "Фактически это селектор выбора характеристики оффера, который указан в Параметре уникализации. Пример: select option, #charect div.size";
$MESS["parser_offer_one_price_attr"] = "Атрибут цены";
$MESS["parser_offer_one_price_attr_descr"] = "Иногда цена записывается в атрибут предыдущего параметра. Например: data-price. Если ничего не задано, то цена будет браться из вкладок Превью или Детально.";
$MESS["parser_work_pagenavigation"] = "Работа с постраничной навигацией";
$MESS["parser_work_pagenavigation_var"] = "Переменная-параметр постраничной навигации";
$MESS["parser_work_pagenavigation_other_var"] = "Другие переменные-параметры";
$MESS["parser_work_pagenavigation_page_count"] = "Количество страниц навигации";
$MESS["parser_standart_pagenavigation"] = "Стандартная постраничная навигация";
$MESS["parser_work_pagenavigation_descr"] = "Данный блок предназначен, если стандартная навигация не работает(отсутствие ссылок href). В таком случае вы можете настроить постраничную навигацию самостоятельно.";
$MESS["parser_work_pagenavigation_var_descr"] = "Переменная в урле, отвечающая за постраничную навигацию. Пример: page, PAGE_1. Далее парсер сам будет подставлять значения к этой переменной. Например: page=1, page=2";
$MESS["parser_work_pagenavigation_other_var_descr"] = "Перечислить переменные и их значения, которые также отвечают за постраничную навигацию. Пример: set_filter=Y&back=1&ajax=Y";
$MESS["parser_work_pagenavigation_page_count_descr"] = "Данный параметр необходимо заполнять, если блок Стандартной навигации не заполнен и вы заранее знаете количество страниц.";
$MESS["parser_local_tab"] = "Сервисы";
$MESS["parser_loc_type"] = "Тип перевода";
$MESS["parser_loc_no"] = "Не переводить";
$MESS["parser_loc_yandex"] = "Яндекс.Переводчик";
$MESS["parser_loc_yandex_key"] = "Ключ от API Яндекс.Переводчик";
$MESS["parser_loc_yandex_key_descr"] = "Данный ключ вы можете получить совершенно бесплатно по адресу: <a target='_blank' href='https://tech.yandex.ru/keys/get/?service=trnsl'>https://tech.yandex.ru/keys/get/?service=trnsl</a>";
$MESS["parser_loc_yandex_lang"] = "Направление перевода";
$MESS["parser_loc_yandex_lang_descr"] = "Может задаваться одним из следующих способов:<br>
- В виде пары кодов языков («с какого»-«на какой»), разделенных дефисом. Например, en-ru обозначает перевод с английского на русский.<br>
- В виде кода конечного языка (например ru). В этом случае сервис пытается определить исходный язык автоматически.<br><br>
Ограничения:<br>
- Максимальный размер передаваемого текста составляет 10000 символов.
";
$MESS["parser_loc_fields"] = "Переводить поля";
$MESS["parser_loc_fields_name"] = "Название";
$MESS["parser_loc_fields_preview_text"] = "Превью текст";
$MESS["parser_loc_fields_detail_text"] = "Детальное описание";
$MESS["parser_loc_fields_props"] = "Свойства";
$MESS["parser_loc_type_head"] = "Перевод текста";
$MESS["parser_loc_uniq"] = "Отправлять уникальный текст в Яндекс";
$MESS["parser_loc_uniq_domain"] = "Выберите домен";
$MESS["shs_parser_loc_uniq_no"] = "Не отправлять";
$MESS["parser_loc_uniq_domain_descr"] = "Осуществляется отправка только детального описания при создании нового элемента. При обновлении товаров отправка не осуществляется.<br><br>
Разрешается добавлять не более 100 текстов в сутки, при этом размер текста должен быть в пределах от 500 до 32000 символов.
";
$MESS["parser_auth_type"] = "Тип авторизации:";
$MESS["parser_auth_type_form"] = "Стандартная авторизация через form";
$MESS["parser_auth_type_http"] = "HTTP-аутентификация";
$MESS["button_caption"] = "Выбрать";
$MESS["parser_mode_descr_xml"] = "При debug режиме осуществляется парсинг первых 30 элементов XML файла. Debug режим необходим для отладки парсера. В рабочий режим парсер необходимо переводить, если вы полностью отладили и настроили парсинг!!!
Работа парсера в демо-режиме ограничена и фактически аналогична работе парсера в debug режиме.";
$MESS["parser_load_section_add"] = "Создано разделов";
$MESS["parser_encoding_xml"] = "Кодировка XML файла, который собираемся парсить. Определяется автоматически. Если не определена, то будет учитываться именно установленное вами значение. ";
$MESS["parser_mode_descr_yml"] = "По умолчанию парсер настроен для парсинга файлов формата yml.";
?>48   76175|/shs.parser/admin/parser_edit.php|5664e488<?
use Bitrix\Highloadblock as HL; 
use Bitrix\Main\Entity;

if(!isset($_REQUEST['ajax']) && !isset($_REQUEST["ajax_start"]) && !isset($_REQUEST["ajax_count"]) && !isset($_POST["auth"])):
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");

//require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/classes/mysql/list_parser.php");
//require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/classes/general/rss_content_parser.php");
define("HELP_FILE", "add_issue.php");
CJSCore::Init(array("jquery"));



?>

<?
if(!CModule::IncludeModule('iblock')) return false;
CModule::IncludeModule('catalog');
CModule::IncludeModule("highloadblock");
CModule::IncludeModule('shs.parser');

IncludeModuleLangFile(__FILE__);
global $shs_DEMO;
$POST_RIGHT = $APPLICATION->GetGroupRight("shs.parser");
if($POST_RIGHT=="D")
    $APPLICATION->AuthForm(GetMessage("ACCESS_DENIED"));

$parentID = 0;
if(isset($_REQUEST["parent"]) && $_REQUEST["parent"])
{
    $parentID = $_REQUEST["parent"];
}
/*$aTabs = array(
    array("DIV" => "edit1", "TAB" => GetMessage("parser_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_tab")),
    array("DIV" => "edit2", "TAB" => GetMessage("parser_preview_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_preview_tab")),
    array("DIV" => "edit3", "TAB" => GetMessage("parser_detail_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_detail_tab")),
    array("DIV" => "edit4", "TAB" => GetMessage("parser_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_settings_tab")),
);
$tabControl = new CAdminTabControl("tabControl", $aTabs);*/


$ID = intval($ID);        // Id of the edited record
$bCopy = ($action == "copy");
$message = null;
$bVarsFromForm = false;

/*function sotbitParserSetSettings(&$SETTINGS)
{
    foreach($SETTINGS as &$v)
    {
        if(is_array($v)) sotbitParserSetSettings($v);
        else $v = htmlspecialcharsEx($v);
    }
}

function sotbitParserGetSettings(&$SETTINGS)
{
    foreach($SETTINGS as &$v)
    {
        if(is_array($v)) sotbitParserGetSettings($v);
        else $v = htmlspecialcharsBack($v);
    }
}*/

if($REQUEST_METHOD == "POST" && ($save!="" || $apply!="") && $POST_RIGHT=="W" && check_bitrix_sessid())
{
    $parser = new ShsParserContent();
    RssContentParser::sotbitParserSetSettings($SETTINGS);

    $arFields = Array(
        "NAME"    => $NAME,
        "TYPE"    => $TYPE,
        "RSS"    => $RSS,
        "SORT"    => $SORT,
        "ACTIVE"    => ($ACTIVE <> "Y"? "N":"Y"),
        "IBLOCK_ID"    => $IBLOCK_ID,
        "SECTION_ID" => $SECTION_ID,
        "SELECTOR"    => $SELECTOR,
        "FIRST_URL"    => $FIRST_URL,
        "ENCODING"    => $ENCODING,
        "PREVIEW_TEXT_TYPE" => $PREVIEW_TEXT_TYPE,
        "DETAIL_TEXT_TYPE" => $DETAIL_TEXT_TYPE,
        "PREVIEW_DELETE_TAG" => $PREVIEW_DELETE_TAG,
        "DETAIL_DELETE_TAG" => $DETAIL_DELETE_TAG,
        "PREVIEW_FIRST_IMG" => ($PREVIEW_FIRST_IMG <> "Y"? "N":"Y"),
        "DETAIL_FIRST_IMG" => ($DETAIL_FIRST_IMG <> "Y"? "N":"Y"),
        "PREVIEW_SAVE_IMG" => ($PREVIEW_SAVE_IMG <> "Y"? "N":"Y"),
        "DETAIL_SAVE_IMG" => ($DETAIL_SAVE_IMG <> "Y"? "N":"Y"),
        "BOOL_PREVIEW_DELETE_TAG" =>($BOOL_PREVIEW_DELETE_TAG <> "Y"? "N":"Y"),
        "BOOL_DETAIL_DELETE_TAG" =>($BOOL_DETAIL_DELETE_TAG <> "Y"? "N":"Y"),
        "PREVIEW_DELETE_ELEMENT" => $PREVIEW_DELETE_ELEMENT,
        "DETAIL_DELETE_ELEMENT" => $DETAIL_DELETE_ELEMENT,
        "PREVIEW_DELETE_ATTRIBUTE" => $PREVIEW_DELETE_ATTRIBUTE,
        "DETAIL_DELETE_ATTRIBUTE" => $DETAIL_DELETE_ATTRIBUTE,
        "INDEX_ELEMENT" => ($INDEX_ELEMENT <> "Y"? "N":"Y"),
        "CODE_ELEMENT" => ($CODE_ELEMENT <> "Y"? "N":"Y"),
        "RESIZE_IMAGE" => ($RESIZE_IMAGE <> "Y"? "N":"Y"),
        "CREATE_SITEMAP" => ($CREATE_SITEMAP <> "Y"? "N":"Y"),
        "DATE_ACTIVE" => ($DATE_ACTIVE <> "Y"? "N":$DATE_PROP_ACTIVE),
        "DATE_PUBLIC" => ($DATE_PUBLIC <> "Y"? "N":$DATE_PROP_PUBLIC),
        "FIRST_TITLE" => ($FIRST_TITLE <> "Y"? "N":$FIRST_PROP_TITLE),
        "META_TITLE" => ($META_TITLE <> "Y"? "N":$META_PROP_TITLE),
        "META_DESCRIPTION" => ($META_DESCRIPTION <> "Y"? "N":$META_PROP_DESCRIPTION),
        "META_KEYWORDS" => ($META_KEYWORDS <> "Y"? "N":$META_PROP_KEYWORDS),
        "START_AGENT" => ($START_AGENT <> "Y"? "N":"Y"),
        "TIME_AGENT" => $TIME_AGENT,
        "ACTIVE_ELEMENT" => ($ACTIVE_ELEMENT <> "Y"? "N":"Y"),
        "SETTINGS" => base64_encode(serialize($SETTINGS)),
        "CATEGORY_ID"    => $CATEGORY_ID,
        //"START_LAST_TIME" => $START_LAST_TIME
    );
    if($ID>0)
    {
        $res = $parser->Update($ID, $arFields);

    }
    else
    {
        $ID = $parser->Add($arFields);
        $res = ($ID>0);
    }
 
    if($res)
    {
        if($apply!="")
            LocalRedirect("/bitrix/admin/parser_edit.php?ID=".$ID."&mess=ok&lang=".LANG."&tabControl_active_tab=".$_POST["tabControl_active_tab"]);
        else
            LocalRedirect("/bitrix/admin/list_parser_admin.php?lang=".LANG);
    }
    else
    {
        if($e = $APPLICATION->GetException())
            $message = new CAdminMessage(GetMessage("parser_save_error"), $e);
        $bVarsFromForm = true;
    }

}
//Edit/Add part
ClearVars();


if($ID>0 || $copy)
{
    if($ID)$parser = ShsParserContent::GetByID($ID);
    elseif($copy) $parser = ShsParserContent::GetByID($copy);
    if(!$parser->ExtractFields("shs_"))
        $ID=0;
    if($ID>0 && $shs_TIME_AGENT>0){
        $arAgent = CAgent::GetList(array(), array("NAME"=>"CShsParser::startAgent(".$ID.");"))->Fetch();
        if(!$arAgent && $shs_START_AGENT=="Y"){CAgent::AddAgent(
            "CShsParser::startAgent(".$ID.");", //  
            "shs.parser",                          //  
            "N",                                  //     - 
            $shs_TIME_AGENT,                                //   - 1 
            "",                //     
            "Y",                                  //  
            "",                //   
            100
          );}
        elseif($arAgent){
            CAgent::Update($arAgent['ID'], array(
                "AGENT_INTERVAL"=>$shs_TIME_AGENT,
                "ACTIVE"=>$shs_START_AGENT=="Y"?"Y":"N"
            ));
        }
    }
    
    
    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$shs_IBLOCK_ID, "PROPERTY_TYPE"=>"S"));
    while($arProp = $properties->Fetch())
    {   //printr($arProp);
        $arrProp['REFERENCE'][] = "[".$arProp["CODE"]."] ".$arProp["NAME"];
        $arrProp['REFERENCE_ID'][] = $arProp["CODE"];
    }

    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$shs_IBLOCK_ID, "PROPERTY_TYPE"=>"F"));
    while($arProp = $properties->Fetch())
    {
        $arrPropFile['REFERENCE'][] = "[".$arProp["CODE"]."] ".$arProp["NAME"];
        $arrPropFile['REFERENCE_ID'][] = $arProp["CODE"];
    }

    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$shs_IBLOCK_ID));

    $arrPropDop['REFERENCE'][] = GetMessage("shs_parser_select_prop_new");
    $arrPropDop['REFERENCE_ID'][] = "[]";
    
    $arrPropField['REFERENCE'][] = GetMessage("parser_SOTBIT_PARSER_NAME_E");
    $arrPropField['REFERENCE_ID'][] = "SOTBIT_PARSER_NAME_E";
    
    while($arProp = $properties->Fetch())
    {

        if($arProp["PROPERTY_TYPE"]=="S")
        {
            $arrPropField['REFERENCE'][] = $arProp["NAME"];
            $arrPropField['REFERENCE_ID'][] = $arProp["CODE"];    
        }
        if($arProp["PROPERTY_TYPE"]=="L" || $arProp["PROPERTY_TYPE"]=="N" || $arProp["PROPERTY_TYPE"]=="S" || $arProp["PROPERTY_TYPE"]=="E" || $arProp["PROPERTY_TYPE"]=="F")
        {
            $arrPropDop['REFERENCE'][] = $arProp["NAME"];
            $arrPropDop['REFERENCE_ID'][] = $arProp["CODE"];
            $arrPropDop['REFERENCE_TYPE'][$arProp["CODE"]] = $arProp["PROPERTY_TYPE"];
            $arrPropDop['USER_TYPE'][$arProp["CODE"]] = $arProp["USER_TYPE"];
            $arrPropDop['REFERENCE_CODE_NAME'][$arProp["CODE"]] = $arProp["NAME"];
        }
        
        if($arProp["PROPERTY_TYPE"]=="L"/* && $arProp["ID"]==14*/)
        {
            $rsEnum = CIBlockPropertyEnum::GetList(Array("DEF"=>"DESC", "SORT"=>"ASC"), Array("IBLOCK_ID"=>$shs_IBLOCK_ID, "property_id"=>$arProp["ID"]));
            $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
            $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
            while($arEnum = $rsEnum->Fetch())
            {
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $arEnum["VALUE"];
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $arEnum["ID"];
            }
        }
        if($arProp['USER_TYPE']=="directory")
        {
            $nameTable = $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"];
            if($nameTable)
            {
                $directorySelect = array("*");
                $directoryOrder = array();
                $entityGetList = array(
                    'select' => $directorySelect,
                    'order' => $directoryOrder
                );
                $highBlock = \Bitrix\Highloadblock\HighloadBlockTable::getList(array("filter" => array('TABLE_NAME' => $nameTable)))->fetch();
                $entity = \Bitrix\Highloadblock\HighloadBlockTable::compileEntity($highBlock);
                $entityDataClass = $entity->getDataClass();
                $propEnums = $entityDataClass::getList($entityGetList);
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
                while ($oneEnum = $propEnums->fetch())
                {
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $oneEnum["UF_NAME"];
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $oneEnum["UF_XML_ID"];
                }    
            }
            
        }
    }
}

/*if($bVarsFromForm)
    $DB->InitTableVarsForEdit("b_shs_list_parser", "", "shs_");*/

$APPLICATION->SetTitle(($ID>0? GetMessage("parser_title_edit") : GetMessage("parser_title_add")));
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_after.php");

$aMenu = array(
    array(
        "TEXT"=>GetMessage("parser_list"),
        "TITLE"=>GetMessage("parser_list_title"),
        "LINK"=>"list_parser_admin.php?parent=".$parentID."&lang=".LANG,
        "ICON"=>"btn_list",
    )
);
if($ID>0)
{
    $aMenu[] = array("SEPARATOR"=>"Y");
    $aMenu[] = array(
        "TEXT"=>GetMessage("parser_add"),
        "TITLE"=>GetMessage("rubric_mnu_add"),
        "LINK"=>"parser_edit.php?lang=".LANG,
        "ICON"=>"btn_new",
    );
    $aMenu[] = array(
        "TEXT"=>GetMessage("parser_copy"),
        "TITLE"=>GetMessage("rubric_mnu_copy"),
        "LINK"=>"parser_edit.php?copy=".$ID."&lang=".LANG,
        "ICON"=>"btn_copy",
    );
    $aMenu[] = array(
        "TEXT"=>GetMessage("parser_delete"),
        "TITLE"=>GetMessage("parser_mnu_del"),
        "LINK"=>"javascript:if(confirm('".GetMessage("parser_mnu_del_conf")."'))window.location='list_parser_admin.php?ID=".$ID."&action=delete&lang=".LANG."&".bitrix_sessid_get()."';",
        "ICON"=>"btn_delete",
    );

    if($shs_ACTIVE=="Y"){
        $aMenu[] = array("SEPARATOR"=>"Y");
        if($shs_TYPE=="catalog" || $_GET["type"]=="catalog"):
        $aMenu[] = array(
            "TEXT"=>GetMessage("parser_start"),
            "TITLE"=>GetMessage("parser_start_title"),
            "LINK"=>"parser_edit.php?start=1&lang=".LANG."&ID=".$ID,
            "ICON"=>"btn_start_catalog"
        );
        elseif($shs_TYPE=="page" || $_GET["type"]=="page" || $shs_TYPE=="rss" || $_GET["type"]=="rss"):
        $aMenu[] = array(
            "TEXT"=>GetMessage("parser_start"),
            "TITLE"=>GetMessage("parser_start_title"),
            "LINK"=>"parser_edit.php?start=1&lang=".LANG."&ID=".$ID,
            "ICON"=>"btn_start"
        );
        elseif($shs_TYPE=="xml" || $_GET["type"]=="xml"):
        $aMenu[] = array(
            "TEXT"=>GetMessage("parser_start"),
            "TITLE"=>GetMessage("parser_start_title"),
            "LINK"=>"parser_edit.php?start=1&lang=".LANG."&ID=".$ID,
            "ICON"=>"btn_start_xml"
        );
        endif;
    }
    if($shs_TYPE=="catalog" || $_GET["type"]=="catalog")
    {
        $aMenu[] = array(
            "TEXT"=>GetMessage("parser_instructions"),
            "TITLE"=>GetMessage("parser_instructions_title"),
            "LINK"=>"http://www.sotbit.ru/info/articles/instruktsiya-polzovatelya-pri-rabote-s-modulem-parser-kontenta-v-rezhime-kataloga.html",
            "ICON"=>"instruction"
        );
    }
    if($shs_TYPE=="xml" || $_GET["type"]=="xml")
    {
        $aMenu[] = array(
            "TEXT"=>GetMessage("parser_instructions"),
            "TITLE"=>GetMessage("parser_instructions_title"),
            "LINK"=>"http://www.sotbit.ru/info/articles/instruktsiya-polzovatelya-pri-rabote-s-modulem-parser-kontenta-v-rezhime-kataloga.html",
            "ICON"=>"instruction"
        );
    }
}
$context = new CAdminContextMenu($aMenu);
$context->Show();

$rsSection = ShsParserSectionTable::getList(array(
    'limit' =>null,
    'offset' => null,
    'select' => array("*"),
    "filter" => array()
));

$parentID = 0;
if(isset($_REQUEST["parent"]) && $_REQUEST["parent"])
{
    $parentID = $_REQUEST["parent"];
}

while($arSection = $rsSection->Fetch())
{
    $arCategory['REFERENCE'][] = "[".$arSection["ID"]."] ".$arSection["NAME"];
    $arCategory['REFERENCE_ID'][] = $arSection["ID"];
}

$arLocType['reference'] = array(GetMessage("parser_loc_no"), GetMessage("parser_loc_yandex"));
$arLocType['reference_id'] = array('', 'yandex');

if(isset($_REQUEST['start']) && $ID>0){
    $rssParser = new RssContentParser();
    $result = $rssParser->startParser();
    if(isset($result[SUCCESS][0]))
    foreach($result[SUCCESS] as $i=>$success){
      $resultUrl .= "&SUCCESS[".$i."]=".urlencode($success);
    }
    if(isset($result[ERROR][0]))
     foreach($result[ERROR] as $i=>$error){
      $resultUrl .= "&ERROR[".$i."]=".urlencode($error);
    }
    if(!RssContentParser::TEST)LocalRedirect($APPLICATION->GetCurPageParam("end=1".$resultUrl, array("start")));
}

/***
****    XML
***/

if($shs_TYPE=="catalog" || $_GET["type"]=="catalog" || $shs_TYPE=="xml" || $_GET["type"]=="xml")
{   $isOfferCatalog = false;
    if(isset($shs_IBLOCK_ID) && $shs_IBLOCK_ID && CModule::IncludeModule('catalog'))
    {
        $arIblock = CCatalogSKU::GetInfoByIBlock($shs_IBLOCK_ID);
        //printr($arIblock);
        if(is_array($arIblock) && !empty($arIblock) && $arIblock["PRODUCT_IBLOCK_ID"]!=0 && $arIblock["SKU_PROPERTY_ID"]!=0)$isOfferCatalog = true;
        
        
        if($arIblock["IBLOCK_ID"] && $arIblock["PRODUCT_IBLOCK_ID"])
            $OFFER_IBLOCK_ID = $arIblock["IBLOCK_ID"];
        if($OFFER_IBLOCK_ID)
        {
            $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$OFFER_IBLOCK_ID));
    
            $arrPropDopOffer['REFERENCE'][] = GetMessage("shs_parser_select_prop_new");
            $arrPropDopOffer['REFERENCE_ID'][] = "[]";
            
            while($arProp = $properties->Fetch())
            {

                if($arProp["PROPERTY_TYPE"]=="L" || $arProp["PROPERTY_TYPE"]=="N" || $arProp["PROPERTY_TYPE"]=="S" || $arProp["PROPERTY_TYPE"]=="E" || $arProp["PROPERTY_TYPE"]=="F")
                {
                    $arrPropDopOffer['REFERENCE'][] = $arProp["NAME"];
                    $arrPropDopOffer['REFERENCE_ID'][] = $arProp["CODE"];
                    $arrPropDopOfferName['REFERENCE'][] = $arProp["NAME"];
                    $arrPropDopOfferName['REFERENCE_ID'][] = $arProp["CODE"];
                    $arrPropDopOffer['REFERENCE_TYPE'][$arProp["CODE"]] = $arProp["PROPERTY_TYPE"];
                    $arrPropDopOffer['USER_TYPE'][$arProp["CODE"]] = $arProp["USER_TYPE"];
                    $arrPropDopOffer['REFERENCE_CODE_NAME'][$arProp["CODE"]] = $arProp["NAME"];
                }
                
                if($arProp["PROPERTY_TYPE"]=="L"/* && $arProp["ID"]==14*/)
                {
                    $rsEnum = CIBlockPropertyEnum::GetList(Array("DEF"=>"DESC", "SORT"=>"ASC"), Array("IBLOCK_ID"=>$OFFER_IBLOCK_ID, "property_id"=>$arProp["ID"]));
                    $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
                    $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
                    while($arEnum = $rsEnum->Fetch())
                    {
                        $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $arEnum["VALUE"];
                        $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $arEnum["ID"];
                    }
                }
                if($arProp['USER_TYPE']=="directory")
                {
                    $nameTable = $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"];
                    $directorySelect = array("*");
                    $directoryOrder = array();
                    $entityGetList = array(
                        'select' => $directorySelect,
                        'order' => $directoryOrder
                    );
                    $highBlock = \Bitrix\Highloadblock\HighloadBlockTable::getList(array("filter" => array('TABLE_NAME' => $nameTable)))->fetch();
                    $entity = \Bitrix\Highloadblock\HighloadBlockTable::compileEntity($highBlock);
                    $entityDataClass = $entity->getDataClass();
                    $propEnums = $entityDataClass::getList($entityGetList);
                    $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
                    $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
                    while ($oneEnum = $propEnums->fetch())
                    {
                        $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $oneEnum["UF_NAME"];
                        $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $oneEnum["UF_XML_ID"];
                    }
                }
            }    
        }    
            
            
    }
    
    /***
    ****   
    ***/
    
    if ($shs_TYPE=="catalog" || $_GET["type"]=="catalog")
    {
        if(CModule::IncludeModule('catalog') && (($shs_IBLOCK_ID && CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y", "ID"=>$shs_IBLOCK_ID))->Fetch()) || (is_array($arIblock) && !empty($arIblock) && $arIblock["PRODUCT_IBLOCK_ID"]!=0 && $arIblock["SKU_PROPERTY_ID"]!=0)  || !$shs_IBLOCK_ID))
        {
            //unset($aTabs[5]);
            $aTabs = array(
                array("DIV" => "edit1", "TAB" => GetMessage("parser_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_tab")),
                array("DIV" => "edit2", "TAB" => GetMessage("parser_pagenavigation_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_pagenavigation_tab")),
                array("DIV" => "edit3", "TAB" => GetMessage("parser_preview_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_preview_tab")),
                array("DIV" => "edit4", "TAB" => GetMessage("parser_detail_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_detail_tab")),
                array("DIV" => "edit5", "TAB" => GetMessage("parser_props_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_props_tab")),
                array("DIV" => "edit6", "TAB" => GetMessage("parser_catalog_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_catalog_tab")),
                array("DIV" => "edit7", "TAB" => GetMessage("parser_offer_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_offer_tab")),
                array("DIV" => "edit8", "TAB" => GetMessage("parser_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_settings_tab")),
                array("DIV" => "edit9", "TAB" => GetMessage("parser_uniq_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_uniq_tab")),
                array("DIV" => "edit10", "TAB" => GetMessage("parser_auth"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_auth")),
                array("DIV" => "edit11", "TAB" => GetMessage("parser_logs_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_logs_tab")),
                array("DIV" => "edit12", "TAB" => GetMessage("parser_local_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_local_tab")),
                array("DIV" => "edit13", "TAB" => GetMessage("parser_video_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_video_tab")),
            );
            $isCatalog = true;
        }else{
            $aTabs = array(
                array("DIV" => "edit1", "TAB" => GetMessage("parser_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_tab")),
                array("DIV" => "edit2", "TAB" => GetMessage("parser_pagenavigation_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_pagenavigation_tab")),
                array("DIV" => "edit3", "TAB" => GetMessage("parser_preview_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_preview_tab")),
                array("DIV" => "edit4", "TAB" => GetMessage("parser_detail_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_detail_tab")),
                array("DIV" => "edit5", "TAB" => GetMessage("parser_props_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_props_tab")),
                array("DIV" => "edit7", "TAB" => GetMessage("parser_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_settings_tab")),
                array("DIV" => "edit8", "TAB" => GetMessage("parser_uniq_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_uniq_tab")),
                array("DIV" => "edit9", "TAB" => GetMessage("parser_auth"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_auth")),
                array("DIV" => "edit10", "TAB" => GetMessage("parser_logs_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_logs_tab")),
                array("DIV" => "edit11", "TAB" => GetMessage("parser_local_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_local_tab")),
                array("DIV" => "edit12", "TAB" => GetMessage("parser_video_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_video_tab")),
            );
            $isCatalog = false;
        }
    }
    
    /***
    ****   XML
    ***/
    
    if ($shs_TYPE=="xml" || $_GET["type"]=="xml")
    {
        if(CModule::IncludeModule('catalog') && (($shs_IBLOCK_ID && CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y", "ID"=>$shs_IBLOCK_ID))->Fetch()) || (is_array($arIblock) && !empty($arIblock) && $arIblock["PRODUCT_IBLOCK_ID"]!=0 && $arIblock["SKU_PROPERTY_ID"]!=0)  || !$shs_IBLOCK_ID))
        {
            $aTabs = array(
                array("DIV" => "edit1", "TAB" => GetMessage("parser_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_tab")),
                //array("DIV" => "edit2", "TAB" => GetMessage("parser_pagenavigation_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_pagenavigation_tab")),
                array("DIV" => "edit2", "TAB" => GetMessage("parser_basic_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_basic_settings_tab")),
                //array("DIV" => "edit4", "TAB" => GetMessage("parser_detail_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_detail_tab")),
                array("DIV" => "edit3", "TAB" => GetMessage("parser_props_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_props_tab")),
                array("DIV" => "edit4", "TAB" => GetMessage("parser_catalog_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_catalog_tab")),
                //array("DIV" => "edit7", "TAB" => GetMessage("parser_offer_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_offer_tab")),
                array("DIV" => "edit5", "TAB" => GetMessage("parser_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_settings_tab")),
                array("DIV" => "edit6", "TAB" => GetMessage("parser_uniq_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_uniq_tab")),
                array("DIV" => "edit10", "TAB" => GetMessage("parser_auth"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_auth")),
                array("DIV" => "edit7", "TAB" => GetMessage("parser_logs_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_logs_tab")),
                array("DIV" => "edit12", "TAB" => GetMessage("parser_local_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_local_tab")),
                array("DIV" => "edit8", "TAB" => GetMessage("parser_video_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_video_tab")),
            );
            $isCatalog = true;
        }else{
            $aTabs = array(
                array("DIV" => "edit1", "TAB" => GetMessage("parser_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_tab")),
                //array("DIV" => "edit2", "TAB" => GetMessage("parser_pagenavigation_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_pagenavigation_tab")),
                array("DIV" => "edit2", "TAB" => GetMessage("parser_preview_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_preview_tab")),
                //array("DIV" => "edit4", "TAB" => GetMessage("parser_detail_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_detail_tab")),
                array("DIV" => "edit3", "TAB" => GetMessage("parser_props_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_props_tab")),
                array("DIV" => "edit4", "TAB" => GetMessage("parser_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_settings_tab")),
                array("DIV" => "edit5", "TAB" => GetMessage("parser_uniq_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_uniq_tab")),
                array("DIV" => "edit9", "TAB" => GetMessage("parser_auth"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_auth")),
                array("DIV" => "edit6", "TAB" => GetMessage("parser_logs_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_logs_tab")),
                array("DIV" => "edit11", "TAB" => GetMessage("parser_local_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_local_tab")),
                array("DIV" => "edit7", "TAB" => GetMessage("parser_video_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_video_tab")),
            );
            $isCatalog = false;
        }
    }
    
    
    //printr($aTabs);
    //$rsIBlock = CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y"));
    $rsIBlock = CIBlock::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y"));
    while($arr=$rsIBlock->Fetch()){
        $arIBlock['REFERENCE'][] = "[".$arr["ID"]."] ".$arr["NAME"];
        $arIBlock['REFERENCE_ID'][] = $arr["ID"];
    }
}

/***
**** RSS  PAGE
***/

else{
    $rsIBlock = CIBlock::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y"));
    while($arr=$rsIBlock->Fetch()){
        $arIBlock['REFERENCE'][] = "[".$arr["ID"]."] ".$arr["NAME"];
        $arIBlock['REFERENCE_ID'][] = $arr["ID"];
    }

    $aTabs = array(
        array("DIV" => "edit1", "TAB" => GetMessage("parser_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_tab")),
        array("DIV" => "edit2", "TAB" => GetMessage("parser_preview_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_preview_tab")),
        array("DIV" => "edit3", "TAB" => GetMessage("parser_detail_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_detail_tab")),
        array("DIV" => "edit4", "TAB" => GetMessage("parser_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_settings_tab")),
        array("DIV" => "edit5", "TAB" => GetMessage("parser_local_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_local_tab")),
        array("DIV" => "edit6", "TAB" => GetMessage("parser_video_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_video_tab")),
    );
}
$tabControl = new CAdminTabControl("tabControl", $aTabs);



if(!empty($shs_IBLOCK_ID)){
    $rsSections = CIBlockSection::GetList(array("left_margin"=>"asc"), array(/*'ACTIVE'=>"Y",*/ "IBLOCK_ID"=>$shs_IBLOCK_ID), false, array('ID', 'NAME', "IBLOCK_ID", "DEPTH_LEVEL"));

    while($arr=$rsSections->Fetch()){
        $arr["NAME"] = str_repeat(" . ", $arr["DEPTH_LEVEL"]).$arr["NAME"];
        $arSection['REFERENCE'][] = $arr["NAME"];
        $arSection['REFERENCE_ID'][] = $arr["ID"];
    }



}
$arrDateActive['REFERENCE'][0] =  GetMessage("parser_date_active_now");
$arrDateActive['REFERENCE'][1] =  GetMessage("parser_date_active_now_time");
$arrDateActive['REFERENCE'][2] =  GetMessage("parser_date_active_public");
$arrDateActive['REFERENCE_ID'][0] = "NOW";
$arrDateActive['REFERENCE_ID'][1] = "NOW_TIME";
$arrDateActive['REFERENCE_ID'][2] = "PUBLIC";
?>
<a target="blank" href=""><?=GetMessage("parser_instruction")?></a>
<div id="status_bar" style="display:none;overflow:hidden;">
    <div id="progress_bar" style="width: 500px;float:left;" class="adm-progress-bar-outer">
        <div id="progress_bar_inner" style="width: 0px;" class="adm-progress-bar-inner"></div>
        <div id="progress_text" style="width: 500px;" class="adm-progress-bar-inner-text">0%</div>
    </div>
    <div id="catalog_bar" style="float:left;width:700px;height:35px;line-height:35px;font-weight:bold;margin-left:30px;"></div>
    <div id="current_test"></div>
</div>
<div style="clear:both;"></div>
<?
if(isset($_REQUEST["mess"]) && $_REQUEST["mess"] == "ok" && $ID>0)
    CAdminMessage::ShowMessage(array("MESSAGE"=>GetMessage("parser_saved"), "TYPE"=>"OK"));

if($message)
    echo $message->Show();
elseif($rubric->LAST_ERROR!="")
    CAdminMessage::ShowMessage($rubric->LAST_ERROR);

if(isset($_REQUEST['end']) && $_REQUEST['end']==1 && $ID>0){
    if(isset($_GET['SUCCESS'][0])){
      foreach($_GET['SUCCESS'] as $success) CAdminMessage::ShowMessage(array("MESSAGE"=>$success, "TYPE"=>"OK"));
    }
    if(isset($_GET['ERROR'][0])){
        foreach($_GET['ERROR'] as $error) CAdminMessage::ShowMessage($error);
    }

}
$shs_SETTINGS = (string)$shs_SETTINGS;
$shs_SETTINGS = unserialize(base64_decode($shs_SETTINGS));

$shsDebug = $shs_SETTINGS["catalog"]["mode"];


if($shs_DEMO==2)CAdminMessage::ShowMessage(array("MESSAGE"=>GetMessage("parser_demo")));
if($shs_DEMO==3)CAdminMessage::ShowMessage(array("MESSAGE"=>GetMessage("parser_demo_end")));
?>
<div id="shs_message"></div>
<form method="POST" id="shs-parser" Action="<?echo $APPLICATION->GetCurPage()?>" ENCTYPE="multipart/form-data" name="post_form">
<?
$tabControl->Begin();


if($shs_TYPE=="page" || (isset($_GET["type"]) && $_GET["type"]=="page")) include("parser_edit_page.php");
elseif($shs_TYPE=="catalog" || (isset($_GET["type"]) && $_GET["type"]=="catalog")) include("parser_edit_catalog.php");
elseif($shs_TYPE=="xml" || (isset($_GET["type"]) && $_GET["type"]=="xml")) include("parser_edit_xml.php");
elseif((!$shs_TYPE && $ID) || $shs_TYPE=="rss" || (isset($_GET["type"]) && $_GET["type"]=="rss") || !isset($ID) || !$ID) include("parser_edit_rss.php");
?>






<?echo BeginNote();?>
<span class="required">*</span><?echo GetMessage("REQUIRED_FIELDS")?>
<?echo EndNote();?>
<script language="JavaScript">
            var target_id = '';
            var target_select_id = '';
            var target_shadow_id = '';
            function addSectionProperty(iblock_id, select_id, tr, table_id)
            {   
                {
                    target_id = table_id;
                    target_select_id = select_id;
                    target_shadow_id = tr;
                    (new BX.CDialog({
                        'content_url' : '/bitrix/admin/iblock_edit_property.php?lang=<?echo LANGUAGE_ID?>&IBLOCK_ID='+iblock_id+'&ID=n0&bxpublic=Y&from_module=iblock&return_url=section_edit',
                        'width' : 700,
                        'height' : 400,
                        'buttons': [BX.CDialog.btnSave, BX.CDialog.btnCancel]
                    })).Show();
                }
            }
            function deleteSectionProperty(id, select_id, shadow_id, table_id)
            {
                var hidden = BX('hidden_SECTION_PROPERTY_' + id);
                var tr = BX('tr_SECTION_PROPERTY_' + id);
                if(hidden && tr)
                {
                    hidden.value = 'N';
                    tr.style.display = 'none';
                    var select = BX(select_id);
                    var shadow = BX(shadow_id);
                    if(select && shadow)
                    {
                        jsSelectUtils.deleteAllOptions(select);
                        for(var i = 0; i < shadow.length; i++)
                        {
                            if(shadow[i].value <= 0)
                                jsSelectUtils.addNewOption(select, shadow[i].value, shadow[i].text);
                            else if (BX('hidden_SECTION_PROPERTY_' + shadow[i].value).value == 'N')
                                jsSelectUtils.addNewOption(select, shadow[i].value, shadow[i].text);
                        }
                    }
                    adjustEmptyTR(table_id);
                }
            }
            function createSectionProperty(id, name, type)
            {   
                jQuery.ajax({
                    url: "",
                    type: "POST",
                    data: 'ajax=1&prop_id='+id,
                    dataType: 'html',
                    success: function(code){
                        code = $.trim(code);
                        if(target_select_id=="loadDopPropOffer")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[offer][selector_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);
                            
                            strName = '<option value="'+code+'">'+name+'</option>'; 
                            $(".add_name").append(strName);   
                        }else if(target_select_id=="loadDopPropOffer1")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[offer][find_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);
                            strName = '<option value="'+code+'">'+name+'</option>';
                            $(".add_name").append(strName);    
                        }
                        else if(target_select_id=="loadDopProp")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);
                    
                        }else if(target_select_id=="loadDopProp1")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }else if(target_select_id=="loadDopProp2")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop_preview]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }else if(target_select_id=="loadDopProp3")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop_preview]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }
                        else if(target_select_id=="loadPropField")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][action_props_val]['+code+'][]" data-code="'+code+'" size="40">&nbsp; <select id="SETTINGS[catalog][action_props]['+code+']" name="SETTINGS[catalog][action_props]['+code+'][]"><option value=""><?=GetMessage("shs_parser_select_action_props")?></option><option value="delete"><?=GetMessage("parser_action_props_delete")?></option><option value="add_b"><?=GetMessage("parser_action_props_add_begin")?></option><option value="add_e"><?=GetMessage("parser_action_props_add_end")?></option></select> <a href="#" class="find_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }
                    }

                 })
                
            }
            function createSectionPropertyOffer(id, name, type)
            {   
                jQuery.ajax({
                    url: "",
                    type: "POST",
                    data: 'ajax=1&iblock=<?=$OFFER_IBLOCK_ID?>&prop_id='+id,
                    dataType: 'html',
                    success: function(code){
                        code = $.trim(code);
                        if(target_select_id=="loadDopProp")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);
                    
                        }else if(target_select_id=="loadDopProp1")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }else if(target_select_id=="loadDopProp2")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop_preview]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }else if(target_select_id=="loadDopProp3")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop_preview]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }
                    }

                 })
                
            }
            function adjustEmptyTR(table_id)
            {
                var tbl = BX(table_id);
                if(tbl)
                {
                    var cnt = tbl.rows.length;
                    var tr = tbl.rows[cnt-1];

                    var display = 'table-row';
                    for(var i = 1; i < cnt-1; i++)
                    {
                        if(tbl.rows[i].style.display != 'none')
                            display = 'none';
                    }
                    tr.style.display = display;
                }
            }
</script>    
<script language="JavaScript">
    jQuery(document).ready(function(){
        
        
        $("#loadDopPropOffer").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDopOffer] option:selected").val();
            t = tr.find("select[name=arrPropDopOffer] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property_offer("loadDopPropOffer", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[offer][selector_prop]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadDopPropOffer1").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDopOffer] option:selected").val();
            t = tr.find("select[name=arrPropDopOffer] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property_offer("loadDopPropOffer1", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[offer][find_prop]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadDopProp").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDop] option:selected").val();
            t = tr.find("select[name=arrPropDop] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadDopProp", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadPropDefault").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDefault] option:selected").val();
            t = tr.find("select[name=arrPropDefault] option:selected").text();
            if(v=="") return false;
            /*else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadPropDefault", tr);
                return false;
            }*/
            
            jQuery.ajax({
                    url: "",
                    type: "POST",
                    data: 'default=1&ajax=1&prop_id='+v+"&iblock_id="+<?=isset($shs_IBLOCK_ID)?$shs_IBLOCK_ID:0?>,
                    dataType: 'html',
                    success: function(data){
                        str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r">'+data+'</td></tr>';
                        tr.before(str);    
                    }
            })
        });
        
        $("#loadDopProp2").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDop] option:selected").val();
            t = tr.find("select[name=arrPropDop] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadDopProp2", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop_preview]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadDopProp1").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDop1] option:selected").val();
            t = tr.find("select[name=arrPropDop1] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadDopProp1", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadDopProp3").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDop1] option:selected").val();
            t = tr.find("select[name=arrPropDop1] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadDopProp3", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop_preview]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadPropField").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropField] option:selected").val();
            t = tr.find("select[name=arrPropField] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadPropField", tr);
                return false;
            }
            //str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop_preview]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            if(v=="SOTBIT_PARSER_NAME_E") str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+':</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][action_props_val]['+v+'][]" data-code="'+v+'" size="40">&nbsp; <select id="SETTINGS[catalog][action_props]['+v+']" name="SETTINGS[catalog][action_props]['+v+'][]"><option value=""><?=GetMessage("shs_parser_select_action_props")?></option><option value="delete"><?=GetMessage("parser_action_props_delete")?></option><option value="add_b"><?=GetMessage("parser_action_props_add_begin")?></option><option value="add_e"><?=GetMessage("parser_action_props_add_end")?></option></select> <a href="#" class="find_delete">Delete</a></td></tr>';
            else str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][action_props_val]['+v+'][]" data-code="'+v+'" size="40">&nbsp; <select id="SETTINGS[catalog][action_props]['+v+']" name="SETTINGS[catalog][action_props]['+v+'][]"><option value=""><?=GetMessage("shs_parser_select_action_props")?></option><option value="delete"><?=GetMessage("parser_action_props_delete")?></option><option value="add_b"><?=GetMessage("parser_action_props_add_begin")?></option><option value="add_e"><?=GetMessage("parser_action_props_add_end")?></option></select> <a href="#" class="find_delete">Delete</a></td></tr>';
            
            tr.before(str);
        });
        
        function sotbit_iblock_edit_property(select_id, tr)
        {
            <?if(isset($shs_IBLOCK_ID) && $shs_IBLOCK_ID):?>addSectionProperty(<?echo $shs_IBLOCK_ID;?>, select_id, tr, 'table_SECTION_PROPERTY')<?endif;?>
        }
        
        function sotbit_iblock_edit_property_offer(select_id, tr)
        {
            <?if(isset($OFFER_IBLOCK_ID) && $OFFER_IBLOCK_ID):?>addSectionProperty(<?echo $OFFER_IBLOCK_ID;?>, select_id, tr, 'table_SECTION_PROPERTY')<?endif;?>
        }
        
        
        $("#instruction").attr("target", "_blank");
        $("body").on("click", ".prop_delete", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            tr.hide();
            tr.find("input").val("");
            v = tr.find("input").attr("data-code");
            prev = $("#delete_selector_prop").val();
            $("#delete_selector_prop").val(prev+","+v);
        });

        $("body").on("click", ".find_delete", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            tr.hide();
            tr.find("input").val("");
            v = tr.find("input").attr("data-code");
            prev = $("#delete_find_prop").val();
            $("#delete_find_prop").val(prev+","+v);
        })
        
        $("body").on("click", ".show_prop", function(e){
            e.preventDefault();
            id = $(this).attr("data-name");
            $("#"+id).val("");
            tr = $(this).parents("tr").eq(0);
            if(!tr.is("#header_find_prop"))tr.nextAll().not("#header_find_prop~tr").show();
            else tr.nextAll().show();    
        })
        
        $("body").on("click", ".add_usl", function(e){
            e.preventDefault();
            
            tr = $(".tr_add").clone(); 
            console.log(tr);
            n = parseInt($(".tr_add.heading").attr("data-num"));
            $(".tr_add").removeClass("tr_add");
            $(".tr_last").after(tr);
            $(".tr_last").not(".tr_add").removeClass("tr_last");
            $(this).remove();
            $(".tr_add.heading").attr("data-num", n+1); 
            $(".tr_add.heading span").text(n+1);
            $(".tr_add .del_usl").show();  
        })
        
        $("body").on("click", "#auth", function(e){
            e.preventDefault();
            url = $(this).attr("data-href");
            jQuery.ajax({
               url: url,
               type: "POST",
               data: "auth=1",
               dataType: 'html',
               success: function(data){
                 $("#shs_message").html(data);
               }

            })
        })
        
        $("body").on("click", ".del_usl", function(e){
            e.preventDefault();
            tr = $(this).parents(".heading").eq(0);
            if(tr.is(".tr_add"))
            {
                tr.prev().addClass("tr_last");
                bool = false;
                tr.prevAll("tr").each(function(){
                    if(!bool) $(this).addClass("tr_add");
                    if($(this).is(".heading") && !bool)
                    {
                        bool = true;
                        attr = parseInt($(this).attr("data-num"));
                        if(attr!=1)$(this).html(tr.html());    
                    }
                         
                })        
            }
                bool = false;
                tr.nextAll("tr").each(function(){
                    if($(this).is(".heading")) bool = true;
                    if(!bool) $(this).remove();    
                })    
            tr.remove();
        })

        jQuery('#iblock').change(function(){
            iblock = jQuery(this).val();
            jQuery.ajax({
               url: "",
               type: "POST",
               data: 'ajax=1&iblock='+iblock,
               dataType: 'html',
               success: function(data){
                 var ar = new Array();
                 ar = data.split("#SOTBIT#");
                 $('#section').html(ar[0]);
                 /*$(".prop-iblock").html(ar[1]);
                 $("#edit5 .image_props").html(ar[4]);
                 $("#edit5 #header_selector_prop+tr+tr").nextAll().not("#header_find_prop, .tr_find_prop").remove();
                 $("#edit5 #header_find_prop+tr+tr+tr").nextAll().not(".tr_find_prop").remove();
                 $("#edit5 #header_selector_prop+tr+tr").after(ar[2]);
                 $("#edit5 #header_find_prop+tr+tr+tr").after(ar[3]);*/
               }

            })

        })

        $('.bool-delete').change(function(){
          if($(this).prop('checked')){
            $(this).next().removeAttr('disabled');
            $(this).next().next().removeAttr('disabled');
          }
          else{
            $(this).next().val("");
            $(this).next().attr('disabled', "");

            $(this).next().next().val("");
            $(this).next().next().attr('disabled', "");
          }
        })

        $('.number_img').change(function(){
          if(!$(this).prop('checked')){
            $(this).next().removeAttr('disabled');
            $(this).next().next().removeAttr('disabled');
          }
          else{
            $(this).next().val("");
            $(this).next().attr('disabled', "");

            $(this).next().next().val("");
            $(this).next().next().attr('disabled', "");

          }
        })

        $("#TYPE").change(function(e){
                href = location.href;
                location.href=href+'&type='+$(this).val();
        })
        
        $(".select_load").change(function(e){
            $("input[name=apply]").click();    
        })
        
        $("body").on("click", "#btn_stop_catalog", function(e){
            e.preventDefault();
                
        })
        var ajaxInterval;
        var sotbitStop;
        var sotbitStopStart;
        var href1, href2;
        var debug = 0;
        <?if($shsDebug=="debug"):?>
        debug = 1;
        <?endif;?>

        function sotbitAjaxCatalog(href2, start)
        {
                if(start==1)
                {
                    sotbitStopStart = 0;
                    href = href2+"&begin=1";
                    sotbitStop = 0;
                }
                else href=href2;
                BX.ajax.get(href, "", function(data){
                    //clearInterval(ajaxInterval);
                    prog = 100;
                    $('#progress_text').html(prog + '%');
                    $('#progress_bar_inner').width(500 * prog / 100);
                    //$("#status_bar").hide();
                    $('#progress_text').html(100 + '%');
                    if(data!="stop")$("#shs_message").html(data);
                    //if(sotbitStop!=1)sotbitAjaxCatalog(href2, 0);
                    //else sotbitStop = 0;
                    if(data!="stop" && sotbitStopStart!=1 && debug!=1) sotbitAjaxCatalog(href2, 0);
                    else
                    {   
                        if(sotbitStopStart==1)sotbitStop = 1;
                        //if(debug==1) 
                        sotbitStop = 1;
                        $("#btn_stop_catalog").attr("id", "btn_start_catalog");
                        $("#btn_start_catalog").text(<?echo '"'.GetMessage("parser_start").'"'?>); 
                        setTimeout(function(){
                            sotbitCountAjax(href1, 1);    
                        },1000)
                            
                    }                            
                    
                })    
        }
        
        //get xml
        function sotbitAjaxXML(href2, start)
        {
                if(start==1)
                {
                    sotbitStopStart = 0;
                    href = href2+"&begin=1";
                    sotbitStop = 0;
                }
                else href=href2;
                BX.ajax.get(href, "", function(data){
                    //clearInterval(ajaxInterval);
                    prog = 100;
                    $('#progress_text').html(prog + '%');
                    $('#progress_bar_inner').width(500 * prog / 100);
                    //$("#status_bar").hide();
                    $('#progress_text').html(100 + '%');
                    if(data!="stop")$("#shs_message").html(data);
                    //if(sotbitStop!=1)sotbitAjaxCatalog(href2, 0);
                    //else sotbitStop = 0;
                    
                    if(data!="stop" && sotbitStopStart!=1 && debug!=1) sotbitAjaxXML(href2, 0);
                    else
                    {   
                        if(sotbitStopStart==1)sotbitStop = 1;
                        //if(debug==1) 
                        sotbitStop = 1;
                        $("#btn_stop_xml").attr("id", "btn_start_xml");
                        $("#btn_start_xml").text(<?echo '"'.GetMessage("parser_start").'"'?>); 
                        setTimeout(function(){
                            sotbitCountAjax(href1, 1);    
                        },1000)
                            
                    }                            
                    
                })    
        }
        
        $("body").on("click", "#btn_stop_catalog", function(e){
            e.preventDefault();
            sotbitStopStart = 1;
        })
        
        //stop parsing xml
        $("body").on("click", "#btn_stop_xml", function(e){
            e.preventDefault();
            sotbitStopStart = 1;
        })
        
        $("body").on('click', "#btn_start_catalog", function(e) {   //alert("test");
            e.preventDefault();
            $(this).attr("id", "btn_stop_catalog");
            $("#status_bar").show();
            $(this).text(<?echo '"'.GetMessage("btn_stop_catalog").'"'?>);
            href1 = $(this).attr("href")+"&ajax_count=1&type=catalog";
            href2 = $(this).attr("href")+"&ajax_start=1&type=catalog";

            //ajaxInterval = setInterval(function(){
            sotbitCountAjax(href1, 0);
            //}, 1000);
            
            

            sotbitAjaxCatalog(href2, 1);

            return false;

        })
         //start parsing xml
         $("body").on('click', "#btn_start_xml", function(e) {   
            e.preventDefault();
            $(this).attr("id", "btn_stop_xml");
            $("#status_bar").show();
            $(this).text(<?echo '"'.GetMessage("btn_stop_catalog").'"'?>);
            href1 = $(this).attr("href")+"&ajax_count=1&type=xml";
            href2 = $(this).attr("href")+"&ajax_start=1&type=xml";

            //ajaxInterval = setInterval(function(){
            sotbitCountAjax(href1, 0);
            //}, 1000);
            
         

            sotbitAjaxXML(href2, 1);

            return false;

        })
        
        function sotbitCountAjax(href1, num)
        {   
            BX.ajax.post(href1, "sessid="+BX.bitrix_sessid(), function(data){
                    arData = data.split("|");
                    if(sotbitStop!=1)
                    {
                        if(arData[1]>0)prog = Math.ceil((arData[1]/arData[0])*100);
                        else prog = 0;
                        $('#progress_text').html(prog + '%');
                        $('#progress_bar_inner').width(500 * prog / 100);    
                    }
                    
                    page = arData[2];
                    elements = arData[3];
                    elementError = arData[4];
                    allError = arData[5];
                    if(sotbitStop!=1)sotbitStop = parseInt(arData[6]);
                    msg = <?echo '"'.GetMessage("parser_load_page").'"'?>+page+<?echo '"'.GetMessage("parser_load_product").'"'?>+elements+<?echo '"<span style=\"color:red\">'.GetMessage("parser_load_product_error").'"'?>+elementError+'</span>'+<?echo '"<span style=\"color:red\">'.GetMessage("parser_all_error").'"'?>+allError+'</span>';
                    $("#catalog_bar").html(msg);
                    if(sotbitStop==1)
                    {   
                        prog = 100;
                        $('#progress_text').html(prog + '%');
                        $('#progress_bar_inner').width(500 * prog / 100);
                        $('#progress_text').html(<?echo '"'.GetMessage("parser_loading_end").'"'?>); 
                    }else sotbitCountAjax(href1, 0);
                    
                    
                })    
        }

    })

    BX.ready(function(){

        BX.bind(BX('btn_start'), 'click', function(e) {
            e.preventDefault();
            BX.show(BX('status_bar'));
            var href1 = BX(this).getAttribute("href")+"&ajax_count=1";
            var href2 = BX(this).getAttribute("href")+"&ajax_start=1";

            var ajaxInterval = setInterval(function(){
                BX.ajax.post(href1, "sessid="+BX.bitrix_sessid(), function(data){
                    arData = data.split("|");
                    if(arData[1]>0)prog = Math.ceil((arData[1]/arData[0])*100);
                    else prog = 0;
                    BX('progress_text').innerHTML = prog + '%';
                    BX('progress_bar_inner').style.width = 500 * prog / 100 + 'px';
                    if(prog==1) clearInterval(ajaxInterval);
                })
            }, 500);


            BX.ajax.get(href2, "", function(data){
                clearInterval(ajaxInterval);
                prog = 100;
                BX('progress_text').innerHTML = prog + '%';
                BX('progress_bar_inner').style.width = 500 * prog / 100 + 'px';
                BX.hide(BX('status_bar'));
                BX('progress_text').innerHTML = 0 + '%';
                BX("shs_message").innerHTML = data;

            })

            return false;

        })

        
    })
</script>
<style>
.adm-info-message table td, .heading .adm-info-message td, .heading .adm-info-message td{
    padding:0!important;
}
.item_row td{
  padding:0!important;  
}
</style>
<?require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/epilog_admin.php");?>
<?elseif(isset($_REQUEST["ajax_start"]) && isset($_REQUEST["ID"]) && isset($_REQUEST["start"]) && !isset($_REQUEST["ajax_count"])):
    set_time_limit(0);
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");
    IncludeModuleLangFile(__FILE__);
    if(CModule::IncludeModule('iblock') && CModule::IncludeModule('main')):
    $parser = ShsParserContent::GetByID($ID);
    if(!$parser->ExtractFields("shs_")) $ID=0;
    $rssParser = new RssContentParser();
    $result = $rssParser->startParser(0);
    endif;
?>
<?elseif(isset($_REQUEST["ID"]) && isset($_REQUEST["start"]) && isset($_REQUEST["ajax_count"])):
    set_time_limit(0);
    $file = $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/count_parser".$_REQUEST["ID"].".txt";
    if(isset($_REQUEST["ID"]) && file_exists($file)){
        $count = file_get_contents($file);
        echo $count;
    }else{
        echo "0|0";
    }
    if($_GET["type"]=="catalog" || $_GET["type"]=="xml")
    {
        $file1 = $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/count_parser_catalog".$_REQUEST["ID"].".txt";
        if(isset($_REQUEST["ID"]) && file_exists($file1))
        {
            $count = file_get_contents($file1);
            echo $count;
        }else{
            echo "|0|0|0|0";
        }
        $file2 = $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/catalog_parser_current_page".$_REQUEST["ID"].".txt";
        if(isset($_REQUEST["ID"]) && file_exists($file2))
        {
            $content = file_get_contents($file2);
            if($content=="")
            {
                echo "|1";
                unlink($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/catalog_parser_current_page".$_REQUEST["ID"].".txt");    
            }
        }    
    }
    //print_r(array($_REQUEST["ID"], file_exists($file), $file));
    //file_put_contents(dirname(__FILE__)."/log.log", print_r(array("REQIEST" => $_REQUEST, "GET" => $_GET), true), FILE_APPEND);
?>
<?
elseif(isset($_REQUEST["prop_id"])):
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");
        IncludeModuleLangFile(__FILE__);
    CModule::IncludeModule('iblock');
    if(isset($_REQUEST["default"])) $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "CODE"=>$_REQUEST["prop_id"], "IBLOCK_ID"=>$_REQUEST["iblock_id"]));
    else $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "ID"=>$_REQUEST["prop_id"]));
    while($arProp = $properties->Fetch())
    {   //printr($arProp);
        if(!isset($_REQUEST["default"]))
        {
            echo $arProp["CODE"];
            return false;    
        }else{
            $code = $arProp["CODE"];
            if($arProp["PROPERTY_TYPE"]=="L" || $arProp["PROPERTY_TYPE"]=="N" || $arProp["PROPERTY_TYPE"]=="S" || $arProp["PROPERTY_TYPE"]=="E" || $arProp["PROPERTY_TYPE"]=="F")
            {
                $arrPropDop['REFERENCE'][] = $arProp["NAME"];
                $arrPropDop['REFERENCE_ID'][] = $arProp["CODE"];
                $arrPropDop['REFERENCE_TYPE'][$arProp["CODE"]] = $arProp["PROPERTY_TYPE"];
                $arrPropDop['USER_TYPE'][$arProp["CODE"]] = $arProp["USER_TYPE"];
                $arrPropDop['REFERENCE_CODE_NAME'][$arProp["CODE"]] = $arProp["NAME"];
            }
            
            if($arProp["PROPERTY_TYPE"]=="L"/* && $arProp["ID"]==14*/)
            {
                $rsEnum = CIBlockPropertyEnum::GetList(Array("DEF"=>"DESC", "SORT"=>"ASC"), Array("IBLOCK_ID"=>$shs_IBLOCK_ID, "property_id"=>$arProp["ID"]));
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
                while($arEnum = $rsEnum->Fetch())
                {
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $arEnum["VALUE"];
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $arEnum["ID"];
                }
            }
            if($arProp['USER_TYPE']=="directory")
            {
                $nameTable = $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"];
                $directorySelect = array("*");
                $directoryOrder = array();
                $entityGetList = array(
                    'select' => $directorySelect,
                    'order' => $directoryOrder
                );
                $highBlock = \Bitrix\Highloadblock\HighloadBlockTable::getList(array("filter" => array('TABLE_NAME' => $nameTable)))->fetch();
                $entity = \Bitrix\Highloadblock\HighloadBlockTable::compileEntity($highBlock);
                $entityDataClass = $entity->getDataClass();
                $propEnums = $entityDataClass::getList($entityGetList);
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
                while ($oneEnum = $propEnums->fetch())
                {
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $oneEnum["UF_NAME"];
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $oneEnum["UF_XML_ID"];
                }
            }
                
                ?><?if($arrPropDop['REFERENCE_TYPE'][$code]=="L"):
            ?>
            <?=SelectBoxFromArray('SETTINGS[catalog][default_prop]['.$code.']', $arrPropDop["LIST_VALUES"][$code], "", "", "");?>
            <?elseif($arrPropDop['USER_TYPE'][$code]=="directory"):?>
            <?=SelectBoxFromArray('SETTINGS[catalog][default_prop]['.$code.']', $arrPropDop["LIST_VALUES"][$code], "", "", "");?>
            <?else:?>
            <input type="text" placeholder="<?=GetMessage("parser_prop_default")?>" name="SETTINGS[catalog][default_prop][<?=$code?>]" value="" />
            <?endif?><?
                
                
        }
        
        
    }
    
    
elseif(isset($_REQUEST["iblock"])):
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");
        IncludeModuleLangFile(__FILE__);
    CModule::IncludeModule('iblock');
    $rsSections = CIBlockSection::GetList(array("left_margin"=>"asc"), array(/*'ACTIVE'=>"Y", */"IBLOCK_ID"=>$_REQUEST["iblock"]), false, array('ID', 'NAME', "IBLOCK_ID", "DEPTH_LEVEL"));

    $first = true;
    echo '<option value="">'.GetMessage("parser_section_id").'</option>';
    while($arr=$rsSections->Fetch()){
        $arr["NAME"] = str_repeat(" . ", $arr["DEPTH_LEVEL"]).$arr["NAME"];
        echo '<option value="'.$arr["ID"].'">'.$arr["NAME"].'</option>';
    }
    echo '#SOTBIT#<option value="">'.GetMessage("parser_prop_id").'</option>';
    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$_REQUEST['iblock'], "PROPERTY_TYPE"=>"S"));
    while($arProp = $properties->Fetch())
    {
        echo '<option value="'.$arProp["CODE"].'">'."[".$arProp["CODE"]."] ".$arProp["NAME"].'</option>';
    }




    echo '#SOTBIT#';
    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$_REQUEST['iblock']));
    while($arProp = $properties->Fetch())
    {
        if($arProp["PROPERTY_TYPE"]=="S" || $arProp["PROPERTY_TYPE"]=="L" || $arProp["PROPERTY_TYPE"]=="N" ||  $arProp["PROPERTY_TYPE"]=="E")
        {
            $arPropsDop[] = $arProp;
        }

         //echo '<option value="'.$arProp["CODE"].'">'."[".$arProp["CODE"]."] ".$arProp["NAME"].'</option>';
    }
    foreach($arPropsDop as $val)
    {
        echo '<tr><td width="40%" class="adm-detail-content-cell-l">'.$val["NAME"].'&nbsp;['.$val["CODE"].']:</td><td width="60%" class="adm-detail-content-cell-r"><input data-code="'.$val["CODE"].'" size="40" type="text" value="" name="SETTINGS[catalog][selector_prop]['.$val["CODE"].']">&nbsp;<a class="prop_delete" href="#">Delete</a></td></tr>';
    }
    echo '#SOTBIT#';
    foreach($arPropsDop as $val)
    {
        echo '<tr><td width="40%" class="adm-detail-content-cell-l">'.$val["NAME"].'&nbsp;['.$val["CODE"].']:</td><td width="60%" class="adm-detail-content-cell-r"><input data-code="'.$val["CODE"].'" size="40" type="text" value="" name="SETTINGS[catalog][find_prop]['.$val["CODE"].']">&nbsp;<a class="find_delete" href="#">Delete</a></td></tr>';
    }

    echo '#SOTBIT#<option value="">'.GetMessage("parser_prop_id").'</option>';
    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$_REQUEST['iblock'], "PROPERTY_TYPE"=>"F"));
    while($arProp = $properties->Fetch())
    {
        echo '<option value="'.$arProp["CODE"].'">'."[".$arProp["CODE"]."] ".$arProp["NAME"].'</option>';
    }
elseif(isset($_POST["auth"])):
    set_time_limit(0);
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");
    IncludeModuleLangFile(__FILE__);
    if(CModule::IncludeModule('iblock') && CModule::IncludeModule('main')):
    $parser = ShsParserContent::GetByID($ID);
    if(!$parser->ExtractFields("shs_")) $ID=0;
    $rssParser = new RssContentParser();
    $rssParser->auth(true);
    endif;
endif;
?>52   62832|/shs.parser/admin/parser_edit_xml.php|f5b33aa9<?
use Bitrix\Seo\Engine;
use Bitrix\Main\Text\Converter;
use Bitrix\Main\Localization\Loc;
use Bitrix\Main\IO\Path;

\Bitrix\Main\Loader::includeModule('seo');
\Bitrix\Main\Loader::includeModule('socialservices');   
global $shs_IBLOCK_ID;
/***
****  
***/
$tabControl->BeginNextTab();
$arEncoding['reference'] = array('utf-8', 'windows-1251');
$arEncoding['reference_id'] = array('utf-8', 'windows-1251');
$arType['reference'] = array('html', 'text');
$arType['reference_id'] = array('html', 'text');
$arMode['reference'] = array('debug', 'work');
$arMode['reference_id'] = array('debug', 'work');
$arTypeAddAutoProps['reference'] = array(GetMessage("parser_type_string"), GetMessage("parser_type_list"));
$arTypeAddAutoProps['reference_id'] = array('S', 'L');
$arFieldWriteIdSection['reference'] = array(GetMessage("field_xml_id"), GetMessage("field_ext"));
$arFieldWriteIdSection['reference_id'] = array('XML_ID', 'EXT_FIELD');
if($shs_DEMO!=1)
{
    unset($arMode['reference'][1]);
    unset($arMode['reference_id'][1]);    
}


$arOfferLoad['reference'] = array(GetMessage("parser_offer_load_no"), GetMessage("parser_offer_load_table"), GetMessage("parser_offer_load_one"));
$arOfferLoad['reference_id'] = array('', 'table', 'one');


$arTypeParser['reference'] = array('rss', 'page', 'catalog', 'xml');
$arTypeParser['reference_id'] = array('rss', 'page', 'catalog', 'xml');

$arUpdate['reference'] = array(GetMessage("parser_update_N"), GetMessage("parser_update_Y"), GetMessage("parser_update_empty"));
$arUpdate['reference_id'] = array('N', 'Y', 'empty');

$arAction['reference'] = array(GetMessage("parser_action_N"), GetMessage("parser_action_A"), GetMessage("parser_action_D"));
$arAction['reference_id'] = array('N', 'A', 'D');

//$arPriceTerms['reference'] = array(GetMessage("parser_price_terms_no"), GetMessage("parser_price_terms_up"), GetMessage("parser_price_terms_down"));
//$arPriceTerms['reference_id'] = array('', 'up', 'down');

$arPriceTerms['reference'] = array(GetMessage("parser_price_terms_no"), GetMessage("parser_price_terms_delta"));
$arPriceTerms['reference_id'] = array('', 'delta');  

$arPriceUpDown['reference'] = array(GetMessage("parser_price_updown_no"), GetMessage("parser_price_updown_up"), GetMessage("parser_price_updown_down"));
$arPriceUpDown['reference_id'] = array('', 'up', 'down');

$arPriceValue['reference'] = array(GetMessage("parser_price_percent"), GetMessage("parser_price_abs_value"));
$arPriceValue['reference_id'] = array('percent', 'value');

$arAuthType['reference'] = array(GetMessage("parser_auth_type_form"), GetMessage("parser_auth_type_http"));
$arAuthType['reference_id'] = array('form', 'http');


$hideCatalog = false;
if($isCatalog && CModule::IncludeModule('catalog') && CModule::IncludeModule('currency')/* && (($shs_IBLOCK_ID && CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y", "ID"=>$shs_IBLOCK_ID))->Fetch()) || !$shs_IBLOCK_ID)*/)
{   
    $dbPriceType = CCatalogGroup::GetList(
        array("SORT" => "ASC"),
        array()
    );
      
    while ($arPriceTypes = $dbPriceType->Fetch())
    {
        $arPriceType["reference"][] = $arPriceTypes["NAME_LANG"];
        $arPriceType["reference_id"][] = $arPriceTypes["ID"];
    }
    $arConvertCurrency["reference"][] = GetMessage("parser_convert_no");
    $arConvertCurrency["reference_id"][] = "";
    
    $arPriceOkrug["reference"] = array(GetMessage("parser_price_okrug_no"), GetMessage("parser_price_okrug_up"), GetMessage("parser_price_okrug_ceil"), GetMessage("parser_price_okrug_floor"));
    $arPriceOkrug["reference_id"] = array("", "up", "ceil", "floor");
    
    $lcur = CCurrency::GetList(($by="name"), ($order1="asc"), LANGUAGE_ID);
    while($lcur_res = $lcur->Fetch())
    {
        $arCurrency["reference"][] = $lcur_res["FULL_NAME"];
        $arCurrency["reference_id"][] = $lcur_res["CURRENCY"];
        $arConvertCurrency["reference"][] = $lcur_res["FULL_NAME"];
        $arConvertCurrency["reference_id"][] = $lcur_res["CURRENCY"];
    }
    $info = CModule::CreateModuleObject('catalog');
    
    if(!CheckVersion("14.0.0", $info->MODULE_VERSION))
    {   
        $dbResultList = CCatalogMeasure::getList(array(), array(), false, false, array("ID", "CODE", "MEASURE_TITLE", "SYMBOL_INTL", "IS_DEFAULT"));
        while($arMeasure = $dbResultList->Fetch())
        {
            $arAllMeasure["reference_id"][] = $arMeasure["ID"];
            $arAllMeasure["reference"][] = $arMeasure["MEASURE_TITLE"];
        }
    }
     
    $arVATRef = CatalogGetVATArray(array(), true);

}else $hideCatalog = true;

/*
if(isset($arrPropDop))
{
    $arrPropField['REFERENCE'] = array_merge($arrPropField['REFERENCE'], $arrPropDop["REFERENCE"]);
    $arrPropField['REFERENCE_ID'] = array_merge($arrPropField['REFERENCE_ID'], $arrPropDop["REFERENCE_ID"]);    
}*/

$arrActionProps['REFERENCE'] = array(GetMessage("parser_action_props_delete"), GetMessage("parser_action_props_add_begin"), GetMessage("parser_action_props_add_end"));
$arrActionProps['REFERENCE_ID'] = array("delete", "add_b", "add_e");
    

$disabled = false;
unset($arrDateActive['REFERENCE'][2]);
unset($arrDateActive['REFERENCE_ID'][2]);
$arrDate = ParseDateTime($shs_START_LAST_TIME_X, "YYYY.MM.DD HH:MI:SS");
if($shs_TYPE)$disabled  = 'disabled=""';
?>
    <tr>
        <td><?echo GetMessage("parser_type")?></td>
        <td><?=SelectBoxFromArray('TYPE', $arTypeParser, $shs_TYPE?$shs_TYPE:$_GET["type"], "", $disabled);?>
        <?if($disabled):?><input type="hidden" name="TYPE" value="<?=$shs_TYPE?>" /><?endif;?>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
                <?=BeginNote();?>
                <?echo GetMessage("parser_mode_descr_yml")?>
                <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_mode")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][mode]', $arMode, $shs_SETTINGS["catalog"]["mode"]?$shs_SETTINGS["catalog"]["mode"]:"debug", "", "");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_mode_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_act")?></td>
        <td width="60%"><input type="checkbox" name="ACTIVE" value="Y"<?if($shs_ACTIVE == "Y" || !$ID) echo " checked"?>>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_sort")?></td>
        <td><input type="text" name="SORT" value="<?echo !$ID?"100":$shs_SORT;?>" size="4"></td>
    </tr>
    <?if(isset($arCategory) && !empty($arCategory)):?>
    <tr>
        <td><?echo GetMessage("parser_category_title")?></td>
        <td><?=SelectBoxFromArray('CATEGORY_ID', $arCategory, isset($shs_CATEGORY_ID)?$shs_CATEGORY_ID:$parentID, GetMessage("parser_category_select"), "id='category' style='width:262px'");?></td>
    </tr>
    <?endif;?>
    <tr>
        <td><span class="required">*</span><?echo GetMessage("parser_name")?></td>
        <td><input type="text" name="NAME" value="<?echo $shs_NAME;?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><span class="required">*</span><?echo GetMessage("parser_xml_catalog")?></td>
        <td><input style="style="float: left;" id="RSS" type="text" name="RSS" value="<?echo $shs_RSS;?>" size="80" maxlength="500"><span class="adm-btn" id="butoon_rss"><?=GetMessage("button_caption")?></span>
		<?
		CAdminFileDialog::ShowScript(Array
			(
				"event" => "OpenFileXml",
				"arResultDest" => Array("FUNCTION_NAME" => "OpenFileXmlResult"),
				"arPath" => Array(),
				"select" => 'F',
				"operation" => 'O',
				"showUploadTab" => true,
				"showAddToMenuTab" => false,
				"fileFilter" => '',
				"allowAllFiles" => true,
				"saveConfig" => true
			)
		);
		?>
		<script>
			document.getElementById("butoon_rss").onclick = OpenFileXml;
			var OpenFileXmlResult = function(filename,path,site)
			{
				if(path != "/") path = path + "/";
                document.getElementById('RSS').value = path + filename;
			}
		</script>
		</td>
    </tr>
    <tr>
        <td style="vertical-align:top"><?echo GetMessage("parser_url_xml_dop")?></td>
        <td style="vertical-align:top">
            <textarea style="float: left" id="URL_DOP" name="SETTINGS[catalog][url_dop]" cols="65" rows="5"><?=$shs_SETTINGS["catalog"]["url_dop"]?></textarea><span class="adm-btn" id="butoon_url_dop"><?=GetMessage("button_caption")?></span>
        <?
        CAdminFileDialog::ShowScript(Array
            (
                "event" => "OpenFileXmlUrlDop",
                "arResultDest" => Array("FUNCTION_NAME" => "OpenFileXmlUrlDopResult"),
                "arPath" => Array(),
                "select" => 'F',
                "operation" => 'O',
                "showUploadTab" => true,
                "showAddToMenuTab" => false,
                "fileFilter" => '',
                "allowAllFiles" => true,
                "saveConfig" => true
            )
        );
        ?>
        <script>
            document.getElementById("butoon_url_dop").onclick = OpenFileXmlUrlDop;
            function trim()
            {
                return this.replace(/^\n+|\n+$/g, '');
            }
            var OpenFileXmlUrlDopResult = function(filename,path,site)
            {
                var str = document.getElementById('URL_DOP').value;
                str = str.trim();
                if (path != "/") path = path + "/";
                document.getElementById('URL_DOP').value = str + "\n" + path + filename;
            }
        </script>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_url_dop_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><span class="required">*</span><?echo GetMessage("parser_iblock_id_catalog")?></td>
        <td><?=SelectBoxFromArray('IBLOCK_ID', $arIBlock, $shs_IBLOCK_ID, GetMessage("parser_iblock_id"), "id='iblock' style='width:262px' ");?>
            <?/*?><?if($disabled):?><input type="hidden" name="IBLOCK_ID" value="<?=$shs_IBLOCK_ID?>" /><?endif;*/?>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_iblock_id_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_add_section")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][add_parser_section]" value="Y"<?if($shs_SETTINGS['catalog']['add_parser_section'] == 'Y') echo " checked"?>>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_add_section_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_section_id")?></td>
        <td><?=SelectBoxFromArray('SECTION_ID', $arSection, $shs_SECTION_ID, GetMessage("parser_section_id"), "id='section' style='width:262px'");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_encoding")?></td>
        <td><?=SelectBoxFromArray('ENCODING', $arEncoding, $shs_ENCODING);?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_encoding_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_step")?></td>
        <td><input type="text" name="SETTINGS[catalog][step]" value="<?echo $shs_SETTINGS["catalog"]["step"]?$shs_SETTINGS["catalog"]["step"]:300;?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_start_last_time")?></td>
        <td><input type="text" disabled name="START_LAST_TIME_X" value="<?echo $arrDate[DD].'.'.$arrDate[MM].'.'.$arrDate[YYYY].' '.$arrDate[HH].':'.$arrDate[MI].':'.$arrDate[SS];?>" size="20"></td>
    </tr>      
<?
//********************
//  
//********************
$tabControl->BeginNextTab();
?>  
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_category_description")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_section_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_category]" value="<?echo isset($shs_SETTINGS["catalog"]["selector_category"])?$shs_SETTINGS["catalog"]["selector_category"]:"categories category";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_section_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
     <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_attr_name_section_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][attr_category]" value="<?echo isset($shs_SETTINGS["catalog"]["attr_category"])?$shs_SETTINGS["catalog"]["attr_category"]:"";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_attr_category_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_attr_id_section_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][attr_id_category]" value="<?echo isset($shs_SETTINGS["catalog"]["attr_id_category"])?$shs_SETTINGS["catalog"]["attr_id_category"]:"[id]";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_attr_id_category_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_attr_id_parrent_category_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][attr_id_parrent_category]" value="<?echo isset($shs_SETTINGS["catalog"]["attr_id_parrent_category"])?$shs_SETTINGS["catalog"]["attr_id_parrent_category"]:"[parentId]";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_attr_id_parrent_category_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_field_id_category_catalog")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][field_id_category]', $arFieldWriteIdSection, $shs_SETTINGS["catalog"]["field_id_category"]?$shs_SETTINGS["catalog"]["field_id_category"]:"XML_ID", "", "");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_field_id_category_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_offer_description")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_preview_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector]" value="<?echo isset($shs_SETTINGS["catalog"]["selector"])?$shs_SETTINGS["catalog"]["selector"]:"offers offer";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_catalog_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_preview_id_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][id_selector]" value="<?echo isset($shs_SETTINGS["catalog"]["id_selector"])?$shs_SETTINGS["catalog"]["id_selector"]:"[id]";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_id_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_categoryId_catalog")?></td>
        <td><input type="text" name="SETTINGS[catalog][id_section]" value="<?echo isset($shs_SETTINGS["catalog"]["id_section"])?$shs_SETTINGS["catalog"]["id_section"]:"categoryId";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_categoryId_descr_catalog")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_name_catalog_xml")?></td>
        <td><input type="text" name="SETTINGS[catalog][name]" value="<?echo isset($shs_SETTINGS["catalog"]["name"])?$shs_SETTINGS["catalog"]["name"]:"name";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_name_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>

    <tr>
        <td><?echo GetMessage("parser_preview_price_xml")?></td>
        <td><input type="text" name="SETTINGS[catalog][preview_price]" value="<?echo isset($shs_SETTINGS["catalog"]["preview_price"])?$shs_SETTINGS["catalog"]["preview_price"]:"price";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_price_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_xml_text_selector")?></td>
        <td><input type="text" name="SETTINGS[catalog][detail_text_selector]" value="<?echo isset($shs_SETTINGS["catalog"]["detail_text_selector"])?$shs_SETTINGS["catalog"]["detail_text_selector"]:"description";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_description_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_first_img_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][preview_picture]" value="<?echo isset($shs_SETTINGS["catalog"]["preview_picture"])?$shs_SETTINGS["catalog"]["preview_picture"]:"picture:eq(0)";?>" size="40" maxlength="255" /></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_first_img_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][detail_picture]" value="<?echo isset($shs_SETTINGS["catalog"]["detail_picture"])?$shs_SETTINGS["catalog"]["detail_picture"]:"picture:eq(0)";?>" size="40" maxlength="255" /></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_first_img_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
<?
//********************
//
//********************
$tabControl->BeginNextTab();
?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_more_image")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_more_image_prop")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][more_image_props]', $arrPropFile, $shs_SETTINGS["catalog"]["more_image_props"], GetMessage("parser_prop_id"), "class='image_props'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_selector_more_image_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][more_image]" value="<?echo isset($shs_SETTINGS["catalog"]["more_image"])?$shs_SETTINGS["catalog"]["more_image"]:"picture";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_more_image_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading" id="header_selector_prop">
        <td colspan="2"><?echo GetMessage("parser_default_props")?></td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["default_prop"]) && !empty($shs_SETTINGS["catalog"]["default_prop"])):?>
    <?foreach($shs_SETTINGS["catalog"]["default_prop"] as $code=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%">
            <?if($arrPropDop['REFERENCE_TYPE'][$code]=="L"):
            ?>
            <?=SelectBoxFromArray('SETTINGS[catalog][default_prop]['.$code.']', $arrPropDop["LIST_VALUES"][$code], $shs_SETTINGS["catalog"]["default_prop"][$code], "", "");?>
            <?elseif($arrPropDop['USER_TYPE'][$code]=="directory"):?>
            <?=SelectBoxFromArray('SETTINGS[catalog][default_prop]['.$code.']', $arrPropDop["LIST_VALUES"][$code], $shs_SETTINGS["catalog"]["default_prop"][$code], "", "");?>
            <?else:?>
            <input type="text" <?if(!$shs_SETTINGS["catalog"]["default_prop"][$code]):?>placeholder="<?=GetMessage("parser_prop_default")?>"<?endif;?> name="SETTINGS[catalog][default_prop][<?=$code?>]" value="<?=$shs_SETTINGS["catalog"]["default_prop"][$code]?>" />
            <?endif?>
        </td>
    </tr>
    <?endforeach;?>
    <?endif;
    $arrPropDopDefault = $arrPropDop;
    unset($arrPropDopDefault['REFERENCE'][0]);
    unset($arrPropDopDefault['REFERENCE_ID'][0]);
    
    ?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDefault', $arrPropDopDefault, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadPropDefault" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr class="heading" id="header_selector_prop">
        <td colspan="2"><?echo GetMessage("parser_selector_props_xml")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_props_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["selector_prop"]) && !empty($shs_SETTINGS["catalog"]["selector_prop"])):?>
    <?foreach($shs_SETTINGS["catalog"]["selector_prop"] as $code=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%">
            <input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[catalog][selector_prop][<?=$code?>]" value="<?=$shs_SETTINGS["catalog"]["selector_prop"][$code]?>">
        </td>
    </tr>
    <?endforeach?>
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDop', $arrPropDop, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadDopProp" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr style="display:none">
        <td colspan="2"><input type="hidden" id="delete_selector_prop" name="SETTINGS[catalog][delete_selector_prop]" value="<?=$shs_SETTINGS["catalog"]["delete_selector_prop"]?>" /></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_prop_detail_preview_descr_file_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading" id="header_find_prop">
        <td colspan="2"><?echo GetMessage("parser_find_props_xml")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_add_auto_props")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][add_auto_props]" value="Y"<?if($shs_SETTINGS["catalog"]["add_auto_props"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_add_auto_props_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_find_props_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_find_props]" value="<?echo isset($shs_SETTINGS["catalog"]["selector_find_props"])?$shs_SETTINGS["catalog"]["selector_find_props"]:'param';?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_find_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_attr_auto_props")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][attr_auto_props]" value="<?echo isset($shs_SETTINGS["catalog"]["attr_auto_props"])?$shs_SETTINGS["catalog"]["attr_auto_props"]:'[name]';?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_attr_auto_props_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_attr_value_auto_props")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_attr_value_auto_props]" value="<?echo isset($shs_SETTINGS["catalog"]["selector_attr_value_auto_props"])?$shs_SETTINGS["catalog"]["selector_attr_value_auto_props"]:'';?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_attr_value_auto_props_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
   <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("type_add_auto_props")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][type_auto_props]', $arTypeAddAutoProps, $shs_SETTINGS["catalog"]["type_auto_props"]?$shs_SETTINGS["catalog"]["type_auto_props"]:"S", "", "");?></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("type_add_auto_props_description")?>
            <?=EndNote();?>
        </td>
    </tr>

    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_find_props_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_find_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr style="display:none">
        <td colspan="2"><input type="hidden" id="delete_find_prop" name="SETTINGS[catalog][delete_find_prop]" value="<?=$shs_SETTINGS["catalog"]["delete_find_prop"]?>" /></td>
    </tr>
    <tr class="heading" id="header_find_prop">
        <td colspan="2"><?echo GetMessage("parser_add_delete_symb_props")?></td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["action_props_val"]) && !empty($shs_SETTINGS["catalog"]["action_props_val"])):?>
    <?foreach($shs_SETTINGS["catalog"]["action_props_val"] as $code=>$arVal):
        foreach($arVal as $i=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=($code=="SOTBIT_PARSER_NAME_E")?GetMessage("parser_SOTBIT_PARSER_NAME_E"):$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;<?if($code=="SOTBIT_PARSER_NAME_E"):?><?else:?>[<?=$code?>]<?endif;?>:</td>
        <td width="60%"><input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[catalog][action_props_val][<?=$code?>][]" value="<?=$val?>">&nbsp; <?=SelectBoxFromArray('SETTINGS[catalog][action_props]['.$code.']['.$i.']', $arrActionProps, $shs_SETTINGS["catalog"]["action_props"][$code][$i], GetMessage("shs_parser_select_action_props"), "");?> <a class="find_delete" href="#">Delete</a></td>
    </tr>
        <?endforeach;?>
    <?endforeach;?>
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropField', $arrPropField, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadPropField" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr class="tr_find_prop">
    <?
    ?>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("shs_parser_action_props_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    

<?
//********************
// 
//********************
if(!$hideCatalog):
$tabControl->BeginNextTab();
?>
    <?//if($isOfferCatalog):?>
    <tr>
        <td><?echo GetMessage("parser_cat_price_offer")?></td>
        <td><input class="bool-delete" type="checkbox" name="SETTINGS[catalog][cat_vat_price_offer]" value="Y"<?if($shs_SETTINGS["catalog"]["cat_vat_price_offer"] == "Y") echo " checked"?> /></td>
    </tr>
    <?//endif;?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_price_type")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][price_type]', $arPriceType, $shs_SETTINGS["catalog"]["price_type"]?$shs_SETTINGS["catalog"]["price_type"]:1, "", "");?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_cat_vat_id")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][cat_vat_id]', $arVATRef, $shs_SETTINGS["catalog"]["cat_vat_id"], "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_cat_vat_included")?></td>
        <td><input class="bool-delete" type="checkbox" name="SETTINGS[catalog][cat_vat_included]" value="Y"<?if($shs_SETTINGS["catalog"]["cat_vat_included"] == "Y") echo " checked"?> /></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_currency")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][currency]', $arCurrency, $shs_SETTINGS["catalog"]["currency"]?$shs_SETTINGS["catalog"]["currency"]:"RUB", "", "");?></td>
    </tr>
    <?if(isset($arAllMeasure)):?>
    <tr>
        <td><?echo GetMessage("parser_measure")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][measure]', $arAllMeasure, $shs_SETTINGS["catalog"]["measure"]?$shs_SETTINGS["catalog"]["measure"]:5, "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_catalog_koef")?></td>
        <td><input type="text" name="SETTINGS[catalog][koef]" value="<?echo $shs_SETTINGS["catalog"]["koef"]?$shs_SETTINGS["catalog"]["koef"]:1;?>" size="40" maxlength="250"></td>
    </tr>
    
    <?endif;?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_work_price")?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_convert_currency")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][convert_currency]', $arConvertCurrency, $shs_SETTINGS["catalog"]["convert_currency"], "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_price_okrug")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_okrug]', $arPriceOkrug, $shs_SETTINGS["catalog"]["price_okrug"], "", "style=\"width:115px\"");?> <?echo GetMessage("parser_price_okrug_delta1")?> <input type="text" name="SETTINGS[catalog][price_okrug_delta]" value="<?echo $shs_SETTINGS["catalog"]["price_okrug_delta"]?>" size="1" maxlength="1"> <?echo GetMessage("parser_price_okrug_delta2")?> </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_price_okrug_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_price_format")?></td>
        <td><?echo GetMessage("parser_price_format1")?><input type="text" name="SETTINGS[catalog][price_format1]" value="<?echo $shs_SETTINGS["catalog"]["price_format1"]?>" size="1" maxlength="250"><?echo GetMessage("parser_price_format2")?><input type="text" name="SETTINGS[catalog][price_format2]" value="<?echo $shs_SETTINGS["catalog"]["price_format2"]?>" size="1" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_price_format_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    $count = count($shs_SETTINGS["catalog"]["price_updown"])-1;
    if(is_set($shs_SETTINGS["catalog"]["price_updown"]) && is_array($shs_SETTINGS["catalog"]["price_updown"]) && count($shs_SETTINGS["catalog"]["price_updown"])>0){
    foreach($shs_SETTINGS["catalog"]["price_updown"] as $i=>$val):
    if($count==$i) $class="tr_add";
    else $class = "";
    ?>
    <tr class="heading <?=$class?>" data-num="<?=($i+1)?>">
        <td colspan="2"><?echo GetMessage("parser_work_price_num")?> <span><?=($i+1)?></span> <?if($count==$i):?><a href="#" style="font-size:12px;" class="add_usl"><?echo GetMessage("parser_price_num_add")?></a><?endif;?>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" style="font-size:12px;<?if($i==0):?>display:none<?endif;?>" class="del_usl"><?echo GetMessage("parser_price_num_del")?></a></td>
    </tr>
    <tr class="<?=$class?>">
        <td><?echo GetMessage("parser_price_updown")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_updown][]', $arPriceUpDown, $shs_SETTINGS["catalog"]["price_updown"][$i], "", "");?></td>
    </tr>
    <tr class="<?=$class?>">
        <td><?echo GetMessage("parser_price_terms")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_terms][]', $arPriceTerms, $shs_SETTINGS["catalog"]["price_terms"][$i], "", "");?> <?echo GetMessage("parser_price_from")?> <input type="text" name="SETTINGS[catalog][price_terms_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value"][$i];?>" size="10" maxlength="250"> <?echo GetMessage("parser_price_to")?> <input type="text" name="SETTINGS[catalog][price_terms_value_to][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value_to"][$i];?>" size="10" maxlength="250"></td>
    </tr>
    <tr class="<?=$class?>">
        <td><?echo GetMessage("parser_price_type_value")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_type_value][]', $arPriceValue, $shs_SETTINGS["catalog"]["price_type_value"][$i], "", "");?></td>
    </tr>
    <tr class="<?=$class?> <?if($class):?>tr_last<?endif;?>">
        <td><?echo GetMessage("parser_price_value")?></td>
        <td><input type="text" name="SETTINGS[catalog][price_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_value"][$i];?>" size="10" maxlength="250"></td>
    </tr>
    <?endforeach;
    }else{
    ?>
    <tr class="heading tr_add" data-num="1">
        <td colspan="2"><?echo GetMessage("parser_work_price_num")?> <span></span> <a href="#" style="font-size:12px;" class="add_usl"><?echo GetMessage("parser_price_num_add")?></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" style="font-size:12px;display:none" class="del_usl"><?echo GetMessage("parser_price_num_del")?></a></td>
    </tr>
    <tr class="tr_add">
        <td><?echo GetMessage("parser_price_updown")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_updown][]', $arPriceUpDown, $shs_SETTINGS["catalog"]["price_updown"], "", "");?></td>
    </tr>
    <tr class="tr_add">
        <td><?echo GetMessage("parser_price_terms")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_terms][]', $arPriceTerms, $shs_SETTINGS["catalog"]["price_terms"], "", "");?> <?echo GetMessage("parser_price_from")?> <input type="text" name="SETTINGS[catalog][price_terms_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value"];?>" size="10" maxlength="250"> <?echo GetMessage("parser_price_to")?> <input type="text" name="SETTINGS[catalog][price_terms_value_to][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value_to"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr class="tr_add">
        <td><?echo GetMessage("parser_price_type_value")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_type_value][]', $arPriceValue, $shs_SETTINGS["catalog"]["price_type_value"], "", "");?></td>
    </tr>
    <tr class="tr_add tr_last">
        <td><?echo GetMessage("parser_price_value")?></td>
        <td><input type="text" name="SETTINGS[catalog][price_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_value"];?>" size="10" maxlength="250"></td>
    </tr>
    
    <?}?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_size_selector")?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_length")?></td>
        <td><input type="text" name="SETTINGS[catalog][selector_product][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["LENGTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["LENGTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_width")?></td>
        <td><input type="text" name="SETTINGS[catalog][selector_product][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["WIDTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["WIDTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_height")?></td>
        <td><input type="text" name="SETTINGS[catalog][selector_product][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["HEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["HEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_size_weight")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_product][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["WEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["WEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_size_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_size_find")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_find")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_find_size]" value="<?echo $shs_SETTINGS["catalog"]["selector_find_size"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_length")?></td>
        <td><input type="text" name="SETTINGS[catalog][find_product][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["LENGTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["LENGTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_width")?></td>
        <td><input type="text" name="SETTINGS[catalog][find_product][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["WIDTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["WIDTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_height")?></td>
        <td><input type="text" name="SETTINGS[catalog][find_product][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["HEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["HEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_size_weight")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][find_product][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["WEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["WEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_find_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_find_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_find_size_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
<?
endif;
//if(!$hideCatalog):
//$tabControl->BeginNextTab();
?>
    
<?
//********************
// 
//********************
$tabControl->BeginNextTab();
?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_active_element")?></td>
        <td width="60%"><input type="checkbox" name="ACTIVE_ELEMENT" value="Y"<?if($shs_ACTIVE_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_code_element")?></td>
        <td width="60%"><input type="checkbox" name="CODE_ELEMENT" value="Y"<?if($shs_CODE_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_index_element")?></td>
        <td width="60%"><input type="checkbox" name="INDEX_ELEMENT" value="Y"<?if($shs_INDEX_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_resize_image")?></td>
        <td width="60%"><input type="checkbox" name="RESIZE_IMAGE" value="Y"<?if($shs_RESIZE_IMAGE == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_from_detail")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][img_preview_from_detail]" value="Y"<?if($shs_SETTINGS["catalog"]["img_preview_from_detail"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_from_detail_text")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][text_preview_from_detail]" value="Y"<?if($shs_SETTINGS["catalog"]["text_preview_from_detail"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_date_active")?></td>
        <td width="60%"><input type="checkbox" name="DATE_ACTIVE" value="Y"<?if($shs_DATE_ACTIVE && $shs_DATE_ACTIVE != "N") echo " checked"?>> <?=SelectBoxFromArray('DATE_PROP_ACTIVE', $arrDateActive, $shs_DATE_ACTIVE, GetMessage("parser_date_type"), "id='prop-active' style='width:262px'");?></td>
    </tr>
    <?/*?><tr>
        <td width="40%"><?echo GetMessage("parser_date_public")?></td>
        <td width="60%"><input type="checkbox" name="DATE_PUBLIC" value="Y"<?if($shs_DATE_PUBLIC && $shs_DATE_PUBLIC != "N") echo " checked"?>> <?=SelectBoxFromArray('DATE_PROP_PUBLIC', $arrProp, $shs_DATE_PUBLIC, GetMessage("parser_prop_id"), "id='prop-date' style='width:262px' class='prop-iblock'");?></td>
    </tr><?*/?>

    <tr>
        <td width="40%"><?echo GetMessage("parser_start_agent")?></td>
        <td width="60%"><input type="checkbox" name="START_AGENT" value="Y"<?if($shs_START_AGENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_start_agent_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_time_agent")?></td>
        <td width="60%"><input type="text" size="40" name="TIME_AGENT" value="<?=$shs_TIME_AGENT?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_sleep")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][sleep]" value="<?=$shs_SETTINGS["catalog"]["sleep"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_sleep_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_proxy")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][proxy]" value="<?=$shs_SETTINGS["catalog"]["proxy"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_proxy_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
//********************
///
//********************
    $tabControl->BeginNextTab();
    ?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_uniq_update")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][active]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["active"] == "Y") echo " checked"?>></td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_header_uniq")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_uniq_name")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][uniq][name]" value="Y"<?if($shs_SETTINGS["catalog"]["uniq"]["name"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_uniq_prop")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][uniq][prop]', $arrProp, $shs_SETTINGS["catalog"]["uniq"]["prop"], GetMessage("parser_prop_id"), "id='style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_uniq_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_header_uniq_field")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_name")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][name]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["name"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_price")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][price]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["price"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_param")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][param]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["param"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_preview_descr")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][preview_descr]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["preview_descr"], "", "");?>
            <?/*?><input type="checkbox" name="SETTINGS[catalog][update][preview_descr]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["preview_descr"] == "Y") echo " checked"?>><?*/?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_detail_descr")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][detail_descr]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["detail_descr"], "", "");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_preview_img")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][preview_img]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["preview_img"], "", "");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_detail_img")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][detail_img]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["detail_img"], "", "");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_more_img")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][more_img]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["more_img"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_props")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][props]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["props"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_header_uniq_field_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_header_element_action")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_element_action")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][uniq][action]', $arAction, $shs_SETTINGS["catalog"]["uniq"]["action"], "", "");?>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_element_action_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    //********************
    //
    //********************
    $tabControl->BeginNextTab();
    ?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_type")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][auth][type]', $arAuthType, $shs_SETTINGS["catalog"]["auth"]["type"], "", "class='select_load'");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_active")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][auth][active]" value="Y"<?if($shs_SETTINGS["catalog"]["auth"]["active"] == "Y") echo " checked"?>></td>
    </tr>
    <?if((isset($shs_SETTINGS["catalog"]["auth"]["type"]) && $shs_SETTINGS["catalog"]["auth"]["type"]=="form") || !isset($shs_SETTINGS["catalog"]["auth"]["type"])):?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_url")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][url]" value="<?=$shs_SETTINGS["catalog"]["auth"]["url"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_auth_url_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_selector")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][selector]" value="<?=$shs_SETTINGS["catalog"]["auth"]["selector"]?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_login")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][login]" value="<?=$shs_SETTINGS["catalog"]["auth"]["login"]?>"> <?echo GetMessage("parser_auth_login_name")?> <input type="text" size="20" name="SETTINGS[catalog][auth][login_name]" value="<?=$shs_SETTINGS["catalog"]["auth"]["login_name"]?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_password")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][password]" value="<?=$shs_SETTINGS["catalog"]["auth"]["password"]?>"> <?echo GetMessage("parser_auth_password_name")?> <input type="text" size="20" name="SETTINGS[catalog][auth][password_name]" value="<?=$shs_SETTINGS["catalog"]["auth"]["password_name"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_auth_password_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?else:?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_login")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][login]" value="<?=$shs_SETTINGS["catalog"]["auth"]["login"]?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_password")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][password]" value="<?=$shs_SETTINGS["catalog"]["auth"]["password"]?>"></td>
    </tr>
    <?endif;?>
    <?if($shs_SETTINGS["catalog"]["auth"]["type"]=="form"):?>
    <tr>
        <td width="40%"></td>
        <td width="60%"><input type="button" size="40" id="auth" name="auth" data-href="<?=$APPLICATION->GetCurPageParam("auth=1", array("auth")); ?>" value="<?echo GetMessage('parser_auth_check')?>"></td>
    </tr>
    <?endif;?>
    <?
    //********************
    //
    //********************
    $tabControl->BeginNextTab();
    ?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_logs")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][log]" value="Y"<?if($shs_SETTINGS["catalog"]["log"] == "Y") echo " checked"?>></td>
    </tr>
    <?
    $file_log = $_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$_GET["ID"].".txt";
    if(isset($_GET["ID"]) && file_exists($file_log)):?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_logs_download")?></td>
        <td width="60%"><a href="<?=$APPLICATION->GetCurPageParam("log_ID=".$_GET["ID"], array("log_ID"));?>">catalog_log_<?=$_GET["ID"]?>.txt  (<?=ceil(filesize($file_log)/1024)?> KB)</a></td>
    </tr>
    <?endif?>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_header_log_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    //********************
    //
    //********************
    $tabControl->BeginNextTab();
    ?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_type_head")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_type")?>:</td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[loc][type]', $arLocType, $shs_SETTINGS["loc"]["type"], "", "class='select_load'");?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["loc"]["type"]) && $shs_SETTINGS["loc"]["type"]=="yandex"):?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_yandex_key")?>:</td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[loc][yandex][key]" value="<?=$shs_SETTINGS["loc"]["yandex"]["key"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_yandex_key_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_yandex_lang")?>:</td>
        <td width="60%"><input type="text" size="20" name="SETTINGS[loc][yandex][lang]" value="<?=$shs_SETTINGS["loc"]["yandex"]["lang"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_yandex_lang_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_fields")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_name")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_name]" value="Y"<?if($shs_SETTINGS["loc"]["f_name"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_preview_text")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_preview_text]" value="Y"<?if($shs_SETTINGS["loc"]["f_preview_text"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_detail_text")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_detail_text]" value="Y"<?if($shs_SETTINGS["loc"]["f_detail_text"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_props")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_props]" value="Y"<?if($shs_SETTINGS["loc"]["f_props"] == "Y") echo " checked"?>></td>
    </tr>
    <?endif;?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_uniq")?></td>
    </tr>
    <?
    $engine = new Engine\Yandex();
    $arSettings = $engine->getSettings();
    $arDomains = \CSeoUtils::getDomainsList();
    
    foreach($arDomains as $key => $domain)
    {
        if(!isset($arSettings['SITES'][$domain['DOMAIN']]))
        {
            unset($arDomains[$key]);
        }
    }

    if(count($arDomains) <= 0)
    {
        $msg = new CAdminMessage(array(
            'MESSAGE' => Loc::getMessage('SHS_PARSER_SEO_YANDEX_ERROR'),
            'HTML' => 'Y'
        ));
    }else{
        $arrDomain['REFERENCE'][] =  Loc::getMessage('shs_parser_loc_uniq_no');
        $arrDomain['REFERENCE_ID'][] = "";
        foreach($arDomains as $domain)
        {   //printr($domain);
            $domainEnc = Converter::getHtmlConverter()->encode($domain['DOMAIN']);
            $arrDomain['REFERENCE'][] =  $domainEnc;
            $arrDomain['REFERENCE_ID'][] = $domainEnc;
        }
    }
    ?>
    <?if(count($arDomains) <= 0):?>
    <tr>
        <td colspan="2" align="center"><?echo $msg->Show();?></td>
    </tr>
    <?else:?>
    <tr>
        <td><?echo GetMessage("parser_loc_uniq_domain")?>:</td>
        <td><?=SelectBoxFromArray('SETTINGS[loc][uniq][domain]', $arrDomain, $shs_SETTINGS["loc"]["uniq"]["domain"], "", "");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_uniq_domain_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?endif?>
    <?
    //********************
    // 
    //********************
    $tabControl->BeginNextTab();
    ?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_video_xml_descr")?></td>
    </tr>
    <tr>
        <td align="center" colspan="2" width="100%"><iframe width="800" height="500" src="//www.youtube.com/embed/vIMmjeo-xSg?list=PL2fR59TvIPXfB_XDmyp7pCnYoqQ-HhPXl" frameborder="0" allowfullscreen></iframe></td>
    </tr>
<?
if(isset($_GET["log_ID"]) && isset($_GET["ID"])):
    if (ob_get_level()) {
      ob_end_clean();
    }
    $file = $file_log;
    header('Content-Description: File Transfer');
    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename=' . basename($file));
    header('Content-Transfer-Encoding: binary');
    header('Expires: 0');
    header('Cache-Control: must-revalidate');
    header('Pragma: public');
    header('Content-Length: ' . filesize($file));
    readfile($file);
    exit();
endif;
$tabControl->Buttons(
    array(
        "disabled"=>($POST_RIGHT<"W"),
        "back_url"=>"list_parser_admin.php?lang=".LANG,

    )
);
?>
<?echo bitrix_sessid_post();?>
<input type="hidden" name="lang" value="<?=LANG?>">
<?if($ID>0 && !$bCopy):?>
    <input type="hidden" name="ID" value="<?=$ID?>">
<?endif;?>
<input type="hidden" name="parent" value="<?=$parentID?>">
<?
$tabControl->End();
?>

<?
$tabControl->ShowWarnings("post_form", $message);
?>63   34285|/shs.parser/classes/general/main_classes_xml.php|f337dfdb<?
use Bitrix\Highloadblock as HL; 
use Bitrix\Main\Entity;
use Bitrix\Seo\Engine;
use Bitrix\Main\Text\Converter;
use Bitrix\Main\Localization\Loc;
use Bitrix\Main\IO\Path;

\Bitrix\Main\Loader::includeModule('seo');
\Bitrix\Main\Loader::includeModule('socialservices');

class SotbitXmlParser{
    
    public $id = false;
    public $rss;
    public $typeN;
    public $active;
    public $iblock_id;
    public $section_id;
    public $detail_dom;
    public $encoding;
    public $preview_delete_tag="";
    public $bool_preview_delete_tag="";
    public $detail_delete_tag="";
    public $bool_detail_delete_tag="";
    public $preview_first_img="";
    public $detail_first_img="";
    public $preview_save_img="";
    public $detail_save_img="";
    public $text = "";
    public $site = "";
    public $link = "";
    public $preview_delete_element="";
    public $detail_delete_element="";
    public $preview_delete_attribute="";
    public $detail_delete_attribute="";
    public $index_element="";
    public $resize_image="";
    public $meta_description="";
    public $meta_keywords="";
    public $meta_description_text="";
    public $meta_keywords_text="";
    public $agent = false;
    public $active_element = "Y";
    public $header_url;
    public $settings;
    public $countPage = 0;
    public $countItem = 0;
    public $stepStart = false;
    public $countSection = 0;

    public $page;
    const TEST = 0;
    const DEFAULT_DEBUG_ITEM = 30;
    public function __construct()
    {
        global $zis, $shs_ID, $shs_TYPE, $shs_ACTIVE, $shs_IBLOCK_ID, $shs_RSS, $shs_SECTION_ID, $shs_SELECTOR, $shs_ENCODING, $shs_PREVIEW_DELETE_TAG, $shs_PREVIEW_TEXT_TYPE, $shs_DETAIL_TEXT_TYPE, $shs_BOOL_PREVIEW_DELETE_TAG,$shs_PREVIEW_FIRST_IMG, $shs_PREVIEW_SAVE_IMG, $shs_DETAIL_DELETE_TAG, $shs_BOOL_DETAIL_DELETE_TAG,$shs_DETAIL_FIRST_IMG, $shs_DETAIL_SAVE_IMG, $shs_PREVIEW_DELETE_ELEMENT, $shs_DETAIL_DELETE_ELEMENT, $shs_PREVIEW_DELETE_ATTRIBUTE, $shs_DETAIL_DELETE_ATTRIBUTE, $shs_INDEX_ELEMENT, $shs_CODE_ELEMENT, $shs_RESIZE_IMAGE, $shs_META_DESCRIPTION, $shs_META_KEYWORDS, $shs_ACTIVE_ELEMENT, $shs_FIRST_TITLE, $shs_DATE_PUBLIC, $shs_FIRST_URL, $shs_DATE_ACTIVE, $shs_META_TITLE, $shs_SETTINGS, $shs_TMP;
        $this->id = $shs_ID;
        $this->typeN = $shs_TYPE;
        $this->rss = $shs_RSS;
        $this->active = $shs_ACTIVE;
        $this->iblock_id = $shs_IBLOCK_ID;
        $this->section_id = $shs_SECTION_ID;
        $this->detail_dom = $shs_SELECTOR;
        $this->first_url = trim($shs_FIRST_URL);
        $this->encoding = $shs_ENCODING;
        $this->preview_text_type = $shs_PREVIEW_TEXT_TYPE;
        $this->detail_text_type = $shs_DETAIL_TEXT_TYPE;
        $this->preview_delete_tag = $shs_PREVIEW_DELETE_TAG;
        $this->detail_delete_tag = $shs_DETAIL_DELETE_TAG;
        $this->bool_preview_delete_tag = $shs_BOOL_PREVIEW_DELETE_TAG;
        $this->bool_detail_delete_tag = $shs_BOOL_DETAIL_DELETE_TAG;
        $this->preview_first_img = $shs_PREVIEW_FIRST_IMG;
        $this->detail_first_img = $shs_DETAIL_FIRST_IMG;
        $this->preview_save_img = $shs_PREVIEW_SAVE_IMG;
        $this->detail_save_img = $shs_DETAIL_SAVE_IMG;
        $this->preview_delete_element = $shs_PREVIEW_DELETE_ELEMENT;
        $this->detail_delete_element = $shs_DETAIL_DELETE_ELEMENT;
        $this->preview_delete_attribute = $shs_PREVIEW_DELETE_ATTRIBUTE;
        $this->detail_delete_attribute = $shs_DETAIL_DELETE_ATTRIBUTE;
        $this->index_element = ($shs_INDEX_ELEMENT=="Y")?true:false;
        $this->code_element = $shs_CODE_ELEMENT;
        $this->resize_image = ($shs_RESIZE_IMAGE=="Y")?true:false;
        $this->meta_title = $shs_META_TITLE;
        $this->meta_description = $shs_META_DESCRIPTION;
        $this->meta_keywords = $shs_META_KEYWORDS;
        $this->active_element = $shs_ACTIVE_ELEMENT;
        $this->first_title = $shs_FIRST_TITLE;
        $this->date_public = $shs_DATE_PUBLIC;
        $this->date_active = $shs_DATE_ACTIVE;
        $this->tmp = $shs_TMP;
        $this->settings = unserialize(base64_decode($shs_SETTINGS));
        $this->header_url = "";
        $this->sleep = (int)$this->settings[$this->typeN]["sleep"];
        $this->proxy = (int)$this->settings[$this->typeN]["proxy"];
        $this->errors = array();
        $this->auth = $this->settings[$this->typeN]["auth"]["active"]?true:false;
        $this->currentPage = 0;
        $this->activeCurrentPage = 0;
        $this->debugErrors = array();
        $this->stepStart = false;
        $this->pagePrevElement = array();
        $this->pagenavigationPrev = array();
        $this->pagenavigation = array();
            
    }

    protected function parseXmlCatalog()
    {   
        set_time_limit(0);
        $this->ClearAjaxFiles(); //    
        $this->DeleteLog(); //  
        $this->checkActionBegin(); 
        $this->arUrl = array(); 
        if(isset($this->settings["catalog"]["url_dop"]) && !empty($this->settings["catalog"]["url_dop"]))$this->arUrl = explode("\r\n", $this->settings["catalog"]["url_dop"]);
        
        $this->arUrl = array_merge(array($this->rss), $this->arUrl);
        $this->arUrlSave = $this->arUrl;
        
        if(!$this->PageFromFile()) return false; 
        $this->CalculateStep();
        if($this->settings["catalog"]["mode"]!="debug" && !$this->agent) $this->arUrlSave = array($this->rss);
        else $this->arUrlSave = $this->arUrl; 
        //if(!$this->connectCatalogPage($this->rss));
        //return;
        foreach($this->arUrlSave as $rss):
            $rss = trim($rss);
            if(empty($rss)) continue;
            $this->rss = $rss;
            $this->convetCyrillic($this->rss);
            $this->connectCatalogPage($this->rss);
            
            if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && isset($this->errors) && count($this->errors)>0)
            {
                $this->SaveLog();
                unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt");
                return false;    
            }
            if ($this->parseCatalogSectionXml($this->rss) === false)
            {
                if ($this->settings["catalog"]["add_parser_section"] == "Y")
                {
                    $this->SaveLog();
                    return false; 
                }   
            }
            $n = $this->currentPage;
            $this->parseCatalogProducts();
            if($this->settings["catalog"]["mode"]!="debug" && !$this->agent)
            {
                $this->stepStart = true;
                $this->SavePrevPage($this->rss);    
            }
         
            $this->SaveCurrentPage($this->pagenavigation);
            if($this->stepStart)
            {
                if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
                    unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                $this->DeleteCopyPage();
            } 
            if((!$this->CheckOnePageNavigation() && $this->agent) || (!$this->CheckOnePageNavigation() && !$this->agent && $this->settings["catalog"]["mode"]=="debug"))$this->parseCatalogPages();
            if($this->CheckOnePageNavigation() && $this->stepStart)
            {
                if($this->IsEndSectionUrl())$this->ClearBufferStop();
                else $this->ClearBufferStep();
                return false;    
            }
        endforeach;
        
        $this->checkActionAgent();
    }
 
    protected function parseCatalogProductElementXml(&$el)
    {
        $this->countItem++;
        $this->parseCatalogSection();
        if(!$this->parserCatalogPreviewXml($el))
        {
            $this->SaveCatalogError();
            $this->clearFields();
            return false;    
        }

        /*$this->parserCatalogDetail();
        $this->parseCatalogSection();
        $this->parseCatalogMeta();
        $this->parseCatalogFirstUrl();*/
        $this->parseCatalogDate();
        $this->parseCatalogAllFields();


        $db_events = GetModuleEvents("shs.parser", "parserBeforeAddElementXml", true);
        $error = false;
        foreach($db_events as $arEvent)
        {
            $bEventRes = ExecuteModuleEventEx($arEvent, array(&$this, &$el));
            if($bEventRes===false)
            {
                $error = true;
                break 1;
            }
        }

        if(!$error && !$error_isad)
        {
            $this->AddElementCatalog();
            foreach(GetModuleEvents("shs.parser", "parserAfterAddElementXml", true) as $arEvent)
                ExecuteModuleEventEx($arEvent, array(&$this, &$el));
        }

        if($this->isCatalog && $this->elementID)
        {   
            /*if($this->isOfferCatalog && !$this->boolOffer)
            {                                  
                $this->AddElementOfferCatalog();
                $this->elementID = $this->elementOfferID;
                $this->elementUpdate = $this->elementOfferUpdate;
            }*/
            if($this->boolOffer)
            {
                $this->addProductPriceOffers();
            }else{
                
                $this->AddProductCatalog();
                $this->AddMeasureCatalog();
                $this->AddPriceCatalog();    
            }
            
        }/*else{
            $this->AddElementOfferCatalog();
            $this->AddProductCatalog();
            $this->AddMeasureCatalog();
            $this->AddPriceCatalog();    
        }*/

        $this->SetCatalogElementsResult();
        $this->clearFields();
        
    }

    protected function parserCatalogPreviewXml(&$el)
    {
        if(!$this->parseCatalogIdElement($el)) return false;
        $this->parseCatalogNamePreview($el);
        //$this->parseCatalogPropertiesPreview($el);
        if($this->isCatalog)$this->parseCatalogPricePreview($el);
        if ($this->settings["catalog"]["add_parser_section"] == "Y") $this->parseCatalogParrentSection($el);
        $this->parseCatalogPreviewPicturePreview($el);
        $this->parseCatalogDetailPicture($el);
        $this->parseCatalogDescriptionXml($el);
        $this->parseCatalogDetailMorePhoto($el);
        $this->parseCatalogPropertiesXml($el);
        
        return true;
    }

    protected function parseCatalogPropertiesXml(&$el)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $this->parseCatalogDefaultProperties($el);
        $this->parseCatalogSelectorProperties($el);
        $this->parseCatalogAutoProps($el);
        $this->parseCatalogAutoPropsAdd();
        $this->AllDoProps();
        if($this->isCatalog)$this->parseCatalogFindProduct($el);
        if($this->isCatalog)$this->parseCatalogSelectorProduct($el);
    }

    protected function parseCatalogAutoProps(&$el)
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"])) return false;
        elseif (($this->settings["catalog"]["add_auto_props"] != "Y") && empty($this->settings["catalog"]["selector_find_props"]) && empty($this->settings["catalog"]["attr_auto_props"])) return false;
        $props = $this->settings["catalog"]["selector_find_props"];
        $props_name = $this->GetArraySrcAttr($this->settings["catalog"]["attr_auto_props"]);
        $arr_val = $this->GetArraySrcAttr($this->settings["catalog"]["selector_attr_value_auto_props"]);
        
        foreach(pq($el)->find($props) as $property)
        {
            $isset_props = false;
            
            if(empty($props_name["path"])){
                $name = trim(pq($property)->attr($props_name["attr"])); //name props
            }
            else{
                if(empty($props_name["attr"]))
                {
                    $name = trim(strip_tags(pq($property)->find($props_name["path"])->html()));
                }
                elseif(!empty($props_name["attr"]))
                {
                    $name = trim(pq($property)->find($props_name["path"])->attr($props_name["attr"]));
                }
            }
               
            if (empty($name)) continue 1;
            
            if (empty($arr_val["path"]) && empty($arr_val["attr"]))
            {
                $value = trim(pq($property)->text());
            }
            elseif(empty($arr_val["path"]) && !empty($arr_val["attr"]))
            {
                $value = trim(pq($property)->attr($arr_val["attr"]));
            }
            else
            {
                if(empty($arr_val["attr"]))
                {
                    $value = strip_tags(trim(pq($property)->find($arr_val["path"])->html()));
                }
                elseif(!empty($arr_val["attr"]))
                {
                    $value = trim(pq($property)->find($arr_val["path"])->attr($arr_val["attr"]));
                }
            }
            
            $isset_props = $this->issetPropsForName($name);
            if (!$isset_props)
            {
                $error = $this->addAutoProps($name);
                if ($error !== false)
                {
                    $db_props = CIBlockProperty::GetByID($error, $this->iblock_id, false);
                    $code_props = $db_props->GetNext();
                    if(!isset($this->arProperties[$code_props["CODE"]]) || empty($this->arProperties[$code_props["CODE"]]))
                    {
                        $this->arProperties[$code_props["CODE"]] = $code_props;
                    }
                    if (!isset($this->arPropertiesParseAuto[$code_props["CODE"]]) || empty($this->arPropertiesParseAuto[$code_props["CODE"]]))
                    {
                        $this->arPropertiesParseAuto[$code_props["CODE"]] = $value;
                    }
                }
            }
            if($isset_props)
            {
                foreach($isset_props as $code => $props)
                {
                    if(!isset($this->arProperties[$code]) || empty($this->arProperties[$code]))
                    {
                        $this->arProperties[$code] = $props;
                    }
                    if (!isset($this->arPropertiesParseAuto[$code]) || empty($this->arPropertiesParseAuto[$code]))
                    {
                        $this->arPropertiesParseAuto[$code] = $value;
                    }
                }
            }
           
        }
        
    }
    
    protected function parseCatalogAutoPropsAdd()
    {
        $arProperties = $this->arPropertiesParseAuto;
        if(!$arProperties) return false;
        if($this->settings["catalog"]["catalog_delete_selector_find_props_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_find_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }
        foreach($arProperties as $code => $value)
        {
            $arProp = $this->arProperties[$code];
            if(($arProp["PROPERTY_TYPE"] == "S") || ($arProp["PROPERTY_TYPE"] == "L") || ($arProp["PROPERTY_TYPE"] == "N")) 
            {   
                $text = $value;
                if($arProp["USER_TYPE"]!="HTML")
                    $text = strip_tags($value);
                $text = str_replace($deleteSymb, "", $text);
                $this->parseCatalogPropAuto($code, $text);
            }
        }
    }
    
    public function parseCatalogPropAuto($code, $val)
    {
        if(empty($code)) return false;
        $val = html_entity_decode($val);
        $arProp = $this->arProperties[$code];
        //$default = $this->settings["catalog"]["default_prop"][$code];
        
        if($arProp["PROPERTY_TYPE"]!="N" && isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"])
            $val = $this->locText($val, $arProp["USER_TYPE"]=="HTML"?"html":"plain");
        
        if($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }elseif($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsDirectory($arProp, $code, $val);;
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsDirectory($arProp, $code, $val);;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y")
        {
            $val = $this->actionFieldProps($code, $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y")
        {
            $val = $this->actionFieldProps($code, $val);
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;
        }
        elseif($arProp["PROPERTY_TYPE"]=="N")
        {
            $val =  str_replace(",", ".", $val);
            $val = preg_replace("/\.{1}$/", "", $val);
            $val = preg_replace('/[^0-9.]/', "", $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;    

        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsL($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsL($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]!="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsE($arProp, $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]=="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsE($arProp, $code, $val);
        }
    }
    
    protected function addAutoProps($setting) //add auto props
    {
        if (empty($setting)) return false;
        $CODE = strtoupper(CUtil::translit($setting, "ru", array(
                        "max_len" => 100,
                        "change_case" => 'S', // 'L' - toLower, 'U' - toUpper, false - do not change
                        "replace_space" => '_',
                        "replace_other" => '_',
                        "delete_repeat_replace" => true,
          )));
        $arFields = Array(
          "NAME" => $setting,
          "ACTIVE" => "Y",
          "SORT" => "100",
          "CODE" => $CODE,
          "PROPERTY_TYPE" => $this->settings["catalog"]["type_auto_props"],
          "IBLOCK_ID" => $this->iblock_id
          );
          $ibp = new CIBlockProperty;
          $PropID = $ibp->Add($arFields);
          if ($PropID) return $PropID;
          else 
          {
              $this->errors[] = "[".$setting."]".$ibp->LAST_ERROR;
              return false;
          }
    }
    
    protected function issetPropsForName($name) //search props for name
    {
        if (empty($name)) return true;
        $property = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "?PROPERTY_TYPE" => "S || N || L", "NAME" => $name));
        $prors = array();
        while($prop = $property->Fetch())
        {
             $prors[$prop["CODE"]] = $prop;
        }
        if($property)
        {
            return $prors;
        }
        if(!$property) return false;
    }
  
    protected function parseCatalogIdElement($el)
    {   
        $id_element = $this->settings["catalog"]["id_selector"];
        
        $ar = $this->GetArraySrcAttr($id_element);
        $selector = $ar["path"];
        $attr = $ar["attr"];
        if (empty($id_element)) return false;
        if ($selector == "")
        {
            $p = trim(pq($el)->attr($attr));
        }
        else{
            if(!empty($attr)) 
            {
                $p = trim(pq($el)->find($selector)->attr($attr)); 
            }
            elseif(empty($attr))
            {
                $p = strip_tags((pq($el)->find($selector)->html())); 
            }
        }
        if(!$p)
        { 
            $this->errors[] = GetMessage("parser_error_id_element_notfound");
            return false;
        }
        $this->arFields["LINK"] = $p;
        return true;
    }
    
    protected function parseCatalogParrentSection(&$el)
    {
        if (($this->settings["catalog"]["add_parser_section"] == "N") || empty($this->settings["catalog"]["id_section"])) return false;
        $ar = $this->GetArraySrcAttr($this->settings["catalog"]["id_section"]);
        $selector = $ar["path"];
        $attr = $ar["attr"];
        
        if($selector == ""){
            $parrent_id = trim(pq($el)->attr($attr));
        }
        else
        {
            if(empty($attr)) $parrent_id = trim(strip_tags(pq($el)->find($selector)->html()));
            elseif(!empty($attr)) $parrent_id = trim(pq($el)->find($selector)->attr());
        }
        /*$parrent_id = trim($this->settings["catalog"]["id_section"]);
        $parrent_id = trim(pq($el)->find($parrent_id)->text());*/
        if(empty($parrent_id)) return false;
        elseif (!empty($parrent_id)) $parrent_id = $this->issetSectionCatalog($parrent_id);
        if($parrent_id !== false)
        {
            $this->arFields["IBLOCK_SECTION_ID"] = $parrent_id;
        }
    }

    protected function parseCatalogSectionXml($pageHref)
    {   
        $this->html = phpQuery::newDocument($this->page);
        $this->base = $this->GetMetaBase($this->html);
        if ($this->settings["catalog"]["add_parser_section"] !== "Y") return false;
        if (empty($this->settings['catalog']['selector_category']))
        {   
            $this->errors[] = GetMessage("parser_no_selector_category");
            return false;
        }
        $arr = $this->GetArrSectionXml();
        if ($arr !== false)
        {
            $new_section_arr = $this->GetTreeArrSectionXml($arr);
        }
        if(is_array($new_section_arr))
        {
            if($this->settings["catalog"]["field_id_category"] == "EXT_FIELD")
            {
                $this->AddExtFieldSection();
            }
            $this->addAllSectionXml($new_section_arr);
        }
    }
    
    protected function GetArrSectionXml()
    {
        if(empty($this->settings['catalog']['selector_category'])) return false;
        
        $arr_section = $this->html->find($this->settings['catalog']['selector_category']);
        $arr = array();
        $arr_id = $this->GetArraySrcAttr($this->settings['catalog']["attr_id_category"]);
        $arr_name = $this->GetArraySrcAttr($this->settings['catalog']["attr_category"]);
        $arr_parent = $this->GetArraySrcAttr($this->settings['catalog']["attr_id_parrent_category"]);
        
        
        foreach ($arr_section as $el_section)
        {
            if ($arr_id['path'] == "")
            {
                $section_id = trim(pq($el_section)->attr($arr_id['attr']));
            } 
            else{
                if(!empty($arr_id['attr'])) $section_id = trim(pq($el_section)->find($arr_id['path'])->attr($arr_id['attr']));
                elseif(empty($arr_id['attr']))
                {
                    $section_id = trim(pq($el_section)->find($arr_id['path'])->html());
                    $section_id = trim(strip_tags($section_id));
                }
            }  
            if (empty($section_id))
            {
                continue 1; 
            }
            if ($arr_parent["path"] == "") 
            {
                $parentId = trim(pq($el_section)->attr($arr_parent["attr"]));
            }
            else{
                if (!empty($arr_parent["attr"])) $parentId = trim(pq($el_section)->find($arr_parent["path"])->attr($arr_parent["attr"]));
                elseif(empty($arr_parent["attr"])) {
                    $parentId = trim(pq($el_section)->find($arr_parent["path"])->html());
                    $parentId = trim(strip_tags($parentId));
                }
                 
            }
            if (!isset($parentId) || empty($parentId)) $parentId = 0;
            
            if(empty($this->settings['catalog']["attr_category"]))
            {
                $arr[$section_id]['text'] = strip_tags(trim(pq($el_section)->html()));
            }
            elseif(!empty($this->settings['catalog']["attr_category"]))
            {
                if (!empty($arr_name['attr'])) 
                {
                    $arr[$section_id]['text'] = trim(pq($el_section)->find($arr_name["path"])->attr($arr_name["attr"]));
                }
                elseif(empty($arr_name['attr']))
                {
                    $arr[$section_id]['text'] = strip_tags(trim(pq($el_section)->find($arr_name["path"])->html()));
                }
            }
            $arr[$section_id]['parentId'] = $parentId;
        }
        
        ksort($arr);
        return $arr;
    }
    
    protected function GetTreeArrSectionXml($arr)
    {
        if (!is_array($arr)) return false;
        
        $new_section_arr = array();
        foreach ($arr as $key => $value) 
        {
            if (!isset($new_section_arr[$value['parentId']]) || empty($new_section_arr[$value['parentId']]))
                $new_section_arr[$value['parentId']]['text'] = $arr[$value['parentId']]['text']; 
        }
        
        foreach ($arr as $k => $v)
        {
            $new_section_arr[$v['parentId']][$k]['text'] = $v['text'];
        }
        ksort($new_section_arr);
        return $new_section_arr;
    }
    
    protected function addAllSectionXml($arr)
    {                    
        if (empty($arr)) return false;
        foreach ($arr as $id => $val)
        {
            $section_title =  $arr[$id]['text'];
            if (empty($section_title) && ($id != 0))
            {
                continue;
            } 
            elseif ($id == 0) $parrent_section = $this->section_id;
            elseif ($id != 0) $parrent_section = $this->issetSectionCatalog($id); 
            
            if (($this->issetSectionCatalog($id) === false) && ($id != 0))
            {
                $this->addSectionXlm(array("id_section" => $id, "text_section" => $section_title, "id_parrent" => $parrent_section));
            }
            foreach ($val as $key => $text)
            {  
                if($key !== "text")
                {
                   if (($this->issetSectionCatalog($key) === false) && $parrent_section !== false)
                   {
                       $this->addSectionXlm(array("id_section" => $key, "text_section" => $text["text"], "id_parrent" => $parrent_section));
                   } 
                }
            }           
        }
    }
    
    protected function addSectionXlm($settings)
    {
        if (empty($settings) || !is_array($settings)) return false;
        $new_section = new CIBlockSection;
        $arFields = $this->GetArrFieldsSection($settings);
        $ID = $new_section->Add($arFields);
        if ($ID !== false)
        {   
            $this->countSection ++; 
        } 
        elseif ($ID === false)
        {
            $this->errors[] = $new_section->LAST_ERROR;
        } 
    }
    
    protected function GetArrFieldsSection($settings)
    {
         $arFields = Array(
              "ACTIVE" => "Y",
              "CODE" => CUtil::translit($settings["text_section"], "ru", array(
                        "max_len" => 100,
                        "change_case" => 'L', 
                        "replace_space" => '_',
                        "replace_other" => '_',
                        "delete_repeat_replace" => true,
              )),
              "IBLOCK_SECTION_ID" => $settings["id_parrent"],
              "IBLOCK_ID" => $this->iblock_id,
              "NAME" => $settings["text_section"],
              "DESCRIPTION" => GetMessage("parser_add_category_description"),
              "DESCRIPTION_TYPE" => "text"
        );
        if ($this->settings["catalog"]["field_id_category"] == "XML_ID")
        {
            $arFields["XML_ID"] = "shs_".md5($this->rss)."_".$settings["id_section"];
        }
        elseif ($this->settings["catalog"]["field_id_category"] == "EXT_FIELD")
        {
            $arFields["UF_SHS_PARSER"] = "shs_".md5($this->rss)."_".$settings["id_section"];
        }
        return $arFields;
    }
    
    protected function AddExtFieldSection()
    {
        $arFields = Array(
            "ENTITY_ID" => "IBLOCK_".$this->iblock_id."_SECTION",
            "FIELD_NAME" => "UF_SHS_PARSER",
            "USER_TYPE_ID" => "string",
            "EDIT_FORM_LABEL" => Array("ru"=>GetMessage("EDIT_FORM_LABEL_RU"), "en"=>GetMessage("EDIT_FORM_LABEL_EN"))
            );
        $obUserField  = new CUserTypeEntity;
        $obUserField->Add($arFields);
    }
    
    protected function issetSectionCatalog($settings)
    {                       
        if (empty($settings)) return false;
        $arFilter = $this->GetArrFilterSection($settings);
        if (!is_array($arFilter)) return false;
        $db_section = CIBlockSection::GetList(Array("SORT"=>"ASC"), $arFilter, false, Array("ID", "XML_ID", "UF_SHS_PARSER"), false);
        $id_section = $db_section->Fetch();
        if ($id_section) return $id_section["ID"];
        else return false;
    }
    
    protected function GetArrFilterSection($settings)
    {
        if ($this->settings["catalog"]["field_id_category"] == "XML_ID")
        {
            $arFilter = Array('IBLOCK_ID'=>$this->iblock_id, '=XML_ID'=>"shs_".md5($this->rss)."_".$settings);  
        }
        elseif ($this->settings["catalog"]["field_id_category"] == "EXT_FIELD") 
        {
            $arFilter = Array('IBLOCK_ID'=>$this->iblock_id, '=UF_SHS_PARSER'=>"shs_".md5($this->rss)."_".$settings);  
        }
        return $arFilter;
    }
    
    protected function parseCatalogDescriptionXml(&$el)
    {
        if($this->checkUniq() && (!$this->isUpdate || (!$this->isUpdate["detail_descr"] && (!$this->isUpdate["preview_descr"] && !$this->settings["catalog"]["text_preview_from_detail"]!="Y")))) return false;
        if($this->settings["catalog"]["detail_text_selector"])
        {
            $detail = $this->settings["catalog"]["detail_text_selector"];
            
            $arDetail = explode(",", $detail);
            $detail_text = "";
            if($arDetail && !empty($arDetail))
            {
                foreach($arDetail as $detail)
                {
                    $detail = trim($detail);
                    if(!$detail) continue 1;

                    foreach(pq($el)->find($detail." img") as $img)
                    {
                        $src = pq($img)->attr("src");
                        $src = $this->parseCaralogFilterSrc($src);
                        $src = $this->getCatalogLink($src);
                        $this->parseCatalogSaveImgServer($img, $src);
                    }
                    
                    $arr = $this->GetArraySrcAttr($detail);
                    $path = $arr["path"];
                    $attr = $arr["attr"];
                    if(empty($attr))
                        $detail_text .= pq($el)->find($path)->html();
                    elseif(!empty($attr))
                        $detail_text .= pq($el)->find($path)->attr($attr);

                }
            }

            $detail_text = trim($detail_text);
            if(isset($this->settings["loc"]["f_detail_text"]) && $this->settings["loc"]["f_detail_text"]=="Y")
            {
                $detail_text = $this->locText($detail_text, $this->detail_text_type=="html"?"html":"plain");    
            }
            $this->arFields["DETAIL_TEXT"] = $detail_text;
            $this->arFields["DETAIL_TEXT_TYPE"] = $this->detail_text_type;
            if($this->settings["catalog"]["text_preview_from_detail"]=="Y")
            {
                $this->arFields["PREVIEW_TEXT"] = $this->arFields["DETAIL_TEXT"];
                $this->arFields["PREVIEW_TEXT_TYPE"] = $this->arFields["DETAIL_TEXT_TYPE"];
            }
        }
    }
    
    protected function ValidateUrl($url)
    {
        if (preg_match("/^(http|https)?(:\/\/)?([A-Z0-9][A-Z0-9_-]*(?:.[A-Z0-9][A-Z0-9_-]*)+):?(d+)?\/?/Diu", $url))
        {
           return true; 
        }
        else 
        {
            return false;
        }
    }

}
?>43   98|/shs.parser/install/version.php|64cd8dc3<?
$arModuleVersion = array(
	"VERSION" => "5.4.2",
	"VERSION_DATE" => "2016-02-03 17:52:36"
);
?>RTIBE