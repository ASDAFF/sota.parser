BITRIX37   7834|/shs.parser/include.php|e55f4e7b<?
use Bitrix\Seo\Engine;
use Bitrix\Main\Text\Converter;
use Bitrix\Main\Localization\Loc;
use Bitrix\Main\IO\Path;

\Bitrix\Main\Loader::includeModule('seo');
\Bitrix\Main\Loader::includeModule('socialservices');

IncludeModuleLangFile(__FILE__);
global $DB, $shs_DEMO;
$db_type = strtolower($DB->type);

$module_id = 'shs.parser';
$module_status = CModule::IncludeModuleEx($module_id);
//$module_status = 3;
if($module_status == '1') {
    $include_class = true;
    $shs_DEMO = 1;
}
elseif($module_status == '2') {
    $include_class = true;
    $shs_DEMO = 2;
    //echo GetMessage("DEMO");

}
elseif($module_status == '3'){
    $include_class = false;
    $shs_DEMO = 3;
}

CModule::AddAutoloadClasses(
    "shs.parser",
    array(
        "ShsParserContentGeneral" => "classes/general/list_parser.php",
        "SotbitContentParser" => "classes/general/main_classes.php",
        "ShsParserContent" => "classes/".$db_type."/list_parser.php",
        "ShsParserTmpTable" => "classes/".$db_type."/parser_tmp.php",
        "ShsParserTmpOldTable" => "classes/".$db_type."/parser_tmp_old.php",
        "ShsParserSectionTable" => "classes/".$db_type."/parser_section.php",
    )
);

include($_SERVER["DOCUMENT_ROOT"].'/bitrix/modules/shs.parser/classes/phpQuery/phpQuery.php');
include($_SERVER["DOCUMENT_ROOT"].'/bitrix/modules/shs.parser/classes/general/sotbit_idna_convert.class.php');
include($_SERVER["DOCUMENT_ROOT"].'/bitrix/modules/shs.parser/classes/general/file_get_html.php');
Class RssContentParser extends SotbitContentParser {
    /*protected $id = false;
    protected $rss;
    protected $type;
    protected $active;
    protected $iblock_id;
    protected $section_id;
    protected $detail_dom;
    protected $encoding;
    protected $preview_delete_tag="";
    protected $bool_preview_delete_tag="";
    protected $detail_delete_tag="";
    protected $bool_detail_delete_tag="";
    protected $preview_first_img="";
    protected $detail_first_img="";
    protected $preview_save_img="";
    protected $detail_save_img="";
    protected $text = "";
    protected $site = "";
    protected $link = "";
    protected $preview_delete_element="";
    protected $detail_delete_element="";
    protected $preview_delete_attribute="";
    protected $detail_delete_attribute="";
    protected $index_element="";
    protected $resize_image="";
    protected $meta_description="";
    protected $meta_keywords="";
    protected $meta_description_text="";
    protected $meta_keywords_text="";
    protected $agent = false;
    protected $active_element = "Y";
    protected $header_url;
    protected $settings;
    protected $countPage = 0;
    protected $countItem = 0;
    protected $stepStart = false;

    protected $page;
    const TEST = 0;
    const DEFAULT_DEBUG_LIST = 3;
    const DEFAULT_DEBUG_ITEM = 3;*/

    public function __construct(){
        /*global $zis, $shs_ID, $shs_TYPE, $shs_ACTIVE, $shs_IBLOCK_ID, $shs_RSS, $shs_SECTION_ID, $shs_SELECTOR, $shs_ENCODING, $shs_PREVIEW_DELETE_TAG, $shs_PREVIEW_TEXT_TYPE, $shs_DETAIL_TEXT_TYPE, $shs_BOOL_PREVIEW_DELETE_TAG,$shs_PREVIEW_FIRST_IMG, $shs_PREVIEW_SAVE_IMG, $shs_DETAIL_DELETE_TAG, $shs_BOOL_DETAIL_DELETE_TAG,$shs_DETAIL_FIRST_IMG, $shs_DETAIL_SAVE_IMG, $shs_PREVIEW_DELETE_ELEMENT, $shs_DETAIL_DELETE_ELEMENT, $shs_PREVIEW_DELETE_ATTRIBUTE, $shs_DETAIL_DELETE_ATTRIBUTE, $shs_INDEX_ELEMENT, $shs_CODE_ELEMENT, $shs_RESIZE_IMAGE, $shs_META_DESCRIPTION, $shs_META_KEYWORDS, $shs_ACTIVE_ELEMENT, $shs_FIRST_TITLE, $shs_DATE_PUBLIC, $shs_FIRST_URL, $shs_DATE_ACTIVE, $shs_META_TITLE, $shs_SETTINGS;
        $this->id = $shs_ID;
        $this->type = $shs_TYPE;
        $this->rss = $shs_RSS;
        $this->active = $shs_ACTIVE;
        $this->iblock_id = $shs_IBLOCK_ID;
        $this->section_id = $shs_SECTION_ID;
        $this->detail_dom = $shs_SELECTOR;
        $this->first_url = trim($shs_FIRST_URL);
        $this->encoding = $shs_ENCODING;
        $this->preview_text_type = $shs_PREVIEW_TEXT_TYPE;
        $this->detail_text_type = $shs_DETAIL_TEXT_TYPE;
        $this->preview_delete_tag = $shs_PREVIEW_DELETE_TAG;
        $this->detail_delete_tag = $shs_DETAIL_DELETE_TAG;
        $this->bool_preview_delete_tag = $shs_BOOL_PREVIEW_DELETE_TAG;
        $this->bool_detail_delete_tag = $shs_BOOL_DETAIL_DELETE_TAG;
        $this->preview_first_img = $shs_PREVIEW_FIRST_IMG;
        $this->detail_first_img = $shs_DETAIL_FIRST_IMG;
        $this->preview_save_img = $shs_PREVIEW_SAVE_IMG;
        $this->detail_save_img = $shs_DETAIL_SAVE_IMG;
        $this->preview_delete_element = $shs_PREVIEW_DELETE_ELEMENT;
        $this->detail_delete_element = $shs_DETAIL_DELETE_ELEMENT;
        $this->preview_delete_attribute = $shs_PREVIEW_DELETE_ATTRIBUTE;
        $this->detail_delete_attribute = $shs_DETAIL_DELETE_ATTRIBUTE;
        $this->index_element = $shs_INDEX_ELEMENT;
        $this->code_element = $shs_CODE_ELEMENT;
        $this->resize_image = $shs_RESIZE_IMAGE;
        $this->meta_title = $shs_META_TITLE;
        $this->meta_description = $shs_META_DESCRIPTION;
        $this->meta_keywords = $shs_META_KEYWORDS;
        $this->active_element = $shs_ACTIVE_ELEMENT;
        $this->first_title = $shs_FIRST_TITLE;
        $this->date_public = $shs_DATE_PUBLIC;
        $this->date_active = $shs_DATE_ACTIVE;
        $this->settings = unserialize(base64_decode($shs_SETTINGS));
        $this->header_url = "";
        $this->sleep = (int)$this->settings[$this->type]["sleep"];
        $this->proxy = (int)$this->settings[$this->type]["proxy"];
        $this->errors = array();
        $this->mode = $this->settings["catalog"]["mode"];
        $this->currentPage = 0;
        $this->activeCurrentPage = 0;
        $this->debugErrors = array();
        $this->stepStart = false;
        $this->pagePrevElement = array();
        $this->pagenavigationPrev = array();
        $this->pagenavigation = array();*/
        $this->setDemo();
        CModule::IncludeModule("highloadblock");
        parent::__construct();

    } 
    
    protected function setDemo()
    {
        global $shs_DEMO;
        $module_id = "shs.parser";
        $shs_DEMO = CModule::IncludeModuleEx($module_id);
        if($shs_DEMO==3) die("DEMO END");
        //elseif($shs_DEMO==2)$this->settings["catalog"]["mode"] = "debug";   
    }

    public function sotbitParserSetSettings(&$SETTINGS)
    {
        foreach($SETTINGS as &$v)
        {
            if(is_array($v)) self::sotbitParserSetSettings($v);
            else $v = htmlspecialcharsBack($v);
        }
    }

    public function createFolder()
    {
        global $shs_DEMO;
        $this->setDemo();
        $dir = $_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include";
        if(!file_exists($dir) && $shs_DEMO!=3)
            mkdir($dir, BX_DIR_PERMISSIONS);
        elseif($shs_DEMO==3) unlink($dir);
    }
    
    
    
    public function auth($check=false)
    {
        global $shs_DEMO;
        $this->setDemo();
        if($shs_DEMO==3) die("DEMO END");
        $this->check = $check;
        $this->GetAuthForm($check);
        
        
        
    }
    
    
    
    
}


Class CShsParser
{
    static function startAgent($ID){
        ignore_user_abort(true);
        if(CModule::IncludeModule('iblock') && CModule::IncludeModule('main')):
        CModule::IncludeModule("highloadblock");
        $parser = ShsParserContent::GetByID($ID);
        if(!$parser->ExtractFields("shs_"))
        $ID=0;
        $rssParser = new RssContentParser();
        $rssParser->startParser(1);
        return "CShsParser::startAgent(".$ID.");";
        endif;
    }
}
?> 37   2738|/shs.parser/options.php|581b49ce<?
$module_id = "shs.parser";
$POST_RIGHT = $APPLICATION->GetGroupRight($module_id);
if($POST_RIGHT>="R") :

IncludeModuleLangFile($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/main/options.php");

IncludeModuleLangFile(__FILE__);

$aTabs = array(
	array("DIV" => "edit1", "TAB" => GetMessage("MAIN_TAB_RIGHTS"), "ICON" => "", "TITLE" => GetMessage("MAIN_TAB_TITLE_RIGHTS")),
);
$tabControl = new CAdminTabControl("tabControl", $aTabs);

if($REQUEST_METHOD=="POST" && strlen($Update.$Apply.$RestoreDefaults)>0 && $POST_RIGHT=="W" && check_bitrix_sessid())
{
	$Update = $Update.$Apply;
	ob_start();
	require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/admin/group_rights.php");
	ob_end_clean();

	if(strlen($_REQUEST["back_url_settings"]) > 0)
	{
		if((strlen($Apply) > 0) || (strlen($RestoreDefaults) > 0))
			LocalRedirect($APPLICATION->GetCurPage()."?mid=".urlencode($module_id)."&lang=".urlencode(LANGUAGE_ID)."&back_url_settings=".urlencode($_REQUEST["back_url_settings"])."&".$tabControl->ActiveTabParam());
		else
			LocalRedirect($_REQUEST["back_url_settings"]);
	}
	else
	{
		LocalRedirect($APPLICATION->GetCurPage()."?mid=".urlencode($module_id)."&lang=".urlencode(LANGUAGE_ID)."&".$tabControl->ActiveTabParam());
	}
}



?>
<form method="post" action="<?echo $APPLICATION->GetCurPage()?>?mid=<?=urlencode($module_id)?>&amp;lang=<?=LANGUAGE_ID?>">
<?
$tabControl->Begin();
$tabControl->BeginNextTab();
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/admin/group_rights.php");?>
<?$tabControl->Buttons();?>
	<input <?if ($POST_RIGHT<"W") echo "disabled" ?> type="submit" name="Update" value="<?=GetMessage("MAIN_SAVE")?>" title="<?=GetMessage("MAIN_OPT_SAVE_TITLE")?>">
	<input <?if ($POST_RIGHT<"W") echo "disabled" ?> type="submit" name="Apply" value="<?=GetMessage("MAIN_OPT_APPLY")?>" title="<?=GetMessage("MAIN_OPT_APPLY_TITLE")?>">
	<?if(strlen($_REQUEST["back_url_settings"])>0):?>
		<input <?if ($POST_RIGHT<"W") echo "disabled" ?> type="button" name="Cancel" value="<?=GetMessage("MAIN_OPT_CANCEL")?>" title="<?=GetMessage("MAIN_OPT_CANCEL_TITLE")?>" onclick="window.location='<?echo htmlspecialchars(CUtil::addslashes($_REQUEST["back_url_settings"]))?>'">
		<input type="hidden" name="back_url_settings" value="<?=htmlspecialchars($_REQUEST["back_url_settings"])?>">
	<?endif?>
	<input <?if ($POST_RIGHT<"W") echo "disabled" ?> type="submit" name="RestoreDefaults" title="<?echo GetMessage("MAIN_HINT_RESTORE_DEFAULTS")?>" OnClick="return confirm('<?echo AddSlashes(GetMessage("MAIN_HINT_RESTORE_DEFAULTS_WARNING"))?>')" value="<?echo GetMessage("MAIN_RESTORE_DEFAULTS")?>">
	<?=bitrix_sessid_post();?>
<?$tabControl->End();?>
</form>
<?endif;?>
35   372|/shs.parser/prolog.php|825ea976<?
IncludeModuleLangFile(__FILE__);
define("ADMIN_MODULE_NAME", "shs.parser");
define("ADMIN_MODULE_ICON", "<a href=\"/bitrix/admin/list_parser_admin.php?lang=".LANG."\"><img src=\"/bitrix/images/shs.parser/shs_parser.gif\" width=\"48\" height=\"48\" border=\"0\" alt=\"".GetMessage("parser_prolog_title")."\" title=\"".GetMessage("parser_prolog_title")."\"></a>");
?>45   5625|/shs.parser/lang/ru/include.php|d4500b8c<?
$MESS["parser_active_no"] = "Парсер не активен.";
$MESS["parser_pars_el_ok"] = "Парсинг успешно завершен. Элементы";
$MESS["parser_pars_create_ok"] = "успешно созданы.";
$MESS["parser_no"] = "Элементы в данном разделе уже существуют.";
$MESS["parser_error"] = "Ошибка. Повторите попытку позже.";
$MESS["parser_meta_description"] = "Описание";
$MESS["parser_meta_keywords"] = "Ключевые слова";
$MESS["parser_error_title"] = "Свойство для заголовка не найдено";
$MESS["parser_error_description"] = "Свойство для мета-описания не найдено";
$MESS["parser_error_keywords"] = "Свойство для ключевых слов не найдено";
$MESS["parser_error_first"] = "Свойство для первоисточника не найдено";
$MESS["parser_error_date"] = "Свойство для даты публикации не найдено";
$MESS["parser_demo_end"] = "Срок демо-версии модуля \"Парсер контента\" истек.";
$MESS["parser_error_noname"] = "Название статьи не определено. Селектор ссылки задан неверно.";
$MESS["parser_error_nohref"] = "Ссылка на статью не определена. Селектор наименования новости зада неверно.";
$MESS["parser_error_connect"] = "Ошибка соединения. Некорректный URL или ошибка на стороне стороннего сайта.";
$MESS["parser_error_pagenavigation_begin"] = "Поле 'Начинать со страницы' должно быть числом.";
$MESS["parser_error_pagenavigation_end"] = "Поле 'по страницу' должно быть числом.";
$MESS["parser_error_ratio"] = "Ошибка добавления коэффициента ед. измерения";
$MESS["parser_error_add_product"] = "Ошибка добавления товара";
$MESS["parser_error_add_product_offer"] = "Ошибка добавления продукта торгового предложения";
$MESS["parser_error_add_price"] = "Ошибка добавления цены";
$MESS["parser_error_add_price_offer"] = "Ошибка добавления цены торгового предложения";
$MESS["parser_error_update_price"] = "Ошибка обновления цены. Не указан ID товара.";
$MESS["parser_error_update_product"] = "Ошибка обновления товара. Не указан ID товара.";
$MESS["parser_error_update_product_offer"] = "Ошибка обновления торгового предложения. Не указан ID оффера.";
$MESS["parser_error_price_notfound"] = "Цена не обнаружена. Селектор цены указан неверно.";
$MESS["parser_error_href_notfound"] = "Селектор названия товара указан неверно.";
$MESS["parser_error_selector_notfound"] = "Селектор товара на странице каталога указан неверно.";
$MESS["parser_error_selector_detail_notfound"] = "Селектор детальной страницы товара указан неверно.";
$MESS["parser_error_price_terms_value"] = "Условие изменения цены должно быть числом.";
$MESS["parser_error_price_value"] = "Величина изменения цены должна быть числом.";
$MESS["parser_error_step"] = "Шаг парсера должен быть числом.";
$MESS["parser_offer_name"] = "Торговое предложение товара: ";
$MESS["error_add_prop_e"] = "Ошибка добавления свойства типа привязка к элементу";
$MESS["parser_error_name_notfound_offer"] = "Селектор наименования торгового предложения неопределен или пуст.";
$MESS["parser_error_offer_price"] = "Цена торгового предложения неопределена";
$MESS["shs_parser_section_name_title"] = "Название";
$MESS["shs_parser_section_date_title"] = "Дата создания";
$MESS["shs_parser_section_active_title"] = "Активность";
$MESS["shs_parser_section_sort_title"] = "Сортировка";
$MESS["shs_parser_section_description_title"] = "Описание";
$MESS["shs_parser_section_parent_title"] = "Родительская категория";
$MESS["shs_parser_loc_401"] = "Неправильный ключ API";
$MESS["shs_parser_loc_402"] = "Ключ API заблокирован";
$MESS["shs_parser_loc_403"] = "Превышено суточное ограничение на количество запросов";
$MESS["shs_parser_loc_404"] = "Превышено суточное ограничение на объем переведенного текста";
$MESS["shs_parser_loc_413"] = "Превышен максимально допустимый размер текста";
$MESS["shs_parser_loc_422"] = "Текст не может быть переведен";
$MESS["shs_parser_loc_501"] = "Заданное направление перевода не поддерживается";
$MESS["SHS_PARSER_SEO_YANDEX_ERROR"] = 'Не настроена привязка к сайтам. <a target="_blank" href="/bitrix/admin/seo_search_yandex.php?lang=ru">Настроить</a>';
?>41   76|/shs.parser/lang/ru/prolog.php|57f889d<?
$MESS ['shs_parser_prolog_title'] = "Парсер контента";
?>61   3392|/shs.parser/lang/ru/admin/list_parser_admin.php|eb558802<?
$MESS ['parser_save_err'] = "Ошибка при сохранении парсера";
$MESS ['parser_del_err'] = "Невозможно удалить парсер.";
$MESS ['parser_updated'] = "Изменен";
$MESS ['parser_rss'] = "RSS канал/URL страницы";
$MESS ['parser_sort'] = "Сортировка";
$MESS ['parser_name'] = "Название";
$MESS ['parser_type'] = "Тип";
$MESS ['parser_active'] = "Активность";
$MESS ['parser_iblock_id'] = "ID инфоблока";
$MESS ['parser_section_id'] = "ID раздела";
$MESS ['parser_selector'] = "Селектор контента";
$MESS ['parser_encoding'] = "Кодировка сайта";
$MESS ['parser_start_agent'] = "Запуск по агенту";
$MESS ['parser_time_agent'] = "Периодичность запуска";
$MESS ['parser_start_last_time'] = "Время последнего запуска";
$MESS ['parser_nav'] = "Парсеры";
$MESS ['parser_act_edit'] = "Изменить";
$MESS ['PARSER_U_YES'] = "Да";
$MESS ['PARSER_U_NO'] = "Нет";
$MESS ['parser_act_copy'] = "Копировать";
$MESS ['parser_act_edit'] = "Изменить";
$MESS ['parser_act_del'] = "Удалить";
$MESS ['parser_act_del_conf'] = "Действие необратимо. Удалить парсер?";
$MESS ['parser_conf'] = "Запустить парсер?";
$MESS ['parser_act_start'] = "Запустить парсер";
$MESS ['post_title'] = "Список парсеров контента";
$MESS ['PARSER_F_ID'] = "ID";
$MESS ['PARSER_F_TIMESTAMP'] = "Дата изменения";
$MESS ['PARSER_F_NAME'] = "Название";
$MESS ['PARSER_F_TYPE'] = "Тип";
$MESS ['PARSER_F_RSS'] = "RSS канал/URL страницы";
$MESS ['PARSER_F_ACTIVE'] = "Активность";
$MESS ['PARSER_F_IBLOCK_ID'] = "ID инфоблока";
$MESS ['PARSER_F_SECTION_ID'] = "ID раздела";
$MESS ['PARSER_F_ENCODING'] = "Кодировка";
$MESS ['PARSER_F_START_AGENT'] = "Запуск по агенту";
$MESS ['PARSER_F_TIME_AGENT'] = "Периодичность запуска";
$MESS ['PARSER_F_START_LAST_TIME'] = "Время последнего запуска";
$MESS ['PARSER_ADD_TITLE'] = "Нажмите для добавления нового парсера";
$MESS ['PARSER_SECTION_ADD_TITLE'] = "Нажмите для добавления новой категории";
$MESS["SHS_PARSER_MAIN_ADD"] = "Добавить парсер";
$MESS["SHS_PARSER_SECTION_MAIN_ADD"] = "Добавить категорию";
$MESS ['PARSER_FIND'] = "Найти";
$MESS ['PARSER_WRONG_TIMESTAMP_FROM'] = "Введите в фильтре правильную дату изменения \"c\"";
$MESS ['PARSER_WRONG_START_LAST_TIME_FROM'] = "Введите в фильтре правильную дату последнего запуска парсера \"c\"";
$MESS ['parser_demo'] = "Модуль \"Парсер контента\" работает в демо-режиме.";
$MESS["PARSER_SHOW_SECTION_PARSER"] = "Вид отображения списка";
$MESS["parser_show_sp_tree"] = "Иерархия";
$MESS["parser_show_sp_all"] = "Все категории и парсеры";
$MESS["parser_show_sp_section"] = "Все категории";
$MESS["parser_show_sp_parser"] = "Все парсеры";
?>63   1591|/shs.parser/lang/ru/admin/parser_section_edit.php|4dbf9c35<?
$MESS["shs_parser_section_title_edit"]  = "Редактирование категории парсера";
$MESS["shs_parser_section_title_add"]  = "Добавление категории парсера";
$MESS["shs_parser_category_name"] = "Категория";
$MESS["parser_section_act"] = "Активность";
$MESS["parser_section_sort"] = "Сортировка";
$MESS["parser_section_name"] = "Название";
$MESS["parser_category_title"] = "Родительская категория";
$MESS["parser_category_select"] = "Выберите категорию";
$MESS["parser_category_description"] = "Описание";
$MESS["parser_list"] = "Список";
$MESS["parser_list_title"] = "Список парсеров и категорий";
$MESS["parser_section_add"] = "Добавить";
$MESS["parser_section_add_title"] = "Добавить категорию";
$MESS["parser_section_copy"] = "Копировать";
$MESS["parser_section_copy_title"] = "Копировать категорию";
$MESS["parser_section_delete"] = "Удалить";
$MESS["parser_section_delete_title"] = "Удалить категорию";
$MESS["parser_section_descr"] = "Винимание! При удалении категории удаляется только сама категория. Парсеры и категории, привязанные к удаляемой категории, удаляться не будут. Вы можете просмотреть их в общем списке всех категорий и парсеров.";
?>56   45513|/shs.parser/lang/ru/admin/parser_edit.php|814d8947<?
$MESS ['parser_tab'] = "Парсер";
$MESS ['parser_settings_tab'] = "Дополнительные настройки";
$MESS ['parser_uniq_tab'] = "Обновление / Уникальность";
$MESS ['parser_save_error'] = "Ошибка сохранения парсера";
$MESS ['parser_title_add'] = "Добавление парсера";
$MESS ['parser_title_edit'] = "Редактирование парсера";
$MESS ['parser_list'] = "Список";
$MESS ['parser_list_title'] = "Список парсеров";
$MESS ['parser_add'] = "Добавить";
$MESS ['parser_copy'] = "Копировать";
$MESS ['parser_mnu_add'] = "Добавить новый парсер";
$MESS ['parser_mnu_copy'] = "Копировать парсер";
$MESS ['parser_delete'] = "Удалить";
$MESS ['parser_mnu_del_conf'] = "Удалить парсер?";
$MESS ['parser_mnu_del_conf'] = "Удалить парсер?";
$MESS ['parser_start'] = "Запустить";
$MESS ['parser_start_title'] = "Запустить парсер";
$MESS ['parser_stop'] = "Остановить";
$MESS ['parser_stop_title'] = "Остановить парсер";
$MESS ['parser_saved'] = "Парсер успешно сохранен.";
$MESS ['parser_act'] = "Активен:";
$MESS ['parser_name'] = "Название:";
$MESS ['parser_rss'] = "RSS канал:";
$MESS ['parser_rss_page'] = "URL страницы:";
$MESS ['parser_rss_catalog'] = "URL раздела каталога:";
$MESS ['parser_sort'] = "Сортировка:";
$MESS ['parser_iblock_id'] = "ID инфоблока:";
$MESS ['parser_iblock_id_catalog'] = "ID инфоблока-каталога:";
$MESS ['parser_section_id'] = "ID раздела:";
$MESS ['parser_selector'] = "Селектор контента:";
$MESS ['parser_selector_page'] = "Селектор новости на странице списка новостей:";
$MESS ['parser_selector_preview_catalog'] = "Селектор товара на странице каталога:";
$MESS ['parser_selector_detail_catalog'] = "Селектор товара на детальной странице:";
$MESS ['parser_first_url'] = "URL в rss ленте:";
$MESS ['parser_first_url_page'] = "URL на странице:";
$MESS ['parser_href_page'] = "Селектор ссылки:";
$MESS ['parser_href_descr_page'] = "Если ничего не задано, то переход по страницам будет осуществляться по первой найденной ссылке в селекторе списка новостей. Селектор указывается относительно селектора новости. <br/>Если селектор сам является ссылкой, то необходимо указать: a:parent";
$MESS ['parser_name_page'] = "Селектор наименования новости:";
$MESS ['parser_name_descr_page'] = "Если ничего не задано, то название новости будет браться, как текст селектора ссылки. Селектор указывается относительно селектора новости.";
$MESS ['parser_encoding'] = "Кодировка:";
$MESS ['parser_delete_tag'] = "Удалять все теги:";
$MESS ['parser_pagenavigation_tab'] = "Постраничная навигация";
$MESS ['parser_preview_tab'] = "Превью";
$MESS ['parser_detail_tab'] = "Детально";
$MESS ['parser_preview_delete_tag'] = "Удалять теги:";
$MESS ['parser_preview_delete_tag_descr'] = htmlspecialcharsEx('Пример: "<div>", "<p>", "<br>"');
$MESS ['parser_page_uniq'] = "Уникализация по:"; 
$MESS ['parser_page_uniq_url'] = "Урлу";
$MESS ['parser_page_uniq_name'] = "Названию";

$MESS ['parser_detail_delete_tag'] = "Удалять теги:";
$MESS ['parser_preview_text_type'] = "Тип поля:";
$MESS ['parser_detail_text_type'] = "Тип поля:";
$MESS ['parser_bool_preview_delete_tag'] = "Кроме следующих:";
$MESS ['parser_bool_detail_delete_tag'] = "Кроме следующих:";
$MESS ['parser_preview_delete_element'] = "Удалять элементы:";
$MESS ['parser_detail_delete_element'] = "Удалять элементы:";
$MESS ['parser_preview_delete_attribute'] = "Удалять атрибуты элементов:";
$MESS ['parser_detail_delete_attribute'] = "Удалять атрибуты элементов:";
$MESS ['parser_preview_first_img'] = "Первая картинка как превью:";
$MESS ['parser_detail_first_img'] = "Первая картинка как детальная:";
$MESS ['parser_preview_first_img_catalog'] = "Селектор-атрибут превью картинки:";
$MESS ['parser_detail_first_img_catalog'] = "Селектор-атрибут детальной картинки:";
$MESS ['parser_preview_save_img'] = "Заменять пути/сохранять картинки на сервер:";
$MESS ['parser_detail_save_img'] = "Заменять пути/сохранять картинки на сервер:";
$MESS ['parser_index_element'] = "Индексировать элементы в поиске:";
$MESS ['parser_code_element'] = "Создавать символьный код из названия:";
$MESS ['parser_resize_image'] = "Использовать настройки инфоблока для обработки изображений:";
$MESS ['parser_create_sitemap'] = "По окончании создавать карту сайта:";
$MESS ['parser_meta_description'] = "Парсить мета-описание страниц:";
$MESS ['parser_meta_keywords'] = "Парсить ключевые слова страниц:";
$MESS ['parser_meta_description_text'] = "Описание страницы:";
$MESS ['parser_meta_keywords_text'] = "Ключевые слова:";
$MESS ['parser_meta_title'] = "Парсить заголовок страниц:";
$MESS ['parser_first_title'] = "Записывать ссылку на первоисточник:";
$MESS ['parser_meta_description'] = "Парсить мета-описание страниц:";
$MESS ['parser_meta_keywords'] = "Парсить ключевые слова страниц:";
$MESS ['parser_start_agent'] = "Запускать по агенту:";
$MESS ['parser_time_agent'] = "Периодичность запуска(в секундах):";
$MESS ['parser_active_element'] = "Создавать активные элементы:";
$MESS ['parser_start_last_time'] = "Время последнего запуска:";
$MESS ['parser_sleep'] = "Время задержки(сек):";
$MESS ['parser_sleep_descr'] = "Некоторые сайты осуществляют контроль активности, то есть, если количество обращений к сайту за единицу времени будет более установленного значения, то пользователь будет блокирован. Для обхода данной защиты установите временные задержки между обращениями парсера к сайту.:";

$MESS ['parser_selector_descr'] = 'Полный путь к селектору контента обозначается аналогично JQuery. <br/>Примеры: div#simpleid div.content; div#simpleid div.content:eq(0); div#simpleid div.content[style="margin-top:30px"]:eq(1)';
$MESS ['parser_first_url_descr'] = 'Не обязательное поле. Применяется, если rss лента включает в себя информацию с различных источников. Это поле позволяет указать URL, по которому будет производиться парсинг. То есть парсинг будет осуществляться, если в rss ленте будут найдены совпадения по указанному урлу. Пример: 1с-bitrix.ru(без указания www и http)';
$MESS ['parser_first_url_descr_page'] = 'Не обязательное поле. Применяется, если страница включает в себя информацию с различных источников. Это поле позволяет указать URL, по которому будет производиться парсинг. То есть парсинг будет осуществляться, если на странице будут найдены совпадения по указанному урлу. Пример: 1с-bitrix.ru(без указания www и http)';


$MESS ['parser_encoding_descr'] = "Кодировка сайта, который собираемся парсить. Определяется автоматически. Если не определена, то будет учитываться именно установленное вами значение.";

$MESS ['parser_preview_first_img_descr'] = "Картинка для превью будет браться первой из описания. Если таковой нет, то будет произведен поиск по всем атрибутам rss элементов потока.";
$MESS ['parser_preview_save_img_descr'] = "Сохранять все картинки из описания на сервер и заменять их пути своими.";
$MESS ['parser_preview_delete_element_descr'] = 'Удаляет перечисленные элементы. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a, div.simpleclass:eq(5), div.simpleclass[align="left"]:eq(0)';
$MESS ['parser_preview_delete_attribute_descr'] = 'Удаляет перечисленные атрибуты элементов. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a[href]';

$MESS ['parser_detail_first_img_descr'] = "Картинка для превью будет браться первой из контента.";
$MESS ['parser_detail_save_img_descr'] = "Сохранять все картинки из описания на сервер и заменять их пути своими.";
$MESS ['parser_detail_delete_element_descr'] = 'Удаляет перечисленные элементы. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a, div.simpleclass:eq(5), div.simpleclass[align="left"]:eq(1)';
$MESS ['parser_detail_delete_attribute_descr'] = 'Удаляет перечисленные атрибуты элементов. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a[href]';
$MESS["parser_category_select"] = "Выберите категорию парсера";
$MESS["parser_category_title"] = "Категория:";
$MESS ['parser_prop_id'] = "Выбор свойства из списка";
$MESS ['parser_date_type'] = "Выбор типа даты";
$MESS ['parser_date_public'] = "Записывать дату публикации:";
$MESS ['parser_date_active'] = "Устанавливать дату начала активности:";
$MESS ['parser_date_active_now'] = "Текущая дата";
$MESS ['parser_date_active_now_time'] = "Текущая дата и время";
$MESS ['parser_date_active_public'] = "Дата публикации в источнике";
$MESS ['parser_demo'] = "Модуль \"Парсер контента\" работает в демо-режиме.";

$MESS ['parser_type'] = "Тип парсера:";
$MESS ['parser_catalog_message'] = "Функционал парсинга каталога будет реализован в новом 2104 году! Следите за новостями и подписывайтесь на обновления модуля. Компания «Сотбит» работает для Вас.";

$MESS ['parser_pagenavigation_selector'] = "Селектор навигации:";
$MESS ['parser_pagenavigation_begin'] = "Начинать со страницы:";
$MESS ['parser_pagenavigation_one'] = "Селектор-атрибут пункта навигации:";
$MESS ['parser_pagenavigation_selector_descr'] = "Пример: .pagenavigation";
$MESS ['parser_pagenavigation_one_descr'] = "Задается относительно предыдущего параметра. Например: a[href]. Если поле пустое или нет атрибута, то по умолчанию a[href]. Если ссылка отсутствует и постраничная навигация отрабатывается скриптами, то необходимо воспользоваться блоком Работа с постраничной навигацией, расположенным ниже.";
$MESS ['parser_pagenavigation_delete'] = "Удалять элементы навигации:";
$MESS ['parser_preview_text_selector'] = "Селектор превью описания:";
$MESS ['parser_detail_text_selector'] = "Селектор детального описания:";
$MESS ['parser_selector_catalog_descr'] = "Пример: .catalog-section. Далее все селектора в этой закладке идут относительно заданного параметра ";
$MESS ['parser_selector_detail_catalog_descr'] = "Пример: .catalog-detail. Далее все селектора в этой закладке идут относительно заданного параметра ";
$MESS ['parser_preview_text_type_catalog'] = "Тип превью описания:";
$MESS ['parser_preview_delete_tag_catalog'] = "Удалять теги из описания:";
$MESS ['parser_preview_first_img_descr_catalog'] = "По умолчанию img:eq(0)[src]. Если картинка находится в другом элементе или атрибуте, то записываем, например: a:eq(0)[href]";
$MESS ['parser_detail_first_img_descr_catalog'] = "По умолчанию img:eq(0)[src]. Если картинка находится в другом элементе или атрибуте, то записываем, например: a:eq(0)[href]. Также может возникнуть ситуация, когда селекторы детальной картинки могут отличаться в зависимости от ряда условия(одна картинка или их несколько). В этом случае перечисление селекторов идет через запятую.";
$MESS ['parser_detail_text_type_catalog'] = "Тип детального описания:";
$MESS ['parser_preview_price'] = "Селектор цены:";
$MESS ['parser_props_tab'] = "Свойства";
$MESS ['parser_preview_price_descr'] = "Если пустое, то селектор цены надо указывать на детальной странице товара. Если оба поля заполнены, то предпочтение отдается детальной странице.";
$MESS ['parser_price_type'] = "Тип цены:";
$MESS ['parser_currency'] = "Валюта:";
$MESS ['parser_catalog_tab'] = "Торговый каталог";
$MESS ['parser_catalog_koef'] = "Коэффициент единицы измерения:";
$MESS ['parser_measure'] = "Единица измерения:";

$MESS ['parser_href_catalog'] = "Селектор ссылки товара:";
$MESS ['parser_name_catalog'] = "Селектор названия товара:";
$MESS ['parser_href_descr_catalog'] = "Если ничего не задано, то переход по страницам будет осуществляться по первой найденной ссылке в селекторе списка товаров. Селектор указывается относительно селектора товара.";
$MESS ['parser_name_descr_catalog'] = "Если ничего не задано, то название товара будет браться, как текст селектора ссылки. Селектор указывается относительно селектора товара.";
$MESS ['parser_size_selector'] = "Парсинг размеров по селектору";

$MESS ['parser_size_length'] = "Длина, мм:";
$MESS ['parser_size_width'] = "Ширина, мм:";
$MESS ['parser_size_height'] = "Высота, мм:";
$MESS ['parser_size_weight'] = "Вес, гр:";
$MESS ['parser_selector_size_descr'] = "Парсинг размеров будет осуществляться по конкретным селекторам. Селектора идут относительно главного селектора товара. Также можно удалить лишние символы(двоеточие, точки с запятой и подобные). При удалении символы чередуются через запятую. Если необходимо удалить запятую, то дважды экранируем ее(\\\,).";

$MESS ['parser_size_find'] = "Парсинг размеров по названию";
$MESS ['parser_selector_find'] = "Селектор перечисления размеров:";
$MESS ['parser_find_size_descr'] = "Парсинг осуществляется по селектору перечисления размеров. И уже в нем осуществляется поиск размеров по конкретным названиям. Также можно удалить лишние символы(ед. измерения, двоеточия, точки с запятой и подобные). При удалении символы чередуются через запятую. Если необходимо удалить запятую, то дважды экранируем ее(\\\,).";

$MESS ['parser_more_image'] = "Доп. картинки";
$MESS ['parser_selector_more_image'] = "Селектор-атрибут перечисления доп. картинок:";
$MESS ['parser_selector_more_image_descr'] = "Пример: .image_list img[src]";

$MESS ['parser_selector_props'] = "Парсинг свойств из деталки по селектору";
$MESS ['parser_more_image_prop'] = "Свойство доп. картинок:";
$MESS ['parser_find_props'] = "Парсинг свойств из деталки по названию";
$MESS ['parser_selector_props_preview'] = 'Парсинг свойств из превью по селектору';
$MESS ['parser_find_props_preview'] = 'Парсинг свойств из превью по названию';
$MESS ['parser_selector_find_props'] = "Селектор перечисления свойств:";
$MESS ['parser_mode'] = "Режим парсера:";
$MESS ['parser_mode_descr'] = "При debug режиме осуществляется парсинг первых 3 страниц и 3 товаров каждой страницы. Debug режим необходим для отладки парсера. В рабочий режим парсер необходимо переводить, если вы полностью отладили и настроили парсинг!!!<br/><b>Работа парсера в демо-режиме ограничена и фактически аналогична работе парсера в debug режиме.</b>"; 

$MESS ['parser_header_uniq'] = "Проверка уникальности";
$MESS ['parser_uniq_update'] = "Обновлять товары";
$MESS ['parser_header_uniq_field'] = "Обновлять поля";
$MESS ['parser_header_uniq_field_preview_descr'] = "Превью описание:";
$MESS ['parser_header_uniq_field_detail_descr'] = "Детальное описание:";
$MESS ['parser_header_uniq_field_preview_img'] = "Превью картинка:";
$MESS ['parser_header_uniq_field_detail_img'] = "Детальное картинка:";
$MESS ['parser_header_uniq_field_price'] = "Цена:";
$MESS ['parser_header_uniq_field_descr'] = "Отмеченные поля будут обновляться при обновлении товаров.";
$MESS ['parser_uniq_name'] = "По названию:";
$MESS ['parser_uniq_prop'] = "По свойству:";
//$MESS ['parser_uniq_descr'] = "По умолчанию уникальность элементов проверяется по md5 от названия элемента и урла первоисточника. Эти данные заносятся в XML_ID и далее уже по XML_ID проверяется уникальность. Вы можете изменить поля, по которым будет проверяться уникальность. Если выбрано несколько полей, то проверка уникальности будет по логике И. Если вы не хотите использовать поле XML_ID для проверки уникальности(как по умолчанию), то вам надо переопределить, по каким полям будет проверяться уникальность.";
$MESS ['parser_uniq_descr'] = "По умолчанию при выгрузке товаров заполняется внешний код XML_ID элемента, как md5(название+url страницы). Далее при обновлении уникализация осуществляется именно по внешнему коду. <br/><b>Внимание! Если вы не хотите делать запись во внешний код и уникализировать по нему товар, то укажите, по какому полю производить уникализацию элементов. В этом случае внешний код XML_ID затираться не будет.</b>";


$MESS ['parser_preview_from_detail'] = "Создавать превью картинку из детальной:";
$MESS ['parser_preview_from_detail_text'] = "Создавать превью описание из детального:";
$MESS ['parser_catalog_delete_symb'] = "Удалять символы:";
$MESS ['parser_delete_symb_descr'] = "Удаление символов позволяет удалять лишние символы из общего селектора свойства(названия ед. измерения, двоеточия, точки с запятой и подобное). Перечисление идет через запятую. Если необходжимо удалить саму запятую, то производим двойное экранирование(\\\,).";
$MESS ['parser_delete_symb_descr_offer'] = "Удаление символов позволяет удалять лишние символы из общего селектора свойства(названия ед. измерения, двоеточия, точки с запятой и подобное). Перечисление идет через ||.<br><br>Также возможно указание регулярных выражений. Регулярка заключается в кавычки //. Пример: /(.)*/";

$MESS ['parser_header_uniq_field_more_img'] = "Доп. картинки:";
$MESS ['parser_cat_vat_id'] = "Ставка НДС:";
$MESS ['parser_cat_vat_included'] = "Включать НДС в цену:";
$MESS ['parser_proxy'] = "Прокси-сервер:";
$MESS ['parser_proxy_descr'] = "Указывается прокси-сервер. Пример: 109.194.20.27:3128";
$MESS ['parser_header_uniq_field_param'] = "Параметры каталога:";
$MESS ['parser_header_uniq_field_props'] = "Свойства товара:";
$MESS ['parser_pagenavigation_end'] = "по страницу:";
$MESS ['parser_pagenavigation_begin_descr'] = "Если ничего не задано, то будет парсится весь раздел каталога.";
$MESS ['parser_404_error'] = "Парсить при возникновении 404 ошибки:";
$MESS ['parser_404_descr'] = "Некоторые сайты при переходе по страницам навигации отдают 404 ошибку из-за SEO заморочек. Именно для таких случаев и предназначен выше приведенный параметр.";
$MESS ['parser_logs_tab'] = "Логи";
$MESS ['parser_header_logs'] = "Включить логирование:";
$MESS ['parser_header_logs_download'] = "Скачать лог:"; 
$MESS ['parser_header_log_descr'] = "Производится логирование последней выгрузки. Лог записывается файл."; 
$MESS ['btn_stop_catalog'] = "Остановить";
$MESS ['parser_load_page'] = "Обработано страниц: ";    
$MESS ['parser_load_product'] = " Импортировано товаров: ";
$MESS ['parser_load_product_error'] = " Из них с ошибками: ";
$MESS ['parser_all_error'] = " Всего ошибок: ";
$MESS['parser_instructions'] = "Инструкция";
$MESS['parser_instructions_title'] = "Инструкция пользователя";
$MESS['parser_loading_end'] = "Загрузка завершена"; 

$MESS['parser_update_N'] = "Не обновлять";
$MESS['parser_update_Y'] = "Обновлять";
$MESS['parser_update_empty'] = "Обновлять пустое значение";

$MESS['parser_work_price'] = "Работа с ценами";

$MESS['parser_price_terms_no'] = "Без условия";
$MESS['parser_price_terms_up'] = "Если цена выше";
$MESS['parser_price_terms_down'] = "Если цена ниже";
$MESS['parser_price_updown_no'] = "Не изменять";
$MESS['parser_price_updown_up'] = "Увеличить";
$MESS['parser_price_updown_down'] = "Уменьшить";
$MESS['parser_price_percent'] = "Проценты";
$MESS['parser_price_abs_value'] = "Абсолютная величина";
$MESS['parser_price_updown'] = 'Изменять цену:';
$MESS['parser_price_terms'] = 'Условие изменения цены:';
$MESS['parser_price_type_value'] = 'Тип изменения:';
$MESS['parser_price_value'] = 'Величина изменения:';
$MESS['parser_convert_currency'] = 'Конвертировать в валюту:'; 
$MESS['parser_convert_no'] = 'Нет';
$MESS['parser_step'] = 'Количество товаров, выгружаемых за один шаг парсера:';
$MESS['parser_start_agent_descr'] = 'Рекомендуется запускать агенты из под крона.';
$MESS['parser_auth'] = 'Авторизация';
$MESS['parser_auth_active'] = 'Производить авторизацию на стороннем сайте:';
$MESS['parser_auth_url'] = 'URL авторизационной страницы:';
$MESS['parser_auth_url_descr'] = 'URL страницы, на которой происходит авторизация. Если пустое, то авторизация происходит на странице раздела.';
$MESS['parser_auth_selector'] = 'Селектор формы авторизации:';
$MESS['parser_auth_login'] = 'Логин:';
$MESS['parser_auth_login_name'] = 'Имя поля логина:';
$MESS['parser_auth_password'] = 'Пароль:';
$MESS['parser_auth_password_name'] = 'Имя поля пароля:';
$MESS['parser_auth_password_descr'] = 'Если форма авторизации стандартная, то по-умолчанию достаточно указать лишь логин и пароль. Если же для авторизации не используются такие типы полей, как text, password, то необходимо указать имена полей.';
$MESS['parser_auth_check'] = 'Проверить авторизацию';
$MESS['parser_work_price_num'] = 'Условие';
$MESS['parser_price_num_add'] = 'Добавить условие';
$MESS['parser_price_num_del'] = 'Удалить условие';
$MESS['parser_price_terms_delta'] = 'Если цена в промежутке';
$MESS['parser_price_from'] = 'От';
$MESS['parser_price_to'] = 'До';
$MESS['parser_auth_no'] = 'Неудачная авторизация. Ключи доступа не подходят.';
$MESS['parser_auth_ok'] = 'Авторизация прошла успешно. Ключи доступа актуальные.';
$MESS['parser_auth_error_selector'] = 'Селектор формы авторизации не определен.';
$MESS['parser_selector_find_descr'] = 'Если общий селектор отсутствует и перечисление идет через тег &lt;br&gt;, то пишем примерно следующее: .props br';
$MESS['parser_detail_name'] = 'Селектор названия товара';
$MESS['parser_detail_name_descr'] = 'Если указан, то селектор названия товара в превьюшке будет игнорироваться.';

$MESS['parser_cat_price_offer'] = 'Цены только в инфоблоке торговых предложений:';
$MESS['parser_url_dop'] = 'Дополнительные урлы разделов:';
$MESS['parser_url_dop_descr'] = 'Поле предназначено для парса нескольких разделов одновременно. Каждый урл пишется с новой строки.';
$MESS['parser_prop_default'] = "Значение по умолчанию";

$MESS ['parser_video_tab'] = "Видео-инструкции";
$MESS ['parser_video_catalog_descr'] = "Видео-урок: Парcер контента в режиме работы с каталогами. Сотбит. 1С-Битрикс.";
$MESS ['parser_video_page_descr'] = "Видео-урок: Парcер контента в режиме работы с новостными страницами. Сотбит. 1С-Битрикс.";
$MESS ['parser_video_rss_descr'] = "Видео-урок: Парcер контента в режиме работы с rss лентами. Сотбит. 1С-Битрикс. ";

$MESS ['parser_price_format'] = "Формат цены(разделители):";
$MESS ['parser_price_format1'] = " тысячи ";
$MESS ['parser_price_format2'] = " копейки ";
$MESS ['parser_price_format_descr'] = "Заполняется в том случае, если цена состоит из тысяч и копеек со своими разделителями. В большинстве случаев можно оставлять пустым.";

$MESS["shs_parser_select_prop"] = "Выберите свойство";
$MESS["shs_parser_select_prop_new"] = "[Создать]";
$MESS["parser_iblock_id_descr"] = "При изменении инфоблока необходимо сохранить настройки.";
$MESS["parser_price_okrug"] = "Округление цены:";
$MESS["parser_price_okrug_no"] = "Не округлять";
$MESS["parser_price_okrug_up"] = "Округлять с указанной точностью";
$MESS["parser_price_okrug_ceil"] = "Округление в большую сторону до целого";
$MESS["parser_price_okrug_floor"] = "Округление в меньшую сторону до целого";
$MESS["parser_price_okrug_delta1"] = "до";
$MESS["parser_price_okrug_delta2"] = "знаков после запятой";
$MESS["parser_price_okrug_descr"] = "Округления до целых чисел точность(количество знаков после запятой) не учитывают.";

$MESS["shs_parser_select_prop_but"] = "Добавить";
$MESS["parser_prop_detail_preview_descr"] = "Внимание! Свойства, выгруженные с детальной страницы, являются приоритетными.";
$MESS["parser_prop_detail_preview_descr_file"] = "<br/><br/>При парсинге свойств по селектору возможен парсинг свойств типа файл(F). Для этого необходимо указать селектор элемента и атрибут, например: .instructions[href]";
$MESS["parser_offer_tab"] = "Торговые предложения";
$MESS["parser_offer_selector"] = "Главный селектор контейнера торговых предложений:";
$MESS["parser_offer_selector_item"] = "Селектор отдельного оффера:";
$MESS["parser_offer_table_desc"] = "Торговые предложения табличного вида";
$MESS["parser_offer_load_no"] = "Не выгружать";
$MESS["parser_offer_load_table"] = "Выгружать из табличного вида";
$MESS["parser_offer_load"] = "Выгружать офферы:";
$MESS["parser_offer_selector_head"] = "Селектор блока шапки таблицы:";
$MESS["parser_offer_selector_head_th"] = "Селектор наименования параметра в шапке таблицы:";
$MESS["parser_offer_selector_head_th_descr"] = "Необходим, если поля и свойства определяются по названию. Относительно предыдущего поля. Пример: th, td";
$MESS["parser_offer_selector_item_td"] = "Селектор значения параметра в теле таблицы:";
$MESS["parser_offer_selector_item_td_descr"] = "Необходим, если поля и свойства определяются по названию. Считается относительно предыдущего поля. Пример: td";
$MESS["parser_offer_parsing_selector"] = "Парсинг полей и свойств по селектору";
$MESS["parser_offer_parsing_find"] = "Парсинг полей и свойств по названию";
$MESS["parser_offer_parsing_selector_name"] = "Наименование:";
$MESS["parser_offer_parsing_selector_price"] = "Цена:";
$MESS["parser_offer_load_descr"] = "После изменения параметра необходимо Применить настройки.";
$MESS["parser_offer_selector_descr"] = "Относительно селектора товара на детальной странице. Пример: table, .mainOfferTable";
$MESS["parser_offer_selector_head_descr"] = "Необходим, если поля и свойства определяются по названию. Считается относительно предыдущего параметра. Данный параметр необходим, если парсинг полей и свойств осуществляется по названию. Пример: thead tr, tr:eq(0)";
$MESS["parser_offer_selector_item_descr"] = "Считается относительно главного контейнера офферов. Пример: tbody tr, tr:eq(0)+tr";
$MESS["parser_offer_parsing_selector_prop"] = "Парсинг свойств по селектору";
$MESS["parser_offer_table_desc_1"] = "Артикул";
$MESS["parser_offer_table_desc_2"] = "Цвет";
$MESS["parser_offer_table_desc_3"] = "Формат, мм";
$MESS["parser_offer_table_desc_4"] = "Кол-во страниц";
$MESS["parser_offer_table_desc_5"] = "Кол-во языков";
$MESS["parser_offer_table_desc_6"] = "Плотность бумаги";
$MESS["parser_offer_table_desc_7"] = "Блок";
$MESS["parser_offer_table_desc_8"] = "Цена (без НДС), руб.";
$MESS["parser_offer_table_desc_9"] = "коричневый";
$MESS["parser_offer_table_desc_10"] = "70 г/м";
$MESS["parser_offer_table_desc_11"] = "шитый";
$MESS["parser_offer_table_desc_12"] = "А5";
$MESS["parser_offer_parsing_find_prop"] = "Парсинг свойств по названию";
$MESS["parser_header_element_action"] = "Действия над элементами";
$MESS["parser_element_action"] = "Что делать с товарами, присутствующими в предыдущей выгрузке и отсутствующими в текущей:";
$MESS["parser_offer_add_name"] = "Параметр уникализации офферов:";
$MESS["parser_default_props"] = "Значения свойств по умолчанию";
$MESS["parser_action_N"] = "ничего";
$MESS["parser_action_A"] = "деактивировать";
$MESS["parser_action_D"] = "удалить";
$MESS["parser_add_delete_symb_props"] = "Добавление/удаление символов полей и свойств";
$MESS["parser_SOTBIT_PARSER_NAME_E"] = "Название товара";
$MESS["parser_action_props_delete"] = "Удалить";
$MESS["parser_action_props_add_begin"] = "Добавить в начало";
$MESS["parser_action_props_add_end"] = "Добавить в конец";
$MESS["shs_parser_select_action_props"] = "Выберите действие";
$MESS["shs_parser_action_props_descr"] = htmlspecialchars("Укажите необходимые символы или слова, если вы хотите удалить/добавить их к указанному полю или свойству. Если необходимо записать пробел, то укажите его спец. символ: &nbsp;")."<br><br>Внимание! Действия возможны только над свойствами и полями типа Строка(S)";
$MESS["parser_element_action_descr"] = "Работает в том случае, если отмечена галочка Обновлять товары. Товары из предыдущей выгрузки сравниваются с товарами из текущей. На основании этого и производятся действия над элементами.";
$MESS["parser_offer_add_name_descr"] = "<b>Важный параметр!!! Особенности:</b><br>1. Указанные свойства добавляются в название оффера.<br>2. Если название оффера отсутствует, то название полностью будет состоять из значений указанных свойств.<br>3. По данному параметру происходит уникализации офферов.<br>4. Если ничего не указано, то уникальность будет определяться по названию оффера.";
$MESS["parser_offer_add_name_one_descr"] = "<b>Важный параметр!!! Особенности:</b><br>1. Указанные свойства добавляются в название оффера.<br>2. По данному параметру происходит уникализации офферов.";

$MESS["parser_offer_parsing_selector_name_descr"] = "Название торгового предложения. Может быть пустое, если отмечены свойства параметра уникализации. Тогда название будет состоять из значений казанных свойств.";
$MESS["parser_offer_parsing_selector_price_descr"] = "Если пусто, то цена будет браться из блока Превью или Детально";
$MESS["parser_offer_load_one"] = "Офферы с одной характеристикой";
$MESS["parser_offer_one_selector"] = "Селектор контейнера отдельной характеристики оффера";
$MESS["parser_offer_one_selector_descr"] = "Фактически это селектор выбора характеристики оффера, который указан в Параметре уникализации. Пример: select option, #charect div.size";
$MESS["parser_offer_one_price_attr"] = "Атрибут цены";
$MESS["parser_offer_one_price_attr_descr"] = "Иногда цена записывается в атрибут предыдущего параметра. Например: data-price. Если ничего не задано, то цена будет браться из вкладок Превью или Детально.";
$MESS["parser_work_pagenavigation"] = "Работа с постраничной навигацией";
$MESS["parser_work_pagenavigation_var"] = "Переменная-параметр постраничной навигации";
$MESS["parser_work_pagenavigation_other_var"] = "Другие переменные-параметры";
$MESS["parser_work_pagenavigation_page_count"] = "Количество страниц навигации";
$MESS["parser_standart_pagenavigation"] = "Стандартная постраничная навигация";
$MESS["parser_work_pagenavigation_descr"] = "Данный блок предназначен, если стандартная навигация не работает(отсутствие ссылок href). В таком случае вы можете настроить постраничную навигацию самостоятельно.";
$MESS["parser_work_pagenavigation_var_descr"] = "Переменная в урле, отвечающая за постраничную навигацию. Пример: page, PAGE_1. Далее парсер сам будет подставлять значения к этой переменной. Например: page=1, page=2";
$MESS["parser_work_pagenavigation_other_var_descr"] = "Перечислить переменные и их значения, которые также отвечают за постраничную навигацию. Пример: set_filter=Y&back=1&ajax=Y";
$MESS["parser_work_pagenavigation_page_count_descr"] = "Данный параметр необходимо заполнять, если блок Стандартной навигации не заполнен и вы заранее знаете количество страниц.";
$MESS["parser_local_tab"] = "Сервисы";
$MESS["parser_loc_type"] = "Тип перевода";
$MESS["parser_loc_no"] = "Не переводить";
$MESS["parser_loc_yandex"] = "Яндекс.Переводчик";
$MESS["parser_loc_yandex_key"] = "Ключ от API Яндекс.Переводчик";
$MESS["parser_loc_yandex_key_descr"] = "Данный ключ вы можете получить совершенно бесплатно по адресу: <a target='_blank' href='https://tech.yandex.ru/keys/get/?service=trnsl'>https://tech.yandex.ru/keys/get/?service=trnsl</a>";
$MESS["parser_loc_yandex_lang"] = "Направление перевода";
$MESS["parser_loc_yandex_lang_descr"] = "Может задаваться одним из следующих способов:<br>
- В виде пары кодов языков («с какого»-«на какой»), разделенных дефисом. Например, en-ru обозначает перевод с английского на русский.<br>
- В виде кода конечного языка (например ru). В этом случае сервис пытается определить исходный язык автоматически.<br><br>
Ограничения:<br>
- Максимальный размер передаваемого текста составляет 10000 символов.
";
$MESS["parser_loc_fields"] = "Переводить поля";
$MESS["parser_loc_fields_name"] = "Название";
$MESS["parser_loc_fields_preview_text"] = "Превью текст";
$MESS["parser_loc_fields_detail_text"] = "Детальное описание";
$MESS["parser_loc_fields_props"] = "Свойства";
$MESS["parser_loc_type_head"] = "Перевод текста";
$MESS["parser_loc_uniq"] = "Отправлять уникальный текст в Яндекс";
$MESS["parser_loc_uniq_domain"] = "Выберите домен";
$MESS["shs_parser_loc_uniq_no"] = "Не отправлять";
$MESS["parser_loc_uniq_domain_descr"] = "Осуществляется отправка только детального описания при создании нового элемента. При обновлении товаров отправка не осуществляется.<br><br>
Разрешается добавлять не более 100 текстов в сутки, при этом размер текста должен быть в пределах от 500 до 32000 символов.
";


?>47   273|/shs.parser/lang/ru/admin/menu.php|23a62caa<?
$MESS ['mnu_shs_parser_sect'] = "Парсер";
$MESS ['mnu_shs_list_parser'] = "Список парсеров";
$MESS ['mnu_shs_list_parser_alt'] = "Список парсеров";
$MESS ['mnu_shs_parser_sect_title'] = "Управление парсерами";
?>64   528|/shs.parser/lang/ru/classes/general/list_parser.php|9e33a6e4<?
$MESS["class_parser_err_name"] = "Название не может быть пустым.";
$MESS["class_parser_err_sort"] = "Поле сортировка должно быть числом";
$MESS["class_parser_err_rss"] = "RSS канал не может быть пустым";
$MESS["class_parser_err_iblock"] = "Поле информационный блок не может быть пустым";
$MESS["class_parser_err_time_agent"] = "Периодичность запуска задана не верно";
?>50   340|/shs.parser/lang/ru/install/index.php|cc2c1d2a<?
$MESS["shs.parser_MODULE_NAME"] = "Парсер контента";
$MESS["shs.parser_MODULE_DESC"] = "Позволяет парсить(загружать) каталоги, статьи, новости, rss ленты";
$MESS["shs.parser_PARTNER_NAME"] = "Сотбит";
$MESS["shs.parser_PARTNER_URI"] = "http://www.sotbit.ru";
?>54   19284|/shs.parser/admin/list_parser_admin.php|a85c2b84<?
use Bitrix\Main\Loader;
use Bitrix\Main\Entity;
use Bitrix\Main\Entity\ExpressionField;
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/classes/mysql/list_parser.php");
//require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/classes/general/rss_content_parser.php");
if(!CModule::IncludeModule('iblock')) return false;
IncludeModuleLangFile(__FILE__);
global $shs_DEMO;
$POST_RIGHT = $APPLICATION->GetGroupRight("shs.parser");
if($POST_RIGHT=="D")
	$APPLICATION->AuthForm(GetMessage("ACCESS_DENIED"));

$ID = intval($ID);
$sTableID = "tbl_parser";
function CheckFilter()
{
	global $FilterArr, $lAdmin;
	foreach ($FilterArr as $f) global $$f;
	if (strlen(trim($find_last_executed_1))>0 || strlen(trim($find_last_executed_2))>0)
	{
		/*$date_1_ok = false;
		$date1_stm = MkDateTime(FmtDate($find_last_executed_1,"D.M.Y"),"d.m.Y");
		$date2_stm = MkDateTime(FmtDate($find_last_executed_2,"D.M.Y")." 23:59","d.m.Y H:i");
		if (!$date1_stm && strlen(trim($find_last_executed_1))>0)
			$lAdmin->AddFilterError(GetMessage("rub_wrong_generation_from"));
		else $date_1_ok = true;
		if (!$date2_stm && strlen(trim($find_last_executed_2))>0)
			$lAdmin->AddFilterError(GetMessage("rub_wrong_generation_till"));
		elseif ($date_1_ok && $date2_stm <= $date1_stm && strlen($date2_stm)>0)
			$lAdmin->AddFilterError(GetMessage("rub_wrong_generation_from_till"));*/
	}
	//return count($lAdmin->arFilterErrors)==0;
    return true;
}

$oSort = new CAdminSorting($sTableID, "ID", "desc");
$lAdmin = new CAdminList($sTableID, $oSort);

$FilterArr = Array(
	"find",
	"find_id",
    "find_type",
    "find_name",
	"find_timestamp_1",
	"find_rss",
	"find_active",
	"find_iblock_id",
	"find_section_id",
	"find_encoding",
    "find_start_last_time_1",
    "find_show_sp"
);
$parentID = 0;
if(isset($_REQUEST["parent"]) && $_REQUEST["parent"])
{
    $parentID = $_REQUEST["parent"];
}

$lAdmin->InitFilter($FilterArr);

if (CheckFilter())
{
	$arFilter = array(
		"ID" => ($find!="" && $find_type == "id"? $find:$find_id),
        "TYPE" => $find_main_type,
		"TIMESTAMP_1" => $find_timestamp_1,
		"NAME" => $find_name,
		"RSS" => $find_rss,
		"ACTIVE" => $find_active,
		"IBLOCK_ID" => $find_iblock_id,
		"SECTION_ID" => $find_section_id,
		"ENCODING" => $find_from,
        "START_AGENT" => $find_start_agent,
        "TIME_AGENT" => $find_time_agent,
        "START_LAST_TIME_1" => $find_start_last_time_1,
        "CATEGORY_ID" => $parentID
	);
}

if($lAdmin->EditAction() && $POST_RIGHT=="W")
{
	foreach($FIELDS as $ID=>$arFields)
	{
		if(!$lAdmin->IsUpdated($ID))
			continue;
		$DB->StartTransaction();
		$ID = IntVal($ID);
		$ob = new ShsParserContent;
		if(!$ob->Update($ID, $arFields))
		{
			$lAdmin->AddUpdateError(GetMessage("parser_save_err").$ID.": ".$ob->LAST_ERROR, $ID);
			$DB->Rollback();
		}
		$DB->Commit();
	}
}

if(($arID = $lAdmin->GroupAction()) && $POST_RIGHT=="W")
{
	if($_REQUEST['action_target']=='selected')
	{
		$cData = new ShsParserContent;
		//$rsData = $cData->GetList(array($by=>$order), $arFilter);
        $rsData = $cData->GetMixedList(array($by=>$order), $arFilter);
		while($arRes = $rsData->Fetch())
			$arID[] = $arRes['ID'];
	}
    
	foreach($arID as $ID)
	{
		if(strlen($ID)<=0)
			continue;
		$TYPE = substr($ID, 0, 1);
		$ID = intval(substr($ID,1));

		switch($_REQUEST['action'])
		{
		case "delete":
			@set_time_limit(0);
			$DB->StartTransaction();
            if($TYPE=="P")
            {
                if(!ShsParserContent::Delete($ID))
    			{
    				$DB->Rollback();
    				$lAdmin->AddGroupError(GetMessage("parser_del_err"), $ID);
    			}
            }
            if($TYPE=="S")
            {
                if(!ShsParserSectionTable::Delete($ID))
    			{
    				$DB->Rollback();
    				$lAdmin->AddGroupError(GetMessage("parser_del_err"), $ID);
    			}
            }

			$DB->Commit();
			break;
        case "activate":
        case "deactivate":
            $cData = new ShsParserContent;
            if($TYPE=="P" && ($rsData = $cData->GetByID($ID)) && ($arFields = $rsData->Fetch()))
            {
                $arFields["ACTIVE"]=($_REQUEST['action']=="activate"?"Y":"N");
                unset($arFields["TIME_AGENT"]);
                unset($arFields["TIME_AGENT"]);
                unset($arFields["START_LAST_TIME_X"]);
                unset($arFields["TIMESTAMP_X"]);
                if(!$cData->Update($ID, $arFields))
                    $lAdmin->AddGroupError(GetMessage("parser_save_error").$cData->LAST_ERROR, $ID);
            }elseif($TYPE=="S")
            {
                $arFields["ACTIVE"]=($_REQUEST['action']=="activate"?"Y":"N");
                if(!ShsParserSectionTable::Update($ID, $arFields))
                    $lAdmin->AddGroupError(GetMessage("parser_save_error").$cData->LAST_ERROR, $ID);
            }
            else
                $lAdmin->AddGroupError(GetMessage("parser_save_error")." ".GetMessage("rub_no_rubric"), $ID);
            break;

		}
	}
}

$lAdmin->AddHeaders(array(
	array(	"id"		=>"ID",
		"content"	=>"ID",
		"sort"		=>"id",
		"align"		=>"right",
		"default"	=>true,
	),
    array(	"id"		=>"NAME",
		"content"	=>GetMessage("parser_name"),
		"sort"		=>"name",
		"default"	=>true,
	),
    array(	"id"		=>"TYPE",
		"content"	=>GetMessage("parser_type"),
		"sort"		=>"type",
		"default"	=>true,
	),
	array(	"id"		=>"TIMESTAMP_X",
		"content"	=>GetMessage("parser_updated"),
		"sort"		=>"timestamp",
		"default"	=>true,
	),
	array(	"id"		=>"RSS",
		"content"	=>GetMessage("parser_rss"),
		"sort"		=>"rss",
		"default"	=>true,
	),
	array(	"id"		=>"SORT",
		"content"	=>GetMessage("parser_sort"),
		"sort"		=>"sort",
		"default"	=>true,
	),
	array(	"id"		=>"ACTIVE",
		"content"	=>GetMessage("parser_active"),
		"sort"		=>"active",
		"default"	=>true,
	),
	array(	"id"		=>"IBLOCK_ID",
		"content"	=>GetMessage("parser_iblock_id"),
		"sort"		=>"iblock_id",
		"default"	=>false,
	),
	array(	"id"		=>"SECTION_ID",
		"content"	=>GetMessage("parser_section_id"),
		"sort"		=>false,
		"default"	=>false,
	),
	array(	"id"		=>"SELECTOR",
		"content"	=>GetMessage("parser_selector"),
		"sort"		=>"selector",
		"default"	=>false,
	),
	array(	"id"		=>"ENCODING",
		"content"	=>GetMessage("parser_encoding"),
		"sort"		=>"encoding",
		"default"	=>true,
	),

    array(	"id"		=>"START_AGENT",
		"content"	=>GetMessage("parser_start_agent"),
		"sort"		=>"start_agent",
		"default"	=>true,
	),
    array(	"id"		=>"TIME_AGENT",
		"content"	=>GetMessage("parser_time_agent"),
		"sort"		=>"time_agent",
		"default"	=>false,
	),

    array(	"id"		=>"START_LAST_TIME_X",
		"content"	=>GetMessage("parser_start_last_time"),
		"sort"		=>"start_last_time",
		"default"	=>true,
	),
));

$cData = new ShsParserContent;
//$rsData = $cData->GetList(array($by=>$order), $arFilter);
//printr($arFilter);
$show = "all";
if(isset($_REQUEST["show_sp"]) && $_REQUEST["show_sp"]=="all")
{
    unset($arFilter["CATEGORY_ID"]);
    $show = "all";
}elseif(isset($_REQUEST["show_sp"]) && $_REQUEST["show_sp"]=="section")
{
    $show = "section";
    unset($arFilter["CATEGORY_ID"]);    
}elseif(isset($_REQUEST["show_sp"]) && $_REQUEST["show_sp"]=="parser")
{
    $show = "parser";
    unset($arFilter["CATEGORY_ID"]);    
}

$rsData = $cData->GetMixedList(array($by=>$order), $arFilter, $show);
$rsData = new CAdminResult($rsData, $sTableID);
$rsData->NavStart();
$lAdmin->NavText($rsData->GetNavPrint(GetMessage("parser_nav")));
$rsIBlock = CIBlock::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y"));
while($arr=$rsIBlock->Fetch()){
    $arIBlock[$arr["ID"]] = "[".$arr["ID"]."] ".$arr["NAME"];
    $arIBlockFilter['REFERENCE'][] = "[".$arr["ID"]."] ".$arr["NAME"];
    $arIBlockFilter['REFERENCE_ID'][] = $arr["ID"];
}




$arShowSP['REFERENCE'] = array(GetMessage("parser_show_sp_tree"), GetMessage("parser_show_sp_all"), GetMessage("parser_show_sp_section"), GetMessage("parser_show_sp_parser"));
$arShowSP['REFERENCE_ID'] = array("tree", "all", "section", "parser");


while($arRes = $rsData->NavNext(true, "f_")):
	$row =& $lAdmin->AddRow($f_T.$f_ID, $arRes);
    if($f_T=="S")
    {
        $row->AddViewField("NAME", '<a href="list_parser_admin.php?parent='.$f_ID.'&lang='.LANG.'" class="adm-list-table-icon-link" title="'.GetMessage("IBLIST_A_LIST").'"><span class="adm-submenu-item-link-icon adm-list-table-icon iblock-section-icon"></span><span class="adm-list-table-link">'.$f_NAME.'</span></a>');
    }
	else{
        $row->AddViewField("NAME", '<a href="parser_edit.php?ID='.$f_ID.'&parent='.$parentID.'&lang='.LANG.'" title="'.GetMessage("parser_act_edit").'">'.$f_NAME.'</a>');
	}



	$row->AddInputField("NAME", array("size"=>20));

    $row->AddViewField("TYPE", $f_TYPE);

    $row->AddViewField("RSS", '<a href="parser_edit.php?ID='.$f_ID.'&amp;lang='.LANG.'" title="'.GetMessage("parser_act_edit").'">'.$f_RSS.'</a>');
	$row->AddInputField("RSS", array("size"=>20));

    $row->AddInputField("SORT", array("size"=>20));

    $row->AddCheckField("ACTIVE");

    $row->AddSelectField("IBLOCK_ID", $arIBlock);
    $row->AddSelectField("ENCODING", array('utf-8'=>'utf-8', 'windows-1251'=>'windows-1251'));
    $row->AddCheckField("START_AGENT");
    $row->AddInputField("TIME_AGENT", array("size"=>20));

	$arActions = Array();

	if($POST_RIGHT=="W" && $f_T=="P")
		$arActions[] = array(
			"ICON"=>"edit",
			"DEFAULT"=>true,
			"TEXT"=>GetMessage("parser_act_edit"),
			"ACTION"=>$lAdmin->ActionRedirect("parser_edit.php?parent=".$parentID."&ID=".$f_ID)
		);
	if($POST_RIGHT=="W" && $f_T=="P")
		$arActions[] = array(
			"ICON"=>"delete",
			"TEXT"=>GetMessage("parser_act_del"),
			"ACTION"=>"if(confirm('".GetMessage("parser_act_del_conf")."')) ".$lAdmin->ActionDoGroup("P".$f_ID, "delete")
		);
    if($POST_RIGHT=="W" && $f_T=="P")
		$arActions[] = array(
			"ICON"=>"copy",
			"DEFAULT"=>true,
			"TEXT"=>GetMessage("parser_act_copy"),
			"ACTION"=>$lAdmin->ActionRedirect("parser_edit.php?copy=".$f_ID)
		);

    if($POST_RIGHT=="W" && $f_T=="S")
		$arActions[] = array(
			"ICON"=>"edit",
			"DEFAULT"=>true,
			"TEXT"=>GetMessage("parser_act_edit"),
			"ACTION"=>$lAdmin->ActionRedirect("parser_section_edit.php?parent=".$parentID."&ID=".$f_ID)
		);
	if($POST_RIGHT=="W" && $f_T=="S")
		$arActions[] = array(
			"ICON"=>"delete",
			"TEXT"=>GetMessage("parser_act_del"),
			"ACTION"=>"if(confirm('".GetMessage("parser_act_del_conf")."')) ".$lAdmin->ActionDoGroup("S".$f_ID, "delete")
		);
    if($POST_RIGHT=="W" && $f_T=="S")
		$arActions[] = array(
			"ICON"=>"copy",
			"DEFAULT"=>true,
			"TEXT"=>GetMessage("parser_act_copy"),
			"ACTION"=>$lAdmin->ActionRedirect("parser_section_edit.php?copy=".$f_ID)
		);

	$arActions[] = array("SEPARATOR"=>true);

	/*if($POST_RIGHT=="W")
		$arActions[] = array(
			"ICON"=>"",
			"TEXT"=>GetMessage("parser_act_start"),
			"ACTION"=>"if(confirm('".GetMessage("parser_conf")."')) window.location='".$APPLICATION->GetCurPage()."?ID=".$f_ID."&action=parser&lang=".LANG."&".bitrix_sessid_get()."'"
		);*/

	if(is_set($arActions[count($arActions)-1], "SEPARATOR"))
		unset($arActions[count($arActions)-1]);
	$row->AddActions($arActions);

endwhile;

$lAdmin->AddFooter(
	array(
		array("title"=>GetMessage("MAIN_ADMIN_LIST_SELECTED"), "value"=>$rsData->SelectedRowsCount()),
		array("counter"=>true, "title"=>GetMessage("MAIN_ADMIN_LIST_CHECKED"), "value"=>"0"),
	)
);
$lAdmin->AddGroupActionTable(Array(
	"delete"=>GetMessage("MAIN_ADMIN_LIST_DELETE"), //   
    "activate"=>GetMessage("MAIN_ADMIN_LIST_ACTIVATE"), //   
    "deactivate"=>GetMessage("MAIN_ADMIN_LIST_DEACTIVATE"), //   
	));

$aContext = array(
	array(
		"TEXT"=>GetMessage("SHS_PARSER_MAIN_ADD"),
		"LINK"=>"parser_edit.php?parent=".$parentID."&lang=".LANG,
		"TITLE"=>GetMessage("PARSER_ADD_TITLE"),
		"ICON"=>"btn_new",
	),
    array(
		"TEXT"=>GetMessage("SHS_PARSER_SECTION_MAIN_ADD"),
		"LINK"=>"parser_section_edit.php?parent=".$parentID."&lang=".LANG,
		"TITLE"=>GetMessage("PARSER_SECTION_ADD_TITLE"),
		"ICON"=>"btn_sect_new",
	),
);
$lAdmin->AddAdminContextMenu($aContext);

//     
$lAdmin->AddAdminContextMenu($aContext);

$lAdmin->CheckListMode();

$APPLICATION->SetTitle(GetMessage("post_title"));

require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_after.php");

$oFilter = new CAdminFilter(
	$sTableID."_filter",
	array(
		"id" => GetMessage("PARSER_F_ID"),
		"timestamp" => GetMessage("PARSER_F_TIMESTAMP"),
        "name" => GetMessage("PARSER_F_NAME"),
        "type" => GetMessage("PARSER_F_TYPE"),
        "rss" => GetMessage("PARSER_F_RSS"),
        "active" => GetMessage("PARSER_F_ACTIVE"),
		"iblock_id" => GetMessage("PARSER_F_IBLOCK_ID"),
        "section_id" => GetMessage("PARSER_F_SECTION_ID"),
		"encoding" => GetMessage("PARSER_F_ENCODING"),
        "start_agent" => GetMessage("PARSER_F_START_AGENT"),
        "time_agent" => GetMessage("PARSER_F_TIME_AGENT"),
        "start_last_time" => GetMessage("PARSER_F_START_LAST_TIME"),
        "show_s_p" => GetMessage("PARSER_SHOW_SECTION_PARSER")
	)
);
if($shs_DEMO==2)CAdminMessage::ShowMessage(array("MESSAGE"=>GetMessage("parser_demo")));
if($shs_DEMO==3)CAdminMessage::ShowMessage(array("MESSAGE"=>GetMessage("parser_demo_end")));

?>
<form name="find_form" method="get" action="<?echo $APPLICATION->GetCurPage();?>">
<?
$oFilter->Begin();
?>
<tr>
	<td><b><?=GetMessage("PARSER_FIND")?>:</b></td>
	<td>
		<input type="text" size="25" name="find" value="<?echo htmlspecialchars($find)?>" title="<?=GetMessage("POST_FIND_TITLE")?>">
		<?
		$arr = array(
			"reference" => array(
				GetMessage("PARSER_F_ID"),
				GetMessage("PARSER_F_NAME"),
				GetMessage("PARSER_F_RSS"),
			),
			"reference_id" => array(
				"id",
				"name",
				"rss",
			)
		);
		echo SelectBoxFromArray("find_type", $arr, $find_type, "", "");
		?>
	</td>
</tr>
<tr>
	<td><?=GetMessage("PARSER_F_ID")?>:</td>
	<td>
		<input type="text" name="find_id" size="47" value="<?echo htmlspecialchars($find_id)?>">
		&nbsp;<?=ShowFilterLogicHelp()?>
	</td>
</tr>
<tr>
	<td><?echo GetMessage("PARSER_F_TIMESTAMP")." (".FORMAT_DATE."):"?></td>
	<td><?echo CalendarPeriod("find_timestamp_1", $find_timestamp_1, "find_timestamp_2", $find_timestamp_2, "find_form","Y")?></td>
</tr>
<tr>
	<td><?echo GetMessage("PARSER_F_NAME")?>:</td>
	<td><input type="text" name="find_name" size="47" value="<?echo htmlspecialchars($find_name)?>">&nbsp;<?=ShowFilterLogicHelp()?></td>
</tr>
<tr>
	<td><?=GetMessage("PARSER_F_TYPE")?>:</td>
	<td>
		<?
        $arrType = array(
			"reference" => array(
				"rss",
				"page",
			),
			"reference_id" => array(
				"rss",
				"page",
			)
		);
		echo SelectBoxFromArray("find_main_type", $arrType, "", GetMessage("MAIN_ALL"), "");
		?>
	</td>
</tr>
<tr>
	<td><?echo GetMessage("PARSER_F_RSS")?>:</td>
	<td><input type="text" name="find_rss" size="47" value="<?echo htmlspecialchars($find_rss)?>">&nbsp;<?=ShowFilterLogicHelp()?></td>
</tr>
<tr>
	<td><?=GetMessage("PARSER_F_ACTIVE")?>:</td>
	<td><?
		$arr = array("reference"=>array(GetMessage("MAIN_YES"), GetMessage("MAIN_NO")), "reference_id"=>array("Y","N"));
		echo SelectBoxFromArray("find_active", $arr, htmlspecialchars($find_active), GetMessage("MAIN_ALL"));
	?></td>
</tr>
<tr>
	<td><?=GetMessage("PARSER_F_IBLOCK_ID")?>:</td>
	<td>

		<?
		echo SelectBoxFromArray("find_iblock_id", $arIBlockFilter, "", GetMessage("MAIN_ALL"), "");
		?>
	</td>
</tr>
<tr>
	<td><?=GetMessage("PARSER_F_SECTION_ID")?>:</td>
	<td>
		<input type="text" name="find_section_id" size="47" value="<?echo htmlspecialchars($find_section_id)?>">
		&nbsp;<?=ShowFilterLogicHelp()?>
	</td>
</tr>
<tr>
	<td><?=GetMessage("PARSER_F_ENCODING")?>:</td>
	<td>
		<?
        $arr = array(
			"reference" => array(
				"utf-8",
				"windows-1251",
			),
			"reference_id" => array(
				"utf-8",
				"windows-1251",
			)
		);
		echo SelectBoxFromArray("find_encoding", $arr, "", GetMessage("MAIN_ALL"), "");
		?>
	</td>
</tr>
<tr>
	<td><?=GetMessage("PARSER_F_START_AGENT")?>:</td>
	<td><?
		$arr = array("reference"=>array(GetMessage("MAIN_YES"), GetMessage("MAIN_NO")), "reference_id"=>array("Y","N"));
		echo SelectBoxFromArray("find_active", $arr, htmlspecialchars($find_start_agent), GetMessage("MAIN_ALL"));
	?></td>
</tr>
<tr>
	<td><?echo GetMessage("PARSER_F_TIME_AGENT")?>:</td>
	<td><input type="text" name="find_time_agent" size="10" value="<?echo htmlspecialchars($find_time_agent)?>">&nbsp;<?=ShowFilterLogicHelp()?></td>
</tr>
<tr>
	<td><?echo GetMessage("PARSER_F_START_LAST_TIME")." (".FORMAT_DATE."):"?></td>
	<td><?echo CalendarPeriod("find_start_last_time_1", $find_start_last_time_1, "find_start_last_time_2", $find_start_last_time_2, "find_form","Y")?></td>
</tr>
<tr>
	<td><?=GetMessage("PARSER_SHOW_SECTION_PARSER")?>:</td>
	<td>

		<?
		echo SelectBoxFromArray("show_sp", $arShowSP, $find_show_sp, "", "");
		?>
	</td>
</tr>

<?
$oFilter->Buttons(array("table_id"=>$sTableID,"url"=>$APPLICATION->GetCurPage(), "form" => "find_form"));
$oFilter->End();
?>
<input type="hidden" name="parent" value="<?=$_REQUEST["parent"]?>" />
</form>

<?
//******************************
// Send message and show progress
//******************************
if(isset($_REQUEST['parser_end']) && $_REQUEST['parser_end']==1 && isset($_REQUEST['parser_id']) && $_REQUEST['parser_id']>0){
    if(isset($_GET['SUCCESS'][0])){
      foreach($_GET['SUCCESS'] as $success) CAdminMessage::ShowMessage(array("MESSAGE"=>$success, "TYPE"=>"OK"));
    }
    if(isset($_GET['ERROR'][0])){
        foreach($_GET['ERROR'] as $error) CAdminMessage::ShowMessage($error);
    }

}
if(isset($_REQUEST['action']) && $_REQUEST['action']=="parser"):
$parser = ShsParserContent::GetByID($_REQUEST['ID']);
if(!$parser->ExtractFields("shs_"))
    $ID=0;

if($ID>0){
    $rssParser = new RssContentParser();
    $result = $rssParser->startParser();
    if(isset($result[SUCCESS][0]))
    foreach($result[SUCCESS] as $i=>$success){
        $resultUrl .= "&SUCCESS[".$i."]=".urlencode($success);
    }
    if(isset($result[ERROR][0]))
     foreach($result[ERROR] as $i=>$error){
     $resultUrl .= "&ERROR[".$i."]=".urlencode($error);
    }
    LocalRedirect($APPLICATION->GetCurPageParam("parser_end=1&parser_id=".$ID.$resultUrl, array("action")));
}

endif;?>

<?$lAdmin->DisplayList();?>

<?
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/epilog_admin.php");
?>
56   84394|/shs.parser/admin/parser_edit_catalog.php|6fdd5ae7<?
use Bitrix\Seo\Engine;
use Bitrix\Main\Text\Converter;
use Bitrix\Main\Localization\Loc;
use Bitrix\Main\IO\Path;

\Bitrix\Main\Loader::includeModule('seo');
\Bitrix\Main\Loader::includeModule('socialservices');   
global $shs_IBLOCK_ID;
$tabControl->BeginNextTab();
$arEncoding['reference'] = array('utf-8', 'windows-1251');
$arEncoding['reference_id'] = array('utf-8', 'windows-1251');
$arType['reference'] = array('html', 'text');
$arType['reference_id'] = array('html', 'text');
$arMode['reference'] = array('debug', 'work');
$arMode['reference_id'] = array('debug', 'work');
if($shs_DEMO!=1)
{
    unset($arMode['reference'][1]);
    unset($arMode['reference_id'][1]);    
}


$arOfferLoad['reference'] = array(GetMessage("parser_offer_load_no"), GetMessage("parser_offer_load_table"), GetMessage("parser_offer_load_one"));
$arOfferLoad['reference_id'] = array('', 'table', 'one');


$arTypeParser['reference'] = array('rss', 'page', 'catalog');
$arTypeParser['reference_id'] = array('rss', 'page', 'catalog');

$arUpdate['reference'] = array(GetMessage("parser_update_N"), GetMessage("parser_update_Y"), GetMessage("parser_update_empty"));
$arUpdate['reference_id'] = array('N', 'Y', 'empty');

$arAction['reference'] = array(GetMessage("parser_action_N"), GetMessage("parser_action_A"), GetMessage("parser_action_D"));
$arAction['reference_id'] = array('N', 'A', 'D');

//$arPriceTerms['reference'] = array(GetMessage("parser_price_terms_no"), GetMessage("parser_price_terms_up"), GetMessage("parser_price_terms_down"));
//$arPriceTerms['reference_id'] = array('', 'up', 'down');

$arPriceTerms['reference'] = array(GetMessage("parser_price_terms_no"), GetMessage("parser_price_terms_delta"));
$arPriceTerms['reference_id'] = array('', 'delta');  

$arPriceUpDown['reference'] = array(GetMessage("parser_price_updown_no"), GetMessage("parser_price_updown_up"), GetMessage("parser_price_updown_down"));
$arPriceUpDown['reference_id'] = array('', 'up', 'down');

$arPriceValue['reference'] = array(GetMessage("parser_price_percent"), GetMessage("parser_price_abs_value"));
$arPriceValue['reference_id'] = array('percent', 'value');






$hideCatalog = false;
if($isCatalog && CModule::IncludeModule('catalog') && CModule::IncludeModule('currency')/* && (($shs_IBLOCK_ID && CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y", "ID"=>$shs_IBLOCK_ID))->Fetch()) || !$shs_IBLOCK_ID)*/)
{   
    $dbPriceType = CCatalogGroup::GetList(
        array("SORT" => "ASC"),
        array()
    );
      
    while ($arPriceTypes = $dbPriceType->Fetch())
    {
        $arPriceType["reference"][] = $arPriceTypes["NAME_LANG"];
        $arPriceType["reference_id"][] = $arPriceTypes["ID"];
    }
    $arConvertCurrency["reference"][] = GetMessage("parser_convert_no");
    $arConvertCurrency["reference_id"][] = "";
    
    $arPriceOkrug["reference"] = array(GetMessage("parser_price_okrug_no"), GetMessage("parser_price_okrug_up"), GetMessage("parser_price_okrug_ceil"), GetMessage("parser_price_okrug_floor"));
    $arPriceOkrug["reference_id"] = array("", "up", "ceil", "floor");
    
    $lcur = CCurrency::GetList(($by="name"), ($order1="asc"), LANGUAGE_ID);
    while($lcur_res = $lcur->Fetch())
    {
        $arCurrency["reference"][] = $lcur_res["FULL_NAME"];
        $arCurrency["reference_id"][] = $lcur_res["CURRENCY"];
        $arConvertCurrency["reference"][] = $lcur_res["FULL_NAME"];
        $arConvertCurrency["reference_id"][] = $lcur_res["CURRENCY"];
    }
    $info = CModule::CreateModuleObject('catalog');
    
    if(!CheckVersion("14.0.0", $info->MODULE_VERSION))
    {   
        $dbResultList = CCatalogMeasure::getList(array(), array(), false, false, array("ID", "CODE", "MEASURE_TITLE", "SYMBOL_INTL", "IS_DEFAULT"));
        while($arMeasure = $dbResultList->Fetch())
        {
            $arAllMeasure["reference_id"][] = $arMeasure["ID"];
            $arAllMeasure["reference"][] = $arMeasure["MEASURE_TITLE"];
        }
    }
     
    $arVATRef = CatalogGetVATArray(array(), true);

}else $hideCatalog = true;

/*
if(isset($arrPropDop))
{
    $arrPropField['REFERENCE'] = array_merge($arrPropField['REFERENCE'], $arrPropDop["REFERENCE"]);
    $arrPropField['REFERENCE_ID'] = array_merge($arrPropField['REFERENCE_ID'], $arrPropDop["REFERENCE_ID"]);    
}*/

$arrActionProps['REFERENCE'] = array(GetMessage("parser_action_props_delete"), GetMessage("parser_action_props_add_begin"), GetMessage("parser_action_props_add_end"));
$arrActionProps['REFERENCE_ID'] = array("delete", "add_b", "add_e");
    

$disabled = false;
unset($arrDateActive['REFERENCE'][2]);
unset($arrDateActive['REFERENCE_ID'][2]);
$arrDate = ParseDateTime($shs_START_LAST_TIME_X, "YYYY.MM.DD HH:MI:SS");
if($shs_TYPE)$disabled  = 'disabled=""';
?>
    <tr>
        <td><?echo GetMessage("parser_type")?></td>
        <td><?=SelectBoxFromArray('TYPE', $arTypeParser, $shs_TYPE?$shs_TYPE:$_GET["type"], "", $disabled);?>
        <?if($disabled):?><input type="hidden" name="TYPE" value="<?=$shs_TYPE?>" /><?endif;?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_mode")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][mode]', $arMode, $shs_SETTINGS["catalog"]["mode"]?$shs_SETTINGS["catalog"]["mode"]:"debug", "", "");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_mode_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_act")?></td>
        <td width="60%"><input type="checkbox" name="ACTIVE" value="Y"<?if($shs_ACTIVE == "Y" || !$ID) echo " checked"?>>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_sort")?></td>
        <td><input type="text" name="SORT" value="<?echo !$ID?"100":$shs_SORT;?>" size="4"></td>
    </tr>
    <?if(isset($arCategory) && !empty($arCategory)):?>
    <tr>
        <td><?echo GetMessage("parser_category_title")?></td>
        <td><?=SelectBoxFromArray('CATEGORY_ID', $arCategory, isset($shs_CATEGORY_ID)?$shs_CATEGORY_ID:$parentID, GetMessage("parser_category_select"), "id='category' style='width:262px'");?></td>
    </tr>
    <?endif;?>
    <tr>
        <td><span class="required">*</span><?echo GetMessage("parser_name")?></td>
        <td><input type="text" name="NAME" value="<?echo $shs_NAME;?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><span class="required">*</span><?echo GetMessage("parser_rss_catalog")?></td>
        <td><input type="text" name="RSS" value="<?echo $shs_RSS;?>" size="80" maxlength="500"></td>
    </tr>
    <tr>
        <td style="vertical-align:top"><?echo GetMessage("parser_url_dop")?></td>
        <td>
            <textarea name="SETTINGS[catalog][url_dop]" cols="65" rows="5"><?=$shs_SETTINGS["catalog"]["url_dop"]?></textarea>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_url_dop_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><span class="required">*</span><?echo GetMessage("parser_iblock_id_catalog")?></td>
        <td><?=SelectBoxFromArray('IBLOCK_ID', $arIBlock, $shs_IBLOCK_ID, GetMessage("parser_iblock_id"), "id='iblock' style='width:262px' ");?>
            <?/*?><?if($disabled):?><input type="hidden" name="IBLOCK_ID" value="<?=$shs_IBLOCK_ID?>" /><?endif;*/?>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_iblock_id_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_section_id")?></td>
        <td><?=SelectBoxFromArray('SECTION_ID', $arSection, $shs_SECTION_ID, GetMessage("parser_section_id"), "id='section' style='width:262px'");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_encoding")?></td>
        <td><?=SelectBoxFromArray('ENCODING', $arEncoding, $shs_ENCODING);?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_encoding_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_step")?></td>
        <td><input type="text" name="SETTINGS[catalog][step]" value="<?echo $shs_SETTINGS["catalog"]["step"]?$shs_SETTINGS["catalog"]["step"]:30;?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_start_last_time")?></td>
        <td><input type="text" disabled name="START_LAST_TIME_X" value="<?echo $arrDate[DD].'.'.$arrDate[MM].'.'.$arrDate[YYYY].' '.$arrDate[HH].':'.$arrDate[MI].':'.$arrDate[SS];?>" size="20"></td>
    </tr>
<?
//********************
//Auto params
//********************
$tabControl->BeginNextTab();
?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_standart_pagenavigation")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_pagenavigation_selector")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][pagenavigation_selector]" value="<?echo $shs_SETTINGS["catalog"]["pagenavigation_selector"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_pagenavigation_selector_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_pagenavigation_one")?></td>
        <td><input type="text" name="SETTINGS[catalog][pagenavigation_one]" value="<?echo $shs_SETTINGS["catalog"]["pagenavigation_one"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_pagenavigation_one_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_pagenavigation_delete")?></td>
        <td><input type="text" name="SETTINGS[catalog][pagenavigation_delete]" value="<?echo $shs_SETTINGS["catalog"]["pagenavigation_delete"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_pagenavigation_begin")?></td>
        <td><input type="text" name="SETTINGS[catalog][pagenavigation_begin]" value="<?echo $shs_SETTINGS["catalog"]["pagenavigation_begin"];?>" size="5" maxlength="5"> <?echo GetMessage("parser_pagenavigation_end")?> <input type="text" name="SETTINGS[catalog][pagenavigation_end]" value="<?echo $shs_SETTINGS["catalog"]["pagenavigation_end"];?>" size="5" maxlength="5"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_pagenavigation_begin_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_work_pagenavigation")?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_work_pagenavigation_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_work_pagenavigation_var")?>:</td>
        <td><input type="text" name="SETTINGS[catalog][pagenavigation_var]" value="<?echo $shs_SETTINGS["catalog"]["pagenavigation_var"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_work_pagenavigation_var_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_work_pagenavigation_other_var")?>:</td>
        <td><input type="text" name="SETTINGS[catalog][pagenavigation_other_var]" value="<?echo $shs_SETTINGS["catalog"]["pagenavigation_other_var"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_work_pagenavigation_other_var_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_work_pagenavigation_page_count")?>:</td>
        <td><input type="text" name="SETTINGS[catalog][pagenavigation_page_count]" value="<?echo $shs_SETTINGS["catalog"]["pagenavigation_page_count"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_work_pagenavigation_page_count_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    
<?
//********************
//Attachments
//********************
$tabControl->BeginNextTab();
?>  <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_preview_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector]" value="<?echo $shs_SETTINGS["catalog"]["selector"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_catalog_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_href_catalog")?></td>
        <td><input type="text" name="SETTINGS[catalog][href]" value="<?echo $shs_SETTINGS["catalog"]["href"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_href_descr_catalog")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_name_catalog")?></td>
        <td><input type="text" name="SETTINGS[catalog][name]" value="<?echo $shs_SETTINGS["catalog"]["name"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_name_descr_page")?>
            <?=EndNote();?>
        </td>
    </tr>

    <tr>
        <td><?echo GetMessage("parser_preview_price")?></td>
        <td><input type="text" name="SETTINGS[catalog][preview_price]" value="<?echo $shs_SETTINGS["catalog"]["preview_price"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_price_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_preview_text_selector")?></td>
        <td><input type="text" name="SETTINGS[catalog][preview_text_selector]" value="<?echo $shs_SETTINGS["catalog"]["preview_text_selector"];?>" size="40" maxlength="250"></td>
    </tr>

    <tr>
        <td><?echo GetMessage("parser_preview_text_type_catalog")?></td>
        <td><?=SelectBoxFromArray('PREVIEW_TEXT_TYPE', $arType, $shs_PREVIEW_TEXT_TYPE, "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_preview_delete_tag_catalog")?></td>
        <td><input class="bool-delete" type="checkbox" name="BOOL_PREVIEW_DELETE_TAG" value="Y"<?if($shs_BOOL_PREVIEW_DELETE_TAG == "Y") echo " checked"?>> <?echo GetMessage("parser_bool_preview_delete_tag")?><input <?if($shs_BOOL_PREVIEW_DELETE_TAG != "Y"):?>disabled <?endif?> type="text" name="PREVIEW_DELETE_TAG" value="<?echo $shs_PREVIEW_DELETE_TAG;?>" size="40" maxlength="300"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_tag_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_delete_element")?></td>
        <td width="60%"><input size="40" maxlength="300" type="text" name="PREVIEW_DELETE_ELEMENT" value="<?=$shs_PREVIEW_DELETE_ELEMENT?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_element_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_delete_attribute")?></td>
        <td width="60%"><input size="40" maxlength="300" type="text" name="PREVIEW_DELETE_ATTRIBUTE" value="<?=$shs_PREVIEW_DELETE_ATTRIBUTE?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_attribute_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_first_img_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][preview_picture]" value="<?echo isset($shs_SETTINGS["catalog"]["preview_picture"])?$shs_SETTINGS["catalog"]["preview_picture"]:"img:eq(0)[src]";?>" size="40" maxlength="255" /></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_first_img_descr_catalog")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?/*<tr>
        <td width="40%"><?echo GetMessage("parser_preview_save_img")?></td>
        <td width="60%"><input type="checkbox" name="PREVIEW_SAVE_IMG" value="Y"<?if($shs_PREVIEW_SAVE_IMG == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_save_img_descr")?>
            <?=EndNote();?>
        </td>
    </tr>*/?>


<?
//********************
//Attachments
//********************
$tabControl->BeginNextTab();
?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_detail_catalog")?></td>
        <td width="60%"><input type="text" name="SELECTOR" value="<?echo $shs_SELECTOR;?>" size="40" maxlength="250"></td>
    </tr>

    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_detail_catalog_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_detail_name")?></td>
        <td><input type="text" name="SETTINGS[catalog][detail_name]" value="<?echo $shs_SETTINGS["catalog"]["detail_name"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_name_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_preview_price")?></td>
        <td><input type="text" name="SETTINGS[catalog][detail_price]" value="<?echo $shs_SETTINGS["catalog"]["detail_price"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_detail_text_selector")?></td>
        <td><input type="text" name="SETTINGS[catalog][detail_text_selector]" value="<?echo $shs_SETTINGS["catalog"]["detail_text_selector"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_detail_text_type_catalog")?></td>
        <td><?=SelectBoxFromArray('DETAIL_TEXT_TYPE', $arType, $shs_DETAIL_TEXT_TYPE, "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_detail_delete_tag")?></td>
        <td><input class="bool-delete" type="checkbox" name="BOOL_DETAIL_DELETE_TAG" value="Y"<?if($shs_BOOL_DETAIL_DELETE_TAG == "Y") echo " checked"?>> <?echo GetMessage("parser_bool_detail_delete_tag")?><input <?if($shs_BOOL_DETAIL_DELETE_TAG != "Y"):?>disabled <?endif?> type="text" name="DETAIL_DELETE_TAG" value="<?echo $shs_DETAIL_DELETE_TAG;?>" size="40" maxlength="300"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_tag_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_delete_element")?></td>
        <td width="60%"><input size="40" maxlength="300" type="text" name="DETAIL_DELETE_ELEMENT" value="<?=$shs_DETAIL_DELETE_ELEMENT?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_delete_element_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_delete_attribute")?></td>
        <td width="60%"><input size="40" maxlength="300" type="text" name="DETAIL_DELETE_ATTRIBUTE" value="<?=$shs_DETAIL_DELETE_ATTRIBUTE?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_delete_attribute_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_first_img_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][detail_picture]" value="<?echo isset($shs_SETTINGS["catalog"]["detail_picture"])?$shs_SETTINGS["catalog"]["detail_picture"]:"img:eq(0)[src]";?>" size="40" maxlength="255" /></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_first_img_descr_catalog")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?/*?><tr>
        <td width="40%"><?echo GetMessage("parser_detail_save_img")?></td>
        <td width="60%"><input type="checkbox" name="DETAIL_SAVE_IMG" value="Y"<?if($shs_DETAIL_SAVE_IMG == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_save_img_descr")?>
            <?=EndNote();?>
        </td>
    </tr><?*/?>

<?
$tabControl->BeginNextTab();
?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_more_image")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_more_image_prop")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][more_image_props]', $arrPropFile, $shs_SETTINGS["catalog"]["more_image_props"], GetMessage("parser_prop_id"), "class='image_props'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_selector_more_image")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][more_image]" value="<?echo $shs_SETTINGS["catalog"]["more_image"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_more_image_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading" id="header_selector_prop">
        <td colspan="2"><?echo GetMessage("parser_default_props")?></td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["default_prop"]) && !empty($shs_SETTINGS["catalog"]["default_prop"])):?>
    <?foreach($shs_SETTINGS["catalog"]["default_prop"] as $code=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%">
            <?if($arrPropDop['REFERENCE_TYPE'][$code]=="L"):
            ?>
            <?=SelectBoxFromArray('SETTINGS[catalog][default_prop]['.$code.']', $arrPropDop["LIST_VALUES"][$code], $shs_SETTINGS["catalog"]["default_prop"][$code], "", "");?>
            <?elseif($arrPropDop['USER_TYPE'][$code]=="directory"):?>
            <?=SelectBoxFromArray('SETTINGS[catalog][default_prop]['.$code.']', $arrPropDop["LIST_VALUES"][$code], $shs_SETTINGS["catalog"]["default_prop"][$code], "", "");?>
            <?else:?>
            <input type="text" <?if(!$shs_SETTINGS["catalog"]["default_prop"][$code]):?>placeholder="<?=GetMessage("parser_prop_default")?>"<?endif;?> name="SETTINGS[catalog][default_prop][<?=$code?>]" value="<?=$shs_SETTINGS["catalog"]["default_prop"][$code]?>" />
            <?endif?>
        </td>
    </tr>
    <?endforeach;?>
    <?endif;
    $arrPropDopDefault = $arrPropDop;
    unset($arrPropDopDefault['REFERENCE'][0]);
    unset($arrPropDopDefault['REFERENCE_ID'][0]);
    
    ?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDefault', $arrPropDopDefault, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadPropDefault" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr class="heading" id="header_selector_prop">
        <td colspan="2"><?echo GetMessage("parser_selector_props")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_props_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["selector_prop"]) && !empty($shs_SETTINGS["catalog"]["selector_prop"])):?>
    <?foreach($shs_SETTINGS["catalog"]["selector_prop"] as $code=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%">
            <input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[catalog][selector_prop][<?=$code?>]" value="<?=$shs_SETTINGS["catalog"]["selector_prop"][$code]?>">
        </td>
    </tr>
    <?endforeach?>
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDop', $arrPropDop, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadDopProp" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr style="display:none">
        <td colspan="2"><input type="hidden" id="delete_selector_prop" name="SETTINGS[catalog][delete_selector_prop]" value="<?=$shs_SETTINGS["catalog"]["delete_selector_prop"]?>" /></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_prop_detail_preview_descr")?><?echo GetMessage("parser_prop_detail_preview_descr_file")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading" id="header_find_prop">
        <td colspan="2"><?echo GetMessage("parser_find_props")?></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_find_props")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_find_props]" value="<?echo $shs_SETTINGS["catalog"]["selector_find_props"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_find_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_find_props_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_find_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["find_prop"]) && !empty($shs_SETTINGS["catalog"]["find_prop"])):?>
    <?foreach($shs_SETTINGS["catalog"]["find_prop"] as $code=>$val):
    $val = trim($val);
    if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%"><input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[catalog][find_prop][<?=$code?>]" value="<?=$shs_SETTINGS["catalog"]["find_prop"][$code]?>">&nbsp;<a class="find_delete" href="#">Delete</a></td>
    </tr>
    <?endforeach;?>    
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDop1', $arrPropDop, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadDopProp1" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    
    <tr style="display:none">
        <td colspan="2"><input type="hidden" id="delete_find_prop" name="SETTINGS[catalog][delete_find_prop]" value="<?=$shs_SETTINGS["catalog"]["delete_find_prop"]?>" /></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_prop_detail_preview_descr")?><?echo GetMessage("parser_prop_detail_preview_descr_file")?>
            <?=EndNote();?>
        </td>
    </tr>
    
    <tr class="heading" id="header_selector_prop">
        <td colspan="2"><?echo GetMessage("parser_selector_props_preview")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_props_symb_preview]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_props_symb_preview"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["selector_prop_preview"]) && !empty($shs_SETTINGS["catalog"]["selector_prop_preview"])):?>
    <?foreach($shs_SETTINGS["catalog"]["selector_prop_preview"] as $code=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%">
            <input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[catalog][selector_prop_preview][<?=$code?>]" value="<?=$shs_SETTINGS["catalog"]["selector_prop_preview"][$code]?>">
            <a class="prop_delete" href="#">Delete</a>
        </td>
    </tr>
    <?endforeach?>
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDop', $arrPropDop, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadDopProp2" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_prop_detail_preview_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading" id="header_find_prop">
        <td colspan="2"><?echo GetMessage("parser_find_props_preview")?></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_find_props")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_find_props_preview]" value="<?echo $shs_SETTINGS["catalog"]["selector_find_props_preview"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_find_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_find_props_symb_preview]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_find_props_symb_preview"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["find_prop_preview"]) && !empty($shs_SETTINGS["catalog"]["find_prop_preview"])):?>
    <?foreach($shs_SETTINGS["catalog"]["find_prop_preview"] as $code=>$val):
    $val = trim($val);
    if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%"><input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[catalog][find_prop_preview][<?=$code?>]" value="<?=$shs_SETTINGS["catalog"]["find_prop_preview"][$code]?>">&nbsp;<a class="find_delete" href="#">Delete</a></td>
    </tr>
    <?endforeach;?>    
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDop1', $arrPropDop, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadDopProp3" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_prop_detail_preview_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading" id="header_find_prop">
        <td colspan="2"><?echo GetMessage("parser_add_delete_symb_props")?></td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["action_props_val"]) && !empty($shs_SETTINGS["catalog"]["action_props_val"])):?>
    <?foreach($shs_SETTINGS["catalog"]["action_props_val"] as $code=>$arVal):
        foreach($arVal as $i=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=($code=="SOTBIT_PARSER_NAME_E")?GetMessage("parser_SOTBIT_PARSER_NAME_E"):$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;<?if($code=="SOTBIT_PARSER_NAME_E"):?><?else:?>[<?=$code?>]<?endif;?>:</td>
        <td width="60%"><input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[catalog][action_props_val][<?=$code?>][]" value="<?=$val?>">&nbsp; <?=SelectBoxFromArray('SETTINGS[catalog][action_props]['.$code.']['.$i.']', $arrActionProps, $shs_SETTINGS["catalog"]["action_props"][$code][$i], GetMessage("shs_parser_select_action_props"), "");?> <a class="find_delete" href="#">Delete</a></td>
    </tr>
        <?endforeach;?>
    <?endforeach;?>
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropField', $arrPropField, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadPropField" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr class="tr_find_prop">
    <?
    ?>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("shs_parser_action_props_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    

<?

if(!$hideCatalog):
$tabControl->BeginNextTab();
?>
    <?if($isOfferCatalog):?>
    <tr>
        <td><?echo GetMessage("parser_cat_price_offer")?></td>
        <td><input class="bool-delete" type="checkbox" name="SETTINGS[catalog][cat_vat_price_offer]" value="Y"<?if($shs_SETTINGS["catalog"]["cat_vat_price_offer"] == "Y") echo " checked"?> /></td>
    </tr>
    <?endif;?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_price_type")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][price_type]', $arPriceType, $shs_SETTINGS["catalog"]["price_type"]?$shs_SETTINGS["catalog"]["price_type"]:1, "", "");?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_cat_vat_id")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][cat_vat_id]', $arVATRef, $shs_SETTINGS["catalog"]["cat_vat_id"], "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_cat_vat_included")?></td>
        <td><input class="bool-delete" type="checkbox" name="SETTINGS[catalog][cat_vat_included]" value="Y"<?if($shs_SETTINGS["catalog"]["cat_vat_included"] == "Y") echo " checked"?> /></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_currency")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][currency]', $arCurrency, $shs_SETTINGS["catalog"]["currency"]?$shs_SETTINGS["catalog"]["currency"]:"RUB", "", "");?></td>
    </tr>
    <?if(isset($arAllMeasure)):?>
    <tr>
        <td><?echo GetMessage("parser_measure")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][measure]', $arAllMeasure, $shs_SETTINGS["catalog"]["measure"]?$shs_SETTINGS["catalog"]["measure"]:5, "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_catalog_koef")?></td>
        <td><input type="text" name="SETTINGS[catalog][koef]" value="<?echo $shs_SETTINGS["catalog"]["koef"]?$shs_SETTINGS["catalog"]["koef"]:1;?>" size="40" maxlength="250"></td>
    </tr>
    
    <?endif;?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_work_price")?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_convert_currency")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][convert_currency]', $arConvertCurrency, $shs_SETTINGS["catalog"]["convert_currency"], "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_price_okrug")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_okrug]', $arPriceOkrug, $shs_SETTINGS["catalog"]["price_okrug"], "", "style=\"width:115px\"");?> <?echo GetMessage("parser_price_okrug_delta1")?> <input type="text" name="SETTINGS[catalog][price_okrug_delta]" value="<?echo $shs_SETTINGS["catalog"]["price_okrug_delta"]?>" size="1" maxlength="1"> <?echo GetMessage("parser_price_okrug_delta2")?> </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_price_okrug_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_price_format")?></td>
        <td><?echo GetMessage("parser_price_format1")?><input type="text" name="SETTINGS[catalog][price_format1]" value="<?echo $shs_SETTINGS["catalog"]["price_format1"]?>" size="1" maxlength="250"><?echo GetMessage("parser_price_format2")?><input type="text" name="SETTINGS[catalog][price_format2]" value="<?echo $shs_SETTINGS["catalog"]["price_format2"]?>" size="1" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_price_format_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    $count = count($shs_SETTINGS["catalog"]["price_updown"])-1;
    if(is_set($shs_SETTINGS["catalog"]["price_updown"]) && is_array($shs_SETTINGS["catalog"]["price_updown"]) && count($shs_SETTINGS["catalog"]["price_updown"])>0){
    foreach($shs_SETTINGS["catalog"]["price_updown"] as $i=>$val):
    if($count==$i) $class="tr_add";
    else $class = "";
    ?>
    <tr class="heading <?=$class?>" data-num="<?=($i+1)?>">
        <td colspan="2"><?echo GetMessage("parser_work_price_num")?> <span><?=($i+1)?></span> <?if($count==$i):?><a href="#" style="font-size:12px;" class="add_usl"><?echo GetMessage("parser_price_num_add")?></a><?endif;?>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" style="font-size:12px;<?if($i==0):?>display:none<?endif;?>" class="del_usl"><?echo GetMessage("parser_price_num_del")?></a></td>
    </tr>
    <tr class="<?=$class?>">
        <td><?echo GetMessage("parser_price_updown")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_updown][]', $arPriceUpDown, $shs_SETTINGS["catalog"]["price_updown"][$i], "", "");?></td>
    </tr>
    <tr class="<?=$class?>">
        <td><?echo GetMessage("parser_price_terms")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_terms][]', $arPriceTerms, $shs_SETTINGS["catalog"]["price_terms"][$i], "", "");?> <?echo GetMessage("parser_price_from")?> <input type="text" name="SETTINGS[catalog][price_terms_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value"][$i];?>" size="10" maxlength="250"> <?echo GetMessage("parser_price_to")?> <input type="text" name="SETTINGS[catalog][price_terms_value_to][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value_to"][$i];?>" size="10" maxlength="250"></td>
    </tr>
    <tr class="<?=$class?>">
        <td><?echo GetMessage("parser_price_type_value")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_type_value][]', $arPriceValue, $shs_SETTINGS["catalog"]["price_type_value"][$i], "", "");?></td>
    </tr>
    <tr class="<?=$class?> <?if($class):?>tr_last<?endif;?>">
        <td><?echo GetMessage("parser_price_value")?></td>
        <td><input type="text" name="SETTINGS[catalog][price_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_value"][$i];?>" size="10" maxlength="250"></td>
    </tr>
    <?endforeach;
    }else{
    ?>
    <tr class="heading tr_add" data-num="1">
        <td colspan="2"><?echo GetMessage("parser_work_price_num")?> <span></span> <a href="#" style="font-size:12px;" class="add_usl"><?echo GetMessage("parser_price_num_add")?></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" style="font-size:12px;display:none" class="del_usl"><?echo GetMessage("parser_price_num_del")?></a></td>
    </tr>
    <tr class="tr_add">
        <td><?echo GetMessage("parser_price_updown")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_updown][]', $arPriceUpDown, $shs_SETTINGS["catalog"]["price_updown"], "", "");?></td>
    </tr>
    <tr class="tr_add">
        <td><?echo GetMessage("parser_price_terms")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_terms][]', $arPriceTerms, $shs_SETTINGS["catalog"]["price_terms"], "", "");?> <?echo GetMessage("parser_price_from")?> <input type="text" name="SETTINGS[catalog][price_terms_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value"];?>" size="10" maxlength="250"> <?echo GetMessage("parser_price_to")?> <input type="text" name="SETTINGS[catalog][price_terms_value_to][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value_to"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr class="tr_add">
        <td><?echo GetMessage("parser_price_type_value")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_type_value][]', $arPriceValue, $shs_SETTINGS["catalog"]["price_type_value"], "", "");?></td>
    </tr>
    <tr class="tr_add tr_last">
        <td><?echo GetMessage("parser_price_value")?></td>
        <td><input type="text" name="SETTINGS[catalog][price_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_value"];?>" size="10" maxlength="250"></td>
    </tr>
    
    <?}?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_size_selector")?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_length")?></td>
        <td><input type="text" name="SETTINGS[catalog][selector_product][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["LENGTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["LENGTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_width")?></td>
        <td><input type="text" name="SETTINGS[catalog][selector_product][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["WIDTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["WIDTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_height")?></td>
        <td><input type="text" name="SETTINGS[catalog][selector_product][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["HEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["HEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_size_weight")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_product][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["WEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["WEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_size_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_size_find")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_find")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_find_size]" value="<?echo $shs_SETTINGS["catalog"]["selector_find_size"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_length")?></td>
        <td><input type="text" name="SETTINGS[catalog][find_product][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["LENGTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["LENGTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_width")?></td>
        <td><input type="text" name="SETTINGS[catalog][find_product][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["WIDTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["WIDTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_height")?></td>
        <td><input type="text" name="SETTINGS[catalog][find_product][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["HEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["HEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_size_weight")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][find_product][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["WEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["WEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_find_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_find_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_find_size_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
<?
endif;

if(!$hideCatalog):
$tabControl->BeginNextTab();
?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_load")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[offer][load]', $arOfferLoad, $shs_SETTINGS["offer"]["load"]?$shs_SETTINGS["offer"]["load"]:1, "", "");?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_load_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["offer"]["load"]) && $shs_SETTINGS["offer"]["load"]=="one"):?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_one_selector")?>:</td>
        <td width="60%"><input type="text" name="SETTINGS[offer][one][selector]" value="<?echo $shs_SETTINGS["offer"]['one']["selector"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_one_selector_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_one_price_attr")?>:</td>
        <td width="60%"><input type="text" name="SETTINGS[offer][one][price]" value="<?echo $shs_SETTINGS["offer"]['one']["price"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_one_price_attr_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_add_name")?></td>
        <td width="60%">
        <?if(isset($arrPropDopOfferName)):?>
            <select name="SETTINGS[offer][add_name][]" class="add_name">
                <?foreach($arrPropDopOfferName["REFERENCE"] as $r=>$ref):?>
                <option <?if(in_array($arrPropDopOfferName["REFERENCE_ID"][$r], $shs_SETTINGS["offer"]["add_name"])):?>selected=""<?endif;?> value="<?=$arrPropDopOfferName["REFERENCE_ID"][$r]?>"><?=$ref?></option>
                <?endforeach?>
            </select>
        <?endif;?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_add_name_one_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][catalog_delete_selector_props_symb]" value="<?echo $shs_SETTINGS["offer"]["catalog_delete_selector_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_descr_offer")?>
            <?=EndNote();?>
        </td>
    </tr> 
    <?endif;?>
    <?if(isset($shs_SETTINGS["offer"]["load"]) && $shs_SETTINGS["offer"]["load"]=="table"):?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_add_name")?></td>
        <td width="60%">
        <?if(isset($arrPropDopOfferName)):?>
            <select name="SETTINGS[offer][add_name][]" multiple="" class="add_name">
                <?foreach($arrPropDopOfferName["REFERENCE"] as $r=>$ref):?>
                <option <?if(in_array($arrPropDopOfferName["REFERENCE_ID"][$r], $shs_SETTINGS["offer"]["add_name"])):?>selected=""<?endif;?> value="<?=$arrPropDopOfferName["REFERENCE_ID"][$r]?>"><?=$ref?></option>
                <?endforeach?>
            </select>
        <?endif;?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_add_name_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_offer_table_desc")?></td>
    </tr><?/*?>
    <tr class="heading">
        <td colspan="2">
        <?/*=BeginNote();?>
        <table>
            <thead>
                <tr>
                    <th>
                        <?echo GetMessage("parser_offer_table_desc_1")?>
                    </th>
                    <th><?echo GetMessage("parser_offer_table_desc_2")?></th>
                    <th><?echo GetMessage("parser_offer_table_desc_3")?></th>
                    <th><?echo GetMessage("parser_offer_table_desc_4")?></th>
                    <th><?echo GetMessage("parser_offer_table_desc_5")?></th>
                    <th><?echo GetMessage("parser_offer_table_desc_6")?></th>
                    <th><?echo GetMessage("parser_offer_table_desc_7")?></th>
                    <th></th>
                    <th>
                            <?echo GetMessage("parser_offer_table_desc_8")?>
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr class="item_row">
                    <td>976886</td>
                    <td><?echo GetMessage("parser_offer_table_desc_9")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_12")?></td>
                    <td>416</td>
                    <td>8(RUS-GB-F-E-ARAB-D-H-PL)</td>
                    <td><?echo GetMessage("parser_offer_table_desc_10")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_11")?></td>
                    <td></td>
                    <td>100</td>
                </tr>
                <tr class="item_row">
                    <td>976886</td>
                    <td><?echo GetMessage("parser_offer_table_desc_9")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_12")?></td>
                    <td>416</td>
                    <td>8(RUS-GB-F-E-ARAB-D-H-PL)</td>
                    <td><?echo GetMessage("parser_offer_table_desc_10")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_11")?></td>
                    <td></td>
                    <td>100</td>
                </tr>
                <tr class="item_row">
                    <td>976886</td>
                    <td><?echo GetMessage("parser_offer_table_desc_9")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_12")?></td>
                    <td>416</td>
                    <td>8(RUS-GB-F-E-ARAB-D-H-PL)</td>
                    <td><?echo GetMessage("parser_offer_table_desc_10")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_11")?></td>
                    <td></td>
                    <td>100</td>
                </tr>
                </tbody>
            </table>
            <?=EndNote();*/?>
        <?/*?></td>
    </tr><?*/?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_selector")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][selector]" value="<?echo $shs_SETTINGS["offer"]["selector"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_selector_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_selector_head")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][selector_head]" value="<?echo $shs_SETTINGS["offer"]["selector_head"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_selector_head_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_selector_head_th")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][selector_head_th]" value="<?echo $shs_SETTINGS["offer"]["selector_head_th"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_selector_head_th_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_selector_item")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][selector_item]" value="<?echo $shs_SETTINGS["offer"]["selector_item"];?>" size="40" maxlength="250"></td>
    </tr>
    
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_selector_item_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_selector_item_td")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][selector_item_td]" value="<?echo $shs_SETTINGS["offer"]["selector_item_td"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_selector_item_td_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_offer_parsing_selector")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][catalog_delete_selector_props_symb]" value="<?echo $shs_SETTINGS["offer"]["catalog_delete_selector_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_descr_offer")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_parsing_selector_name")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][selector_name]" value="<?echo $shs_SETTINGS["offer"]["selector_name"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_parsing_selector_name_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_parsing_selector_price")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][selector_price]" value="<?echo $shs_SETTINGS["offer"]["selector_price"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_parsing_selector_price_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["offer"]["selector_prop"]) && !empty($shs_SETTINGS["offer"]["selector_prop"])):?>
    <?foreach($shs_SETTINGS["offer"]["selector_prop"] as $code=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDopOffer['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%">
            <input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[offer][selector_prop][<?=$code?>]" value="<?=$shs_SETTINGS["offer"]["selector_prop"][$code]?>">
            <a class="prop_delete" href="#">Delete</a>
        </td>
    </tr>
    <?endforeach?>
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDopOffer', $arrPropDopOffer, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadDopPropOffer" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_offer_parsing_find")?></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][catalog_delete_selector_find_props_symb]" value="<?echo $shs_SETTINGS["offer"]["catalog_delete_selector_find_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_descr_offer")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_parsing_selector_name")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][find_name]" value="<?echo $shs_SETTINGS["offer"]["find_name"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_parsing_selector_name_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_parsing_selector_price")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][find_price]" value="<?echo $shs_SETTINGS["offer"]["find_price"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_parsing_selector_price_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["offer"]["find_prop"]) && !empty($shs_SETTINGS["offer"]["find_prop"])):?>
    <?foreach($shs_SETTINGS["offer"]["find_prop"] as $code=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDopOffer['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%">
            <input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[offer][find_prop][<?=$code?>]" value="<?=$shs_SETTINGS["offer"]["find_prop"][$code]?>">
            <a class="prop_delete" href="#">Delete</a>
        </td>
    </tr>
    <?endforeach?>
    <?endif;?>
    
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDopOffer', $arrPropDopOffer, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadDopPropOffer1" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <?endif;?>
    
<?

endif;

$tabControl->BeginNextTab();
?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_active_element")?></td>
        <td width="60%"><input type="checkbox" name="ACTIVE_ELEMENT" value="Y"<?if($shs_ACTIVE_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_code_element")?></td>
        <td width="60%"><input type="checkbox" name="CODE_ELEMENT" value="Y"<?if($shs_CODE_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_index_element")?></td>
        <td width="60%"><input type="checkbox" name="INDEX_ELEMENT" value="Y"<?if($shs_INDEX_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_resize_image")?></td>
        <td width="60%"><input type="checkbox" name="RESIZE_IMAGE" value="Y"<?if($shs_RESIZE_IMAGE == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_from_detail")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][img_preview_from_detail]" value="Y"<?if($shs_SETTINGS["catalog"]["img_preview_from_detail"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_from_detail_text")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][text_preview_from_detail]" value="Y"<?if($shs_SETTINGS["catalog"]["text_preview_from_detail"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_404_error")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][404]" value="Y"<?if($shs_SETTINGS["catalog"]["404"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_404_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_date_active")?></td>
        <td width="60%"><input type="checkbox" name="DATE_ACTIVE" value="Y"<?if($shs_DATE_ACTIVE && $shs_DATE_ACTIVE != "N") echo " checked"?>> <?=SelectBoxFromArray('DATE_PROP_ACTIVE', $arrDateActive, $shs_DATE_ACTIVE, GetMessage("parser_date_type"), "id='prop-active' style='width:262px'");?></td>
    </tr>
    <?/*?><tr>
        <td width="40%"><?echo GetMessage("parser_date_public")?></td>
        <td width="60%"><input type="checkbox" name="DATE_PUBLIC" value="Y"<?if($shs_DATE_PUBLIC && $shs_DATE_PUBLIC != "N") echo " checked"?>> <?=SelectBoxFromArray('DATE_PROP_PUBLIC', $arrProp, $shs_DATE_PUBLIC, GetMessage("parser_prop_id"), "id='prop-date' style='width:262px' class='prop-iblock'");?></td>
    </tr><?*/?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_first_title")?></td>
        <td width="60%"><input type="checkbox" name="FIRST_TITLE" value="Y"<?if($shs_FIRST_TITLE && $shs_FIRST_TITLE != "N") echo " checked"?>> <?=SelectBoxFromArray('FIRST_PROP_TITLE', $arrProp, $shs_FIRST_TITLE, GetMessage("parser_prop_id"), "id='prop-first' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_meta_title")?></td>
        <td width="60%"><input type="checkbox" name="META_TITLE" value="Y"<?if($shs_META_TITLE && $shs_META_TITLE != "N") echo " checked"?>> <?=SelectBoxFromArray('META_PROP_TITLE', $arrProp, $shs_META_TITLE, GetMessage("parser_prop_id"), "id='prop-title' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_meta_description")?></td>
        <td width="60%"><input type="checkbox" name="META_DESCRIPTION" value="Y"<?if($shs_META_DESCRIPTION && $shs_META_DESCRIPTION != "N") echo " checked"?>> <?=SelectBoxFromArray('META_PROP_DESCRIPTION', $arrProp, $shs_META_DESCRIPTION, GetMessage("parser_prop_id"), "id='prop-key' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_meta_keywords")?></td>
        <td width="60%"><input type="checkbox" name="META_KEYWORDS" value="Y"<?if($shs_META_KEYWORDS && $shs_META_KEYWORDS != "N") echo " checked"?>> <?=SelectBoxFromArray('META_PROP_KEYWORDS', $arrProp, $shs_META_KEYWORDS, GetMessage("parser_prop_id"), "id='prop-meta' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_start_agent")?></td>
        <td width="60%"><input type="checkbox" name="START_AGENT" value="Y"<?if($shs_START_AGENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_start_agent_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_time_agent")?></td>
        <td width="60%"><input type="text" size="40" name="TIME_AGENT" value="<?=$shs_TIME_AGENT?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_sleep")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][sleep]" value="<?=$shs_SETTINGS["catalog"]["sleep"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_sleep_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_proxy")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][proxy]" value="<?=$shs_SETTINGS["catalog"]["proxy"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_proxy_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    $tabControl->BeginNextTab();
    ?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_uniq_update")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][active]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["active"] == "Y") echo " checked"?>></td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_header_uniq")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_uniq_name")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][uniq][name]" value="Y"<?if($shs_SETTINGS["catalog"]["uniq"]["name"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_uniq_prop")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][uniq][prop]', $arrProp, $shs_SETTINGS["catalog"]["uniq"]["prop"], GetMessage("parser_prop_id"), "id='style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_uniq_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_header_uniq_field")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_price")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][price]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["price"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_param")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][param]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["param"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_preview_descr")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][preview_descr]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["preview_descr"], "", "");?>
            <?/*?><input type="checkbox" name="SETTINGS[catalog][update][preview_descr]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["preview_descr"] == "Y") echo " checked"?>><?*/?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_detail_descr")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][detail_descr]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["detail_descr"], "", "");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_preview_img")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][preview_img]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["preview_img"], "", "");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_detail_img")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][detail_img]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["detail_img"], "", "");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_more_img")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][more_img]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["more_img"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_props")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][props]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["props"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_header_uniq_field_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_header_element_action")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_element_action")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][uniq][action]', $arAction, $shs_SETTINGS["catalog"]["uniq"]["action"], "", "");?>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_element_action_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    $tabControl->BeginNextTab();
    ?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_active")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][auth][active]" value="Y"<?if($shs_SETTINGS["catalog"]["auth"]["active"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_url")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][url]" value="<?=$shs_SETTINGS["catalog"]["auth"]["url"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_auth_url_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_selector")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][selector]" value="<?=$shs_SETTINGS["catalog"]["auth"]["selector"]?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_login")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][login]" value="<?=$shs_SETTINGS["catalog"]["auth"]["login"]?>"> <?echo GetMessage("parser_auth_login_name")?> <input type="text" size="20" name="SETTINGS[catalog][auth][login_name]" value="<?=$shs_SETTINGS["catalog"]["auth"]["login_name"]?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_password")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][password]" value="<?=$shs_SETTINGS["catalog"]["auth"]["password"]?>"> <?echo GetMessage("parser_auth_password_name")?> <input type="text" size="20" name="SETTINGS[catalog][auth][password_name]" value="<?=$shs_SETTINGS["catalog"]["auth"]["password_name"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_auth_password_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"></td>
        <td width="60%"><input type="button" size="40" id="auth" name="auth" data-href="<?=$APPLICATION->GetCurPageParam("auth=1", array("auth")); ?>" value="<?echo GetMessage('parser_auth_check')?>"></td>
    </tr>
    <?
    $tabControl->BeginNextTab();
    ?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_logs")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][log]" value="Y"<?if($shs_SETTINGS["catalog"]["log"] == "Y") echo " checked"?>></td>
    </tr>
    <?
    $file_log = $_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$_GET["ID"].".txt";
    if(isset($_GET["ID"]) && file_exists($file_log)):?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_logs_download")?></td>
        <td width="60%"><a href="<?=$APPLICATION->GetCurPageParam("log_ID=".$_GET["ID"], array("log_ID"));?>">catalog_log_<?=$_GET["ID"]?>.txt  (<?=ceil(filesize($file_log)/1024)?> KB)</a></td>
    </tr>
    <?endif?>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_header_log_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    $tabControl->BeginNextTab();
    ?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_type_head")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_type")?>:</td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[loc][type]', $arLocType, $shs_SETTINGS["loc"]["type"], "", "class='select_load'");?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["loc"]["type"]) && $shs_SETTINGS["loc"]["type"]=="yandex"):?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_yandex_key")?>:</td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[loc][yandex][key]" value="<?=$shs_SETTINGS["loc"]["yandex"]["key"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_yandex_key_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_yandex_lang")?>:</td>
        <td width="60%"><input type="text" size="20" name="SETTINGS[loc][yandex][lang]" value="<?=$shs_SETTINGS["loc"]["yandex"]["lang"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_yandex_lang_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_fields")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_name")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_name]" value="Y"<?if($shs_SETTINGS["loc"]["f_name"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_preview_text")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_preview_text]" value="Y"<?if($shs_SETTINGS["loc"]["f_preview_text"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_detail_text")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_detail_text]" value="Y"<?if($shs_SETTINGS["loc"]["f_detail_text"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_props")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_props]" value="Y"<?if($shs_SETTINGS["loc"]["f_props"] == "Y") echo " checked"?>></td>
    </tr>
    <?endif;?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_uniq")?></td>
    </tr>
    <?
    $engine = new Engine\Yandex();
    $arSettings = $engine->getSettings();
    $arDomains = \CSeoUtils::getDomainsList();
    
    foreach($arDomains as $key => $domain)
    {
        if(!isset($arSettings['SITES'][$domain['DOMAIN']]))
        {
            unset($arDomains[$key]);
        }
    }

    if(count($arDomains) <= 0)
    {
        $msg = new CAdminMessage(array(
            'MESSAGE' => Loc::getMessage('SHS_PARSER_SEO_YANDEX_ERROR'),
            'HTML' => 'Y'
        ));
    }else{
        $arrDomain['REFERENCE'][] =  Loc::getMessage('shs_parser_loc_uniq_no');
        $arrDomain['REFERENCE_ID'][] = "";
        foreach($arDomains as $domain)
        {   //printr($domain);
            $domainEnc = Converter::getHtmlConverter()->encode($domain['DOMAIN']);
            $arrDomain['REFERENCE'][] =  $domainEnc;
            $arrDomain['REFERENCE_ID'][] = $domainEnc;
        }
    }
    ?>
    <?if(count($arDomains) <= 0):?>
    <tr>
        <td colspan="2" align="center"><?echo $msg->Show();?></td>
    </tr>
    <?else:?>
    <tr>
        <td><?echo GetMessage("parser_loc_uniq_domain")?>:</td>
        <td><?=SelectBoxFromArray('SETTINGS[loc][uniq][domain]', $arrDomain, $shs_SETTINGS["loc"]["uniq"]["domain"], "", "");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_uniq_domain_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?endif?>
    
    <?
    $tabControl->BeginNextTab();
    ?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_video_catalog_descr")?></td>
    </tr>
    <tr>
        <td align="center" colspan="2" width="100%"><iframe width="800" height="500" src="//www.youtube.com/embed/vIMmjeo-xSg?list=PL2fR59TvIPXfB_XDmyp7pCnYoqQ-HhPXl" frameborder="0" allowfullscreen></iframe></td>
    </tr>
<?
if(isset($_GET["log_ID"]) && isset($_GET["ID"])):
    if (ob_get_level()) {
      ob_end_clean();
    }
    $file = $file_log;
    header('Content-Description: File Transfer');
    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename=' . basename($file));
    header('Content-Transfer-Encoding: binary');
    header('Expires: 0');
    header('Cache-Control: must-revalidate');
    header('Pragma: public');
    header('Content-Length: ' . filesize($file));
    readfile($file);
    exit();
endif;
$tabControl->Buttons(
    array(
        "disabled"=>($POST_RIGHT<"W"),
        "back_url"=>"list_parser_admin.php?lang=".LANG,

    )
);
?>
<?echo bitrix_sessid_post();?>
<input type="hidden" name="lang" value="<?=LANG?>">
<?if($ID>0 && !$bCopy):?>
    <input type="hidden" name="ID" value="<?=$ID?>">
<?endif;?>
<input type="hidden" name="parent" value="<?=$parentID?>">
<?
$tabControl->End();
?>

<?
$tabControl->ShowWarnings("post_form", $message);
?>52   19436|/shs.parser/admin/parser_edit_rss.php|46431550<?
use Bitrix\Seo\Engine;
use Bitrix\Main\Text\Converter;
use Bitrix\Main\Localization\Loc;
use Bitrix\Main\IO\Path;

\Bitrix\Main\Loader::includeModule('seo');
\Bitrix\Main\Loader::includeModule('socialservices');
$tabControl->BeginNextTab();
$arEncoding['reference'] = array('utf-8', 'windows-1251');
$arEncoding['reference_id'] = array('utf-8', 'windows-1251');
$arType['reference'] = array('html', 'text');
$arType['reference_id'] = array('html', 'text');

$arTypeParser['reference'] = array('rss', 'page', 'catalog');
$arTypeParser['reference_id'] = array('rss', 'page', 'catalog');

$arrDate = ParseDateTime($shs_START_LAST_TIME_X, "YYYY.MM.DD HH:MI:SS");

$disabled = false;

$arrUniq["reference"] = array(GetMessage("parser_page_uniq_name"), GetMessage("parser_page_uniq_url"));
$arrUniq["reference_id"] = array("name", "url");

if($shs_TYPE) $disabled = 'disabled=""';
?>
    <tr>
		<td><?echo GetMessage("parser_type")?></td>
		<td><?=SelectBoxFromArray('TYPE', $arTypeParser, $shs_TYPE?$shs_TYPE:$_GET["type"], "", $disabled);?>
        <?if($disabled):?><input type="hidden" name="TYPE" value="<?=$shs_TYPE?>" /><?endif;?>
        </td>
	</tr>
	<tr>
		<td width="40%"><?echo GetMessage("parser_act")?></td>
		<td width="60%"><input type="checkbox" name="ACTIVE" value="Y"<?if($shs_ACTIVE == "Y" || !$ID) echo " checked"?>>
        </td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_sort")?></td>
		<td><input type="text" name="SORT" value="<?echo !$ID?"100":$shs_SORT;?>" size="4"></td>
	</tr>
    <?if(isset($arCategory) && !empty($arCategory)):?>
    <tr>
        <td><?echo GetMessage("parser_category_title")?></td>
        <td><?=SelectBoxFromArray('CATEGORY_ID', $arCategory, isset($shs_CATEGORY_ID)?$shs_CATEGORY_ID:$parentID, GetMessage("parser_category_select"), "id='category' style='width:262px'");?></td>
    </tr>
    <?endif;?>
	<tr>
		<td><span class="required">*</span><?echo GetMessage("parser_name")?></td>
		<td><input type="text" name="NAME" value="<?echo $shs_NAME;?>" size="40" maxlength="250"></td>
	</tr>
    <tr>
		<td><span class="required">*</span><?echo GetMessage("parser_rss")?></td>
		<td><input type="text" name="RSS" value="<?echo $shs_RSS;?>" size="40" maxlength="250"></td>
	</tr>
	<tr>
		<td><span class="required">*</span><?echo GetMessage("parser_iblock_id")?></td>
		<td><?=SelectBoxFromArray('IBLOCK_ID', $arIBlock, $shs_IBLOCK_ID, GetMessage("parser_iblock_id"), "id='iblock' style='width:262px'");?></td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_section_id")?></td>
		<td><?=SelectBoxFromArray('SECTION_ID', $arSection, $shs_SECTION_ID, GetMessage("parser_section_id"), "id='section' style='width:262px'");?></td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_selector")?></td>
		<td><input type="text" name="SELECTOR" value="<?echo $shs_SELECTOR;?>" size="40" maxlength="250"></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
		<td><?echo GetMessage("parser_first_url")?></td>
		<td><input type="text" name="FIRST_URL" value="<?echo $shs_FIRST_URL;?>" size="40" maxlength="250"></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_first_url_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
		<td><?echo GetMessage("parser_encoding")?></td>
		<td><?=SelectBoxFromArray('ENCODING', $arEncoding, $shs_ENCODING);?></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_encoding_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
		<td><?echo GetMessage("parser_start_last_time")?></td>
		<td><input type="text" disabled name="START_LAST_TIME_X" value="<?echo $arrDate[DD].'.'.$arrDate[MM].'.'.$arrDate[YYYY].' '.$arrDate[HH].':'.$arrDate[MI].':'.$arrDate[SS];?>" size="20"></td>
	</tr>
<?
//********************
//Auto params
//********************
?>
<?
//********************
//Attachments
//********************
$tabControl->BeginNextTab();
?>
    <tr>
		<td><?echo GetMessage("parser_preview_text_type")?></td>
		<td><?=SelectBoxFromArray('PREVIEW_TEXT_TYPE', $arType, $shs_PREVIEW_TEXT_TYPE, "", "");?></td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_preview_delete_tag")?></td>
        <td><input class="bool-delete" type="checkbox" name="BOOL_PREVIEW_DELETE_TAG" value="Y"<?if($shs_BOOL_PREVIEW_DELETE_TAG == "Y") echo " checked"?>> <?echo GetMessage("parser_bool_preview_delete_tag")?><input <?if($shs_BOOL_PREVIEW_DELETE_TAG != "Y"):?>disabled <?endif?> type="text" name="PREVIEW_DELETE_TAG" value="<?echo $shs_PREVIEW_DELETE_TAG;?>" size="40" maxlength="300"></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_tag_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_first_img")?></td>
        <td width="60%"><input type="checkbox" name="PREVIEW_FIRST_IMG" value="Y"<?if($shs_PREVIEW_FIRST_IMG == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_first_img_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_save_img")?></td>
        <td width="60%"><input type="checkbox" name="PREVIEW_SAVE_IMG" value="Y"<?if($shs_PREVIEW_SAVE_IMG == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_save_img_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_delete_element")?></td>
        <td width="60%"><input size="80" maxlength="300" type="text" name="PREVIEW_DELETE_ELEMENT" value="<?=$shs_PREVIEW_DELETE_ELEMENT?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_element_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_delete_attribute")?></td>
        <td width="60%"><input size="80" maxlength="300" type="text" name="PREVIEW_DELETE_ATTRIBUTE" value="<?=$shs_PREVIEW_DELETE_ATTRIBUTE?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_attribute_descr")?>
            <?=EndNote();?>
        </td>
    </tr>

<?
//********************
//Attachments
//********************
$tabControl->BeginNextTab();
?>
    <tr>
		<td><?echo GetMessage("parser_detail_text_type")?></td>
		<td><?=SelectBoxFromArray('DETAIL_TEXT_TYPE', $arType, $shs_DETAIL_TEXT_TYPE, "", "");?></td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_detail_delete_tag")?></td>
        <td><input class="bool-delete" type="checkbox" name="BOOL_DETAIL_DELETE_TAG" value="Y"<?if($shs_BOOL_DETAIL_DELETE_TAG == "Y") echo " checked"?>> <?echo GetMessage("parser_bool_detail_delete_tag")?><input <?if($shs_BOOL_DETAIL_DELETE_TAG != "Y"):?>disabled <?endif?> type="text" name="DETAIL_DELETE_TAG" value="<?echo $shs_DETAIL_DELETE_TAG;?>" size="40" maxlength="300"></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_tag_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_first_img")?></td>
        <td width="60%"><input type="checkbox" name="DETAIL_FIRST_IMG" value="Y"<?if($shs_DETAIL_FIRST_IMG == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_first_img_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_save_img")?></td>
        <td width="60%"><input type="checkbox" name="DETAIL_SAVE_IMG" value="Y"<?if($shs_DETAIL_SAVE_IMG == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_save_img_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_delete_element")?></td>
        <td width="60%"><input size="80" maxlength="300" type="text" name="DETAIL_DELETE_ELEMENT" value="<?=$shs_DETAIL_DELETE_ELEMENT?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_delete_element_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_delete_attribute")?></td>
        <td width="60%"><input size="80" maxlength="300" type="text" name="DETAIL_DELETE_ATTRIBUTE" value="<?=$shs_DETAIL_DELETE_ATTRIBUTE?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_delete_attribute_descr")?>
            <?=EndNote();?>
        </td>
    </tr>

<?
$tabControl->BeginNextTab();

?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_active_element")?></td>
        <td width="60%"><input type="checkbox" name="ACTIVE_ELEMENT" value="Y"<?if($shs_ACTIVE_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_code_element")?></td>
        <td width="60%"><input type="checkbox" name="CODE_ELEMENT" value="Y"<?if($shs_CODE_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_index_element")?></td>
        <td width="60%"><input type="checkbox" name="INDEX_ELEMENT" value="Y"<?if($shs_INDEX_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_resize_image")?></td>
        <td width="60%"><input type="checkbox" name="RESIZE_IMAGE" value="Y"<?if($shs_RESIZE_IMAGE == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_date_active")?></td>
        <td width="60%"><input type="checkbox" name="DATE_ACTIVE" value="Y"<?if($shs_DATE_ACTIVE && $shs_DATE_ACTIVE != "N") echo " checked"?>> <?=SelectBoxFromArray('DATE_PROP_ACTIVE', $arrDateActive, $shs_DATE_ACTIVE, GetMessage("parser_date_type"), "id='prop-active' style='width:262px'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_date_public")?></td>
        <td width="60%"><input type="checkbox" name="DATE_PUBLIC" value="Y"<?if($shs_DATE_PUBLIC && $shs_DATE_PUBLIC != "N") echo " checked"?>> <?=SelectBoxFromArray('DATE_PROP_PUBLIC', $arrProp, $shs_DATE_PUBLIC, GetMessage("parser_prop_id"), "id='prop-date' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_first_title")?></td>
        <td width="60%"><input type="checkbox" name="FIRST_TITLE" value="Y"<?if($shs_FIRST_TITLE && $shs_FIRST_TITLE != "N") echo " checked"?>> <?=SelectBoxFromArray('FIRST_PROP_TITLE', $arrProp, $shs_FIRST_TITLE, GetMessage("parser_prop_id"), "id='prop-first' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_meta_title")?></td>
        <td width="60%"><input type="checkbox" name="META_TITLE" value="Y"<?if($shs_META_TITLE && $shs_META_TITLE != "N") echo " checked"?>> <?=SelectBoxFromArray('META_PROP_TITLE', $arrProp, $shs_META_TITLE, GetMessage("parser_prop_id"), "id='prop-title' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_meta_description")?></td>
        <td width="60%"><input type="checkbox" name="META_DESCRIPTION" value="Y"<?if($shs_META_DESCRIPTION && $shs_META_DESCRIPTION != "N") echo " checked"?>> <?=SelectBoxFromArray('META_PROP_DESCRIPTION', $arrProp, $shs_META_DESCRIPTION, GetMessage("parser_prop_id"), "id='prop-key' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_meta_keywords")?></td>
        <td width="60%"><input type="checkbox" name="META_KEYWORDS" value="Y"<?if($shs_META_KEYWORDS && $shs_META_KEYWORDS != "N") echo " checked"?>> <?=SelectBoxFromArray('META_PROP_KEYWORDS', $arrProp, $shs_META_KEYWORDS, GetMessage("parser_prop_id"), "id='prop-meta' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_page_uniq")?></td>
        <td width="60%">
        <?=SelectBoxFromArray('SETTINGS[rss][uniq]', $arrUniq, $shs_SETTINGS["rss"]["uniq"]);?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_start_agent")?></td>
        <td width="60%"><input type="checkbox" name="START_AGENT" value="Y"<?if($shs_START_AGENT == "Y") echo " checked"?>></td>
    </tr>
    
    <tr>
        <td width="40%"><?echo GetMessage("parser_time_agent")?></td>
        <td width="60%"><input type="text" size="40" name="TIME_AGENT" value="<?=$shs_TIME_AGENT?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_sleep")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[rss][sleep]" value="<?=$shs_SETTINGS["rss"]["sleep"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_sleep_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_proxy")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[rss][proxy]" value="<?=$shs_SETTINGS["rss"]["proxy"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_proxy_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    $tabControl->BeginNextTab();
    ?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_type_head")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_type")?>:</td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[loc][type]', $arLocType, $shs_SETTINGS["loc"]["type"], "", "class='select_load'");?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["loc"]["type"]) && $shs_SETTINGS["loc"]["type"]=="yandex"):?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_yandex_key")?>:</td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[loc][yandex][key]" value="<?=$shs_SETTINGS["loc"]["yandex"]["key"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_yandex_key_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_yandex_lang")?>:</td>
        <td width="60%"><input type="text" size="20" name="SETTINGS[loc][yandex][lang]" value="<?=$shs_SETTINGS["loc"]["yandex"]["lang"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_yandex_lang_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_fields")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_name")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_name]" value="Y"<?if($shs_SETTINGS["loc"]["f_name"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_preview_text")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_preview_text]" value="Y"<?if($shs_SETTINGS["loc"]["f_preview_text"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_detail_text")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_detail_text]" value="Y"<?if($shs_SETTINGS["loc"]["f_detail_text"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_props")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_props]" value="Y"<?if($shs_SETTINGS["loc"]["f_props"] == "Y") echo " checked"?>></td>
    </tr>
    <?endif;?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_uniq")?></td>
    </tr>
    <?
    $engine = new Engine\Yandex();
    $arSettings = $engine->getSettings();
    $arDomains = \CSeoUtils::getDomainsList();
    
    foreach($arDomains as $key => $domain)
    {
        if(!isset($arSettings['SITES'][$domain['DOMAIN']]))
        {
            unset($arDomains[$key]);
        }
    }

    if(count($arDomains) <= 0)
    {
        $msg = new CAdminMessage(array(
            'MESSAGE' => Loc::getMessage('SHS_PARSER_SEO_YANDEX_ERROR'),
            'HTML' => 'Y'
        ));
    }else{
        $arrDomain['REFERENCE'][] =  Loc::getMessage('shs_parser_loc_uniq_no');
        $arrDomain['REFERENCE_ID'][] = "";
        foreach($arDomains as $domain)
        {   //printr($domain);
            $domainEnc = Converter::getHtmlConverter()->encode($domain['DOMAIN']);
            $arrDomain['REFERENCE'][] =  $domainEnc;
            $arrDomain['REFERENCE_ID'][] = $domainEnc;
        }
    }
    ?>
    <?if(count($arDomains) <= 0):?>
    <tr>
        <td colspan="2" align="center"><?echo $msg->Show();?></td>
    </tr>
    <?else:?>
    <tr>
        <td><?echo GetMessage("parser_loc_uniq_domain")?>:</td>
        <td><?=SelectBoxFromArray('SETTINGS[loc][uniq][domain]', $arrDomain, $shs_SETTINGS["loc"]["uniq"]["domain"], "", "");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_uniq_domain_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?endif?>
    <?
    $tabControl->BeginNextTab();
    ?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_video_rss_descr")?></td>
    </tr>
    <tr>
        <td align="center" colspan="2" width="100%"><iframe width="800" height="500" src="//www.youtube.com/embed/UvkWaq_7rlY?list=PL2fR59TvIPXfB_XDmyp7pCnYoqQ-HhPXl" frameborder="0" allowfullscreen></iframe></td>
    </tr>
<?
$tabControl->Buttons(
	array(
		"disabled"=>($POST_RIGHT<"W"),
		"back_url"=>"list_parser_admin.php?lang=".LANG,

	)
);
?>
<?echo bitrix_sessid_post();?>
<input type="hidden" name="lang" value="<?=LANG?>">
<?if($ID>0 && !$bCopy):?>
	<input type="hidden" name="ID" value="<?=$ID?>">
<?endif;?>
<?
$tabControl->End();
?>

<?
$tabControl->ShowWarnings("post_form", $message);
?>55   6970|/shs.parser/admin/parser_section_edit.php|36c60fc5<?
use Bitrix\Main\Loader;
use Bitrix\Main\Entity;
use Bitrix\Main\Entity\ExpressionField;
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
require_once($_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/main/include/prolog_admin.php');

$module_id = "shs.parser";
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/".$module_id."/include.php");
IncludeModuleLangFile(__FILE__);
IncludeModuleLangFile($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/main/interface/admin_lib.php");

CModule::IncludeModule('shs.parser');
$parentID = 0;
if(isset($_REQUEST["parent"]) && $_REQUEST["parent"])
{
    $parentID = $_REQUEST["parent"];
}
$ID = intval($ID);
$POST_RIGHT = $APPLICATION->GetGroupRight($module_id);
if ($POST_RIGHT <= "D") {
    $APPLICATION->AuthForm(GetMessage("ACCESS_DENIED"));
}
$bCopy = ($action == "copy");

if($REQUEST_METHOD == "POST" && ($save!="" || $apply!="") && $POST_RIGHT=="W" && check_bitrix_sessid())
{
    $arFields = Array(
        "NAME"    => $NAME,
        "SORT"    => $SORT,
        "ACTIVE"    => ($ACTIVE <> "Y"? "N":"Y"),
        "DESCRIPTION"    => $DESCRIPTION,
        "PARENT_CATEGORY_ID"    => $PARENT_CATEGORY_ID,
    );
    //printr(array("ID"=>$ID));
    //die("SSS");
    if($ID>0)
    {
        $result = ShsParserSectionTable::Update($ID, $arFields);
        if (!$result->isSuccess())
        {
            $errors = $result->getErrorMessages();
            $res = false;
        }else
            $res = true;
    }
    else
    {
        $arFields["DATE_CREATE"] = new Bitrix\Main\Type\DateTime(date('Y-m-d H:i:s',time()),'Y-m-d H:i:s');
        $result = ShsParserSectionTable::add($arFields);

        if ($result->isSuccess())
        {
            $ID = $result->getId();
            $res = ($ID>0);
        }else{
            $errors = $result->getErrorMessages();
            $res = false;
        }

    }


    if($res)
    {
        if($apply!="")
            LocalRedirect("/bitrix/admin/parser_section_edit.php?ID=".$ID."&parent=".$parentID."&lang=".LANG);
        else
            LocalRedirect("/bitrix/admin/list_parser_admin.php?parent=".$parentID."&lang=".LANG);
    }
    else
    {
        if(isset($errors) && !empty($errors))
        {
            foreach($errors as $error)
            {
                CAdminMessage::ShowMessage($error);
            }

        }
        $bVarsFromForm = true;
    }
}

if(isset($_REQUEST["ID"]) || $copy)
{
    $ID = (int)$_REQUEST["ID"];
    if($copy)
        $arDataTable = ShsParserSectionTable::GetByID($copy)->Fetch();
    else
        $arDataTable = ShsParserSectionTable::GetByID($ID)->Fetch();

}



$aTabs = array(
        array(
            "DIV" => "edit1",
            "TAB" => GetMessage("shs_parser_category_name"),
            "ICON" => "shs_parser_category_icon",
            "TITLE" => GetMessage("shs_parser_category_name")
        ),
);


$aMenu = array(
    array(
        "TEXT"=>GetMessage("parser_list"),
        "TITLE"=>GetMessage("parser_list_title"),
        "LINK"=>"list_parser_admin.php?parent=".$parentID."&lang=".LANG,
        "ICON"=>"btn_list",
    )
);
if($ID>0)
{
    $aMenu[] = array("SEPARATOR"=>"Y");
    $aMenu[] = array(
        "TEXT"=>GetMessage("parser_section_add"),
        "TITLE"=>GetMessage("parser_section_add_title"),
        "LINK"=>"parser_section_edit.php?parent=".$parentID."&lang=".LANG,
        "ICON"=>"btn_new",
    );
    $aMenu[] = array(
        "TEXT"=>GetMessage("parser_section_copy"),
        "TITLE"=>GetMessage("parser_section_copy_title"),
        "LINK"=>"parser_section_edit.php?copy=".$ID."&lang=".LANG,
        "ICON"=>"btn_copy",
    );
    $aMenu[] = array(
        "TEXT"=>GetMessage("parser_section_delete"),
        "TITLE"=>GetMessage("parser_section_delete_title"),
        "LINK"=>"javascript:if(confirm('".GetMessage("parser_mnu_del_conf")."'))window.location='list_parser_admin.php?ID=".$ID."&action=delete_sect&parent=".$parentID."&lang=".LANG."&".bitrix_sessid_get()."';",
        "ICON"=>"btn_delete",
    );
}
$context = new CAdminContextMenu($aMenu);
$context->Show();

$rsSection = ShsParserSectionTable::getList(array(
    'limit' =>null,
    'offset' => null,
    'select' => array("*"),
    "filter" => array()
));

while($arSection = $rsSection->Fetch())
{
    if($ID>0 && $ID==$arSection["ID"]) continue 1;
    $arCategory['REFERENCE'][] = "[".$arSection["ID"]."] ".$arSection["NAME"];
    $arCategory['REFERENCE_ID'][] = $arSection["ID"];
}


$tabControl = new CAdminTabControl("tabControl", $aTabs);




?>
<form method="POST" id="shs-parser" Action="<?echo $APPLICATION->GetCurPage()?>" ENCTYPE="multipart/form-data" name="post_form">
<?
$tabControl->Begin();

$tabControl->BeginNextTab();
?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_section_act")?>:</td>
        <td width="60%"><input type="checkbox" name="ACTIVE" value="Y"<?if($arDataTable["ACTIVE"] == "Y" || !$ID) echo " checked"?>>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_section_sort")?></td>
        <td><input type="text" name="SORT" value="<?echo !$ID?"500":$arDataTable["SORT"];?>" size="4"></td>
    </tr>
    <tr>
        <td><span class="required">*</span><?echo GetMessage("parser_section_name")?></td>
        <td><input type="text" name="NAME" value="<?echo $arDataTable["NAME"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_category_title")?></td>
        <td><?=SelectBoxFromArray('PARENT_CATEGORY_ID', $arCategory, isset($arDataTable["PARENT_CATEGORY_ID"])?$arDataTable["PARENT_CATEGORY_ID"]:$parentID, GetMessage("parser_category_select"), "id='category' style='width:262px'");?></td>
    </tr>
    <tr>
		<td colspan="2" align="center"><?echo GetMessage("parser_category_description")?>:</td>
	</tr>
    <tr>
		<td colspan="2" align="center">
			<textarea cols="60" rows="15"  name="DESCRIPTION" style="width:100%"><?echo $arDataTable["DESCRIPTION"]?></textarea>
            <?=BeginNote();?>
            <?echo GetMessage("parser_section_descr")?>
            <?=EndNote();?>
		</td>
	</tr>
    <?echo bitrix_sessid_post();?>
    <input type="hidden" name="lang" value="<?=LANG?>">
    <?if($ID>0 && !$bCopy):?>
    <input type="hidden" name="ID" value="<?=$ID?>">
    <?endif;?>
    <input type="hidden" name="parent" value="<?=$parentID?>">
<?
$tabControl->End();

$tabControl->Buttons(
    array(
        "disabled"=>($POST_RIGHT<"W"),
        "back_url"=>"list_parser_admin.php?parent=".$parentID."&lang=".LANG,

    )
);



$APPLICATION->SetTitle(($ID>0? GetMessage("shs_parser_section_title_edit") : GetMessage("shs_parser_section_title_add")));



require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/epilog_admin.php");
?>48   67968|/shs.parser/admin/parser_edit.php|b65d91c5<?
use Bitrix\Highloadblock as HL; 
use Bitrix\Main\Entity;

if(!isset($_REQUEST['ajax']) && !isset($_REQUEST["ajax_start"]) && !isset($_REQUEST["ajax_count"]) && !isset($_POST["auth"])):
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");

//require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/classes/mysql/list_parser.php");
//require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/classes/general/rss_content_parser.php");
define("HELP_FILE", "add_issue.php");
CJSCore::Init(array("jquery"));




?>

<?
if(!CModule::IncludeModule('iblock')) return false;
CModule::IncludeModule('catalog');
CModule::IncludeModule("highloadblock");
CModule::IncludeModule('shs.parser');

IncludeModuleLangFile(__FILE__);
global $shs_DEMO;
$POST_RIGHT = $APPLICATION->GetGroupRight("shs.parser");
if($POST_RIGHT=="D")
    $APPLICATION->AuthForm(GetMessage("ACCESS_DENIED"));

$parentID = 0;
if(isset($_REQUEST["parent"]) && $_REQUEST["parent"])
{
    $parentID = $_REQUEST["parent"];
}
/*$aTabs = array(
    array("DIV" => "edit1", "TAB" => GetMessage("parser_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_tab")),
    array("DIV" => "edit2", "TAB" => GetMessage("parser_preview_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_preview_tab")),
    array("DIV" => "edit3", "TAB" => GetMessage("parser_detail_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_detail_tab")),
    array("DIV" => "edit4", "TAB" => GetMessage("parser_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_settings_tab")),
);
$tabControl = new CAdminTabControl("tabControl", $aTabs);*/


$ID = intval($ID);        // Id of the edited record
$bCopy = ($action == "copy");
$message = null;
$bVarsFromForm = false;

/*function sotbitParserSetSettings(&$SETTINGS)
{
    foreach($SETTINGS as &$v)
    {
        if(is_array($v)) sotbitParserSetSettings($v);
        else $v = htmlspecialcharsEx($v);
    }
}

function sotbitParserGetSettings(&$SETTINGS)
{
    foreach($SETTINGS as &$v)
    {
        if(is_array($v)) sotbitParserGetSettings($v);
        else $v = htmlspecialcharsBack($v);
    }
}*/

if($REQUEST_METHOD == "POST" && ($save!="" || $apply!="") && $POST_RIGHT=="W" && check_bitrix_sessid())
{
    $parser = new ShsParserContent();
    RssContentParser::sotbitParserSetSettings($SETTINGS);

    $arFields = Array(
        "NAME"    => $NAME,
        "TYPE"    => $TYPE,
        "RSS"    => $RSS,
        "SORT"    => $SORT,
        "ACTIVE"    => ($ACTIVE <> "Y"? "N":"Y"),
        "IBLOCK_ID"    => $IBLOCK_ID,
        "SECTION_ID" => $SECTION_ID,
        "SELECTOR"    => $SELECTOR,
        "FIRST_URL"    => $FIRST_URL,
        "ENCODING"    => $ENCODING,
        "PREVIEW_TEXT_TYPE" => $PREVIEW_TEXT_TYPE,
        "DETAIL_TEXT_TYPE" => $DETAIL_TEXT_TYPE,
        "PREVIEW_DELETE_TAG" => $PREVIEW_DELETE_TAG,
        "DETAIL_DELETE_TAG" => $DETAIL_DELETE_TAG,
        "PREVIEW_FIRST_IMG" => ($PREVIEW_FIRST_IMG <> "Y"? "N":"Y"),
        "DETAIL_FIRST_IMG" => ($DETAIL_FIRST_IMG <> "Y"? "N":"Y"),
        "PREVIEW_SAVE_IMG" => ($PREVIEW_SAVE_IMG <> "Y"? "N":"Y"),
        "DETAIL_SAVE_IMG" => ($DETAIL_SAVE_IMG <> "Y"? "N":"Y"),
        "BOOL_PREVIEW_DELETE_TAG" =>($BOOL_PREVIEW_DELETE_TAG <> "Y"? "N":"Y"),
        "BOOL_DETAIL_DELETE_TAG" =>($BOOL_DETAIL_DELETE_TAG <> "Y"? "N":"Y"),
        "PREVIEW_DELETE_ELEMENT" => $PREVIEW_DELETE_ELEMENT,
        "DETAIL_DELETE_ELEMENT" => $DETAIL_DELETE_ELEMENT,
        "PREVIEW_DELETE_ATTRIBUTE" => $PREVIEW_DELETE_ATTRIBUTE,
        "DETAIL_DELETE_ATTRIBUTE" => $DETAIL_DELETE_ATTRIBUTE,
        "INDEX_ELEMENT" => ($INDEX_ELEMENT <> "Y"? "N":"Y"),
        "CODE_ELEMENT" => ($CODE_ELEMENT <> "Y"? "N":"Y"),
        "RESIZE_IMAGE" => ($RESIZE_IMAGE <> "Y"? "N":"Y"),
        "CREATE_SITEMAP" => ($CREATE_SITEMAP <> "Y"? "N":"Y"),
        "DATE_ACTIVE" => ($DATE_ACTIVE <> "Y"? "N":$DATE_PROP_ACTIVE),
        "DATE_PUBLIC" => ($DATE_PUBLIC <> "Y"? "N":$DATE_PROP_PUBLIC),
        "FIRST_TITLE" => ($FIRST_TITLE <> "Y"? "N":$FIRST_PROP_TITLE),
        "META_TITLE" => ($META_TITLE <> "Y"? "N":$META_PROP_TITLE),
        "META_DESCRIPTION" => ($META_DESCRIPTION <> "Y"? "N":$META_PROP_DESCRIPTION),
        "META_KEYWORDS" => ($META_KEYWORDS <> "Y"? "N":$META_PROP_KEYWORDS),
        "START_AGENT" => ($START_AGENT <> "Y"? "N":"Y"),
        "TIME_AGENT" => $TIME_AGENT,
        "ACTIVE_ELEMENT" => ($ACTIVE_ELEMENT <> "Y"? "N":"Y"),
        "SETTINGS" => base64_encode(serialize($SETTINGS)),
        "CATEGORY_ID"    => $CATEGORY_ID,
        //"START_LAST_TIME" => $START_LAST_TIME
    );
    if($ID>0)
    {
        $res = $parser->Update($ID, $arFields);

    }
    else
    {
        $ID = $parser->Add($arFields);
        $res = ($ID>0);
    }
 
    if($res)
    {
        if($apply!="")
            LocalRedirect("/bitrix/admin/parser_edit.php?ID=".$ID."&mess=ok&lang=".LANG."&tabControl_active_tab=".$_POST["tabControl_active_tab"]);
        else
            LocalRedirect("/bitrix/admin/list_parser_admin.php?lang=".LANG);
    }
    else
    {
        if($e = $APPLICATION->GetException())
            $message = new CAdminMessage(GetMessage("parser_save_error"), $e);
        $bVarsFromForm = true;
    }

}
//Edit/Add part
ClearVars();


if($ID>0 || $copy)
{
    if($ID)$parser = ShsParserContent::GetByID($ID);
    elseif($copy) $parser = ShsParserContent::GetByID($copy);
    if(!$parser->ExtractFields("shs_"))
        $ID=0;
    if($ID>0 && $shs_TIME_AGENT>0){
        $arAgent = CAgent::GetList(array(), array("NAME"=>"CShsParser::startAgent(".$ID.");"))->Fetch();
        if(!$arAgent && $shs_START_AGENT=="Y"){CAgent::AddAgent(
            "CShsParser::startAgent(".$ID.");", //  
            "shs.parser",                          //  
            "N",                                  //     - 
            $shs_TIME_AGENT,                                //   - 1 
            "",                //     
            "Y",                                  //  
            "",                //   
            100
          );}
        elseif($arAgent){
            CAgent::Update($arAgent['ID'], array(
                "AGENT_INTERVAL"=>$shs_TIME_AGENT,
                "ACTIVE"=>$shs_START_AGENT=="Y"?"Y":"N"
            ));
        }
    }
    
    
    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$shs_IBLOCK_ID, "PROPERTY_TYPE"=>"S"));
    while($arProp = $properties->Fetch())
    {   //printr($arProp);
        $arrProp['REFERENCE'][] = "[".$arProp["CODE"]."] ".$arProp["NAME"];
        $arrProp['REFERENCE_ID'][] = $arProp["CODE"];
    }

    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$shs_IBLOCK_ID, "PROPERTY_TYPE"=>"F"));
    while($arProp = $properties->Fetch())
    {
        $arrPropFile['REFERENCE'][] = "[".$arProp["CODE"]."] ".$arProp["NAME"];
        $arrPropFile['REFERENCE_ID'][] = $arProp["CODE"];
    }

    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$shs_IBLOCK_ID));

    $arrPropDop['REFERENCE'][] = GetMessage("shs_parser_select_prop_new");
    $arrPropDop['REFERENCE_ID'][] = "[]";
    
    $arrPropField['REFERENCE'][] = GetMessage("parser_SOTBIT_PARSER_NAME_E");
    $arrPropField['REFERENCE_ID'][] = "SOTBIT_PARSER_NAME_E";
    
    while($arProp = $properties->Fetch())
    {

        if($arProp["PROPERTY_TYPE"]=="S")
        {
            $arrPropField['REFERENCE'][] = $arProp["NAME"];
            $arrPropField['REFERENCE_ID'][] = $arProp["CODE"];    
        }
        if($arProp["PROPERTY_TYPE"]=="L" || $arProp["PROPERTY_TYPE"]=="N" || $arProp["PROPERTY_TYPE"]=="S" || $arProp["PROPERTY_TYPE"]=="E" || $arProp["PROPERTY_TYPE"]=="F")
        {
            $arrPropDop['REFERENCE'][] = $arProp["NAME"];
            $arrPropDop['REFERENCE_ID'][] = $arProp["CODE"];
            $arrPropDop['REFERENCE_TYPE'][$arProp["CODE"]] = $arProp["PROPERTY_TYPE"];
            $arrPropDop['USER_TYPE'][$arProp["CODE"]] = $arProp["USER_TYPE"];
            $arrPropDop['REFERENCE_CODE_NAME'][$arProp["CODE"]] = $arProp["NAME"];
        }
        
        if($arProp["PROPERTY_TYPE"]=="L"/* && $arProp["ID"]==14*/)
        {
            $rsEnum = CIBlockPropertyEnum::GetList(Array("DEF"=>"DESC", "SORT"=>"ASC"), Array("IBLOCK_ID"=>$shs_IBLOCK_ID, "property_id"=>$arProp["ID"]));
            $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
            $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
            while($arEnum = $rsEnum->Fetch())
            {
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $arEnum["VALUE"];
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $arEnum["ID"];
            }
        }
        if($arProp['USER_TYPE']=="directory")
        {
            $nameTable = $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"];
            if($nameTable)
            {
                $directorySelect = array("*");
                $directoryOrder = array();
                $entityGetList = array(
                    'select' => $directorySelect,
                    'order' => $directoryOrder
                );
                $highBlock = \Bitrix\Highloadblock\HighloadBlockTable::getList(array("filter" => array('TABLE_NAME' => $nameTable)))->fetch();
                $entity = \Bitrix\Highloadblock\HighloadBlockTable::compileEntity($highBlock);
                $entityDataClass = $entity->getDataClass();
                $propEnums = $entityDataClass::getList($entityGetList);
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
                while ($oneEnum = $propEnums->fetch())
                {
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $oneEnum["UF_NAME"];
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $oneEnum["UF_XML_ID"];
                }    
            }
            
        }
    }
}

if($bVarsFromForm)
    $DB->InitTableVarsForEdit("b_shs_list_parser", "", "shs_");

$APPLICATION->SetTitle(($ID>0? GetMessage("parser_title_edit") : GetMessage("parser_title_add")));
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_after.php");

$aMenu = array(
    array(
        "TEXT"=>GetMessage("parser_list"),
        "TITLE"=>GetMessage("parser_list_title"),
        "LINK"=>"list_parser_admin.php?parent=".$parentID."&lang=".LANG,
        "ICON"=>"btn_list",
    )
);
if($ID>0)
{
    $aMenu[] = array("SEPARATOR"=>"Y");
    $aMenu[] = array(
        "TEXT"=>GetMessage("parser_add"),
        "TITLE"=>GetMessage("rubric_mnu_add"),
        "LINK"=>"parser_edit.php?lang=".LANG,
        "ICON"=>"btn_new",
    );
    $aMenu[] = array(
        "TEXT"=>GetMessage("parser_copy"),
        "TITLE"=>GetMessage("rubric_mnu_copy"),
        "LINK"=>"parser_edit.php?copy=".$ID."&lang=".LANG,
        "ICON"=>"btn_copy",
    );
    $aMenu[] = array(
        "TEXT"=>GetMessage("parser_delete"),
        "TITLE"=>GetMessage("parser_mnu_del"),
        "LINK"=>"javascript:if(confirm('".GetMessage("parser_mnu_del_conf")."'))window.location='list_parser_admin.php?ID=".$ID."&action=delete&lang=".LANG."&".bitrix_sessid_get()."';",
        "ICON"=>"btn_delete",
    );

    if($shs_ACTIVE=="Y"){
        $aMenu[] = array("SEPARATOR"=>"Y");
        if($shs_TYPE=="catalog" || $_GET["type"]=="catalog"):
        $aMenu[] = array(
            "TEXT"=>GetMessage("parser_start"),
            "TITLE"=>GetMessage("parser_start_title"),
            "LINK"=>"parser_edit.php?start=1&lang=".LANG."&ID=".$ID,
            "ICON"=>"btn_start_catalog"
        );
        else:
        $aMenu[] = array(
            "TEXT"=>GetMessage("parser_start"),
            "TITLE"=>GetMessage("parser_start_title"),
            "LINK"=>"parser_edit.php?start=1&lang=".LANG."&ID=".$ID,
            "ICON"=>"btn_start"
        );
        endif;
    }
    if($shs_TYPE=="catalog" || $_GET["type"]=="catalog")
    {
        $aMenu[] = array(
            "TEXT"=>GetMessage("parser_instructions"),
            "TITLE"=>GetMessage("parser_instructions_title"),
            "LINK"=>"http://www.sotbit.ru/info/articles/instruktsiya-polzovatelya-pri-rabote-s-modulem-parser-kontenta-v-rezhime-kataloga.html",
            "ICON"=>"instruction"
        );
    }
}
$context = new CAdminContextMenu($aMenu);
$context->Show();

$rsSection = ShsParserSectionTable::getList(array(
    'limit' =>null,
    'offset' => null,
    'select' => array("*"),
    "filter" => array()
));

$parentID = 0;
if(isset($_REQUEST["parent"]) && $_REQUEST["parent"])
{
    $parentID = $_REQUEST["parent"];
}

while($arSection = $rsSection->Fetch())
{
    $arCategory['REFERENCE'][] = "[".$arSection["ID"]."] ".$arSection["NAME"];
    $arCategory['REFERENCE_ID'][] = $arSection["ID"];
}

$arLocType['reference'] = array(GetMessage("parser_loc_no"), GetMessage("parser_loc_yandex"));
$arLocType['reference_id'] = array('', 'yandex');

if(isset($_REQUEST['start']) && $ID>0){
    $rssParser = new RssContentParser();
    $result = $rssParser->startParser();
    if(isset($result[SUCCESS][0]))
    foreach($result[SUCCESS] as $i=>$success){
      $resultUrl .= "&SUCCESS[".$i."]=".urlencode($success);
    }
    if(isset($result[ERROR][0]))
     foreach($result[ERROR] as $i=>$error){
      $resultUrl .= "&ERROR[".$i."]=".urlencode($error);
    }
    if(!RssContentParser::TEST)LocalRedirect($APPLICATION->GetCurPageParam("end=1".$resultUrl, array("start")));
}

if($shs_TYPE=="catalog" || $_GET["type"]=="catalog")
{   $isOfferCatalog = false;
    if(isset($shs_IBLOCK_ID) && $shs_IBLOCK_ID && CModule::IncludeModule('catalog'))
    {
        $arIblock = CCatalogSKU::GetInfoByIBlock($shs_IBLOCK_ID);
        //printr($arIblock);
        if(is_array($arIblock) && !empty($arIblock) && $arIblock["PRODUCT_IBLOCK_ID"]!=0 && $arIblock["SKU_PROPERTY_ID"]!=0)$isOfferCatalog = true;
        
        
        if($arIblock["IBLOCK_ID"] && $arIblock["PRODUCT_IBLOCK_ID"])
            $OFFER_IBLOCK_ID = $arIblock["IBLOCK_ID"];
        if($OFFER_IBLOCK_ID)
        {
            $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$OFFER_IBLOCK_ID));
    
            $arrPropDopOffer['REFERENCE'][] = GetMessage("shs_parser_select_prop_new");
            $arrPropDopOffer['REFERENCE_ID'][] = "[]";
            
            while($arProp = $properties->Fetch())
            {

                if($arProp["PROPERTY_TYPE"]=="L" || $arProp["PROPERTY_TYPE"]=="N" || $arProp["PROPERTY_TYPE"]=="S" || $arProp["PROPERTY_TYPE"]=="E" || $arProp["PROPERTY_TYPE"]=="F")
                {
                    $arrPropDopOffer['REFERENCE'][] = $arProp["NAME"];
                    $arrPropDopOffer['REFERENCE_ID'][] = $arProp["CODE"];
                    $arrPropDopOfferName['REFERENCE'][] = $arProp["NAME"];
                    $arrPropDopOfferName['REFERENCE_ID'][] = $arProp["CODE"];
                    $arrPropDopOffer['REFERENCE_TYPE'][$arProp["CODE"]] = $arProp["PROPERTY_TYPE"];
                    $arrPropDopOffer['USER_TYPE'][$arProp["CODE"]] = $arProp["USER_TYPE"];
                    $arrPropDopOffer['REFERENCE_CODE_NAME'][$arProp["CODE"]] = $arProp["NAME"];
                }
                
                if($arProp["PROPERTY_TYPE"]=="L"/* && $arProp["ID"]==14*/)
                {
                    $rsEnum = CIBlockPropertyEnum::GetList(Array("DEF"=>"DESC", "SORT"=>"ASC"), Array("IBLOCK_ID"=>$OFFER_IBLOCK_ID, "property_id"=>$arProp["ID"]));
                    $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
                    $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
                    while($arEnum = $rsEnum->Fetch())
                    {
                        $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $arEnum["VALUE"];
                        $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $arEnum["ID"];
                    }
                }
                if($arProp['USER_TYPE']=="directory")
                {
                    $nameTable = $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"];
                    $directorySelect = array("*");
                    $directoryOrder = array();
                    $entityGetList = array(
                        'select' => $directorySelect,
                        'order' => $directoryOrder
                    );
                    $highBlock = \Bitrix\Highloadblock\HighloadBlockTable::getList(array("filter" => array('TABLE_NAME' => $nameTable)))->fetch();
                    $entity = \Bitrix\Highloadblock\HighloadBlockTable::compileEntity($highBlock);
                    $entityDataClass = $entity->getDataClass();
                    $propEnums = $entityDataClass::getList($entityGetList);
                    $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
                    $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
                    while ($oneEnum = $propEnums->fetch())
                    {
                        $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $oneEnum["UF_NAME"];
                        $arrPropDopOffer["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $oneEnum["UF_XML_ID"];
                    }
                }
            }    
        }    
            
            
    }
    
    if(CModule::IncludeModule('catalog') && (($shs_IBLOCK_ID && CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y", "ID"=>$shs_IBLOCK_ID))->Fetch()) || (is_array($arIblock) && !empty($arIblock) && $arIblock["PRODUCT_IBLOCK_ID"]!=0 && $arIblock["SKU_PROPERTY_ID"]!=0)  || !$shs_IBLOCK_ID))
    {
        //unset($aTabs[5]);
        $aTabs = array(
            array("DIV" => "edit1", "TAB" => GetMessage("parser_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_tab")),
            array("DIV" => "edit2", "TAB" => GetMessage("parser_pagenavigation_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_pagenavigation_tab")),
            array("DIV" => "edit3", "TAB" => GetMessage("parser_preview_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_preview_tab")),
            array("DIV" => "edit4", "TAB" => GetMessage("parser_detail_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_detail_tab")),
            array("DIV" => "edit5", "TAB" => GetMessage("parser_props_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_props_tab")),
            array("DIV" => "edit6", "TAB" => GetMessage("parser_catalog_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_catalog_tab")),
            array("DIV" => "edit7", "TAB" => GetMessage("parser_offer_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_offer_tab")),
            array("DIV" => "edit8", "TAB" => GetMessage("parser_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_settings_tab")),
            array("DIV" => "edit9", "TAB" => GetMessage("parser_uniq_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_uniq_tab")),
            array("DIV" => "edit10", "TAB" => GetMessage("parser_auth"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_auth")),
            array("DIV" => "edit11", "TAB" => GetMessage("parser_logs_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_logs_tab")),
            array("DIV" => "edit12", "TAB" => GetMessage("parser_local_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_local_tab")),
            array("DIV" => "edit13", "TAB" => GetMessage("parser_video_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_video_tab")),
        );
        $isCatalog = true;
    }else{
        $aTabs = array(
            array("DIV" => "edit1", "TAB" => GetMessage("parser_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_tab")),
            array("DIV" => "edit2", "TAB" => GetMessage("parser_pagenavigation_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_pagenavigation_tab")),
            array("DIV" => "edit3", "TAB" => GetMessage("parser_preview_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_preview_tab")),
            array("DIV" => "edit4", "TAB" => GetMessage("parser_detail_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_detail_tab")),
            array("DIV" => "edit5", "TAB" => GetMessage("parser_props_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_props_tab")),
            array("DIV" => "edit7", "TAB" => GetMessage("parser_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_settings_tab")),
            array("DIV" => "edit8", "TAB" => GetMessage("parser_uniq_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_uniq_tab")),
            array("DIV" => "edit9", "TAB" => GetMessage("parser_auth"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_auth")),
            array("DIV" => "edit10", "TAB" => GetMessage("parser_logs_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_logs_tab")),
            array("DIV" => "edit11", "TAB" => GetMessage("parser_local_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_local_tab")),
            array("DIV" => "edit12", "TAB" => GetMessage("parser_video_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_video_tab")),
        );
        $isCatalog = false;
    }
    //printr($aTabs);
    //$rsIBlock = CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y"));
    $rsIBlock = CIBlock::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y"));
    while($arr=$rsIBlock->Fetch()){
        $arIBlock['REFERENCE'][] = "[".$arr["ID"]."] ".$arr["NAME"];
        $arIBlock['REFERENCE_ID'][] = $arr["ID"];
    }
}else{
    $rsIBlock = CIBlock::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y"));
    while($arr=$rsIBlock->Fetch()){
        $arIBlock['REFERENCE'][] = "[".$arr["ID"]."] ".$arr["NAME"];
        $arIBlock['REFERENCE_ID'][] = $arr["ID"];
    }

    $aTabs = array(
        array("DIV" => "edit1", "TAB" => GetMessage("parser_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_tab")),
        array("DIV" => "edit2", "TAB" => GetMessage("parser_preview_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_preview_tab")),
        array("DIV" => "edit3", "TAB" => GetMessage("parser_detail_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_detail_tab")),
        array("DIV" => "edit4", "TAB" => GetMessage("parser_settings_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_settings_tab")),
        array("DIV" => "edit5", "TAB" => GetMessage("parser_local_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_local_tab")),
        array("DIV" => "edit6", "TAB" => GetMessage("parser_video_tab"), "ICON"=>"main_user_edit", "TITLE"=>GetMessage("parser_video_tab")),
    );
}
$tabControl = new CAdminTabControl("tabControl", $aTabs);



if(!empty($shs_IBLOCK_ID)){
    $rsSections = CIBlockSection::GetList(array("left_margin"=>"asc"), array(/*'ACTIVE'=>"Y",*/ "IBLOCK_ID"=>$shs_IBLOCK_ID), false, array('ID', 'NAME', "IBLOCK_ID", "DEPTH_LEVEL"));

    while($arr=$rsSections->Fetch()){
        $arr["NAME"] = str_repeat(" . ", $arr["DEPTH_LEVEL"]).$arr["NAME"];
        $arSection['REFERENCE'][] = $arr["NAME"];
        $arSection['REFERENCE_ID'][] = $arr["ID"];
    }



}
$arrDateActive['REFERENCE'][0] =  GetMessage("parser_date_active_now");
$arrDateActive['REFERENCE'][1] =  GetMessage("parser_date_active_now_time");
$arrDateActive['REFERENCE'][2] =  GetMessage("parser_date_active_public");
$arrDateActive['REFERENCE_ID'][0] = "NOW";
$arrDateActive['REFERENCE_ID'][1] = "NOW_TIME";
$arrDateActive['REFERENCE_ID'][2] = "PUBLIC";
?>
<a target="blank" href=""><?=GetMessage("parser_instruction")?></a>
<div id="status_bar" style="display:none;overflow:hidden;">
    <div id="progress_bar" style="width: 500px;float:left;" class="adm-progress-bar-outer">
        <div id="progress_bar_inner" style="width: 0px;" class="adm-progress-bar-inner"></div>
        <div id="progress_text" style="width: 500px;" class="adm-progress-bar-inner-text">0%</div>
    </div>
    <div id="catalog_bar" style="float:left;width:700px;height:35px;line-height:35px;font-weight:bold;margin-left:30px;"></div>
    <div id="current_test"></div>
</div>
<div style="clear:both;"></div>
<?
if(isset($_REQUEST["mess"]) && $_REQUEST["mess"] == "ok" && $ID>0)
    CAdminMessage::ShowMessage(array("MESSAGE"=>GetMessage("parser_saved"), "TYPE"=>"OK"));

if($message)
    echo $message->Show();
elseif($rubric->LAST_ERROR!="")
    CAdminMessage::ShowMessage($rubric->LAST_ERROR);

if(isset($_REQUEST['end']) && $_REQUEST['end']==1 && $ID>0){
    if(isset($_GET['SUCCESS'][0])){
      foreach($_GET['SUCCESS'] as $success) CAdminMessage::ShowMessage(array("MESSAGE"=>$success, "TYPE"=>"OK"));
    }
    if(isset($_GET['ERROR'][0])){
        foreach($_GET['ERROR'] as $error) CAdminMessage::ShowMessage($error);
    }

}
$shs_SETTINGS = (string)$shs_SETTINGS;
$shs_SETTINGS = unserialize(base64_decode($shs_SETTINGS));

$shsDebug = $shs_SETTINGS["catalog"]["mode"];


if($shs_DEMO==2)CAdminMessage::ShowMessage(array("MESSAGE"=>GetMessage("parser_demo")));
if($shs_DEMO==3)CAdminMessage::ShowMessage(array("MESSAGE"=>GetMessage("parser_demo_end")));
?>
<div id="shs_message"></div>
<form method="POST" id="shs-parser" Action="<?echo $APPLICATION->GetCurPage()?>" ENCTYPE="multipart/form-data" name="post_form">
<?
$tabControl->Begin();


if($shs_TYPE=="page" || (isset($_GET["type"]) && $_GET["type"]=="page")) include("parser_edit_page.php");
elseif($shs_TYPE=="catalog" || (isset($_GET["type"]) && $_GET["type"]=="catalog")) include("parser_edit_catalog.php");
elseif((!$shs_TYPE && $ID) || $shs_TYPE=="rss" || (isset($_GET["type"]) && $_GET["type"]=="rss") || !isset($ID) || !$ID) include("parser_edit_rss.php");
?>






<?echo BeginNote();?>
<span class="required">*</span><?echo GetMessage("REQUIRED_FIELDS")?>
<?echo EndNote();?>
<script language="JavaScript">
            var target_id = '';
            var target_select_id = '';
            var target_shadow_id = '';
            function addSectionProperty(iblock_id, select_id, tr, table_id)
            {   
                {
                    target_id = table_id;
                    target_select_id = select_id;
                    target_shadow_id = tr;
                    (new BX.CDialog({
                        'content_url' : '/bitrix/admin/iblock_edit_property.php?lang=<?echo LANGUAGE_ID?>&IBLOCK_ID='+iblock_id+'&ID=n0&bxpublic=Y&from_module=iblock&return_url=section_edit',
                        'width' : 700,
                        'height' : 400,
                        'buttons': [BX.CDialog.btnSave, BX.CDialog.btnCancel]
                    })).Show();
                }
            }
            function deleteSectionProperty(id, select_id, shadow_id, table_id)
            {
                var hidden = BX('hidden_SECTION_PROPERTY_' + id);
                var tr = BX('tr_SECTION_PROPERTY_' + id);
                if(hidden && tr)
                {
                    hidden.value = 'N';
                    tr.style.display = 'none';
                    var select = BX(select_id);
                    var shadow = BX(shadow_id);
                    if(select && shadow)
                    {
                        jsSelectUtils.deleteAllOptions(select);
                        for(var i = 0; i < shadow.length; i++)
                        {
                            if(shadow[i].value <= 0)
                                jsSelectUtils.addNewOption(select, shadow[i].value, shadow[i].text);
                            else if (BX('hidden_SECTION_PROPERTY_' + shadow[i].value).value == 'N')
                                jsSelectUtils.addNewOption(select, shadow[i].value, shadow[i].text);
                        }
                    }
                    adjustEmptyTR(table_id);
                }
            }
            function createSectionProperty(id, name, type)
            {   
                jQuery.ajax({
                    url: "",
                    type: "POST",
                    data: 'ajax=1&prop_id='+id,
                    dataType: 'html',
                    success: function(code){
                        code = $.trim(code);
                        if(target_select_id=="loadDopPropOffer")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[offer][selector_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);
                            
                            strName = '<option value="'+code+'">'+name+'</option>'; 
                            $(".add_name").append(strName);   
                        }else if(target_select_id=="loadDopPropOffer1")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[offer][find_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);
                            strName = '<option value="'+code+'">'+name+'</option>';
                            $(".add_name").append(strName);    
                        }
                        else if(target_select_id=="loadDopProp")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);
                    
                        }else if(target_select_id=="loadDopProp1")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }else if(target_select_id=="loadDopProp2")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop_preview]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }else if(target_select_id=="loadDopProp3")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop_preview]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }
                        else if(target_select_id=="loadPropField")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][action_props_val]['+code+'][]" data-code="'+code+'" size="40">&nbsp; <select id="SETTINGS[catalog][action_props]['+code+']" name="SETTINGS[catalog][action_props]['+code+'][]"><option value=""><?=GetMessage("shs_parser_select_action_props")?></option><option value="delete"><?=GetMessage("parser_action_props_delete")?></option><option value="add_b"><?=GetMessage("parser_action_props_add_begin")?></option><option value="add_e"><?=GetMessage("parser_action_props_add_end")?></option></select> <a href="#" class="find_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }
                    }

                 })
                
            }
            function createSectionPropertyOffer(id, name, type)
            {   
                jQuery.ajax({
                    url: "",
                    type: "POST",
                    data: 'ajax=1&iblock=<?=$OFFER_IBLOCK_ID?>&prop_id='+id,
                    dataType: 'html',
                    success: function(code){
                        code = $.trim(code);
                        if(target_select_id=="loadDopProp")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);
                    
                        }else if(target_select_id=="loadDopProp1")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }else if(target_select_id=="loadDopProp2")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop_preview]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }else if(target_select_id=="loadDopProp3")
                        {
                            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+name+'&nbsp;['+code+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop_preview]['+code+']" data-code="'+code+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
                            target_shadow_id.before(str);    
                        }
                    }

                 })
                
            }
            function adjustEmptyTR(table_id)
            {
                var tbl = BX(table_id);
                if(tbl)
                {
                    var cnt = tbl.rows.length;
                    var tr = tbl.rows[cnt-1];

                    var display = 'table-row';
                    for(var i = 1; i < cnt-1; i++)
                    {
                        if(tbl.rows[i].style.display != 'none')
                            display = 'none';
                    }
                    tr.style.display = display;
                }
            }
</script>    
<script language="JavaScript">
    jQuery(document).ready(function(){
        
        
        $("#loadDopPropOffer").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDopOffer] option:selected").val();
            t = tr.find("select[name=arrPropDopOffer] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property_offer("loadDopPropOffer", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[offer][selector_prop]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadDopPropOffer1").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDopOffer] option:selected").val();
            t = tr.find("select[name=arrPropDopOffer] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property_offer("loadDopPropOffer1", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[offer][find_prop]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadDopProp").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDop] option:selected").val();
            t = tr.find("select[name=arrPropDop] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadDopProp", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadPropDefault").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDefault] option:selected").val();
            t = tr.find("select[name=arrPropDefault] option:selected").text();
            if(v=="") return false;
            /*else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadPropDefault", tr);
                return false;
            }*/
            
            jQuery.ajax({
                    url: "",
                    type: "POST",
                    data: 'default=1&ajax=1&prop_id='+v+"&iblock_id="+<?=isset($shs_IBLOCK_ID)?$shs_IBLOCK_ID:0?>,
                    dataType: 'html',
                    success: function(data){
                        str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r">'+data+'</td></tr>';
                        tr.before(str);    
                    }
            })
        });
        
        $("#loadDopProp2").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDop] option:selected").val();
            t = tr.find("select[name=arrPropDop] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadDopProp2", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][selector_prop_preview]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadDopProp1").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDop1] option:selected").val();
            t = tr.find("select[name=arrPropDop1] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadDopProp1", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadDopProp3").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropDop1] option:selected").val();
            t = tr.find("select[name=arrPropDop1] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadDopProp3", tr);
                return false;
            }
            str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop_preview]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            tr.before(str);
        });
        
        $("#loadPropField").on("click", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            
            v = tr.find("select[name=arrPropField] option:selected").val();
            t = tr.find("select[name=arrPropField] option:selected").text();
            if(v=="") return false;
            else if(v=="[]")
            {
                sotbit_iblock_edit_property("loadPropField", tr);
                return false;
            }
            //str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][find_prop_preview]['+v+']" data-code="'+v+'" size="40">&nbsp;<a href="#" class="prop_delete">Delete</a></td></tr>';
            if(v=="SOTBIT_PARSER_NAME_E") str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+':</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][action_props_val]['+v+'][]" data-code="'+v+'" size="40">&nbsp; <select id="SETTINGS[catalog][action_props]['+v+']" name="SETTINGS[catalog][action_props]['+v+'][]"><option value=""><?=GetMessage("shs_parser_select_action_props")?></option><option value="delete"><?=GetMessage("parser_action_props_delete")?></option><option value="add_b"><?=GetMessage("parser_action_props_add_begin")?></option><option value="add_e"><?=GetMessage("parser_action_props_add_end")?></option></select> <a href="#" class="find_delete">Delete</a></td></tr>';
            else str = '<tr><td width="40%" class="adm-detail-content-cell-l">'+t+'&nbsp;['+v+']:</td><td width="60%" class="adm-detail-content-cell-r"><input type="text" value="" name="SETTINGS[catalog][action_props_val]['+v+'][]" data-code="'+v+'" size="40">&nbsp; <select id="SETTINGS[catalog][action_props]['+v+']" name="SETTINGS[catalog][action_props]['+v+'][]"><option value=""><?=GetMessage("shs_parser_select_action_props")?></option><option value="delete"><?=GetMessage("parser_action_props_delete")?></option><option value="add_b"><?=GetMessage("parser_action_props_add_begin")?></option><option value="add_e"><?=GetMessage("parser_action_props_add_end")?></option></select> <a href="#" class="find_delete">Delete</a></td></tr>';
            
            tr.before(str);
        });
        
        function sotbit_iblock_edit_property(select_id, tr)
        {
            <?if(isset($shs_IBLOCK_ID) && $shs_IBLOCK_ID):?>addSectionProperty(<?echo $shs_IBLOCK_ID;?>, select_id, tr, 'table_SECTION_PROPERTY')<?endif;?>
        }
        
        function sotbit_iblock_edit_property_offer(select_id, tr)
        {
            <?if(isset($OFFER_IBLOCK_ID) && $OFFER_IBLOCK_ID):?>addSectionProperty(<?echo $OFFER_IBLOCK_ID;?>, select_id, tr, 'table_SECTION_PROPERTY')<?endif;?>
        }
        
        
        $("#instruction").attr("target", "_blank");
        $("body").on("click", ".prop_delete", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            tr.hide();
            tr.find("input").val("");
            v = tr.find("input").attr("data-code");
            prev = $("#delete_selector_prop").val();
            $("#delete_selector_prop").val(prev+","+v);
        });

        $("body").on("click", ".find_delete", function(e){
            e.preventDefault();
            tr = $(this).parents("tr").eq(0);
            tr.hide();
            tr.find("input").val("");
            v = tr.find("input").attr("data-code");
            prev = $("#delete_find_prop").val();
            $("#delete_find_prop").val(prev+","+v);
        })
        
        $("body").on("click", ".show_prop", function(e){
            e.preventDefault();
            id = $(this).attr("data-name");
            $("#"+id).val("");
            tr = $(this).parents("tr").eq(0);
            if(!tr.is("#header_find_prop"))tr.nextAll().not("#header_find_prop~tr").show();
            else tr.nextAll().show();    
        })
        
        $("body").on("click", ".add_usl", function(e){
            e.preventDefault();
            
            tr = $(".tr_add").clone(); 
            console.log(tr);
            n = parseInt($(".tr_add.heading").attr("data-num"));
            $(".tr_add").removeClass("tr_add");
            $(".tr_last").after(tr);
            $(".tr_last").not(".tr_add").removeClass("tr_last");
            $(this).remove();
            $(".tr_add.heading").attr("data-num", n+1); 
            $(".tr_add.heading span").text(n+1);
            $(".tr_add .del_usl").show();  
        })
        
        $("body").on("click", "#auth", function(e){
            e.preventDefault();
            url = $(this).attr("data-href");
            jQuery.ajax({
               url: url,
               type: "POST",
               data: "auth=1",
               dataType: 'html',
               success: function(data){
                 $("#shs_message").html(data);
               }

            })
        })
        
        $("body").on("click", ".del_usl", function(e){
            e.preventDefault();
            tr = $(this).parents(".heading").eq(0);
            if(tr.is(".tr_add"))
            {
                tr.prev().addClass("tr_last");
                bool = false;
                tr.prevAll("tr").each(function(){
                    if(!bool) $(this).addClass("tr_add");
                    if($(this).is(".heading") && !bool)
                    {
                        bool = true;
                        attr = parseInt($(this).attr("data-num"));
                        if(attr!=1)$(this).html(tr.html());    
                    }
                         
                })        
            }
                bool = false;
                tr.nextAll("tr").each(function(){
                    if($(this).is(".heading")) bool = true;
                    if(!bool) $(this).remove();    
                })    
            tr.remove();
        })

        jQuery('#iblock').change(function(){
            iblock = jQuery(this).val();
            jQuery.ajax({
               url: "",
               type: "POST",
               data: 'ajax=1&iblock='+iblock,
               dataType: 'html',
               success: function(data){
                 var ar = new Array();
                 ar = data.split("#SOTBIT#");
                 $('#section').html(ar[0]);
                 /*$(".prop-iblock").html(ar[1]);
                 $("#edit5 .image_props").html(ar[4]);
                 $("#edit5 #header_selector_prop+tr+tr").nextAll().not("#header_find_prop, .tr_find_prop").remove();
                 $("#edit5 #header_find_prop+tr+tr+tr").nextAll().not(".tr_find_prop").remove();
                 $("#edit5 #header_selector_prop+tr+tr").after(ar[2]);
                 $("#edit5 #header_find_prop+tr+tr+tr").after(ar[3]);*/
               }

            })

        })

        $('.bool-delete').change(function(){
          if($(this).prop('checked')){
            $(this).next().removeAttr('disabled');
            $(this).next().next().removeAttr('disabled');
          }
          else{
            $(this).next().val("");
            $(this).next().attr('disabled', "");

            $(this).next().next().val("");
            $(this).next().next().attr('disabled', "");
          }
        })

        $('.number_img').change(function(){
          if(!$(this).prop('checked')){
            $(this).next().removeAttr('disabled');
            $(this).next().next().removeAttr('disabled');
          }
          else{
            $(this).next().val("");
            $(this).next().attr('disabled', "");

            $(this).next().next().val("");
            $(this).next().next().attr('disabled', "");

          }
        })

        $("#TYPE").change(function(e){
                href = location.href;
                location.href=href+'&type='+$(this).val();
        })
        
        $(".select_load").change(function(e){
            $("input[name=apply]").click();    
        })
        
        $("body").on("click", "#btn_stop_catalog", function(e){
            e.preventDefault();
                
        })
        var ajaxInterval;
        var sotbitStop;
        var sotbitStopStart;
        var href1, href2;
        var debug = 0;
        <?if($shsDebug=="debug"):?>
        debug = 1;
        <?endif;?>

        function sotbitAjaxCatalog(href2, start)
        {
                if(start==1)
                {
                    sotbitStopStart = 0;
                    href = href2+"&begin=1";
                    sotbitStop = 0;
                }
                else href=href2;
                BX.ajax.get(href, "", function(data){
                    //clearInterval(ajaxInterval);
                    prog = 100;
                    $('#progress_text').html(prog + '%');
                    $('#progress_bar_inner').width(500 * prog / 100);
                    //$("#status_bar").hide();
                    $('#progress_text').html(100 + '%');
                    if(data!="stop")$("#shs_message").html(data);
                    //if(sotbitStop!=1)sotbitAjaxCatalog(href2, 0);
                    //else sotbitStop = 0;
                    if(data!="stop" && sotbitStopStart!=1 && debug!=1) sotbitAjaxCatalog(href2, 0);
                    else
                    {   
                        if(sotbitStopStart==1)sotbitStop = 1;
                        //if(debug==1) 
                        sotbitStop = 1;
                        $("#btn_stop_catalog").attr("id", "btn_start_catalog");
                        $("#btn_start_catalog").text(<?echo '"'.GetMessage("parser_start").'"'?>); 
                        setTimeout(function(){
                            sotbitCountAjax(href1, 1);    
                        },1000)
                            
                    }                            
                    
                })    
        }
        
        $("#btn_stop_catalog").live("click", function(e){
            e.preventDefault();
            sotbitStopStart = 1;
        })
        
        $("#btn_start_catalog").live('click', function(e) {   //alert("test");
            e.preventDefault();
            $(this).attr("id", "btn_stop_catalog");
            $("#status_bar").show();
            $(this).text(<?echo '"'.GetMessage("btn_stop_catalog").'"'?>);
            href1 = $(this).attr("href")+"&ajax_count=1&type=catalog";
            href2 = $(this).attr("href")+"&ajax_start=1&type=catalog";

            //ajaxInterval = setInterval(function(){
            sotbitCountAjax(href1, 0);
            //}, 1000);
            
            

            sotbitAjaxCatalog(href2, 1);

            return false;

        })
        
        function sotbitCountAjax(href1, num)
        {   
            BX.ajax.post(href1, "sessid="+BX.bitrix_sessid(), function(data){
                    arData = data.split("|");
                    if(sotbitStop!=1)
                    {
                        if(arData[1]>0)prog = Math.ceil((arData[1]/arData[0])*100);
                        else prog = 0;
                        $('#progress_text').html(prog + '%');
                        $('#progress_bar_inner').width(500 * prog / 100);    
                    }
                    
                    page = arData[2];
                    elements = arData[3];
                    elementError = arData[4];
                    allError = arData[5];
                    if(sotbitStop!=1)sotbitStop = parseInt(arData[6]);
                    msg = <?echo '"'.GetMessage("parser_load_page").'"'?>+page+<?echo '"'.GetMessage("parser_load_product").'"'?>+elements+<?echo '"<span style=\"color:red\">'.GetMessage("parser_load_product_error").'"'?>+elementError+'</span>'+<?echo '"<span style=\"color:red\">'.GetMessage("parser_all_error").'"'?>+allError+'</span>';
                    $("#catalog_bar").html(msg);
                    if(sotbitStop==1)
                    {   
                        prog = 100;
                        $('#progress_text').html(prog + '%');
                        $('#progress_bar_inner').width(500 * prog / 100);
                        $('#progress_text').html(<?echo '"'.GetMessage("parser_loading_end").'"'?>); 
                    }else sotbitCountAjax(href1, 0);
                    
                    
                })    
        }

    })

    BX.ready(function(){

        BX.bind(BX('btn_start'), 'click', function(e) {
            e.preventDefault();
            BX.show(BX('status_bar'));
            var href1 = BX(this).getAttribute("href")+"&ajax_count=1";
            var href2 = BX(this).getAttribute("href")+"&ajax_start=1";

            var ajaxInterval = setInterval(function(){
                BX.ajax.post(href1, "sessid="+BX.bitrix_sessid(), function(data){
                    arData = data.split("|");
                    if(arData[1]>0)prog = Math.ceil((arData[1]/arData[0])*100);
                    else prog = 0;
                    BX('progress_text').innerHTML = prog + '%';
                    BX('progress_bar_inner').style.width = 500 * prog / 100 + 'px';
                    if(prog==1) clearInterval(ajaxInterval);
                })
            }, 500);


            BX.ajax.get(href2, "", function(data){
                clearInterval(ajaxInterval);
                prog = 100;
                BX('progress_text').innerHTML = prog + '%';
                BX('progress_bar_inner').style.width = 500 * prog / 100 + 'px';
                BX.hide(BX('status_bar'));
                BX('progress_text').innerHTML = 0 + '%';
                BX("shs_message").innerHTML = data;

            })

            return false;

        })

        
    })
</script>
<style>
.adm-info-message table td, .heading .adm-info-message td, .heading .adm-info-message td{
    padding:0!important;
}
.item_row td{
  padding:0!important;  
}
</style>
<?require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/epilog_admin.php");?>
<?elseif(isset($_REQUEST["ajax_start"]) && isset($_REQUEST["ID"]) && isset($_REQUEST["start"]) && !isset($_REQUEST["ajax_count"])):
    set_time_limit(0);
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");
    IncludeModuleLangFile(__FILE__);
    if(CModule::IncludeModule('iblock') && CModule::IncludeModule('main')):
    $parser = ShsParserContent::GetByID($ID);
    if(!$parser->ExtractFields("shs_")) $ID=0;
    $rssParser = new RssContentParser();
    $result = $rssParser->startParser(0);
    endif;
?>
<?elseif(isset($_REQUEST["ID"]) && isset($_REQUEST["start"]) && isset($_REQUEST["ajax_count"])):
    set_time_limit(0);
    $file = $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/count_parser".$_REQUEST["ID"].".txt";
    if(isset($_REQUEST["ID"]) && file_exists($file)){
        $count = file_get_contents($file);
        echo $count;
    }else{
        echo "0|0";
    }
    if($_GET["type"]=="catalog")
    {
        $file1 = $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/count_parser_catalog".$_REQUEST["ID"].".txt";
        if(isset($_REQUEST["ID"]) && file_exists($file1))
        {
            $count = file_get_contents($file1);
            echo $count;
        }else{
            echo "|0|0|0|0";
        }
        $file2 = $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/catalog_parser_current_page".$_REQUEST["ID"].".txt";
        if(isset($_REQUEST["ID"]) && file_exists($file2))
        {
            $content = file_get_contents($file2);
            if($content=="")
            {
                echo "|1";
                unlink($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/catalog_parser_current_page".$_REQUEST["ID"].".txt");    
            }
        }    
    }
    //print_r(array($_REQUEST["ID"], file_exists($file), $file));
?>
<?
elseif(isset($_REQUEST["prop_id"])):
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");
        IncludeModuleLangFile(__FILE__);
    CModule::IncludeModule('iblock');
    if(isset($_REQUEST["default"])) $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "CODE"=>$_REQUEST["prop_id"], "IBLOCK_ID"=>$_REQUEST["iblock_id"]));
    else $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "ID"=>$_REQUEST["prop_id"]));
    while($arProp = $properties->Fetch())
    {   //printr($arProp);
        if(!isset($_REQUEST["default"]))
        {
            echo $arProp["CODE"];
            return false;    
        }else{
            $code = $arProp["CODE"];
            if($arProp["PROPERTY_TYPE"]=="L" || $arProp["PROPERTY_TYPE"]=="N" || $arProp["PROPERTY_TYPE"]=="S" || $arProp["PROPERTY_TYPE"]=="E" || $arProp["PROPERTY_TYPE"]=="F")
            {
                $arrPropDop['REFERENCE'][] = $arProp["NAME"];
                $arrPropDop['REFERENCE_ID'][] = $arProp["CODE"];
                $arrPropDop['REFERENCE_TYPE'][$arProp["CODE"]] = $arProp["PROPERTY_TYPE"];
                $arrPropDop['USER_TYPE'][$arProp["CODE"]] = $arProp["USER_TYPE"];
                $arrPropDop['REFERENCE_CODE_NAME'][$arProp["CODE"]] = $arProp["NAME"];
            }
            
            if($arProp["PROPERTY_TYPE"]=="L"/* && $arProp["ID"]==14*/)
            {
                $rsEnum = CIBlockPropertyEnum::GetList(Array("DEF"=>"DESC", "SORT"=>"ASC"), Array("IBLOCK_ID"=>$shs_IBLOCK_ID, "property_id"=>$arProp["ID"]));
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
                while($arEnum = $rsEnum->Fetch())
                {
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $arEnum["VALUE"];
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $arEnum["ID"];
                }
            }
            if($arProp['USER_TYPE']=="directory")
            {
                $nameTable = $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"];
                $directorySelect = array("*");
                $directoryOrder = array();
                $entityGetList = array(
                    'select' => $directorySelect,
                    'order' => $directoryOrder
                );
                $highBlock = \Bitrix\Highloadblock\HighloadBlockTable::getList(array("filter" => array('TABLE_NAME' => $nameTable)))->fetch();
                $entity = \Bitrix\Highloadblock\HighloadBlockTable::compileEntity($highBlock);
                $entityDataClass = $entity->getDataClass();
                $propEnums = $entityDataClass::getList($entityGetList);
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
                $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
                while ($oneEnum = $propEnums->fetch())
                {
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = $oneEnum["UF_NAME"];
                    $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = $oneEnum["UF_XML_ID"];
                }
            }
                
                ?><?if($arrPropDop['REFERENCE_TYPE'][$code]=="L"):
            ?>
            <?=SelectBoxFromArray('SETTINGS[catalog][default_prop]['.$code.']', $arrPropDop["LIST_VALUES"][$code], "", "", "");?>
            <?elseif($arrPropDop['USER_TYPE'][$code]=="directory"):?>
            <?=SelectBoxFromArray('SETTINGS[catalog][default_prop]['.$code.']', $arrPropDop["LIST_VALUES"][$code], "", "", "");?>
            <?else:?>
            <input type="text" placeholder="<?=GetMessage("parser_prop_default")?>" name="SETTINGS[catalog][default_prop][<?=$code?>]" value="" />
            <?endif?><?
                
                
        }
        
        
    }
    
    
elseif(isset($_REQUEST["iblock"])):
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
        require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");
        IncludeModuleLangFile(__FILE__);
    CModule::IncludeModule('iblock');
    $rsSections = CIBlockSection::GetList(array("left_margin"=>"asc"), array(/*'ACTIVE'=>"Y", */"IBLOCK_ID"=>$_REQUEST["iblock"]), false, array('ID', 'NAME', "IBLOCK_ID", "DEPTH_LEVEL"));

    $first = true;
    echo '<option value="">'.GetMessage("parser_section_id").'</option>';
    while($arr=$rsSections->Fetch()){
        $arr["NAME"] = str_repeat(" . ", $arr["DEPTH_LEVEL"]).$arr["NAME"];
        echo '<option value="'.$arr["ID"].'">'.$arr["NAME"].'</option>';
    }
    echo '#SOTBIT#<option value="">'.GetMessage("parser_prop_id").'</option>';
    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$_REQUEST['iblock'], "PROPERTY_TYPE"=>"S"));
    while($arProp = $properties->Fetch())
    {
        echo '<option value="'.$arProp["CODE"].'">'."[".$arProp["CODE"]."] ".$arProp["NAME"].'</option>';
    }




    echo '#SOTBIT#';
    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$_REQUEST['iblock']));
    while($arProp = $properties->Fetch())
    {
        if($arProp["PROPERTY_TYPE"]=="S" || $arProp["PROPERTY_TYPE"]=="L" || $arProp["PROPERTY_TYPE"]=="N" ||  $arProp["PROPERTY_TYPE"]=="E")
        {
            $arPropsDop[] = $arProp;
        }

         //echo '<option value="'.$arProp["CODE"].'">'."[".$arProp["CODE"]."] ".$arProp["NAME"].'</option>';
    }
    foreach($arPropsDop as $val)
    {
        echo '<tr><td width="40%" class="adm-detail-content-cell-l">'.$val["NAME"].'&nbsp;['.$val["CODE"].']:</td><td width="60%" class="adm-detail-content-cell-r"><input data-code="'.$val["CODE"].'" size="40" type="text" value="" name="SETTINGS[catalog][selector_prop]['.$val["CODE"].']">&nbsp;<a class="prop_delete" href="#">Delete</a></td></tr>';
    }
    echo '#SOTBIT#';
    foreach($arPropsDop as $val)
    {
        echo '<tr><td width="40%" class="adm-detail-content-cell-l">'.$val["NAME"].'&nbsp;['.$val["CODE"].']:</td><td width="60%" class="adm-detail-content-cell-r"><input data-code="'.$val["CODE"].'" size="40" type="text" value="" name="SETTINGS[catalog][find_prop]['.$val["CODE"].']">&nbsp;<a class="find_delete" href="#">Delete</a></td></tr>';
    }

    echo '#SOTBIT#<option value="">'.GetMessage("parser_prop_id").'</option>';
    $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$_REQUEST['iblock'], "PROPERTY_TYPE"=>"F"));
    while($arProp = $properties->Fetch())
    {
        echo '<option value="'.$arProp["CODE"].'">'."[".$arProp["CODE"]."] ".$arProp["NAME"].'</option>';
    }
elseif(isset($_POST["auth"])):
    set_time_limit(0);
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_admin_before.php");
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include.php");
    require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/prolog.php");
    IncludeModuleLangFile(__FILE__);
    if(CModule::IncludeModule('iblock') && CModule::IncludeModule('main')):
    $parser = ShsParserContent::GetByID($ID);
    if(!$parser->ExtractFields("shs_")) $ID=0;
    $rssParser = new RssContentParser();
    $rssParser->auth(true);
    endif;
endif;
?>53   20543|/shs.parser/admin/parser_edit_page.php|96a93755<?
use Bitrix\Seo\Engine;
use Bitrix\Main\Text\Converter;
use Bitrix\Main\Localization\Loc;
use Bitrix\Main\IO\Path;

\Bitrix\Main\Loader::includeModule('seo');
\Bitrix\Main\Loader::includeModule('socialservices');
$tabControl->BeginNextTab();
$arEncoding['reference'] = array('utf-8', 'windows-1251');
$arEncoding['reference_id'] = array('utf-8', 'windows-1251');
$arType['reference'] = array('html', 'text');
$arType['reference_id'] = array('html', 'text');

$arTypeParser['reference'] = array('rss', 'page', 'catalog');
$arTypeParser['reference_id'] = array('rss', 'page', 'catalog');

$arrUniq["reference"] = array(GetMessage("parser_page_uniq_name"), GetMessage("parser_page_uniq_url"));
$arrUniq["reference_id"] = array("name", "url");

unset($arrDateActive['REFERENCE'][2]);
unset($arrDateActive['REFERENCE_ID'][2]);
$disabled = false;
$arrDate = ParseDateTime($shs_START_LAST_TIME_X, "YYYY.MM.DD HH:MI:SS");
if($shs_TYPE) $disabled = 'disabled=""';
?>
    <tr>
		<td><?echo GetMessage("parser_type")?></td>
		<td><?=SelectBoxFromArray('TYPE', $arTypeParser, $shs_TYPE?$shs_TYPE:$_GET["type"], "", $disabled);?>
        <?if($disabled):?><input type="hidden" name="TYPE" value="<?=$shs_TYPE?>" /><?endif;?>
        </td>
	</tr>
	<tr>
		<td width="40%"><?echo GetMessage("parser_act")?></td>
		<td width="60%"><input type="checkbox" name="ACTIVE" value="Y"<?if($shs_ACTIVE == "Y" || !$ID) echo " checked"?>>
        </td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_sort")?></td>
		<td><input type="text" name="SORT" value="<?echo !$ID?"100":$shs_SORT;?>" size="4"></td>
	</tr>
    <?if(isset($arCategory) && !empty($arCategory)):?>
    <tr>
        <td><?echo GetMessage("parser_category_title")?></td>
        <td><?=SelectBoxFromArray('CATEGORY_ID', $arCategory, isset($shs_CATEGORY_ID)?$shs_CATEGORY_ID:$parentID, GetMessage("parser_category_select"), "id='category' style='width:262px'");?></td>
    </tr>
    <?endif;?>
	<tr>
		<td><span class="required">*</span><?echo GetMessage("parser_name")?></td>
		<td><input type="text" name="NAME" value="<?echo $shs_NAME;?>" size="40" maxlength="250"></td>
	</tr>
    <tr>
		<td><span class="required">*</span><?echo GetMessage("parser_rss_page")?></td>
		<td><input type="text" name="RSS" value="<?echo $shs_RSS;?>" size="40" maxlength="250"></td>
	</tr>
	<tr>
		<td><span class="required">*</span><?echo GetMessage("parser_iblock_id")?></td>
		<td><?=SelectBoxFromArray('IBLOCK_ID', $arIBlock, $shs_IBLOCK_ID, GetMessage("parser_iblock_id"), "id='iblock' style='width:262px'");?></td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_section_id")?></td>
		<td><?=SelectBoxFromArray('SECTION_ID', $arSection, $shs_SECTION_ID, GetMessage("parser_section_id"), "id='section' style='width:262px'");?></td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_selector")?></td>
		<td><input type="text" name="SELECTOR" value="<?echo $shs_SELECTOR;?>" size="40" maxlength="250"></td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_selector_page")?></td>
		<td><input type="text" name="SETTINGS[page][selector]" value="<?echo $shs_SETTINGS["page"]["selector"];?>" size="40" maxlength="250"></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
		<td><?echo GetMessage("parser_href_page")?></td>
		<td><input type="text" name="SETTINGS[page][href]" value="<?echo $shs_SETTINGS["page"]["href"];?>" size="40" maxlength="250"></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_href_descr_page")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
		<td><?echo GetMessage("parser_name_page")?></td>
		<td><input type="text" name="SETTINGS[page][name]" value="<?echo $shs_SETTINGS["page"]["name"];?>" size="40" maxlength="250"></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_name_descr_page")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
		<td><?echo GetMessage("parser_first_url_page")?></td>
		<td><input type="text" name="FIRST_URL" value="<?echo $shs_FIRST_URL;?>" size="40" maxlength="250"></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_first_url_descr_page")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
		<td><?echo GetMessage("parser_encoding")?></td>
		<td><?=SelectBoxFromArray('ENCODING', $arEncoding, $shs_ENCODING);?></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_encoding_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
		<td><?echo GetMessage("parser_start_last_time")?></td>
		<td><input type="text" disabled name="START_LAST_TIME_X" value="<?echo $arrDate[DD].'.'.$arrDate[MM].'.'.$arrDate[YYYY].' '.$arrDate[HH].':'.$arrDate[MI].':'.$arrDate[SS];?>" size="20"></td>
	</tr>
<?
//********************
//Auto params
//********************
?>
<?
//********************
//Attachments
//********************
$tabControl->BeginNextTab();
?>
    <tr>
		<td><?echo GetMessage("parser_preview_text_type")?></td>
		<td><?=SelectBoxFromArray('PREVIEW_TEXT_TYPE', $arType, $shs_PREVIEW_TEXT_TYPE, "", "");?></td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_preview_delete_tag")?></td>
        <td><input class="bool-delete" type="checkbox" name="BOOL_PREVIEW_DELETE_TAG" value="Y"<?if($shs_BOOL_PREVIEW_DELETE_TAG == "Y") echo " checked"?>> <?echo GetMessage("parser_bool_preview_delete_tag")?><input <?if($shs_BOOL_PREVIEW_DELETE_TAG != "Y"):?>disabled <?endif?> type="text" name="PREVIEW_DELETE_TAG" value="<?echo $shs_PREVIEW_DELETE_TAG;?>" size="40" maxlength="300"></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_tag_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_first_img")?></td>
        <td width="60%"><input type="checkbox" name="PREVIEW_FIRST_IMG" value="Y"<?if($shs_PREVIEW_FIRST_IMG == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_first_img_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_save_img")?></td>
        <td width="60%"><input type="checkbox" name="PREVIEW_SAVE_IMG" value="Y"<?if($shs_PREVIEW_SAVE_IMG == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_save_img_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_delete_element")?></td>
        <td width="60%"><input size="80" maxlength="300" type="text" name="PREVIEW_DELETE_ELEMENT" value="<?=$shs_PREVIEW_DELETE_ELEMENT?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_element_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_delete_attribute")?></td>
        <td width="60%"><input size="80" maxlength="300" type="text" name="PREVIEW_DELETE_ATTRIBUTE" value="<?=$shs_PREVIEW_DELETE_ATTRIBUTE?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_attribute_descr")?>
            <?=EndNote();?>
        </td>
    </tr>

<?
//********************
//Attachments
//********************
$tabControl->BeginNextTab();
?>
    <tr>
		<td><?echo GetMessage("parser_detail_text_type")?></td>
		<td><?=SelectBoxFromArray('DETAIL_TEXT_TYPE', $arType, $shs_DETAIL_TEXT_TYPE, "", "");?></td>
	</tr>
    <tr>
		<td><?echo GetMessage("parser_detail_delete_tag")?></td>
        <td><input class="bool-delete" type="checkbox" name="BOOL_DETAIL_DELETE_TAG" value="Y"<?if($shs_BOOL_DETAIL_DELETE_TAG == "Y") echo " checked"?>> <?echo GetMessage("parser_bool_detail_delete_tag")?><input <?if($shs_BOOL_DETAIL_DELETE_TAG != "Y"):?>disabled <?endif?> type="text" name="DETAIL_DELETE_TAG" value="<?echo $shs_DETAIL_DELETE_TAG;?>" size="40" maxlength="300"></td>
	</tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_delete_tag_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_first_img")?></td>
        <td width="60%"><input type="checkbox" name="DETAIL_FIRST_IMG" value="Y"<?if($shs_DETAIL_FIRST_IMG == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_first_img_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_save_img")?></td>
        <td width="60%"><input type="checkbox" name="DETAIL_SAVE_IMG" value="Y"<?if($shs_DETAIL_SAVE_IMG == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_save_img_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_delete_element")?></td>
        <td width="60%"><input size="80" maxlength="300" type="text" name="DETAIL_DELETE_ELEMENT" value="<?=$shs_DETAIL_DELETE_ELEMENT?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_delete_element_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_delete_attribute")?></td>
        <td width="60%"><input size="80" maxlength="300" type="text" name="DETAIL_DELETE_ATTRIBUTE" value="<?=$shs_DETAIL_DELETE_ATTRIBUTE?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_detail_delete_attribute_descr")?>
            <?=EndNote();?>
        </td>
    </tr>

<?
$tabControl->BeginNextTab();

?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_active_element")?></td>
        <td width="60%"><input type="checkbox" name="ACTIVE_ELEMENT" value="Y"<?if($shs_ACTIVE_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_code_element")?></td>
        <td width="60%"><input type="checkbox" name="CODE_ELEMENT" value="Y"<?if($shs_CODE_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_index_element")?></td>
        <td width="60%"><input type="checkbox" name="INDEX_ELEMENT" value="Y"<?if($shs_INDEX_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_resize_image")?></td>
        <td width="60%"><input type="checkbox" name="RESIZE_IMAGE" value="Y"<?if($shs_RESIZE_IMAGE == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_date_active")?></td>
        <td width="60%"><input type="checkbox" name="DATE_ACTIVE" value="Y"<?if($shs_DATE_ACTIVE && $shs_DATE_ACTIVE != "N") echo " checked"?>> <?=SelectBoxFromArray('DATE_PROP_ACTIVE', $arrDateActive, $shs_DATE_ACTIVE, GetMessage("parser_date_type"), "id='prop-active' style='width:262px'");?></td>
    </tr>
    <?/*?><tr>
        <td width="40%"><?echo GetMessage("parser_date_public")?></td>
        <td width="60%"><input type="checkbox" name="DATE_PUBLIC" value="Y"<?if($shs_DATE_PUBLIC && $shs_DATE_PUBLIC != "N") echo " checked"?>> <?=SelectBoxFromArray('DATE_PROP_PUBLIC', $arrProp, $shs_DATE_PUBLIC, GetMessage("parser_prop_id"), "id='prop-date' style='width:262px' class='prop-iblock'");?></td>
    </tr><?*/?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_first_title")?></td>
        <td width="60%"><input type="checkbox" name="FIRST_TITLE" value="Y"<?if($shs_FIRST_TITLE && $shs_FIRST_TITLE != "N") echo " checked"?>> <?=SelectBoxFromArray('FIRST_PROP_TITLE', $arrProp, $shs_FIRST_TITLE, GetMessage("parser_prop_id"), "id='prop-first' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_meta_title")?></td>
        <td width="60%"><input type="checkbox" name="META_TITLE" value="Y"<?if($shs_META_TITLE && $shs_META_TITLE != "N") echo " checked"?>> <?=SelectBoxFromArray('META_PROP_TITLE', $arrProp, $shs_META_TITLE, GetMessage("parser_prop_id"), "id='prop-title' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_meta_description")?></td>
        <td width="60%"><input type="checkbox" name="META_DESCRIPTION" value="Y"<?if($shs_META_DESCRIPTION && $shs_META_DESCRIPTION != "N") echo " checked"?>> <?=SelectBoxFromArray('META_PROP_DESCRIPTION', $arrProp, $shs_META_DESCRIPTION, GetMessage("parser_prop_id"), "id='prop-key' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_meta_keywords")?></td>
        <td width="60%"><input type="checkbox" name="META_KEYWORDS" value="Y"<?if($shs_META_KEYWORDS && $shs_META_KEYWORDS != "N") echo " checked"?>> <?=SelectBoxFromArray('META_PROP_KEYWORDS', $arrProp, $shs_META_KEYWORDS, GetMessage("parser_prop_id"), "id='prop-meta' style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_start_agent")?></td>
        <td width="60%"><input type="checkbox" name="START_AGENT" value="Y"<?if($shs_START_AGENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_page_uniq")?></td>
        <td width="60%">
        <?=SelectBoxFromArray('SETTINGS[page][uniq]', $arrUniq, $shs_SETTINGS["page"]["uniq"]);?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_time_agent")?></td>
        <td width="60%"><input type="text" size="40" name="TIME_AGENT" value="<?=$shs_TIME_AGENT?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_sleep")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[page][sleep]" value="<?=$shs_SETTINGS["page"]["sleep"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_sleep_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_proxy")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[page][proxy]" value="<?=$shs_SETTINGS["page"]["proxy"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_proxy_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    $tabControl->BeginNextTab();
    ?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_type_head")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_type")?>:</td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[loc][type]', $arLocType, $shs_SETTINGS["loc"]["type"], "", "class='select_load'");?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["loc"]["type"]) && $shs_SETTINGS["loc"]["type"]=="yandex"):?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_yandex_key")?>:</td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[loc][yandex][key]" value="<?=$shs_SETTINGS["loc"]["yandex"]["key"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_yandex_key_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_yandex_lang")?>:</td>
        <td width="60%"><input type="text" size="20" name="SETTINGS[loc][yandex][lang]" value="<?=$shs_SETTINGS["loc"]["yandex"]["lang"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_yandex_lang_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_fields")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_name")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_name]" value="Y"<?if($shs_SETTINGS["loc"]["f_name"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_preview_text")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_preview_text]" value="Y"<?if($shs_SETTINGS["loc"]["f_preview_text"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_detail_text")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_detail_text]" value="Y"<?if($shs_SETTINGS["loc"]["f_detail_text"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_props")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_props]" value="Y"<?if($shs_SETTINGS["loc"]["f_props"] == "Y") echo " checked"?>></td>
    </tr>
    <?endif;?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_uniq")?></td>
    </tr>
    <?
    $engine = new Engine\Yandex();
    $arSettings = $engine->getSettings();
    $arDomains = \CSeoUtils::getDomainsList();
    
    foreach($arDomains as $key => $domain)
    {
        if(!isset($arSettings['SITES'][$domain['DOMAIN']]))
        {
            unset($arDomains[$key]);
        }
    }

    if(count($arDomains) <= 0)
    {
        $msg = new CAdminMessage(array(
            'MESSAGE' => Loc::getMessage('SHS_PARSER_SEO_YANDEX_ERROR'),
            'HTML' => 'Y'
        ));
    }else{
        $arrDomain['REFERENCE'][] =  Loc::getMessage('shs_parser_loc_uniq_no');
        $arrDomain['REFERENCE_ID'][] = "";
        foreach($arDomains as $domain)
        {   //printr($domain);
            $domainEnc = Converter::getHtmlConverter()->encode($domain['DOMAIN']);
            $arrDomain['REFERENCE'][] =  $domainEnc;
            $arrDomain['REFERENCE_ID'][] = $domainEnc;
        }
    }
    ?>
    <?if(count($arDomains) <= 0):?>
    <tr>
        <td colspan="2" align="center"><?echo $msg->Show();?></td>
    </tr>
    <?else:?>
    <tr>
        <td><?echo GetMessage("parser_loc_uniq_domain")?>:</td>
        <td><?=SelectBoxFromArray('SETTINGS[loc][uniq][domain]', $arrDomain, $shs_SETTINGS["loc"]["uniq"]["domain"], "", "");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_uniq_domain_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?endif?>
    <?
    $tabControl->BeginNextTab();
    ?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_video_page_descr")?></td>
    </tr>
    <tr>
        <td align="center" colspan="2" width="100%"><iframe width="800" height="500" src="//www.youtube.com/embed/tIZqrPOVYFY?list=PL2fR59TvIPXfB_XDmyp7pCnYoqQ-HhPXl" frameborder="0" allowfullscreen></iframe></td>
    </tr>
<?
$tabControl->Buttons(
	array(
		"disabled"=>($POST_RIGHT<"W"),
		"back_url"=>"list_parser_admin.php?lang=".LANG,

	)
);
?>
<?echo bitrix_sessid_post();?>
<input type="hidden" name="lang" value="<?=LANG?>">
<?if($ID>0 && !$bCopy):?>
	<input type="hidden" name="ID" value="<?=$ID?>">
<?endif;?>
<?
$tabControl->End();
?>

<?
$tabControl->ShowWarnings("post_form", $message);
?>39   777|/shs.parser/admin/menu.php|244c7aaa<?
IncludeModuleLangFile(__FILE__);

if($APPLICATION->GetGroupRight("shs.parser")!="D")
{
	$aMenu = array(
		"parent_menu" => "global_menu_content",
		"section" => "shs.parser",
		"sort" => 100,
		"text" => GetMessage("mnu_shs_parser_sect"),
		"title" => GetMessage("mnu_shs_parser_sect_title"),
		"url" => "list_parser_admin.php?lang=".LANGUAGE_ID,
		"icon" => "shs_parser_menu_icon",
		"page_icon" => "shs_parser_page_icon",
		"items_id" => "menu_shs.parser",
		"items" => array(
			array(
				"text" => GetMessage("mnu_shs_list_parser"),
				"url" => "list_parser_admin.php?lang=".LANGUAGE_ID,
				"more_url" => array("list_parser_admin.php"),
				"title" => GetMessage("mnu_shs_list_parser_alt")
			),
		)
	);

	return $aMenu;
}
return false;
?>55   5312|/shs.parser/classes/mysql/list_parser.php|4dcb1b52<?
class ShsParserContent extends ShsParserContentGeneral
{
	function GetList($aSort=Array(), $aFilter=Array())
	{
		global $DB;
		$this->LAST_ERROR = "";
		$arFilter = array();
		if (is_array($aFilter))
		{
			foreach($aFilter as $key=>$val)
			{
                if($key!="CATEGORY_ID")if (!is_array($val) && (strlen($val)<=0 || $val=="NOT_REF"))
					continue;

				switch(strtoupper($key))
				{
				case "NAME":
					$arFilter[] = "P.NAME like '%".$val."%'";
					break;
				case "ID":
					$arFilter[] = GetFilterQuery("P.ID",$val,"N");
					break;
                case "RSS":
					$arFilter[] = "P.RSS like '%".$val."%'";
					break;
				case "TIMESTAMP_1":
					if($DB->IsDate($val))
						$arFilter[] = "P.TIMESTAMP_X>=".$DB->CharToDateFunction($val, "SHORT");
					else
						$this->LAST_ERROR .= GetMessage("PARSER_WRONG_TIMESTAMP_FROM")."<br>";
					break;
                case "TYPE":
					$arFilter[] = "P.TYPE='".$val."'";
					break;
                case "ACTIVE":
					$arFilter[] = "P.ACTIVE='".$val."'";
					break;

                case "IBLOCK_ID":
					$arFilter[] = "P.IBLOCK_ID='".$val."'";
					break;
                case "SECTION_ID":
					$arFilter[] = GetFilterQuery("P.SECTION_ID",$val,"N");
					break;
                case "CATEGORY_ID":
					$arFilter[] = "P.CATEGORY_ID='".$val."'";
					break;
                case "SELECTOR":
					$arFilter[] = GetFilterQuery("P.SELECTOR",$val,"Y");
					break;
				case "ENCODING":
					$arFilter[] = GetFilterQuery("P.ENCODING",$val,"N");
					break;
                case "START_AGENT":
					$arFilter[] = "P.START_AGENT='".$val."'";
					break;
                case "TIME_AGENT":
					$arFilter[] = "P.TIME_AGENT='".$val."'";
					break;
                case "START_LAST_TIME_1":
					if($DB->IsDate($val))
						$arFilter[] = "P.START_LAST_TIME_X>=".$DB->CharToDateFunction($val, "SHORT");
					else
						$this->LAST_ERROR .= GetMessage("PARSER_WRONG_START_LAST_TIME_FROM")."<br>";
					break;
				}
			}
		}
		$arOrder = array();
		foreach($aSort as $key => $ord)
		{
			$key = strtoupper($key);
			$ord = (strtoupper($ord) <> "ASC"? "DESC": "ASC");
			switch($key)
			{
				case "ID":		$arOrder[$key] = "P.ID ".$ord; break;
                case "TYPE":		$arOrder[$key] = "P.TYPE ".$ord; break;
				case "TIMESTAMP":	$arOrder[$key] = "P.TIMESTAMP_X ".$ord; break;
				case "NAME":		$arOrder[$key] = "P.NAME ".$ord; break;
				case "RSS":	$arOrder[$key] = "P.RSS ".$ord; break;
				case "ACTIVE":		$arOrder[$key] = "P.ACTIVE ".$ord; break;
				case "IBLOCK_ID":	$arOrder[$key] = "P.IBLOCK_ID ".$ord; break;
				case "ENCODING":	$arOrder[$key] = "P.ENCODING ".$ord; break;
                case "START_AGENT":	$arOrder[$key] = "P.START_AGENT ".$ord; break;
                case "TIME_AGENT":	$arOrder[$key] = "P.TIME_AGENT ".$ord; break;
                case "SORT":    $arOrder[$key] = "P.SORT ".$ord; break;
                case "START_LAST_TIME":	$arOrder[$key] = "P.START_LAST_TIME_X ".$ord; break;
                case "CATEGORY_ID":		$arOrder[$key] = "P.CATEGORY_ID ".$ord; break;
			}
		}
		if(count($arOrder) == 0)
			$arOrder[] = "P.ID DESC";
		$sOrder = "\nORDER BY ".implode(", ",$arOrder);
		if(count($arFilter) == 0)
			$sFilter = "";
		else
			$sFilter = "\nWHERE ".implode("\nAND ", $arFilter);
		$strSql = "
			SELECT
                 P.ID
                ,P.TYPE
				,P.NAME
				,P.RSS
				,P.SORT
				,P.ACTIVE
				,P.SECTION_ID
				,P.SELECTOR
				,P.ENCODING
                ,P.START_AGENT
                ,P.TIME_AGENT
                ,P.CATEGORY_ID
				,".$DB->DateToCharFunction("P.TIMESTAMP_X")." TIMESTAMP_X
                ,".$DB->DateToCharFunction("P.START_LAST_TIME_X")." START_LAST_TIME_X
			FROM b_shs_parser P
			".$sFilter.$sOrder;
		return $DB->Query($strSql, false, "File: ".__FILE__."<br>Line: ".__LINE__);
	}

    function GetMixedList($aSort=Array(), $arFilter=Array(), $show="all")
    {
        $filter = array();
        if($show=="all" || $show=="section")
        {
            if(isset($arFilter["CATEGORY_ID"]))
            {
                $filter["PARENT_CATEGORY_ID"] = $arFilter["CATEGORY_ID"];
            }

            $rsSection = ShsParserSectionTable::getList(array(
                'limit' =>null,
                'offset' => null,
                'select' => array("*"),
                //'order' => $aSort,
                "filter" => $filter
            ));

            while($arSection = $rsSection->Fetch())
            {
                $arSection["T"]="S";
                $arResult[]=$arSection;
            }    
        }/*else{
            $arResult[] = array();    
        }*/
        
        if($show=="all" || $show=="parser")
        {
            $cData = new ShsParserContent;
            $rsData = $cData->GetList($aSort, $arFilter);
            while($arData = $rsData->Fetch())
            {
                $arData["T"]="P";
                $arResult[] = $arData;
            }
            unset($cData);    
        }/*else{
            $arResult[] = array();    
        }*/
        $rsResult = new CDBResult;
        $rsResult->InitFromArray($arResult);

        return $rsResult;
    }
}
?>58   1892|/shs.parser/classes/mysql/parser_section.php|54624f5e<?
use Bitrix\Main\Entity;
use Bitrix\Main\Localization\Loc;
Loc::loadMessages(__FILE__);

class ShsParserSectionTable extends Entity\DataManager
{
    public static function getFilePath()
    {
       return __FILE__;
    }

   public static function getTableName()
   {
      return 'b_shs_parser_section';
   }
   
   public static function getMap()
   {
      return array(
         'ID' => array(
            'data_type' => 'integer',
            'primary' => true,
            'autocomplete' => true,
            'title' => "ID",
         ),
         'TIMESTAMP_X' => array(
            'data_type' => 'datetime',
            //'required' => true,
            'title' => "TIMESTAMP_X",
         ),
         'DATE_CREATE' => array(
            'data_type' => 'datetime',
            //'required' => true,
            'title' => Loc::getMessage("shs_parser_section_date_title"),
         ),
         'ACTIVE' => array(
            'data_type' => 'boolean',
            'required' => true,
            'values' => array('N', 'Y'),
            'title' => Loc::getMessage("shs_parser_section_active_title"),
         ),
         'SORT' => array(
            'data_type' => 'integer',
            'required' => true,
            'title' => Loc::getMessage("shs_parser_section_sort_title"),
         ),
         'NAME' => array(
            'data_type' => 'string',
            'required' => true,
            'title' => Loc::getMessage("shs_parser_section_name_title"),
         ),
         'DESCRIPTION' => array(
            'data_type' => 'string',
            'title' => Loc::getMessage("shs_parser_section_description_title"),
         ),
         'PARENT_CATEGORY_ID' => array(
            'data_type' => 'integer',
            'title' => Loc::getMessage("shs_parser_section_parent_title"),
         ),

      );
   }
}
?>53   840|/shs.parser/classes/mysql/parser_tmp.php|3b8b404d<?
use Bitrix\Main\Entity;
use Bitrix\Main\Localization\Loc;
Loc::loadMessages(__FILE__);

class ShsParserTmpTable extends Entity\DataManager
{
    public static function getFilePath()
    {
       return __FILE__;
    }

   public static function getTableName()
   {
      return 'b_shs_parser_tmp';
   }
   
   public static function getMap()
   {
      return array(
         'ID' => array(
            'data_type' => 'integer',
            'primary' => true,
            'autocomplete' => true,
            'title' => "ID",
         ),
         'PARSER_ID' => array(
            'data_type' => 'integer',
            'title' => "PARSER_ID",
         ),         
         'PRODUCT_ID' => array(
            'data_type' => 'integer',
            'title' => "PRODUCT_ID",
         ),
      );
   }
}
?>57   847|/shs.parser/classes/mysql/parser_tmp_old.php|60a755f4<?
use Bitrix\Main\Entity;
use Bitrix\Main\Localization\Loc;
Loc::loadMessages(__FILE__);

class ShsParserTmpOldTable extends Entity\DataManager
{
    public static function getFilePath()
    {
       return __FILE__;
    }

   public static function getTableName()
   {
      return 'b_shs_parser_tmp_old';
   }
   
   public static function getMap()
   {
      return array(
         'ID' => array(
            'data_type' => 'integer',
            'primary' => true,
            'autocomplete' => true,
            'title' => "ID",
         ),
         'PARSER_ID' => array(
            'data_type' => 'integer',
            'title' => "PARSER_ID",
         ),         
         'PRODUCT_ID' => array(
            'data_type' => 'integer',
            'title' => "PRODUCT_ID",
         ),
      );
   }
}
?>57   2974|/shs.parser/classes/general/list_parser.php|acb8f02c<?
IncludeModuleLangFile(__FILE__);
Class ShsParserContentGeneral{
    function CheckFields($arFields, $ID)
	{
		global $DB;
		$this->LAST_ERROR = "";
		$aMsg = array();

		if(array_key_exists("NAME", $arFields))
		{
			if(strlen($arFields["NAME"])<=0)
				$aMsg[] = array("id"=>"NAME", "text"=>GetMessage("class_parser_err_name"));
		}

        if(array_key_exists("RSS", $arFields))
		{
			if(strlen($arFields["RSS"])<=0)
				$aMsg[] = array("id"=>"RSS", "text"=>GetMessage("class_parser_err_rss"));
		}

		if(array_key_exists("SORT", $arFields))
		{
			if(!preg_match('/^\d+$/', $arFields['SORT']))
				$aMsg[] = array("id"=>"SORT", "text"=>GetMessage("class_parser_err_sort"));
		}

		if(array_key_exists("IBLOCK_ID", $arFields))
		{
			if(strlen($arFields["IBLOCK_ID"])<=0)
				$aMsg[] = array("id"=>"IBLOCK_ID", "text"=>GetMessage("class_parser_err_iblock"));
		}

        if(array_key_exists("TIME_AGENT", $arFields))
		{
			if(($arFields['START_AGENT']=="Y" && !empty($arFields["TIME_AGENT"]) && preg_match('/\D/', $arFields["TIME_AGENT"])) || ($arFields['START_AGENT']=="Y" && empty($arFields["TIME_AGENT"])))
				$aMsg[] = array("id"=>"IBLOCK_ID", "text"=>GetMessage("class_parser_err_time_agent"));
		}
        if(array_key_exists("SETTINGS", $arFields))
        {
            $arFields["SETTINGS"] = htmlspecialcharsEx($arFields["SETTINGS"]);
        }

		if(!empty($aMsg))
		{
			$e = new CAdminException($aMsg);
			$GLOBALS["APPLICATION"]->ThrowException($e);
			$this->LAST_ERROR = $e->GetString();
			return false;
		}

		return true;
	}


    function Update($ID, $arFields){
        global $DB, $USER;
		$ID = intval($ID);
        //print_r($arFields);
		if(!$this->CheckFields($arFields, $ID))
			return false;
		$strUpdate = $DB->PrepareUpdate("b_shs_parser", $arFields);
		if($strUpdate!="")
		{
			$strSql = "UPDATE b_shs_parser SET ".$strUpdate." WHERE ID=".$ID;
			$arBinds = array();
			if(!$DB->QueryBind($strSql, $arBinds))
				return false;
		}

		return true;
    }

    function Add($arFields)
	{
		global $DB;

		if(!$this->CheckFields($arFields))
			return false;

		$ID = $DB->Add("b_shs_parser", $arFields);

		return $ID;
	}

    function Delete($ID)
	{
		global $DB;
        CModule::IncludeModule("main");
		$ID = intval($ID);
        $arAgent = CAgent::GetList(array(), array("NAME"=>"CShsParser::startAgent(".$ID.");"))->Fetch();
        CAgent::Delete($arAgent["ID"]);
		$DB->StartTransaction();

		$res = $DB->Query("DELETE FROM b_shs_parser WHERE ID='".$ID."'", false, "File: ".__FILE__."<br>Line: ".__LINE__);

		if($res)
			$DB->Commit();
		else
			$DB->Rollback();

		return $res;
	}

    function GetByID($ID)
	{
		global $DB;
		$ID = intval($ID);

		$strSql = "SELECT P.* FROM b_shs_parser P WHERE P.ID = '".$ID."'";

		return $DB->Query($strSql, false, "File: ".__FILE__."<br>Line: ".__LINE__);
	}

}




?>60   214114|/shs.parser/classes/general/main_classes.php|d7034055<?
use Bitrix\Highloadblock as HL; 
use Bitrix\Main\Entity;
use Bitrix\Seo\Engine;
use Bitrix\Main\Text\Converter;
use Bitrix\Main\Localization\Loc;
use Bitrix\Main\IO\Path;

\Bitrix\Main\Loader::includeModule('seo');
\Bitrix\Main\Loader::includeModule('socialservices');

class SotbitContentParser{
    
    protected $id = false;
    protected $rss;
    protected $type;
    protected $active;
    protected $iblock_id;
    protected $section_id;
    protected $detail_dom;
    protected $encoding;
    protected $preview_delete_tag="";
    protected $bool_preview_delete_tag="";
    protected $detail_delete_tag="";
    protected $bool_detail_delete_tag="";
    protected $preview_first_img="";
    protected $detail_first_img="";
    protected $preview_save_img="";
    protected $detail_save_img="";
    protected $text = "";
    protected $site = "";
    protected $link = "";
    protected $preview_delete_element="";
    protected $detail_delete_element="";
    protected $preview_delete_attribute="";
    protected $detail_delete_attribute="";
    protected $index_element="";
    protected $resize_image="";
    protected $meta_description="";
    protected $meta_keywords="";
    protected $meta_description_text="";
    protected $meta_keywords_text="";
    protected $agent = false;
    protected $active_element = "Y";
    protected $header_url;
    protected $settings;
    protected $countPage = 0;
    protected $countItem = 0;
    protected $stepStart = false;

    protected $page;
    const TEST = 0;
    const DEFAULT_DEBUG_LIST = 3;
    const DEFAULT_DEBUG_ITEM = 3;
    public function __construct()
    {
        global $zis, $shs_ID, $shs_TYPE, $shs_ACTIVE, $shs_IBLOCK_ID, $shs_RSS, $shs_SECTION_ID, $shs_SELECTOR, $shs_ENCODING, $shs_PREVIEW_DELETE_TAG, $shs_PREVIEW_TEXT_TYPE, $shs_DETAIL_TEXT_TYPE, $shs_BOOL_PREVIEW_DELETE_TAG,$shs_PREVIEW_FIRST_IMG, $shs_PREVIEW_SAVE_IMG, $shs_DETAIL_DELETE_TAG, $shs_BOOL_DETAIL_DELETE_TAG,$shs_DETAIL_FIRST_IMG, $shs_DETAIL_SAVE_IMG, $shs_PREVIEW_DELETE_ELEMENT, $shs_DETAIL_DELETE_ELEMENT, $shs_PREVIEW_DELETE_ATTRIBUTE, $shs_DETAIL_DELETE_ATTRIBUTE, $shs_INDEX_ELEMENT, $shs_CODE_ELEMENT, $shs_RESIZE_IMAGE, $shs_META_DESCRIPTION, $shs_META_KEYWORDS, $shs_ACTIVE_ELEMENT, $shs_FIRST_TITLE, $shs_DATE_PUBLIC, $shs_FIRST_URL, $shs_DATE_ACTIVE, $shs_META_TITLE, $shs_SETTINGS, $shs_TMP;
        $this->id = $shs_ID;
        $this->type = $shs_TYPE;
        $this->rss = $shs_RSS;
        $this->active = $shs_ACTIVE;
        $this->iblock_id = $shs_IBLOCK_ID;
        $this->section_id = $shs_SECTION_ID;
        $this->detail_dom = $shs_SELECTOR;
        $this->first_url = trim($shs_FIRST_URL);
        $this->encoding = $shs_ENCODING;
        $this->preview_text_type = $shs_PREVIEW_TEXT_TYPE;
        $this->detail_text_type = $shs_DETAIL_TEXT_TYPE;
        $this->preview_delete_tag = $shs_PREVIEW_DELETE_TAG;
        $this->detail_delete_tag = $shs_DETAIL_DELETE_TAG;
        $this->bool_preview_delete_tag = $shs_BOOL_PREVIEW_DELETE_TAG;
        $this->bool_detail_delete_tag = $shs_BOOL_DETAIL_DELETE_TAG;
        $this->preview_first_img = $shs_PREVIEW_FIRST_IMG;
        $this->detail_first_img = $shs_DETAIL_FIRST_IMG;
        $this->preview_save_img = $shs_PREVIEW_SAVE_IMG;
        $this->detail_save_img = $shs_DETAIL_SAVE_IMG;
        $this->preview_delete_element = $shs_PREVIEW_DELETE_ELEMENT;
        $this->detail_delete_element = $shs_DETAIL_DELETE_ELEMENT;
        $this->preview_delete_attribute = $shs_PREVIEW_DELETE_ATTRIBUTE;
        $this->detail_delete_attribute = $shs_DETAIL_DELETE_ATTRIBUTE;
        $this->index_element = $shs_INDEX_ELEMENT;
        $this->code_element = $shs_CODE_ELEMENT;
        $this->resize_image = $shs_RESIZE_IMAGE;
        $this->meta_title = $shs_META_TITLE;
        $this->meta_description = $shs_META_DESCRIPTION;
        $this->meta_keywords = $shs_META_KEYWORDS;
        $this->active_element = $shs_ACTIVE_ELEMENT;
        $this->first_title = $shs_FIRST_TITLE;
        $this->date_public = $shs_DATE_PUBLIC;
        $this->date_active = $shs_DATE_ACTIVE;
        $this->tmp = $shs_TMP;
        $this->settings = unserialize(base64_decode($shs_SETTINGS));
        $this->header_url = "";
        $this->sleep = (int)$this->settings[$this->type]["sleep"];
        $this->proxy = (int)$this->settings[$this->type]["proxy"];
        $this->errors = array();
        $this->auth = $this->settings[$this->type]["auth"]["active"]?true:false;
        $this->currentPage = 0;
        $this->activeCurrentPage = 0;
        $this->debugErrors = array();
        $this->stepStart = false;
        $this->pagePrevElement = array();
        $this->pagenavigationPrev = array();
        $this->pagenavigation = array();
            
    }
    
    public function startParser($agent=false){
        global $DB, $shs_DEMO; //$agent = true;
        if($shs_DEMO==3) return;
        $this->createFolder();
        $this->createAlbum();
        if($this->active!="Y"){
          $result["ERROR"][] = GetMessage("parser_active_no");
          $this->errors[] = GetMessage("parser_active_no");
          if(!$agent)CAdminMessage::ShowMessage(GetMessage("parser_active_no"));
          return $result;
        }
        $parser = new ShsParserContent();
        $now = time()+CTimeZone::GetOffset();
        $arFieldsTime['START_LAST_TIME_X'] = date($DB->DateFormatToPHP(FORMAT_DATETIME), $now);
        $parser->Update($this->id, $arFieldsTime);
        $this->convetCyrillic($this->rss);

        if($this->meta_description!="N"){
            $propDescr = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->meta_description))->Fetch();
            if(!$propDescr){
                $result["ERROR"][] = GetMessage("parser_error_description");
                $this->errors[] = GetMessage("parser_error_description");
            }
        }
        if($this->meta_keywords!="N"){
            $propKey = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->meta_keywords))->Fetch();
            if(!$propKey){
                $result["ERROR"][] = GetMessage("parser_error_keywords");
                $this->errors[] = GetMessage("parser_error_keywords");
                //return $result;
            }
        }
        if($this->meta_title!="N"){
            $propKey = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->meta_title))->Fetch();
            if(!$propKey){
                $result["ERROR"][] = GetMessage("parser_error_title");
                $this->errors[] = GetMessage("parser_error_title");
                //return $result;
            }
        }
        if($this->first_title!="N"){
            $propFirst= CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->first_title))->Fetch();
            if(!$propFirst){
                $result["ERROR"][] = GetMessage("parser_error_first");
                $this->errors[] = GetMessage("parser_error_first");
                //return $result;
            }
        }
        if($this->date_public!="N"){
            $propDate= CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->date_public))->Fetch();
            if(!$propDate){
                $result["ERROR"][] = GetMessage("parser_error_date");
                $this->errors[] = GetMessage("parser_error_date");
                //return $result;
            }
        }


        if(isset($result['ERROR']))
        {
            if(!$agent)foreach($result['ERROR'] as $error) CAdminMessage::ShowMessage($error);
            return false;
        }
        $this->agent = $agent;
        if($shs_DEMO==2) $this->settings["catalog"]["mode"] = "debug";
        if($_GET["begin"])$this->auth(true);
        elseif($this->agent || $this->settings["catalog"]["mode"]=="debug") $this->auth(true);
        
        
        if($this->type=="catalog")
        {
            $this->isCatalog();
            $this->getUniqElement();
            $this->isUpdateElement();
            $this->GetSortFields();
            $this->getArrayIblock();
            $this->DoPageNavigation();
            $this->CheckFields($this->settings["catalog"]);
            
            if(!$this->errors)$this->parseCatalog();
            else{    
                if(!$agent)foreach($this->errors as $error) CAdminMessage::ShowMessage($error);
                $this->SaveLog();
                return false;
            } 
            if($this->debugErrors && $this->settings["catalog"]["mode"]=="debug")
            {
                if(!$agent)foreach($this->debugErrors as $error) CAdminMessage::ShowMessage($error);
                $this->SaveLog();
                return false;
            }
            return true;
        }

        $this->rss = str_replace(array('http://', 'www.', 'https://'), '', $this->rss);
        $arSite = explode('/', $this->rss);
        $level = explode('.', $arSite[0]);
        if(count($level)>=3) $this->rss = $this->rss;
        else $this->rss = 'www.'.$this->rss;
        $arSite = explode('/', $this->rss);
        $this->site = $arSite[0];
        $uri = preg_replace('/^(www\.){0,1}([a-zA-Z0-9-\.])+\//', '', $this->rss);
        $arPath = explode('?', $uri);
        $path = '/'.$arPath[0];
        $query = $arPath[1];   
        $arContent = $this->getContentsArray($this->site, 80, $path, $query);
        if(empty($arContent['title']) && empty($arContent['link'])){
            $arContent = $this->getContentsArray(str_replace("www.", "", $this->site), 80, $path, $query);
            if(empty($arContent['title']) && empty($arContent['link'])){
                $arContent = $this->getContentsArray("www.".$this->site, 80, $path, $query);
                if(empty($arContent['title']) && empty($arContent['link'])){
                    if(!$agent){
                        $result["ERROR"][] = GetMessage("parser_error");
                        $this->errors[] = GetMessage("parser_error");
                        //CAdminMessage::ShowMessage(GetMessage("parser_error"));
                        //return $result;
                    }
                    //return false;
                }
            }
        }
        if($this->errors)
        {
            if(!$agent)foreach($this->errors as $error) CAdminMessage::ShowMessage($error);
            if($this->type!="page")return false;
        }
        if(isset($result['ERROR']))
        {
            //if(!$agent)foreach($result['ERROR'] as $error) CAdminMessage::ShowMessage($error);
            if($this->type!="page")return false;
        }


        return $this->setContentIblock($arContent, $this->iblock_id, $this->section_id, $this->detail_dom, $this->encoding);
    }
    
    private function convetCyrillic(&$url)
    {
        if(preg_match("/^\/{2}www/", $url))
        {
            $url = preg_replace("/^\/{2}www/", "www", $url);
        }
        
        $converter = new sotbit_idna_convert();
        $url = $converter->encode($url); 
    }
    
    private function setContentIblock($arContent=array(), $iblock_id=false, $section_id=false, $detail_dom="", $encoding="utf-8"){
        $first = false;
        global $shs_preview, $shs_first, $DB, $shs_DEMO;
        set_time_limit(0);
        $this->setDemo();
        /*if($this->first_url)
        {
            if($this->first_url && strpos($this->header_url, $this->first_url)===false && strpos($item['link'], $this->first_url)==false) continue;
        }
        else */ 
        $count = count($arContent['item']);
        $ci = 0;  
        //printr($arContent);
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $count."|".$ci);
        foreach($arContent['item'] as $i=>$item){
            $item['title'] = trim($item['title']);
            //if($this->sleep && $this->sleep>0)sleep($this->sleep);
            $this->link = $item['link'];
            $item['link'] = str_replace('http://', '', $item['link']);
            $this->convetCyrillic($item['link']);
            if(!isset($this->settings[$this->type]["uniq"]) || $this->settings[$this->type]["uniq"]=="name")
            {
                if($item['title'] && isset($this->settings['loc']["f_name"]) && $this->settings['loc']["f_name"]=="Y")
                {
                    $item['title'] = $this->locText($item['title']);        
                }
                $isElement = CIBlockElement::GetList(Array(), array("NAME"=>$item['title'], "SECTION_ID"=>$section_id, "IBLOCK_ID"=>$iblock_id), false, Array("nTopCount"=>1), array("ID"))->Fetch();
            }
            else{
                $md5 = md5($item['link']);
                $isElement = CIBlockElement::GetList(Array(), array("XML_ID"=>$md5, "SECTION_ID"=>$section_id, "IBLOCK_ID"=>$iblock_id), false, Array("nTopCount"=>1), array("ID"))->Fetch();
            }
            
            
            $ci++;
            if($isElement && !self::TEST && $shs_DEMO==1) continue;
            $first = true;
            $item['description'] = trim($item['description']);
            
            
            $fileHtml = new FileGetHtml();
            $this->date_public_text = $item["pubDate"];
            $proxy = $this->proxy;
            
            $data = $fileHtml->file_get_html($item['link'], $proxy, $this->auth); 
            $this->header_url = $fileHtml->headerUrl;
            if($this->first_url && strpos($this->header_url, $this->first_url)===false && strpos($item['link'], $this->first_url)==false) continue;
            $shs_first = true;
            //preg_replace("/\<meta\s+charser=[\"|']{0,1}.+[\"|']{0,1}\s*\/{0,1}\>/ig")
            //print $data;
            $this->DeleteCharsetHtml5($data);
            $html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET);
            $shs_first = false;
            $this->first_title_text = $this->header_url;

            $this->getUrlSite();
            $DETAIL_TEXT = "";
            $this->text = "";

            $DETAIL_TEXT = $this->parserSelector($html, htmlspecialchars_decode(trim($detail_dom)));

            $el = new CIBlockElement;
            $shs_preview = true;
            if($this->preview_first_img=="Y") $PREVIEW_IMG = $this->parserFirstImg(phpQuery::newDocument($item['description']), "text/html;charset=".LANG_CHARSET);
            $shs_preview = false;
            if($this->detail_first_img=="Y") $DETAIL_IMG = $this->parserFirstImg(phpQuery::newDocument($DETAIL_TEXT), "text/html;charset=".LANG_CHARSET);
            
            $this->preview_delete_element = trim($this->preview_delete_element);
            $this->detail_delete_element = trim($this->detail_delete_element);
            $shs_preview = true;
            $preview_html = phpQuery::newDocument($item['description'], "text/html;charset=".LANG_CHARSET);
            $shs_preview = false;
            $detail_html = phpQuery::newDocument($DETAIL_TEXT, "text/html;charset=".LANG_CHARSET);
            if(!empty($this->preview_delete_element)){
                $preview_html = $this->deleteElementStart($preview_html, htmlspecialchars_decode($this->preview_delete_element));
            }
            if(!empty($this->detail_delete_element)){
                $detail_html = $this->deleteElementStart($detail_html, htmlspecialchars_decode($this->detail_delete_element));
            }
            if(!empty($this->preview_delete_attribute)){
                $preview_html = $this->deleteAttributeStart($preview_html, htmlspecialchars_decode($this->preview_delete_attribute));
            }
            if(!empty($this->detail_delete_attribute)){
                $detail_html = $this->deleteAttributeStart($detail_html, htmlspecialchars_decode($this->detail_delete_attribute));
            }
            
            
            
            
            $detail_html = $this->changeImgSrc($detail_html);
            $preview_html = $this->changeImgSrc($preview_html);

            if($this->preview_save_img=="Y") $item['description'] = $this->saveImgServer($preview_html);
            else $item['description'] = $preview_html->htmlOuter();
            if($this->detail_save_img=="Y") $DETAIL_TEXT = $this->saveImgServer($detail_html);
            else $DETAIL_TEXT = $detail_html->htmlOuter();
            $item['description'] = preg_replace("/\<meta(.)+\>{1}/", "", $item['description']);
            $DETAIL_TEXT = preg_replace("/\<meta(.)+\>{1}/", "", $DETAIL_TEXT);

            if($this->code_element=="Y")$code = $arProperty["CODE"] = CUtil::translit($item['title'], "ru", array(
                        "max_len" => 100,
                        "change_case" => 'L', // 'L' - toLower, 'U' - toUpper, false - do not change
                        "replace_space" => '_',
                        "replace_other" => '_',
                        "delete_repeat_replace" => true,
            ));
            if($this->date_public_text)$unix = strtotime($this->date_public_text);
            if($this->date_active=="NOW") $date_from = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "SHORT");
            elseif($this->date_active=="NOW_TIME") $date_from = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "FULL");
            elseif($this->date_active=="PUBLIC" && $unix) $date_from = ConvertTimeStamp($unix, "FULL");
            
            
            if(!empty($this->preview_delete_tag) && $this->bool_preview_delete_tag=="Y"){
                $item['description'] = strip_tags($item['description'], htmlspecialchars_decode($this->preview_delete_tag));
            }elseif($this->bool_preview_delete_tag=="Y") $item['description'] = strip_tags($item['description']);
            if(!empty($this->detail_delete_tag) && $this->bool_detail_delete_tag=="Y"){
                $DETAIL_TEXT = strip_tags($DETAIL_TEXT, htmlspecialchars_decode($this->detail_delete_tag));
            }elseif($this->bool_detail_delete_tag=="Y")
            {
                $DETAIL_TEXT = strip_tags($DETAIL_TEXT);
            }
            $item['description'] = trim($item['description']);
            $DETAIL_TEXT = trim($DETAIL_TEXT);
            
            if($item['title'] && isset($this->settings['loc']["f_name"]) && $this->settings['loc']["f_name"]=="Y" && $this->settings[$this->type]["uniq"]=="url")
            {
                $item['title'] = $this->locText($item['title']);        
            }
            if($item['description'] && isset($this->settings['loc']["f_preview_text"]) && $this->settings['loc']["f_preview_text"]=="Y")
            {
                $item['description'] = $this->locText($item['description'], $this->preview_text_type=="html"?"html":"plain");        
            }
            if($DETAIL_TEXT && isset($this->settings['loc']["f_detail_text"]) && $this->settings['loc']["f_detail_text"]=="Y")
            {   
                $DETAIL_TEXT = $this->locText($DETAIL_TEXT, $this->detail_text_type=="html"?"html":"plain", true);
                //printr(array("DET"=>$DETAIL_TEXT));        
            }

            $arLoadProductArray = Array(
                "MODIFIED_BY"    => 1, //    
                "IBLOCK_SECTION_ID" => $this->section_id,          //     
                "DATE_ACTIVE_FROM" => $date_from,
                "IBLOCK_ID"      => $this->iblock_id,
                "NAME"           => $item['title'],
                "ACTIVE"         => $this->active_element=="Y"?"Y":"N",            // 
                "PREVIEW_TEXT"   => $item['description'],
                "PREVIEW_TEXT_TYPE"  => $this->preview_text_type,
                "DETAIL_TEXT"    => $DETAIL_TEXT,
                "DETAIL_TEXT_TYPE"    => $this->detail_text_type,
                "CODE" => $code?$code:""
            );
            if(isset($md5))
            {
                $arLoadProductArray["XML_ID"] = $md5;
                unset($md5);    
            }
             

            if(empty($PREVIEW_IMG) && $this->preview_first_img=="Y") $PREVIEW_IMG = $this->filterSrc($this->parseImgFromRss($item));
            
            if($this->preview_first_img=="Y")
            {
                $this->convetCyrillic($PREVIEW_IMG);
                $arLoadProductArray['PREVIEW_PICTURE'] = CFile::MakeFileArray($PREVIEW_IMG);
            }
             
            if($this->detail_first_img=="Y")
            {
                $this->convetCyrillic($DETAIL_IMG);
                $arLoadProductArray['DETAIL_PICTURE'] = CFile::MakeFileArray($DETAIL_IMG);
            }
             
            if($this->date_public!="N" && $this->date_public_text)
            {
                $new_date = date($DB->DateFormatToPHP(FORMAT_DATETIME), $unix);
                $arLoadProductArray['PROPERTY_VALUES'][$this->date_public] = $new_date;
            }
            if($this->first_title!="N")$arLoadProductArray['PROPERTY_VALUES'][$this->first_title] = $this->first_title_text;
            if($this->meta_title!="N" && $this->meta_title_text)
            {
                if(isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"]=="Y")
                    $this->meta_title_text = $this->locText($this->meta_title_text);    
                $arLoadProductArray['PROPERTY_VALUES'][$this->meta_title] = $this->meta_title_text;    
            }
            if($this->meta_description!="N" && $this->meta_description)
            {
                if(isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"]=="Y")
                    $this->meta_description = $this->locText($this->meta_description);
                
                $arLoadProductArray['PROPERTY_VALUES'][$this->meta_description] = $this->meta_description_text;    
            }
            if($this->meta_keywords!="N" && $this->meta_keywords)
            {
                if(isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"]=="Y")
                    $this->meta_keywords = $this->locText($this->meta_keywords);
                
                $arLoadProductArray['PROPERTY_VALUES'][$this->meta_keywords] = $this->meta_keywords_text;    
            }
            
            
            $this->addSeoUniqYandex($arLoadProductArray);
            
            if($PRODUCT_ID = $el->Add($arLoadProductArray, false, $this->index_element=="Y"?true:false, $this->resize_image=="Y"?true:false)){
                $elem[]= ' '.$PRODUCT_ID;
            }
            elseif(!$this->agent){
                $result[ERROR][] = $el->LAST_ERROR;
            }

            $el = null;
            $isElement = null;
            if(isset($preview_html)){
                unset($preview_html);
            }
            if(isset($detail_html)){
                unset($detail_html);
            }
            unset($html);
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $count."|".$ci);
            unset($fileHtml);
            if(self::TEST || $shs_DEMO==2)break;
            if($this->sleep && $this->sleep>0)sleep($this->sleep);

        }
        unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt");
        if($elem){
            $message = implode(',', $elem);
            $message = GetMessage("parser_pars_el_ok").' '.$message.' '.GetMessage("parser_pars_create_ok");
        }
        if($first && !$this->agent){
            $result[SUCCESS][] = $message;
        }
        elseif(!$this->agent){
            $result[ERROR][] = GetMessage("parser_no");
        }
        if(!$this->agent)
        {
            if(isset($result[SUCCESS]) && count($result[SUCCESS])>0)
            {
                foreach($result['SUCCESS'] as $success) CAdminMessage::ShowMessage(array("MESSAGE"=>$success, "TYPE"=>"OK"));
            }
            if(isset($result[ERROR]) && count($result[ERROR])>0)
            {
                foreach($result['ERROR'] as $error) CAdminMessage::ShowMessage($error);
            }
        }
        return $result;
    }
    
    public function GetAuthForm($check=false)
    {   
        if(isset($this->settings[$this->type]["auth"]["active"]) && $this->settings[$this->type]["auth"]["active"]!="Y") return false;
        elseif(!isset($this->settings[$this->type]["auth"]["active"])) return false;
        elseif(isset($this->settings[$this->type]["auth"]["selector"]) && !$this->settings[$this->type]["auth"]["selector"])
        {
            $this->errors[] = GetMessage("parser_auth_error_selector");
            return false;    
        }
         
        
        $url = $this->settings[$this->type]["auth"]["url"]?$this->settings["catalog"]["auth"]["url"]:$this->rss;
        $form = $this->settings[$this->type]["auth"]["selector"];
        $proxy = $this->settings[$this->type]["proxy"];
        
        $auth = new FileGetHtml();
        $data = $auth->file_get_html($url, $proxy);
        $this->urlCatalog = $auth->headerUrl;
        $this->urlSite = $this->getCatalogUrlSite();
        
        $this->CheckAuthForm($data, $form, $proxy);
        
        if($check)if(isset($this->errors) && count(isset($this->errors))>0)
        {
            foreach($this->errors as $error)
            {
                if(isset($_POST["auth"]))CAdminMessage::ShowMessage($error);
            }
        }
        if($check)if(isset($this->success) && count(isset($this->success))>0)
        {
            foreach($this->success as $success)
            {
                if(isset($_POST["auth"]))CAdminMessage::ShowMessage(array("MESSAGE"=>$success, "TYPE"=>"OK"));    
            }
        }
            
    }
    
    public function CheckAuthform($data, $form, $proxy)
    {   
        $this->html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET); 
        //print pq($this->html)->html();
        $objForm = pq($this->html)->find($form);
        $url = $objForm->attr("action");
        $url = empty($url)?$this->urlCatalog:$this->getCatalogLink($url);
        
        $login = trim($this->settings[$this->type]["auth"]["login"]);
        $password = trim($this->settings[$this->type]["auth"]["password"]);
        foreach($this->html[$form." input"] as $input)
        {
            $name = trim(pq($input)->attr("name"));
            $value = trim(pq($input)->attr("value"));
            $type = trim(pq($input)->attr("type"));
            if(isset($this->settings[$this->type]["auth"]["password_name"]) && !empty($this->settings[$this->type]["auth"]["password_name"]) && $name==$this->settings[$this->type]["auth"]["password_name"])
            {
                //if($name==$this->settings[$this->type]["auth"]["password_name"])
                {
                    $arInput[$name] = $password;
                    continue;    
                }    
            }
            elseif(isset($this->settings[$this->type]["auth"]["login_name"]) && !empty($this->settings[$this->type]["auth"]["login_name"]) && $name==$this->settings[$this->type]["auth"]["login_name"])
            {
                //if($name==$this->settings[$this->type]["auth"]["login_name"])
                {
                    $arInput[$name] = $login;
                    continue;    
                }    
            }
            elseif($type=="password")
            {
                $arInput[$name] = $password;
                continue;        
            }
            elseif($type=="text" || $type=="email"){
                $arInput[$name] = $login;
                continue;    
            } 
            $arInput[$name] = $value;
        }
        if(isset($arInput))$this->doAuth($url, $arInput, $proxy);
        else{
            $this->errors[] = GetMessage("parser_auth_error_selector");    
        }
    }
    
    protected function doAuth($url, $arInput, $proxy)
    {
        $auth = new FileGetHtml();
        $data = $auth->auth($url, $proxy, $arInput, true);
        //if(isset($_POST["auth"]))
        $this->AdminAuth($data);
    }
    
    protected function AdminAuth($data)
    {
        $form = $this->settings[$this->type]["auth"]["selector"];
        $this->html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET);
        $passw = false;
        foreach($this->html[$form." input"] as $input)
        {
            $type = pq($input)->attr("type");
            if($type=="password")
            {
                $passw = true;    
            }
        } 
        
        if($passw)
            $this->errors[] = GetMessage("parser_auth_no");
        else
            $this->success[] = GetMessage("parser_auth_ok");
    }
    
    protected function DoPageNavigation()
    {
        $begin = $this->settings["catalog"]["pagenavigation_begin"];
        $end = $this->settings["catalog"]["pagenavigation_end"];
        $this->arPageNavigationDelta[0] = $begin;
        $this->arPageNavigationDelta[1] = $end;
    }

    protected function ValidatePageNavigation($n)
    {
        $n = strip_tags($n);
        $n = preg_replace("/\D/", "", $n);
        return $n;
    }
    //    
    protected function CheckPageNavigation($n)
    {
        if(!preg_match("/\d/", $n) || empty($n)) return false;
        if($this->currentPage>$n) return false;
        if($this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n>=$this->arPageNavigationDelta[0] && $n<=$this->arPageNavigationDelta[1]) return $n;
        }elseif($this->arPageNavigationDelta[0] && !$this->arPageNavigationDelta[1])
        {
            if($n>=$this->arPageNavigationDelta[0]) return $n;
        }elseif(!$this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[1]) return $n;
        }
        return false;
    }
    
    protected function CheckPageNavigationLess($n)
    {
        if(!preg_match("/\d/", $n) || empty($n)) return false;
        
        if($this->currentPage>$n) return false;

        if($this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[1]) return $n;
        }elseif(!$this->arPageNavigationDelta[1]) return true;
        return false;
    }

    protected function CheckValidatePageNavigation($n)
    {
        if($this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[0] && $n<=$this->arPageNavigationDelta[1]) return true;
        }elseif($this->arPageNavigationDelta[0] && !$this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[0] && $n<=100000) return true;
        }elseif(!$this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[1]) return true;
        }
    }

    protected function CheckOnePageNavigation()
    {
        if($this->settings["catalog"]["pagenavigation_begin"]==1 && $this->settings["catalog"]["pagenavigation_end"]==1)
        {
            return true;
        }elseif(!$this->settings["catalog"]["pagenavigation_selector"] && (!isset($this->settings["catalog"]["pagenavigation_var"]) || !$this->settings["catalog"]["pagenavigation_var"])) return true;
        
        return false;
    }
    
    protected function CheckAlonePageNavigation($n)
    {   
        if(!empty($this->settings["catalog"]["pagenavigation_begin"]) && !empty($this->settings["catalog"]["pagenavigation_end"]) && $this->settings["catalog"]["pagenavigation_end"]==$this->settings["catalog"]["pagenavigation_begin"] && $n==$this->settings["catalog"]["pagenavigation_begin"])
        {
            return true;
        }
        
        return false;
    }

    protected function IsNumberPageNavigation()
    {
        if(!$this->settings["catalog"]["pagenavigation_begin"] && !$this->settings["catalog"]["pagenavigation_end"]) return false;
        else return true;
    }
    
    protected function DeleteLog()
    {
        if($this->agent)unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog".$this->id.".txt");    
    }
    
    protected function SaveLog()
    {
        if($this->settings["catalog"]["log"]=="Y" && isset($this->errors) && count($this->errors)>0)
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$this->id.".txt", print_r($this->errors, true), FILE_APPEND);
            
        if(!isset($this->errors)) $this->errors = array();
        $this->debugErrors = array_merge($this->debugErrors, $this->errors);
    }

    protected function isUpdateElement()
    {
        $this->updateActive = false;
        if($this->settings["catalog"]["update"]["active"])
        {
            unset($this->settings["catalog"]["update"]["active"]);
            $this->updateActive = true;
            foreach($this->settings["catalog"]["update"] as $id=>$val)
            {
                if($val=="Y" || $val=="empty") $this->isUpdate[$id] = $val;
            }
            if(!isset($this->isUpdate) || !$this->isUpdate) $this->isUpdate = false;
        }else  $this->isUpdate = false;
    }

    protected function getUniqElement()
    {
        //if($this->settings["catalog"]["update"]["active"]=="Y")
        {
            $this->uniqFields["NAME"] = "NAME";
            $this->uniqFields["LINK"] = "LINK";

            if($this->settings["catalog"]["uniq"]["prop"])
            {
                unset($this->uniqFields["LINK"]);
                unset($this->uniqFields["NAME"]);
                $prop = $this->settings["catalog"]["uniq"]["prop"];
                $this->uniqFields[$prop] = $prop;
            }
            if($this->settings["catalog"]["uniq"]["name"])
            {
                unset($this->uniqFields["LINK"]);
                unset($this->uniqFields["NAME"]);
                $this->uniqFields["NAME"] = "NAME";
            }
        }
    }
    
    protected function GetSortFields()
    {
        $this->arSortUpdate = array();
        $this->arEmptyUpdate = array();
        if($this->isUpdate)
        {
            foreach($this->isUpdate as $id=>$val)
            {
                if($val!="empty") continue;
                if($id=="preview_img") $this->arSortUpdate[] = "PREVIEW_PICTURE";
                elseif($id=="detail_img") $this->arSortUpdate[] = "DETAIL_PICTURE";
                elseif($id=="preview_descr") $this->arSortUpdate[] = "PREVIEW_TEXT";
                elseif($id=="detail_descr") $this->arSortUpdate[] = "DETAIL_TEXT";
            }
        }    
    }

    protected function checkUniq()
    {   
        if($this->elementUpdate) return $this->elementUpdate;
        if(!isset($this->arSortUpdate)) $this->arSortUpdate = array();
        
        if(isset($this->uniqFields["LINK"]) && $this->uniqFields["LINK"] && isset($this->arFields["NAME"]) && $this->arFields["NAME"])
        {
            $uniq = md5($this->arFields["NAME"].$this->arFields["LINK"]);
            $isElement = CIBlockElement::GetList(Array(), array("XML_ID"=>$uniq, "IBLOCK_ID"=>$this->iblock_id), false, Array("nTopCount"=>1), array_merge(array("ID"), $this->arSortUpdate))->Fetch();
            $this->elementUpdate = $isElement["ID"];
            if($isElement)
            {
                $this->arEmptyUpdate = $isElement;
                return $isElement["ID"];
            }
            else return false;
        }else{
            if($this->settings["catalog"]["uniq"]["prop"])
            {
                $prop = $this->settings["catalog"]["uniq"]["prop"];
                if($this->arFields["PROPERTY_VALUES"][$prop])$arFields["PROPERTY_".$prop] = $this->arFields["PROPERTY_VALUES"][$prop];
            }
            if($this->settings["catalog"]["uniq"]["name"])
            {
                $prop = $this->settings["catalog"]["uniq"]["prop"];
                if($this->arFields["NAME"])$arFields["NAME"] = $this->arFields["NAME"];
            }
            if(count($arFields)==count($this->uniqFields))$isElement = CIBlockElement::GetList(Array(), array_merge(array("IBLOCK_ID"=>$this->iblock_id), $arFields), false, Array("nTopCount"=>1), array_merge(array("ID"), $this->arSortUpdate))->Fetch();
            $this->elementUpdate = $isElement["ID"];
            if($isElement)
            {
                $this->arEmptyUpdate = $isElement;
                return $isElement["ID"];
            }
            else return false;
        }

        return false;
    }
    
    protected function checkOfferUniq()
    {
        if($this->elementOfferUpdate) return $this->elementOfferUpdate;
        
        $uniq = "offer#".md5($this->arFields["NAME"].$this->arFields["LINK"]);
        $isElement = CIBlockElement::GetList(Array(), array("XML_ID"=>$uniq, "IBLOCK_ID"=>$this->offerArray["IBLOCK_ID"]), false, Array("nTopCount"=>1), array("ID"))->Fetch();
        $this->elementOfferUpdate = $isElement["ID"];
        if($isElement) return $isElement["ID"];
        else return false;
    }
    
    protected function checkOfferUniqTable($arFields)
    {
        if($this->elementOfferUpdate) return $this->elementOfferUpdate;
        
        $uniq = "offer#".md5($this->arFields["LINK"].$arFields["NAME"]);
        $isElement = CIBlockElement::GetList(Array(), array("XML_ID"=>$uniq, "IBLOCK_ID"=>$this->offerArray["IBLOCK_ID"]), false, Array("nTopCount"=>1), array("ID"))->Fetch();
        $this->elementOfferUpdate = $isElement["ID"];
        if($isElement) return $isElement["ID"];
        else return false;
    }

    protected function isCatalog()
    {
        $this->isOfferCatalog = false;
        $this->isOfferParsing = false;
        $this->iblockOffer = 0;
        if(CModule::IncludeModule('catalog') && ($this->iblock_id && CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y", "ID"=>$this->iblock_id))->Fetch()))
        {
            if($this->settings["catalog"]["preview_price"] || $this->settings["catalog"]["detail_price"])
            {
                $this->isCatalog = true;
            }else $this->isCatalog = false;
        }else $this->isCatalog = false;
        if(CModule::IncludeModule('catalog') && isset($this->settings["catalog"]["cat_vat_price_offer"]) && $this->settings["catalog"]["cat_vat_price_offer"]=="Y")
        {
            $arIblock = CCatalogSKU::GetInfoByIBlock($this->iblock_id);
            if(is_array($arIblock) && !empty($arIblock) && $arIblock["PRODUCT_IBLOCK_ID"]!=0 && $arIblock["SKU_PROPERTY_ID"]!=0)
            {
                $this->isOfferCatalog = true;
                $this->offerArray = $arIblock;
                $this->isCatalog = true;            
            }else $this->isOfferCatalog = false;    
        }
        if(CModule::IncludeModule('catalog') && isset($this->settings["offer"]["load"]) && $this->settings["offer"]["load"])
        {
            if(!isset($this->settings["catalog"]["cat_vat_price_offer"]) || isset($this->settings["catalog"]["cat_vat_price_offer"]) && $this->settings["catalog"]["cat_vat_price_offer"]!="Y")
            {
                $arIblock = CCatalogSKU::GetInfoByIBlock($this->iblock_id);
            }
            
            if(is_array($arIblock) && !empty($arIblock) && $arIblock["PRODUCT_IBLOCK_ID"]!=0 && $arIblock["SKU_PROPERTY_ID"]!=0 && $arIblock["IBLOCK_ID"])
            {
                $this->offerArray = $arIblock;
                $this->isCatalog = true;
                $this->isOfferParsing = true;
                if($arIblock["IBLOCK_ID"] && $arIblock["PRODUCT_IBLOCK_ID"])
                    $this->iblockOffer = $arIblock["IBLOCK_ID"];
                           
            }else $this->isOfferParsing = false; 
        }
        
        
    }

    protected function CheckFields($settings)
    {   
        if(preg_match("/\D/", $settings["pagenavigation_begin"]) && $settings["pagenavigation_begin"]!="")
        {
            $this->errors[] = GetMessage("parser_error_pagenavigation_begin");
        }
        if(preg_match("/\D/", $settings["pagenavigation_end"]) && $settings["pagenavigation_end"]!="")
        {
            $this->errors[] = GetMessage("parser_error_pagenavigation_end");
        }
        if(preg_match("/\D/", $settings["step"]))
        {
            $this->errors[] = GetMessage("parser_error_step");
        }
        
        if(is_array($settings["price_updown"]))
        {
            foreach($settings["price_updown"] as $i=>$val)
            {
                if($settings["price_updown"][$i])
                {
                    if($settings["price_terms"][$i] && !self::isFloat($settings["price_terms_value"][$i]))
                    {       
                        $this->errors[] = GetMessage("parser_error_price_terms_value");    
                    }
                    if($settings["price_terms"][$i] && !self::isFloat($settings["price_terms_value_to"][$i]))
                    {       
                        $this->errors[] = GetMessage("parser_error_price_terms_value");    
                    } 
                    if($settings["price_updown"][$i] && !self::isFloat($settings["price_value"][$i]))
                    {
                        $this->errors[] = GetMessage("parser_error_price_value");    
                    }   
                }    
            }    
        }
        
        
        

        $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id));
        while ($prop_fields = $properties->GetNext())
        {
            $this->arProperties[$prop_fields["CODE"]] = $prop_fields;
        }
        
        if($this->iblockOffer)
        {
            $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblockOffer));
            while ($prop_fields = $properties->GetNext())
            {
                $this->arPropertiesOffer[$prop_fields["CODE"]] = $prop_fields;
            }    
        }

        $this->arSelectorProduct = $this->getSelectorProduct();
        $this->arFindProduct = $this->getFindProduct();
        $this->arSelectorProperties = $this->getSelectorProperties();
        $this->arSelectorPropertiesOffer = $this->getSelectorPropertiesOffer();
        $this->arFindProperties = $this->getFindProperties();
        $this->arFindPropertiesOffer = $this->getFindPropertiesOffer();
        $this->arDubleFindProperties = $this->getFindDubleProperties();
        $this->arDubleFindPropertiesOffer = $this->getFindDublePropertiesOffer();
        
        $this->arSelectorPropertiesPreview = $this->getSelectorPropertiesPreview();
        $this->arFindPropertiesPreview = $this->getFindPropertiesPreview();
        $this->arDubleFindPropertiesPreview = $this->getFindDublePropertiesPreview();
        //printr($this->ArDubleFindProperties);
    }
    
    protected function isFloat($n)
    {
        if(preg_match("/^(?:\+|\-)?(?:(?:\d+)|(?:\d+\.)|(?:\.\d+)|(?:\d+\.\d+)){1}(?:e(?:\+|\-)?\d+)?$/i", $n)) return true;
        else return false;
    }


    protected function parseCatalog()
    {   
        set_time_limit(0);
        $this->ClearAjaxFiles();
        $this->DeleteLog();
        $this->checkActionBegin(); 
        $this->arUrl = array();
        if(isset($this->settings["catalog"]["url_dop"]) && !empty($this->settings["catalog"]["url_dop"]))$this->arUrl = explode("\r\n", $this->settings["catalog"]["url_dop"]);
        
        $this->arUrl = array_merge(array($this->rss), $this->arUrl);
        $this->arUrlSave = $this->arUrl;
        
        if(!$this->PageFromFile()) return false;
        $this->CalculateStep();
        if($this->settings["catalog"]["mode"]!="debug" && !$this->agent) $this->arUrlSave = array($this->rss);
        else $this->arUrlSave = $this->arUrl; 
        //if(!$this->connectCatalogPage($this->rss));
        //return;
        foreach($this->arUrlSave as $rss):
            $rss = trim($rss);
            if(empty($rss)) continue;
            $this->rss = $rss;
            $this->convetCyrillic($this->rss); 
            $this->connectCatalogPage($this->rss);
            if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && isset($this->errors) && count($this->errors)>0)
            {
                $this->SaveLog();
                unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt");
                return false;    
            }
        
            $this->parseCatalogNavigation($this->rss);
            $n = $this->currentPage;
            if(!$this->IsNumberPageNavigation())
            {   
                $this->parseCatalogProducts();
            }elseif($this->IsNumberPageNavigation() && $this->CheckPageNavigation($n))
            {   
                $this->parseCatalogProducts();
            }elseif($this->settings["catalog"]["mode"]!="debug" && !$this->agent)
            {
                $this->stepStart = true;
                $this->SavePrevPage($this->rss);    
            }
         
            $this->SaveCurrentPage($this->pagenavigation);
            if($this->stepStart)
            {
                if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
                    unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                $this->DeleteCopyPage();
            } 
            if((!$this->CheckOnePageNavigation() && $this->agent) || (!$this->CheckOnePageNavigation() && !$this->agent && $this->settings["catalog"]["mode"]=="debug"))$this->parseCatalogPages();
            if($this->CheckOnePageNavigation() && $this->stepStart)
            {
                if($this->IsEndSectionUrl())$this->ClearBufferStop();
                else $this->ClearBufferStep();
                return false;    
            }
        endforeach;
        
        $this->checkActionAgent();
    }
    
    protected function PageFromFile()
    {
        if($this->settings["catalog"]["mode"]=="debug" || $this->agent || $_GET["begin"]) return true;
        $prevPage = $prevElement = $currentPage = 0;
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt"))
            $prevPage = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt");
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt"))
            $prevElement = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt");
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt"))
            $currentPage = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt");
        
        if($prevPage)
        {
            $arPrevPage = explode("|", $prevPage);
            $arPrevElement = explode("|", $prevElement);
            $arCurrentPage = explode("|", $currentPage);    
        }else{
            $arPrevPage = array();
            $arCurrentPage = array();
        }
        
        if(isset($arPrevElement) && is_array($arPrevElement))foreach($arPrevElement as $i=>$p)
        {
            $p = trim($p);
            if(empty($p)) continue;
            $this->pagePrevElement[$p] = $p;
        }
        
        if(!$_GET["begin"] && !$prevPage) return true;
        
        if(isset($arPrevPage) && is_array($arPrevPage))foreach($arPrevPage as $i=>$p)
        {
            $p = trim($p);
            if(empty($p)) continue;
            $this->pagenavigationPrev[$p] = $p;
        }
        
        
        if(isset($arCurrentPage) && is_array($arCurrentPage))foreach($arCurrentPage as $p)
        {
            $p = trim($p);
            if(empty($p)) continue;
            $this->pagenavigation[$p] = $p;    
        }
        
        if(isset($this->pagenavigationPrev) && is_array($this->pagenavigationPrev))foreach($this->pagenavigationPrev as $i=>$v)
        {
            foreach($this->pagenavigation as $i1=>$v1)
            {
                if($v1==$v) unset($this->pagenavigation[$i1]);   
            }
        }
        
        if(isset($this->pagenavigation) && is_array($this->pagenavigation))foreach($this->pagenavigation as $p)
        {
            $isContinue = true;
            $this->rss = $p;
            break;
        }
        if(!$isContinue && !empty($this->pagenavigationPrev) && $this->IsEndSectionUrl())
        {
                 
            //if($this->IsEndSectionUrl())
            $this->ClearBufferStop();
            //else $this->ClearBufferStep();
            return false;
        }elseif(!$isContinue && !empty($this->pagenavigationPrev) && !$this->IsEndSectionUrl())
        {
            $isContinue = true;
            $this->rss = $this->GetUrlRss();        
        }
         
        $this->currentPage = count($this->pagenavigationPrev);
        if($this->IsNumberPageNavigation() && $this->CheckPageNavigation($this->currentPage))
        {
            
            $this->activeCurrentPage = $this->currentPage-$this->arPageNavigationDelta[0]+1;
        }elseif(!$this->IsNumberPageNavigation()) $this->activeCurrentPage = $this->currentPage;
        return true;
    }
    
    protected function IsEndSectionUrl()
    {
        if(!isset($this->settings["catalog"]["url_dop"]) || empty($this->settings["catalog"]["url_dop"]) || empty($this->arUrl)) return true;
        $count = 0;
        foreach($this->arUrl as $i=>$url)
        {
            if(isset($this->pagenavigationPrev[$url])) $count++;   
        }
        if($count==count($this->arUrl)) return true;
        else return false;
    }
    
    protected function GetUrlRss()
    {
        foreach($this->arUrl as $i=>$url)
        {
            if(isset($this->pagenavigationPrev[$url])) continue;
            return $url;
        }        
    }
    
    protected function ClearBufferStop()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            global $APPLICATION;
            //if(self::TEST==0)
            $APPLICATION->RestartBuffer();
            $this->checkActionAgent(false);
            die("stop");    
        }
    }
    
    protected function ClearBufferStep()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            global $APPLICATION;
            if(self::TEST==0)$APPLICATION->RestartBuffer();
            die();    
        }
    }

    protected function parseCatalogProducts()
    {
        $count = 0;
        
        $this->activeCurrentPage++;
        $this->SetCatalogElementsResult($this->activeCurrentPage);
        
        $element = $this->settings["catalog"]["selector"];

        if($this->preview_delete_element)$this->deleteCatalogElement($this->preview_delete_element, $element, $this->html[$element]);
        if($this->preview_delete_attribute)$this->deleteCatalogAttribute($this->preview_delete_attribute, $element, $this->html[$element]);
        $i = 0;
        $ci = 0;
        
        foreach($this->html[$element] as $el)
        {
            $count++;    
        }
        
        if($this->settings["catalog"]["mode"]!="debug" && !$this->agent)
        {
            if($count>$this->settings["catalog"]["step"] && ($this->settings["catalog"]["mode"]!="debug" && !$this->agent))
                $countStep = $this->settings["catalog"]["step"];
            else{
                $this->stepStart = true;
                if($this->CheckOnePageNavigation() || $this->CheckAlonePageNavigation($this->currentPage)) $this->pagenavigation[$this->rss] = $this->rss;
                $this->SaveCurrentPage($this->pagenavigation);
                $this->SavePrevPage($this->sectionPage);
                $countStep = $count;
            }    
        }else{
            $countStep = $count;    
        }
            
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $countStep."|".$ci);    
        
        if($count==0)
        {
            $this->errors[] = GetMessage("parser_error_selector_notfound")."[".$element."]";
            $this->clearFields();
            //die();
        }
       
        foreach($this->html[$element] as $el)
        {
            $ci++;
            if($this->StepContinue($ci, $count)) continue;
            if($i==self::DEFAULT_DEBUG_ITEM && $this->settings["catalog"]["mode"]=="debug") break;
            $this->parseCatalogProductElement($el);
            
            $i++;
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $countStep."|".$i);
            $this->CalculateStep($count);
            
        }
        unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt");
    }

    protected function parseCatalogProductElement(&$el)
    {
        $this->countItem++;
        if(!$this->parserCatalogPreview($el))
        {
            //$this->SaveLog();
            $this->SaveCatalogError();
            $this->clearFields();
            return false;    
        }
         
        $this->parserCatalogDetail();
        $this->parseCatalogSection();
        $this->parseCatalogMeta();
        $this->parseCatalogFirstUrl();
        $this->parseCatalogDate();
        $this->parseCatalogAllFields();
        $this->AddElementCatalog();
        if($this->isCatalog && $this->elementID)
        {   
            /*if($this->boolOffer)
            {
                return true;    
            }*/
            if($this->isOfferCatalog && !$this->boolOffer)
            {                                   
                $this->AddElementOfferCatalog();
                $this->elementID = $this->elementOfferID;
                $this->elementUpdate = $this->elementOfferUpdate;
            }
            if($this->boolOffer)
            {
                $this->addProductPriceOffers();
            }else{
                $this->AddProductCatalog();
                $this->AddMeasureCatalog();
                $this->AddPriceCatalog();    
            }
            
        }/*else{
            $this->AddElementOfferCatalog();
            $this->AddProductCatalog();
            $this->AddMeasureCatalog();
            $this->AddPriceCatalog();    
        }*/

        $this->SetCatalogElementsResult();
        $this->clearFields();
        
    }
    
    protected function addProductPriceOffers()
    {
        if(isset($this->arOfferAll))
        {
            if(isset($this->arOfferAll["FIELDS"]) && !empty($this->arOfferAll["FIELDS"]))
            {
                foreach($this->arOfferAll["FIELDS"] as $i=>$field)
                {
                    $this->AddElementOfferCatalogTable($field);
                    $arPrice = $this->arOfferAll["PRICE"][$i];
                    $this->arPrice = $arPrice;
                    $this->AddProductCatalogOffer($field);
                    $this->AddMeasureCatalogOffer($field);
                    $this->AddPriceCatalogOffer($arPrice, $field);
                    
                    if(isset($this->elementOfferID))
                        unset($this->elementOfferID);
                        
                    if(isset($this->elementOfferUpdate))
                        unset($this->elementOfferUpdate);
                }
            }
        
            
        }
        
        //printr($this->arOfferAll);
    }
    
    protected function AddElementOfferCatalogTable($arFields)
    {
        if($this->checkOfferUniqTable($arFields) && !$this->isUpdate) return false;
        $el = new CIBlockElement;
        $isElement = $this->checkOfferUniqTable();
        $arFields["IBLOCK_ID"] = $this->iblockOffer;
        $arFields["PROPERTY_VALUES"][$this->offerArray["SKU_PROPERTY_ID"]] = $this->elementID; 
        if(!$isElement)
        {   

            $id = $el->Add($arFields, "N", $this->index_element, $this->resize_image); 
            if(!$id)
            {   
                $this->errors[] = GetMessage("parser_offer_name").$arFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }else{
                $this->elementOfferID = $id;
                $this->addTmp($id);    
            } 
        }else{
            $this->elementOfferID = $isElement;
            $el->Update($isElement, $arFields);
            $this->addTmp($isElement);
        } 
       
        unset($el);    
    }
    
    protected function StepContinue($n, $count=0)
    {
        if($this->settings["catalog"]["mode"]=="debug" || $this->agent) return false;
        $step = (int)$this->settings["catalog"]["step"];
        if($step>$count && $count>0) return false;
        $file = 0;
        
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
        if($file)
        {
            $arFile = explode("|", $file);
            $countElement = (int)$arFile[0];
            $currentElement = (int)$arFile[1];    
        }else{
            return false;
        }

        if($currentElement>0 && $n<=$currentElement && $currentElement%$step==0) return true;
        else return false;    
    }
    
    protected function CalculateStep($count = 0)
    {           

        if($this->settings["catalog"]["mode"]=="debug" || $this->agent || $this->stepStart) return true;
        $step = $this->settings["catalog"]["step"];
        if($step>$count && $count>0)
        {
            $this->stepStart = true;
            return true;    
        }
        $file = 0;
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))  
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
        if($file)
        {
            $arFile = explode("|", $file);
            $countElement = (int)$arFile[0];
            $currentElement = (int)$arFile[1];    
        }else{
            $countElement = $count;
            $currentElement = 0;   
        }
        if($countElement-$currentElement<=$step && $countElement>0 && $count==0)
        {
            $this->stepStart = true;
        }
         
        if($count==0) return true;
        $currentElement++;
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt", $countElement."|".$currentElement);
        if($currentElement%$step==0 && !$this->stepStart)
        {
            $this->clearFields();
            $this->ClearBufferStep();
        }
        
            
    }
    
    protected function SetCatalogElementsResult($page=false)
    {
        $file = 0;
        if(file_exists(($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt")))
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt");
        
        if($file)
        {
            $arFile = explode("|", $file);
            
            $countPage = (int)$arFile[1];
            $ciElement = (int)$arFile[2];
            $errorElement = (int)$arFile[3];
            $allError = (int)$arFile[4];
        }
        else{
            $countPage = 0;
            $ciElement = 0;
            $errorElement = 0;
            $allError = 0; 
        }
        
        if($page)
        {
            $countPage = $page;    
        }elseif(isset($this->elementID)){
            $ciElement++;
            if(isset($this->errors) && count($this->errors))$errorElement++;
            $this->SavePrevPageDetail($this->arFields["LINK"]);    
        }
        if(isset($this->errors) && count($this->errors)>0)$allError = $allError+count($this->errors);
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt", "|".$countPage."|".$ciElement."|".$errorElement."|".$allError);
    }
    /*    */
    protected function SaveCatalogError()
    {
        $file = 0;
        if(file_exists(($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt")))
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt");
        
        if($file)
        {
            $arFile = explode("|", $file);
            
            $countPage = (int)$arFile[1];
            $ciElement = (int)$arFile[2];
            $errorElement = (int)$arFile[3];
            $allError = (int)$arFile[4];
        }
        else{
            $countPage = 0;
            $ciElement = 0;
            $errorElement = 0;
            $allError = 0; 
        }
        if(isset($this->elementID)){
            if(isset($this->errors) && count($this->errors))$errorElement++;
        }
        if(isset($this->errors) && count($this->errors)>0)$allError = $allError+count($this->errors);
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt", "|".$countPage."|".$ciElement."|".$errorElement."|".$allError);    
    }
    /*  */
    protected function parseCatalogAllFields()
    {
        if($this->updateActive && isset($this->settings["catalog"]["uniq"]["action"]) && $this->settings["catalog"]["uniq"]["action"]=="A")
            $this->arFields["ACTIVE"] = $this->active_element;
        
        if($this->checkUniq()) return false;
        $this->arFields["IBLOCK_ID"] = $this->iblock_id;
        $this->arFields["ACTIVE"] = $this->active_element;
        if($this->code_element=="Y")
        {
            $this->arFields["CODE"] = $this->getCodeElement($this->arFields["NAME"]);
        }

        if($this->uniqFields["LINK"])
        {
            $uniq = md5($this->arFields["NAME"].$this->arFields["LINK"]);
            $this->arFields["XML_ID"] = $uniq;
        }
        
        if($this->date_active=="NOW") $this->arFields["DATE_ACTIVE_FROM"] = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "SHORT");
        elseif($this->date_active=="NOW_TIME") $this->arFields["DATE_ACTIVE_FROM"] = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "FULL");
        //elseif($this->date_active=="PUBLIC" && $unix) $this->arFields["DATE_ACTIVE_FROM"] = ConvertTimeStamp($unix, "FULL");
    }

    protected function AddElementCatalog()
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $el = new CIBlockElement;   
        $isElement = $this->checkUniq();
        
        
        if(!$isElement)
        {
            $id = $el->Add($this->arFields, "N", $this->index_element, $this->resize_image); 
            if(!$id)
            {   
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }else{
                $this->elementID = $id; 
                $this->addTmp($id);
                $this->addSeoUniqYandex($this->arFields);   
            } 
        }else{
             $this->clearFieldsUpdate();
             $this->elementID = $isElement;
             $el->Update($isElement, $this->arFields);
             $this->addTmp($isElement);
        }
        
        unset($el);
    }
    
    protected function AddElementOfferCatalog()
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $el = new CIBlockElement;      
        $isElement = $this->checkOfferUniq(); 
        if(!$isElement)
        {   
            $this->arOfferFields["XML_ID"] = "offer#".md5($this->arFields["NAME"].$this->arFields["LINK"]);
            $this->arOfferFields["NAME"] = $this->arFields["NAME"];
            $this->arOfferFields["IBLOCK_ID"] = $this->offerArray["IBLOCK_ID"];
            $this->arOfferFields["PROPERTY_VALUES"][$this->offerArray["SKU_PROPERTY_ID"]] = $this->elementID;
            $id = $el->Add($this->arOfferFields, "N", $this->index_element, $this->resize_image); 
            if(!$id)
            {   
                $this->errors[] = GetMessage("parser_offer_name").$this->arOfferFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }else{
                $this->elementOfferID = $id;
                $this->addTmp($id);    
            } 
        }else{
            $this->elementOfferID = $isElement;
            $this->addTmp($isElement);    
        } 
        
        /*else{
             $this->clearFieldsUpdate();

             $this->elementID = $isElement;
             $el->Update($isElement, $this->arOfferFields);
        }*/
        unset($el);
    }
    
    protected function addSeoUniqYandex($arFields)
    {
        if(isset($this->settings["loc"]["uniq"]["domain"]) && !empty($this->settings["loc"]["uniq"]["domain"]) && isset($arFields["DETAIL_TEXT"]) && !empty($arFields["DETAIL_TEXT"]) && strlen($arFields["DETAIL_TEXT"])>=500)
        {
            $textContent = $arFields["DETAIL_TEXT"];
            $engine = new Engine\Yandex();
            $domain = $this->settings["loc"]["uniq"]["domain"];
            try
            {
                $res = $engine->addOriginalText($textContent, $domain);
            }catch(Engine\YandexException $e)
            {   
                $this->errors[] = $e->getMessage();
            }
            
            unset($engine);
        }
    }
                           
    protected function clearFieldsUpdate()
    {

        $this->arEmptyUpdate["PREVIEW_TEXT"] = trim($this->arEmptyUpdate["PREVIEW_TEXT"]);
        $this->arEmptyUpdate["DETAIL_TEXT"] = trim($this->arEmptyUpdate["DETAIL_TEXT"]);
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"]))
        {
            unset($this->arFields["PROPERTY_VALUES"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["preview_descr"] || (in_array("PREVIEW_TEXT", $this->arSortUpdate) && !empty($this->arEmptyUpdate["PREVIEW_TEXT"]))))
        {
            unset($this->arFields["PREVIEW_TEXT"]);
            unset($this->arFields["PREVIEW_TEXT_TYPE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["detail_descr"] || (in_array("DETAIL_TEXT", $this->arSortUpdate) && !empty($this->arEmptyUpdate["DETAIL_TEXT"]))))
        {
            unset($this->arFields["DETAIL_TEXT"]);
            unset($this->arFields["DETAIL_TEXT_TYPE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["preview_img"] || (in_array("PREVIEW_PICTURE", $this->arSortUpdate) && !empty($this->arEmptyUpdate["PREVIEW_PICTURE"]))))
        {
            unset($this->arFields["PREVIEW_PICTURE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["detail_img"] || (in_array("DETAIL_PICTURE", $this->arSortUpdate) && !empty($this->arEmptyUpdate["DETAIL_PICTURE"]))))
        {
            unset($this->arFields["DETAIL_PICTURE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"]))
        {
            unset($this->arPrice);
        }
        if($this->checkUniq())
        {
            $code = $this->settings["catalog"]["more_image_props"];
            unset($this->arFields["PROPERTY_VALUES"][$code]);
        }

    }
    
    protected function AddMeasureCatalogOffer()
    {
        if($this->elementOfferUpdate) return false;
        $info = CModule::CreateModuleObject('catalog');
        if(!CheckVersion("14.0.0", $info->MODULE_VERSION))
        {
            if($this->settings["catalog"]["koef"]>0)
            {
                $arMes = array("RATIO"=>$this->settings["catalog"]["koef"], "PRODUCT_ID"=>$this->elementOfferID);
                $str_CAT_MEASURE_RATIO = 1;
                $CAT_MEASURE_RATIO_ID = 0;
                $db_CAT_MEASURE_RATIO = CCatalogMeasureRatio::getList(array(), array("PRODUCT_ID" => $this->elementOfferID));
                if($ar_CAT_MEASURE_RATIO = $db_CAT_MEASURE_RATIO->Fetch())
                {
                    $str_CAT_MEASURE_RATIO = $ar_CAT_MEASURE_RATIO["RATIO"];
                    $CAT_MEASURE_RATIO_ID =  $ar_CAT_MEASURE_RATIO["ID"];
                }
                if($CAT_MEASURE_RATIO_ID>0)
                {
                    if(!CCatalogMeasureRatioAll::Update($CAT_MEASURE_RATIO_ID, $arMes))
                    {
                        $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_ratio");
                    }
                }
                else{
                    if(!CCatalogMeasureRatio::add($arMes))
                    {
                        $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_ratio");
                    }
                }
                
            }
        }
    }

    protected function AddMeasureCatalog()
    {
        if($this->elementUpdate) return false;
        $info = CModule::CreateModuleObject('catalog');
        if(!CheckVersion("14.0.0", $info->MODULE_VERSION))
        {
            if($this->settings["catalog"]["koef"]>0)
            {
                $arMes = array("RATIO"=>$this->settings["catalog"]["koef"], "PRODUCT_ID"=>$this->elementID);
                $str_CAT_MEASURE_RATIO = 1;
                $CAT_MEASURE_RATIO_ID = 0;
                $db_CAT_MEASURE_RATIO = CCatalogMeasureRatio::getList(array(), array("PRODUCT_ID" => $this->elementID));
                if($ar_CAT_MEASURE_RATIO = $db_CAT_MEASURE_RATIO->Fetch())
                {
                    $str_CAT_MEASURE_RATIO = $ar_CAT_MEASURE_RATIO["RATIO"];
                    $CAT_MEASURE_RATIO_ID =  $ar_CAT_MEASURE_RATIO["ID"];
                }
                if($CAT_MEASURE_RATIO_ID>0)
                {
                    if(!CCatalogMeasureRatioAll::Update($CAT_MEASURE_RATIO_ID, $arMes))
                    {
                        $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_ratio");
                    }    
                }
                else{
                    if(!CCatalogMeasureRatio::add($arMes))
                    {
                        $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_ratio");
                    }    
                }
                
            }
        }
    }

    protected function AddProductCatalog()
    {
        if($this->elementUpdate && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        $this->arProduct["MEASURE"] = $this->settings["catalog"]["measure"];
        $this->arProduct["VAT_ID"] = $this->settings["catalog"]["cat_vat_id"];
        $this->arProduct["VAT_INCLUDED"] = $this->settings["catalog"]["cat_vat_included"];
        $this->arProduct["ID"] = $this->elementID;

        $isElement = $this->elementUpdate;
        if(!$isElement)
        {
            if(!CCatalogProduct::Add($this->arProduct))
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_add_product");
            }
        }else{
            $this->UpdateProductCatalog($isElement);
        }

    }
    
    protected function AddProductCatalogOffer($arFields)
    {
        if($this->elementOfferUpdate && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        $this->arProduct["MEASURE"] = $this->settings["catalog"]["measure"];
        $this->arProduct["VAT_ID"] = $this->settings["catalog"]["cat_vat_id"];
        $this->arProduct["VAT_INCLUDED"] = $this->settings["catalog"]["cat_vat_included"];
        $this->arProduct["ID"] = $this->elementOfferID;

        $isElement = $this->elementOfferUpdate;
        if(!$isElement)
        {
            if(!CCatalogProduct::Add($this->arProduct))
            {
                $this->errors[] = $this->arFields["NAME"]." - ".$arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_add_product_offer");
            }
        }else{
            $this->UpdateProductCatalogOffer($isElement, $arFields);
        }

    }
    
    protected function UpdateProductCatalogOffer($productID, $arFields)
    {
        if(!$productID){
            $this->errors[] = $this->arFields["NAME"]."-".$arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_update_product_offer");
            return false;
        }
        CCatalogProduct::Update($productID, $this->arProduct);
    } 
    
    protected function UpdateProductCatalog($productID)
    {
        if(!$productID){
            $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_update_product");
            return false;
        }
        CCatalogProduct::Update($productID, $this->arProduct);
    }
    
    protected function AddProductCatalogOffers()
    {
        
    }
    
    protected function ConvertCurrency()
    {
        if($this->settings["catalog"]["convert_currency"])
        {
            $this->arPrice["CURRENCY"] = $this->settings["catalog"]["convert_currency"];
            $this->arPrice["PRICE"] = CCurrencyRates::ConvertCurrency($this->arPrice["PRICE"], $this->settings["catalog"]["currency"], $this->settings["catalog"]["convert_currency"]);    
        }    
    }
    
    protected function ChangePrice()
    {
        if(is_array($this->settings["catalog"]["price_updown"]) && count($this->settings["catalog"]["price_updown"])>0)
        {
            foreach($this->settings["catalog"]["price_updown"] as $i=>$val)
            {
                if($this->settings["catalog"]["price_updown"][$i] && $this->settings["catalog"]["price_value"][$i])
                {
                    if($this->settings["catalog"]["price_terms"][$i]=="delta")
                    {
                        if(empty($this->settings["catalog"]["price_terms_value"][$i]) && !empty($this->settings["catalog"]["price_terms_value_to"][$i]))
                        {
                            if($this->arPrice["PRICE"]>$this->settings["catalog"]["price_terms_value_to"][$i]) continue;
                        }
                        
                        if(!empty($this->settings["catalog"]["price_terms_value"][$i]) && empty($this->settings["catalog"]["price_terms_value_to"][$i]))
                        {
                            if($this->arPrice["PRICE"]<$this->settings["catalog"]["price_terms_value"][$i]) continue;
                        }

                        if(!empty($this->settings["catalog"]["price_terms_value"][$i]) && !empty($this->settings["catalog"]["price_terms_value_to"][$i]))
                        {
                            if($this->arPrice["PRICE"]<$this->settings["catalog"]["price_terms_value"][$i] || $this->arPrice["PRICE"]>$this->settings["catalog"]["price_terms_value_to"][$i]) continue;
                        }
                    }
                    if($this->settings["catalog"]["price_type_value"][$i]=="percent")
                    {
                        $delta = $this->arPrice["PRICE"]*$this->settings["catalog"]["price_value"][$i]/100; 
                    }else{
                        $delta = $this->settings["catalog"]["price_value"][$i]; 
                    }
                    if($this->settings["catalog"]["price_updown"][$i]=="up")
                    {   
                        $this->arPrice["PRICE"] += $delta;
                    }
                    elseif($this->settings["catalog"]["price_updown"][$i]=="down")
                    {    
                        $this->arPrice["PRICE"] -= $delta;
                    }
                    break;
                }
            }
        }else{
            if($this->settings["catalog"]["price_updown"] && $this->settings["catalog"]["price_value"])
            {   
                    if($this->settings["catalog"]["price_terms"]=="up" && $this->settings["catalog"]["price_terms_value"])
                    {
                        if($this->arPrice["PRICE"]<$this->settings["catalog"]["price_terms_value"]) return false;
                    }
                    if($this->settings["catalog"]["price_terms"]=="down" && $this->settings["catalog"]["price_terms_value"])
                    {
                        if($this->arPrice["PRICE"]>$this->settings["catalog"]["price_terms_value"]) return false;
                    }
            
                    if($this->settings["catalog"]["price_type_value"]=="percent")
                    {
                        $delta = $this->arPrice["PRICE"]*$this->settings["catalog"]["price_value"]/100; 
                    }else{
                        $delta = $this->settings["catalog"]["price_value"];
                    }
                    if($this->settings["catalog"]["price_updown"]=="up")
                    {
                        $this->arPrice["PRICE"] += $delta;
                    }
                    elseif($this->settings["catalog"]["price_updown"]=="down")
                    {
                        $this->arPrice["PRICE"] -= $delta;
                    }
            }    
        }

    }

    protected function AddPriceCatalog()
    {
        if($this->elementUpdate && (!$this->isUpdate || !$this->isUpdate["price"])) return false;

        if(!$this->arPrice || !$this->arPrice["PRICE"]) return false;
        $isElement = $this->elementUpdate;
        $this->arPrice["PRODUCT_ID"] = $this->elementID;
        $this->ChangePrice();
        $this->ConvertCurrency();
        $this->arPrice["PRICE"] = $this->parseCatalogPriceOkrug($this->arPrice["PRICE"]);
        $obPrice = new CPrice();
        if(!$isElement)
        {
            $price = $obPrice->Add($this->arPrice);
            if(!$price)
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_add_price").$obPrice->LAST_ERROR;
            }
        }else $this->UpdatePriceCatalog($isElement);

        unset($obPrice);
    }
    
    protected function AddPriceCatalogOffer($arPrice, $arFields)
    {
        if($this->elementOfferUpdate && (!$this->isUpdate || !$this->isUpdate["price"])) return false;
        if(!$this->arPrice || !$this->arPrice["PRICE"]) return false;
        $isElement = $this->elementOfferUpdate;
        $this->arPrice["PRODUCT_ID"] = $this->elementOfferID;
        $this->ChangePrice();
        $this->ConvertCurrency();

        $this->arPrice["PRICE"] = $this->parseCatalogPriceOkrug($this->arPrice["PRICE"]);

        $obPrice = new CPrice();
        if(!$isElement)
        {
            $price = $obPrice->Add($this->arPrice);
            if(!$price)
            {
                $this->errors[] = $this->arFields["NAME"]." - ".$arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_add_price_offer").$obPrice->LAST_ERROR;
            }
        }else $this->UpdatePriceCatalog($isElement);

        unset($obPrice);
    }

    protected function UpdatePriceCatalog($elementID)
    {
        if(!$elementID){
            $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_update_price");
            return false;
        }
        $res = CPrice::GetList(
            array(),
            array(
                "PRODUCT_ID" => $elementID,
                "CATALOG_GROUP_ID" => $this->arPrice["CATALOG_GROUP_ID"]
                )
        );

        if ($arr = $res->Fetch())
        {
            CPrice::Update($arr["ID"], $this->arPrice);
        }
    }

    protected function parserCatalogPreview(&$el)
    {
        foreach(GetModuleEvents("shs.parser", "parserCatalogPreview", true) as $arEvent)
            ExecuteModuleEventEx($arEvent, array($this->id, &$el, &$this->arFields));
        
        if(!$this->parseCatalogUrlPreview($el)) return false;
        $this->parseCatalogNamePreview($el);
        $this->parseCatalogPropertiesPreview($el);
        if($this->isCatalog)$this->parseCatalogPricePreview($el);
        $this->parseCatalogPreviewPicturePreview($el);
        $this->parseCatalogDescriptionPreview($el);

        return true;
    }

    protected function parserCatalogDetail()
    {

        if($this->checkUniq() && !$this->isUpdate) return false;
        $el = $this->parserCatalogDetailPage();
        foreach(GetModuleEvents("shs.parser", "parserCatalogDetail", true) as $arEvent)
            ExecuteModuleEventEx($arEvent, array($this->id, &$el, &$this->arFields));
        $this->parseCatalogNameDetail($el);
        $this->parseCatalogProperties($el);
        $this->parseCatalogDetailPicture($el);
        $this->parseCatalogDetailMorePhoto($el);
        if($this->isCatalog)$this->parseCatalogPriceDetail($el);
        $this->parseCatalogDescriptionDetail($el);
        $this->parserOffers($el);
    }
    
    protected function parserOffers($el)
    {
        $this->boolOffer = false;
        if($this->settings["offer"]["load"]=="table" && $this->isOfferParsing && isset($this->settings["offer"]["selector"]) && $this->settings["offer"]["selector"] && isset($this->settings["offer"]["selector_item"]) && $this->settings["offer"]["selector_item"])
        {
            //$this->arFields["NAME"] = htmlspecialchars_decode(trim(strip_tags(pq($el)->find($name)->html())));
           $offerItem = $this->settings["offer"]["selector"]." ".$this->settings["offer"]["selector_item"];

           $this->parserHeadTableOffer($el);
           
           foreach(pq($el)->find($offerItem) as $offer)
           {    
                $this->boolOffer = true;
                if($this->parseOfferName($offer))
                {
                    $this->parseOfferPrice($offer);
                    $this->parseOfferProps($offer);
                    if(!$this->parseOfferGetUniq())
                    {
                        $this->deleteOfferFields();;
                        continue 1;
                    }

                }else
                    continue 1;

                $this->arOfferAll["FIELDS"][] = $this->arOffer;
                $this->arOfferAll["PRICE"][] = $this->arPriceOffer;

                $this->deleteOfferFields();
                    
           }
        }elseif($this->settings["offer"]["load"]=="one" && $this->isOfferParsing && isset($this->settings["offer"]["one"]["selector"]) && $this->settings["offer"]["one"]["selector"])
        {
            $offerItem = trim($this->settings["offer"]["one"]["selector"]);
            foreach(pq($el)->find($offerItem) as $offer)
            {    
                $this->boolOffer = true;
                if($this->parseOfferName($offer))
                {
                    $this->parseOfferPrice($offer);
                    $this->parseOfferProps($offer);
                    if(!$this->parseOfferGetUniq())
                    {
                        $this->deleteOfferFields();;
                        continue 1;
                    }

                }else
                    continue 1;

                $this->arOfferAll["FIELDS"][] = $this->arOffer;
                $this->arOfferAll["PRICE"][] = $this->arPriceOffer;

                $this->deleteOfferFields();
                    
            }    
        }
    
    }

    protected function deleteOfferFields()
    {
        if(isset($this->arOffer))
            unset($this->arOffer);
                    
        if(isset($this->arPriceOffer))
            unset($this->arPriceOffer);    
    }

    protected function parseOfferGetUniq()
    {
        if(isset($this->settings["offer"]["add_name"]) && !empty($this->settings["offer"]["add_name"]))
        {
            $strV = "";
            $bool = true;
            foreach($this->settings["offer"]["add_name"] as $v)
            {
                if(isset($this->arOffer["PROPERTY_VALUES"][$v]))
                {
                    
                    if(is_array($this->arOffer["PROPERTY_VALUES"][$v]))
                    {
                        
                        foreach($this->arOffer["PROPERTY_VALUES"][$v] as $val)
                        {
                            if($bool) $strV .= $val;
                            else $strV .= " / ".$val;
                            $bool = false;
                        }
                    }else{
                        $val = $this->arOffer["PROPERTY_VALUES"][$v];
                        if($bool) $strV .= $val;
                        else $strV .= " / ".$val;
                        $bool = false;   
                    }
                }
            }
            
            if(!isset($this->arOffer["NAME"]))
                $this->arOffer["NAME"] = "";
            if($strV)
                $strV =  " (".$strV.")";
            $this->arOffer["NAME"] .= $strV;
            

            if(!$this->arOffer["NAME"])
            {
                $this->errors[] = GetMessage("parser_error_name_notfound_offer");
                return false;    
            }
        }
        if($this->arOffer["NAME"])
        {
            $this->arOffer["XML_ID"] = "offer#".md5($this->arFields["LINK"].$this->arOffer["NAME"]);
        }
        return true;    
    }
    
    protected function parserHeadTableOffer($el)
    {
        if(isset($this->settings["offer"]["selector"]) && $this->settings["offer"]["selector"] && isset($this->settings["offer"]["selector_head"]) && $this->settings["offer"]["selector_head"] && isset($this->settings["offer"]["selector_head_th"]) && $this->settings["offer"]["selector_head_th"])
        {
            $offerHead = $this->settings["offer"]["selector"]." ".$this->settings["offer"]["selector_head"]." ".$this->settings["offer"]["selector_head_th"];
            $i = 0;
            foreach(pq($el)->find($offerHead) as $head)
            {
                $textHead = trim(strip_tags(pq($head)->html()));    
                
                $this->tableHeaderNumber[$textHead] = $i;
                $i++;
            }
        }
    }
    
    protected function parseOfferName($offer)
    {
        if(isset($this->settings["offer"]["selector_name"]) && $this->settings["offer"]["selector_name"])
        {
            $name = trim(strip_tags(pq($offer)->find($this->settings["offer"]["selector_name"])->html()));
            $deleteSymb = $this->getOfferDeleteSelector();
            $name = str_replace($deleteSymb, "", $name);
            $this->arOffer["NAME"] = htmlspecialchars_decode($name);
            if(isset($this->settings["loc"]["f_name"]) && $this->settings["loc"]["f_name"]=="Y")
            {
                $this->arOffer["NAME"] = $this->locText($this->arOffer["NAME"]);    
            }   
        }elseif(isset($this->settings["offer"]["find_name"]) && $this->settings["offer"]["find_name"])
        {
            if(isset($this->settings["offer"]["selector_item_td"]) && $this->settings["offer"]["selector_item_td"])
            {
                $deleteSymb = $this->getOfferDeleteFind();
                $name = $this->settings["offer"]["find_name"];
                
                if(isset($this->tableHeaderNumber[$name]))
                {
                    $n = $this->tableHeaderNumber[$name];
                    $name = pq($offer)->find($this->settings["offer"]["selector_item_td"].":eq(".$n.")");
                    $this->arOffer["NAME"] = htmlspecialchars_decode(trim(strip_tags($name)));
                    $this->arOffer["NAME"] = str_replace($deleteSymb, "", $this->arOffer["NAME"]);
                    if(isset($this->settings["loc"]["f_name"]) && $this->settings["loc"]["f_name"]=="Y")
                    {
                        $this->arOffer["NAME"] = $this->locText($this->arOffer["NAME"]);    
                    }
                    
                }
            }        
        }
        if(!isset($this->arOffer["NAME"]) && (!isset($this->settings["offer"]["add_name"]) || empty($this->settings["offer"]["add_name"])))
        {
            $this->errors[] = GetMessage("parser_error_name_notfound_offer");
            return false;
        }else
            $this->arOffer["NAME"] = $this->arFields["NAME"]; 
               
        return true;
    }
    
    protected function getOfferDeleteSelector()
    {
        $deleteSymb = array();
        if($this->settings["offer"]["catalog_delete_selector_props_symb"])
        {
            $deleteSymb = explode("||", $this->settings["offer"]["catalog_delete_selector_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if(preg_match("/^\//", $symb) && preg_match("/\/$/", $symb))
                {
                    unset($deleteSymb[$i]);
                    continue;    
                }
            }
            
        }

        return $deleteSymb;
    }
    
    protected function getOfferDeleteSelectorRegular()
    {
        $deleteSymb = array();
        if($this->settings["offer"]["catalog_delete_selector_props_symb"])
        {
            $deleteSymb = explode("||", $this->settings["offer"]["catalog_delete_selector_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                
                if(!preg_match("/^\//", $symb) || !preg_match("/\/$/", $symb))
                {
                    unset($deleteSymb[$i]);
                    continue;    
                }
            }
            
        }

        return $deleteSymb;
    }

    protected function getOfferDeleteFind()
    {
        $deleteSymb = array();
        
        if($this->settings["offer"]["catalog_delete_selector_find_props_symb"])
        {
            $deleteSymb = explode("||", $this->settings["offer"]["catalog_delete_selector_find_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                
                if(preg_match("/^\//", $symb) && preg_match("/\/$/", $symb))
                {
                    unset($deleteSymb[$i]);
                    continue;    
                }
            }

        }
        
        return $deleteSymb;
    }
    
    protected function getOfferDeleteFindRegular()
    {
        $deleteSymb = array();
        if($this->settings["offer"]["catalog_delete_selector_find_props_symb"])
        {
            $deleteSymb = explode("||", $this->settings["offer"]["catalog_delete_selector_find_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                
                if(!preg_match("/^\//", $symb) || !preg_match("/\/$/", $symb))
                {
                    unset($deleteSymb[$i]);
                    continue;    
                }
            }

        }
        
        return $deleteSymb;
    }
    
    protected function parseOfferPrice($offer)
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"])) return false;
        if(isset($this->settings["offer"]["selector_price"]) && $this->settings["offer"]["selector_price"])
        {   
            $price = trim(strip_tags(pq($offer)->find($this->settings["offer"]["selector_price"])->html()));
            $price = $this->parseCatalogPriceFormat($price);
            //$price = $this->parseCatalogPriceOkrug($price);
            $this->arPriceOffer["PRICE"] = $price;
            $this->arPriceOffer["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
            $this->arPriceOffer["CURRENCY"] = $this->settings["catalog"]["currency"];
               
        }elseif(isset($this->settings["offer"]["find_price"]) && $this->settings["offer"]["find_price"])
        {
            if(isset($this->settings["offer"]["selector_item_td"]) && $this->settings["offer"]["selector_item_td"])
            {
                $name = $this->settings["offer"]["find_price"];
                if(isset($this->tableHeaderNumber[$name]))
                {
                    $n = $this->tableHeaderNumber[$name];
                    $price = pq($offer)->find($this->settings["offer"]["selector_item_td"].":eq(".$n.")");
                    $price = trim(strip_tags($price));
                    $price = $this->parseCatalogPriceFormat($price);
                    //$price = $this->parseCatalogPriceOkrug($price);
                    $this->arPriceOffer["PRICE"] = $price;
                    $this->arPriceOffer["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
                    $this->arPriceOffer["CURRENCY"] = $this->settings["catalog"]["currency"];
                }
            }        
        }elseif(isset($this->settings["offer"]["one"]["price"]) && $this->settings["offer"]["one"]["price"])
        {
            $attr = $this->settings["offer"]["one"]["price"];
            $price = pq($offer)->attr($attr);
            $price = trim(strip_tags($price));
            $this->arPriceOffer["PRICE"] = $price;
            $this->arPriceOffer["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
            $this->arPriceOffer["CURRENCY"] = $this->settings["catalog"]["currency"];    
        }
        
        if(isset($this->arPrice["PRICE"]) && !empty($this->arPrice["PRICE"]) && (!isset($this->arPriceOffer["PRICE"]) || empty($this->arPriceOffer["PRICE"])))
        {
             $this->arPriceOffer["PRICE"] = $this->arPrice["PRICE"];
             $this->arPriceOffer["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
             $this->arPriceOffer["CURRENCY"] = $this->settings["catalog"]["currency"];    
        }
        
        if(!isset($this->arPriceOffer["PRICE"]))
        {
            $this->errors[] = GetMessage("parser_error_name_notfound_offer");
            return false;
        }
        return true;        
    }
    
    protected function parseOfferProps($offer)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        if(isset($this->settings["offer"]["selector_prop"]) && !empty($this->settings["offer"]["find_prop"]))
        {
            $deleteSymb = $this->getOfferDeleteSelector();
            $deleteSymbRegular = $this->getOfferDeleteSelectorRegular();
            
            $arProperties = $this->arSelectorPropertiesOffer;
            foreach($arProperties as $code=>$val)
            {
                $arProp = $this->arPropertiesOffer[$code];
                if($arProp["PROPERTY_TYPE"]=="F")
                {
                    $this->parseCatalogPropFile($code, $offer);
                }else{
                    $text = pq($offer)->find($this->settings["offer"]["selector_prop"][$code])->html();

                    if($arProp["USER_TYPE"]!="HTML")
                        $text = strip_tags($text);
                    $text = str_replace($deleteSymb, "", $text);
                    $text = preg_replace($deleteSymbRegular, "", $text);
                    $this->parseCatalogPropOffer($code, $val, $text);    
                }

            }
                
        }
        if(isset($this->settings["offer"]["find_prop"]) && !empty($this->settings["offer"]["find_prop"]))
        {
            $deleteSymb = $this->getOfferDeleteFind();
            $deleteSymbRegular = $this->getOfferDeleteFindRegular();
            
            $arProperties = $this->arFindPropertiesOffer; 
            foreach($arProperties as $code=>$val)
            {
                $arProp = $this->arPropertiesOffer[$code];
                if(isset($this->tableHeaderNumber[$val]))
                {
                    $n = $this->tableHeaderNumber[$val];
                    $text = pq($offer)->find($this->settings["offer"]["selector_item_td"].":eq(".$n.")");
                    $text = str_replace($deleteSymb, "", $text);
                    $text = preg_replace($deleteSymbRegular, "", $text);
                    
                    $text1 = $text; 
                    if($arProp["USER_TYPE"]!="HTML")
                        $text1 = strip_tags($text);
                    if($this->CheckFindPropsOffer($code, $val, $text1))
                    {   
                        $this->parseCatalogPropOffer($code, $val, $text1);
                    }   
                }    
            }
        }
        
        if(isset($this->settings["offer"]["one"]["selector"]) && !empty($this->settings["offer"]["one"]["selector"]) && isset($this->settings["offer"]["add_name"]) && !empty($this->settings["offer"]["add_name"])) 
        {
            $arProperties = $this->settings["offer"]["add_name"];
            $deleteSymb = $this->getOfferDeleteSelector();
            $deleteSymbRegular = $this->getOfferDeleteSelectorRegular();
            foreach($arProperties as $code)
            {
                $text = pq($offer)->html();
                $text = str_replace($deleteSymb, "", $text); 
                $text = preg_replace($deleteSymbRegular, "", $text);
                $text1 = $text; 
                $text1 = strip_tags($text); 
                $this->parseCatalogPropOffer($code, "", $text1);
                break 1;
            }    
        }      
    }

    protected function parseCatalogProperties(&$el)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $this->parseCatalogDefaultProperties($el);
        $this->parseCatalogSelectorProperties($el);
        $this->parseCatalogFindProperties($el);
        $this->AllDoProps();
        if($this->isCatalog)$this->parseCatalogFindProduct($el);
        if($this->isCatalog)$this->parseCatalogSelectorProduct($el);
    }

    protected function parseCatalogPropertiesPreview(&$el)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $this->parseCatalogSelectorPropertiesPreview($el);
        $this->parseCatalogFindPropertiesPreview($el);
        //$this->AllDoProps();
    }
    


    protected function AllDoProps()
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"])) return false;
        $isElement = $this->checkUniq();
        if($isElement)
        {
            $obElement = new CIBlockElement;
            $rsProperties = $obElement->GetProperty($this->iblock_id, $isElement, "sort", "asc");
            while($arProperty = $rsProperties->Fetch())
            {

                if(isset($this->arFields["PROPERTY_VALUES"][$arProperty["CODE"]]) || $arProperty["PROPERTY_TYPE"]=="F") continue;
                $this->arFields["PROPERTY_VALUES"][$arProperty["ID"]][$arProperty['PROPERTY_VALUE_ID']] = array(
                    "VALUE"=>$arProperty['VALUE'],
                    "DESCRIPTION"=>$arProperty["DESCRIPTION"]
                );
            }

        }
    }

    protected function clearFields()
    {
        unset($this->arFields);
        
        if($this->arProduct)
            unset($this->arProduct);
        if(isset($this->arPrice))
            unset($this->arPrice);
        unset($this->elementUpdate);
        if(isset($this->elementOfferUpdate))
            unset($this->elementOfferUpdate);
        unset($this->elementID);
        unset($this->detailHtml);
        unset($this->arEmptyUpdate);
        if(isset($this->arPhoto))
            unset($this->arPhoto);
        if(isset($this->arOfferAll))
            unset($this->arOfferAll);
        $this->SaveLog();
        //if($this->settings["catalog"]["mode"]!="debug")
         
        unset($this->errors); 
    }
    
    protected function clearHtml()
    {
        unset($this->html);
    }

    protected function getCodeElement($name)
    {
        $arFieldCode = $this->arrayIblock["FIELDS"]["CODE"]["DEFAULT_VALUE"];
        $CODE = CUtil::translit($name, "ru", array(
            "max_len" => $arFieldCode["TRANS_LEN"],
            "change_case" => $arFieldCode["TRANS_CASE"],
            "replace_space" => $arFieldCode["TRANS_SPACE"],
            "replace_other" => $arFieldCode["TRANS_OTHER"],
            "delete_repeat_replace" => $arFieldCode["TRANS_EAT"]=="Y"?true:false,
        ));
        
        $IBLOCK_ID = $this->arrayIblock['ID'];

        $arCodes = array();
        $rsCodeLike = CIBlockElement::GetList(array(), array(
                "IBLOCK_ID" => $IBLOCK_ID,
                "CODE" => $CODE."%",
        ), false, false, array("ID", "CODE"));
        while($ar = $rsCodeLike->Fetch())
            $arCodes[$ar["CODE"]] = $ar["ID"];

        if (array_key_exists($CODE, $arCodes))
        {
            $i = 1;
            while(array_key_exists($CODE."_".$i, $arCodes))
                $i++;

            return $CODE."_".$i;
        }
        else
        {
            return $CODE;
        }
    }

    protected function getArrayIblock()
    {
        $arIBlock = CIBlock::GetArrayByID($this->iblock_id);
        $this->arrayIblock = $arIBlock;
    }

    protected function parseCatalogSection()
    {
        if($this->checkUniq()) return false;
        $this->arFields["IBLOCK_SECTION_ID"] = $this->section_id;
    }

    protected function parseCatalogFindProduct(&$el)
    {
        $arProperties = $this->arFindProduct;
        if(!$arProperties) return false;
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        $find = $this->settings["catalog"]["selector_find_size"];
        if($this->settings["catalog"]["catalog_delete_find_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_find_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }

        foreach(pq($el)->find($find) as $prop)
        {
            $text = pq($prop)->html();
            $text = strip_tags($text);
            $text = str_replace($deleteSymb, "", $text);
            foreach($arProperties as $code=>$val)
            {
                //if(preg_match("/".$val."/", $text))
                if(strpos($text, $val)!==false)
                {
                    $text = str_replace($val, "", $text);
                    $text = trim($text);
                    
                    $text =  str_replace(",", ".", $text);
                    $text = preg_replace("/\.{1}$/", "", $text);
                    $text = preg_replace('/[^0-9.]/', "", $text);
                    
                    if(isset($this->settings["catalog"]["find_product_koef"][$code]) && !empty($this->settings["catalog"]["find_product_koef"][$code]))
                    {
                        $text = $text*$this->settings["catalog"]["find_product_koef"][$code];    
                    }
                    
                    $this->arProduct[$code] = $text;
                }
            }

        }
    }

    protected function parseCatalogSelectorProduct(&$el)
    {
        $arProperties = $this->arSelectorProduct;
        if(!$arProperties) return false;
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        if($this->settings["catalog"]["catalog_delete_selector_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }
            }
        }

        foreach($arProperties as $code=>$val)
        {
            $text = pq($el)->find($this->settings["catalog"]["selector_product"][$code])->html();
            $text = strip_tags($text);
            $text = str_replace($deleteSymb, "", $text);
            $text = trim($text);
            
            $text =  str_replace(",", ".", $text);
            $text = preg_replace("/\.{1}$/", "", $text);
            $text = preg_replace('/[^0-9.]/', "", $text);
            
            if(isset($this->settings["catalog"]["selector_product_koef"][$code]) && !empty($this->settings["catalog"]["selector_product_koef"][$code]))
            {
                $text = $text*$this->settings["catalog"]["selector_product_koef"][$code];    
            }
            
            $this->arProduct[$code] = $text;
        }
    }

    protected function parseCatalogSelectorProperties(&$el)
    {
        $arProperties = $this->arSelectorProperties;
        if(!$arProperties) return false;
        if($this->settings["catalog"]["catalog_delete_selector_props_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }

        foreach($arProperties as $code=>$val)
        {
            $arProp = $this->arProperties[$code];
            if($arProp["PROPERTY_TYPE"]=="F")
            {
                $this->parseCatalogPropFile($code, $el);
            }else{
                $text = pq($el)->find($this->settings["catalog"]["selector_prop"][$code])->html();

                if($arProp["USER_TYPE"]!="HTML")
                    $text = strip_tags($text);
                $text = str_replace($deleteSymb, "", $text);
                $this->parseCatalogProp($code, $val, $text);    
            }

        }
    }

    protected function parseCatalogSelectorPropertiesPreview(&$el)
    {
        $arProperties = $this->arSelectorPropertiesPreview;
        if(!$arProperties) return false;
        if($this->settings["catalog"]["catalog_delete_selector_props_symb_preview"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_props_symb_preview"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }
 
        foreach($arProperties as $code=>$val)
        {
            /*$text = pq($el)->find($this->settings["catalog"]["selector_prop_preview"][$code])->html();
            
            $arProp = $this->arProperties[$code];
            if($arProp["USER_TYPE"]!="HTML")
                $text = strip_tags($text);
            $text = str_replace($deleteSymb, "", $text);
            $this->parseCatalogProp($code, $val, $text);*/
            
            $arProp = $this->arProperties[$code];
            if($arProp["PROPERTY_TYPE"]=="F")
            {
                $this->parseCatalogPropFilePreview($code, $el);
            }else{
                $text = pq($el)->find($this->settings["catalog"]["selector_prop_preview"][$code])->html();

                if($arProp["USER_TYPE"]!="HTML")
                    $text = strip_tags($text);
                $text = str_replace($deleteSymb, "", $text);
                $this->parseCatalogProp($code, $val, $text);    
            }

        }
    }

    protected function parseCatalogFindProperties(&$el)
    {   
        $arProperties = $this->arFindProperties;
        if(!$arProperties) return false;
        $find = $this->settings["catalog"]["selector_find_props"];
        if($this->settings["catalog"]["catalog_delete_selector_find_props_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_find_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);  
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }
        $arFind = explode(",", $find);
        foreach($arFind as $vFind)
        {
            if(strpos($vFind, " br")!==false || strpos($vFind, "<br/>") || strpos($vFind, "<br />"))
            {
                $vFind = str_replace(array(" br", "<br/>", "<br />"), "", $vFind);
                $vFind = trim($vFind);
                $arBr = array("<br>", "<br/>", "<br />");
                
                foreach(pq($el)->find($vFind) as $prop)
                {
                    $text = pq($prop)->html();
                    $text = str_replace($arBr, "<br>", $text);
                    unset($arBr[1]);
                    unset($arBr[2]);
                    foreach($arBr as $br)
                    {
                        $arTextBr = explode($br, $text);
                        if(!empty($arTextBr) && count($arTextBr)>1)
                        {
                            foreach($arTextBr as $textBr)
                            {   
                                $textBr = strip_tags($textBr);
                                $textBr = str_replace($deleteSymb, "", $textBr); 
                                foreach($arProperties as $code=>$val)
                                {
                                    //if(preg_match("/".$val."/", $textBr))
                                    if($this->CheckFindProps($code, $val, $textBr))
                                    {
                                        $this->parseCatalogProp($code, $val, $textBr);
                                    }    
                                }
                                
                            }      
                        }
                    }
                    
                }
            }else
            {
                foreach(pq($el)->find($vFind) as $prop)
                {
                    $text = pq($prop)->html();
                    //$text = strip_tags($text);
                    $text = str_replace($deleteSymb, "", $text);
                    $text1 = $text;

                    foreach($arProperties as $code=>$val)
                    {
                        //if(preg_match("/".$val."/", $text))
                        $text1 = $text;
                        $arProp = $this->arProperties[$code];
                        if($arProp["USER_TYPE"]!="HTML")
                            $text1 = strip_tags($text);
                        
                        if($this->CheckFindProps($code, $val, $text1))
                        {   
                            $this->parseCatalogProp($code, $val, $text1);
                        }
                    }
                }
            }
        }
    }

    protected function parseCatalogFindPropertiesPreview(&$el)
    {   
        $arProperties = $this->arFindPropertiesPreview;
        if(!$arProperties) return false;
        $find = $this->settings["catalog"]["selector_find_props_preview"];
        if($this->settings["catalog"]["catalog_delete_selector_find_props_symb_preview"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_find_props_symb_preview"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);  
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }
        $arFind = explode(",", $find);
        foreach($arFind as $vFind)
        {
            if(strpos($vFind, " br")!==false || strpos($vFind, "<br/>") || strpos($vFind, "<br />"))
            {
                $vFind = str_replace(array(" br", "<br/>", "<br />"), "", $vFind);
                $vFind = trim($vFind);
                $arBr = array("<br>", "<br/>", "<br />");
                
                foreach(pq($el)->find($vFind) as $prop)
                {
                    $text = pq($prop)->html();
                    $text = str_replace($arBr, "<br>", $text);
                    unset($arBr[1]);
                    unset($arBr[2]);
                    foreach($arBr as $br)
                    {
                        $arTextBr = explode($br, $text);
                        if(!empty($arTextBr) && count($arTextBr)>1)
                        {
                            foreach($arTextBr as $textBr)
                            {   
                                $textBr = strip_tags($textBr);
                                $textBr = str_replace($deleteSymb, "", $textBr); 
                                foreach($arProperties as $code=>$val)
                                {
                                    //if(preg_match("/".$val."/", $textBr))
                                    if($this->CheckFindPropsPreview($code, $val, $textBr))
                                    {
                                        $this->parseCatalogProp($code, $val, $textBr);
                                    }    
                                }
                                
                            }      
                        }
                    }
                    
                }
            }else
            {
                foreach(pq($el)->find($vFind) as $prop)
                {   
                    $text = pq($prop)->html();
                    //$text = strip_tags($text);
                    $text = str_replace($deleteSymb, "", $text);
                    $text1 = $text;
                    foreach($arProperties as $code=>$val)
                    {
                        //if(preg_match("/".$val."/", $text))
                        $text1 = $text;
                        $arProp = $this->arProperties[$code];
                        if($arProp["USER_TYPE"]!="HTML")
                            $text1 = strip_tags($text);
                        if($this->CheckFindPropsPreview($code, $val, $text1))
                        {   
                            $this->parseCatalogProp($code, $val, $text1);
                        }
                    }

                }    
            }    
        }
    }
    
    protected function parseCatalogDefaultProperties(&$el)
    {
        if(isset($this->settings["catalog"]["default_prop"]) && !empty($this->settings["catalog"]["default_prop"]))
        {
            foreach($this->settings["catalog"]["default_prop"] as $code=>$val)
            {
                if($val)$this->parseCatalogDefaultProp($code, $val);
            }
        }    
    }
    
    protected function CheckFindProps($code, $val, $text)
    {
        $arDubleProperties = $this->arDubleFindProperties;
        $bool = false;
        if(isset($arDubleProperties[$code]))
        {   
            foreach($arDubleProperties[$code] as $prop)
            {
                $v = $this->arFindProperties[$prop];
                //if(preg_match("/".$v."/", $text))
                if(strpos($text, $v)!==false)
                {
                    $bool  = true;    
                }
            }
            if($bool) return false;
        }
        
        //if(preg_match("/".$val."/", $text)) return true;
        if(strpos($text, $val)!==false) return true;
        else return false;
    }
    
    protected function CheckFindPropsOffer($code, $val, $text)
    {
        $arDubleProperties = $this->arDubleFindPropertiesOffer;
        $bool = false;
        if(isset($arDubleProperties[$code]))
        {   
            foreach($arDubleProperties[$code] as $prop)
            {
                $v = $this->arFindPropertiesOffer[$prop];
                //if(preg_match("/".$v."/", $text))
                if(strpos($text, $v)!==false)
                {
                    $bool  = true;
                }    
            }
            if($bool) return false;
        }
        
        return true;
    }
    
    protected function CheckFindPropsPreview($code, $val, $text)
    {
        $arDubleProperties = $this->arDubleFindPropertiesPreview;
        $bool = false;
        if(isset($arDubleProperties[$code]))
        {   
            foreach($arDubleProperties[$code] as $prop)
            {
                $v = $this->arFindPropertiesPreview[$prop];
                //if(preg_match("/".$v."/", $text))
                if(strpos($text, $v)!==false)
                {
                    $bool  = true;
                }    
            }
            if($bool) return false;
        }
        //if(preg_match("/".$val."/", $text)) return true;
        if(strpos($text, $val)!==false) return true;
        else return false;
    }

    protected function parseCatalogMeta()
    {
        if($this->checkUniq()) return false;
        if($this->meta_description!="N" || $this->meta_keywords!="N")
        {
            foreach($this->detailHtml["meta"] as $meta)
            {
                if($this->meta_description!="N" && strtolower(pq($meta)->attr("name"))=="description")
                {
                    $meta_text = pq($meta)->attr("content");
                    if(!$meta_text)$meta_text = pq($meta)->attr("value");
                    if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                        $meta_text = mb_convert_encoding($meta_text, LANG_CHARSET, "utf-8");
                    }
                    $this->arFields["PROPERTY_VALUES"][$this->meta_description] = strip_tags($meta_text);
                }elseif($this->meta_keywords!="N" && strtolower(pq($meta)->attr("name"))=="keywords")
                {
                    $meta_text = pq($meta)->attr("content");
                    if(!$meta_text)$meta_text = pq($meta)->attr("value");
                    if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                        $meta_text = mb_convert_encoding($meta_text, LANG_CHARSET, "utf-8");
                    }
                    $this->arFields["PROPERTY_VALUES"][$this->meta_keywords] = strip_tags($meta_text);
                }
                unset($meta_text);
            }
        }

        if($this->meta_title!="N")
        {
            $meta_title = pq($this->detailHtml["head:eq(0) title:eq(0)"])->text();
            $meta_title = strip_tags($meta_title);
            if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                $meta_title = mb_convert_encoding($meta_title, LANG_CHARSET, "utf-8");
            }
            $this->arFields["PROPERTY_VALUES"][$this->meta_title] = $meta_title;
        }

    }

    protected function parseCatalogFirstUrl()
    {
        if($this->checkUniq()) return false;
        if($this->first_title!="N")
        {
            $this->arFields["PROPERTY_VALUES"][$this->first_title] = $this->arFields["LINK"];
        }
    }

    protected function parseCatalogDate()
    {

    }

    protected function parseCatalogPropFile($code, $el)
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"])) return false;
        $ar = $this->GetArraySrcAttr($this->settings["catalog"]["selector_prop"][$code]);
        $file = $ar["path"];
        $attr = $ar["attr"];
        $n = 0;

        $isElement = $this->checkUniq();

        foreach(pq($el)->find($file) as $f)
        {
            $src = pq($f)->attr($attr);
            $descr = strip_tags(pq($f)->html());
            $src = $this->parseCaralogFilterSrc($src);
            $src = $this->getCatalogLink($src);
            $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["VALUE"] = CFile::MakeFileArray($src);
            $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["DESCRIPTION"] = $descr;
            $n++;
        }
        if($isElement)
        {
            $arFiles = $this->arFields["PROPERTY_VALUES"][$code];
            unset($this->arFields["PROPERTY_VALUES"][$code]);
            $obElement = new CIBlockElement;
            $rsProperties = $obElement->GetProperty($this->iblock_id, $isElement, "sort", "asc",  Array("CODE"=>$code));
            while($arProperty = $rsProperties->Fetch())
            {
                $arFiles[$arProperty["PROPERTY_VALUE_ID"]] = array(
                        "tmp_name" => "",
                        "del" => "Y",
                );
            }
            CIBlockElement::SetPropertyValueCode($isElement, $code, $arFiles);
            unset($obElement);
        }
    }
    
    protected function parseCatalogPropFilePreview($code, $el)
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"])) return false;
        $ar = $this->GetArraySrcAttr($this->settings["catalog"]["selector_prop_preview"][$code]);
        $file = $ar["path"];
        $attr = $ar["attr"];
        $n = 0;

        $isElement = $this->checkUniq();

        foreach(pq($el)->find($file) as $f)
        {
            $src = pq($f)->attr($attr);
            $descr = strip_tags(pq($f)->html());
            $src = $this->parseCaralogFilterSrc($src);
            $src = $this->getCatalogLink($src);
            $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["VALUE"] = CFile::MakeFileArray($src);
            $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["DESCRIPTION"] = $descr;
            $n++;
        }
        
        if($isElement)
        {
            $arFiles = $this->arFields["PROPERTY_VALUES"][$code];
            unset($this->arFields["PROPERTY_VALUES"][$code]);
            $obElement = new CIBlockElement;
            $rsProperties = $obElement->GetProperty($this->iblock_id, $isElement, "sort", "asc",  Array("CODE"=>$code));
            while($arProperty = $rsProperties->Fetch())
            {
                $arFiles[$arProperty["PROPERTY_VALUE_ID"]] = array(
                        "tmp_name" => "",
                        "del" => "Y",
                );
            }
            CIBlockElement::SetPropertyValueCode($isElement, $code, $arFiles);
            unset($obElement);
        }
    }

    protected function parseCatalogProp($code, $val, $text)
    {
        //$text = str_replace($val, "", $text);
        
        $val = preg_quote($val, "/");
        $text = preg_replace("/(".$val.")/", "", $text, 1);
        
        $val = trim($text);
        
        if(empty($val)) return false;

        $arProp = $this->arProperties[$code];
        //$default = $this->settings["catalog"]["default_prop"][$code];
        
        if($arProp["PROPERTY_TYPE"]!="N" && isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"])
            $val = $this->locText($val, $arProp["USER_TYPE"]=="HTML"?"html":"plain");
        
        if($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }elseif($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsDirectory($arProp, $code, $val);;
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsDirectory($arProp, $code, $val);;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y")
        {
            $val = $this->actionFieldProps($code, $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y")
        {
            $val = $this->actionFieldProps($code, $val);
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;
        }
        elseif($arProp["PROPERTY_TYPE"]=="N")
        {
            $val =  str_replace(",", ".", $val);
            $val = preg_replace("/\.{1}$/", "", $val);
            $val = preg_replace('/[^0-9.]/', "", $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;    

        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsL($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsL($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]!="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsE($arProp, $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]=="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsE($arProp, $code, $val);
        }
    }

    protected function parseCatalogPropOffer($code, $val, $text)
    {
        //$text = str_replace($val, "", $text);
        
        $val = preg_quote($val, "/");
        $text = preg_replace("/(".$val.")/", "", $text, 1);
        
        $val = trim($text);
        
        if(empty($val)) return false;
        
        $arProp = $this->arPropertiesOffer[$code];
        
        if($arProp["PROPERTY_TYPE"]!="N" && isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"])
            $val = $this->locText($val, $arProp["USER_TYPE"]=="HTML"?"html":"plain");
        
        //$default = $this->settings["catalog"]["default_prop"][$code];
        if($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }elseif($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code]["n0"] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arOffer["PROPERTY_VALUES"][$code] = $this->CheckPropsDirectory($arProp, $code, $val);;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arOffer["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsDirectory($arProp, $code, $val);;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code]["n0"] = $val;
        }
        elseif($arProp["PROPERTY_TYPE"]=="N")
        {
            $val =  str_replace(",", ".", $val);
            $val = preg_replace("/\.{1}$/", "", $val);
            $val = preg_replace('/[^0-9.]/', "", $val);
            $this->arOffer["PROPERTY_VALUES"][$code] = $val;    
            
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code] = $this->CheckPropsLOffer($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsLOffer($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]!="Y")
        {   
            $this->arOffer["PROPERTY_VALUES"][$code] = $this->CheckPropsE($arProp, $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]=="Y")
        {   
            $this->arOffer["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsE($arProp, $code, $val);
        }
    }
    
    protected function parseCatalogDefaultProp($code, $val)
    {
        $val = trim($val);
        $arProp = $this->arProperties[$code];
        if(empty($val)) return false;
        if($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $val;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="N")
        {
            $val =  str_replace(",", ".", $val);
            $val = preg_replace("/\.{1}$/", "", $val);
            $val = preg_replace('/[^0-9.]/', "", $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;    

        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]!="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsE($arProp, $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]=="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsE($arProp, $code, $val);
        }
    }

    protected function CheckPropsDirectory($arProp, $code, $val)
    {
        $element_xml_id = Cutil::translit($val, 'ru', array('change_case' => 'U'));
        $element_xml_id = self::GetCleanCode($element_xml_id);
        
        $this->getDirectoryValues($arProp);
        $nameTable = $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"];
        if(!empty($this->arDirectory[$nameTable]))
        {
            if(isset($this->arDirectory[$nameTable][$element_xml_id]) && $this->arDirectory[$nameTable][$element_xml_id])
            {
                return  $element_xml_id;
            }else{
                $hlblock = Bitrix\Highloadblock\HighloadBlockTable::getList(array(
                    "filter" => array(
                    "TABLE_NAME" => $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"],
                )))->fetch();
                $arFields = array(
                        "UF_XML_ID" => $element_xml_id,
                        "UF_NAME" => $val,
                );
                $entity = Bitrix\Highloadblock\HighloadBlockTable::compileEntity($hlblock);
                $entity_data_class = $entity->getDataClass();
                $entity_data_class::add($arFields);
                return $element_xml_id;    
            }    
        }
    }
    
    protected function GetCleanCode($code) {

        if(is_numeric($code[0])) {
            $code = 'N'.$code;
        }

        return $code;
    }
    
    protected function getDirectoryValues($arProp)
    {
        $nameTable = $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"];
        if(isset($this->arDirectory[$nameTable])) return false;
        $directorySelect = array("*");
        $directoryOrder = array();
        $entityGetList = array(
            'select' => $directorySelect,
            'order' => $directoryOrder
        );
        $arProperty = array();
        $highBlock = \Bitrix\Highloadblock\HighloadBlockTable::getList(array("filter" => array('TABLE_NAME' => $nameTable)))->fetch();
        $entity = \Bitrix\Highloadblock\HighloadBlockTable::compileEntity($highBlock);
        $entityDataClass = $entity->getDataClass();
        $propEnums = $entityDataClass::getList($entityGetList);
        $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
        $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
        while ($oneEnum = $propEnums->fetch())
        {
            $arProperty[$oneEnum["UF_XML_ID"]] = $oneEnum["UF_XML_ID"];
        } 
        $this->arDirectory[$nameTable] = $arProperty;
    }
    
    protected function CheckPropsE($arProp, $code, $val)
    {
        $IBLOCK_ID = $arProp["LINK_IBLOCK_ID"];

        $rsProp = CIBlockElement::GetList(Array(), array("IBLOCK_ID"=>$IBLOCK_ID, "%NAME"=>$val), false, false, array("ID", "NAME"));
        while($arIsProp = $rsProp->Fetch())
        {
            $arIsProp["NAME"] = mb_strtolower($arIsProp["NAME"], LANG_CHARSET); 
            $val0 = mb_strtolower($val, LANG_CHARSET);
            if($val0==$arIsProp["NAME"])
            {
                $isProp = $arIsProp["ID"];
            }
        }
        
        if($isProp) return $isProp;
        else{
            $codeText = CUtil::translit($val, "ru", array(
                        "max_len" => 100,
                        "change_case" => 'L', // 'L' - toLower, 'U' - toUpper, false - do not change
                        "replace_space" => '_',
                        "replace_other" => '_',
                        "delete_repeat_replace" => true,
            ));
            $arFields = array(
                "NAME"=>$val,
                "ACTIVE" => "Y",
                "IBLOCK_ID" => $IBLOCK_ID,
                "CODE" => $codeText
            );
            $el = new CIBlockElement;
            $id = $el->Add($arFields);
            if(!$id)
            {
                $this->errors[] = GetMessage("error_add_prop_e").$this->arFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }
            unset($el);
            return $id;
        }
    }

    protected function CheckPropsL($id, $code, $val)
    {
        $res2 = CIBlockProperty::GetPropertyEnum(
            $id,
            array(),
            array("IBLOCK_ID" => $this->iblock_id, "VALUE" => $val)
        );

        if ($arRes2 = $res2->Fetch())
        {
            $kz = $arRes2["ID"];
        }
        else
        {
            $tmpid = md5(uniqid(""));
            $kz = CIBlockPropertyEnum::Add(
                array(
                "PROPERTY_ID" => $id,
                "VALUE" => $val,
                "TMP_ID" => $tmpid
            )
            );

        }

        return $kz;
    }
    
    protected function CheckPropsLOffer($id, $code, $val)
    {
        $res2 = CIBlockProperty::GetPropertyEnum(
            $id,
            array(),
            array("IBLOCK_ID" => $this->iblockOffer, "VALUE" => $val)
        );

        if ($arRes2 = $res2->Fetch())
        {
            $kz = $arRes2["ID"];
        }
        else
        {
            $tmpid = md5(uniqid(""));
            $kz = CIBlockPropertyEnum::Add(
                array(
                "PROPERTY_ID" => $id,
                "VALUE" => $val,
                "TMP_ID" => $tmpid
            )
            );

        }

        return $kz;
    }

    protected function getFindProduct()
    {
        if(isset($this->settings["catalog"]["find_product"]) && !empty($this->settings["catalog"]["find_product"]))foreach($this->settings["catalog"]["find_product"] as $i=>$prop)
        {
            $prop = trim($prop);
            if(!empty($prop))
            {
                $arProps[$i] = $prop;
            }
        }
        if(!$arProps) return false;
        return $arProps;
    }

    protected function getSelectorProduct()
    {
        if(isset($this->settings["catalog"]["selector_product"]) && !empty($this->settings["catalog"]["selector_product"]))foreach($this->settings["catalog"]["selector_product"] as $i=>$prop)
        {
            $prop = trim($prop);
            if(!empty($prop))
            {
                $arProps[$i] = $prop;
            }
        }
        if(!$arProps) return false;
        return $arProps;
    }
    
    protected function getFindDubleProperties()
    {
        $arFindProps = $this->arFindProperties;
        if(!empty($arFindProps))foreach($arFindProps as $code=>$prop)
        {
            foreach($arFindProps as $code1=>$prop1)
            {
                if(strpos($prop1, $prop)!==false && $code1!=$code && $prop1!=$prop)
                {
                    $arDubleProps[$code][] = $code1;
                }
            }        
        }
        if(isset($arDubleProps)) return $arDubleProps;
        else return false;    
    }

    protected function getFindDublePropertiesOffer()
    {
        $arFindProps = $this->arFindPropertiesOffer;
        if(!empty($arFindProps))foreach($arFindProps as $code=>$prop)
        {
            foreach($arFindProps as $code1=>$prop1)
            {
                if(strpos($prop1, $prop)!==false && $code1!=$code && $prop1!=$prop)
                {
                    $arDubleProps[$code][] = $code1;
                }    
            }
        }
        if(isset($arDubleProps)) return $arDubleProps;
        else return false;    
    }
    
    protected function getFindDublePropertiesPreview()
    {
        $arFindProps = $this->arFindPropertiesPreview;
        if(!empty($arFindProps))foreach($arFindProps as $code=>$prop)
        {
            foreach($arFindProps as $code1=>$prop1)
            {
                if(strpos($prop1, $prop)!==false && $code1!=$code && $prop1!=$prop)
                {
                    $arDubleProps[$code][] = $code1;
                }    
            }        
        }
        if(isset($arDubleProps)) return $arDubleProps;
        else return false;    
    }

    protected function getFindProperties()
    {
        if(isset($this->settings["catalog"]["find_prop"]) && !empty($this->settings["catalog"]["find_prop"]))
        {
            foreach($this->settings["catalog"]["find_prop"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!isset($arProps)) return false;
            return $arProps;
        }
        return false;        
    }
    
    protected function getFindPropertiesOffer()
    {
        if(isset($this->settings["offer"]["find_prop"]) && !empty($this->settings["offer"]["find_prop"]))
        {
            foreach($this->settings["offer"]["find_prop"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!isset($arProps)) return false;
            return $arProps;
        }
        return false;        
    }
    
    protected function getFindPropertiesPreview()
    {
        if(isset($this->settings["catalog"]["find_prop_preview"]) && !empty($this->settings["catalog"]["find_prop_preview"]))
        {
            foreach($this->settings["catalog"]["find_prop_preview"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!isset($arProps)) return false;
            return $arProps;
        }
        return false;
        
    }

    protected function getSelectorProperties()
    {
        if(isset($this->settings["catalog"]["selector_prop"]) && !empty($this->settings["catalog"]["selector_prop"]))
        {
            $arProps = false;
            foreach($this->settings["catalog"]["selector_prop"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!$arProps) return false;
            return $arProps;    
        }
        
        return false;

    }
    
    protected function getSelectorPropertiesOffer()
    {
        if(isset($this->settings["offer"]["selector_prop"]) && !empty($this->settings["offer"]["selector_prop"]))
        {
            $arProps = false;
            foreach($this->settings["offer"]["selector_prop"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!$arProps) return false;
            return $arProps;    
        }
        
        return false;
    }
    
    protected function getSelectorPropertiesPreview()
    {
        if(isset($this->settings["catalog"]["selector_prop_preview"]) && !empty($this->settings["catalog"]["selector_prop_preview"]))
        {
            $arProps = false;
            foreach($this->settings["catalog"]["selector_prop_preview"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!$arProps) return false;
            return $arProps;    
        }
        return false;
    }

    protected function parseCatalogDetailMorePhoto(&$el)
    {
        if($this->settings["catalog"]["more_image_props"])
        {
            if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["more_img"])) return false;
            $code = $this->settings["catalog"]["more_image_props"];
            $ar = $this->GetArraySrcAttr($this->settings["catalog"]["more_image"]);
            $image = $ar["path"];
            $attr = $ar["attr"];
            $n = 0;

            $isElement = $this->checkUniq();
            foreach(pq($el)->find($image) as $img)
            {   
                $src = pq($img)->attr($attr);
                
                $src = $this->parseSelectorStyle($attr, $src);
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                if(isset($this->arPhoto[$src])) continue 1;
                $this->arPhoto[$src] = 1;
                $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["VALUE"] = CFile::MakeFileArray($src);
                $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["DESCRIPTION"] = "";
                $n++;
            }
            if($isElement)
            {
                $arImages = $this->arFields["PROPERTY_VALUES"][$code];
                unset($this->arFields["PROPERTY_VALUES"][$code]);
                $obElement = new CIBlockElement;
                $rsProperties = $obElement->GetProperty($this->iblock_id, $isElement, "sort", "asc",  Array("CODE"=>$code));
                while($arProperty = $rsProperties->Fetch())
                {
                    $arImages[$arProperty["PROPERTY_VALUE_ID"]] = array(
                        "tmp_name" => "",
                        "del" => "Y",
                    );
                }
                CIBlockElement::SetPropertyValueCode($isElement, $code, $arImages);
                unset($obElement);
            }

        }



    }

    protected function parserCatalogDetailPage()
    {
        $this->catalogSleep();
        $this->detailFileHtml = new FileGetHtml();
        $this->detailPage = $this->fileHtml->file_get_html($this->arFields["LINK"], $this->settings["catalog"]["proxy"], $this->auth);  
        $this->DeleteCharsetHtml5($this->detailPage);
        $this->detailHttpCode = $this->fileHtml->httpCode;
        if($this->detailHttpCode!=200 && $this->detailHttpCode!=301 && $this->detailHttpCode!=302 && $this->detailHttpCode!=303)
        {
            $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."]".GetMessage("parser_error_connect")."[".$this->detailHttpCode."]";
            //return false;
        }
        $this->detailHtml = phpQuery::newDocument($this->detailPage, "text/html;charset=".LANG_CHARSET);
        $this->base = $this->GetMetaBase($this->detailHtml);
        //if($this->detail_delete_element)$this->deleteCatalogElement($this->detail_delete_element, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        //if($this->detail_delete_attribute)$this->deleteCatalogAttribute($this->detail_delete_attribute, $this->detail_dom, $this->detailHtml[$this->detail_dom]);

        foreach($this->detailHtml[$this->detail_dom] as $detail)
        {
            return $detail;
        }
        $this->errors[] = GetMessage("parser_error_selecto_detail_notfound");


    }

    protected function parseCatalogUrlPreview($el)
    {
        if($this->settings["catalog"]["href"]=="a:parent")
        {
            $p = pq($el)->attr("href");        
        }else{
            $url = $this->settings["catalog"]["href"]?$this->settings["catalog"]["href"]:"a:eq(0)";
            $this->settings["catalog"]["href"] = $url;
            $p = pq($el)->find($url)->attr("href");    
        }
        
        if(!$p)
        {
            $this->errors[] = GetMessage("parser_error_href_notfound");
            return false;
        }

        $p = $this->getCatalogLink($p);
        //$this->convetCyrillic($p);
        $this->arFields["LINK"] = $p;
        if(isset($this->pagePrevElement[$p])) return false;
        return true;
    }

    protected function parseCatalogNamePreview($el)
    {
        if(isset($this->settings["catalog"]["detail_name"]) && $this->settings["catalog"]["detail_name"]) return false;
        $name = $this->settings["catalog"]["name"]?$this->settings["catalog"]["name"]:$this->settings["catalog"]["href"];

        $this->arFields["NAME"] = trim(htmlspecialchars_decode(trim(strip_tags(pq($el)->find($name)->html()))));
        
        if($this->arFields["NAME"])
        {
            $this->arFields["NAME"] = $this->actionFieldProps("SOTBIT_PARSER_NAME_E", $this->arFields["NAME"]);
            if(isset($this->settings["loc"]["f_name"]) && $this->settings["loc"]["f_name"]=="Y")
            {
                $this->arFields["NAME"] = $this->locText($this->arFields["NAME"]);    
            }
            
        }
        
        if(!$this->arFields["NAME"])
        {
            $this->errors[] = GetMessage("parser_error_name_notfound");
            return false;
        }
    }
    
    protected function actionFieldProps($code, $val)
    {
        if(isset($this->settings["catalog"]["action_props_val"][$code]) && $this->settings["catalog"]["action_props_val"][$code])
        {
            foreach($this->settings["catalog"]["action_props_val"][$code] as $i=>$v)
            {   
                {   
                    if($this->settings["catalog"]["action_props"][$code][$i]=="") continue 1;
                    if($this->settings["catalog"]["action_props"][$code][$i]=="delete")
                    {
                        $val = str_replace($v, "", $val);    
                    }
                    if($this->settings["catalog"]["action_props"][$code][$i]=="add_b")
                    {
                        $val = $v.$val;    
                    }
                    if($this->settings["catalog"]["action_props"][$code][$i]=="add_e")
                    {
                        $val = $val.$v;    
                    }    
                }
            }
                    
        }
        return trim($val);
    }
    
    protected function parseCatalogNameDetail($el)
    {
        if($this->detail_delete_element)$this->deleteCatalogElement($this->detail_delete_element, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        if($this->detail_delete_attribute)$this->deleteCatalogAttribute($this->detail_delete_attribute, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        
        if(!isset($this->settings["catalog"]["detail_name"]) || !$this->settings["catalog"]["detail_name"]) return false;
        $name = $this->settings["catalog"]["detail_name"];

        $this->arFields["NAME"] = htmlspecialchars_decode(trim(strip_tags(pq($el)->find($name)->html())));
        if($this->arFields["NAME"])
        {
            $this->arFields["NAME"] = $this->actionFieldProps("SOTBIT_PARSER_NAME_E", $this->arFields["NAME"]);
            if(isset($this->settings["loc"]["f_name"]) && $this->settings["loc"]["f_name"]=="Y")
            {
                $this->arFields["NAME"] = $this->locText($this->arFields["NAME"]);    
            }
        }
        if(!$this->arFields["NAME"])
        {
            $this->errors[] = GetMessage("parser_error_name_notfound");
            return false;
        }
    }
    
    protected function parseCatalogPriceFormat($price)
    {
        $price = trim($price);
        
        if(isset($this->settings["catalog"]["price_format1"]) && $this->settings["catalog"]["price_format1"] && isset($this->settings["catalog"]["price_format2"]) && $this->settings["catalog"]["price_format2"])
        {
            $price = str_replace($this->settings["catalog"]["price_format1"], "", $price);
            $price = str_replace($this->settings["catalog"]["price_format2"], ".", $price);
        }
        else $price = str_replace(",", ".", $price);
        
        $price = preg_replace("/\.{1}$/", "", $price);
        $price = preg_replace('/[^0-9.]/', "", $price);
        return $price;
    }
    
    protected function parseCatalogPriceOkrug($price)
    {   
        $price = trim($price);
        if($price)
        {
            if(isset($this->settings["catalog"]["price_okrug"]))
            {
                if($this->settings["catalog"]["price_okrug"]=="up")
                {
                    if(!isset($this->settings["catalog"]["price_okrug_delta"]) || !$this->settings["catalog"]["price_okrug_delta"])
                        $delta = 0;
                    else
                        $delta = $this->settings["catalog"]["price_okrug_delta"];
                        
                    $price = round($price, $delta);
                }elseif($this->settings["catalog"]["price_okrug"]=="ceil")
                {
                    $price = ceil($price);    
                }elseif($this->settings["catalog"]["price_okrug"]=="floor")
                {
                    $price = floor($price);    
                }
            }
        }
        
        return $price;
    }

    protected function parseCatalogPricePreview(&$el)
    {
        if($this->settings["catalog"]["preview_price"])
        {
            if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"])) return false;
            $price = $this->settings["catalog"]["preview_price"];
            $price = strip_tags(pq($el)->find($price)->html());
            $price = $this->parseCatalogPriceFormat($price);
            //$price = $this->parseCatalogPriceOkrug($price);
            
            $this->arPrice["PRICE"] = $price;
            $this->arPrice["PRICE"] = trim($this->arPrice["PRICE"]);
            if(!$this->arPrice["PRICE"])
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."]".GetMessage("parser_error_price_notfound");
                unset($this->arPrice["PRICE"]);
                return false;
            }
            $this->arPrice["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
            $this->arPrice["CURRENCY"] = $this->settings["catalog"]["currency"];
        }

    }

    protected function parseCatalogPriceDetail(&$el)
    {

        if($this->settings["catalog"]["detail_price"])
        {
            if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"])) return false;
            $price = $this->settings["catalog"]["detail_price"];
            $price = strip_tags(pq($el)->find($price)->html());
            $price = $this->parseCatalogPriceFormat($price);
            //$price = $this->parseCatalogPriceOkrug($price);
            
            $this->arPrice["PRICE"] = $price;
            $this->arPrice["PRICE"] = trim($this->arPrice["PRICE"]);
            if(!$this->arPrice["PRICE"])
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."]".GetMessage("parser_error_price_notfound");
                unset($this->arPrice["PRICE"]);
                return false;
            }
            $this->arPrice["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
            $this->arPrice["CURRENCY"] = $this->settings["catalog"]["currency"];
        }

    }

    protected function parseCatalogDescriptionPreview(&$el)
    {
        if($this->checkUniq() && (!$this->isUpdate || $this->isUpdate["preview_descr"]=="N")) return false;
        if($this->settings["catalog"]["preview_text_selector"] && $this->settings["catalog"]["text_preview_from_detail"]!="Y")
        {
            $preview = $this->settings["catalog"]["preview_text_selector"];
            foreach(pq($el)->find($preview." img") as $img)
            {
                $src = pq($img)->attr("src");
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                $this->parseCatalogSaveImgServer($img, $src);
            }

            if($this->bool_preview_delete_tag=="Y")$preview_text = strip_tags(pq($el)->find($preview)->html(), htmlspecialcharsBack($this->preview_delete_tag));
            else $preview_text = pq($el)->find($preview)->html();
            
            
            $preview_text = trim($preview_text);
            if(isset($this->settings["loc"]["f_preview_text"]) && $this->settings["loc"]["f_preview_text"]=="Y")
            {
                $preview_text = $this->locText($preview_text, $this->preview_text_type=="html"?"html":"plain");    
            }
            
            $this->arFields["PREVIEW_TEXT"] = trim($preview_text);
            $this->arFields["PREVIEW_TEXT_TYPE"] = $this->preview_text_type;
        }
    }

    protected function parseCatalogDescriptionDetail(&$el)
    {
        //if($this->detail_delete_element)$this->deleteCatalogElement($this->detail_delete_element, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        //if($this->detail_delete_attribute)$this->deleteCatalogAttribute($this->detail_delete_attribute, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        if($this->checkUniq() && (!$this->isUpdate || (!$this->isUpdate["detail_descr"] && (!$this->isUpdate["preview_descr"] && !$this->settings["catalog"]["text_preview_from_detail"]!="Y")))) return false;
        if($this->settings["catalog"]["detail_text_selector"])
        {
            $detail = $this->settings["catalog"]["detail_text_selector"];
            $arDetail = explode(",", $detail);
            $detail_text = "";
            if($arDetail && !empty($arDetail))
            {
                foreach($arDetail as $detail)
                {
                    $detail = trim($detail);
                    if(!$detail) continue 1;

                    foreach(pq($el)->find($detail." img") as $img)
                    {
                        $src = pq($img)->attr("src");
                        $src = $this->parseCaralogFilterSrc($src);
                        $src = $this->getCatalogLink($src);
                        $this->parseCatalogSaveImgServer($img, $src);
                    }

                    if($this->bool_detail_delete_tag=="Y")$detail_text .= strip_tags(pq($el)->find($detail)->html(), htmlspecialcharsBack($this->detail_delete_tag));
                    else $detail_text .= pq($el)->find($detail)->html();

                }
            }

            /*foreach(pq($el)->find($detail." img") as $img)
            {
                $src = pq($img)->attr("src");
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                $this->parseCatalogSaveImgServer($img, $src);
            }
            if($this->bool_detail_delete_tag=="Y")$detail_text = strip_tags(pq($el)->find($detail)->html(), htmlspecialcharsBack($this->detail_delete_tag));
            else $detail_text = pq($el)->find($detail)->html();*/
            $detail_text = trim($detail_text);
            if(isset($this->settings["loc"]["f_detail_text"]) && $this->settings["loc"]["f_detail_text"]=="Y")
            {
                $detail_text = $this->locText($detail_text, $this->detail_text_type=="html"?"html":"plain");    
            }
            $this->arFields["DETAIL_TEXT"] = $detail_text;
            $this->arFields["DETAIL_TEXT_TYPE"] = $this->detail_text_type;
            if($this->settings["catalog"]["text_preview_from_detail"]=="Y")
            {
                $this->arFields["PREVIEW_TEXT"] = $this->arFields["DETAIL_TEXT"];
                $this->arFields["PREVIEW_TEXT_TYPE"] = $this->arFields["DETAIL_TEXT_TYPE"];
            }
        }
    }

    protected function parseCatalogDetailPicture(&$el)
    {   
        if($this->checkUniq() && (!$this->isUpdate || (!$this->isUpdate["detail_img"] && (!$this->isUpdate["preview_img"] && !$this->settings["catalog"]["img_preview_from_detail"]!="Y")))) return false;
        if($this->settings["catalog"]["detail_picture"])
        {    
            $arSelPic = explode(",", $this->settings["catalog"]["detail_picture"]);

            foreach($arSelPic as $sel)
            {
                $sel = trim($sel);
                if(empty($sel)) continue;
                $ar = $this->GetArraySrcAttr($sel); 
                $img = $ar["path"];
                $attr = $ar["attr"];
                $src = pq($el)->find($img)->attr($attr); 
                $src = $this->parseSelectorStyle($attr, $src);
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src); 
                if(!self::CheckImage($src)) continue;
                $this->arPhoto[$src] = 1;
                //$src = str_replace("cdn.", "", $src);
                $this->arFields["DETAIL_PICTURE"] = CFile::MakeFileArray($src);

                if($this->settings["catalog"]["img_preview_from_detail"]=="Y")
                {
                    $this->arFields["PREVIEW_PICTURE"] = $this->arFields["DETAIL_PICTURE"];
                }
            }

        }
    }

    protected function CheckImage($src)
    {
        if(!empty($src) && preg_match("/(jpeg|jpg|gif|png|JPEG|JPG|GIF|PNG)$/", $src))
        {
            return true;
        }else return false;
    }

    protected function parseCatalogPreviewPicturePreview(&$el)
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["preview_img"])) return false;
        if($this->settings["catalog"]["preview_picture"] && $this->settings["catalog"]["img_preview_from_detail"]!="Y")
        {   
            $ar = $this->GetArraySrcAttr($this->settings["catalog"]["preview_picture"]);
            $img = $ar["path"];
            $attr = $ar["attr"];
            $src = pq($el)->find($img)->attr($attr);
            $src = $this->parseSelectorStyle($attr, $src);
            $src = $this->parseCaralogFilterSrc($src);
            $src = $this->getCatalogLink($src);
            //$src = str_replace("cdn.", "", $src);
            if(!self::CheckImage($src)) return;
            $this->arFields["PREVIEW_PICTURE"] = CFile::MakeFileArray($src);
        }
    }

    protected function parseSelectorStyle($attr, $src)
    {
        if($attr=="style" && $src)
        {
            preg_match("/url\(([^)]*)\)/", $src, $matches);
            if(isset($matches[1]) && $matches[1])
            {
                $src = str_replace(array('"', "'"), "", $matches[1]);
            }
        }

        return $src;
    }

    protected function parseCatalogSaveImgServer($img, $src){
        
        $arImg = CFile::MakeFileArray($src);
        
        if(isset($this->albumID) && $this->albumID)
            $this->addAlbumCollection($arImg, $img);
        else{
            $fid = CFile::SaveFile($arImg, "shs.parser");
            pq($img)->attr('src', CFile::GetPath($fid));    
        }
        

    }
    
    protected function createAlbum()
    {   
        CModule::IncludeModule("fileman");
        CMedialib::Init();
        $arCollections = CMedialibCollection::GetList(array('arOrder'=>Array('NAME'=>'ASC'),'arFilter' => array('ACTIVE' => 'Y', "NAME"=>"SOTBIT_PARSER")));
        if(!$arCollections)
        {
            $this->albumID = CMedialibCollection::Edit(array("arFields" => array("NAME"=>"SOTBIT_PARSER")));    
        }else
            $this->albumID = $arCollections[0]["ID"];
    }
    
    protected function addAlbumCollection($arImg, $img)
    {
        $res = CMedialibItem::Edit(array(
                'file' => $arImg,
                'arFields' => array(
                    'ID' => 0,
                    'NAME' => $arImg["name"],
                    'DESCRIPTION' => "",
                    'KEYWORDS' => ""
                ),
                'arCollections' => array($this->albumID)
        ));
        if($res)
        {
            pq($img)->attr('src', $res['PATH']);    
        }
    }

    public function parseCaralogFilterSrc($src){
        $src = preg_replace('/#.+/', '', $src);
        $src = preg_replace('/\?.+/', '', $src);
        $countPoint = substr_count($src, ".");
        if($countPoint>=2 && preg_match("/^\/{2}/", $src) && !preg_match("/^\/{2}www\./", $src) && !preg_match("/http:\//", $src) && !preg_match("/https:\//", $src))
            $src = preg_replace("/^\/{2}/", "http://", $src);
        //$src = str_replace('http:/', 'http://', $src); 
        $src = str_replace('//', '/', $src);
        $src = str_replace('http:/', 'http://', $src);
        $src = str_replace('https:/', 'https://', $src);
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src) || preg_match("/https:\//", $src))
        {
            if(preg_match("/https:\//", $src))
                $src = preg_replace("/^\/{2}/", "https://", $src);
            elseif(preg_match("/http:\//", $src) || preg_match("/www\./", $src))
                $src = preg_replace("/^\/{2}/", "http://", $src);
        }
        
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src) || preg_match("/https:\//", $src))
        {
            if(preg_match("/https:\//", $src))
                $src = preg_replace("/^\/{1}/", "https://", $src);
            elseif(preg_match("/http:\//", $src) || preg_match("/www\./", $src))
                $src = preg_replace("/^\/{1}/", "http://", $src);    
        }
        
        //$src = str_replace('//', '/', $src);
        return $src;
    }

    protected function GetArraySrcAttr($path)
    {
        $ar["path"] = $image = preg_replace('#\[[^\[]+$#','',$path);
        preg_match('#\[[^\[]+$#', $path, $matches);
        $ar["attr"] = $attr = str_replace(array("[", "]"), "", $matches[0]);
        return $ar;
    }

    protected function parseCatalogPages()
    {
        global $zis;
        foreach($this->pagenavigation as $id=>$page)
        {
            $this->clearHtml();
            
            try{
                if(isset($this->pagenavigationPrev[$page]) || isset($this->pagenavigationPrev[$id]) || empty($page)) continue;
            }catch(Exception $e)
            {
                continue;    
            } 

            
            $zis++;
           
            if($this->currentPage>=self::DEFAULT_DEBUG_LIST && $this->settings["catalog"]["mode"]=="debug") return;
            $this->connectCatalogPage($page);
            $this->parseCatalogNavigation($page);
            if($this->IsNumberPageNavigation() && $this->CheckPageNavigation($id))
            {   
                $this->parseCatalogProducts();
            }elseif(!$this->IsNumberPageNavigation())
            {
                $this->parseCatalogProducts();
            }

            $i++;

        }
        foreach($this->pagenavigationPrev as $i=>$v)
        {
            foreach($this->pagenavigation as $i1=>$v1)
            {
                if($v1==$v) unset($this->pagenavigation[$i1]);
            }
        }
        
        if(count($this->pagenavigation)>0)
        {
            $this->parseCatalogPages();
        }

    }
    
    protected function SaveCopyPage()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt", $this->page);
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt", $this->fileHtml->headerUrl);   
        }     
    }
    
    protected function DeleteCopyPage()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt"))
        {
            unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt");
            unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt"); 
        }
    }
    
    protected function GetCopyPage()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt"))
        {
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt");
            $this->httpCode = 200;
            return $file;  
        }
        $this->httpCode = 0;
        return false;
    }
    
    protected function GetCopyUrl()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt"))
        {
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt");
            return $file;  
        }
        $this->httpCode = 0;
        return false;     
    }
    
    protected function connectCatalogPage($page)
    {
        $this->catalogSleep();
        $this->sectionPage = $page;
        $this->fileHtml = new FileGetHtml();
        $this->page = $this->GetCopyPage();
        if(!$this->page)
        {   
            $this->page = $this->fileHtml->file_get_html($page, $this->settings["catalog"]["proxy"], $this->auth); 
               
        }else{
            $this->fileHtml->httpCode = 200;
            $this->fileHtml->headerUrl = $this->GetCopyUrl();    
        }
        $this->DeleteCharsetHtml5($this->page);
        $this->SaveCopyPage();
        $this->httpCode = $this->fileHtml->httpCode;
        if($this->httpCode!=200 && $this->httpCode!=301 && $this->httpCode!=302 && $this->httpCode!=303)
        {   
            {   
                
                $this->errors[] = "[".$page."]".GetMessage("parser_error_connect")."[".$this->httpCode."]";
                //if($this->agent || $this->settings["catalog"]["mode"]=="debug")
                {   
                    $this->SaveLog();
                    unset($this->errors);
                }
                
                if($this->settings["catalog"]["404"]!="Y")
                {
                    if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
                    {
                        $this->stepStart = 1;
                        $this->SavePrevPage($page);
                        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
                            unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                        $this->DeleteCopyPage();
                        $this->activeCurrentPage++;
                        $this->SetCatalogElementsResult($this->activeCurrentPage);
                        $this->clearFields();
                        $this->ClearBufferStep();
                    }
                    
                    return false;    
                }
            }
        }

        $this->currentPage++;
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")$this->SavePrevPage($page);
        //if($page==$this->rss)
        {
            $this->urlCatalog = $this->fileHtml->headerUrl;
            $this->urlSite = $this->getCatalogUrlSite();
        }
        
        return true;
    }

    protected function catalogSleep()
    {
        $sleep = $this->settings["catalog"]["sleep"];
        if($sleep)
        {
            sleep($sleep);
        }
    }
    
    protected function SavePrevPage($page)
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && $this->stepStart)
        {
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt", $page."|", FILE_APPEND);  
        }  
    }
    
    protected function SavePrevPageDetail($page)
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt", $page."|", FILE_APPEND);  
        }  
    }
    
    protected function SaveCurrentPage($arPage)
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && $this->stepStart)
        {    
            $page = implode("|", $arPage);
            if(!empty($arPage))file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt", $page."|"); 
            elseif($this->IsEndSectionUrl()) file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt", "");
            else file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt", "0");   
        }
            
    }
    
    protected function ClearAjaxFiles()
    {
        if(!$this->agent && $_GET["begin"])
        {
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt"); 
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt");  
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt"); 
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/loc".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/loc".$this->id.".txt"); 

        }elseif($this->agent)
        {
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/loc".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/loc".$this->id.".txt");
        }
           
    }
    
    protected function checkActionBegin()
    {
        //if($this->updateActive && isset($this->settings["catalog"]["uniq"]["action"]) && $this->settings["catalog"]["uniq"]["action"]!="N")
        {
            if((!$this->agent && $_GET["begin"]) || $this->agent)
            {
                
                $filterValues = array("PARSER_ID"=>$this->id);
                $arr = array(
                    "select" => array('ID'),
                    "filter" => $filterValues
                );
                
                if($this->tmp=="b_shs_parser_tmp" || !$this->tmp)
                {
                    $rsData = ShsParserTmpTable::GetList($arr);
                    
                    while($arData = $rsData->Fetch())
                    {
                        ShsParserTmpTable::Delete($arData["ID"]);
                    }        
                }elseif($this->tmp=="b_shs_parser_tmp_old")
                {
                    $rsData = ShsParserTmpOldTable::GetList($arr);
                    
                    while($arData = $rsData->Fetch())
                    {
                        ShsParserTmpOldTable::Delete($arData["ID"]);    
                    }
                }
                
            }
        }
            
    }
    
    protected function checkActionAgent($agent = true)
    {
        if((($this->agent && $agent) || !$agent) && $this->updateActive && isset($this->settings["catalog"]["uniq"]["action"]) && $this->settings["catalog"]["uniq"]["action"]!="N")
        {   
            $filterValues = array("PARSER_ID"=>$this->id);
            $arr = array(
                "select" => array('ID', "PRODUCT_ID"),
                "filter" => $filterValues
            );
            if($this->tmp=="b_shs_parser_tmp" || !$this->tmp)
            {
                $rsData = ShsParserTmpTable::GetList($arr);
                
                while($arData = $rsData->Fetch())
                {
                    $arProd[$arData["PRODUCT_ID"]] = $arData["PRODUCT_ID"];    
                }
                
                $rsDataOld = ShsParserTmpOldTable::GetList($arr);

                while($arDataOld = $rsDataOld->Fetch())
                {
                    $arProdOld[$arDataOld["PRODUCT_ID"]] = $arDataOld["PRODUCT_ID"];    
                }
                
                if(isset($arProdOld) && !empty($arProdOld))
                {
                    foreach($arProdOld as $p)
                    {
                        if(!isset($arProd[$p]))
                            $this->doProductAction($p);
                    }
                }
                $parser = new ShsParserContent();
                $arFields['TMP'] = "b_shs_parser_tmp_old";
                $parser->Update($this->id, $arFields); 
                unset($parser);
            }elseif($this->tmp=="b_shs_parser_tmp_old")
            {
                $rsData = ShsParserTmpOldTable::GetList($arr);
                
                while($arData = $rsData->Fetch())
                {
                    $arProd[$arData["PRODUCT_ID"]] = $arData["PRODUCT_ID"];
                }
                
                $rsDataOld = ShsParserTmpTable::GetList($arr);
                
                while($arDataOld = $rsDataOld->Fetch())
                {
                    $arProdOld[$arDataOld["PRODUCT_ID"]] = $arDataOld["PRODUCT_ID"];    
                }
                
                if(isset($arProdOld) && !empty($arProdOld))
                {
                    foreach($arProdOld as $p)
                    {
                        if(!isset($arProd[$p]))
                            $this->doProductAction($p);
                    }
                }
                $parser = new ShsParserContent();
                $arFields['TMP'] = "b_shs_parser_tmp";
                $parser->Update($this->id, $arFields);
                unset($parser);
            }    
        }
    }
    
    protected function doProductAction($ID)
    {
        if($this->settings["catalog"]["uniq"]["action"]=="D")
        {
            CIBlockElement::Delete($ID);
        }elseif($this->settings["catalog"]["uniq"]["action"]=="A")
        {
            $el = new CIBlockElement;
            $res = $el->Update($ID, array("ACTIVE"=>"N"));
            unset($el);
        }
    }
    
    protected function addTmp($ID)
    {   
        if(/*!$this->debug && */$ID && $this->updateActive && isset($this->settings["catalog"]["uniq"]["action"]) && $this->settings["catalog"]["uniq"]["action"]!="N")
        {
            $arFields["PARSER_ID"] = $this->id;
            $arFields["PRODUCT_ID"] = $ID;
            if($this->tmp=="b_shs_parser_tmp" || !$this->tmp)
            {   
                ShsParserTmpTable::add($arFields);    
            }elseif($this->tmp=="b_shs_parser_tmp_old")
            {   
                ShsParserTmpOldTable::add($arFields);    
            }
        }    
    }

    protected function getCatalogUrlSite(){
        if(preg_match("/http:/", $this->rss))
        {
            $url = str_replace("http://", "", $this->rss);
            $url = preg_replace("/\/.*/", "", $url);
            $url = "http://".$url;
        }elseif(preg_match("/https:/", $this->rss))
        {
            $url = str_replace("https://", "", $this->rss);
            $url = preg_replace("/\/.*/", "", $url);
            $url = "https://".$url;    
        }
        else{
            $url = preg_replace("/\/.*/", "", $this->rss);
        }
        return $url;
    }

    protected function searchCatalogNavigation()
    {

    }

    protected function parseCatalogNavigation($pageHref)
    {   
        $this->html = phpQuery::newDocument($this->page, "text/html;charset=".LANG_CHARSET);
        $this->base = $this->GetMetaBase($this->html);
       
        if($this->settings["catalog"]["pagenavigation_selector"])
        {
            $this->deleteCatalogElement($this->settings["catalog"]["pagenavigation_delete"], $this->settings["catalog"]["pagenavigation_selector"]);
            
            if(!$this->settings["catalog"]["pagenavigation_one"])
                $this->settings["catalog"]["pagenavigation_one"] = "a[href]";
            
            $arPath = $this->GetArraySrcAttr($this->settings["catalog"]["pagenavigation_one"]);
            $attr = $arPath["attr"]?$arPath["attr"]:"href";
            $element = $this->settings["catalog"]["pagenavigation_selector"]." ".$arPath["path"];

            unset($this->pagenavigation[$pageHref]);
            unset($this->pagenavigation[$this->currentPage]);
            $this->pagenavigationPrev[$pageHref] = $pageHref;


            foreach($this->html[$element] as $page)
            {
                
                $p = pq($page)->attr($attr);
                $p = $this->getCatalogLink($p);
                $p1 = $p."\\r\\n";
                $n = pq($page)->text();
                $n = $this->ValidatePageNavigation($n);
                
                if(!$p || empty($p) || (isset($this->settings["catalog"]["pagenavigation_var"]) && $this->settings["catalog"]["pagenavigation_var"]))
                {   
                    if(isset($this->settings["catalog"]["pagenavigation_var"]) && $this->settings["catalog"]["pagenavigation_var"])
                    {   
                        $nV = (int)$this->settings["catalog"]["pagenavigation_page_count"];
                        $pV = $this->settings["catalog"]["pagenavigation_var"];
                        $other = $this->settings["catalog"]["pagenavigation_other_var"];
                        
                        $req = $pV."=".$n;
                        if($other)
                            $req .= "&".$other;
                            
                        $p = $this->getUrlPageNavigation($req, $pV); 
                    }
                    else continue 1;    
                }
                  
                //$this->convetCyrillic($p);
                
                if(isset($this->pagenavigationPrev[$p])) continue;
                
                if($this->IsNumberPageNavigation())
                {   
                    if(!$this->CheckValidatePageNavigation($n) && !$this->CheckPageNavigation($n)) continue;

                    if(($this->currentPage+5)<$n)continue;
                    if($this->CheckPageNavigation($n))
                    {   
                        if(isset($this->pagenavigationPrev[$p])) continue;
                        if(isset($this->pagenavigationPrev[$n])) continue;
                        $this->pagenavigation[$n] = $p;
                    }elseif($this->CheckPageNavigationLess($n)){
                        if(isset($this->pagenavigationPrev[$p])) continue;
                        if(isset($this->pagenavigationPrev[$n])) continue;
                        $this->pagenavigation[$n] = $p;
                    } else{

                    }
                }else{

                    $this->pagenavigation[$p] = $p;
                }

            }
            return true;
        }elseif(isset($this->settings["catalog"]["pagenavigation_var"]) && $this->settings["catalog"]["pagenavigation_var"] && isset($this->settings["catalog"]["pagenavigation_page_count"]) && $this->settings["catalog"]["pagenavigation_page_count"])
        {
            $n = (int)$this->settings["catalog"]["pagenavigation_page_count"];
            $p = $this->settings["catalog"]["pagenavigation_var"];
            $other = $this->settings["catalog"]["pagenavigation_other_var"];
            for($i=2; $i<=$n;$i++)
            {
                $req = $p."=".$i;
                if($other)
                    $req .= "&".$other;
                    
                $page = $this->getUrlPageNavigation($req, $p, $other);
                $this->pagenavigation[$page] = $page;    
            }
            return true;    
        }
         
        return false;



    }
    
    protected function locText($text="", $format="plain", $test = false)
    {
        global $APPLICATION;
        if(isset($this->settings["loc"]["type"]) && $this->settings["loc"]["type"] && $text)
        {
            if($this->settings["loc"]["type"]=="yandex")
            {   
                $key = $this->settings["loc"]["yandex"]["key"];
                $lang = $this->settings["loc"]["yandex"]["lang"];
                $text0 = $text;
                $charset = strtolower(SITE_CHARSET);
                if($charset!="utf-8")
                {
                     $text = $APPLICATION->ConvertCharset($text, $charset, "utf-8");    
                }
                $text = urlencode($text);
                $url = "https://translate.yandex.net/api/v1.5/tr/translate?key=".$key."&text=".$text."&lang=".$lang."&format=".$format;
                $ch = curl_init();
                //curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_URL, "https://translate.yandex.net/api/v1.5/tr/translate");
                curl_setopt($ch, CURLOPT_POST, true);
                curl_setopt($ch, CURLOPT_POSTFIELDS, "key=".$key."&text=".$text."&lang=".$lang."&format=".$format);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 60);
                
                $arrorLoc[401] = GetMessage("shs_parser_loc_401");
                $arrorLoc[402] = GetMessage("shs_parser_loc_402");
                $arrorLoc[403] = GetMessage("shs_parser_loc_403");
                $arrorLoc[404] = GetMessage("shs_parser_loc_404");
                $arrorLoc[413] = GetMessage("shs_parser_loc_413");
                $arrorLoc[422] = GetMessage("shs_parser_loc_422");
                $arrorLoc[501] = GetMessage("shs_parser_loc_501");
                $data = curl_exec($ch);
                $xml = new CDataXML();
                $xml->LoadString($data);
                $arData = $xml->GetArray();
                
                if(isset($arData["Translation"]["#"]["text"]["0"]["#"]))
                {
                    $data = $arData["Translation"]["#"]["text"]["0"]["#"];
                    $charset = strtolower(SITE_CHARSET);
                    if($charset!="utf-8")
                    {
                         $APPLICATION->ConvertCharset($data, "utf-8", $charset);    
                    }
                    
                }elseif(isset($arData["Error"]["@"]["code"]))
                {
                    $httpCode = $arData["Error"]["@"]["code"];
                    $this->errors[] = $arrorLoc[$httpCode];
                    $data = $text0;
                }else
                    $data = $text0;
                unset($xml);
                unset($arData);
                unset($arrorLoc);
                curl_close($ch);
                return $data;
            }    
        }        
    }

    protected function deleteCatalogElement($element, $parentElement=false, $dom=false)
    {
        if($parentElement)
        {
            $arElement = explode(",", $element);
            $parentElement = trim($parentElement);
            $element = "";
            foreach($arElement as $i=>$el)
            {
                $el = trim($el);
                if(empty($el)){
                    unset($arElement[$i]);
                    continue 1;
                }
                $element.=$parentElement." ".$el;
                if(($i+1)!=count($arElement))$element.=",";
            }
        } 
        pq($element)->remove();
    }

    protected function deleteCatalogAttribute($element, $parentElement=false, $dom=false)
    {
        if($parentElement)
        {
            $arElement = explode(",", $element);
            $parentElement = trim($parentElement);
            $element = "";
            foreach($arElement as $i=>$el)
            {
                $el = trim($el);
                if(empty($el)){
                    unset($arElement[$i]);
                    continue;
                }

                preg_match('#\[[^\[]+$#', $el, $matches);
                $el = preg_replace('#\[[^\[]+$#','',$el);
                $attr = str_replace(array("[", "]"), "", $matches[0]);

                $element = $parentElement." ".$el;
                pq($element)->removeAttr($attr);
            }
        }

    }
    
    protected function DeleteParam($url="", $p="", $other="")
    {
        if(empty($url) || empty($p)) return false;
        
        $url = str_replace($other, "", $url);
        $reg = "/\?".$p."\=(\d)/";
        $url = preg_replace($reg, "", $url);
        $reg = "/".$p."\=(\d)/";
        $url = preg_replace($reg, "", $url);
        
        $url = str_replace("?&", "?", $url);
        $url = str_replace("&&", "&", $url);
        $url = str_replace("/&", "/?", $url);
        $url = preg_replace("/\?{1}$/", "", $url);
        
        return $url;
            
    }
    
    protected function getUrlPageNavigation($url="", $p="", $other="")
    {
        $url = trim($url);
        $p = trim($p);
        
        if(empty($url) || empty($p)) return false;
        
        $this->urlCatalog = $this->DeleteParam($this->urlCatalog, $p, $other);
        
        if(preg_match("/\/{1}$/", $this->urlCatalog))
        {
            $url = $this->urlCatalog."?".$url;    
        }elseif(preg_match("/\?/", $this->urlCatalog))
        {
            $url = $this->urlCatalog."&".$url;        
        }
        
        return $url;    
    }

    protected function getCatalogLink($url)
    {
        $url = trim($url);

        
        if(empty($url)) return false;
        elseif(preg_match("/^\/{2}www/", $url))
        {
            $url = preg_replace("/^\/{2}www/", "www", $url);
        }
        elseif(preg_match('/^http:/', $url) || preg_match('/www\./', $url) || preg_match('/^https:/', $url))
        {
            $url = $url;
        }elseif(preg_match("/^\//", $url))
        {   
            $url = $this->urlSite.$url;
        }elseif(!preg_match("/^\//", $url) && preg_match("/\/{1}$/", $this->urlCatalog))
        {
            if($this->base) $url = $this->base.$url;
            else $url = $this->urlCatalog.$url;
        }
        elseif(!preg_match("/^\?/", $url) && !preg_match("/^\//", $url) && !preg_match("/\/{1}$/", $this->urlCatalog))
        {   
            //$site
            if($this->base)
            {
                if(!preg_match("/\/{1}$/", $this->base))
                    $this->base = $this->base."/";
                $url = $this->base.$url;    
            }else{
                $uri = preg_replace('#/[^/]+$#','',$this->urlCatalog);
                $url = $uri."/".$url;    
            }

        }elseif(preg_match("/\?/", $url) && preg_match("/\?/", $this->urlCatalog))
        {   
            if(preg_match("/^\?/", $url))
            {
                $uri = preg_replace("/\?.+/", "", $this->urlCatalog);
                $url = $uri.$url;
            }else{
                $uri = preg_replace('#/[^/]+$#','',$this->urlCatalog);
                $url = $uri."/".$url;    
            }
        }

        $this->convetCyrillic($url);
        //$url = $this->deletePointUrl($url);
        return $url;
    }

    public function deletePointUrl($url)
    {
        $count = substr_count($url, "../");
        if($count>0)
        {
            for($i=0;$i<$count;$i++)
            {
                $url = preg_replace("/[-\w]+\/\.{2}\//", "", $url);
            }
        }
        return $url;
    }

    public function DeleteCharsetHtml5(&$data)
    {
        $data = preg_replace("/\s*<meta\s+charset=[\"|']{0,1}.+?[\"|']{0,1}\s*\/{0,1}\>/i", "", $data);
    }
    
    public function parserSelector(&$html, $selector, $nextSelector=0){
        global $shs_DOC_ENCODING;
        phpQuery::selectDocument($html);
        if($nextSelector==0 && $this->meta_description!="N")foreach($html['meta'] as $meta){
            if(strtolower(pq($meta)->attr("name"))=="description"){
                $this->meta_description_text = pq($meta)->attr("content");
                if(!$this->meta_description_text)$this->meta_description_text = pq($meta)->attr("value");
                if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) $this->meta_description_text = mb_convert_encoding($this->meta_description_text, LANG_CHARSET, "utf-8");
                if($this->meta_description_text)
                {
                    $this->meta_description_text = strip_tags($this->meta_description_text);
                    break;
                }

            }
        }
        if($nextSelector==0 && $this->meta_keywords!="N")foreach($html['meta'] as $meta){
            if(strtolower(pq($meta)->attr("name"))=="keywords"){
                $this->meta_keywords_text = pq($meta)->attr("content");
                if(!$this->meta_keywords_text)$this->meta_keywords_text = pq($meta)->attr("value");
                if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) $this->meta_keywords_text = mb_convert_encoding($this->meta_keywords_text, LANG_CHARSET, "utf-8");
                if($this->meta_keywords_text)
                {
                    $this->meta_keywords_text = strip_tags($this->meta_keywords_text);
                    break;
                }

            }
        }
        if($nextSelector==0 && $this->meta_title!="N")
        {
            $this->meta_title_text = pq($html['title'])->text();
            $this->meta_title_text = strip_tags($this->meta_title_text);
            if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                //$this->meta_title_text = mb_convert_encoding($this->meta_title_text, LANG_CHARSET, $shs_DOC_ENCODING);
                $this->meta_title_text = mb_convert_encoding($this->meta_title_text, LANG_CHARSET, "utf-8");
            }
        }


        if(empty($selector)) return $html->htmlOuter();
        else
        {
          $out = '<meta http-equiv="Content-Type" content="text/html;charset='.LANG_CHARSET.'">'.pq($selector)->html();
          return $out;
        }


    }

    public function changeImgSrc($html){
        phpQuery::selectDocument($html);
        $site = $this->getUrlSite();
        foreach($html["img"] as $img){
          $src = $this->filterSrc(pq($img)->attr("src"));
          if(!preg_match('/^http:/', $img->getAttribute('src')) && !preg_match('/^https:/', $img->getAttribute('src')) && !preg_match('/^www/', $img->getAttribute('src')) && !preg_match('/^\/{2}/', $img->getAttribute('src'))){
            if(preg_match("/^\/{1}/", $src))$src = $site.$src;
            else $src = $site."/".$src;
            $img->setAttribute('src', $src);
          }else{
            $img->setAttribute('src', $src);
          }
        }
        return $html;
    }

    public function parserFirstImg($html){
        phpQuery::selectDocument($html);
        $site = $this->getUrlSite();
        foreach($html["img"] as $img){
          $first_img = $this->filterSrc(pq($img)->attr("src"));
          if(!preg_match('/^http:/', $first_img) && !preg_match('/^www/', $first_img) && !preg_match('/^https:/', $first_img)){

            if(preg_match("/^\/{1}/", $first_img))$first_img = $site.$first_img;
            else $first_img = $site."/".$first_img;
            $arWidth = getimagesize($first_img);
            if($arWidth[0]<40) continue;
            return $first_img;
          }else{
            $arWidth = getimagesize($first_img);
            if($arWidth[0]<40) continue;
            return $first_img;
          }
        }
        return $first_img;
    }

    public function saveImgServer($html){
        foreach($html["img"] as $img){
            $arImg = CFile::MakeFileArray(pq($img)->attr("src"));
            
            if(isset($this->albumID) && $this->albumID)
                $this->addAlbumCollection($arImg, $img);
            else{
                $fid = CFile::SaveFile($arImg, "shs.parser");
                $img->setAttribute('src', CFile::GetPath($fid));    
            }
            /*$fid = CFile::SaveFile($arImg, "shs.parser");
            $img->setAttribute('src', CFile::GetPath($fid));*/
        }
        return $html->htmlOuter();
    }

    public function deleteElementStart(&$html, $selector_delete_element){
        phpQuery::selectDocument($html);
        $arElements = explode(',', $selector_delete_element);
        foreach($arElements as $selector){
          if(empty($selector)) continue;
          $selector = trim($selector);
          $html[$selector]->remove();
        }
        return $html;
    }

    public function deleteElements(&$html, $selector, $nextSelector=0){
        $arSelector = $this->arraySelector($selector);
        $n = 0;
        if(!isset($arSelector[$nextSelector])){
          $html->outertext = "";
          return;
        }
        if(strpos($arSelector[$nextSelector], '[')!==false && preg_match("/\[[0-9]{1,3}\]/", $arSelector[$nextSelector])){
            $sel = $arSelector[$nextSelector];
            $arSelector[$nextSelector] = preg_replace('/\[[0-9]{1,3}\]/', '', $sel);
            preg_match_all('/\[[0-9]{1,3}\]/', $sel, $matches);
            $n = str_replace(array('[', ']'), "", $matches[0][0]);
            $item = $html->find($arSelector[$nextSelector], $n);
            if(gettype($item)=="NULL"){
                return false;
            }
            $data = $this->deleteElements($item, $selector, $nextSelector+1);

        }else{
            foreach($html->find($arSelector[$nextSelector]) as $item){
                $data = $this->deleteElements($item, $selector, $nextSelector+1);
            }
        }

    }

    public function deleteAttributeStart(&$html, $selector_delete_attribute){

        $arElements = explode(',', $selector_delete_attribute);

        foreach($arElements as $selector){
          if(empty($selector)) continue;
          preg_match('/\[[a-zA-Z]+\]$/', $selector, $attribute);
          $attributes = str_replace(array(']', '['), "", $attribute[0]);
          $selector = preg_replace('/\[[a-zA-Z]+\]$/', "", trim($selector));
          $this->deleteAttributes($html, trim($selector), $attributes);
        }
        return $html;
    }

    public function deleteAttributes(&$html, $selector, $attribute, $nextSelector=0){
        phpQuery::selectDocument($html);
        pq($selector)->removeAttr($attribute);
    }
    
    
    
    protected function getPageRssLink($url, $path, $site)
    {
        $url = trim($url);
        $urlCatalog = $site.$path;
        /*if(empty($url)) return false;
        elseif(preg_match("/^\/{2}www/", $url))
        {
            $url = preg_replace("/^\/{2}www/", "www", $url);
        }
        elseif(preg_match('/^http:/', $url) || preg_match('/www\./', $url) || preg_match('/^https:/', $url))
        {
            $url = $url;
        }elseif(preg_match("/^\//", $url))
        {
            $url = $site.$url;
        }elseif(!preg_match("/^\//", $url) && preg_match("/\/{1}$/", $urlCatalog))
        {    
            
            if($this->base)$url = $this->base.$url;
            else $url = $urlCatalog.$url;
        }
        elseif(!preg_match("/\?/", $url) && !preg_match("/^\//", $url) && !preg_match("/\/{1}$/", $urlCatalog))
        {   
            //$site
            if($this->base) $url = $this->base.$url;
            else{
                $uri = preg_replace('#/[^/]+$#','',$urlCatalog);
                $url = $uri."/".$url;    
            }
        }elseif(preg_match("/\?/", $url) && preg_match("/\?/", $urlCatalog))
        {   
            if(preg_match("/^\?/", $url))
            {
                $uri = preg_replace("/\?.+/", "", $urlCatalog);
                $url = $uri.$url;    
            }else{
                $uri = preg_replace('#/[^/]+$#','',$urlCatalog);
                $url = $uri."/".$url;
            }
        }*/
        
        if(empty($url)) return false;
        elseif(preg_match("/^\/{2}www/", $url))
        {
            $url = preg_replace("/^\/{2}www/", "www", $url);
        }
        elseif(preg_match('/^http:/', $url) || preg_match('/www\./', $url) || preg_match('/^https:/', $url))
        {
            $url = $url;
        }elseif(preg_match("/^\//", $url))
        {   
            $url = $site.$url;
        }elseif(!preg_match("/^\//", $url) && preg_match("/\/{1}$/", $urlCatalog))
        {
            if($this->base) $url = $this->base.$url;
            else $url = $urlCatalog.$url;
        }
        elseif(!preg_match("/^\?/", $url) && !preg_match("/^\//", $url) && !preg_match("/\/{1}$/", $urlCatalog))
        {   
            //$site
            if($this->base)
            {
                if(!preg_match("/\/{1}$/", $this->base))
                    $this->base = $this->base."/";
                $url = $this->base.$url;    
            }else{
                $uri = preg_replace('#/[^/]+$#','',$urlCatalog);
                $url = $uri."/".$url;    
            }

        }elseif(preg_match("/\?/", $url) && preg_match("/\?/", $urlCatalog))
        {   
            if(preg_match("/^\?/", $url))
            {
                $uri = preg_replace("/\?.+/", "", $urlCatalog);
                $url = $uri.$url;
            }else{
                $uri = preg_replace('#/[^/]+$#','',$urlCatalog);
                $url = $uri."/".$url;    
            }
        }
        
        
        //$this->convetCyrillic($url);
        return $url;
    }

    public function getContentsArray($site='', $port=80, $path='', $query=''){
        if(!$this->type || $this->type=="rss")
        {   
            $arContent = CIBlockRSS::GetNewsEx($site, $port, $path, $query);
            
            return CIBlockRSS::FormatArray($arContent);
        }elseif($this->type=="page")
        {
            $url = $site.$path;
            if($query)$url = $url."?".$query;
            $fileHtml = new FileGetHtml();
            $data = $fileHtml->file_get_html($url, $this->proxy, $this->auth);
            $this->header_url = $url = $fileHtml->headerUrl;
            $this->DeleteCharsetHtml5($data);
            $html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET);
            $dom = htmlspecialcharsBack(trim($this->settings["page"]["selector"]));
            $href = htmlspecialcharsBack(trim($this->settings["page"]["href"]));
            $name = htmlspecialcharsBack(trim($this->settings["page"]["name"]));
            $href = $href?$href:"a:eq(0)";
            $name = $name?$name:$href;
            $this->base = $this->GetMetaBase($html);
            $i = 0;
            $site = $this->getUrlSite();
            foreach($html[$dom] as $val)
            {
                $strName =  strip_tags(pq($val)->find($name)->html());

                if($name=="a:parent")$strHref =  $strName =  strip_tags(pq($val)->html());
                else $strName =  strip_tags(pq($val)->find($name)->html());

                //$strHref =  mb_strtolower(pq($val)->find($href)->attr("href"));
                if($href=="a:parent")$strHref =  pq($val)->attr("href");
                else $strHref =  pq($val)->find($href)->attr("href");

                /*if(!preg_match('/^http:/', $strHref) && !preg_match('/^www/', $strHref) && !preg_match('/^\/{2}/', $strHref))
                {
                    if(preg_match('/^\//', $strHref))$strHref = $site.$strHref;
                    else $strHref = $site.$path.$strHref;
                }*/
                $strHref = $this->getPageRssLink($strHref, $path, $site);
                if(empty($strName)) $this->errors[] = GetMessage("parser_error_noname");
                if(empty($strHref)) $this->errors[] = GetMessage("parser_error_nohref");
                if(empty($strName) || empty($strHref)) continue;

                $arContent["item"][$i]["title"] = $strName;
                $arContent["item"][$i]["link"] = $strHref;
                $arContent["item"][$i]["description"] = pq($val)->html();
                $i++;
            }     
            if($i>0)
            {
                $arContent['title'] = $site;
                $arContent['link'] = $site;
                return  $arContent;
            }
        }
    }
    
    public function getMetaBase($html)
    {
        if(isset($this->base)) unset($this->base);
        $base = pq($html)->find("base:eq(0)")->attr("href");
        return $base;
    }

    public function getUrlSite(){
        $this->header_url = strtolower($this->header_url);
        $site = str_replace(array('http://', "https://", 'www.', "HTTP://", "WWW."), "", $this->header_url);
        $site = preg_replace('/\/(.)+/', '', $site);
        $arLevel = explode(".", $site);
        if(preg_match("/https:\//", $this->header_url))
        {
            if(count($arLevel)==2) return 'https://www.'.$site;
            else return 'https://'.$site;    
        }else{
            if(count($arLevel)==2) return 'http://www.'.$site;
            else return 'http://'.$site;    
        }
        
    }

    public function filterSrc($src){
        $src = preg_replace('/#.+/', '', $src);
        $src = preg_replace('/\?.+/', '', $src);
        //$src = str_replace('http:/', 'http://', $src);
        $src = str_replace('//', '/', $src);
        $src = str_replace('http:/', 'http://', $src);
        $src = str_replace('https:/', 'https://', $src);
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src) || preg_match("/https:\//", $src))
        {
            if(preg_match("/https:\//", $src))
                $src = preg_replace("/^\/{2}/", "https://", $src);
            elseif(preg_match("/http:\//", $src) || preg_match("/www\./", $src))
                $src = preg_replace("/^\/{2}/", "http://", $src);
        }
        //$src = preg_replace("/^\/{2}/", "http://", $src);
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src) || preg_match("/https:\//", $src))
        {
            if(preg_match("/https:\//", $src))
                $src = preg_replace("/^\/{1}/", "https://", $src);
            elseif(preg_match("/http:\//", $src) || preg_match("/www\./", $src))
                $src = preg_replace("/^\/{1}/", "http://", $src);    
        }
        //$src = str_replace('//', '/', $src);
        return $src;
    }

    public function parseImgFromRss($arItem){
        foreach($arItem as $item){
            if(is_array($item)) $preview = $this->parseImgFromRss($item);
            elseif(preg_match("/^(http:)(.)+(jpg|JPG|gif|GIF|png|PNG|JPEG|jpeg)$/", $item, $match) || preg_match("/^(https:)(.)+(jpg|JPG|gif|GIF|png|PNG|JPEG|jpeg)$/", $item, $match)){
              $preview = $match[0];
              break;
            }
        }
        return $preview;
    }

    public function arraySelector($selector, $debug=0){
        $bool = false;
        $selector = trim($selector);
        $arSel = explode(' ', $selector);
        $newArSel = array();
        $selStr = "";
        foreach($arSel as $i=>$val){
          if(preg_match('/\[/', $val) && preg_match('/\]/', $val) && !$bool) $newArSel[] = $val;
          elseif(!preg_match('/\[/', $val) && !preg_match('/\]/', $val) && !$bool) $newArSel[] = $val;
          elseif(preg_match('/\[/', $val) && !preg_match('/\]/', $val)){
            $bool = true;
            $selStr .= $val;
          }elseif(!preg_match('/\[/', $val) && !preg_match('/\]/', $val) && $bool){
            $selStr .= " ".$val;
          }elseif(preg_match('/\]/', $val) && $bool){
            $selStr .= " ".$val;
            $bool = false;
            $newArSel[] = $selStr;
            $selStr = "";
          }
        }
        return $newArSel;
    }
}
?>59   3734|/shs.parser/classes/general/file_get_html.php|76db210d<?php
class FileGetHtml{
    public $headerUrl = "";
    public $httpCode = "";
    function file_get_html($path, $proxy=false, $auth=false) {
        global $shs_ID; 
        $ch = curl_init($path); 
        //curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 6.1; rv:14.0) Gecko/20100101 Firefox/14.0.1');
        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/27.0.1453.93 Safari/537.36');
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, TRUE);
        curl_setopt ($ch, CURLOPT_SSL_VERIFYPEER, 0);//   SSL 
        curl_setopt ($ch, CURLOPT_SSL_VERIFYHOST, 0);    //   Host SSL 
        curl_setopt($ch, CURLOPT_TIMEOUT, 120);        //  
        curl_setopt($ch, CURLOPT_MAXREDIRS, 10); 
        if($auth && $shs_ID)
        {
            curl_setopt($ch, CURLOPT_COOKIEJAR, $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/coo".$shs_ID.".txt");
            curl_setopt($ch, CURLOPT_COOKIEFILE, $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/coo".$shs_ID.".txt");
        }elseif($shs_ID)
        {
            curl_setopt($ch, CURLOPT_COOKIEJAR, $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/loc".$shs_ID.".txt");
            curl_setopt($ch, CURLOPT_COOKIEFILE, $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/loc".$shs_ID.".txt");    
        } 
        
        if($proxy) curl_setopt($ch, CURLOPT_PROXY, "$proxy");
        $data = curl_exec($ch); //print $data;  
        $this->headerUrl  = curl_getinfo( $ch, CURLINFO_EFFECTIVE_URL);
        $this->httpCode = curl_getinfo( $ch, CURLINFO_HTTP_CODE ); 
        curl_close($ch); 
        return $data;
    }
    
    function auth($path, $proxy=false, $postdata, $check=false)
    {
        global $shs_ID;
        $coo = $_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/include/coo".$shs_ID.".txt";
        if($check && file_exists($coo))
            unlink($coo);
        $ch = curl_init( $path );

        $strPost = "";
        $count = 0;
        foreach($postdata as $i=>$v)
        {
            $count++;
            if(empty($i)) continue;
            $strPost .= $i."=".$v;
            if($count!=count($postdata)) $strPost .="&";
        }
        
        curl_setopt($ch, CURLOPT_URL, $path);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, TRUE);
        curl_setopt($ch, CURLOPT_AUTOREFERER, TRUE);
        curl_setopt ($ch, CURLOPT_SSL_VERIFYPEER, 0);//   SSL 
        curl_setopt ($ch, CURLOPT_SSL_VERIFYHOST, 0);    //   Host SSL 
        curl_setopt($ch, CURLOPT_ENCODING, "");
        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/27.0.1453.93 Safari/537.36');
        curl_setopt($ch, CURLOPT_TIMEOUT, 120);
        curl_setopt($ch, CURLOPT_POST, 1);
        //curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $strPost);
        curl_setopt($ch, CURLOPT_COOKIEJAR, $coo);
        curl_setopt($ch, CURLOPT_COOKIEFILE, $coo);
        if($proxy) curl_setopt($ch, CURLOPT_PROXY, "$proxy");
        $this->headerUrl  = curl_getinfo( $ch, CURLINFO_EFFECTIVE_URL);
        $this->httpCode = curl_getinfo( $ch, CURLINFO_HTTP_CODE );
        $data = curl_exec($ch);
        curl_close($ch);
        return $data;
    }
}
?>62   133962|/shs.parser/classes/general/main_classes00.php|f3d67486<?
class SotbitContentParser{
    
    protected $id = false;
    protected $rss;
    protected $type;
    protected $active;
    protected $iblock_id;
    protected $section_id;
    protected $detail_dom;
    protected $encoding;
    protected $preview_delete_tag="";
    protected $bool_preview_delete_tag="";
    protected $detail_delete_tag="";
    protected $bool_detail_delete_tag="";
    protected $preview_first_img="";
    protected $detail_first_img="";
    protected $preview_save_img="";
    protected $detail_save_img="";
    protected $text = "";
    protected $site = "";
    protected $link = "";
    protected $preview_delete_element="";
    protected $detail_delete_element="";
    protected $preview_delete_attribute="";
    protected $detail_delete_attribute="";
    protected $index_element="";
    protected $resize_image="";
    protected $meta_description="";
    protected $meta_keywords="";
    protected $meta_description_text="";
    protected $meta_keywords_text="";
    protected $agent = false;
    protected $active_element = "Y";
    protected $header_url;
    protected $settings;
    protected $countPage = 0;
    protected $countItem = 0;
    protected $stepStart = false;

    protected $page;
    const TEST = 0;
    const DEFAULT_DEBUG_LIST = 3;
    const DEFAULT_DEBUG_ITEM = 3;
    public function __construct()
    {
        global $zis, $shs_ID, $shs_TYPE, $shs_ACTIVE, $shs_IBLOCK_ID, $shs_RSS, $shs_SECTION_ID, $shs_SELECTOR, $shs_ENCODING, $shs_PREVIEW_DELETE_TAG, $shs_PREVIEW_TEXT_TYPE, $shs_DETAIL_TEXT_TYPE, $shs_BOOL_PREVIEW_DELETE_TAG,$shs_PREVIEW_FIRST_IMG, $shs_PREVIEW_SAVE_IMG, $shs_DETAIL_DELETE_TAG, $shs_BOOL_DETAIL_DELETE_TAG,$shs_DETAIL_FIRST_IMG, $shs_DETAIL_SAVE_IMG, $shs_PREVIEW_DELETE_ELEMENT, $shs_DETAIL_DELETE_ELEMENT, $shs_PREVIEW_DELETE_ATTRIBUTE, $shs_DETAIL_DELETE_ATTRIBUTE, $shs_INDEX_ELEMENT, $shs_CODE_ELEMENT, $shs_RESIZE_IMAGE, $shs_META_DESCRIPTION, $shs_META_KEYWORDS, $shs_ACTIVE_ELEMENT, $shs_FIRST_TITLE, $shs_DATE_PUBLIC, $shs_FIRST_URL, $shs_DATE_ACTIVE, $shs_META_TITLE, $shs_SETTINGS;
        $this->id = $shs_ID;
        $this->type = $shs_TYPE;
        $this->rss = $shs_RSS;
        $this->active = $shs_ACTIVE;
        $this->iblock_id = $shs_IBLOCK_ID;
        $this->section_id = $shs_SECTION_ID;
        $this->detail_dom = $shs_SELECTOR;
        $this->first_url = trim($shs_FIRST_URL);
        $this->encoding = $shs_ENCODING;
        $this->preview_text_type = $shs_PREVIEW_TEXT_TYPE;
        $this->detail_text_type = $shs_DETAIL_TEXT_TYPE;
        $this->preview_delete_tag = $shs_PREVIEW_DELETE_TAG;
        $this->detail_delete_tag = $shs_DETAIL_DELETE_TAG;
        $this->bool_preview_delete_tag = $shs_BOOL_PREVIEW_DELETE_TAG;
        $this->bool_detail_delete_tag = $shs_BOOL_DETAIL_DELETE_TAG;
        $this->preview_first_img = $shs_PREVIEW_FIRST_IMG;
        $this->detail_first_img = $shs_DETAIL_FIRST_IMG;
        $this->preview_save_img = $shs_PREVIEW_SAVE_IMG;
        $this->detail_save_img = $shs_DETAIL_SAVE_IMG;
        $this->preview_delete_element = $shs_PREVIEW_DELETE_ELEMENT;
        $this->detail_delete_element = $shs_DETAIL_DELETE_ELEMENT;
        $this->preview_delete_attribute = $shs_PREVIEW_DELETE_ATTRIBUTE;
        $this->detail_delete_attribute = $shs_DETAIL_DELETE_ATTRIBUTE;
        $this->index_element = $shs_INDEX_ELEMENT;
        $this->code_element = $shs_CODE_ELEMENT;
        $this->resize_image = $shs_RESIZE_IMAGE;
        $this->meta_title = $shs_META_TITLE;
        $this->meta_description = $shs_META_DESCRIPTION;
        $this->meta_keywords = $shs_META_KEYWORDS;
        $this->active_element = $shs_ACTIVE_ELEMENT;
        $this->first_title = $shs_FIRST_TITLE;
        $this->date_public = $shs_DATE_PUBLIC;
        $this->date_active = $shs_DATE_ACTIVE;
        $this->settings = unserialize(base64_decode($shs_SETTINGS));
        $this->header_url = "";
        $this->sleep = (int)$this->settings[$this->type]["sleep"];
        $this->proxy = (int)$this->settings[$this->type]["proxy"];
        $this->errors = array();
        $this->auth = $this->settings[$this->type]["auth"]["active"]?true:false;
        $this->currentPage = 0;
        $this->activeCurrentPage = 0;
        $this->debugErrors = array();
        $this->stepStart = false;
        $this->pagePrevElement = array();
        $this->pagenavigationPrev = array();
        $this->pagenavigation = array();    
    }
    
    public function startParser($agent=false){
        global $DB, $shs_DEMO; //$agent = true;
        if($shs_DEMO==3) return;
        $this->createFolder();
        if($this->active!="Y"){
          $result["ERROR"][] = GetMessage("parser_active_no");
          $this->errors[] = GetMessage("parser_active_no");
          if(!$agent)CAdminMessage::ShowMessage(GetMessage("parser_active_no"));
          return $result;
        }
        $parser = new ShsParserContent();
        $now = time()+CTimeZone::GetOffset();
        $arFieldsTime['START_LAST_TIME_X'] = date($DB->DateFormatToPHP(FORMAT_DATETIME), $now);
        $parser->Update($this->id, $arFieldsTime);


        if($this->meta_description!="N"){
            $propDescr = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->meta_description))->Fetch();
            if(!$propDescr){
                $result["ERROR"][] = GetMessage("parser_error_description");
                $this->errors[] = GetMessage("parser_error_description");
            }
        }
        if($this->meta_keywords!="N"){
            $propKey = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->meta_keywords))->Fetch();
            if(!$propKey){
                $result["ERROR"][] = GetMessage("parser_error_keywords");
                $this->errors[] = GetMessage("parser_error_keywords");
                //return $result;
            }
        }
        if($this->meta_title!="N"){
            $propKey = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->meta_title))->Fetch();
            if(!$propKey){
                $result["ERROR"][] = GetMessage("parser_error_title");
                $this->errors[] = GetMessage("parser_error_title");
                //return $result;
            }
        }
        if($this->first_title!="N"){
            $propFirst= CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->first_title))->Fetch();
            if(!$propFirst){
                $result["ERROR"][] = GetMessage("parser_error_first");
                $this->errors[] = GetMessage("parser_error_first");
                //return $result;
            }
        }
        if($this->date_public!="N"){
            $propDate= CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->date_public))->Fetch();
            if(!$propDate){
                $result["ERROR"][] = GetMessage("parser_error_date");
                $this->errors[] = GetMessage("parser_error_date");
                //return $result;
            }
        }


        if(isset($result['ERROR']))
        {
            if(!$agent)foreach($result['ERROR'] as $error) CAdminMessage::ShowMessage($error);
            return false;
        }
        $this->agent = $agent;
        if($shs_DEMO==2) $this->settings["catalog"]["mode"] = "debug";
        if($_GET["begin"])$this->auth(true);
        elseif($this->agent || $this->settings["catalog"]["mode"]=="debug") $this->auth(true);
        
        
        if($this->type=="catalog")
        {
            $this->isCatalog();
            $this->getUniqElement();
            $this->isUpdateElement();
            $this->GetSortFields();
            $this->getArrayIblock();
            $this->DoPageNavigation();
            $this->CheckFields($this->settings["catalog"]);
            
            if(!$this->errors)$this->parseCatalog();
            else{    
                if(!$agent)foreach($this->errors as $error) CAdminMessage::ShowMessage($error);
                $this->SaveLog();
                return false;
            } 
            if($this->debugErrors && $this->settings["catalog"]["mode"]=="debug")
            {
                if(!$agent)foreach($this->debugErrors as $error) CAdminMessage::ShowMessage($error);
                $this->SaveLog();
                return false;
            }
            return true;
        }

        $this->rss = str_replace(array('http://', 'www.'), '', $this->rss);
        $arSite = explode('/', $this->rss);
        $level = explode('.', $arSite[0]);
        if(count($level)>=3) $this->rss = $this->rss;
        else $this->rss = 'www.'.$this->rss;
        $arSite = explode('/', $this->rss);
        $this->site = $arSite[0];
        $uri = preg_replace('/^(www\.){0,1}([a-zA-Z0-9-\.])+\//', '', $this->rss);
        $arPath = explode('?', $uri);
        $path = '/'.$arPath[0];
        $query = $arPath[1]; 
        $arContent = $this->getContentsArray($this->site, 80, $path, $query);
        if(empty($arContent['title']) && empty($arContent['link'])){
            $arContent = $this->getContentsArray(str_replace("www.", "", $this->site), 80, $path, $query);
            if(empty($arContent['title']) && empty($arContent['link'])){
                $arContent = $this->getContentsArray("www.".$this->site, 80, $path, $query);
                if(empty($arContent['title']) && empty($arContent['link'])){
                    if(!$agent){
                        $result["ERROR"][] = GetMessage("parser_error");
                        $this->errors[] = GetMessage("parser_error");
                        //CAdminMessage::ShowMessage(GetMessage("parser_error"));
                        //return $result;
                    }
                    //return false;
                }
            }
        }
        if($this->errors)
        {
            if(!$agent)foreach($this->errors as $error) CAdminMessage::ShowMessage($error);
            if($this->type!="page")return false;
        }
        if(isset($result['ERROR']))
        {
            //if(!$agent)foreach($result['ERROR'] as $error) CAdminMessage::ShowMessage($error);
            if($this->type!="page")return false;
        }


        return $this->setContentIblock($arContent, $this->iblock_id, $this->section_id, $this->detail_dom, $this->encoding);
    }
    
    private function setContentIblock($arContent=array(), $iblock_id=false, $section_id=false, $detail_dom="", $encoding="utf-8"){
        $first = false;
        global $shs_preview, $shs_first, $DB, $shs_DEMO;
        set_time_limit(0);
        $this->setDemo();
        /*if($this->first_url)
        {
            if($this->first_url && strpos($this->header_url, $this->first_url)===false && strpos($item['link'], $this->first_url)==false) continue;
        }
        else */
        $count = count($arContent['item']);
        $ci = 0;
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $count."|".$ci);
        foreach($arContent['item'] as $i=>$item){

            //if($this->sleep && $this->sleep>0)sleep($this->sleep);
            $item['title'] = trim($item['title']);
            $isElement = CIBlockElement::GetList(Array(), array("NAME"=>$item['title'], "SECTION_ID"=>$section_id, "IBLOCK_ID"=>$iblock_id), false, Array("nTopCount"=>1), array("ID"))->Fetch();
            $ci++;
            if($isElement && !self::TEST && $shs_DEMO==1) continue;
            $first = true;
            $item['description'] = trim($item['description']);
            $this->link = $item['link'];
            $item['link'] = str_replace('http://', '', $item['link']);
            $fileHtml = new FileGetHtml();
            $this->date_public_text = $item["pubDate"];
            $proxy = $this->proxy;
            $data = $fileHtml->file_get_html($item['link'], $proxy, $this->auth);
            $this->header_url = $fileHtml->headerUrl;
            if($this->first_url && strpos($this->header_url, $this->first_url)===false && strpos($item['link'], $this->first_url)==false) continue;
            $shs_first = true;
            //preg_replace("/\<meta\s+charser=[\"|']{0,1}.+[\"|']{0,1}\s*\/{0,1}\>/ig")
            //print $data;
            $this->DeleteCharsetHtml5($data);
            $html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET);
            $shs_first = false;
            $this->first_title_text = $this->header_url;

            $this->getUrlSite();
            $DETAIL_TEXT = "";
            $this->text = "";

            $DETAIL_TEXT = $this->parserSelector($html, htmlspecialchars_decode(trim($detail_dom)));

            $el = new CIBlockElement;
            $shs_preview = true;
            if($this->preview_first_img=="Y") $PREVIEW_IMG = $this->parserFirstImg(phpQuery::newDocument($item['description']), "text/html;charset=".LANG_CHARSET);
            $shs_preview = false;
            if($this->detail_first_img=="Y") $DETAIL_IMG = $this->parserFirstImg(phpQuery::newDocument($DETAIL_TEXT), "text/html;charset=".LANG_CHARSET);
            
            $this->preview_delete_element = trim($this->preview_delete_element);
            $this->detail_delete_element = trim($this->detail_delete_element);
            $shs_preview = true;
            $preview_html = phpQuery::newDocument($item['description'], "text/html;charset=".LANG_CHARSET);
            $shs_preview = false;
            $detail_html = phpQuery::newDocument($DETAIL_TEXT, "text/html;charset=".LANG_CHARSET);
            if(!empty($this->preview_delete_element)){
                $preview_html = $this->deleteElementStart($preview_html, htmlspecialchars_decode($this->preview_delete_element));
            }
            if(!empty($this->detail_delete_element)){
                $detail_html = $this->deleteElementStart($detail_html, htmlspecialchars_decode($this->detail_delete_element));
            }
            if(!empty($this->preview_delete_attribute)){
                $preview_html = $this->deleteAttributeStart($preview_html, htmlspecialchars_decode($this->preview_delete_attribute));
            }
            if(!empty($this->detail_delete_attribute)){
                $detail_html = $this->deleteAttributeStart($detail_html, htmlspecialchars_decode($this->detail_delete_attribute));
            }
            
            
            
            
            $detail_html = $this->changeImgSrc($detail_html);
            $preview_html = $this->changeImgSrc($preview_html);

            if($this->preview_save_img=="Y") $item['description'] = $this->saveImgServer($preview_html);
            else $item['description'] = $preview_html->htmlOuter();
            if($this->detail_save_img=="Y") $DETAIL_TEXT = $this->saveImgServer($detail_html);
            else $DETAIL_TEXT = $detail_html->htmlOuter();
            $item['description'] = preg_replace("/\<meta(.)+\>{1}/", "", $item['description']);
            $DETAIL_TEXT = preg_replace("/\<meta(.)+\>{1}/", "", $DETAIL_TEXT);

            if($this->code_element=="Y")$code = $arProperty["CODE"] = CUtil::translit($item['title'], LANGUAGE_ID, array(
                        "max_len" => 100,
                        "change_case" => 'L', // 'L' - toLower, 'U' - toUpper, false - do not change
                        "replace_space" => '_',
                        "replace_other" => '_',
                        "delete_repeat_replace" => true,
            ));
            if($this->date_public_text)$unix = strtotime($this->date_public_text);
            if($this->date_active=="NOW") $date_from = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "SHORT");
            elseif($this->date_active=="NOW_TIME") $date_from = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "FULL");
            elseif($this->date_active=="PUBLIC" && $unix) $date_from = ConvertTimeStamp($unix, "FULL");
            
            
            if(!empty($this->preview_delete_tag) && $this->bool_preview_delete_tag=="Y"){
                $item['description'] = strip_tags($item['description'], htmlspecialchars_decode($this->preview_delete_tag));
            }elseif($this->bool_preview_delete_tag=="Y") $item['description'] = strip_tags($item['description']);
            if(!empty($this->detail_delete_tag) && $this->bool_detail_delete_tag=="Y"){
                $DETAIL_TEXT = strip_tags($DETAIL_TEXT, htmlspecialchars_decode($this->detail_delete_tag));
            }elseif($this->bool_detail_delete_tag=="Y")
            {
                $DETAIL_TEXT = strip_tags($DETAIL_TEXT);    
            }

            $arLoadProductArray = Array(
                "MODIFIED_BY"    => 1, //    
                "IBLOCK_SECTION_ID" => $this->section_id,          //     
                "DATE_ACTIVE_FROM" => $date_from,
                "IBLOCK_ID"      => $this->iblock_id,
                "NAME"           => trim($item['title']),
                "ACTIVE"         => $this->active_element=="Y"?"Y":"N",            // 
                "PREVIEW_TEXT"   => trim($item['description']),
                "PREVIEW_TEXT_TYPE"  => $this->preview_text_type,
                "DETAIL_TEXT"    => trim($DETAIL_TEXT),
                "DETAIL_TEXT_TYPE"    => $this->detail_text_type,
                "CODE" => $code?$code:""
            );


            if(empty($PREVIEW_IMG) && $this->preview_first_img=="Y") $PREVIEW_IMG = $this->filterSrc($this->parseImgFromRss($item));
            if($this->preview_first_img=="Y") $arLoadProductArray['PREVIEW_PICTURE'] = CFile::MakeFileArray($PREVIEW_IMG);
            if($this->detail_first_img=="Y") $arLoadProductArray['DETAIL_PICTURE'] = CFile::MakeFileArray($DETAIL_IMG);
            if($this->date_public!="N" && $this->date_public_text)
            {
                $new_date = date($DB->DateFormatToPHP(FORMAT_DATETIME), $unix);
                $arLoadProductArray['PROPERTY_VALUES'][$this->date_public] = $new_date;
            }
            if($this->first_title!="N")$arLoadProductArray['PROPERTY_VALUES'][$this->first_title] = $this->first_title_text;
            if($this->meta_title!="N")$arLoadProductArray['PROPERTY_VALUES'][$this->meta_title] = $this->meta_title_text;
            if($this->meta_description!="N")$arLoadProductArray['PROPERTY_VALUES'][$this->meta_description] = $this->meta_description_text;
            if($this->meta_keywords!="N")$arLoadProductArray['PROPERTY_VALUES'][$this->meta_keywords] = $this->meta_keywords_text;
            if($PRODUCT_ID = $el->Add($arLoadProductArray, false, $this->index_element=="Y"?true:false, $this->resize_image=="Y"?true:false)){
                $elem[]= ' '.$PRODUCT_ID;
            }
            elseif(!$this->agent){
                $result[ERROR][] = $el->LAST_ERROR;
            }

            $el = null;
            $isElement = null;
            if(isset($preview_html)){
                unset($preview_html);
            }
            if(isset($detail_html)){
                unset($detail_html);
            }
            unset($html);
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $count."|".$ci);
            unset($fileHtml);
            if(self::TEST || $shs_DEMO==2)break;
            if($this->sleep && $this->sleep>0)sleep($this->sleep);

        }
        unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt");
        if($elem){
            $message = implode(',', $elem);
            $message = GetMessage("parser_pars_el_ok").' '.$message.' '.GetMessage("parser_pars_create_ok");
        }
        if($first && !$this->agent){
            $result[SUCCESS][] = $message;
        }
        elseif(!$this->agent){
            $result[ERROR][] = GetMessage("parser_no");
        }
        if(!$this->agent)
        {
            if(isset($result[SUCCESS]) && count($result[SUCCESS])>0)
            {
                foreach($result['SUCCESS'] as $success) CAdminMessage::ShowMessage(array("MESSAGE"=>$success, "TYPE"=>"OK"));
            }
            if(isset($result[ERROR]) && count($result[ERROR])>0)
            {
                foreach($result['ERROR'] as $error) CAdminMessage::ShowMessage($error);
            }
        }
        return $result;
    }
    
    public function GetAuthForm($check=false)
    {   
        if(isset($this->settings[$this->type]["auth"]["active"]) && $this->settings[$this->type]["auth"]["active"]!="Y") return false;
        elseif(!isset($this->settings[$this->type]["auth"]["active"])) return false;
        elseif(isset($this->settings[$this->type]["auth"]["selector"]) && !$this->settings[$this->type]["auth"]["selector"])
        {
            $this->errors[] = GetMessage("parser_auth_error_selector");
            return false;    
        }
         
        
        $url = $this->settings[$this->type]["auth"]["url"]?$this->settings["catalog"]["auth"]["url"]:$this->rss;
        $form = $this->settings[$this->type]["auth"]["selector"];
        $proxy = $this->settings[$this->type]["proxy"];
        
        $auth = new FileGetHtml();
        $data = $auth->file_get_html($url, $proxy);
        $this->urlCatalog = $auth->headerUrl;
        $this->urlSite = $this->getCatalogUrlSite();
        
        $this->CheckAuthForm($data, $form, $proxy);
        
        if($check)if(isset($this->errors) && count(isset($this->errors))>0)
        {
            foreach($this->errors as $error)
            {
                if(isset($_POST["auth"]))CAdminMessage::ShowMessage($error);
            }
        }
        if($check)if(isset($this->success) && count(isset($this->success))>0)
        {
            foreach($this->success as $success)
            {
                if(isset($_POST["auth"]))CAdminMessage::ShowMessage(array("MESSAGE"=>$success, "TYPE"=>"OK"));    
            }
        }
            
    }
    
    public function CheckAuthform($data, $form, $proxy)
    {   
        $this->html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET); 
        //print pq($this->html)->html();
        $objForm = pq($this->html)->find($form);
        $url = $objForm->attr("action");
        $url = empty($url)?$this->urlCatalog:$this->getCatalogLink($url);
        
        $login = trim($this->settings[$this->type]["auth"]["login"]);
        $password = trim($this->settings[$this->type]["auth"]["password"]);
        foreach($this->html[$form." input"] as $input)
        {
            $name = trim(pq($input)->attr("name")); 
            $value = trim(pq($input)->attr("value"));
            $type = trim(pq($input)->attr("type"));
            if(isset($this->settings[$this->type]["auth"]["password_name"]) && !empty($this->settings[$this->type]["auth"]["password_name"]) && $name==$this->settings[$this->type]["auth"]["password_name"])
            {
                //if($name==$this->settings[$this->type]["auth"]["password_name"])
                {
                    $arInput[$name] = $password;
                    continue;    
                }    
            }
            elseif(isset($this->settings[$this->type]["auth"]["login_name"]) && !empty($this->settings[$this->type]["auth"]["login_name"]) && $name==$this->settings[$this->type]["auth"]["login_name"])
            {
                //if($name==$this->settings[$this->type]["auth"]["login_name"])
                {
                    $arInput[$name] = $login;
                    continue;    
                }    
            }
            elseif($type=="password")
            {
                $arInput[$name] = $password;
                continue;        
            }
            elseif($type=="text" || $type=="email"){
                $arInput[$name] = $login;
                continue;    
            } 
            $arInput[$name] = $value;
        }
        if(isset($arInput))$this->doAuth($url, $arInput, $proxy);
        else{
            $this->errors[] = GetMessage("parser_auth_error_selector");    
        }
    }
    
    protected function doAuth($url, $arInput, $proxy)
    {
        $auth = new FileGetHtml();
        $data = $auth->auth($url, $proxy, $arInput, true);
        //if(isset($_POST["auth"]))
        $this->AdminAuth($data);
    }
    
    protected function AdminAuth($data)
    {
        $form = $this->settings[$this->type]["auth"]["selector"];
        $this->html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET);
        $passw = false;
        foreach($this->html[$form." input"] as $input)
        {
            $type = pq($input)->attr("type");
            if($type=="password")
            {
                $passw = true;    
            }
        } 
        
        if($passw)
            $this->errors[] = GetMessage("parser_auth_no");
        else
            $this->success[] = GetMessage("parser_auth_ok");
    }
    
    protected function DoPageNavigation()
    {
        $begin = $this->settings["catalog"]["pagenavigation_begin"];
        $end = $this->settings["catalog"]["pagenavigation_end"];
        $this->arPageNavigationDelta[0] = $begin;
        $this->arPageNavigationDelta[1] = $end;
    }

    protected function ValidatePageNavigation($n)
    {
        $n = strip_tags($n);
        $n = preg_replace("/\D/", "", $n);
        return $n;
    }
    //    
    protected function CheckPageNavigation($n)
    {
        if(!preg_match("/\d/", $n) || empty($n)) return false;
        if($this->currentPage>$n) return false;
        if($this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n>=$this->arPageNavigationDelta[0] && $n<=$this->arPageNavigationDelta[1]) return $n;
        }elseif($this->arPageNavigationDelta[0] && !$this->arPageNavigationDelta[1])
        {
            if($n>=$this->arPageNavigationDelta[0]) return $n;
        }elseif(!$this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[1]) return $n;
        }
        return false;
    }
    
    protected function CheckPageNavigationLess($n)
    {
        if(!preg_match("/\d/", $n) || empty($n)) return false;
        
        if($this->currentPage>$n) return false;

        if($this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[1]) return $n;
        }elseif(!$this->arPageNavigationDelta[1]) return true;
        return false;
    }

    protected function CheckValidatePageNavigation($n)
    {
        if($this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[0] && $n<=$this->arPageNavigationDelta[1]) return true;
        }elseif($this->arPageNavigationDelta[0] && !$this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[0] && $n<=100000) return true;
        }elseif(!$this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[1]) return true;
        }
    }

    protected function CheckOnePageNavigation()
    {
        if($this->settings["catalog"]["pagenavigation_begin"]==1 && $this->settings["catalog"]["pagenavigation_end"]==1)
        {
            return true;
        }elseif(!$this->settings["catalog"]["pagenavigation_selector"]) return true;
        
        return false;
    }
    
    protected function CheckAlonePageNavigation($n)
    {   
        if(!empty($this->settings["catalog"]["pagenavigation_begin"]) && !empty($this->settings["catalog"]["pagenavigation_end"]) && $this->settings["catalog"]["pagenavigation_end"]==$this->settings["catalog"]["pagenavigation_begin"] && $n==$this->settings["catalog"]["pagenavigation_begin"])
        {
            return true;
        }
        
        return false;
    }

    protected function IsNumberPageNavigation()
    {
        if(!$this->settings["catalog"]["pagenavigation_begin"] && !$this->settings["catalog"]["pagenavigation_end"]) return false;
        else return true;
    }
    
    protected function DeleteLog()
    {
        if($this->agent)unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog".$this->id.".txt");    
    }
    
    protected function SaveLog()
    {
        if($this->settings["catalog"]["log"]=="Y" && isset($this->errors) && count($this->errors)>0)
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$this->id.".txt", print_r($this->errors, true), FILE_APPEND);
            
        if(!isset($this->errors)) $this->errors = array();
        $this->debugErrors = array_merge($this->debugErrors, $this->errors);
    }

    protected function isUpdateElement()
    {
        if($this->settings["catalog"]["update"]["active"])
        {
            unset($this->settings["catalog"]["update"]["active"]);
            foreach($this->settings["catalog"]["update"] as $id=>$val)
            {
                if($val=="Y" || $val=="empty") $this->isUpdate[$id] = $val;
            }
            if(!isset($this->isUpdate) || !$this->isUpdate) $this->isUpdate = false;
        }else  $this->isUpdate = false;
    }

    protected function getUniqElement()
    {
        //if($this->settings["catalog"]["update"]["active"]=="Y")
        {
            $this->uniqFields["NAME"] = "NAME";
            $this->uniqFields["LINK"] = "LINK";

            if($this->settings["catalog"]["uniq"]["prop"])
            {
                unset($this->uniqFields["LINK"]);
                unset($this->uniqFields["NAME"]);
                $prop = $this->settings["catalog"]["uniq"]["prop"];
                $this->uniqFields[$prop] = $prop;
            }
            if($this->settings["catalog"]["uniq"]["name"])
            {
                unset($this->uniqFields["LINK"]);
                unset($this->uniqFields["NAME"]);
                $this->uniqFields["NAME"] = "NAME";
            }
        }
    }
    
    protected function GetSortFields()
    {
        $this->arSortUpdate = array();
        $this->arEmptyUpdate = array();
        if($this->isUpdate)
        {
            foreach($this->isUpdate as $id=>$val)
            {
                if($val!="empty") continue;
                if($id=="preview_img") $this->arSortUpdate[] = "PREVIEW_PICTURE";
                elseif($id=="detail_img") $this->arSortUpdate[] = "DETAIL_PICTURE";
                elseif($id=="preview_descr") $this->arSortUpdate[] = "PREVIEW_TEXT";
                elseif($id=="detail_descr") $this->arSortUpdate[] = "DETAIL_TEXT";
            }
        }    
    }

    protected function checkUniq()
    {   
        if($this->elementUpdate) return $this->elementUpdate;
        if(!isset($this->arSortUpdate)) $this->arSortUpdate = array();
        if($this->uniqFields["LINK"])
        {
            $uniq = md5($this->arFields["NAME"].$this->arFields["LINK"]);
            $isElement = CIBlockElement::GetList(Array(), array("XML_ID"=>$uniq, "IBLOCK_ID"=>$this->iblock_id), false, Array("nTopCount"=>1), array_merge(array("ID"), $this->arSortUpdate))->Fetch();
            $this->elementUpdate = $isElement["ID"];
            if($isElement)
            {
                $this->arEmptyUpdate = $isElement;
                return $isElement["ID"];
            }
            
            else return false;
        }else{
            if($this->settings["catalog"]["uniq"]["prop"])
            {
                $prop = $this->settings["catalog"]["uniq"]["prop"];
                if($this->arFields["PROPERTY_VALUES"][$prop])$arFields["PROPERTY_".$prop] = $this->arFields["PROPERTY_VALUES"][$prop];
            }
            if($this->settings["catalog"]["uniq"]["name"])
            {
                $prop = $this->settings["catalog"]["uniq"]["prop"];
                if($this->arFields["NAME"])$arFields["NAME"] = $this->arFields["NAME"];
            }
            if(count($arFields)==count($this->uniqFields))$isElement = CIBlockElement::GetList(Array(), array_merge(array("IBLOCK_ID"=>$this->iblock_id), $arFields), false, Array("nTopCount"=>1), array_merge(array("ID"), $this->arSortUpdate))->Fetch();
            $this->elementUpdate = $isElement["ID"];
            if($isElement)
            {
                $this->arEmptyUpdate = $isElement;
                return $isElement["ID"];
            }
            else return false;
        }

        return false;
    }
    
    protected function checkOfferUniqSpecial($size)
    {
        if($this->elementOfferUpdate) return $this->elementOfferUpdate;
        
        $uniq = "offer#".md5($this->arFields["NAME"].$this->arFields["LINK"].$size);
        $isElement = CIBlockElement::GetList(Array(), array("XML_ID"=>$uniq, "IBLOCK_ID"=>$this->offerArray["IBLOCK_ID"]), false, Array("nTopCount"=>1), array("ID"))->Fetch();
        $this->elementOfferUpdate = $isElement["ID"];
        if($isElement) return $isElement["ID"];
        else return false;
    }

    protected function isCatalog()
    {
        if(CModule::IncludeModule('catalog') && ($this->iblock_id && CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y", "ID"=>$this->iblock_id))->Fetch()))
        {
            if($this->settings["catalog"]["preview_price"] || $this->settings["catalog"]["detail_price"])
            {
                $this->isCatalog = true;
            }else $this->isCatalog = false;
        }else $this->isCatalog = false;
        if(isset($this->settings["catalog"]["cat_vat_price_offer"]) && $this->settings["catalog"]["cat_vat_price_offer"]=="Y")
        {
            $arIblock = CCatalogSKU::GetInfoByIBlock($this->iblock_id);
            if(is_array($arIblock) && !empty($arIblock) && $arIblock["PRODUCT_IBLOCK_ID"]!=0 && $arIblock["SKU_PROPERTY_ID"]!=0)
            {
                $this->isOfferCatalog = true;
                $this->offerArray = $arIblock;
                $this->isCatalog = true;            
            }else $this->isOfferCatalog = false;    
        }
        
        
    }

    protected function CheckFields($settings)
    {   
        if(preg_match("/\D/", $settings["pagenavigation_begin"]) && $settings["pagenavigation_begin"]!="")
        {
            $this->errors[] = GetMessage("parser_error_pagenavigation_begin");
        }
        if(preg_match("/\D/", $settings["pagenavigation_end"]) && $settings["pagenavigation_end"]!="")
        {
            $this->errors[] = GetMessage("parser_error_pagenavigation_end");
        }
        if(preg_match("/\D/", $settings["step"]))
        {
            $this->errors[] = GetMessage("parser_error_step");
        }
        
        if(is_array($settings["price_updown"]))
        {
            foreach($settings["price_updown"] as $i=>$val)
            {
                if($settings["price_updown"][$i])
                {
                    if($settings["price_terms"][$i] && !self::isFloat($settings["price_terms_value"][$i]))
                    {       
                        $this->errors[] = GetMessage("parser_error_price_terms_value");    
                    }
                    if($settings["price_terms"][$i] && !self::isFloat($settings["price_terms_value_to"][$i]))
                    {       
                        $this->errors[] = GetMessage("parser_error_price_terms_value");    
                    } 
                    if($settings["price_updown"][$i] && !self::isFloat($settings["price_value"][$i]))
                    {
                        $this->errors[] = GetMessage("parser_error_price_value");    
                    }   
                }    
            }    
        }
        
        
        

        $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id));
        while ($prop_fields = $properties->GetNext())
        {
            $this->arProperties[$prop_fields["CODE"]] = $prop_fields;
        }

        $this->arSelectorProduct = $this->getSelectorProduct();
        $this->arFindProduct = $this->getFindProduct();
        $this->arSelectorProperties = $this->getSelectorProperties();
        $this->arFindProperties = $this->getFindProperties();
        $this->arDubleFindProperties = $this->getFindDubleProperties();
        //printr($this->ArDubleFindProperties);
    }
    
    protected function isFloat($n)
    {
        if(preg_match("/^(?:\+|\-)?(?:(?:\d+)|(?:\d+\.)|(?:\.\d+)|(?:\d+\.\d+)){1}(?:e(?:\+|\-)?\d+)?$/i", $n)) return true;
        else return false;
    }


    protected function parseCatalog()
    {   
        set_time_limit(0);
        $this->ClearAjaxFiles();
        $this->DeleteLog(); 
        $this->arUrl = array();
        if(isset($this->settings["catalog"]["url_dop"]) && !empty($this->settings["catalog"]["url_dop"]))$this->arUrl = explode("\r\n", $this->settings["catalog"]["url_dop"]);
        
        $this->arUrl = array_merge(array($this->rss), $this->arUrl);
        $this->arUrlSave = $this->arUrl;
        //print "TEST";
        //printr($this->arUrl);
        
        if(!$this->PageFromFile()) return false;
        $this->CalculateStep();
        if($this->settings["catalog"]["mode"]!="debug" && !$this->agent) $this->arUrlSave = array($this->rss);
        else $this->arUrlSave = $this->arUrl; 
        //if(!$this->connectCatalogPage($this->rss));
        //return;
        foreach($this->arUrlSave as $rss):
            $rss = trim($rss);
            if(empty($rss)) continue;
            $this->rss = $rss; 
            $this->connectCatalogPage($this->rss);
            if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && isset($this->errors) && count($this->errors)>0)
            {
                $this->SaveLog();
                unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt");
                return false;    
            }
        
            $this->parseCatalogNavigation($this->rss);
            $n = $this->currentPage;
            if(!$this->IsNumberPageNavigation())
            {   
                $this->parseCatalogProducts();
            }elseif($this->IsNumberPageNavigation() && $this->CheckPageNavigation($n))
            {   
                $this->parseCatalogProducts();
            }elseif($this->settings["catalog"]["mode"]!="debug" && !$this->agent)
            {
                $this->stepStart = true;
                $this->SavePrevPage($this->rss);    
            }
         
            $this->SaveCurrentPage($this->pagenavigation);
            if($this->stepStart)
            {
                if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
                    unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                $this->DeleteCopyPage();
            } 
            if((!$this->CheckOnePageNavigation() && $this->agent) || (!$this->CheckOnePageNavigation() && !$this->agent && $this->settings["catalog"]["mode"]=="debug"))$this->parseCatalogPages();
            if($this->CheckOnePageNavigation() && $this->stepStart)
            {
                if($this->IsEndSectionUrl())$this->ClearBufferStop();
                else $this->ClearBufferStep();
                return false;    
            }
        endforeach;
    }
    
    protected function PageFromFile()
    {
        if($this->settings["catalog"]["mode"]=="debug" || $this->agent || $_GET["begin"]) return true;
        $prevPage = $prevElement = $currentPage = 0;
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt"))
            $prevPage = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt");
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt"))
            $prevElement = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt");
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt"))
            $currentPage = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt");
        
        if($prevPage)
        {
            $arPrevPage = explode("|", $prevPage);
            $arPrevElement = explode("|", $prevElement);
            $arCurrentPage = explode("|", $currentPage);    
        }else{
            $arPrevPage = array();
            $arCurrentPage = array();
        }
        
        if(isset($arPrevElement) && is_array($arPrevElement))foreach($arPrevElement as $i=>$p)
        {
            $p = trim($p);
            if(empty($p)) continue;
            $this->pagePrevElement[$p] = $p;
        }
        
        if(!$_GET["begin"] && !$prevPage) return true;
        
        if(isset($arPrevPage) && is_array($arPrevPage))foreach($arPrevPage as $i=>$p)
        {
            $p = trim($p);
            if(empty($p)) continue;
            $this->pagenavigationPrev[$p] = $p;
        }
        
        
        if(isset($arCurrentPage) && is_array($arCurrentPage))foreach($arCurrentPage as $p)
        {
            $p = trim($p);
            if(empty($p)) continue;
            $this->pagenavigation[$p] = $p;    
        }
        
        if(isset($this->pagenavigationPrev) && is_array($this->pagenavigationPrev))foreach($this->pagenavigationPrev as $i=>$v)
        {
            foreach($this->pagenavigation as $i1=>$v1)
            {
                if($v1==$v) unset($this->pagenavigation[$i1]);   
            }
        }
        
        if(isset($this->pagenavigation) && is_array($this->pagenavigation))foreach($this->pagenavigation as $p)
        {
            $isContinue = true;
            $this->rss = $p;
            break;
        }
        if(!$isContinue && !empty($this->pagenavigationPrev) && $this->IsEndSectionUrl())
        {
                 
            //if($this->IsEndSectionUrl())
            $this->ClearBufferStop();
            //else $this->ClearBufferStep();
            return false;
        }elseif(!$isContinue && !empty($this->pagenavigationPrev) && !$this->IsEndSectionUrl())
        {
            $isContinue = true;
            $this->rss = $this->GetUrlRss();        
        }
         
        $this->currentPage = count($this->pagenavigationPrev);
        if($this->IsNumberPageNavigation() && $this->CheckPageNavigation($this->currentPage))
        {
            
            $this->activeCurrentPage = $this->currentPage-$this->arPageNavigationDelta[0]+1;
        }elseif(!$this->IsNumberPageNavigation()) $this->activeCurrentPage = $this->currentPage;
        return true;
    }
    
    protected function IsEndSectionUrl()
    {
        if(!isset($this->settings["catalog"]["url_dop"]) || empty($this->settings["catalog"]["url_dop"]) || empty($this->arUrl)) return true;
        $count = 0;
        foreach($this->arUrl as $i=>$url)
        {
            if(isset($this->pagenavigationPrev[$url])) $count++;   
        }
        if($count==count($this->arUrl)) return true;
        else return false;
    }
    
    protected function GetUrlRss()
    {
        foreach($this->arUrl as $i=>$url)
        {
            if(isset($this->pagenavigationPrev[$url])) continue;
            return $url;
        }        
    }
    
    protected function ClearBufferStop()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            global $APPLICATION;
            //if(self::TEST==0)
            $APPLICATION->RestartBuffer();
            die("stop");    
        }
    }
    
    protected function ClearBufferStep()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            global $APPLICATION;
            if(self::TEST==0)$APPLICATION->RestartBuffer();
            die();    
        }
    }

    protected function parseCatalogProducts()
    {
        $count = 0;
        
        $this->activeCurrentPage++;
        $this->SetCatalogElementsResult($this->activeCurrentPage);
        
        $element = $this->settings["catalog"]["selector"];

        if($this->preview_delete_element)$this->deleteCatalogElement($this->preview_delete_element, $element, $this->html[$element]);
        if($this->preview_delete_attribute)$this->deleteCatalogAttribute($this->preview_delete_attribute, $element, $this->html[$element]);
        $i = 0;
        $ci = 0;
        
        foreach($this->html[$element] as $el)
        {
            $count++;    
        }
        
        if($this->settings["catalog"]["mode"]!="debug" && !$this->agent)
        {
            if($count>$this->settings["catalog"]["step"] && ($this->settings["catalog"]["mode"]!="debug" && !$this->agent))
                $countStep = $this->settings["catalog"]["step"];
            else{
                $this->stepStart = true;
                if($this->CheckOnePageNavigation() || $this->CheckAlonePageNavigation($this->currentPage)) $this->pagenavigation[$this->rss] = $this->rss;
                $this->SaveCurrentPage($this->pagenavigation);
                $this->SavePrevPage($this->sectionPage);
                $countStep = $count;
            }    
        }else{
            $countStep = $count;    
        }
            
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $countStep."|".$ci);    
        
        if($count==0)
        {
            $this->errors[] = GetMessage("parser_error_selector_notfound")."[".$element."]";
            $this->clearFields();
            //die();
        }
       
        foreach($this->html[$element] as $el)
        {
            $ci++;
            if($this->StepContinue($ci, $count)) continue;
            if($i==self::DEFAULT_DEBUG_ITEM && $this->settings["catalog"]["mode"]=="debug") break;
            $this->parseCatalogProductElement($el);
            
            $i++;
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $countStep."|".$i);
            $this->CalculateStep($count);
            
        }
        unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt");
    }

    protected function parseCatalogProductElement(&$el)
    {
        $this->countItem++;
        if(!$this->parserCatalogPreview($el))
        {
            //$this->SaveLog();
            $this->SaveCatalogError();
            $this->clearFields();
            return false;    
        }
         
        $this->parserCatalogDetail();
        $this->parseCatalogSection();
        $this->parseCatalogMeta();
        $this->parseCatalogFirstUrl();
        $this->parseCatalogDate();
        $this->parseCatalogAllFields();
        $this->AddElementCatalog();
        if($this->isCatalog && $this->elementID)
        {   
            /*if($this->isOfferCatalog)
            {                                   
                $this->AddElementOfferCatalog();
                $this->elementID = $this->elementOfferID;
                $this->elementUpdate = $this->elementOfferUpdate;
            }
            $this->AddProductCatalog();
            $this->AddMeasureCatalog();
            $this->AddPriceCatalog();*/
            
            if(isset($this->strArSize) && is_array($this->strArSize))
            {   $elID = $this->elementID;
                $elUpdateID = $this->elementUpdate;
                $arPrice = $this->arPrice;
                foreach($this->strArSize as $size)
                {
                    $size = trim($size);
                    if(!$size) continue;
                    $this->elementID = $elID;
                    $this->elementUpdate = $elUpdateID;
                    $this->arPrice = $arPrice;
                    $this->AddElementOfferCatalogSpecial($size);
                    $this->elementID = $this->elementOfferID;
                    $this->elementUpdate = $this->elementOfferUpdate;
                    
                    $this->AddProductCatalog();
                    $this->AddMeasureCatalog();
                    $this->AddPriceCatalog();
                    unset($this->elementUpdate);
                    unset($this->elementOfferUpdate);
                }
            }
            
            
            /**/
            //printr($this->arFields["PROPERTY_VALUES"]);
            /**/
            
            
        }/*else{
            $this->AddElementOfferCatalog();
            $this->AddProductCatalog();
            $this->AddMeasureCatalog();
            $this->AddPriceCatalog();    
        }*/

        $this->SetCatalogElementsResult();
        $this->clearFields();
        
    }
    
    protected function StepContinue($n, $count=0)
    {
        if($this->settings["catalog"]["mode"]=="debug" || $this->agent) return false;
        $step = (int)$this->settings["catalog"]["step"];
        if($step>$count && $count>0) return false;
        $file = 0;
        
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
        if($file)
        {
            $arFile = explode("|", $file);
            $countElement = (int)$arFile[0];
            $currentElement = (int)$arFile[1];    
        }else{
            return false;
        }

        if($currentElement>0 && $n<=$currentElement && $currentElement%$step==0) return true;
        else return false;    
    }
    
    protected function CalculateStep($count = 0)
    {           

        if($this->settings["catalog"]["mode"]=="debug" || $this->agent || $this->stepStart) return true;
        $step = $this->settings["catalog"]["step"];
        if($step>$count && $count>0)
        {
            $this->stepStart = true;
            return true;    
        }
        $file = 0;
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))  
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
        if($file)
        {
            $arFile = explode("|", $file);
            $countElement = (int)$arFile[0];
            $currentElement = (int)$arFile[1];    
        }else{
            $countElement = $count;
            $currentElement = 0;   
        }
        if($countElement-$currentElement<=$step && $countElement>0 && $count==0)
        {
            $this->stepStart = true;
        }
         
        if($count==0) return true;
        $currentElement++;
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt", $countElement."|".$currentElement);
        if($currentElement%$step==0 && !$this->stepStart)
        {
            $this->clearFields();
            $this->ClearBufferStep();
        }
        
            
    }
    
    protected function SetCatalogElementsResult($page=false)
    {
        $file = 0;
        if(file_exists(($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt")))
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt");
        
        if($file)
        {
            $arFile = explode("|", $file);
            
            $countPage = (int)$arFile[1];
            $ciElement = (int)$arFile[2];
            $errorElement = (int)$arFile[3];
            $allError = (int)$arFile[4];
        }
        else{
            $countPage = 0;
            $ciElement = 0;
            $errorElement = 0;
            $allError = 0; 
        }
        
        if($page)
        {
            $countPage = $page;    
        }elseif(isset($this->elementID)){
            $ciElement++;
            if(isset($this->errors) && count($this->errors))$errorElement++;
            $this->SavePrevPageDetail($this->arFields["LINK"]);    
        }
        if(isset($this->errors) && count($this->errors)>0)$allError = $allError+count($this->errors);
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt", "|".$countPage."|".$ciElement."|".$errorElement."|".$allError);
    }
    
    protected function SaveCatalogError()
    {
        $file = 0;
        if(file_exists(($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt")))
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt");
        
        if($file)
        {
            $arFile = explode("|", $file);
            
            $countPage = (int)$arFile[1];
            $ciElement = (int)$arFile[2];
            $errorElement = (int)$arFile[3];
            $allError = (int)$arFile[4];
        }
        else{
            $countPage = 0;
            $ciElement = 0;
            $errorElement = 0;
            $allError = 0; 
        }
        if(isset($this->elementID)){
            if(isset($this->errors) && count($this->errors))$errorElement++;
        }
        if(isset($this->errors) && count($this->errors)>0)$allError = $allError+count($this->errors);
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt", "|".$countPage."|".$ciElement."|".$errorElement."|".$allError);    
    }

    protected function parseCatalogAllFields()
    {
        if($this->checkUniq()) return false;
        $this->arFields["IBLOCK_ID"] = $this->iblock_id;
        $this->arFields["ACTIVE"] = $this->active_element;
        if($this->code_element=="Y")
        {
            $this->arFields["CODE"] = $this->getCodeElement($this->arFields["NAME"]);
        }

        if($this->uniqFields["LINK"])
        {
            $uniq = md5($this->arFields["NAME"].$this->arFields["LINK"]);
            $this->arFields["XML_ID"] = $uniq;
        }
        
        if($this->date_active=="NOW") $this->arFields["DATE_ACTIVE_FROM"] = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "SHORT");
        elseif($this->date_active=="NOW_TIME") $this->arFields["DATE_ACTIVE_FROM"] = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "FULL");
        //elseif($this->date_active=="PUBLIC" && $unix) $this->arFields["DATE_ACTIVE_FROM"] = ConvertTimeStamp($unix, "FULL");
    }

    protected function AddElementCatalog()
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $el = new CIBlockElement;
        $isElement = $this->checkUniq(); 
        if(!$isElement)
        {
            $id = $el->Add($this->arFields, "N", $this->index_element, $this->resize_image); 
            if(!$id)
            {   
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }else $this->elementID = $id;
        }else{
             $this->clearFieldsUpdate();

             $this->elementID = $isElement;
             $el->Update($isElement, $this->arFields);
        }
        unset($el);
    }
    
    protected function AddElementOfferCatalog()
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $el = new CIBlockElement;
        $isElement = $this->checkOfferUniq(); 
        if(!$isElement)
        {   
            $this->arOfferFields["XML_ID"] = "offer#".md5($this->arFields["NAME"].$this->arFields["LINK"]);
            $this->arOfferFields["NAME"] = $this->arFields["NAME"];
            $this->arOfferFields["IBLOCK_ID"] = $this->offerArray["IBLOCK_ID"];
            $this->arOfferFields["PROPERTY_VALUES"][$this->offerArray["SKU_PROPERTY_ID"]] = $this->elementID;
            $id = $el->Add($this->arOfferFields, "N", $this->index_element, $this->resize_image); 
            if(!$id)
            {   
                $this->errors[] = GetMessage("parser_offer_name").$this->arOfferFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }else $this->elementOfferID = $id;
        }else $this->elementOfferID = $isElement;

        unset($el);
    }
    
    protected function AddElementOfferCatalogSpecial($size)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $el = new CIBlockElement;
        $isElement = $this->checkOfferUniqSpecial($size); 
        if(!$isElement)
        {   
            $this->arOfferFields["XML_ID"] = "offer#".md5($this->arFields["NAME"].$this->arFields["LINK"].$size);
            $this->arOfferFields["NAME"] = $this->arFields["NAME"] ." (".$size.")";
            $this->arOfferFields["IBLOCK_ID"] = $this->offerArray["IBLOCK_ID"];
            $this->arOfferFields["PROPERTY_VALUES"][$this->offerArray["SKU_PROPERTY_ID"]] = $this->elementID;
            $this->arOfferFields["PROPERTY_VALUES"]["SIZES_CLOTHES"] = $this->CheckPropsOfferL(2787, "SIZES_CLOTHES", $size);
            $id = $el->Add($this->arOfferFields, "N", $this->index_element, $this->resize_image); 
            if(!$id)
            {   
                $this->errors[] = GetMessage("parser_offer_name").$this->arOfferFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }else $this->elementOfferID = $id;
        }else $this->elementOfferID = $isElement;

        unset($el);
    }
                           
    protected function clearFieldsUpdate()
    {   
        
        $this->arEmptyUpdate["PREVIEW_TEXT"] = trim($this->arEmptyUpdate["PREVIEW_TEXT"]);
        $this->arEmptyUpdate["DETAIL_TEXT"] = trim($this->arEmptyUpdate["DETAIL_TEXT"]);
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"]))
        {
            unset($this->arFields["PROPERTY_VALUES"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["preview_descr"] || (in_array("PREVIEW_TEXT", $this->arSortUpdate) && !empty($this->arEmptyUpdate["PREVIEW_TEXT"]))))
        {
            unset($this->arFields["PREVIEW_TEXT"]);
            unset($this->arFields["PREVIEW_TEXT_TYPE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["detail_descr"] || (in_array("DETAIL_TEXT", $this->arSortUpdate) && !empty($this->arEmptyUpdate["DETAIL_TEXT"]))))
        {
            unset($this->arFields["DETAIL_TEXT"]);
            unset($this->arFields["DETAIL_TEXT_TYPE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["preview_img"] || (in_array("PREVIEW_PICTURE", $this->arSortUpdate) && !empty($this->arEmptyUpdate["PREVIEW_PICTURE"]))))
        {
            unset($this->arFields["PREVIEW_PICTURE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["detail_img"] || (in_array("DETAIL_PICTURE", $this->arSortUpdate) && !empty($this->arEmptyUpdate["DETAIL_PICTURE"]))))
        {
            unset($this->arFields["DETAIL_PICTURE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"]))
        {
            unset($this->arPrice);
        }
        if($this->checkUniq())
        {
            $code = $this->settings["catalog"]["more_image_props"];
            unset($this->arFields["PROPERTY_VALUES"][$code]);
        }

    }

    protected function AddMeasureCatalog()
    {
        if($this->elementUpdate) return false;
        $info = CModule::CreateModuleObject('catalog');
        if(!CheckVersion("14.0.0", $info->MODULE_VERSION))
        {
            if($this->settings["catalog"]["koef"]>0)
            {
                $arMes = array("RATIO"=>$this->settings["catalog"]["koef"], "PRODUCT_ID"=>$this->elementID);
                $str_CAT_MEASURE_RATIO = 1;
                $CAT_MEASURE_RATIO_ID = 0;
                $db_CAT_MEASURE_RATIO = CCatalogMeasureRatio::getList(array(), array("PRODUCT_ID" => $this->elementID));
                if($ar_CAT_MEASURE_RATIO = $db_CAT_MEASURE_RATIO->Fetch())
                {
                    $str_CAT_MEASURE_RATIO = $ar_CAT_MEASURE_RATIO["RATIO"];
                    $CAT_MEASURE_RATIO_ID =  $ar_CAT_MEASURE_RATIO["ID"];
                }
                if($CAT_MEASURE_RATIO_ID>0)
                {
                    if(!CCatalogMeasureRatioAll::Update($CAT_MEASURE_RATIO_ID, $arMes))
                    {
                        $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_ratio");
                    }    
                }
                else{
                    if(!CCatalogMeasureRatio::add($arMes))
                    {
                        $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_ratio");
                    }    
                }
                
            }
        }
    }

    protected function AddProductCatalog()
    {
        if($this->elementUpdate && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        $this->arProduct["MEASURE"] = $this->settings["catalog"]["measure"];
        $this->arProduct["VAT_ID"] = $this->settings["catalog"]["cat_vat_id"];
        $this->arProduct["VAT_INCLUDED"] = $this->settings["catalog"]["cat_vat_included"];
        $this->arProduct["ID"] = $this->elementID; 

        $isElement = $this->elementUpdate;
        if(!$isElement)
        {
            if(!CCatalogProduct::Add($this->arProduct))
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_add_product");
            }
        }else{
            $this->UpdateProductCatalog($isElement);
        }

    } 

    protected function UpdateProductCatalog($productID)
    {
        if(!$productID){
            $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_update_product");
            return false;
        }
        CCatalogProduct::Update($productID, $this->arProduct);
    }
    
    protected function ConvertCurrency()
    {
        if($this->settings["catalog"]["convert_currency"])
        {
            $this->arPrice["CURRENCY"] = $this->settings["catalog"]["convert_currency"];
            $this->arPrice["PRICE"] = CCurrencyRates::ConvertCurrency($this->arPrice["PRICE"], $this->settings["catalog"]["currency"], $this->settings["catalog"]["convert_currency"]);    
        }    
    }
    
    protected function ChangePrice()
    {
        if(is_array($this->settings["catalog"]["price_updown"]) && count($this->settings["catalog"]["price_updown"])>0)
        {
            foreach($this->settings["catalog"]["price_updown"] as $i=>$val)
            {
                if($this->settings["catalog"]["price_updown"][$i] && $this->settings["catalog"]["price_value"][$i])
                {
                    if($this->settings["catalog"]["price_terms"][$i]=="delta")
                    {
                        if(empty($this->settings["catalog"]["price_terms_value"][$i]) && !empty($this->settings["catalog"]["price_terms_value_to"][$i]))
                        {
                            if($this->arPrice["PRICE"]>$this->settings["catalog"]["price_terms_value_to"][$i]) continue;
                        }
                        
                        if(!empty($this->settings["catalog"]["price_terms_value"][$i]) && empty($this->settings["catalog"]["price_terms_value_to"][$i]))
                        {
                            if($this->arPrice["PRICE"]<$this->settings["catalog"]["price_terms_value"][$i]) continue;
                        }
                        
                        if(!empty($this->settings["catalog"]["price_terms_value"][$i]) && !empty($this->settings["catalog"]["price_terms_value_to"][$i]))
                        {
                            if($this->arPrice["PRICE"]<$this->settings["catalog"]["price_terms_value"][$i] || $this->arPrice["PRICE"]>$this->settings["catalog"]["price_terms_value_to"][$i]) continue;
                        }
                    }
                    if($this->settings["catalog"]["price_type_value"][$i]=="percent")
                    {
                        $delta = $this->arPrice["PRICE"]*$this->settings["catalog"]["price_value"][$i]/100; 
                    }else{
                        $delta = $this->settings["catalog"]["price_value"][$i]; 
                    }
                    if($this->settings["catalog"]["price_updown"][$i]=="up")
                    {   
                        $this->arPrice["PRICE"] += $delta;
                    }
                    elseif($this->settings["catalog"]["price_updown"][$i]=="down")
                    {    
                        $this->arPrice["PRICE"] -= $delta;
                    }
                    break;
                }
            }
        }else{
            if($this->settings["catalog"]["price_updown"] && $this->settings["catalog"]["price_value"])
            {   
                    if($this->settings["catalog"]["price_terms"]=="up" && $this->settings["catalog"]["price_terms_value"])
                    {
                        if($this->arPrice["PRICE"]<$this->settings["catalog"]["price_terms_value"]) return false;
                    }
                    if($this->settings["catalog"]["price_terms"]=="down" && $this->settings["catalog"]["price_terms_value"])
                    {
                        if($this->arPrice["PRICE"]>$this->settings["catalog"]["price_terms_value"]) return false;
                    }
            
                    if($this->settings["catalog"]["price_type_value"]=="percent")
                    {
                        $delta = $this->arPrice["PRICE"]*$this->settings["catalog"]["price_value"]/100; 
                    }else{
                        $delta = $this->settings["catalog"]["price_value"]; 
                    }
                    if($this->settings["catalog"]["price_updown"]=="up")
                    {
                        $this->arPrice["PRICE"] += $delta;
                    }
                    elseif($this->settings["catalog"]["price_updown"]=="down")
                    {
                        $this->arPrice["PRICE"] -= $delta;
                    }
            }    
        }
            
    }

    protected function AddPriceCatalog()
    {
        if($this->elementUpdate && (!$this->isUpdate || !$this->isUpdate["price"])) return false;

        if(!$this->arPrice || !$this->arPrice["PRICE"]) return false;
        $isElement = $this->elementUpdate;
        $this->arPrice["PRODUCT_ID"] = $this->elementID;
        $this->ChangePrice();
        $this->ConvertCurrency(); 
        $obPrice = new CPrice();
        if(!$isElement)
        {
            $price = $obPrice->Add($this->arPrice);
            if(!$price)
            {   
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_add_price").$obPrice->LAST_ERROR;
            }
        }else $this->UpdatePriceCatalog($isElement);

        unset($obPrice);
    }

    protected function UpdatePriceCatalog($elementID)
    {
        if(!$elementID){
            $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_update_price");
            return false;
        }  
        $res = CPrice::GetList(
            array(),
            array(
                "PRODUCT_ID" => $elementID,
                "CATALOG_GROUP_ID" => $this->arPrice["CATALOG_GROUP_ID"]
                )
        );

        if ($arr = $res->Fetch())
        {
            CPrice::Update($arr["ID"], $this->arPrice);
        }
    }

    protected function parserCatalogPreview(&$el)
    {
        if(!$this->parseCatalogUrlPreview($el)) return false;
        $this->parseCatalogNamePreview($el);
        if($this->isCatalog)$this->parseCatalogPricePreview($el);
        $this->parseCatalogDescriptionPreview($el);
        $this->parseCatalogPreviewPicturePreview($el);
        return true;
    }

    protected function parserCatalogDetail()
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $el = $this->parserCatalogDetailPage();
        $this->parseCatalogNameDetail($el);
        $this->parseCatalogDetailMorePhoto($el);
        $this->parseCatalogProperties($el);

        if($this->isCatalog)$this->parseCatalogPriceDetail($el);
        $this->parseCatalogDescriptionDetail($el);
        $this->parseCatalogDetailPicture($el);



    }

    protected function parseCatalogProperties(&$el)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $this->parseCatalogDefaultProperties($el);
        $this->parseCatalogSelectorProperties($el);
        $this->parseCatalogFindProperties($el);
        $this->AllDoProps();
        if($this->isCatalog)$this->parseCatalogFindProduct($el);
        if($this->isCatalog)$this->parseCatalogSelectorProduct($el);
    }

    protected function AllDoProps()
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"])) return false;
        $isElement = $this->checkUniq();
        if($isElement)
        {
            $obElement = new CIBlockElement;
            $rsProperties = $obElement->GetProperty($this->iblock_id, $isElement, "sort", "asc");
            while($arProperty = $rsProperties->Fetch())
            {

                if(isset($this->arFields["PROPERTY_VALUES"][$arProperty["CODE"]]) || $arProperty["PROPERTY_TYPE"]=="F") continue;
                $this->arFields["PROPERTY_VALUES"][$arProperty["ID"]][$arProperty['PROPERTY_VALUE_ID']] = array(
                    "VALUE"=>$arProperty['VALUE'],
                    "DESCRIPTION"=>$arProperty["DESCRIPTION"]
                );
            }

        }
    }

    protected function clearFields()
    {
        unset($this->arFields);
        unset($this->arProduct);
        unset($this->arPrice);
        unset($this->elementUpdate);
        if(isset($this->elementOfferUpdate))unset($this->elementOfferUpdate);
        unset($this->elementID);
        unset($this->detailHtml);
        unset($this->arEmptyUpdate);
        $this->SaveLog();
        //if($this->settings["catalog"]["mode"]!="debug")
         
        unset($this->errors); 
    }
    
    protected function clearHtml()
    {
        unset($this->html);
    }

    protected function getCodeElement($name)
    {
        $arFieldCode = $this->arrayIblock["FIELDS"]["CODE"]["DEFAULT_VALUE"];
        $CODE = CUtil::translit($name, "ru", array(
            "max_len" => $arFieldCode["TRANS_LEN"],
            "change_case" => $arFieldCode["TRANS_CASE"],
            "replace_space" => $arFieldCode["TRANS_SPACE"],
            "replace_other" => $arFieldCode["TRANS_OTHER"],
            "delete_repeat_replace" => $arFieldCode["TRANS_EAT"]=="Y"?true:false,
        ));
        
        $IBLOCK_ID = $this->arrayIblock['ID'];

        $arCodes = array();
        $rsCodeLike = CIBlockElement::GetList(array(), array(
                "IBLOCK_ID" => $IBLOCK_ID,
                "CODE" => $CODE."%",
        ), false, false, array("ID", "CODE"));
        while($ar = $rsCodeLike->Fetch())
            $arCodes[$ar["CODE"]] = $ar["ID"];

        if (array_key_exists($CODE, $arCodes))
        {
            $i = 1;
            while(array_key_exists($CODE."_".$i, $arCodes))
                $i++;

            return $CODE."_".$i;
        }
        else
        {
            return $CODE;
        }
    }

    protected function getArrayIblock()
    {
        $arIBlock = CIBlock::GetArrayByID($this->iblock_id);
        $this->arrayIblock = $arIBlock; 
    }

    protected function parseCatalogSection()
    {
        if($this->checkUniq()) return false;
        $this->arFields["IBLOCK_SECTION_ID"] = $this->section_id;
    }

    protected function parseCatalogFindProduct(&$el)
    {
        $arProperties = $this->arFindProduct;
        if(!$arProperties) return false;
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        $find = $this->settings["catalog"]["selector_find_size"];
        if($this->settings["catalog"]["catalog_delete_find_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_find_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }

        foreach(pq($el)->find($find) as $prop)
        {
            $text = pq($prop)->html();
            $text = strip_tags($text);
            $text = str_replace($deleteSymb, "", $text);
            foreach($arProperties as $code=>$val)
            {
                //if(preg_match("/".$val."/", $text))
                if(strpos($text, $val)!==false)
                {
                    $text = str_replace($val, "", $text);
                    $text = trim($text);
                    $this->arProduct[$code] = $text;
                }
            }

        }
    }

    protected function parseCatalogSelectorProduct(&$el)
    {
        $arProperties = $this->arSelectorProduct;
        if(!$arProperties) return false;
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        if($this->settings["catalog"]["catalog_delete_selector_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }
            }
        }

        foreach($arProperties as $code=>$val)
        {
            $text = pq($el)->find($this->settings["catalog"]["selector_product"][$code])->html();
            $text = strip_tags($text);
            $text = str_replace($deleteSymb, "", $text);
            $text = trim($text);
            $this->arProduct[$code] = $text;
        }
    }

    protected function parseCatalogSelectorProperties(&$el)
    {
        $arProperties = $this->arSelectorProperties;
        if(!$arProperties) return false;
        if($this->settings["catalog"]["catalog_delete_selector_props_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }
 
        foreach($arProperties as $code=>$val)
        {
            $text = pq($el)->find($this->settings["catalog"]["selector_prop"][$code])->html();
            $text = strip_tags($text);
            $text = str_replace($deleteSymb, "", $text);
            $this->parseCatalogProp($code, $val, $text);
        }



    }

    protected function parseCatalogFindProperties(&$el)
    {   
        $arProperties = $this->arFindProperties;
        if(!$arProperties) return false;
        $find = $this->settings["catalog"]["selector_find_props"];
        if($this->settings["catalog"]["catalog_delete_selector_find_props_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_find_props_symb"]);
            
            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }
        $arFind = explode(",", $find);
        
        foreach($arFind as $vFind)
        {
            if(strpos($vFind, " br")!==false || strpos($vFind, "<br/>") || strpos($vFind, "<br />"))
            {
                $vFind = str_replace(array(" br", "<br/>", "<br />"), "", $vFind);
                $vFind = trim($vFind);
                $arBr = array("<br>", "<br/>", "<br />");
                
                foreach(pq($el)->find($vFind) as $prop)
                {   
                    $text = pq($prop)->html();
                    $text = str_replace($arBr, "<br>", $text);
                    unset($arBr[1]);
                    unset($arBr[2]);
                    foreach($arBr as $br)
                    {   
                        $arTextBr = explode($br, $text);
                        if(!empty($arTextBr) && count($arTextBr)>1)
                        {   
                            foreach($arTextBr as $textBr)
                            {   
                                $textBr = strip_tags($textBr);
                                $textBr = str_replace($deleteSymb, "", $textBr);
                                foreach($arProperties as $code=>$val)
                                {
                                    //if(preg_match("/".$val."/", $textBr))
                                    if($this->CheckFindProps($code, $val, $textBr))
                                    {   
                                        $this->parseCatalogProp($code, $val, $textBr);
                                    }    
                                }
                                
                            }      
                        }
                    }
                    
                }
            }else
            {
                foreach(pq($el)->find($vFind) as $prop)
                {   
                    $text = pq($prop)->html();
                    $text = strip_tags($text);
                    $text = str_replace($deleteSymb, "", $text);
                    foreach($arProperties as $code=>$val)
                    {
                        //if(preg_match("/".$val."/", $text))
                        
                        if($this->CheckFindProps($code, $val, $text))
                        {   
                            $this->parseCatalogProp($code, $val, $text);
                        }
                    }

                }    
            }    
        }
        
          
        
    }
    
    protected function parseCatalogDefaultProperties(&$el)
    {
        if(isset($this->settings["catalog"]["default_prop"]) && !empty($this->settings["catalog"]["default_prop"]))
        {
            foreach($this->settings["catalog"]["default_prop"] as $code=>$val)
            {
                if($val)$this->parseCatalogDefaultProp($code, $val);    
            }
        }    
    }
    
    protected function CheckFindProps($code, $val, $text)
    {
        $arDubleProperties = $this->arDubleFindProperties;
        $bool = false;
        if(isset($arDubleProperties[$code]))
        {   
            foreach($arDubleProperties[$code] as $prop)
            {
                $v = $this->arFindProperties[$prop];
                //if(preg_match("/".$v."/", $text))
                if(strpos($text, $v)!==false)
                {
                    $bool  = true;    
                }    
            }
            if($bool) return false;
        }
        //if(preg_match("/".$val."/", $text)) return true;
        if(strpos($text, $val)!==false) return true;
        else return false;
    }

    protected function parseCatalogMeta()
    {
        if($this->checkUniq()) return false;
        if($this->meta_description!="N" || $this->meta_keywords!="N")
        {
            foreach($this->detailHtml["meta"] as $meta)
            {
                if($this->meta_description!="N" && strtolower(pq($meta)->attr("name"))=="description")
                {
                    $meta_text = pq($meta)->attr("content");
                    if(!$meta_text)$meta_text = pq($meta)->attr("value");
                    if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                        $meta_text = mb_convert_encoding($meta_text, LANG_CHARSET, "utf-8");
                    }
                    $this->arFields["PROPERTY_VALUES"][$this->meta_description] = strip_tags($meta_text);
                }elseif($this->meta_keywords!="N" && strtolower(pq($meta)->attr("name"))=="keywords")
                {
                    $meta_text = pq($meta)->attr("content");
                    if(!$meta_text)$meta_text = pq($meta)->attr("value");
                    if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                        $meta_text = mb_convert_encoding($meta_text, LANG_CHARSET, "utf-8");
                    }
                    $this->arFields["PROPERTY_VALUES"][$this->meta_keywords] = strip_tags($meta_text);
                }
                unset($meta_text);
            }
        }

        if($this->meta_title!="N")
        {
            $meta_title = pq($this->detailHtml["head:eq(0) title:eq(0)"])->text();
            $meta_title = strip_tags($meta_title);
            if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                $meta_title = mb_convert_encoding($meta_title, LANG_CHARSET, "utf-8");
            }
            $this->arFields["PROPERTY_VALUES"][$this->meta_title] = $meta_title;
        }

    }

    protected function parseCatalogFirstUrl()
    {
        if($this->checkUniq()) return false;
        if($this->first_title!="N")
        {
            $this->arFields["PROPERTY_VALUES"][$this->first_title] = $this->arFields["LINK"];
        }
    }

    protected function parseCatalogDate()
    {

    }

    protected function parseCatalogProp($code, $val, $text)
    {
        $text = str_replace($val, "", $text);
        $val = trim($text);
        $arProp = $this->arProperties[$code];
        //$default = $this->settings["catalog"]["default_prop"][$code];
        
        if($arProp["PROPERTY_TYPE"]=="S")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="N")
        {
            $val =  str_replace(",", ".", $val);
            $val = preg_replace("/\.{1}$/", "", $val);
            $val = preg_replace('/[^0-9.]/', "", $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;    
            
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsL($arProp["ID"], $code, $val);
            if($code=="SIZE")
            {
                $strSize = $val;
                $this->strArSize = explode(" ", $val);
            }
            
            
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsL($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]!="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsE($arProp, $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]=="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsE($arProp, $code, $val);
        }
    }
    
    protected function parseCatalogDefaultProp($code, $val)
    {
        $val = trim($val);
        $arProp = $this->arProperties[$code];
        
        if($arProp["PROPERTY_TYPE"]=="S")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="N")
        {
            $val =  str_replace(",", ".", $val);
            $val = preg_replace("/\.{1}$/", "", $val);
            $val = preg_replace('/[^0-9.]/', "", $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;    
            
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]!="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsE($arProp, $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]=="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsE($arProp, $code, $val);
        }
    }
    
    protected function CheckPropsE($arProp, $code, $val)
    {
        $IBLOCK_ID = $arProp["LINK_IBLOCK_ID"];
        
        $rsProp = CIBlockElement::GetList(Array(), array("IBLOCK_ID"=>$IBLOCK_ID, "%NAME"=>$val), false, false, array("ID", "NAME"));
        while($arIsProp = $rsProp->Fetch())
        {
            $arIsProp["NAME"] = mb_strtolower($arIsProp["NAME"], LANG_CHARSET); 
            $val0 = mb_strtolower($val, LANG_CHARSET);
            if($val0==$arIsProp["NAME"])
            {
                $isProp = $arIsProp["ID"];
            }   
        }
        
        if($isProp) return $isProp;
        else{
            $arFields = array(
                "NAME"=>$val,
                "ACTIVE" => "Y",
                "IBLOCK_ID" => $IBLOCK_ID
            );
            $el = new CIBlockElement;
            $id = $el->Add($arFields);
            unset($el);
            return $id;
        }
    }

    protected function CheckPropsL($id, $code, $val)
    {
        $res2 = CIBlockProperty::GetPropertyEnum(
            $id,
            array(),
            array("IBLOCK_ID" => $this->iblock_id, "VALUE" => $val)
        );

        if ($arRes2 = $res2->Fetch())
        {
            $kz = $arRes2["ID"];
        }
        else
        {
            $tmpid = md5(uniqid(""));
            $kz = CIBlockPropertyEnum::Add(
                array(
                "PROPERTY_ID" => $id,
                "VALUE" => $val,
                "TMP_ID" => $tmpid
            )
            );

        }

        return $kz;
    }
    
    protected function CheckPropsOfferL($id, $code, $val)
    {
        $res2 = CIBlockProperty::GetPropertyEnum(
            $id,
            array(),
            array("IBLOCK_ID" => $this->offerArray["IBLOCK_ID"], "VALUE" => $val)
        );

        if ($arRes2 = $res2->Fetch())
        {
            $kz = $arRes2["ID"];
        }
        else
        {
            $tmpid = md5(uniqid(""));
            $kz = CIBlockPropertyEnum::Add(
                array(
                "PROPERTY_ID" => $id,
                "VALUE" => $val,
                "TMP_ID" => $tmpid
            )
            );

        }

        return $kz;
    }

    protected function getFindProduct()
    {
        foreach($this->settings["catalog"]["find_product"] as $i=>$prop)
        {
            $prop = trim($prop);
            if(!empty($prop))
            {
                $arProps[$i] = $prop;
            }
        }
        if(!$arProps) return false;
        return $arProps;
    }

    protected function getSelectorProduct()
    {
        foreach($this->settings["catalog"]["selector_product"] as $i=>$prop)
        {
            $prop = trim($prop);
            if(!empty($prop))
            {
                $arProps[$i] = $prop;
            }
        }
        if(!$arProps) return false;
        return $arProps;
    }
    
    protected function getFindDubleProperties()
    {
        $arFindProps = $this->arFindProperties;
        //printr($arFindProps);
        foreach($arFindProps as $code=>$prop)
        {
            foreach($arFindProps as $code1=>$prop1)
            {
                if(strpos($prop1, $prop)!==false && $code1!=$code)
                {
                    $arDubleProps[$code][] = $code1;
                }    
            }        
        }
        if(isset($arDubleProps)) return $arDubleProps;
        else return false;    
    }

    protected function getFindProperties()
    {
        foreach($this->settings["catalog"]["find_prop"] as $i=>$prop)
        {
            $prop = trim($prop);
            if(!empty($prop))
            {
                $arProps[$i] = $prop;
            }
        }
        if(!isset($arProps)) return false;
        return $arProps;
    }

    protected function getSelectorProperties()
    {
        foreach($this->settings["catalog"]["selector_prop"] as $i=>$prop)
        {
            $prop = trim($prop);
            if(!empty($prop))
            {
                $arProps[$i] = $prop;
            }
        }
        if(!$arProps) return false;
        return $arProps;
    }

    protected function parseCatalogDetailMorePhoto(&$el)
    {
        if($this->settings["catalog"]["more_image_props"])
        {
            if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["more_img"])) return false;
            $code = $this->settings["catalog"]["more_image_props"];
            $ar = $this->GetArraySrcAttr($this->settings["catalog"]["more_image"]);
            $image = $ar["path"];
            $attr = $ar["attr"];
            $n = 0;

            $isElement = $this->checkUniq();

            foreach(pq($el)->find($image) as $img)
            {
                $src = pq($img)->attr($attr);
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["VALUE"] = CFile::MakeFileArray($src);
                $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["DESCRIPTION"] = "";
                $n++;
            }
            if($isElement)
            {
                $arImages = $this->arFields["PROPERTY_VALUES"][$code];
                //unset($this->arFields["PROPERTY_VALUES"][$code]);
                $obElement = new CIBlockElement;
                $rsProperties = $obElement->GetProperty($this->iblock_id, $isElement, "sort", "asc",  Array("CODE"=>$code));
                while($arProperty = $rsProperties->Fetch())
                {
                    $arImages[$arProperty["PROPERTY_VALUE_ID"]] = array(
                        "tmp_name" => "",
                        "del" => "Y",
                    );
                }
                CIBlockElement::SetPropertyValueCode($isElement, $code, $arImages);
                unset($obElement);
            }

        }



    }

    protected function parserCatalogDetailPage()
    {
        $this->catalogSleep();
        $this->detailFileHtml = new FileGetHtml();
        $this->detailPage = $this->fileHtml->file_get_html($this->arFields["LINK"], $this->settings["catalog"]["proxy"], $this->auth);
        $this->DeleteCharsetHtml5($this->detailPage);
        $this->detailHttpCode = $this->fileHtml->httpCode;

        if($this->detailHttpCode!=200 && $this->detailHttpCode!=301 && $this->detailHttpCode!=302 && $this->detailHttpCode!=303)
        {
            $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."]".GetMessage("parser_error_connect")."[".$this->detailHttpCode."]";
            //return false;
        }
        $this->detailHtml = phpQuery::newDocument($this->detailPage, "text/html;charset=".LANG_CHARSET);
        //if($this->detail_delete_element)$this->deleteCatalogElement($this->detail_delete_element, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        //if($this->detail_delete_attribute)$this->deleteCatalogAttribute($this->detail_delete_attribute, $this->detail_dom, $this->detailHtml[$this->detail_dom]);

        foreach($this->detailHtml[$this->detail_dom] as $detail)
        {
            return $detail;
        }
        $this->errors[] = GetMessage("parser_error_selecto_detail_notfound");


    }

    protected function parseCatalogUrlPreview($el)
    {
        $url = $this->settings["catalog"]["href"]?$this->settings["catalog"]["href"]:"a:eq(0)";
        $this->settings["catalog"]["href"] = $url;
        $p = pq($el)->find($url)->attr("href");
        if(!$p)
        {
            $this->errors[] = GetMessage("parser_error_href_notfound");
            return false;
        }
        $p = $this->getCatalogLink($p);
        $this->arFields["LINK"] = $p;
        if(isset($this->pagePrevElement[$p])) return false;
        return true;
    }

    protected function parseCatalogNamePreview($el)
    {
        if(isset($this->settings["catalog"]["detail_name"]) && $this->settings["catalog"]["detail_name"]) return false;
        $name = $this->settings["catalog"]["name"]?$this->settings["catalog"]["name"]:$this->settings["catalog"]["href"];

        $this->arFields["NAME"] = trim(strip_tags(pq($el)->find($name)->html()));
        if(!$this->arFields["NAME"])
        {
            $this->errors[] = GetMessage("parser_error_name_notfound");
            return false;
        }
    }
    
    protected function parseCatalogNameDetail($el)
    {
        if(!isset($this->settings["catalog"]["detail_name"]) || !$this->settings["catalog"]["detail_name"]) return false;
        $name = $this->settings["catalog"]["detail_name"];

        $this->arFields["NAME"] = trim(strip_tags(pq($el)->find($name)->html()));
        if(!$this->arFields["NAME"])
        {
            $this->errors[] = GetMessage("parser_error_name_notfound");
            return false;
        }
    }

    protected function parseCatalogPricePreview(&$el)
    {
        if($this->settings["catalog"]["preview_price"])
        {
            if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"])) return false;
            $price = $this->settings["catalog"]["preview_price"];
            $price = strip_tags(pq($el)->find($price)->html());
            $price = trim($price);
            $price = str_replace(",", ".", $price);
            $price = preg_replace("/\.{1}$/", "", $price);
            $price = preg_replace('/[^0-9.]/', "", $price);
            $this->arPrice["PRICE"] = $price;
            $this->arPrice["PRICE"] = trim($this->arPrice["PRICE"]);
            if(!$this->arPrice["PRICE"])
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."]".GetMessage("parser_error_price_notfound");
                unset($this->arPrice["PRICE"]);
                return false;
            }
            $this->arPrice["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
            $this->arPrice["CURRENCY"] = $this->settings["catalog"]["currency"];
        }

    }

    protected function parseCatalogPriceDetail(&$el)
    {

        if($this->settings["catalog"]["detail_price"])
        {
            if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"])) return false;
            $price = $this->settings["catalog"]["detail_price"];
            $price = strip_tags(pq($el)->find($price)->html());
            $price = trim($price);
            $price = str_replace(",", ".", $price);
            $price = preg_replace("/\.{1}$/", "", $price);
            $price = preg_replace('/[^0-9.]/', "", $price);
            $this->arPrice["PRICE"] = $price;
            $this->arPrice["PRICE"] = trim($this->arPrice["PRICE"]);
            if(!$this->arPrice["PRICE"])
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."]".GetMessage("parser_error_price_notfound");
                unset($this->arPrice["PRICE"]);
                return false;
            }
            $this->arPrice["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
            $this->arPrice["CURRENCY"] = $this->settings["catalog"]["currency"];
        }

    }

    protected function parseCatalogDescriptionPreview(&$el)
    {
        if($this->checkUniq() && (!$this->isUpdate || $this->isUpdate["preview_descr"]=="N")) return false;
        if($this->settings["catalog"]["preview_text_selector"] && $this->settings["catalog"]["text_preview_from_detail"]!="Y")
        {
            $preview = $this->settings["catalog"]["preview_text_selector"];
            foreach(pq($el)->find($preview." img") as $img)
            {
                $src = pq($img)->attr("src");
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                $this->parseCatalogSaveImgServer($img, $src);
            }

            if($this->bool_preview_delete_tag=="Y")$preview_text = strip_tags(pq($el)->find($preview)->html(), $this->preview_delete_tag);
            else $preview_text = pq($el)->find($preview)->html();
            $this->arFields["PREVIEW_TEXT"] = trim($preview_text);
            $this->arFields["PREVIEW_TEXT_TYPE"] = $this->preview_text_type;
        }
    }

    protected function parseCatalogDescriptionDetail(&$el)
    {
        if($this->detail_delete_element)$this->deleteCatalogElement($this->detail_delete_element, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        if($this->detail_delete_attribute)$this->deleteCatalogAttribute($this->detail_delete_attribute, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        if($this->checkUniq() && (!$this->isUpdate || (!$this->isUpdate["detail_descr"] && (!$this->isUpdate["preview_descr"] && !$this->settings["catalog"]["text_preview_from_detail"]!="Y")))) return false;
        if($this->settings["catalog"]["detail_text_selector"])
        {
            $detail = $this->settings["catalog"]["detail_text_selector"];
            foreach(pq($el)->find($detail." img") as $img)
            {
                $src = pq($img)->attr("src");
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                $this->parseCatalogSaveImgServer($img, $src);
            }
            if($this->bool_detail_delete_tag=="Y")$detail_text = strip_tags(pq($el)->find($detail)->html(), $this->detail_delete_tag);
            else $detail_text = pq($el)->find($detail)->html();
            $this->arFields["DETAIL_TEXT"] = trim($detail_text);
            $this->arFields["DETAIL_TEXT_TYPE"] = $this->detail_text_type;
            if($this->settings["catalog"]["text_preview_from_detail"]=="Y")
            {
                $this->arFields["PREVIEW_TEXT"] = $this->arFields["DETAIL_TEXT"];
                $this->arFields["PREVIEW_TEXT_TYPE"] = $this->arFields["DETAIL_TEXT_TYPE"];
            }
        }
    }

    protected function parseCatalogDetailPicture(&$el)
    {   
        if($this->checkUniq() && (!$this->isUpdate || (!$this->isUpdate["detail_img"] && (!$this->isUpdate["preview_img"] && !$this->settings["catalog"]["img_preview_from_detail"]!="Y")))) return false;
        if($this->settings["catalog"]["detail_picture"])
        {    
            $arSelPic = explode(",", $this->settings["catalog"]["detail_picture"]);

            foreach($arSelPic as $sel)
            {
                $sel = trim($sel);
                if(empty($sel)) continue;
                $ar = $this->GetArraySrcAttr($sel);
                $img = $ar["path"];
                $attr = $ar["attr"];
                $src = pq($el)->find($img)->attr($attr); 
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                if(!self::CheckImage($src)) continue;
                //$src = str_replace("cdn.", "", $src);
                $this->arFields["DETAIL_PICTURE"] = CFile::MakeFileArray($src);
                if($this->settings["catalog"]["img_preview_from_detail"]=="Y")
                {
                    $this->arFields["PREVIEW_PICTURE"] = $this->arFields["DETAIL_PICTURE"];
                }
            }

        }
    }

    protected function CheckImage($src)
    {
        if(!empty($src) && preg_match("/(jpeg|jpg|gif|png|JPEG|JPG|GIF|PNG)$/", $src))
        {
            return true;
        }else return false;
    }

    protected function parseCatalogPreviewPicturePreview(&$el)
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["preview_img"])) return false;
        if($this->settings["catalog"]["preview_picture"] && $this->settings["catalog"]["img_preview_from_detail"]!="Y")
        {   
            $ar = $this->GetArraySrcAttr($this->settings["catalog"]["preview_picture"]);
            $img = $ar["path"];
            $attr = $ar["attr"];
            $src = pq($el)->find($img)->attr($attr);
            $src = $this->parseCaralogFilterSrc($src);
            $src = $this->getCatalogLink($src);
            //$src = str_replace("cdn.", "", $src);
            if(!self::CheckImage($src)) return;
            $this->arFields["PREVIEW_PICTURE"] = CFile::MakeFileArray($src); 
        }
    }

    protected function parseCatalogSaveImgServer($img, $src){
        $arImg = CFile::MakeFileArray($src);
        $fid = CFile::SaveFile($arImg, "shs.parser");
        pq($img)->attr('src', CFile::GetPath($fid));
    }

    public function parseCaralogFilterSrc($src){
        $src = preg_replace('/#.+/', '', $src);
        $src = preg_replace('/\?.+/', '', $src);
        //$src = str_replace('http:/', 'http://', $src);
        $src = str_replace('//', '/', $src);
        $src = str_replace('http:/', 'http://', $src);
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src))$src = preg_replace("/^\/{2}/", "http://", $src);
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src))$src = preg_replace("/^\/{1}/", "http://", $src);
        //$src = str_replace('//', '/', $src);
        return $src;
    }

    protected function GetArraySrcAttr($path)
    {
        $ar["path"] = $image = preg_replace('#\[[^\[]+$#','',$path);
        preg_match('#\[[^\[]+$#', $path, $matches);
        $ar["attr"] = $attr = str_replace(array("[", "]"), "", $matches[0]);
        return $ar;
    }

    protected function parseCatalogPages()
    {
        global $zis;
        foreach($this->pagenavigation as $id=>$page)
        {
            $this->clearHtml();
            
            try{
                if(isset($this->pagenavigationPrev[$page]) || isset($this->pagenavigationPrev[$id]) || empty($page)) continue;
            }catch(Exception $e)
            {
                continue;    
            } 
            
            
            $zis++;
           
            if($this->currentPage>=self::DEFAULT_DEBUG_LIST && $this->settings["catalog"]["mode"]=="debug") return;
            $this->connectCatalogPage($page);
            $this->parseCatalogNavigation($page);
            if($this->IsNumberPageNavigation() && $this->CheckPageNavigation($id))
            {   
                $this->parseCatalogProducts();
            }elseif(!$this->IsNumberPageNavigation())
            {
                $this->parseCatalogProducts();    
            }

            $i++;

        }
        foreach($this->pagenavigationPrev as $i=>$v)
        {
            foreach($this->pagenavigation as $i1=>$v1)
            {
                if($v1==$v) unset($this->pagenavigation[$i1]);   
            }
        }
        
        if(count($this->pagenavigation)>0)
        {
            $this->parseCatalogPages();
        }
        
    }
    
    protected function SaveCopyPage()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt", $this->page);
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt", $this->fileHtml->headerUrl);   
        }     
    }
    
    protected function DeleteCopyPage()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt"))
        {
            unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt");
            unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt"); 
        }     
    }
    
    protected function GetCopyPage()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt"))
        {
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt");
            $this->httpCode = 200;
            return $file;  
        }
        $this->httpCode = 0;
        return false;     
    }
    
    protected function GetCopyUrl()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt"))
        {
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt");
            return $file;  
        }
        $this->httpCode = 0;
        return false;     
    }
    
    /*private function connectCatalogPage0($page)
    {
        global $zis;
        //file_put_contents(dirname(__FILE__)."/catalog_page.txt", print_r(array($page), true), FILE_APPEND);
        $this->catalogSleep();
        $this->sectionPage = $page;
        $this->fileHtml = new FileGetHtml();
        $this->page = $this->GetCopyPage();
        if(!$this->page)
            $this->page = $this->fileHtml->file_get_html($page, $this->settings["catalog"]["proxy"]);
        $this->DeleteCharsetHtml5($this->page);
        $this->SaveCopyPage();
        
        $this->httpCode = $this->fileHtml->httpCode;

        if($this->httpCode!=200 && $this->httpCode!=301 && $this->httpCode!=302 && $this->httpCode!=303)
        {
            if($this->settings["catalog"]["404"]!="Y" && $this->httpCode==404)
            {
                $this->errors[] = "[".$page."]".GetMessage("parser_error_connect")."[".$this->httpCode."]";
                //if($this->agent || $this->settings["catalog"]["mode"]=="debug")
                {
                    $this->SaveLog();
                    unset($this->errors);
                        
                }
                
                return false;
            }

        }
        
        $this->currentPage++;
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")$this->SavePrevPage($page);
        //if($page==$this->rss)
        {
            $this->urlCatalog = $this->fileHtml->headerUrl;
            $this->urlSite = $this->getCatalogUrlSite();
        }
        
        return true;
          

    }*/

    protected function connectCatalogPage($page)
    {
        $this->catalogSleep();
        $this->sectionPage = $page;
        $this->fileHtml = new FileGetHtml();
        $this->page = $this->GetCopyPage();
        if(!$this->page)
        {
            $this->page = $this->fileHtml->file_get_html($page, $this->settings["catalog"]["proxy"], $this->auth); 
               
        }else{
            $this->fileHtml->httpCode = 200;
            $this->fileHtml->headerUrl = $this->GetCopyUrl();    
        }
        $this->DeleteCharsetHtml5($this->page);
        $this->SaveCopyPage();
        $this->httpCode = $this->fileHtml->httpCode;
        if($this->httpCode!=200 && $this->httpCode!=301 && $this->httpCode!=302 && $this->httpCode!=303)
        {   
            {   
                
                $this->errors[] = "[".$page."]".GetMessage("parser_error_connect")."[".$this->httpCode."]";
                //if($this->agent || $this->settings["catalog"]["mode"]=="debug")
                {   
                    $this->SaveLog();
                    unset($this->errors);    
                }
                
                if($this->settings["catalog"]["404"]!="Y")
                {
                    if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
                    {
                        $this->stepStart = 1;
                        $this->SavePrevPage($page);
                        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
                            unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                        $this->DeleteCopyPage();
                        $this->activeCurrentPage++;
                        $this->SetCatalogElementsResult($this->activeCurrentPage);
                        $this->clearFields();
                        $this->ClearBufferStep();    
                    }
                    
                    return false;    
                }
            }
        }

        $this->currentPage++;
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")$this->SavePrevPage($page);
        //if($page==$this->rss)
        {
            $this->urlCatalog = $this->fileHtml->headerUrl;
            $this->urlSite = $this->getCatalogUrlSite();
        }
        
        return true;
    }
    
    protected function catalogSleep()
    {
        $sleep = $this->settings["catalog"]["sleep"];
        if($sleep)
        {
            sleep($sleep);
        }
    }
    
    protected function SavePrevPage($page)
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && $this->stepStart)
        {
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt", $page."|", FILE_APPEND);  
        }  
    }
    
    protected function SavePrevPageDetail($page)
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt", $page."|", FILE_APPEND);  
        }  
    }
    
    protected function SaveCurrentPage($arPage)
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && $this->stepStart)
        {    
            $page = implode("|", $arPage);
            if(!empty($arPage))file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt", $page."|"); 
            elseif($this->IsEndSectionUrl()) file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt", "");
            else file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt", "0");   
        }
            
    }
    
    protected function ClearAjaxFiles()
    {
        if(!$this->agent && $_GET["begin"])
        {
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt"); 
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt");  
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"); 
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt"); 
        }
           
    }

    protected function getCatalogUrlSite(){
        if(preg_match("/http:/", $this->rss))
        {
            $url = str_replace("http://", "", $this->rss);
            $url = preg_replace("/\/.*/", "", $url);
            $url = "http://".$url;
        }else{
            $url = preg_replace("/\/.*/", "", $url);
        }
        return $url;
    }

    protected function searchCatalogNavigation()
    {

    }

    protected function parseCatalogNavigation($pageHref)
    {   
        $this->html = phpQuery::newDocument($this->page, "text/html;charset=".LANG_CHARSET);
        
       
        if($this->settings["catalog"]["pagenavigation_selector"])
        {
            $this->deleteCatalogElement($this->settings["catalog"]["pagenavigation_delete"], $this->settings["catalog"]["pagenavigation_selector"]);
            $element = $this->settings["catalog"]["pagenavigation_selector"]." ".$this->settings["catalog"]["pagenavigation_one"];
            unset($this->pagenavigation[$pageHref]);
            unset($this->pagenavigation[$this->currentPage]);
            $this->pagenavigationPrev[$pageHref] = $pageHref;


            foreach($this->html[$element] as $page)
            {
                
                $p = pq($page)->attr("href");
                $p = $this->getCatalogLink($p);
                $p1 = $p."\\r\\n";
                if(!$p || empty($p)) continue; 
                $n = pq($page)->text();
                $n = $this->ValidatePageNavigation($n);
                if(isset($this->pagenavigationPrev[$p])) continue;
                
                if($this->IsNumberPageNavigation())
                {   
                    if(!$this->CheckValidatePageNavigation($n) && !$this->CheckPageNavigation($n)) continue;
                    
                    if(($this->currentPage+5)<$n)continue;
                    if($this->CheckPageNavigation($n))
                    {   
                        if(isset($this->pagenavigationPrev[$p])) continue;
                        if(isset($this->pagenavigationPrev[$n])) continue;
                        $this->pagenavigation[$n] = $p;
                    }elseif($this->CheckPageNavigationLess($n)){
                        if(isset($this->pagenavigationPrev[$p])) continue;
                        if(isset($this->pagenavigationPrev[$n])) continue;
                        $this->pagenavigation[$n] = $p;
                    } else{
                        
                    }
                }else{

                    $this->pagenavigation[$p] = $p;
                }

            }
            return true;
        } 
        return false;



    }

    protected function deleteCatalogElement($element, $parentElement=false, $dom=false)
    {
        if($parentElement)
        {
            $arElement = explode(",", $element);
            $parentElement = trim($parentElement);
            $element = "";
            foreach($arElement as $i=>$el)
            {
                $el = trim($el);
                if(empty($el)){
                    unset($arElement[$i]);
                    continue;
                }
                $element.=$parentElement." ".$el;
                if(($i+1)!=count($arElement))$element.=",";
            }
        }
        pq($element)->remove();
    }

    protected function deleteCatalogAttribute($element, $parentElement=false, $dom=false)
    {
        if($parentElement)
        {
            $arElement = explode(",", $element);
            $parentElement = trim($parentElement);
            $element = "";
            foreach($arElement as $i=>$el)
            {
                $el = trim($el);
                if(empty($el)){
                    unset($arElement[$i]);
                    continue;
                }

                preg_match('#\[[^\[]+$#', $el, $matches);
                $el = preg_replace('#\[[^\[]+$#','',$el);
                $attr = str_replace(array("[", "]"), "", $matches[0]);

                $element = $parentElement." ".$el;
                pq($element)->removeAttr($attr);
            }
        }

    }

    protected function getCatalogLink($url)
    {   
        $url = trim($url);
        if(empty($url)) return false;
        elseif(preg_match("/^\/{2}www/", $url))
        {
            $url = preg_replace("/^\/{2}www/", "www", $url);
        }
        elseif(preg_match('/^http:/', $url) || preg_match('/www\./', $url))
        {
            $url = $url;
        }elseif(preg_match("/^\//", $url))
        {
            $url = $this->urlSite.$url;
        }elseif(!preg_match("/^\//", $url) && preg_match("/\/{1}$/", $this->urlCatalog))
        {
            $url = $this->urlCatalog.$url;
        }
        elseif(!preg_match("/\?/", $url) && !preg_match("/^\//", $url) && !preg_match("/\/{1}$/", $this->urlCatalog))
        {
            //$site
            $uri = preg_replace('#/[^/]+$#','',$this->urlCatalog);
            $url = $uri."/".$url;
        }elseif(preg_match("/\?/", $url) && preg_match("/\?/", $this->urlCatalog))
        {
            $uri = preg_replace("/\?.+/", "", $this->urlCatalog);
            $url = $uri.$url;
        }

        return $url;
    }
    
    public function DeleteCharsetHtml5(&$data)
    {
        $data = preg_replace("/\s*<meta\s+charset=[\"|']{0,1}.+?[\"|']{0,1}\s*\/{0,1}\>/i", "", $data);
    }
    
    public function parserSelector(&$html, $selector, $nextSelector=0){
        global $shs_DOC_ENCODING;
        phpQuery::selectDocument($html);
        if($nextSelector==0 && $this->meta_description!="N")foreach($html['meta'] as $meta){
            if(strtolower(pq($meta)->attr("name"))=="description"){
                $this->meta_description_text = pq($meta)->attr("content");
                if(!$this->meta_description_text)$this->meta_description_text = pq($meta)->attr("value");
                if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) $this->meta_description_text = mb_convert_encoding($this->meta_description_text, LANG_CHARSET, "utf-8");
                if($this->meta_description_text)
                {
                    $this->meta_description_text = strip_tags($this->meta_description_text);
                    break;
                }

            }
        }
        if($nextSelector==0 && $this->meta_keywords!="N")foreach($html['meta'] as $meta){
            if(strtolower(pq($meta)->attr("name"))=="keywords"){
                $this->meta_keywords_text = pq($meta)->attr("content");
                if(!$this->meta_keywords_text)$this->meta_keywords_text = pq($meta)->attr("value");
                if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) $this->meta_keywords_text = mb_convert_encoding($this->meta_keywords_text, LANG_CHARSET, "utf-8");
                if($this->meta_keywords_text)
                {
                    $this->meta_keywords_text = strip_tags($this->meta_keywords_text);
                    break;
                }

            }
        }
        if($nextSelector==0 && $this->meta_title!="N")
        {
            $this->meta_title_text = pq($html['title'])->text();
            $this->meta_title_text = strip_tags($this->meta_title_text);
            //print_r(array(strtoupper(LANG_CHARSET), strtoupper($shs_DOC_ENCODING)));
            if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                //$this->meta_title_text = mb_convert_encoding($this->meta_title_text, LANG_CHARSET, $shs_DOC_ENCODING);
                $this->meta_title_text = mb_convert_encoding($this->meta_title_text, LANG_CHARSET, "utf-8");
                //print_r(array(strtoupper(LANG_CHARSET), strtoupper($shs_DOC_ENCODING)));
            }
        }


        if(empty($selector)) return $html->htmlOuter();
        else
        {
          $out = '<meta http-equiv="Content-Type" content="text/html;charset='.LANG_CHARSET.'">'.pq($selector)->html();
          //print $out;
          return $out;
        }


    }

    public function changeImgSrc($html){
        phpQuery::selectDocument($html);
        $site = $this->getUrlSite();
        foreach($html["img"] as $img){
          $src = $this->filterSrc(pq($img)->attr("src"));
          if(!preg_match('/^http:/', $img->getAttribute('src')) && !preg_match('/^www/', $img->getAttribute('src')) && !preg_match('/^\/{2}/', $img->getAttribute('src'))){
            if(preg_match("/^\/{1}/", $src))$src = $site.$src;
            else $src = $site."/".$src;
            $img->setAttribute('src', $src);
          }else{
            $img->setAttribute('src', $src);
          }
        }
        return $html;
    }

    public function parserFirstImg($html){
        phpQuery::selectDocument($html);
        $site = $this->getUrlSite();
        foreach($html["img"] as $img){
          $first_img = $this->filterSrc(pq($img)->attr("src"));
          if(!preg_match('/^http:/', $first_img) && !preg_match('/^www/', $first_img)){

            if(preg_match("/^\/{1}/", $first_img))$first_img = $site.$first_img;
            else $first_img = $site."/".$first_img;
            $arWidth = getimagesize($first_img);
            if($arWidth[0]<40) continue;
            return $first_img;
          }else{
            $arWidth = getimagesize($first_img);
            if($arWidth[0]<40) continue;
            return $first_img;
          }
        }
        return $first_img;
    }

    public function saveImgServer($html){
        foreach($html["img"] as $img){
            $arImg = CFile::MakeFileArray(pq($img)->attr("src"));
            $fid = CFile::SaveFile($arImg, "shs.parser");
            $img->setAttribute('src', CFile::GetPath($fid));
        }
        return $html->htmlOuter();
    }

    public function deleteElementStart(&$html, $selector_delete_element){
        phpQuery::selectDocument($html);
        $arElements = explode(',', $selector_delete_element);
        foreach($arElements as $selector){
          if(empty($selector)) continue;
          $selector = trim($selector);
          $html[$selector]->remove();
        }
        return $html;
    }

    public function deleteElements(&$html, $selector, $nextSelector=0){
        $arSelector = $this->arraySelector($selector);
        $n = 0;
        if(!isset($arSelector[$nextSelector])){
          $html->outertext = "";
          return;
        }
        if(strpos($arSelector[$nextSelector], '[')!==false && preg_match("/\[[0-9]{1,3}\]/", $arSelector[$nextSelector])){
            $sel = $arSelector[$nextSelector];
            $arSelector[$nextSelector] = preg_replace('/\[[0-9]{1,3}\]/', '', $sel);
            preg_match_all('/\[[0-9]{1,3}\]/', $sel, $matches);
            $n = str_replace(array('[', ']'), "", $matches[0][0]);
            $item = $html->find($arSelector[$nextSelector], $n);
            if(gettype($item)=="NULL"){
                return false;
            }
            $data = $this->deleteElements($item, $selector, $nextSelector+1);

        }else{
            foreach($html->find($arSelector[$nextSelector]) as $item){
                $data = $this->deleteElements($item, $selector, $nextSelector+1);
            }
        }

    }

    public function deleteAttributeStart(&$html, $selector_delete_attribute){

        $arElements = explode(',', $selector_delete_attribute);

        foreach($arElements as $selector){
          if(empty($selector)) continue;
          preg_match('/\[[a-zA-Z]+\]$/', $selector, $attribute);
          $attributes = str_replace(array(']', '['), "", $attribute[0]);
          $selector = preg_replace('/\[[a-zA-Z]+\]$/', "", trim($selector));
          $this->deleteAttributes($html, trim($selector), $attributes);
        }
        return $html;
    }

    public function deleteAttributes(&$html, $selector, $attribute, $nextSelector=0){
        phpQuery::selectDocument($html);
        pq($selector)->removeAttr($attribute);
    }

    public function getContentsArray($site='', $port=80, $path='', $query=''){
        if(!$this->type || $this->type=="rss")
        {   
            $arContent = CIBlockRSS::GetNewsEx($site, $port, $path, $query);
            
            return CIBlockRSS::FormatArray($arContent);
        }elseif($this->type=="page")
        {
            $url = $site.$path;
            if($query)$url = $url."?".$query;
            $fileHtml = new FileGetHtml();
            $data = $fileHtml->file_get_html($url, $this->proxy, $this->auth);
            $this->header_url = $url = $fileHtml->headerUrl;
            $this->DeleteCharsetHtml5($data);
            $html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET);
            $dom = htmlspecialcharsBack(trim($this->settings["page"]["selector"]));
            $href = htmlspecialcharsBack(trim($this->settings["page"]["href"]));
            $name = htmlspecialcharsBack(trim($this->settings["page"]["name"]));
            $href = $href?$href:"a:eq(0)";
            $name = $name?$name:$href;

            $i = 0;
            $site = $this->getUrlSite();
            foreach($html[$dom] as $val)
            {
                $strName =  strip_tags(pq($val)->find($name)->html());
                //$strHref =  mb_strtolower(pq($val)->find($href)->attr("href"));
                $strHref =  pq($val)->find($href)->attr("href");


                if(!preg_match('/^http:/', $strHref) && !preg_match('/^www/', $strHref) && !preg_match('/^\/{2}/', $strHref))
                {
                    if(preg_match('/^\//', $strHref))$strHref = $site.$strHref;
                    else $strHref = $site.$path.$strHref;
                }

                if(empty($strName)) $this->errors[] = GetMessage("parser_error_noname");
                if(empty($strHref)) $this->errors[] = GetMessage("parser_error_nohref");
                if(empty($strName) || empty($strHref)) continue;
                $arContent["item"][$i]["title"] = $strName;
                $arContent["item"][$i]["link"] = $strHref;
                $arContent["item"][$i]["description"] = pq($val)->html();
                $i++;
            }
            if($i>0)
            {   
                $arContent['title'] = $site;
                $arContent['link'] = $site;
                return  $arContent;
            }
        }
    }

    public function getUrlSite(){
        $this->header_url = strtolower($this->header_url);
        $site = str_replace(array('http://', 'www.', "HTTP://", "WWW."), "", $this->header_url);
        $site = preg_replace('/\/(.)+/', '', $site);
        $arLevel = explode(".", $site);
        if(count($arLevel)==2) return 'http://www.'.$site;
        else return 'http://'.$site;
    }

    public function filterSrc($src){
        $src = preg_replace('/#.+/', '', $src);
        $src = preg_replace('/\?.+/', '', $src);
        //$src = str_replace('http:/', 'http://', $src);
        $src = str_replace('//', '/', $src);
        $src = str_replace('http:/', 'http://', $src);
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src))$src = preg_replace("/^\/{2}/", "http://", $src);
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src))$src = preg_replace("/^\/{1}/", "http://", $src);
        //$src = str_replace('//', '/', $src);
        return $src;
    }

    public function parseImgFromRss($arItem){
        foreach($arItem as $item){
            if(is_array($item)) $preview = $this->parseImgFromRss($item);
            elseif(preg_match("/^(http:)(.)+(jpg|JPG|gif|GIF|png|PNG|JPEG|jpeg)$/", $item, $match)){
              $preview = $match[0];
              break;
            }
        }
        return $preview;
    }

    public function arraySelector($selector, $debug=0){
        $bool = false;
        $selector = trim($selector);
        $arSel = explode(' ', $selector);
        $newArSel = array();
        $selStr = "";
        foreach($arSel as $i=>$val){
          if(preg_match('/\[/', $val) && preg_match('/\]/', $val) && !$bool) $newArSel[] = $val;
          elseif(!preg_match('/\[/', $val) && !preg_match('/\]/', $val) && !$bool) $newArSel[] = $val;
          elseif(preg_match('/\[/', $val) && !preg_match('/\]/', $val)){
            $bool = true;
            $selStr .= $val;
          }elseif(!preg_match('/\[/', $val) && !preg_match('/\]/', $val) && $bool){
            $selStr .= " ".$val;
          }elseif(preg_match('/\]/', $val) && $bool){
            $selStr .= " ".$val;
            $bool = false;
            $newArSel[] = $selStr;
            $selStr = "";
          }
        }
        return $newArSel;
    }
}
?>72   96423|/shs.parser/classes/general/sotbit_idna_convert.class.php|57123488<?php
// {{{ license

/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4 foldmethod=marker: */
//
// +----------------------------------------------------------------------+
// | This library is free software; you can redistribute it and/or modify |
// | it under the terms of the GNU Lesser General Public License as       |
// | published by the Free Software Foundation; either version 2.1 of the |
// | License, or (at your option) any later version.                      |
// |                                                                      |
// | This library is distributed in the hope that it will be useful, but  |
// | WITHOUT ANY WARRANTY; without even the implied warranty of           |
// | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    |
// | Lesser General Public License for more details.                      |
// |                                                                      |
// | You should have received a copy of the GNU Lesser General Public     |
// | License along with this library; if not, write to the Free Software  |
// | Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 |
// | USA.                                                                 |
// +----------------------------------------------------------------------+
//

// }}}

/**
 * Encode/decode Internationalized Domain Names.
 *
 * The class allows to convert internationalized domain names
 * (see RFC 3490 for details) as they can be used with various registries worldwide
 * to be translated between their original (localized) form and their encoded form
 * as it will be used in the DNS (Domain Name System).
 *
 * The class provides two public methods, encode() and decode(), which do exactly
 * what you would expect them to do. You are allowed to use complete domain names,
 * simple strings and complete email addresses as well. That means, that you might
 * use any of the following notations:
 *
 * - www.nrgler.com
 * - xn--nrgler-wxa
 * - xn--brse-5qa.xn--knrz-1ra.info
 *
 * Unicode input might be given as either UTF-8 string, UCS-4 string or UCS-4 array.
 * Unicode output is available in the same formats.
 * You can select your preferred format via {@link set_paramter()}.
 *
 * ACE input and output is always expected to be ASCII.
 *
 * @author  Matthias Sommerfeld <mso@phlylabs.de>
 * @copyright 2004-2011 phlyLabs Berlin, http://phlylabs.de
 * @version 0.8.1 2011-12-19
 */
class sotbit_idna_convert
{
    // NP See below

    // Internal settings, do not mess with them
    protected $_punycode_prefix = 'xn--';
    protected $_invalid_ucs = 0x80000000;
    protected $_max_ucs = 0x10FFFF;
    protected $_base = 36;
    protected $_tmin = 1;
    protected $_tmax = 26;
    protected $_skew = 38;
    protected $_damp = 700;
    protected $_initial_bias = 72;
    protected $_initial_n = 0x80;
    protected $_sbase = 0xAC00;
    protected $_lbase = 0x1100;
    protected $_vbase = 0x1161;
    protected $_tbase = 0x11A7;
    protected $_lcount = 19;
    protected $_vcount = 21;
    protected $_tcount = 28;
    protected $_ncount = 588;   // _vcount * _tcount
    protected $_scount = 11172; // _lcount * _tcount * _vcount
    protected $_error = false;

    protected static $_mb_string_overload = null;

    // See {@link set_paramter()} for details of how to change the following
    // settings from within your script / application
    protected $_api_encoding = 'utf8';   // Default input charset is UTF-8
    protected $_allow_overlong = false;  // Overlong UTF-8 encodings are forbidden
    protected $_strict_mode = false;     // Behave strict or not
    protected $_idn_version = 2003;      // Can be either 2003 (old, default) or 2008

    /**
     * the constructor
     *
     * @param array $options
     * @return boolean
     * @since 0.5.2
     */
    public function __construct($options = false)
    {
        $this->slast = $this->_sbase + $this->_lcount * $this->_vcount * $this->_tcount;
        // If parameters are given, pass these to the respective method
        if (is_array($options)) {
            $this->set_parameter($options);
        }

        // populate mbstring overloading cache if not set
        if (self::$_mb_string_overload === null) {
            self::$_mb_string_overload = (extension_loaded('mbstring')
                && (ini_get('mbstring.func_overload') & 0x02) === 0x02);
        }
    }

    /**
     * Sets a new option value. Available options and values:
     * [encoding - Use either UTF-8, UCS4 as array or UCS4 as string as input ('utf8' for UTF-8,
     *         'ucs4_string' and 'ucs4_array' respectively for UCS4); The output is always UTF-8]
     * [overlong - Unicode does not allow unnecessarily long encodings of chars,
     *             to allow this, set this parameter to true, else to false;
     *             default is false.]
     * [strict - true: strict mode, good for registration purposes - Causes errors
     *           on failures; false: loose mode, ideal for "wildlife" applications
     *           by silently ignoring errors and returning the original input instead
     *
     * @param    mixed     Parameter to set (string: single parameter; array of Parameter => Value pairs)
     * @param    string    Value to use (if parameter 1 is a string)
     * @return   boolean   true on success, false otherwise
     */
    public function set_parameter($option, $value = false)
    {
        if (!is_array($option)) {
            $option = array($option => $value);
        }
        foreach ($option as $k => $v) {
            switch ($k) {
            case 'encoding':
                switch ($v) {
                case 'utf8':
                case 'ucs4_string':
                case 'ucs4_array':
                    $this->_api_encoding = $v;
                    break;
                default:
                    $this->_error('Set Parameter: Unknown parameter '.$v.' for option '.$k);
                    return false;
                }
                break;
            case 'overlong':
                $this->_allow_overlong = ($v) ? true : false;
                break;
            case 'strict':
                $this->_strict_mode = ($v) ? true : false;
                break;
            case 'idn_version':
                if (in_array($v, array('2003', '2008'))) {
                    $this->_idn_version = $v;
                } else {
                    $this->_error('Set Parameter: Unknown parameter '.$v.' for option '.$k);
                }
                break;
            case 'encode_german_sz': // Deprecated
                if (!$v) {
                    self::$NP['replacemaps'][0xDF] = array(0x73, 0x73);
                } else {
                    unset(self::$NP['replacemaps'][0xDF]);
                }
                break;
            default:
                $this->_error('Set Parameter: Unknown option '.$k);
                return false;
            }
        }
        return true;
    }

    /**
     * Decode a given ACE domain name
     * @param    string   Domain name (ACE string)
     * [@param    string   Desired output encoding, see {@link set_parameter}]
     * @return   string   Decoded Domain name (UTF-8 or UCS-4)
     */
    public function decode($input, $one_time_encoding = false)
    {
        // Optionally set
        if ($one_time_encoding) {
            switch ($one_time_encoding) {
            case 'utf8':
            case 'ucs4_string':
            case 'ucs4_array':
                break;
            default:
                $this->_error('Unknown encoding '.$one_time_encoding);
                return false;
            }
        }
        // Make sure to drop any newline characters around
        $input = trim($input);

        // Negotiate input and try to determine, whether it is a plain string,
        // an email address or something like a complete URL
        if (strpos($input, '@')) { // Maybe it is an email address
            // No no in strict mode
            if ($this->_strict_mode) {
                $this->_error('Only simple domain name parts can be handled in strict mode');
                return false;
            }
            list ($email_pref, $input) = explode('@', $input, 2);
            $arr = explode('.', $input);
            foreach ($arr as $k => $v) {
                if (preg_match('!^'.preg_quote($this->_punycode_prefix, '!').'!', $v)) {
                    $conv = $this->_decode($v);
                    if ($conv) $arr[$k] = $conv;
                }
            }
            $input = join('.', $arr);
            $arr = explode('.', $email_pref);
            foreach ($arr as $k => $v) {
                if (preg_match('!^'.preg_quote($this->_punycode_prefix, '!').'!', $v)) {
                    $conv = $this->_decode($v);
                    if ($conv) $arr[$k] = $conv;
                }
            }
            $email_pref = join('.', $arr);
            $return = $email_pref . '@' . $input;
        } elseif (preg_match('![:\./]!', $input)) { // Or a complete domain name (with or without paths / parameters)
            // No no in strict mode
            if ($this->_strict_mode) {
                $this->_error('Only simple domain name parts can be handled in strict mode');
                return false;
            }
            $parsed = parse_url($input);
            if (isset($parsed['host'])) {
                $arr = explode('.', $parsed['host']);
                foreach ($arr as $k => $v) {
                    $conv = $this->_decode($v);
                    if ($conv) $arr[$k] = $conv;
                }
                $parsed['host'] = join('.', $arr);
                $return =
                        (empty($parsed['scheme']) ? '' : $parsed['scheme'].(strtolower($parsed['scheme']) == 'mailto' ? ':' : '://'))
                        .(empty($parsed['user']) ? '' : $parsed['user'].(empty($parsed['pass']) ? '' : ':'.$parsed['pass']).'@')
                        .$parsed['host']
                        .(empty($parsed['port']) ? '' : ':'.$parsed['port'])
                        .(empty($parsed['path']) ? '' : $parsed['path'])
                        .(empty($parsed['query']) ? '' : '?'.$parsed['query'])
                        .(empty($parsed['fragment']) ? '' : '#'.$parsed['fragment']);
            } else { // parse_url seems to have failed, try without it
                $arr = explode('.', $input);
                foreach ($arr as $k => $v) {
                    $conv = $this->_decode($v);
                    $arr[$k] = ($conv) ? $conv : $v;
                }
                $return = join('.', $arr);
            }
        } else { // Otherwise we consider it being a pure domain name string
            $return = $this->_decode($input);
            if (!$return) $return = $input;
        }
        // The output is UTF-8 by default, other output formats need conversion here
        // If one time encoding is given, use this, else the objects property
        switch (($one_time_encoding) ? $one_time_encoding : $this->_api_encoding) {
        case 'utf8':
            return $return;
            break;
        case 'ucs4_string':
           return $this->_ucs4_to_ucs4_string($this->_utf8_to_ucs4($return));
           break;
        case 'ucs4_array':
            return $this->_utf8_to_ucs4($return);
            break;
        default:
            $this->_error('Unsupported output format');
            return false;
        }
    }

    /**
     * Encode a given UTF-8 domain name
     * @param    string   Domain name (UTF-8 or UCS-4)
     * [@param    string   Desired input encoding, see {@link set_parameter}]
     * @return   string   Encoded Domain name (ACE string)
     */
    public function encode($decoded, $one_time_encoding = false)
    {
        // Forcing conversion of input to UCS4 array
        // If one time encoding is given, use this, else the objects property
        switch ($one_time_encoding ? $one_time_encoding : $this->_api_encoding) {
        case 'utf8':
            $decoded = $this->_utf8_to_ucs4($decoded);
            break;
        case 'ucs4_string':
           $decoded = $this->_ucs4_string_to_ucs4($decoded);
        case 'ucs4_array':
           break;
        default:
            $this->_error('Unsupported input format: '.($one_time_encoding ? $one_time_encoding : $this->_api_encoding));
            return false;
        }

        // No input, no output, what else did you expect?
        if (empty($decoded)) return '';

        // Anchors for iteration
        $last_begin = 0;
        // Output string
        $output = '';
        foreach ($decoded as $k => $v) {
            // Make sure to use just the plain dot
            switch($v) {
            case 0x3002:
            case 0xFF0E:
            case 0xFF61:
                $decoded[$k] = 0x2E;
                // Right, no break here, the above are converted to dots anyway
            // Stumbling across an anchoring character
            case 0x2E:
            case 0x2F:
            case 0x3A:
            case 0x3F:
            case 0x40:
                // Neither email addresses nor URLs allowed in strict mode
                if ($this->_strict_mode) {
                   $this->_error('Neither email addresses nor URLs are allowed in strict mode.');
                   return false;
                } else {
                    // Skip first char
                    if ($k) {
                        $encoded = '';
                        $encoded = $this->_encode(array_slice($decoded, $last_begin, (($k)-$last_begin)));
                        if ($encoded) {
                            $output .= $encoded;
                        } else {
                            $output .= $this->_ucs4_to_utf8(array_slice($decoded, $last_begin, (($k)-$last_begin)));
                        }
                        $output .= chr($decoded[$k]);
                    }
                    $last_begin = $k + 1;
                }
            }
        }
        // Catch the rest of the string
        if ($last_begin) {
            $inp_len = sizeof($decoded);
            $encoded = '';
            $encoded = $this->_encode(array_slice($decoded, $last_begin, (($inp_len)-$last_begin)));
            if ($encoded) {
                $output .= $encoded;
            } else {
                $output .= $this->_ucs4_to_utf8(array_slice($decoded, $last_begin, (($inp_len)-$last_begin)));
            }
            return $output;
        } else {
            if ($output = $this->_encode($decoded)) {
                return $output;
            } else {
                return $this->_ucs4_to_utf8($decoded);
            }
        }
    }

    /**
     * Removes a weakness of encode(), which cannot properly handle URIs but instead encodes their
     * path or query components, too.
     * @param string  $uri  Expects the URI as a UTF-8 (or ASCII) string
     * @return  string  The URI encoded to Punycode, everything but the host component is left alone
     * @since 0.6.4
     */
    public function encode_uri($uri)
    {
        $parsed = parse_url($uri);
        if (!isset($parsed['host'])) {
            $this->_error('The given string does not look like a URI');
            return false;
        }
        $arr = explode('.', $parsed['host']);
        foreach ($arr as $k => $v) {
            $conv = $this->encode($v, 'utf8');
            if ($conv) $arr[$k] = $conv;
        }
        $parsed['host'] = join('.', $arr);
        $return =
                (empty($parsed['scheme']) ? '' : $parsed['scheme'].(strtolower($parsed['scheme']) == 'mailto' ? ':' : '://'))
                .(empty($parsed['user']) ? '' : $parsed['user'].(empty($parsed['pass']) ? '' : ':'.$parsed['pass']).'@')
                .$parsed['host']
                .(empty($parsed['port']) ? '' : ':'.$parsed['port'])
                .(empty($parsed['path']) ? '' : $parsed['path'])
                .(empty($parsed['query']) ? '' : '?'.$parsed['query'])
                .(empty($parsed['fragment']) ? '' : '#'.$parsed['fragment']);
        return $return;
    }

    /**
     * Use this method to get the last error ocurred
     * @param    void
     * @return   string   The last error, that occured
     */
    public function get_last_error()
    {
        return $this->_error;
    }

    /**
     * The actual decoding algorithm
     * @param string
     * @return mixed
     */
    protected function _decode($encoded)
    {
        $decoded = array();
        // find the Punycode prefix
        if (!preg_match('!^'.preg_quote($this->_punycode_prefix, '!').'!', $encoded)) {
            $this->_error('This is not a punycode string');
            return false;
        }
        $encode_test = preg_replace('!^'.preg_quote($this->_punycode_prefix, '!').'!', '', $encoded);
        // If nothing left after removing the prefix, it is hopeless
        if (!$encode_test) {
            $this->_error('The given encoded string was empty');
            return false;
        }
        // Find last occurence of the delimiter
        $delim_pos = strrpos($encoded, '-');
        if ($delim_pos > self::byteLength($this->_punycode_prefix)) {
            for ($k = self::byteLength($this->_punycode_prefix); $k < $delim_pos; ++$k) {
                $decoded[] = ord($encoded{$k});
            }
        }
        $deco_len = count($decoded);
        $enco_len = self::byteLength($encoded);

        // Wandering through the strings; init
        $is_first = true;
        $bias = $this->_initial_bias;
        $idx = 0;
        $char = $this->_initial_n;

        for ($enco_idx = ($delim_pos) ? ($delim_pos + 1) : 0; $enco_idx < $enco_len; ++$deco_len) {
            for ($old_idx = $idx, $w = 1, $k = $this->_base; 1 ; $k += $this->_base) {
                $digit = $this->_decode_digit($encoded{$enco_idx++});
                $idx += $digit * $w;
                $t = ($k <= $bias) ? $this->_tmin :
                        (($k >= $bias + $this->_tmax) ? $this->_tmax : ($k - $bias));
                if ($digit < $t) break;
                $w = (int) ($w * ($this->_base - $t));
            }
            $bias = $this->_adapt($idx - $old_idx, $deco_len + 1, $is_first);
            $is_first = false;
            $char += (int) ($idx / ($deco_len + 1));
            $idx %= ($deco_len + 1);
            if ($deco_len > 0) {
                // Make room for the decoded char
                for ($i = $deco_len; $i > $idx; $i--) $decoded[$i] = $decoded[($i - 1)];
            }
            $decoded[$idx++] = $char;
        }
        return $this->_ucs4_to_utf8($decoded);
    }

    /**
     * The actual encoding algorithm
     * @param  string
     * @return mixed
     */
    protected function _encode($decoded)
    {
        // We cannot encode a domain name containing the Punycode prefix
        $extract = self::byteLength($this->_punycode_prefix);
        $check_pref = $this->_utf8_to_ucs4($this->_punycode_prefix);
        $check_deco = array_slice($decoded, 0, $extract);

        if ($check_pref == $check_deco) {
            $this->_error('This is already a punycode string');
            return false;
        }
        // We will not try to encode strings consisting of basic code points only
        $encodable = false;
        foreach ($decoded as $k => $v) {
            if ($v > 0x7a) {
                $encodable = true;
                break;
            }
        }
        if (!$encodable) {
            $this->_error('The given string does not contain encodable chars');
            return false;
        }
        // Do NAMEPREP
        $decoded = $this->_nameprep($decoded);
        if (!$decoded || !is_array($decoded)) return false; // NAMEPREP failed
        $deco_len  = count($decoded);
        if (!$deco_len) return false; // Empty array
        $codecount = 0; // How many chars have been consumed
        $encoded = '';
        // Copy all basic code points to output
        for ($i = 0; $i < $deco_len; ++$i) {
            $test = $decoded[$i];
            // Will match [-0-9a-zA-Z]
            if ((0x2F < $test && $test < 0x40) || (0x40 < $test && $test < 0x5B)
                    || (0x60 < $test && $test <= 0x7B) || (0x2D == $test)) {
                $encoded .= chr($decoded[$i]);
                $codecount++;
            }
        }
        if ($codecount == $deco_len) return $encoded; // All codepoints were basic ones

        // Start with the prefix; copy it to output
        $encoded = $this->_punycode_prefix.$encoded;
        // If we have basic code points in output, add an hyphen to the end
        if ($codecount) $encoded .= '-';
        // Now find and encode all non-basic code points
        $is_first = true;
        $cur_code = $this->_initial_n;
        $bias = $this->_initial_bias;
        $delta = 0;
        while ($codecount < $deco_len) {
            // Find the smallest code point >= the current code point and
            // remember the last ouccrence of it in the input
            for ($i = 0, $next_code = $this->_max_ucs; $i < $deco_len; $i++) {
                if ($decoded[$i] >= $cur_code && $decoded[$i] <= $next_code) {
                    $next_code = $decoded[$i];
                }
            }
            $delta += ($next_code - $cur_code) * ($codecount + 1);
            $cur_code = $next_code;

            // Scan input again and encode all characters whose code point is $cur_code
            for ($i = 0; $i < $deco_len; $i++) {
                if ($decoded[$i] < $cur_code) {
                    $delta++;
                } elseif ($decoded[$i] == $cur_code) {
                    for ($q = $delta, $k = $this->_base; 1; $k += $this->_base) {
                        $t = ($k <= $bias) ? $this->_tmin :
                                (($k >= $bias + $this->_tmax) ? $this->_tmax : $k - $bias);
                        if ($q < $t) break;
                        $encoded .= $this->_encode_digit(intval($t + (($q - $t) % ($this->_base - $t)))); //v0.4.5 Changed from ceil() to intval()
                        $q = (int) (($q - $t) / ($this->_base - $t));
                    }
                    $encoded .= $this->_encode_digit($q);
                    $bias = $this->_adapt($delta, $codecount+1, $is_first);
                    $codecount++;
                    $delta = 0;
                    $is_first = false;
                }
            }
            $delta++;
            $cur_code++;
        }
        return $encoded;
    }

    /**
     * Adapt the bias according to the current code point and position
     * @param int $delta
     * @param int $npoints
     * @param int $is_first
     * @return int
     */
    protected function _adapt($delta, $npoints, $is_first)
    {
        $delta = intval($is_first ? ($delta / $this->_damp) : ($delta / 2));
        $delta += intval($delta / $npoints);
        for ($k = 0; $delta > (($this->_base - $this->_tmin) * $this->_tmax) / 2; $k += $this->_base) {
            $delta = intval($delta / ($this->_base - $this->_tmin));
        }
        return intval($k + ($this->_base - $this->_tmin + 1) * $delta / ($delta + $this->_skew));
    }

    /**
     * Encoding a certain digit
     * @param    int $d
     * @return string
     */
    protected function _encode_digit($d)
    {
        return chr($d + 22 + 75 * ($d < 26));
    }

    /**
     * Decode a certain digit
     * @param    int $cp
     * @return int
     */
    protected function _decode_digit($cp)
    {
        $cp = ord($cp);
        return ($cp - 48 < 10) ? $cp - 22 : (($cp - 65 < 26) ? $cp - 65 : (($cp - 97 < 26) ? $cp - 97 : $this->_base));
    }

    /**
     * Internal error handling method
     * @param  string $error
     */
    protected function _error($error = '')
    {
        $this->_error = $error;
    }

    /**
     * Do Nameprep according to RFC3491 and RFC3454
     * @param    array    Unicode Characters
     * @return   string   Unicode Characters, Nameprep'd
     */
    protected function _nameprep($input)
    {
        $output = array();
        $error = false;
        //
        // Mapping
        // Walking through the input array, performing the required steps on each of
        // the input chars and putting the result into the output array
        // While mapping required chars we apply the cannonical ordering
        foreach ($input as $v) {
            // Map to nothing == skip that code point
            if (in_array($v, self::$NP['map_nothing'])) continue;
            // Try to find prohibited input
            if (in_array($v, self::$NP['prohibit']) || in_array($v, self::$NP['general_prohibited'])) {
                $this->_error('NAMEPREP: Prohibited input U+'.sprintf('%08X', $v));
                return false;
            }
            foreach (self::$NP['prohibit_ranges'] as $range) {
                if ($range[0] <= $v && $v <= $range[1]) {
                    $this->_error('NAMEPREP: Prohibited input U+'.sprintf('%08X', $v));
                    return false;
                }
            }

            if (0xAC00 <= $v && $v <= 0xD7AF) {
                // Hangul syllable decomposition
                foreach ($this->_hangul_decompose($v) as $out) {
                    $output[] = (int) $out;
                }
            } elseif (($this->_idn_version == '2003') && isset(self::$NP['replacemaps'][$v])) {
                // There's a decomposition mapping for that code point
                // Decompositions only in version 2003 (original) of IDNA
                foreach ($this->_apply_cannonical_ordering(self::$NP['replacemaps'][$v]) as $out) {
                    $output[] = (int) $out;
                }
            } else {
                $output[] = (int) $v;
            }
        }
        // Before applying any Combining, try to rearrange any Hangul syllables
        $output = $this->_hangul_compose($output);
        //
        // Combine code points
        //
        $last_class = 0;
        $last_starter = 0;
        $out_len = count($output);
        for ($i = 0; $i < $out_len; ++$i) {
            $class = $this->_get_combining_class($output[$i]);
            if ((!$last_class || $last_class > $class) && $class) {
                // Try to match
                $seq_len = $i - $last_starter;
                $out = $this->_combine(array_slice($output, $last_starter, $seq_len));
                // On match: Replace the last starter with the composed character and remove
                // the now redundant non-starter(s)
                if ($out) {
                    $output[$last_starter] = $out;
                    if (count($out) != $seq_len) {
                        for ($j = $i+1; $j < $out_len; ++$j) $output[$j-1] = $output[$j];
                        unset($output[$out_len]);
                    }
                    // Rewind the for loop by one, since there can be more possible compositions
                    $i--;
                    $out_len--;
                    $last_class = ($i == $last_starter) ? 0 : $this->_get_combining_class($output[$i-1]);
                    continue;
                }
            }
            // The current class is 0
            if (!$class) $last_starter = $i;
            $last_class = $class;
        }
        return $output;
    }

    /**
     * Decomposes a Hangul syllable
     * (see http://www.unicode.org/unicode/reports/tr15/#Hangul
     * @param    integer  32bit UCS4 code point
     * @return   array    Either Hangul Syllable decomposed or original 32bit value as one value array
     */
    protected function _hangul_decompose($char)
    {
        $sindex = (int) $char - $this->_sbase;
        if ($sindex < 0 || $sindex >= $this->_scount) return array($char);
        $result = array();
        $result[] = (int) $this->_lbase + $sindex / $this->_ncount;
        $result[] = (int) $this->_vbase + ($sindex % $this->_ncount) / $this->_tcount;
        $T = intval($this->_tbase + $sindex % $this->_tcount);
        if ($T != $this->_tbase) $result[] = $T;
        return $result;
    }
    /**
     * Ccomposes a Hangul syllable
     * (see http://www.unicode.org/unicode/reports/tr15/#Hangul
     * @param    array    Decomposed UCS4 sequence
     * @return   array    UCS4 sequence with syllables composed
     */
    protected function _hangul_compose($input)
    {
        $inp_len = count($input);
        if (!$inp_len) return array();
        $result = array();
        $last = (int) $input[0];
        $result[] = $last; // copy first char from input to output

        for ($i = 1; $i < $inp_len; ++$i) {
            $char = (int) $input[$i];
            $sindex = $last - $this->_sbase;
            $lindex = $last - $this->_lbase;
            $vindex = $char - $this->_vbase;
            $tindex = $char - $this->_tbase;
            // Find out, whether two current characters are LV and T
            if (0 <= $sindex && $sindex < $this->_scount && ($sindex % $this->_tcount == 0)
                    && 0 <= $tindex && $tindex <= $this->_tcount) {
                // create syllable of form LVT
                $last += $tindex;
                $result[(count($result) - 1)] = $last; // reset last
                continue; // discard char
            }
            // Find out, whether two current characters form L and V
            if (0 <= $lindex && $lindex < $this->_lcount && 0 <= $vindex && $vindex < $this->_vcount) {
                // create syllable of form LV
                $last = (int) $this->_sbase + ($lindex * $this->_vcount + $vindex) * $this->_tcount;
                $result[(count($result) - 1)] = $last; // reset last
                continue; // discard char
            }
            // if neither case was true, just add the character
            $last = $char;
            $result[] = $char;
        }
        return $result;
    }

    /**
     * Returns the combining class of a certain wide char
     * @param    integer    Wide char to check (32bit integer)
     * @return   integer    Combining class if found, else 0
     */
    protected function _get_combining_class($char)
    {
        return isset(self::$NP['norm_combcls'][$char]) ? self::$NP['norm_combcls'][$char] : 0;
    }

    /**
     * Applies the cannonical ordering of a decomposed UCS4 sequence
     * @param    array      Decomposed UCS4 sequence
     * @return   array      Ordered USC4 sequence
     */
    protected function _apply_cannonical_ordering($input)
    {
        $swap = true;
        $size = count($input);
        while ($swap) {
            $swap = false;
            $last = $this->_get_combining_class(intval($input[0]));
            for ($i = 0; $i < $size-1; ++$i) {
                $next = $this->_get_combining_class(intval($input[$i+1]));
                if ($next != 0 && $last > $next) {
                    // Move item leftward until it fits
                    for ($j = $i + 1; $j > 0; --$j) {
                        if ($this->_get_combining_class(intval($input[$j-1])) <= $next) break;
                        $t = intval($input[$j]);
                        $input[$j] = intval($input[$j-1]);
                        $input[$j-1] = $t;
                        $swap = true;
                    }
                    // Reentering the loop looking at the old character again
                    $next = $last;
                }
                $last = $next;
            }
        }
        return $input;
    }

    /**
     * Do composition of a sequence of starter and non-starter
     * @param    array      UCS4 Decomposed sequence
     * @return   array      Ordered USC4 sequence
     */
    protected function _combine($input)
    {
        $inp_len = count($input);
        if (0 == $inp_len) {
            return false;
        }
        foreach (self::$NP['replacemaps'] as $np_src => $np_target) {
            if ($np_target[0] != $input[0]) continue;
            if (count($np_target) != $inp_len) continue;
            $hit = false;
            foreach ($input as $k2 => $v2) {
                if ($v2 == $np_target[$k2]) {
                    $hit = true;
                } else {
                    $hit = false;
                    break;
                }
            }
            if ($hit) return $np_src;
        }
        return false;
    }

    /**
     * This converts an UTF-8 encoded string to its UCS-4 representation
     * By talking about UCS-4 "strings" we mean arrays of 32bit integers representing
     * each of the "chars". This is due to PHP not being able to handle strings with
     * bit depth different from 8. This apllies to the reverse method _ucs4_to_utf8(), too.
     * The following UTF-8 encodings are supported:
     * bytes bits  representation
     * 1        7  0xxxxxxx
     * 2       11  110xxxxx 10xxxxxx
     * 3       16  1110xxxx 10xxxxxx 10xxxxxx
     * 4       21  11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
     * 5       26  111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx
     * 6       31  1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx
     * Each x represents a bit that can be used to store character data.
     * The five and six byte sequences are part of Annex D of ISO/IEC 10646-1:2000
     * @param string $input
     * @return string
     */
    protected function _utf8_to_ucs4($input)
    {
        $output = array();
        $out_len = 0;
        $inp_len = self::byteLength($input);
        $mode = 'next';
        $test = 'none';
        for ($k = 0; $k < $inp_len; ++$k) {
            $v = ord($input{$k}); // Extract byte from input string
            if ($v < 128) { // We found an ASCII char - put into stirng as is
                $output[$out_len] = $v;
                ++$out_len;
                if ('add' == $mode) {
                    $this->_error('Conversion from UTF-8 to UCS-4 failed: malformed input at byte '.$k);
                    return false;
                }
                continue;
            }
            if ('next' == $mode) { // Try to find the next start byte; determine the width of the Unicode char
                $start_byte = $v;
                $mode = 'add';
                $test = 'range';
                if ($v >> 5 == 6) { // &110xxxxx 10xxxxx
                    $next_byte = 0; // Tells, how many times subsequent bitmasks must rotate 6bits to the left
                    $v = ($v - 192) << 6;
                } elseif ($v >> 4 == 14) { // &1110xxxx 10xxxxxx 10xxxxxx
                    $next_byte = 1;
                    $v = ($v - 224) << 12;
                } elseif ($v >> 3 == 30) { // &11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
                    $next_byte = 2;
                    $v = ($v - 240) << 18;
                } elseif ($v >> 2 == 62) { // &111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx
                    $next_byte = 3;
                    $v = ($v - 248) << 24;
                } elseif ($v >> 1 == 126) { // &1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx
                    $next_byte = 4;
                    $v = ($v - 252) << 30;
                } else {
                    $this->_error('This might be UTF-8, but I don\'t understand it at byte '.$k);
                    return false;
                }
                if ('add' == $mode) {
                    $output[$out_len] = (int) $v;
                    ++$out_len;
                    continue;
                }
            }
            if ('add' == $mode) {
                if (!$this->_allow_overlong && $test == 'range') {
                    $test = 'none';
                    if (($v < 0xA0 && $start_byte == 0xE0) || ($v < 0x90 && $start_byte == 0xF0) || ($v > 0x8F && $start_byte == 0xF4)) {
                        $this->_error('Bogus UTF-8 character detected (out of legal range) at byte '.$k);
                        return false;
                    }
                }
                if ($v >> 6 == 2) { // Bit mask must be 10xxxxxx
                    $v = ($v - 128) << ($next_byte * 6);
                    $output[($out_len - 1)] += $v;
                    --$next_byte;
                } else {
                    $this->_error('Conversion from UTF-8 to UCS-4 failed: malformed input at byte '.$k);
                    return false;
                }
                if ($next_byte < 0) {
                    $mode = 'next';
                }
            }
        } // for
        return $output;
    }

    /**
     * Convert UCS-4 string into UTF-8 string
     * See _utf8_to_ucs4() for details
     * @param string  $input
     * @return string
     */
    protected function _ucs4_to_utf8($input)
    {
        $output = '';
        foreach ($input as $k => $v) {
            if ($v < 128) { // 7bit are transferred literally
                $output .= chr($v);
            } elseif ($v < (1 << 11)) { // 2 bytes
                $output .= chr(192+($v >> 6)).chr(128+($v & 63));
            } elseif ($v < (1 << 16)) { // 3 bytes
                $output .= chr(224+($v >> 12)).chr(128+(($v >> 6) & 63)).chr(128+($v & 63));
            } elseif ($v < (1 << 21)) { // 4 bytes
                $output .= chr(240+($v >> 18)).chr(128+(($v >> 12) & 63)).chr(128+(($v >> 6) & 63)).chr(128+($v & 63));
            } else {
                $this->_error('Conversion from UCS-4 to UTF-8 failed: malformed input at byte '.$k);
                return false;
            }
        }
        return $output;
    }

    /**
     * Convert UCS-4 array into UCS-4 string
     *
     * @param array $input
     * @return string
     */
    protected function _ucs4_to_ucs4_string($input)
    {
        $output = '';
        // Take array values and split output to 4 bytes per value
        // The bit mask is 255, which reads &11111111
        foreach ($input as $v) {
            $output .= chr(($v >> 24) & 255).chr(($v >> 16) & 255).chr(($v >> 8) & 255).chr($v & 255);
        }
        return $output;
    }

    /**
     * Convert UCS-4 strin into UCS-4 garray
     *
     * @param  string $input
     * @return array
     */
    protected function _ucs4_string_to_ucs4($input)
    {
        $output = array();
        $inp_len = self::byteLength($input);
        // Input length must be dividable by 4
        if ($inp_len % 4) {
            $this->_error('Input UCS4 string is broken');
            return false;
        }
        // Empty input - return empty output
        if (!$inp_len) return $output;
        for ($i = 0, $out_len = -1; $i < $inp_len; ++$i) {
            // Increment output position every 4 input bytes
            if (!($i % 4)) {
                $out_len++;
                $output[$out_len] = 0;
            }
            $output[$out_len] += ord($input{$i}) << (8 * (3 - ($i % 4) ) );
        }
        return $output;
    }

    /**
     * Gets the length of a string in bytes even if mbstring function
     * overloading is turned on
     *
     * @param string $string the string for which to get the length.
     * @return integer the length of the string in bytes.
     */
    protected static function byteLength($string)
    {
        if (self::$_mb_string_overload) {
            return mb_strlen($string, '8bit');
        }
        return strlen((binary) $string);
    }

    /**
     * Attempts to return a concrete IDNA instance.
     *
     * @param array $params Set of paramaters
     * @return idna_convert
     * @access public
     */
    public function getInstance($params = array())
    {
        return new idna_convert($params);
    }

    /**
     * Attempts to return a concrete IDNA instance for either php4 or php5,
     * only creating a new instance if no IDNA instance with the same
     * parameters currently exists.
     *
     * @param array $params Set of paramaters
     *
     * @return object idna_convert
     * @access public
     */
    public function singleton($params = array())
    {
        static $instances;
        if (!isset($instances)) {
            $instances = array();
        }
        $signature = serialize($params);
        if (!isset($instances[$signature])) {
            $instances[$signature] = idna_convert::getInstance($params);
        }
        return $instances[$signature];
    }

    /**
     * Holds all relevant mapping tables
     * See RFC3454 for details
     *
     * @private array
     * @since 0.5.2
     */
    protected static $NP = array
            ('map_nothing' => array(0xAD, 0x34F, 0x1806, 0x180B, 0x180C, 0x180D, 0x200B, 0x200C
                    ,0x200D, 0x2060, 0xFE00, 0xFE01, 0xFE02, 0xFE03, 0xFE04, 0xFE05, 0xFE06, 0xFE07
                    ,0xFE08, 0xFE09, 0xFE0A, 0xFE0B, 0xFE0C, 0xFE0D, 0xFE0E, 0xFE0F, 0xFEFF
                    )
            ,'general_prohibited' => array(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19
                    ,20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32 ,33, 34, 35, 36, 37, 38, 39, 40, 41, 42
                    ,43, 44, 47, 59, 60, 61, 62, 63, 64, 91, 92, 93, 94, 95, 96, 123, 124, 125, 126, 127, 0x3002
                    )
            ,'prohibit' => array(0xA0, 0x340, 0x341, 0x6DD, 0x70F, 0x1680, 0x180E, 0x2000, 0x2001, 0x2002, 0x2003
                    ,0x2004, 0x2005, 0x2006, 0x2007, 0x2008, 0x2009, 0x200A, 0x200B, 0x200C, 0x200D, 0x200E, 0x200F
                    ,0x2028, 0x2029, 0x202A, 0x202B, 0x202C, 0x202D, 0x202E, 0x202F, 0x205F, 0x206A, 0x206B, 0x206C
                    ,0x206D, 0x206E, 0x206F, 0x3000, 0xFEFF, 0xFFF9, 0xFFFA, 0xFFFB, 0xFFFC, 0xFFFD, 0xFFFE, 0xFFFF
                    ,0x1FFFE, 0x1FFFF, 0x2FFFE, 0x2FFFF, 0x3FFFE, 0x3FFFF, 0x4FFFE, 0x4FFFF, 0x5FFFE, 0x5FFFF, 0x6FFFE
                    ,0x6FFFF, 0x7FFFE, 0x7FFFF, 0x8FFFE, 0x8FFFF, 0x9FFFE, 0x9FFFF, 0xAFFFE, 0xAFFFF, 0xBFFFE, 0xBFFFF
                    ,0xCFFFE, 0xCFFFF, 0xDFFFE, 0xDFFFF, 0xE0001, 0xEFFFE, 0xEFFFF, 0xFFFFE, 0xFFFFF, 0x10FFFE, 0x10FFFF
                    )
            ,'prohibit_ranges' => array(array(0x80, 0x9F), array(0x2060, 0x206F), array(0x1D173, 0x1D17A)
                    ,array(0xE000, 0xF8FF) ,array(0xF0000, 0xFFFFD), array(0x100000, 0x10FFFD)
                    ,array(0xFDD0, 0xFDEF), array(0xD800, 0xDFFF), array(0x2FF0, 0x2FFB), array(0xE0020, 0xE007F)
                    )
            ,'replacemaps' => array(0x41 => array(0x61), 0x42 => array(0x62), 0x43 => array(0x63)
                    ,0x44 => array(0x64), 0x45 => array(0x65), 0x46 => array(0x66), 0x47 => array(0x67)
                    ,0x48 => array(0x68), 0x49 => array(0x69), 0x4A => array(0x6A), 0x4B => array(0x6B)
                    ,0x4C => array(0x6C), 0x4D => array(0x6D), 0x4E => array(0x6E), 0x4F => array(0x6F)
                    ,0x50 => array(0x70), 0x51 => array(0x71), 0x52 => array(0x72), 0x53 => array(0x73)
                    ,0x54 => array(0x74), 0x55 => array(0x75), 0x56 => array(0x76), 0x57 => array(0x77)
                    ,0x58 => array(0x78), 0x59 => array(0x79), 0x5A => array(0x7A), 0xB5 => array(0x3BC)
                    ,0xC0 => array(0xE0), 0xC1 => array(0xE1), 0xC2 => array(0xE2), 0xC3 => array(0xE3)
                    ,0xC4 => array(0xE4), 0xC5 => array(0xE5), 0xC6 => array(0xE6), 0xC7 => array(0xE7)
                    ,0xC8 => array(0xE8), 0xC9 => array(0xE9), 0xCA => array(0xEA), 0xCB => array(0xEB)
                    ,0xCC => array(0xEC), 0xCD => array(0xED), 0xCE => array(0xEE), 0xCF => array(0xEF)
                    ,0xD0 => array(0xF0), 0xD1 => array(0xF1), 0xD2 => array(0xF2), 0xD3 => array(0xF3)
                    ,0xD4 => array(0xF4), 0xD5 => array(0xF5), 0xD6 => array(0xF6), 0xD8 => array(0xF8)
                    ,0xD9 => array(0xF9), 0xDA => array(0xFA), 0xDB => array(0xFB), 0xDC => array(0xFC)
                    ,0xDD => array(0xFD), 0xDE => array(0xFE), 0xDF => array(0x73, 0x73)
                    ,0x100 => array(0x101), 0x102 => array(0x103), 0x104 => array(0x105)
                    ,0x106 => array(0x107), 0x108 => array(0x109), 0x10A => array(0x10B)
                    ,0x10C => array(0x10D), 0x10E => array(0x10F), 0x110 => array(0x111)
                    ,0x112 => array(0x113), 0x114 => array(0x115), 0x116 => array(0x117)
                    ,0x118 => array(0x119), 0x11A => array(0x11B), 0x11C => array(0x11D)
                    ,0x11E => array(0x11F), 0x120 => array(0x121), 0x122 => array(0x123)
                    ,0x124 => array(0x125), 0x126 => array(0x127), 0x128 => array(0x129)
                    ,0x12A => array(0x12B), 0x12C => array(0x12D), 0x12E => array(0x12F)
                    ,0x130 => array(0x69, 0x307), 0x132 => array(0x133), 0x134 => array(0x135)
                    ,0x136 => array(0x137), 0x139 => array(0x13A), 0x13B => array(0x13C)
                    ,0x13D => array(0x13E), 0x13F => array(0x140), 0x141 => array(0x142)
                    ,0x143 => array(0x144), 0x145 => array(0x146), 0x147 => array(0x148)
                    ,0x149 => array(0x2BC, 0x6E), 0x14A => array(0x14B), 0x14C => array(0x14D)
                    ,0x14E => array(0x14F), 0x150 => array(0x151), 0x152 => array(0x153)
                    ,0x154 => array(0x155), 0x156 => array(0x157), 0x158 => array(0x159)
                    ,0x15A => array(0x15B), 0x15C => array(0x15D), 0x15E => array(0x15F)
                    ,0x160 => array(0x161), 0x162 => array(0x163), 0x164 => array(0x165)
                    ,0x166 => array(0x167), 0x168 => array(0x169), 0x16A => array(0x16B)
                    ,0x16C => array(0x16D), 0x16E => array(0x16F), 0x170 => array(0x171)
                    ,0x172 => array(0x173), 0x174 => array(0x175), 0x176 => array(0x177)
                    ,0x178 => array(0xFF), 0x179 => array(0x17A), 0x17B => array(0x17C)
                    ,0x17D => array(0x17E), 0x17F => array(0x73), 0x181 => array(0x253)
                    ,0x182 => array(0x183), 0x184 => array(0x185), 0x186 => array(0x254)
                    ,0x187 => array(0x188), 0x189 => array(0x256), 0x18A => array(0x257)
                    ,0x18B => array(0x18C), 0x18E => array(0x1DD), 0x18F => array(0x259)
                    ,0x190 => array(0x25B), 0x191 => array(0x192), 0x193 => array(0x260)
                    ,0x194 => array(0x263), 0x196 => array(0x269), 0x197 => array(0x268)
                    ,0x198 => array(0x199), 0x19C => array(0x26F), 0x19D => array(0x272)
                    ,0x19F => array(0x275), 0x1A0 => array(0x1A1), 0x1A2 => array(0x1A3)
                    ,0x1A4 => array(0x1A5), 0x1A6 => array(0x280), 0x1A7 => array(0x1A8)
                    ,0x1A9 => array(0x283), 0x1AC => array(0x1AD), 0x1AE => array(0x288)
                    ,0x1AF => array(0x1B0), 0x1B1 => array(0x28A), 0x1B2 => array(0x28B)
                    ,0x1B3 => array(0x1B4), 0x1B5 => array(0x1B6), 0x1B7 => array(0x292)
                    ,0x1B8 => array(0x1B9), 0x1BC => array(0x1BD), 0x1C4 => array(0x1C6)
                    ,0x1C5 => array(0x1C6), 0x1C7 => array(0x1C9), 0x1C8 => array(0x1C9)
                    ,0x1CA => array(0x1CC), 0x1CB => array(0x1CC), 0x1CD => array(0x1CE)
                    ,0x1CF => array(0x1D0), 0x1D1   => array(0x1D2), 0x1D3   => array(0x1D4)
                    ,0x1D5   => array(0x1D6), 0x1D7   => array(0x1D8), 0x1D9   => array(0x1DA)
                    ,0x1DB   => array(0x1DC), 0x1DE   => array(0x1DF), 0x1E0   => array(0x1E1)
                    ,0x1E2   => array(0x1E3), 0x1E4   => array(0x1E5), 0x1E6   => array(0x1E7)
                    ,0x1E8   => array(0x1E9), 0x1EA   => array(0x1EB), 0x1EC   => array(0x1ED)
                    ,0x1EE   => array(0x1EF), 0x1F0   => array(0x6A, 0x30C), 0x1F1   => array(0x1F3)
                    ,0x1F2   => array(0x1F3), 0x1F4   => array(0x1F5), 0x1F6   => array(0x195)
                    ,0x1F7   => array(0x1BF), 0x1F8   => array(0x1F9), 0x1FA   => array(0x1FB)
                    ,0x1FC   => array(0x1FD), 0x1FE   => array(0x1FF), 0x200   => array(0x201)
                    ,0x202   => array(0x203), 0x204   => array(0x205), 0x206   => array(0x207)
                    ,0x208   => array(0x209), 0x20A   => array(0x20B), 0x20C   => array(0x20D)
                    ,0x20E   => array(0x20F), 0x210   => array(0x211), 0x212   => array(0x213)
                    ,0x214   => array(0x215), 0x216   => array(0x217), 0x218   => array(0x219)
                    ,0x21A   => array(0x21B), 0x21C   => array(0x21D), 0x21E   => array(0x21F)
                    ,0x220   => array(0x19E), 0x222   => array(0x223), 0x224   => array(0x225)
                    ,0x226   => array(0x227), 0x228   => array(0x229), 0x22A   => array(0x22B)
                    ,0x22C   => array(0x22D), 0x22E   => array(0x22F), 0x230   => array(0x231)
                    ,0x232   => array(0x233), 0x345   => array(0x3B9), 0x37A   => array(0x20, 0x3B9)
                    ,0x386   => array(0x3AC), 0x388   => array(0x3AD), 0x389   => array(0x3AE)
                    ,0x38A   => array(0x3AF), 0x38C   => array(0x3CC), 0x38E   => array(0x3CD)
                    ,0x38F   => array(0x3CE), 0x390   => array(0x3B9, 0x308, 0x301)
                    ,0x391   => array(0x3B1), 0x392   => array(0x3B2), 0x393   => array(0x3B3)
                    ,0x394   => array(0x3B4), 0x395   => array(0x3B5), 0x396   => array(0x3B6)
                    ,0x397   => array(0x3B7), 0x398   => array(0x3B8), 0x399   => array(0x3B9)
                    ,0x39A   => array(0x3BA), 0x39B   => array(0x3BB), 0x39C   => array(0x3BC)
                    ,0x39D   => array(0x3BD), 0x39E   => array(0x3BE), 0x39F   => array(0x3BF)
                    ,0x3A0   => array(0x3C0), 0x3A1   => array(0x3C1), 0x3A3   => array(0x3C3)
                    ,0x3A4   => array(0x3C4), 0x3A5   => array(0x3C5), 0x3A6   => array(0x3C6)
                    ,0x3A7   => array(0x3C7), 0x3A8   => array(0x3C8), 0x3A9   => array(0x3C9)
                    ,0x3AA   => array(0x3CA), 0x3AB   => array(0x3CB), 0x3B0   => array(0x3C5, 0x308, 0x301)
                    ,0x3C2   => array(0x3C3), 0x3D0   => array(0x3B2), 0x3D1   => array(0x3B8)
                    ,0x3D2   => array(0x3C5), 0x3D3   => array(0x3CD), 0x3D4   => array(0x3CB)
                    ,0x3D5   => array(0x3C6), 0x3D6   => array(0x3C0), 0x3D8   => array(0x3D9)
                    ,0x3DA   => array(0x3DB), 0x3DC   => array(0x3DD), 0x3DE   => array(0x3DF)
                    ,0x3E0   => array(0x3E1), 0x3E2   => array(0x3E3), 0x3E4   => array(0x3E5)
                    ,0x3E6   => array(0x3E7), 0x3E8   => array(0x3E9), 0x3EA   => array(0x3EB)
                    ,0x3EC   => array(0x3ED), 0x3EE   => array(0x3EF), 0x3F0   => array(0x3BA)
                    ,0x3F1   => array(0x3C1), 0x3F2   => array(0x3C3), 0x3F4   => array(0x3B8)
                    ,0x3F5   => array(0x3B5), 0x400   => array(0x450), 0x401   => array(0x451)
                    ,0x402   => array(0x452), 0x403   => array(0x453), 0x404   => array(0x454)
                    ,0x405   => array(0x455), 0x406   => array(0x456), 0x407   => array(0x457)
                    ,0x408   => array(0x458), 0x409   => array(0x459), 0x40A   => array(0x45A)
                    ,0x40B   => array(0x45B), 0x40C   => array(0x45C), 0x40D   => array(0x45D)
                    ,0x40E   => array(0x45E), 0x40F   => array(0x45F), 0x410   => array(0x430)
                    ,0x411   => array(0x431), 0x412   => array(0x432), 0x413   => array(0x433)
                    ,0x414   => array(0x434), 0x415   => array(0x435), 0x416   => array(0x436)
                    ,0x417   => array(0x437), 0x418   => array(0x438), 0x419   => array(0x439)
                    ,0x41A   => array(0x43A), 0x41B   => array(0x43B), 0x41C   => array(0x43C)
                    ,0x41D   => array(0x43D), 0x41E   => array(0x43E), 0x41F   => array(0x43F)
                    ,0x420   => array(0x440), 0x421   => array(0x441), 0x422   => array(0x442)
                    ,0x423   => array(0x443), 0x424   => array(0x444), 0x425   => array(0x445)
                    ,0x426   => array(0x446), 0x427   => array(0x447), 0x428   => array(0x448)
                    ,0x429   => array(0x449), 0x42A   => array(0x44A), 0x42B   => array(0x44B)
                    ,0x42C   => array(0x44C), 0x42D   => array(0x44D), 0x42E   => array(0x44E)
                    ,0x42F   => array(0x44F), 0x460   => array(0x461), 0x462   => array(0x463)
                    ,0x464   => array(0x465), 0x466   => array(0x467), 0x468   => array(0x469)
                    ,0x46A   => array(0x46B), 0x46C   => array(0x46D), 0x46E   => array(0x46F)
                    ,0x470   => array(0x471), 0x472   => array(0x473), 0x474   => array(0x475)
                    ,0x476   => array(0x477), 0x478   => array(0x479), 0x47A   => array(0x47B)
                    ,0x47C   => array(0x47D), 0x47E   => array(0x47F), 0x480   => array(0x481)
                    ,0x48A   => array(0x48B), 0x48C   => array(0x48D), 0x48E   => array(0x48F)
                    ,0x490   => array(0x491), 0x492   => array(0x493), 0x494   => array(0x495)
                    ,0x496   => array(0x497), 0x498   => array(0x499), 0x49A   => array(0x49B)
                    ,0x49C   => array(0x49D), 0x49E   => array(0x49F), 0x4A0   => array(0x4A1)
                    ,0x4A2   => array(0x4A3), 0x4A4   => array(0x4A5), 0x4A6   => array(0x4A7)
                    ,0x4A8   => array(0x4A9), 0x4AA   => array(0x4AB), 0x4AC   => array(0x4AD)
                    ,0x4AE   => array(0x4AF), 0x4B0   => array(0x4B1), 0x4B2   => array(0x4B3)
                    ,0x4B4   => array(0x4B5), 0x4B6   => array(0x4B7), 0x4B8   => array(0x4B9)
                    ,0x4BA   => array(0x4BB), 0x4BC   => array(0x4BD), 0x4BE   => array(0x4BF)
                    ,0x4C1   => array(0x4C2), 0x4C3   => array(0x4C4), 0x4C5   => array(0x4C6)
                    ,0x4C7   => array(0x4C8), 0x4C9   => array(0x4CA), 0x4CB   => array(0x4CC)
                    ,0x4CD   => array(0x4CE), 0x4D0   => array(0x4D1), 0x4D2   => array(0x4D3)
                    ,0x4D4   => array(0x4D5), 0x4D6   => array(0x4D7), 0x4D8   => array(0x4D9)
                    ,0x4DA   => array(0x4DB), 0x4DC   => array(0x4DD), 0x4DE   => array(0x4DF)
                    ,0x4E0   => array(0x4E1), 0x4E2   => array(0x4E3), 0x4E4   => array(0x4E5)
                    ,0x4E6   => array(0x4E7), 0x4E8   => array(0x4E9), 0x4EA   => array(0x4EB)
                    ,0x4EC   => array(0x4ED), 0x4EE   => array(0x4EF), 0x4F0   => array(0x4F1)
                    ,0x4F2   => array(0x4F3), 0x4F4   => array(0x4F5), 0x4F8   => array(0x4F9)
                    ,0x500   => array(0x501), 0x502   => array(0x503), 0x504   => array(0x505)
                    ,0x506   => array(0x507), 0x508   => array(0x509), 0x50A   => array(0x50B)
                    ,0x50C   => array(0x50D), 0x50E   => array(0x50F), 0x531   => array(0x561)
                    ,0x532   => array(0x562), 0x533   => array(0x563), 0x534   => array(0x564)
                    ,0x535   => array(0x565), 0x536   => array(0x566), 0x537   => array(0x567)
                    ,0x538   => array(0x568), 0x539   => array(0x569), 0x53A   => array(0x56A)
                    ,0x53B   => array(0x56B), 0x53C   => array(0x56C), 0x53D   => array(0x56D)
                    ,0x53E   => array(0x56E), 0x53F   => array(0x56F), 0x540   => array(0x570)
                    ,0x541   => array(0x571), 0x542   => array(0x572), 0x543   => array(0x573)
                    ,0x544   => array(0x574), 0x545   => array(0x575), 0x546   => array(0x576)
                    ,0x547   => array(0x577), 0x548   => array(0x578), 0x549   => array(0x579)
                    ,0x54A   => array(0x57A), 0x54B   => array(0x57B), 0x54C   => array(0x57C)
                    ,0x54D   => array(0x57D), 0x54E   => array(0x57E), 0x54F   => array(0x57F)
                    ,0x550   => array(0x580), 0x551   => array(0x581), 0x552   => array(0x582)
                    ,0x553   => array(0x583), 0x554   => array(0x584), 0x555   => array(0x585)
                    ,0x556 => array(0x586), 0x587 => array(0x565, 0x582), 0xE33 => array(0xE4D, 0xE32)
                    ,0x1E00  => array(0x1E01), 0x1E02  => array(0x1E03), 0x1E04  => array(0x1E05)
                    ,0x1E06  => array(0x1E07), 0x1E08  => array(0x1E09), 0x1E0A  => array(0x1E0B)
                    ,0x1E0C  => array(0x1E0D), 0x1E0E  => array(0x1E0F), 0x1E10  => array(0x1E11)
                    ,0x1E12  => array(0x1E13), 0x1E14  => array(0x1E15), 0x1E16  => array(0x1E17)
                    ,0x1E18  => array(0x1E19), 0x1E1A  => array(0x1E1B), 0x1E1C  => array(0x1E1D)
                    ,0x1E1E  => array(0x1E1F), 0x1E20  => array(0x1E21), 0x1E22  => array(0x1E23)
                    ,0x1E24  => array(0x1E25), 0x1E26  => array(0x1E27), 0x1E28  => array(0x1E29)
                    ,0x1E2A  => array(0x1E2B), 0x1E2C  => array(0x1E2D), 0x1E2E  => array(0x1E2F)
                    ,0x1E30  => array(0x1E31), 0x1E32  => array(0x1E33), 0x1E34  => array(0x1E35)
                    ,0x1E36  => array(0x1E37), 0x1E38  => array(0x1E39), 0x1E3A  => array(0x1E3B)
                    ,0x1E3C  => array(0x1E3D), 0x1E3E  => array(0x1E3F), 0x1E40  => array(0x1E41)
                    ,0x1E42  => array(0x1E43), 0x1E44  => array(0x1E45), 0x1E46  => array(0x1E47)
                    ,0x1E48  => array(0x1E49), 0x1E4A  => array(0x1E4B), 0x1E4C  => array(0x1E4D)
                    ,0x1E4E  => array(0x1E4F), 0x1E50  => array(0x1E51), 0x1E52  => array(0x1E53)
                    ,0x1E54  => array(0x1E55), 0x1E56  => array(0x1E57), 0x1E58  => array(0x1E59)
                    ,0x1E5A  => array(0x1E5B), 0x1E5C  => array(0x1E5D), 0x1E5E  => array(0x1E5F)
                    ,0x1E60  => array(0x1E61), 0x1E62  => array(0x1E63), 0x1E64  => array(0x1E65)
                    ,0x1E66  => array(0x1E67), 0x1E68  => array(0x1E69), 0x1E6A  => array(0x1E6B)
                    ,0x1E6C  => array(0x1E6D), 0x1E6E  => array(0x1E6F), 0x1E70  => array(0x1E71)
                    ,0x1E72  => array(0x1E73), 0x1E74  => array(0x1E75), 0x1E76  => array(0x1E77)
                    ,0x1E78  => array(0x1E79), 0x1E7A  => array(0x1E7B), 0x1E7C  => array(0x1E7D)
                    ,0x1E7E  => array(0x1E7F), 0x1E80  => array(0x1E81), 0x1E82  => array(0x1E83)
                    ,0x1E84  => array(0x1E85), 0x1E86  => array(0x1E87), 0x1E88  => array(0x1E89)
                    ,0x1E8A  => array(0x1E8B), 0x1E8C  => array(0x1E8D), 0x1E8E  => array(0x1E8F)
                    ,0x1E90  => array(0x1E91), 0x1E92  => array(0x1E93), 0x1E94  => array(0x1E95)
                    ,0x1E96  => array(0x68, 0x331), 0x1E97  => array(0x74, 0x308), 0x1E98  => array(0x77, 0x30A)
                    ,0x1E99  => array(0x79, 0x30A), 0x1E9A  => array(0x61, 0x2BE), 0x1E9B  => array(0x1E61)
                    ,0x1EA0  => array(0x1EA1), 0x1EA2  => array(0x1EA3), 0x1EA4  => array(0x1EA5)
                    ,0x1EA6  => array(0x1EA7), 0x1EA8  => array(0x1EA9), 0x1EAA  => array(0x1EAB)
                    ,0x1EAC  => array(0x1EAD), 0x1EAE  => array(0x1EAF), 0x1EB0  => array(0x1EB1)
                    ,0x1EB2  => array(0x1EB3), 0x1EB4  => array(0x1EB5), 0x1EB6  => array(0x1EB7)
                    ,0x1EB8  => array(0x1EB9), 0x1EBA  => array(0x1EBB), 0x1EBC  => array(0x1EBD)
                    ,0x1EBE  => array(0x1EBF), 0x1EC0  => array(0x1EC1), 0x1EC2  => array(0x1EC3)
                    ,0x1EC4  => array(0x1EC5), 0x1EC6  => array(0x1EC7), 0x1EC8  => array(0x1EC9)
                    ,0x1ECA  => array(0x1ECB), 0x1ECC  => array(0x1ECD), 0x1ECE  => array(0x1ECF)
                    ,0x1ED0  => array(0x1ED1), 0x1ED2  => array(0x1ED3), 0x1ED4  => array(0x1ED5)
                    ,0x1ED6  => array(0x1ED7), 0x1ED8  => array(0x1ED9), 0x1EDA  => array(0x1EDB)
                    ,0x1EDC  => array(0x1EDD), 0x1EDE  => array(0x1EDF), 0x1EE0  => array(0x1EE1)
                    ,0x1EE2  => array(0x1EE3), 0x1EE4  => array(0x1EE5), 0x1EE6  => array(0x1EE7)
                    ,0x1EE8  => array(0x1EE9), 0x1EEA  => array(0x1EEB), 0x1EEC  => array(0x1EED)
                    ,0x1EEE  => array(0x1EEF), 0x1EF0  => array(0x1EF1), 0x1EF2  => array(0x1EF3)
                    ,0x1EF4  => array(0x1EF5), 0x1EF6  => array(0x1EF7), 0x1EF8  => array(0x1EF9)
                    ,0x1F08  => array(0x1F00), 0x1F09  => array(0x1F01), 0x1F0A  => array(0x1F02)
                    ,0x1F0B  => array(0x1F03), 0x1F0C  => array(0x1F04), 0x1F0D  => array(0x1F05)
                    ,0x1F0E  => array(0x1F06), 0x1F0F  => array(0x1F07), 0x1F18  => array(0x1F10)
                    ,0x1F19  => array(0x1F11), 0x1F1A  => array(0x1F12), 0x1F1B  => array(0x1F13)
                    ,0x1F1C  => array(0x1F14), 0x1F1D  => array(0x1F15), 0x1F28  => array(0x1F20)
                    ,0x1F29  => array(0x1F21), 0x1F2A  => array(0x1F22), 0x1F2B  => array(0x1F23)
                    ,0x1F2C  => array(0x1F24), 0x1F2D  => array(0x1F25), 0x1F2E  => array(0x1F26)
                    ,0x1F2F  => array(0x1F27), 0x1F38  => array(0x1F30), 0x1F39  => array(0x1F31)
                    ,0x1F3A  => array(0x1F32), 0x1F3B  => array(0x1F33), 0x1F3C  => array(0x1F34)
                    ,0x1F3D  => array(0x1F35), 0x1F3E  => array(0x1F36), 0x1F3F  => array(0x1F37)
                    ,0x1F48  => array(0x1F40), 0x1F49  => array(0x1F41), 0x1F4A  => array(0x1F42)
                    ,0x1F4B  => array(0x1F43), 0x1F4C  => array(0x1F44), 0x1F4D  => array(0x1F45)
                    ,0x1F50  => array(0x3C5, 0x313), 0x1F52  => array(0x3C5, 0x313, 0x300)
                    ,0x1F54  => array(0x3C5, 0x313, 0x301), 0x1F56  => array(0x3C5, 0x313, 0x342)
                    ,0x1F59  => array(0x1F51), 0x1F5B  => array(0x1F53), 0x1F5D  => array(0x1F55)
                    ,0x1F5F  => array(0x1F57), 0x1F68  => array(0x1F60), 0x1F69  => array(0x1F61)
                    ,0x1F6A  => array(0x1F62), 0x1F6B  => array(0x1F63), 0x1F6C  => array(0x1F64)
                    ,0x1F6D  => array(0x1F65), 0x1F6E  => array(0x1F66), 0x1F6F  => array(0x1F67)
                    ,0x1F80  => array(0x1F00, 0x3B9), 0x1F81  => array(0x1F01, 0x3B9)
                    ,0x1F82  => array(0x1F02, 0x3B9), 0x1F83  => array(0x1F03, 0x3B9)
                    ,0x1F84  => array(0x1F04, 0x3B9), 0x1F85  => array(0x1F05, 0x3B9)
                    ,0x1F86  => array(0x1F06, 0x3B9), 0x1F87  => array(0x1F07, 0x3B9)
                    ,0x1F88  => array(0x1F00, 0x3B9), 0x1F89  => array(0x1F01, 0x3B9)
                    ,0x1F8A  => array(0x1F02, 0x3B9), 0x1F8B  => array(0x1F03, 0x3B9)
                    ,0x1F8C  => array(0x1F04, 0x3B9), 0x1F8D  => array(0x1F05, 0x3B9)
                    ,0x1F8E  => array(0x1F06, 0x3B9), 0x1F8F  => array(0x1F07, 0x3B9)
                    ,0x1F90  => array(0x1F20, 0x3B9), 0x1F91  => array(0x1F21, 0x3B9)
                    ,0x1F92  => array(0x1F22, 0x3B9), 0x1F93  => array(0x1F23, 0x3B9)
                    ,0x1F94  => array(0x1F24, 0x3B9), 0x1F95  => array(0x1F25, 0x3B9)
                    ,0x1F96  => array(0x1F26, 0x3B9), 0x1F97  => array(0x1F27, 0x3B9)
                    ,0x1F98  => array(0x1F20, 0x3B9), 0x1F99  => array(0x1F21, 0x3B9)
                    ,0x1F9A  => array(0x1F22, 0x3B9), 0x1F9B  => array(0x1F23, 0x3B9)
                    ,0x1F9C  => array(0x1F24, 0x3B9), 0x1F9D  => array(0x1F25, 0x3B9)
                    ,0x1F9E  => array(0x1F26, 0x3B9), 0x1F9F  => array(0x1F27, 0x3B9)
                    ,0x1FA0  => array(0x1F60, 0x3B9), 0x1FA1  => array(0x1F61, 0x3B9)
                    ,0x1FA2  => array(0x1F62, 0x3B9), 0x1FA3  => array(0x1F63, 0x3B9)
                    ,0x1FA4  => array(0x1F64, 0x3B9), 0x1FA5  => array(0x1F65, 0x3B9)
                    ,0x1FA6  => array(0x1F66, 0x3B9), 0x1FA7  => array(0x1F67, 0x3B9)
                    ,0x1FA8  => array(0x1F60, 0x3B9), 0x1FA9  => array(0x1F61, 0x3B9)
                    ,0x1FAA  => array(0x1F62, 0x3B9), 0x1FAB  => array(0x1F63, 0x3B9)
                    ,0x1FAC  => array(0x1F64, 0x3B9), 0x1FAD  => array(0x1F65, 0x3B9)
                    ,0x1FAE  => array(0x1F66, 0x3B9), 0x1FAF  => array(0x1F67, 0x3B9)
                    ,0x1FB2  => array(0x1F70, 0x3B9), 0x1FB3  => array(0x3B1, 0x3B9)
                    ,0x1FB4  => array(0x3AC, 0x3B9), 0x1FB6  => array(0x3B1, 0x342)
                    ,0x1FB7  => array(0x3B1, 0x342, 0x3B9), 0x1FB8  => array(0x1FB0)
                    ,0x1FB9  => array(0x1FB1), 0x1FBA  => array(0x1F70), 0x1FBB  => array(0x1F71)
                    ,0x1FBC  => array(0x3B1, 0x3B9), 0x1FBE  => array(0x3B9)
                    ,0x1FC2  => array(0x1F74, 0x3B9), 0x1FC3  => array(0x3B7, 0x3B9)
                    ,0x1FC4  => array(0x3AE, 0x3B9), 0x1FC6  => array(0x3B7, 0x342)
                    ,0x1FC7  => array(0x3B7, 0x342, 0x3B9), 0x1FC8  => array(0x1F72)
                    ,0x1FC9  => array(0x1F73), 0x1FCA  => array(0x1F74), 0x1FCB  => array(0x1F75)
                    ,0x1FCC  => array(0x3B7, 0x3B9), 0x1FD2  => array(0x3B9, 0x308, 0x300)
                    ,0x1FD3  => array(0x3B9, 0x308, 0x301), 0x1FD6  => array(0x3B9, 0x342)
                    ,0x1FD7  => array(0x3B9, 0x308, 0x342), 0x1FD8  => array(0x1FD0)
                    ,0x1FD9  => array(0x1FD1), 0x1FDA  => array(0x1F76)
                    ,0x1FDB  => array(0x1F77), 0x1FE2  => array(0x3C5, 0x308, 0x300)
                    ,0x1FE3  => array(0x3C5, 0x308, 0x301), 0x1FE4  => array(0x3C1, 0x313)
                    ,0x1FE6  => array(0x3C5, 0x342), 0x1FE7  => array(0x3C5, 0x308, 0x342)
                    ,0x1FE8  => array(0x1FE0), 0x1FE9  => array(0x1FE1)
                    ,0x1FEA  => array(0x1F7A), 0x1FEB  => array(0x1F7B)
                    ,0x1FEC  => array(0x1FE5), 0x1FF2  => array(0x1F7C, 0x3B9)
                    ,0x1FF3  => array(0x3C9, 0x3B9), 0x1FF4  => array(0x3CE, 0x3B9)
                    ,0x1FF6  => array(0x3C9, 0x342), 0x1FF7  => array(0x3C9, 0x342, 0x3B9)
                    ,0x1FF8  => array(0x1F78), 0x1FF9  => array(0x1F79), 0x1FFA  => array(0x1F7C)
                    ,0x1FFB  => array(0x1F7D), 0x1FFC  => array(0x3C9, 0x3B9)
                    ,0x20A8  => array(0x72, 0x73), 0x2102  => array(0x63), 0x2103  => array(0xB0, 0x63)
                    ,0x2107  => array(0x25B), 0x2109  => array(0xB0, 0x66), 0x210B  => array(0x68)
                    ,0x210C  => array(0x68), 0x210D  => array(0x68), 0x2110  => array(0x69)
                    ,0x2111  => array(0x69), 0x2112  => array(0x6C), 0x2115  => array(0x6E)
                    ,0x2116  => array(0x6E, 0x6F), 0x2119  => array(0x70), 0x211A  => array(0x71)
                    ,0x211B  => array(0x72), 0x211C  => array(0x72), 0x211D  => array(0x72)
                    ,0x2120  => array(0x73, 0x6D), 0x2121  => array(0x74, 0x65, 0x6C)
                    ,0x2122  => array(0x74, 0x6D), 0x2124  => array(0x7A), 0x2126  => array(0x3C9)
                    ,0x2128  => array(0x7A), 0x212A  => array(0x6B), 0x212B  => array(0xE5)
                    ,0x212C  => array(0x62), 0x212D  => array(0x63), 0x2130  => array(0x65)
                    ,0x2131  => array(0x66), 0x2133  => array(0x6D), 0x213E  => array(0x3B3)
                    ,0x213F  => array(0x3C0), 0x2145  => array(0x64) ,0x2160  => array(0x2170)
                    ,0x2161  => array(0x2171), 0x2162  => array(0x2172), 0x2163  => array(0x2173)
                    ,0x2164  => array(0x2174), 0x2165  => array(0x2175), 0x2166  => array(0x2176)
                    ,0x2167  => array(0x2177), 0x2168  => array(0x2178), 0x2169  => array(0x2179)
                    ,0x216A  => array(0x217A), 0x216B  => array(0x217B), 0x216C  => array(0x217C)
                    ,0x216D  => array(0x217D), 0x216E  => array(0x217E), 0x216F  => array(0x217F)
                    ,0x24B6  => array(0x24D0), 0x24B7  => array(0x24D1), 0x24B8  => array(0x24D2)
                    ,0x24B9  => array(0x24D3), 0x24BA  => array(0x24D4), 0x24BB  => array(0x24D5)
                    ,0x24BC  => array(0x24D6), 0x24BD  => array(0x24D7), 0x24BE  => array(0x24D8)
                    ,0x24BF  => array(0x24D9), 0x24C0  => array(0x24DA), 0x24C1  => array(0x24DB)
                    ,0x24C2  => array(0x24DC), 0x24C3  => array(0x24DD), 0x24C4  => array(0x24DE)
                    ,0x24C5  => array(0x24DF), 0x24C6  => array(0x24E0), 0x24C7  => array(0x24E1)
                    ,0x24C8  => array(0x24E2), 0x24C9  => array(0x24E3), 0x24CA  => array(0x24E4)
                    ,0x24CB  => array(0x24E5), 0x24CC  => array(0x24E6), 0x24CD  => array(0x24E7)
                    ,0x24CE  => array(0x24E8), 0x24CF  => array(0x24E9), 0x3371  => array(0x68, 0x70, 0x61)
                    ,0x3373  => array(0x61, 0x75), 0x3375  => array(0x6F, 0x76)
                    ,0x3380  => array(0x70, 0x61), 0x3381  => array(0x6E, 0x61)
                    ,0x3382  => array(0x3BC, 0x61), 0x3383  => array(0x6D, 0x61)
                    ,0x3384  => array(0x6B, 0x61), 0x3385  => array(0x6B, 0x62)
                    ,0x3386  => array(0x6D, 0x62), 0x3387  => array(0x67, 0x62)
                    ,0x338A  => array(0x70, 0x66), 0x338B  => array(0x6E, 0x66)
                    ,0x338C  => array(0x3BC, 0x66), 0x3390  => array(0x68, 0x7A)
                    ,0x3391  => array(0x6B, 0x68, 0x7A), 0x3392  => array(0x6D, 0x68, 0x7A)
                    ,0x3393  => array(0x67, 0x68, 0x7A), 0x3394  => array(0x74, 0x68, 0x7A)
                    ,0x33A9  => array(0x70, 0x61), 0x33AA  => array(0x6B, 0x70, 0x61)
                    ,0x33AB  => array(0x6D, 0x70, 0x61), 0x33AC  => array(0x67, 0x70, 0x61)
                    ,0x33B4  => array(0x70, 0x76), 0x33B5  => array(0x6E, 0x76)
                    ,0x33B6  => array(0x3BC, 0x76), 0x33B7  => array(0x6D, 0x76)
                    ,0x33B8  => array(0x6B, 0x76), 0x33B9  => array(0x6D, 0x76)
                    ,0x33BA  => array(0x70, 0x77), 0x33BB  => array(0x6E, 0x77)
                    ,0x33BC  => array(0x3BC, 0x77), 0x33BD  => array(0x6D, 0x77)
                    ,0x33BE  => array(0x6B, 0x77), 0x33BF  => array(0x6D, 0x77)
                    ,0x33C0  => array(0x6B, 0x3C9), 0x33C1  => array(0x6D, 0x3C9) /*
                    ,0x33C2  => array(0x61, 0x2E, 0x6D, 0x2E) */
                    ,0x33C3  => array(0x62, 0x71), 0x33C6  => array(0x63, 0x2215, 0x6B, 0x67)
                    ,0x33C7  => array(0x63, 0x6F, 0x2E), 0x33C8  => array(0x64, 0x62)
                    ,0x33C9  => array(0x67, 0x79), 0x33CB  => array(0x68, 0x70)
                    ,0x33CD  => array(0x6B, 0x6B), 0x33CE  => array(0x6B, 0x6D)
                    ,0x33D7  => array(0x70, 0x68), 0x33D9  => array(0x70, 0x70, 0x6D)
                    ,0x33DA  => array(0x70, 0x72), 0x33DC  => array(0x73, 0x76)
                    ,0x33DD  => array(0x77, 0x62), 0xFB00  => array(0x66, 0x66)
                    ,0xFB01  => array(0x66, 0x69), 0xFB02  => array(0x66, 0x6C)
                    ,0xFB03  => array(0x66, 0x66, 0x69), 0xFB04  => array(0x66, 0x66, 0x6C)
                    ,0xFB05  => array(0x73, 0x74), 0xFB06  => array(0x73, 0x74)
                    ,0xFB13  => array(0x574, 0x576), 0xFB14  => array(0x574, 0x565)
                    ,0xFB15  => array(0x574, 0x56B), 0xFB16  => array(0x57E, 0x576)
                    ,0xFB17  => array(0x574, 0x56D), 0xFF21  => array(0xFF41)
                    ,0xFF22  => array(0xFF42), 0xFF23  => array(0xFF43), 0xFF24  => array(0xFF44)
                    ,0xFF25  => array(0xFF45), 0xFF26  => array(0xFF46), 0xFF27  => array(0xFF47)
                    ,0xFF28  => array(0xFF48), 0xFF29  => array(0xFF49), 0xFF2A  => array(0xFF4A)
                    ,0xFF2B  => array(0xFF4B), 0xFF2C  => array(0xFF4C), 0xFF2D  => array(0xFF4D)
                    ,0xFF2E  => array(0xFF4E), 0xFF2F  => array(0xFF4F), 0xFF30  => array(0xFF50)
                    ,0xFF31  => array(0xFF51), 0xFF32  => array(0xFF52), 0xFF33  => array(0xFF53)
                    ,0xFF34  => array(0xFF54), 0xFF35  => array(0xFF55), 0xFF36  => array(0xFF56)
                    ,0xFF37  => array(0xFF57), 0xFF38  => array(0xFF58), 0xFF39  => array(0xFF59)
                    ,0xFF3A  => array(0xFF5A), 0x10400 => array(0x10428), 0x10401 => array(0x10429)
                    ,0x10402 => array(0x1042A), 0x10403 => array(0x1042B), 0x10404 => array(0x1042C)
                    ,0x10405 => array(0x1042D), 0x10406 => array(0x1042E), 0x10407 => array(0x1042F)
                    ,0x10408 => array(0x10430), 0x10409 => array(0x10431), 0x1040A => array(0x10432)
                    ,0x1040B => array(0x10433), 0x1040C => array(0x10434), 0x1040D => array(0x10435)
                    ,0x1040E => array(0x10436), 0x1040F => array(0x10437), 0x10410 => array(0x10438)
                    ,0x10411 => array(0x10439), 0x10412 => array(0x1043A), 0x10413 => array(0x1043B)
                    ,0x10414 => array(0x1043C), 0x10415 => array(0x1043D), 0x10416 => array(0x1043E)
                    ,0x10417 => array(0x1043F), 0x10418 => array(0x10440), 0x10419 => array(0x10441)
                    ,0x1041A => array(0x10442), 0x1041B => array(0x10443), 0x1041C => array(0x10444)
                    ,0x1041D => array(0x10445), 0x1041E => array(0x10446), 0x1041F => array(0x10447)
                    ,0x10420 => array(0x10448), 0x10421 => array(0x10449), 0x10422 => array(0x1044A)
                    ,0x10423 => array(0x1044B), 0x10424 => array(0x1044C), 0x10425 => array(0x1044D)
                    ,0x1D400 => array(0x61), 0x1D401 => array(0x62), 0x1D402 => array(0x63)
                    ,0x1D403 => array(0x64), 0x1D404 => array(0x65), 0x1D405 => array(0x66)
                    ,0x1D406 => array(0x67), 0x1D407 => array(0x68), 0x1D408 => array(0x69)
                    ,0x1D409 => array(0x6A), 0x1D40A => array(0x6B), 0x1D40B => array(0x6C)
                    ,0x1D40C => array(0x6D), 0x1D40D => array(0x6E), 0x1D40E => array(0x6F)
                    ,0x1D40F => array(0x70), 0x1D410 => array(0x71), 0x1D411 => array(0x72)
                    ,0x1D412 => array(0x73), 0x1D413 => array(0x74), 0x1D414 => array(0x75)
                    ,0x1D415 => array(0x76), 0x1D416 => array(0x77), 0x1D417 => array(0x78)
                    ,0x1D418 => array(0x79), 0x1D419 => array(0x7A), 0x1D434 => array(0x61)
                    ,0x1D435 => array(0x62), 0x1D436 => array(0x63), 0x1D437 => array(0x64)
                    ,0x1D438 => array(0x65), 0x1D439 => array(0x66), 0x1D43A => array(0x67)
                    ,0x1D43B => array(0x68), 0x1D43C => array(0x69), 0x1D43D => array(0x6A)
                    ,0x1D43E => array(0x6B), 0x1D43F => array(0x6C), 0x1D440 => array(0x6D)
                    ,0x1D441 => array(0x6E), 0x1D442 => array(0x6F), 0x1D443 => array(0x70)
                    ,0x1D444 => array(0x71), 0x1D445 => array(0x72), 0x1D446 => array(0x73)
                    ,0x1D447 => array(0x74), 0x1D448 => array(0x75), 0x1D449 => array(0x76)
                    ,0x1D44A => array(0x77), 0x1D44B => array(0x78), 0x1D44C => array(0x79)
                    ,0x1D44D => array(0x7A), 0x1D468 => array(0x61), 0x1D469 => array(0x62)
                    ,0x1D46A => array(0x63), 0x1D46B => array(0x64), 0x1D46C => array(0x65)
                    ,0x1D46D => array(0x66), 0x1D46E => array(0x67), 0x1D46F => array(0x68)
                    ,0x1D470 => array(0x69), 0x1D471 => array(0x6A), 0x1D472 => array(0x6B)
                    ,0x1D473 => array(0x6C), 0x1D474 => array(0x6D), 0x1D475 => array(0x6E)
                    ,0x1D476 => array(0x6F), 0x1D477 => array(0x70), 0x1D478 => array(0x71)
                    ,0x1D479 => array(0x72), 0x1D47A => array(0x73), 0x1D47B => array(0x74)
                    ,0x1D47C => array(0x75), 0x1D47D => array(0x76), 0x1D47E => array(0x77)
                    ,0x1D47F => array(0x78), 0x1D480 => array(0x79), 0x1D481 => array(0x7A)
                    ,0x1D49C => array(0x61), 0x1D49E => array(0x63), 0x1D49F => array(0x64)
                    ,0x1D4A2 => array(0x67), 0x1D4A5 => array(0x6A), 0x1D4A6 => array(0x6B)
                    ,0x1D4A9 => array(0x6E), 0x1D4AA => array(0x6F), 0x1D4AB => array(0x70)
                    ,0x1D4AC => array(0x71), 0x1D4AE => array(0x73), 0x1D4AF => array(0x74)
                    ,0x1D4B0 => array(0x75), 0x1D4B1 => array(0x76), 0x1D4B2 => array(0x77)
                    ,0x1D4B3 => array(0x78), 0x1D4B4 => array(0x79), 0x1D4B5 => array(0x7A)
                    ,0x1D4D0 => array(0x61), 0x1D4D1 => array(0x62), 0x1D4D2 => array(0x63)
                    ,0x1D4D3 => array(0x64), 0x1D4D4 => array(0x65), 0x1D4D5 => array(0x66)
                    ,0x1D4D6 => array(0x67), 0x1D4D7 => array(0x68), 0x1D4D8 => array(0x69)
                    ,0x1D4D9 => array(0x6A), 0x1D4DA => array(0x6B), 0x1D4DB => array(0x6C)
                    ,0x1D4DC => array(0x6D), 0x1D4DD => array(0x6E), 0x1D4DE => array(0x6F)
                    ,0x1D4DF => array(0x70), 0x1D4E0 => array(0x71), 0x1D4E1 => array(0x72)
                    ,0x1D4E2 => array(0x73), 0x1D4E3 => array(0x74), 0x1D4E4 => array(0x75)
                    ,0x1D4E5 => array(0x76), 0x1D4E6 => array(0x77), 0x1D4E7 => array(0x78)
                    ,0x1D4E8 => array(0x79), 0x1D4E9 => array(0x7A), 0x1D504 => array(0x61)
                    ,0x1D505 => array(0x62), 0x1D507 => array(0x64), 0x1D508 => array(0x65)
                    ,0x1D509 => array(0x66), 0x1D50A => array(0x67), 0x1D50D => array(0x6A)
                    ,0x1D50E => array(0x6B), 0x1D50F => array(0x6C), 0x1D510 => array(0x6D)
                    ,0x1D511 => array(0x6E), 0x1D512 => array(0x6F), 0x1D513 => array(0x70)
                    ,0x1D514 => array(0x71), 0x1D516 => array(0x73), 0x1D517 => array(0x74)
                    ,0x1D518 => array(0x75), 0x1D519 => array(0x76), 0x1D51A => array(0x77)
                    ,0x1D51B => array(0x78), 0x1D51C => array(0x79), 0x1D538 => array(0x61)
                    ,0x1D539 => array(0x62), 0x1D53B => array(0x64), 0x1D53C => array(0x65)
                    ,0x1D53D => array(0x66), 0x1D53E => array(0x67), 0x1D540 => array(0x69)
                    ,0x1D541 => array(0x6A), 0x1D542 => array(0x6B), 0x1D543 => array(0x6C)
                    ,0x1D544 => array(0x6D), 0x1D546 => array(0x6F), 0x1D54A => array(0x73)
                    ,0x1D54B => array(0x74), 0x1D54C => array(0x75), 0x1D54D => array(0x76)
                    ,0x1D54E => array(0x77), 0x1D54F => array(0x78), 0x1D550 => array(0x79)
                    ,0x1D56C => array(0x61), 0x1D56D => array(0x62), 0x1D56E => array(0x63)
                    ,0x1D56F => array(0x64), 0x1D570 => array(0x65), 0x1D571 => array(0x66)
                    ,0x1D572 => array(0x67), 0x1D573 => array(0x68), 0x1D574 => array(0x69)
                    ,0x1D575 => array(0x6A), 0x1D576 => array(0x6B), 0x1D577 => array(0x6C)
                    ,0x1D578 => array(0x6D), 0x1D579 => array(0x6E), 0x1D57A => array(0x6F)
                    ,0x1D57B => array(0x70), 0x1D57C => array(0x71), 0x1D57D => array(0x72)
                    ,0x1D57E => array(0x73), 0x1D57F => array(0x74), 0x1D580 => array(0x75)
                    ,0x1D581 => array(0x76), 0x1D582 => array(0x77), 0x1D583 => array(0x78)
                    ,0x1D584 => array(0x79), 0x1D585 => array(0x7A), 0x1D5A0 => array(0x61)
                    ,0x1D5A1 => array(0x62), 0x1D5A2 => array(0x63), 0x1D5A3 => array(0x64)
                    ,0x1D5A4 => array(0x65), 0x1D5A5 => array(0x66), 0x1D5A6 => array(0x67)
                    ,0x1D5A7 => array(0x68), 0x1D5A8 => array(0x69), 0x1D5A9 => array(0x6A)
                    ,0x1D5AA => array(0x6B), 0x1D5AB => array(0x6C), 0x1D5AC => array(0x6D)
                    ,0x1D5AD => array(0x6E), 0x1D5AE => array(0x6F), 0x1D5AF => array(0x70)
                    ,0x1D5B0 => array(0x71), 0x1D5B1 => array(0x72), 0x1D5B2 => array(0x73)
                    ,0x1D5B3 => array(0x74), 0x1D5B4 => array(0x75), 0x1D5B5 => array(0x76)
                    ,0x1D5B6 => array(0x77), 0x1D5B7 => array(0x78), 0x1D5B8 => array(0x79)
                    ,0x1D5B9 => array(0x7A), 0x1D5D4 => array(0x61), 0x1D5D5 => array(0x62)
                    ,0x1D5D6 => array(0x63), 0x1D5D7 => array(0x64), 0x1D5D8 => array(0x65)
                    ,0x1D5D9 => array(0x66), 0x1D5DA => array(0x67), 0x1D5DB => array(0x68)
                    ,0x1D5DC => array(0x69), 0x1D5DD => array(0x6A), 0x1D5DE => array(0x6B)
                    ,0x1D5DF => array(0x6C), 0x1D5E0 => array(0x6D), 0x1D5E1 => array(0x6E)
                    ,0x1D5E2 => array(0x6F), 0x1D5E3 => array(0x70), 0x1D5E4 => array(0x71)
                    ,0x1D5E5 => array(0x72), 0x1D5E6 => array(0x73), 0x1D5E7 => array(0x74)
                    ,0x1D5E8 => array(0x75), 0x1D5E9 => array(0x76), 0x1D5EA => array(0x77)
                    ,0x1D5EB => array(0x78), 0x1D5EC => array(0x79), 0x1D5ED => array(0x7A)
                    ,0x1D608 => array(0x61), 0x1D609 => array(0x62) ,0x1D60A => array(0x63)
                    ,0x1D60B => array(0x64), 0x1D60C => array(0x65), 0x1D60D => array(0x66)
                    ,0x1D60E => array(0x67), 0x1D60F => array(0x68), 0x1D610 => array(0x69)
                    ,0x1D611 => array(0x6A), 0x1D612 => array(0x6B), 0x1D613 => array(0x6C)
                    ,0x1D614 => array(0x6D), 0x1D615 => array(0x6E), 0x1D616 => array(0x6F)
                    ,0x1D617 => array(0x70), 0x1D618 => array(0x71), 0x1D619 => array(0x72)
                    ,0x1D61A => array(0x73), 0x1D61B => array(0x74), 0x1D61C => array(0x75)
                    ,0x1D61D => array(0x76), 0x1D61E => array(0x77), 0x1D61F => array(0x78)
                    ,0x1D620 => array(0x79), 0x1D621 => array(0x7A), 0x1D63C => array(0x61)
                    ,0x1D63D => array(0x62), 0x1D63E => array(0x63), 0x1D63F => array(0x64)
                    ,0x1D640 => array(0x65), 0x1D641 => array(0x66), 0x1D642 => array(0x67)
                    ,0x1D643 => array(0x68), 0x1D644 => array(0x69), 0x1D645 => array(0x6A)
                    ,0x1D646 => array(0x6B), 0x1D647 => array(0x6C), 0x1D648 => array(0x6D)
                    ,0x1D649 => array(0x6E), 0x1D64A => array(0x6F), 0x1D64B => array(0x70)
                    ,0x1D64C => array(0x71), 0x1D64D => array(0x72), 0x1D64E => array(0x73)
                    ,0x1D64F => array(0x74), 0x1D650 => array(0x75), 0x1D651 => array(0x76)
                    ,0x1D652 => array(0x77), 0x1D653 => array(0x78), 0x1D654 => array(0x79)
                    ,0x1D655 => array(0x7A), 0x1D670 => array(0x61), 0x1D671 => array(0x62)
                    ,0x1D672 => array(0x63), 0x1D673 => array(0x64), 0x1D674 => array(0x65)
                    ,0x1D675 => array(0x66), 0x1D676 => array(0x67), 0x1D677 => array(0x68)
                    ,0x1D678 => array(0x69), 0x1D679 => array(0x6A), 0x1D67A => array(0x6B)
                    ,0x1D67B => array(0x6C), 0x1D67C => array(0x6D), 0x1D67D => array(0x6E)
                    ,0x1D67E => array(0x6F), 0x1D67F => array(0x70), 0x1D680 => array(0x71)
                    ,0x1D681 => array(0x72), 0x1D682 => array(0x73), 0x1D683 => array(0x74)
                    ,0x1D684 => array(0x75), 0x1D685 => array(0x76), 0x1D686 => array(0x77)
                    ,0x1D687 => array(0x78), 0x1D688 => array(0x79), 0x1D689 => array(0x7A)
                    ,0x1D6A8 => array(0x3B1), 0x1D6A9 => array(0x3B2), 0x1D6AA => array(0x3B3)
                    ,0x1D6AB => array(0x3B4), 0x1D6AC => array(0x3B5), 0x1D6AD => array(0x3B6)
                    ,0x1D6AE => array(0x3B7), 0x1D6AF => array(0x3B8), 0x1D6B0 => array(0x3B9)
                    ,0x1D6B1 => array(0x3BA), 0x1D6B2 => array(0x3BB), 0x1D6B3 => array(0x3BC)
                    ,0x1D6B4 => array(0x3BD), 0x1D6B5 => array(0x3BE), 0x1D6B6 => array(0x3BF)
                    ,0x1D6B7 => array(0x3C0), 0x1D6B8 => array(0x3C1), 0x1D6B9 => array(0x3B8)
                    ,0x1D6BA => array(0x3C3), 0x1D6BB => array(0x3C4), 0x1D6BC => array(0x3C5)
                    ,0x1D6BD => array(0x3C6), 0x1D6BE => array(0x3C7), 0x1D6BF => array(0x3C8)
                    ,0x1D6C0 => array(0x3C9), 0x1D6D3 => array(0x3C3), 0x1D6E2 => array(0x3B1)
                    ,0x1D6E3 => array(0x3B2), 0x1D6E4 => array(0x3B3), 0x1D6E5 => array(0x3B4)
                    ,0x1D6E6 => array(0x3B5), 0x1D6E7 => array(0x3B6), 0x1D6E8 => array(0x3B7)
                    ,0x1D6E9 => array(0x3B8), 0x1D6EA => array(0x3B9), 0x1D6EB => array(0x3BA)
                    ,0x1D6EC => array(0x3BB), 0x1D6ED => array(0x3BC), 0x1D6EE => array(0x3BD)
                    ,0x1D6EF => array(0x3BE), 0x1D6F0 => array(0x3BF), 0x1D6F1 => array(0x3C0)
                    ,0x1D6F2 => array(0x3C1), 0x1D6F3 => array(0x3B8) ,0x1D6F4 => array(0x3C3)
                    ,0x1D6F5 => array(0x3C4), 0x1D6F6 => array(0x3C5), 0x1D6F7 => array(0x3C6)
                    ,0x1D6F8 => array(0x3C7), 0x1D6F9 => array(0x3C8) ,0x1D6FA => array(0x3C9)
                    ,0x1D70D => array(0x3C3), 0x1D71C => array(0x3B1), 0x1D71D => array(0x3B2)
                    ,0x1D71E => array(0x3B3), 0x1D71F => array(0x3B4), 0x1D720 => array(0x3B5)
                    ,0x1D721 => array(0x3B6), 0x1D722 => array(0x3B7), 0x1D723 => array(0x3B8)
                    ,0x1D724 => array(0x3B9), 0x1D725 => array(0x3BA), 0x1D726 => array(0x3BB)
                    ,0x1D727 => array(0x3BC), 0x1D728 => array(0x3BD), 0x1D729 => array(0x3BE)
                    ,0x1D72A => array(0x3BF), 0x1D72B => array(0x3C0), 0x1D72C => array(0x3C1)
                    ,0x1D72D => array(0x3B8), 0x1D72E => array(0x3C3), 0x1D72F => array(0x3C4)
                    ,0x1D730 => array(0x3C5), 0x1D731 => array(0x3C6), 0x1D732 => array(0x3C7)
                    ,0x1D733 => array(0x3C8), 0x1D734 => array(0x3C9), 0x1D747 => array(0x3C3)
                    ,0x1D756 => array(0x3B1), 0x1D757 => array(0x3B2), 0x1D758 => array(0x3B3)
                    ,0x1D759 => array(0x3B4), 0x1D75A => array(0x3B5), 0x1D75B => array(0x3B6)
                    ,0x1D75C => array(0x3B7), 0x1D75D => array(0x3B8), 0x1D75E => array(0x3B9)
                    ,0x1D75F => array(0x3BA), 0x1D760 => array(0x3BB), 0x1D761 => array(0x3BC)
                    ,0x1D762 => array(0x3BD), 0x1D763 => array(0x3BE), 0x1D764 => array(0x3BF)
                    ,0x1D765 => array(0x3C0), 0x1D766 => array(0x3C1), 0x1D767 => array(0x3B8)
                    ,0x1D768 => array(0x3C3), 0x1D769 => array(0x3C4), 0x1D76A => array(0x3C5)
                    ,0x1D76B => array(0x3C6), 0x1D76C => array(0x3C7), 0x1D76D => array(0x3C8)
                    ,0x1D76E => array(0x3C9), 0x1D781 => array(0x3C3), 0x1D790 => array(0x3B1)
                    ,0x1D791 => array(0x3B2), 0x1D792 => array(0x3B3), 0x1D793 => array(0x3B4)
                    ,0x1D794 => array(0x3B5), 0x1D795 => array(0x3B6), 0x1D796 => array(0x3B7)
                    ,0x1D797 => array(0x3B8), 0x1D798 => array(0x3B9), 0x1D799 => array(0x3BA)
                    ,0x1D79A => array(0x3BB), 0x1D79B => array(0x3BC), 0x1D79C => array(0x3BD)
                    ,0x1D79D => array(0x3BE), 0x1D79E => array(0x3BF), 0x1D79F => array(0x3C0)
                    ,0x1D7A0 => array(0x3C1), 0x1D7A1 => array(0x3B8), 0x1D7A2 => array(0x3C3)
                    ,0x1D7A3 => array(0x3C4), 0x1D7A4 => array(0x3C5), 0x1D7A5 => array(0x3C6)
                    ,0x1D7A6 => array(0x3C7), 0x1D7A7 => array(0x3C8), 0x1D7A8 => array(0x3C9)
                    ,0x1D7BB => array(0x3C3), 0x3F9   => array(0x3C3), 0x1D2C  => array(0x61)
                    ,0x1D2D  => array(0xE6), 0x1D2E  => array(0x62), 0x1D30  => array(0x64)
                    ,0x1D31  => array(0x65), 0x1D32  => array(0x1DD), 0x1D33  => array(0x67)
                    ,0x1D34  => array(0x68), 0x1D35  => array(0x69), 0x1D36  => array(0x6A)
                    ,0x1D37  => array(0x6B), 0x1D38  => array(0x6C), 0x1D39  => array(0x6D)
                    ,0x1D3A  => array(0x6E), 0x1D3C  => array(0x6F), 0x1D3D  => array(0x223)
                    ,0x1D3E  => array(0x70), 0x1D3F  => array(0x72), 0x1D40  => array(0x74)
                    ,0x1D41  => array(0x75), 0x1D42  => array(0x77), 0x213B  => array(0x66, 0x61, 0x78)
                    ,0x3250  => array(0x70, 0x74, 0x65), 0x32CC  => array(0x68, 0x67)
                    ,0x32CE  => array(0x65, 0x76), 0x32CF  => array(0x6C, 0x74, 0x64)
                    ,0x337A  => array(0x69, 0x75), 0x33DE  => array(0x76, 0x2215, 0x6D)
                    ,0x33DF  => array(0x61, 0x2215, 0x6D)
                    )
            ,'norm_combcls' => array(0x334   => 1,   0x335   => 1,   0x336   => 1,   0x337   => 1
                    ,0x338   => 1,   0x93C   => 7,   0x9BC   => 7,   0xA3C   => 7,   0xABC   => 7
                    ,0xB3C   => 7,   0xCBC   => 7,   0x1037  => 7,   0x3099  => 8,   0x309A  => 8
                    ,0x94D   => 9,   0x9CD   => 9,   0xA4D   => 9,   0xACD   => 9,   0xB4D   => 9
                    ,0xBCD   => 9,   0xC4D   => 9,   0xCCD   => 9,   0xD4D   => 9,   0xDCA   => 9
                    ,0xE3A   => 9,   0xF84   => 9,   0x1039  => 9,   0x1714  => 9,   0x1734  => 9
                    ,0x17D2  => 9,   0x5B0   => 10,  0x5B1   => 11,  0x5B2   => 12,  0x5B3   => 13
                    ,0x5B4   => 14,  0x5B5   => 15,  0x5B6   => 16,  0x5B7   => 17,  0x5B8   => 18
                    ,0x5B9   => 19,  0x5BB   => 20,  0x5Bc   => 21,  0x5BD   => 22,  0x5BF   => 23
                    ,0x5C1   => 24,  0x5C2   => 25,  0xFB1E  => 26,  0x64B   => 27,  0x64C   => 28
                    ,0x64D   => 29,  0x64E   => 30,  0x64F   => 31,  0x650   => 32,  0x651   => 33
                    ,0x652   => 34,  0x670   => 35,  0x711   => 36,  0xC55   => 84,  0xC56   => 91
                    ,0xE38   => 103, 0xE39   => 103, 0xE48   => 107, 0xE49   => 107, 0xE4A   => 107
                    ,0xE4B   => 107, 0xEB8   => 118, 0xEB9   => 118, 0xEC8   => 122, 0xEC9   => 122
                    ,0xECA   => 122, 0xECB   => 122, 0xF71   => 129, 0xF72   => 130, 0xF7A   => 130
                    ,0xF7B   => 130, 0xF7C   => 130, 0xF7D   => 130, 0xF80   => 130, 0xF74   => 132
                    ,0x321   => 202, 0x322   => 202, 0x327   => 202, 0x328   => 202, 0x31B   => 216
                    ,0xF39   => 216, 0x1D165 => 216, 0x1D166 => 216, 0x1D16E => 216, 0x1D16F => 216
                    ,0x1D170 => 216, 0x1D171 => 216, 0x1D172 => 216, 0x302A  => 218, 0x316   => 220
                    ,0x317   => 220, 0x318   => 220, 0x319   => 220, 0x31C   => 220, 0x31D   => 220
                    ,0x31E   => 220, 0x31F   => 220, 0x320   => 220, 0x323   => 220, 0x324   => 220
                    ,0x325   => 220, 0x326   => 220, 0x329   => 220, 0x32A   => 220, 0x32B   => 220
                    ,0x32C   => 220, 0x32D   => 220, 0x32E   => 220, 0x32F   => 220, 0x330   => 220
                    ,0x331   => 220, 0x332   => 220, 0x333   => 220, 0x339   => 220, 0x33A   => 220
                    ,0x33B   => 220, 0x33C   => 220, 0x347   => 220, 0x348   => 220, 0x349   => 220
                    ,0x34D   => 220, 0x34E   => 220, 0x353   => 220, 0x354   => 220, 0x355   => 220
                    ,0x356   => 220, 0x591   => 220, 0x596   => 220, 0x59B   => 220, 0x5A3   => 220
                    ,0x5A4   => 220, 0x5A5   => 220, 0x5A6   => 220, 0x5A7   => 220, 0x5AA   => 220
                    ,0x655   => 220, 0x656   => 220, 0x6E3   => 220, 0x6EA   => 220, 0x6ED   => 220
                    ,0x731   => 220, 0x734   => 220, 0x737   => 220, 0x738   => 220, 0x739   => 220
                    ,0x73B   => 220, 0x73C   => 220, 0x73E   => 220, 0x742   => 220, 0x744   => 220
                    ,0x746   => 220, 0x748   => 220, 0x952   => 220, 0xF18   => 220, 0xF19   => 220
                    ,0xF35   => 220, 0xF37   => 220, 0xFC6   => 220, 0x193B  => 220, 0x20E8  => 220
                    ,0x1D17B => 220, 0x1D17C => 220, 0x1D17D => 220, 0x1D17E => 220, 0x1D17F => 220
                    ,0x1D180 => 220, 0x1D181 => 220, 0x1D182 => 220, 0x1D18A => 220, 0x1D18B => 220
                    ,0x59A   => 222, 0x5AD   => 222, 0x1929  => 222, 0x302D  => 222, 0x302E  => 224
                    ,0x302F  => 224, 0x1D16D => 226, 0x5AE   => 228, 0x18A9  => 228, 0x302B  => 228
                    ,0x300   => 230, 0x301   => 230, 0x302   => 230, 0x303   => 230, 0x304   => 230
                    ,0x305   => 230, 0x306   => 230, 0x307   => 230, 0x308   => 230, 0x309   => 230
                    ,0x30A   => 230, 0x30B   => 230, 0x30C   => 230, 0x30D   => 230, 0x30E   => 230
                    ,0x30F   => 230, 0x310   => 230, 0x311   => 230, 0x312   => 230, 0x313   => 230
                    ,0x314   => 230, 0x33D   => 230, 0x33E   => 230, 0x33F   => 230, 0x340   => 230
                    ,0x341   => 230, 0x342   => 230, 0x343   => 230, 0x344   => 230, 0x346   => 230
                    ,0x34A   => 230, 0x34B   => 230, 0x34C   => 230, 0x350   => 230, 0x351   => 230
                    ,0x352   => 230, 0x357   => 230, 0x363   => 230, 0x364   => 230, 0x365   => 230
                    ,0x366   => 230, 0x367   => 230, 0x368   => 230, 0x369   => 230, 0x36A   => 230
                    ,0x36B   => 230, 0x36C   => 230, 0x36D   => 230, 0x36E   => 230, 0x36F   => 230
                    ,0x483   => 230, 0x484   => 230, 0x485   => 230, 0x486   => 230, 0x592   => 230
                    ,0x593   => 230, 0x594   => 230, 0x595   => 230, 0x597   => 230, 0x598   => 230
                    ,0x599   => 230, 0x59C   => 230, 0x59D   => 230, 0x59E   => 230, 0x59F   => 230
                    ,0x5A0   => 230, 0x5A1   => 230, 0x5A8   => 230, 0x5A9   => 230, 0x5AB   => 230
                    ,0x5AC   => 230, 0x5AF   => 230, 0x5C4   => 230, 0x610   => 230, 0x611   => 230
                    ,0x612   => 230, 0x613   => 230, 0x614   => 230, 0x615   => 230, 0x653   => 230
                    ,0x654   => 230, 0x657   => 230, 0x658   => 230, 0x6D6   => 230, 0x6D7   => 230
                    ,0x6D8   => 230, 0x6D9   => 230, 0x6DA   => 230, 0x6DB   => 230, 0x6DC   => 230
                    ,0x6DF   => 230, 0x6E0   => 230, 0x6E1   => 230, 0x6E2   => 230, 0x6E4   => 230
                    ,0x6E7   => 230, 0x6E8   => 230, 0x6EB   => 230, 0x6EC   => 230, 0x730   => 230
                    ,0x732   => 230, 0x733   => 230, 0x735   => 230, 0x736   => 230, 0x73A   => 230
                    ,0x73D   => 230, 0x73F   => 230, 0x740   => 230, 0x741   => 230, 0x743   => 230
                    ,0x745   => 230, 0x747   => 230, 0x749   => 230, 0x74A   => 230, 0x951   => 230
                    ,0x953   => 230, 0x954   => 230, 0xF82   => 230, 0xF83   => 230, 0xF86   => 230
                    ,0xF87   => 230, 0x170D  => 230, 0x193A  => 230, 0x20D0  => 230, 0x20D1  => 230
                    ,0x20D4  => 230, 0x20D5  => 230, 0x20D6  => 230, 0x20D7  => 230, 0x20DB  => 230
                    ,0x20DC  => 230, 0x20E1  => 230, 0x20E7  => 230, 0x20E9  => 230, 0xFE20  => 230
                    ,0xFE21  => 230, 0xFE22  => 230, 0xFE23  => 230, 0x1D185 => 230, 0x1D186 => 230
                    ,0x1D187 => 230, 0x1D189 => 230, 0x1D188 => 230, 0x1D1AA => 230, 0x1D1AB => 230
                    ,0x1D1AC => 230, 0x1D1AD => 230, 0x315   => 232, 0x31A   => 232, 0x302C  => 232
                    ,0x35F   => 233, 0x362   => 233, 0x35D   => 234, 0x35E   => 234, 0x360   => 234
                    ,0x361   => 234, 0x345   => 240
                    )
            );
}
?>56   44180|/shs.parser/classes/phpQuery/phpQuery.php|dc5813b3<?php
/**
 * phpQuery is a server-side, chainable, CSS3 selector driven
 * Document Object Model (DOM) API based on jQuery JavaScript Library.
 *
 * @version 0.9.5
 * @link http://code.google.com/p/phpquery/
 * @link http://phpquery-library.blogspot.com/
 * @link http://jquery.com/
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @license http://www.opensource.org/licenses/mit-license.php MIT License
 * @package phpQuery
 */

// class names for instanceof
// TODO move them as class constants into phpQuery
define('DOMDOCUMENT', 'DOMDocument');
define('DOMELEMENT', 'DOMElement');
define('DOMNODELIST', 'DOMNodeList');
define('DOMNODE', 'DOMNode');
require_once(dirname(__FILE__).'/phpQuery/DOMEvent.php');
require_once(dirname(__FILE__).'/phpQuery/DOMDocumentWrapper.php');
require_once(dirname(__FILE__).'/phpQuery/phpQueryEvents.php');
require_once(dirname(__FILE__).'/phpQuery/Callback.php');
require_once(dirname(__FILE__).'/phpQuery/phpQueryObject.php');
require_once(dirname(__FILE__).'/phpQuery/compat/mbstring.php');
/**
 * Static namespace for phpQuery functions.
 *
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 */
abstract class phpQuery {
	/**
	 * XXX: Workaround for mbstring problems 
	 * 
	 * @var bool
	 */
	public static $mbstringSupport = true;
	public static $debug = false;
	public static $documents = array();
	public static $defaultDocumentID = null;
//	public static $defaultDoctype = 'html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"';
	/**
	 * Applies only to HTML.
	 *
	 * @var unknown_type
	 */
	public static $defaultDoctype = '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">';
	public static $defaultCharset = 'UTF-8';
	/**
	 * Static namespace for plugins.
	 *
	 * @var object
	 */
	public static $plugins = array();
	/**
	 * List of loaded plugins.
	 *
	 * @var unknown_type
	 */
	public static $pluginsLoaded = array();
	public static $pluginsMethods = array();
	public static $pluginsStaticMethods = array();
	public static $extendMethods = array();
	/**
	 * @TODO implement
	 */
	public static $extendStaticMethods = array();
	/**
	 * Hosts allowed for AJAX connections.
	 * Dot '.' means $_SERVER['HTTP_HOST'] (if any).
	 *
	 * @var array
	 */
	public static $ajaxAllowedHosts = array(
		'.'
	);
	/**
	 * AJAX settings.
	 *
	 * @var array
	 * XXX should it be static or not ?
	 */
	public static $ajaxSettings = array(
		'url' => '',//TODO
		'global' => true,
		'type' => "GET",
		'timeout' => null,
		'contentType' => "application/x-www-form-urlencoded",
		'processData' => true,
//		'async' => true,
		'data' => null,
		'username' => null,
		'password' => null,
		'accepts' => array(
			'xml' => "application/xml, text/xml",
			'html' => "text/html",
			'script' => "text/javascript, application/javascript",
			'json' => "application/json, text/javascript",
			'text' => "text/plain",
			'_default' => "*/*"
		)
	);
	public static $lastModified = null;
	public static $active = 0;
	public static $dumpCount = 0;
	/**
	 * Multi-purpose function.
	 * Use pq() as shortcut.
	 *
	 * In below examples, $pq is any result of pq(); function.
	 *
	 * 1. Import markup into existing document (without any attaching):
	 * - Import into selected document:
	 *   pq('<div/>')				// DOESNT accept text nodes at beginning of input string !
	 * - Import into document with ID from $pq->getDocumentID():
	 *   pq('<div/>', $pq->getDocumentID())
	 * - Import into same document as DOMNode belongs to:
	 *   pq('<div/>', DOMNode)
	 * - Import into document from phpQuery object:
	 *   pq('<div/>', $pq)
	 *
	 * 2. Run query:
	 * - Run query on last selected document:
	 *   pq('div.myClass')
	 * - Run query on document with ID from $pq->getDocumentID():
	 *   pq('div.myClass', $pq->getDocumentID())
	 * - Run query on same document as DOMNode belongs to and use node(s)as root for query:
	 *   pq('div.myClass', DOMNode)
	 * - Run query on document from phpQuery object
	 *   and use object's stack as root node(s) for query:
	 *   pq('div.myClass', $pq)
	 *
	 * @param string|DOMNode|DOMNodeList|array	$arg1	HTML markup, CSS Selector, DOMNode or array of DOMNodes
	 * @param string|phpQueryObject|DOMNode	$context	DOM ID from $pq->getDocumentID(), phpQuery object (determines also query root) or DOMNode (determines also query root)
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery|QueryTemplatesPhpQuery|false
   * phpQuery object or false in case of error.
	 */
	public static function pq($arg1, $context = null) {
		if ($arg1 instanceof DOMNODE && ! isset($context)) {
			foreach(phpQuery::$documents as $documentWrapper) {
				$compare = $arg1 instanceof DOMDocument
					? $arg1 : $arg1->ownerDocument;
				if ($documentWrapper->document->isSameNode($compare))
					$context = $documentWrapper->id;
			}
		}
		if (! $context) {
			$domId = self::$defaultDocumentID;
			if (! $domId)
				throw new Exception("Can't use last created DOM, because there isn't any. Use phpQuery::newDocument() first.");
//		} else if (is_object($context) && ($context instanceof PHPQUERY || is_subclass_of($context, 'phpQueryObject')))
		} else if (is_object($context) && $context instanceof phpQueryObject)
			$domId = $context->getDocumentID();
		else if ($context instanceof DOMDOCUMENT) {
			$domId = self::getDocumentID($context);
			if (! $domId) {
				//throw new Exception('Orphaned DOMDocument');
				$domId = self::newDocument($context)->getDocumentID();
			}
		} else if ($context instanceof DOMNODE) {
			$domId = self::getDocumentID($context);
			if (! $domId) {
				throw new Exception('Orphaned DOMNode');
//				$domId = self::newDocument($context->ownerDocument);
			}
		} else
			$domId = $context;
		if ($arg1 instanceof phpQueryObject) {
//		if (is_object($arg1) && (get_class($arg1) == 'phpQueryObject' || $arg1 instanceof PHPQUERY || is_subclass_of($arg1, 'phpQueryObject'))) {
			/**
			 * Return $arg1 or import $arg1 stack if document differs:
			 * pq(pq('<div/>'))
			 */
			if ($arg1->getDocumentID() == $domId)
				return $arg1;
			$class = get_class($arg1);
			// support inheritance by passing old object to overloaded constructor
			$phpQuery = $class != 'phpQuery'
				? new $class($arg1, $domId)
				: new phpQueryObject($domId);
			$phpQuery->elements = array();
			foreach($arg1->elements as $node)
				$phpQuery->elements[] = $phpQuery->document->importNode($node, true);
			return $phpQuery;
		} else if ($arg1 instanceof DOMNODE || (is_array($arg1) && isset($arg1[0]) && $arg1[0] instanceof DOMNODE)) {
			/*
			 * Wrap DOM nodes with phpQuery object, import into document when needed:
			 * pq(array($domNode1, $domNode2))
			 */
			$phpQuery = new phpQueryObject($domId);
			if (!($arg1 instanceof DOMNODELIST) && ! is_array($arg1))
				$arg1 = array($arg1);
			$phpQuery->elements = array();
			foreach($arg1 as $node) {
				$sameDocument = $node->ownerDocument instanceof DOMDOCUMENT
					&& ! $node->ownerDocument->isSameNode($phpQuery->document);
				$phpQuery->elements[] = $sameDocument
					? $phpQuery->document->importNode($node, true)
					: $node;
			}
			return $phpQuery;
		} else if (self::isMarkup($arg1)) {
			/**
			 * Import HTML:
			 * pq('<div/>')
			 */
			$phpQuery = new phpQueryObject($domId);
			return $phpQuery->newInstance(
				$phpQuery->documentWrapper->import($arg1)
			);
		} else {
			/**
			 * Run CSS query:
			 * pq('div.myClass')
			 */
			$phpQuery = new phpQueryObject($domId);
//			if ($context && ($context instanceof PHPQUERY || is_subclass_of($context, 'phpQueryObject')))
			if ($context && $context instanceof phpQueryObject)
				$phpQuery->elements = $context->elements;
			else if ($context && $context instanceof DOMNODELIST) {
				$phpQuery->elements = array();
				foreach($context as $node)
					$phpQuery->elements[] = $node;
			} else if ($context && $context instanceof DOMNODE)
				$phpQuery->elements = array($context);
			return $phpQuery->find($arg1);
		}
	}
	/**
	 * Sets default document to $id. Document has to be loaded prior
	 * to using this method.
	 * $id can be retrived via getDocumentID() or getDocumentIDRef().
	 *
	 * @param unknown_type $id
	 */
	public static function selectDocument($id) {
		$id = self::getDocumentID($id);
		self::debug("Selecting document '$id' as default one");
		self::$defaultDocumentID = self::getDocumentID($id);
	}
	/**
	 * Returns document with id $id or last used as phpQueryObject.
	 * $id can be retrived via getDocumentID() or getDocumentIDRef().
	 * Chainable.
	 *
	 * @see phpQuery::selectDocument()
	 * @param unknown_type $id
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function getDocument($id = null) {
		if ($id)
			phpQuery::selectDocument($id);
		else
			$id = phpQuery::$defaultDocumentID;
		return new phpQueryObject($id);
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocument($markup = null, $contentType = null) {
		if (! $markup)
			$markup = '';
		$documentID = phpQuery::createDocumentWrapper($markup, $contentType);
		return new phpQueryObject($documentID);
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentHTML($markup = null, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocument($markup, "text/html{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentXML($markup = null, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocument($markup, "text/xml{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentXHTML($markup = null, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocument($markup, "application/xhtml+xml{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentPHP($markup = null, $contentType = "text/html") {
		// TODO pass charset to phpToMarkup if possible (use DOMDocumentWrapper function)
		$markup = phpQuery::phpToMarkup($markup, self::$defaultCharset);
		return self::newDocument($markup, $contentType);
	}
	public static function phpToMarkup($php, $charset = 'utf-8') {
		$regexes = array(
			'@(<(?!\\?)(?:[^>]|\\?>)+\\w+\\s*=\\s*)(\')([^\']*)<'.'?php?(.*?)(?:\\?>)([^\']*)\'@s',
			'@(<(?!\\?)(?:[^>]|\\?>)+\\w+\\s*=\\s*)(")([^"]*)<'.'?php?(.*?)(?:\\?>)([^"]*)"@s',
		);
		foreach($regexes as $regex)
			while (preg_match($regex, $php, $matches)) {
				$php = preg_replace_callback(
					$regex,
//					create_function('$m, $charset = "'.$charset.'"',
//						'return $m[1].$m[2]
//							.htmlspecialchars("<"."?php".$m[4]."?".">", ENT_QUOTES|ENT_NOQUOTES, $charset)
//							.$m[5].$m[2];'
//					),
					array('phpQuery', '_phpToMarkupCallback'),
					$php
				);
			}
		$regex = '@(^|>[^<]*)+?(<\?php(.*?)(\?>))@s';
//preg_match_all($regex, $php, $matches);
//var_dump($matches);
		$php = preg_replace($regex, '\\1<php><!-- \\3 --></php>', $php);
		return $php;
	}
	public static function _phpToMarkupCallback($php, $charset = 'utf-8') {
		return $m[1].$m[2]
			.htmlspecialchars("<"."?php".$m[4]."?".">", ENT_QUOTES|ENT_NOQUOTES, $charset)
			.$m[5].$m[2];
	}
	public static function _markupToPHPCallback($m) {
		return "<"."?php ".htmlspecialchars_decode($m[1])." ?".">";
	}
	/**
	 * Converts document markup containing PHP code generated by phpQuery::php()
	 * into valid (executable) PHP code syntax.
	 *
	 * @param string|phpQueryObject $content
	 * @return string PHP code.
	 */
	public static function markupToPHP($content) {
		if ($content instanceof phpQueryObject)
			$content = $content->markupOuter();
		/* <php>...</php> to <?php...? > */
		$content = preg_replace_callback(
			'@<php>\s*<!--(.*?)-->\s*</php>@s',
//			create_function('$m',
//				'return "<'.'?php ".htmlspecialchars_decode($m[1])." ?'.'>";'
//			),
			array('phpQuery', '_markupToPHPCallback'),
			$content
		);
		/* <node attr='< ?php ? >'> extra space added to save highlighters */
		$regexes = array(
			'@(<(?!\\?)(?:[^>]|\\?>)+\\w+\\s*=\\s*)(\')([^\']*)(?:&lt;|%3C)\\?(?:php)?(.*?)(?:\\?(?:&gt;|%3E))([^\']*)\'@s',
			'@(<(?!\\?)(?:[^>]|\\?>)+\\w+\\s*=\\s*)(")([^"]*)(?:&lt;|%3C)\\?(?:php)?(.*?)(?:\\?(?:&gt;|%3E))([^"]*)"@s',
		);
		foreach($regexes as $regex)
			while (preg_match($regex, $content))
				$content = preg_replace_callback(
					$regex,
					create_function('$m',
						'return $m[1].$m[2].$m[3]."<?php "
							.str_replace(
								array("%20", "%3E", "%09", "&#10;", "&#9;", "%7B", "%24", "%7D", "%22", "%5B", "%5D"),
								array(" ", ">", "	", "\n", "	", "{", "$", "}", \'"\', "[", "]"),
								htmlspecialchars_decode($m[4])
							)
							." ?>".$m[5].$m[2];'
					),
					$content
				);
		return $content;
	}
	/**
	 * Creates new document from file $file.
	 * Chainable.
	 *
	 * @param string $file URLs allowed. See File wrapper page at php.net for more supported sources.
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentFile($file, $contentType = null) {
		$documentID = self::createDocumentWrapper(
			file_get_contents($file), $contentType
		);
		return new phpQueryObject($documentID);
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentFileHTML($file, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocumentFile($file, "text/html{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentFileXML($file, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocumentFile($file, "text/xml{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentFileXHTML($file, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocumentFile($file, "application/xhtml+xml{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentFilePHP($file, $contentType = null) {
		return self::newDocumentPHP(file_get_contents($file), $contentType);
	}
	/**
	 * Reuses existing DOMDocument object.
	 * Chainable.
	 *
	 * @param $document DOMDocument
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @TODO support DOMDocument
	 */
	public static function loadDocument($document) {
		// TODO
		die('TODO loadDocument');
	}
	/**
	 * Enter description here...
	 *
	 * @param unknown_type $html
	 * @param unknown_type $domId
	 * @return unknown New DOM ID
	 * @todo support PHP tags in input
	 * @todo support passing DOMDocument object from self::loadDocument
	 */
	protected static function createDocumentWrapper($html, $contentType = null, $documentID = null) {
		if (function_exists('domxml_open_mem'))
			throw new Exception("Old PHP4 DOM XML extension detected. phpQuery won't work until this extension is enabled.");
//		$id = $documentID
//			? $documentID
//			: md5(microtime());
		$document = null;
		if ($html instanceof DOMDOCUMENT) {
			if (self::getDocumentID($html)) {
				// document already exists in phpQuery::$documents, make a copy
				$document = clone $html;
			} else {
				// new document, add it to phpQuery::$documents
				$wrapper = new DOMDocumentWrapper($html, $contentType, $documentID);
			}
		} else {
			$wrapper = new DOMDocumentWrapper($html, $contentType, $documentID);
		}
//		$wrapper->id = $id;
		// bind document
		phpQuery::$documents[$wrapper->id] = $wrapper;
		// remember last loaded document
		phpQuery::selectDocument($wrapper->id);
		return $wrapper->id;
	}
	/**
	 * Extend class namespace.
	 *
	 * @param string|array $target
	 * @param array $source
	 * @TODO support string $source
	 * @return unknown_type
	 */
	public static function extend($target, $source) {
		switch($target) {
			case 'phpQueryObject':
				$targetRef = &self::$extendMethods;
				$targetRef2 = &self::$pluginsMethods;
				break;
			case 'phpQuery':
				$targetRef = &self::$extendStaticMethods;
				$targetRef2 = &self::$pluginsStaticMethods;
				break;
			default:
				throw new Exception("Unsupported \$target type");
		}
		if (is_string($source))
			$source = array($source => $source);
		foreach($source as $method => $callback) {
			if (isset($targetRef[$method])) {
//				throw new Exception
				self::debug("Duplicate method '{$method}', can\'t extend '{$target}'");
				continue;
			}
			if (isset($targetRef2[$method])) {
//				throw new Exception
				self::debug("Duplicate method '{$method}' from plugin '{$targetRef2[$method]}',"
					." can\'t extend '{$target}'");
				continue;
			}
			$targetRef[$method] = $callback;
		}
		return true;
	}
	/**
	 * Extend phpQuery with $class from $file.
	 *
	 * @param string $class Extending class name. Real class name can be prepended phpQuery_.
	 * @param string $file Filename to include. Defaults to "{$class}.php".
	 */
	public static function plugin($class, $file = null) {
		// TODO $class checked agains phpQuery_$class
//		if (strpos($class, 'phpQuery') === 0)
//			$class = substr($class, 8);
		if (in_array($class, self::$pluginsLoaded))
			return true;
		if (! $file)
			$file = $class.'.php';
		$objectClassExists = class_exists('phpQueryObjectPlugin_'.$class);
		$staticClassExists = class_exists('phpQueryPlugin_'.$class);
		if (! $objectClassExists && ! $staticClassExists)
			require_once($file);
		self::$pluginsLoaded[] = $class;
		// static methods
		if (class_exists('phpQueryPlugin_'.$class)) {
			$realClass = 'phpQueryPlugin_'.$class;
			$vars = get_class_vars($realClass);
			$loop = isset($vars['phpQueryMethods'])
				&& ! is_null($vars['phpQueryMethods'])
				? $vars['phpQueryMethods']
				: get_class_methods($realClass);
			foreach($loop as $method) {
				if ($method == '__initialize')
					continue;
				if (! is_callable(array($realClass, $method)))
					continue;
				if (isset(self::$pluginsStaticMethods[$method])) {
					throw new Exception("Duplicate method '{$method}' from plugin '{$c}' conflicts with same method from plugin '".self::$pluginsStaticMethods[$method]."'");
					return;
				}
				self::$pluginsStaticMethods[$method] = $class;
			}
			if (method_exists($realClass, '__initialize'))
				call_user_func_array(array($realClass, '__initialize'), array());
		}
		// object methods
		if (class_exists('phpQueryObjectPlugin_'.$class)) {
			$realClass = 'phpQueryObjectPlugin_'.$class;
			$vars = get_class_vars($realClass);
			$loop = isset($vars['phpQueryMethods'])
				&& ! is_null($vars['phpQueryMethods'])
				? $vars['phpQueryMethods']
				: get_class_methods($realClass);
			foreach($loop as $method) {
				if (! is_callable(array($realClass, $method)))
					continue;
				if (isset(self::$pluginsMethods[$method])) {
					throw new Exception("Duplicate method '{$method}' from plugin '{$c}' conflicts with same method from plugin '".self::$pluginsMethods[$method]."'");
					continue;
				}
				self::$pluginsMethods[$method] = $class;
			}
		}
		return true;
	}
	/**
	 * Unloades all or specified document from memory.
	 *
	 * @param mixed $documentID @see phpQuery::getDocumentID() for supported types.
	 */
	public static function unloadDocuments($id = null) {
		if (isset($id)) {
			if ($id = self::getDocumentID($id))
				unset(phpQuery::$documents[$id]);
		} else {
			foreach(phpQuery::$documents as $k => $v) {
				unset(phpQuery::$documents[$k]);
			}
		}
	}
	/**
	 * Parses phpQuery object or HTML result against PHP tags and makes them active.
	 *
	 * @param phpQuery|string $content
	 * @deprecated
	 * @return string
	 */
	public static function unsafePHPTags($content) {
		return self::markupToPHP($content);
	}
	public static function DOMNodeListToArray($DOMNodeList) {
		$array = array();
		if (! $DOMNodeList)
			return $array;
		foreach($DOMNodeList as $node)
			$array[] = $node;
		return $array;
	}
	/**
	 * Checks if $input is HTML string, which has to start with '<'.
	 *
	 * @deprecated
	 * @param String $input
	 * @return Bool
	 * @todo still used ?
	 */
	public static function isMarkup($input) {
		return ! is_array($input) && substr(trim($input), 0, 1) == '<';
	}
	public static function debug($text) {
		if (self::$debug)
			print var_dump($text);
	}
	/**
	 * Make an AJAX request.
	 *
	 * @param array See $options http://docs.jquery.com/Ajax/jQuery.ajax#toptions
	 * Additional options are:
	 * 'document' - document for global events, @see phpQuery::getDocumentID()
	 * 'referer' - implemented
	 * 'requested_with' - TODO; not implemented (X-Requested-With)
	 * @return Zend_Http_Client
	 * @link http://docs.jquery.com/Ajax/jQuery.ajax
	 *
	 * @TODO $options['cache']
	 * @TODO $options['processData']
	 * @TODO $options['xhr']
	 * @TODO $options['data'] as string
	 * @TODO XHR interface
	 */
	public static function ajax($options = array(), $xhr = null) {
		$options = array_merge(
			self::$ajaxSettings, $options
		);
		$documentID = isset($options['document'])
			? self::getDocumentID($options['document'])
			: null;
		if ($xhr) {
			// reuse existing XHR object, but clean it up
			$client = $xhr;
//			$client->setParameterPost(null);
//			$client->setParameterGet(null);
			$client->setAuth(false);
			$client->setHeaders("If-Modified-Since", null);
			$client->setHeaders("Referer", null);
			$client->resetParameters();
		} else {
			// create new XHR object
			require_once('Zend/Http/Client.php');
			$client = new Zend_Http_Client();
			$client->setCookieJar();
		}
		if (isset($options['timeout']))
			$client->setConfig(array(
				'timeout'      => $options['timeout'],
			));
//			'maxredirects' => 0,
		foreach(self::$ajaxAllowedHosts as $k => $host)
			if ($host == '.' && isset($_SERVER['HTTP_HOST']))
				self::$ajaxAllowedHosts[$k] = $_SERVER['HTTP_HOST'];
		$host = parse_url($options['url'], PHP_URL_HOST);
		if (! in_array($host, self::$ajaxAllowedHosts)) {
			throw new Exception("Request not permitted, host '$host' not present in "
				."phpQuery::\$ajaxAllowedHosts");
		}
		// JSONP
		$jsre = "/=\\?(&|$)/";
		if (isset($options['dataType']) && $options['dataType'] == 'jsonp') {
			$jsonpCallbackParam = $options['jsonp']
				? $options['jsonp'] : 'callback';
			if (strtolower($options['type']) == 'get') {
				if (! preg_match($jsre, $options['url'])) {
					$sep = strpos($options['url'], '?')
						? '&' : '?';
					$options['url'] .= "$sep$jsonpCallbackParam=?";
				}
			} else if ($options['data']) {
				$jsonp = false;
				foreach($options['data'] as $n => $v) {
					if ($v == '?')
						$jsonp = true;
				}
				if (! $jsonp) {
					$options['data'][$jsonpCallbackParam] = '?';
				}
			}
			$options['dataType'] = 'json';
		}
		if (isset($options['dataType']) && $options['dataType'] == 'json') {
			$jsonpCallback = 'json_'.md5(microtime());
			$jsonpData = $jsonpUrl = false;
			if ($options['data']) {
				foreach($options['data'] as $n => $v) {
					if ($v == '?')
						$jsonpData = $n;
				}
			}
			if (preg_match($jsre, $options['url']))
				$jsonpUrl = true;
			if ($jsonpData !== false || $jsonpUrl) {
				// remember callback name for httpData()
				$options['_jsonp'] = $jsonpCallback;
				if ($jsonpData !== false)
					$options['data'][$jsonpData] = $jsonpCallback;
				if ($jsonpUrl)
					$options['url'] = preg_replace($jsre, "=$jsonpCallback\\1", $options['url']);
			}
		}
		$client->setUri($options['url']);
		$client->setMethod(strtoupper($options['type']));
		if (isset($options['referer']) && $options['referer'])
			$client->setHeaders('Referer', $options['referer']);
		$client->setHeaders(array(
//			'content-type' => $options['contentType'],
			'User-Agent' => 'Mozilla/5.0 (X11; U; Linux x86; en-US; rv:1.9.0.5) Gecko'
				 .'/2008122010 Firefox/3.0.5',
	 		// TODO custom charset
			'Accept-Charset' => 'ISO-8859-1,utf-8;q=0.7,*;q=0.7',
// 	 		'Connection' => 'keep-alive',
// 			'Accept' => 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
	 		'Accept-Language' => 'en-us,en;q=0.5',
		));
		if ($options['username'])
			$client->setAuth($options['username'], $options['password']);
		if (isset($options['ifModified']) && $options['ifModified'])
			$client->setHeaders("If-Modified-Since",
				self::$lastModified
					? self::$lastModified
					: "Thu, 01 Jan 1970 00:00:00 GMT"
			);
		$client->setHeaders("Accept",
			isset($options['dataType'])
			&& isset(self::$ajaxSettings['accepts'][ $options['dataType'] ])
				? self::$ajaxSettings['accepts'][ $options['dataType'] ].", */*"
				: self::$ajaxSettings['accepts']['_default']
		);
		// TODO $options['processData']
		if ($options['data'] instanceof phpQueryObject) {
			$serialized = $options['data']->serializeArray($options['data']);
			$options['data'] = array();
			foreach($serialized as $r)
				$options['data'][ $r['name'] ] = $r['value'];
		}
		if (strtolower($options['type']) == 'get') {
			$client->setParameterGet($options['data']);
		} else if (strtolower($options['type']) == 'post') {
			$client->setEncType($options['contentType']);
			$client->setParameterPost($options['data']);
		}
		if (self::$active == 0 && $options['global'])
			phpQueryEvents::trigger($documentID, 'ajaxStart');
		self::$active++;
		// beforeSend callback
		if (isset($options['beforeSend']) && $options['beforeSend'])
			phpQuery::callbackRun($options['beforeSend'], array($client));
		// ajaxSend event
		if ($options['global'])
			phpQueryEvents::trigger($documentID, 'ajaxSend', array($client, $options));
		if (phpQuery::$debug) {
			self::debug("{$options['type']}: {$options['url']}\n");
			self::debug("Options: <pre>".var_export($options, true)."</pre>\n");
//			if ($client->getCookieJar())
//				self::debug("Cookies: <pre>".var_export($client->getCookieJar()->getMatchingCookies($options['url']), true)."</pre>\n");
		}
		// request
		$response = $client->request();
		if (phpQuery::$debug) {
			self::debug('Status: '.$response->getStatus().' / '.$response->getMessage());
			self::debug($client->getLastRequest());
			self::debug($response->getHeaders());
		}
		if ($response->isSuccessful()) {
			// XXX tempolary
			self::$lastModified = $response->getHeader('Last-Modified');
			$data = self::httpData($response->getBody(), $options['dataType'], $options);
			if (isset($options['success']) && $options['success'])
				phpQuery::callbackRun($options['success'], array($data, $response->getStatus(), $options));
			if ($options['global'])
				phpQueryEvents::trigger($documentID, 'ajaxSuccess', array($client, $options));
		} else {
			if (isset($options['error']) && $options['error'])
				phpQuery::callbackRun($options['error'], array($client, $response->getStatus(), $response->getMessage()));
			if ($options['global'])
				phpQueryEvents::trigger($documentID, 'ajaxError', array($client, /*$response->getStatus(),*/$response->getMessage(), $options));
		}
		if (isset($options['complete']) && $options['complete'])
			phpQuery::callbackRun($options['complete'], array($client, $response->getStatus()));
		if ($options['global'])
			phpQueryEvents::trigger($documentID, 'ajaxComplete', array($client, $options));
		if ($options['global'] && ! --self::$active)
			phpQueryEvents::trigger($documentID, 'ajaxStop');
		return $client;
//		if (is_null($domId))
//			$domId = self::$defaultDocumentID ? self::$defaultDocumentID : false;
//		return new phpQueryAjaxResponse($response, $domId);
	}
	protected static function httpData($data, $type, $options) {
		if (isset($options['dataFilter']) && $options['dataFilter'])
			$data = self::callbackRun($options['dataFilter'], array($data, $type));
		if (is_string($data)) {
			if ($type == "json") {
				if (isset($options['_jsonp']) && $options['_jsonp']) {
					$data = preg_replace('/^\s*\w+\((.*)\)\s*$/s', '$1', $data);
				}
				$data = self::parseJSON($data);
			}
		}
		return $data;
	}
	/**
	 * Enter description here...
	 *
	 * @param array|phpQuery $data
	 *
	 */
	public static function param($data) {
		return http_build_query($data, null, '&');
	}
	public static function get($url, $data = null, $callback = null, $type = null) {
		if (!is_array($data)) {
			$callback = $data;
			$data = null;
		}
		// TODO some array_values on this shit
		return phpQuery::ajax(array(
			'type' => 'GET',
			'url' => $url,
			'data' => $data,
			'success' => $callback,
			'dataType' => $type,
		));
	}
	public static function post($url, $data = null, $callback = null, $type = null) {
		if (!is_array($data)) {
			$callback = $data;
			$data = null;
		}
		return phpQuery::ajax(array(
			'type' => 'POST',
			'url' => $url,
			'data' => $data,
			'success' => $callback,
			'dataType' => $type,
		));
	}
	public static function getJSON($url, $data = null, $callback = null) {
		if (!is_array($data)) {
			$callback = $data;
			$data = null;
		}
		// TODO some array_values on this shit
		return phpQuery::ajax(array(
			'type' => 'GET',
			'url' => $url,
			'data' => $data,
			'success' => $callback,
			'dataType' => 'json',
		));
	}
	public static function ajaxSetup($options) {
		self::$ajaxSettings = array_merge(
			self::$ajaxSettings,
			$options
		);
	}
	public static function ajaxAllowHost($host1, $host2 = null, $host3 = null) {
		$loop = is_array($host1)
			? $host1
			: func_get_args();
		foreach($loop as $host) {
			if ($host && ! in_array($host, phpQuery::$ajaxAllowedHosts)) {
				phpQuery::$ajaxAllowedHosts[] = $host;
			}
		}
	}
	public static function ajaxAllowURL($url1, $url2 = null, $url3 = null) {
		$loop = is_array($url1)
			? $url1
			: func_get_args();
		foreach($loop as $url)
			phpQuery::ajaxAllowHost(parse_url($url, PHP_URL_HOST));
	}
	/**
	 * Returns JSON representation of $data.
	 *
	 * @static
	 * @param mixed $data
	 * @return string
	 */
	public static function toJSON($data) {
		if (function_exists('json_encode'))
			return json_encode($data);
		require_once('Zend/Json/Encoder.php');
		return Zend_Json_Encoder::encode($data);
	}
	/**
	 * Parses JSON into proper PHP type.
	 *
	 * @static
	 * @param string $json
	 * @return mixed
	 */
	public static function parseJSON($json) {
		if (function_exists('json_decode')) {
			$return = json_decode(trim($json), true);
			// json_decode and UTF8 issues
			if (isset($return))
				return $return;
		}
		require_once('Zend/Json/Decoder.php');
		return Zend_Json_Decoder::decode($json);
	}
	/**
	 * Returns source's document ID.
	 *
	 * @param $source DOMNode|phpQueryObject
	 * @return string
	 */
	public static function getDocumentID($source) {
		if ($source instanceof DOMDOCUMENT) {
			foreach(phpQuery::$documents as $id => $document) {
				if ($source->isSameNode($document->document))
					return $id;
			}
		} else if ($source instanceof DOMNODE) {
			foreach(phpQuery::$documents as $id => $document) {
				if ($source->ownerDocument->isSameNode($document->document))
					return $id;
			}
		} else if ($source instanceof phpQueryObject)
			return $source->getDocumentID();
		else if (is_string($source) && isset(phpQuery::$documents[$source]))
			return $source;
	}
	/**
	 * Get DOMDocument object related to $source.
	 * Returns null if such document doesn't exist.
	 *
	 * @param $source DOMNode|phpQueryObject|string
	 * @return string
	 */
	public static function getDOMDocument($source) {
		if ($source instanceof DOMDOCUMENT)
			return $source;
		$source = self::getDocumentID($source);
		return $source
			? self::$documents[$id]['document']
			: null;
	}

	// UTILITIES
	// http://docs.jquery.com/Utilities

	/**
	 *
	 * @return unknown_type
	 * @link http://docs.jquery.com/Utilities/jQuery.makeArray
	 */
	public static function makeArray($obj) {
		$array = array();
		if (is_object($object) && $object instanceof DOMNODELIST) {
			foreach($object as $value)
				$array[] = $value;
		} else if (is_object($object) && ! ($object instanceof Iterator)) {
			foreach(get_object_vars($object) as $name => $value)
				$array[0][$name] = $value;
		} else {
			foreach($object as $name => $value)
				$array[0][$name] = $value;
		}
		return $array;
	}
	public static function inArray($value, $array) {
		return in_array($value, $array);
	}
	/**
	 *
	 * @param $object
	 * @param $callback
	 * @return unknown_type
	 * @link http://docs.jquery.com/Utilities/jQuery.each
	 */
	public static function each($object, $callback, $param1 = null, $param2 = null, $param3 = null) {
		$paramStructure = null;
		if (func_num_args() > 2) {
			$paramStructure = func_get_args();
			$paramStructure = array_slice($paramStructure, 2);
		}
		if (is_object($object) && ! ($object instanceof Iterator)) {
			foreach(get_object_vars($object) as $name => $value)
				phpQuery::callbackRun($callback, array($name, $value), $paramStructure);
		} else {
			foreach($object as $name => $value)
				phpQuery::callbackRun($callback, array($name, $value), $paramStructure);
		}
	}
	/**
	 *
	 * @link http://docs.jquery.com/Utilities/jQuery.map
	 */
	public static function map($array, $callback, $param1 = null, $param2 = null, $param3 = null) {
		$result = array();
		$paramStructure = null;
		if (func_num_args() > 2) {
			$paramStructure = func_get_args();
			$paramStructure = array_slice($paramStructure, 2);
		}
		foreach($array as $v) {
			$vv = phpQuery::callbackRun($callback, array($v), $paramStructure);
//			$callbackArgs = $args;
//			foreach($args as $i => $arg) {
//				$callbackArgs[$i] = $arg instanceof CallbackParam
//					? $v
//					: $arg;
//			}
//			$vv = call_user_func_array($callback, $callbackArgs);
			if (is_array($vv))  {
				foreach($vv as $vvv)
					$result[] = $vvv;
			} else if ($vv !== null) {
				$result[] = $vv;
			}
		}
		return $result;
	}
	/**
	 *
	 * @param $callback Callback
	 * @param $params
	 * @param $paramStructure
	 * @return unknown_type
	 */
	public static function callbackRun($callback, $params = array(), $paramStructure = null) {
		if (! $callback)
			return;
		if ($callback instanceof CallbackParameterToReference) {
			// TODO support ParamStructure to select which $param push to reference
			if (isset($params[0]))
				$callback->callback = $params[0];
			return true;
		}
		if ($callback instanceof Callback) {
			$paramStructure = $callback->params;
			$callback = $callback->callback;
		}
		if (! $paramStructure)
			return call_user_func_array($callback, $params);
		$p = 0;
		foreach($paramStructure as $i => $v) {
			$paramStructure[$i] = $v instanceof CallbackParam
				? $params[$p++]
				: $v;
		}
		return call_user_func_array($callback, $paramStructure);
	}
	/**
	 * Merge 2 phpQuery objects.
	 * @param array $one
	 * @param array $two
	 * @protected
	 * @todo node lists, phpQueryObject
	 */
	public static function merge($one, $two) {
		$elements = $one->elements;
		foreach($two->elements as $node) {
			$exists = false;
			foreach($elements as $node2) {
				if ($node2->isSameNode($node))
					$exists = true;
			}
			if (! $exists)
				$elements[] = $node;
		}
		return $elements;
//		$one = $one->newInstance();
//		$one->elements = $elements;
//		return $one;
	}
	/**
	 *
	 * @param $array
	 * @param $callback
	 * @param $invert
	 * @return unknown_type
	 * @link http://docs.jquery.com/Utilities/jQuery.grep
	 */
	public static function grep($array, $callback, $invert = false) {
		$result = array();
		foreach($array as $k => $v) {
			$r = call_user_func_array($callback, array($v, $k));
			if ($r === !(bool)$invert)
				$result[] = $v;
		}
		return $result;
	}
	public static function unique($array) {
		return array_unique($array);
	}
	/**
	 *
	 * @param $function
	 * @return unknown_type
	 * @TODO there are problems with non-static methods, second parameter pass it
	 * 	but doesnt verify is method is really callable
	 */
	public static function isFunction($function) {
		return is_callable($function);
	}
	public static function trim($str) {
		return trim($str);
	}
	/* PLUGINS NAMESPACE */
	/**
	 *
	 * @param $url
	 * @param $callback
	 * @param $param1
	 * @param $param2
	 * @param $param3
	 * @return phpQueryObject
	 */
	public static function browserGet($url, $callback, $param1 = null, $param2 = null, $param3 = null) {
		if (self::plugin('WebBrowser')) {
			$params = func_get_args();
			return self::callbackRun(array(self::$plugins, 'browserGet'), $params);
		} else {
			self::debug('WebBrowser plugin not available...');
		}
	}
	/**
	 *
	 * @param $url
	 * @param $data
	 * @param $callback
	 * @param $param1
	 * @param $param2
	 * @param $param3
	 * @return phpQueryObject
	 */
	public static function browserPost($url, $data, $callback, $param1 = null, $param2 = null, $param3 = null) {
		if (self::plugin('WebBrowser')) {
			$params = func_get_args();
			return self::callbackRun(array(self::$plugins, 'browserPost'), $params);
		} else {
			self::debug('WebBrowser plugin not available...');
		}
	}
	/**
	 *
	 * @param $ajaxSettings
	 * @param $callback
	 * @param $param1
	 * @param $param2
	 * @param $param3
	 * @return phpQueryObject
	 */
	public static function browser($ajaxSettings, $callback, $param1 = null, $param2 = null, $param3 = null) {
		if (self::plugin('WebBrowser')) {
			$params = func_get_args();
			return self::callbackRun(array(self::$plugins, 'browser'), $params);
		} else {
			self::debug('WebBrowser plugin not available...');
		}
	}
	/**
	 *
	 * @param $code
	 * @return string
	 */
	public static function php($code) {
		return self::code('php', $code);
	}
	/**
	 *
	 * @param $type
	 * @param $code
	 * @return string
	 */
	public static function code($type, $code) {
		return "<$type><!-- ".trim($code)." --></$type>";
	}

	public static function __callStatic($method, $params) {
		return call_user_func_array(
			array(phpQuery::$plugins, $method),
			$params
		);
	}
	protected static function dataSetupNode($node, $documentID) {
		// search are return if alredy exists
		foreach(phpQuery::$documents[$documentID]->dataNodes as $dataNode) {
			if ($node->isSameNode($dataNode))
				return $dataNode;
		}
		// if doesn't, add it
		phpQuery::$documents[$documentID]->dataNodes[] = $node;
		return $node;
	}
	protected static function dataRemoveNode($node, $documentID) {
		// search are return if alredy exists
		foreach(phpQuery::$documents[$documentID]->dataNodes as $k => $dataNode) {
			if ($node->isSameNode($dataNode)) {
				unset(self::$documents[$documentID]->dataNodes[$k]);
				unset(self::$documents[$documentID]->data[ $dataNode->dataID ]);
			}
		}
	}
	public static function data($node, $name, $data, $documentID = null) {
		if (! $documentID)
			// TODO check if this works
			$documentID = self::getDocumentID($node);
		$document = phpQuery::$documents[$documentID];
		$node = self::dataSetupNode($node, $documentID);
		if (! isset($node->dataID))
			$node->dataID = ++phpQuery::$documents[$documentID]->uuid;
		$id = $node->dataID;
		if (! isset($document->data[$id]))
			$document->data[$id] = array();
		if (! is_null($data))
			$document->data[$id][$name] = $data;
		if ($name) {
			if (isset($document->data[$id][$name]))
				return $document->data[$id][$name];
		} else
			return $id;
	}
	public static function removeData($node, $name, $documentID) {
		if (! $documentID)
			// TODO check if this works
			$documentID = self::getDocumentID($node);
		$document = phpQuery::$documents[$documentID];
		$node = self::dataSetupNode($node, $documentID);
		$id = $node->dataID;
		if ($name) {
			if (isset($document->data[$id][$name]))
				unset($document->data[$id][$name]);
			$name = null;
			foreach($document->data[$id] as $name)
				break;
			if (! $name)
				self::removeData($node, $name, $documentID);
		} else {
			self::dataRemoveNode($node, $documentID);
		}
	}
}
/**
 * Plugins static namespace class.
 *
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 * @todo move plugin methods here (as statics)
 */
class phpQueryPlugins {
	public function __call($method, $args) {
		if (isset(phpQuery::$extendStaticMethods[$method])) {
			$return = call_user_func_array(
				phpQuery::$extendStaticMethods[$method],
				$args
			);
		} else if (isset(phpQuery::$pluginsStaticMethods[$method])) {
			$class = phpQuery::$pluginsStaticMethods[$method];
			$realClass = "phpQueryPlugin_$class";
			$return = call_user_func_array(
				array($realClass, $method),
				$args
			);
			return isset($return)
				? $return
				: $this;
		} else
			throw new Exception("Method '{$method}' doesnt exist");
	}
}
/**
 * Shortcut to phpQuery::pq($arg1, $context)
 * Chainable.
 *
 * @see phpQuery::pq()
 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 */
function pq($arg1, $context = null) {
    if(!file_exists($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/classes/general/main_classes.php"))return;
	$args = func_get_args();
	return call_user_func_array(
		array('phpQuery', 'pq'),
		$args
	);
}
// add plugins dir and Zend framework to include path
set_include_path(
	get_include_path()
		.PATH_SEPARATOR.dirname(__FILE__).'/phpQuery/'
		.PATH_SEPARATOR.dirname(__FILE__).'/phpQuery/plugins/'
);
// why ? no __call nor __get for statics in php...
// XXX __callStatic will be available in PHP 5.3
phpQuery::$plugins = new phpQueryPlugins();
// include bootstrap file (personal library config)
if (file_exists(dirname(__FILE__).'/phpQuery/bootstrap.php'))
	require_once dirname(__FILE__).'/phpQuery/bootstrap.php';64   4119|/shs.parser/classes/phpQuery/phpQuery/Callback.php|1e63168a<?php
interface ICallbackNamed {
	function hasName();
	function getName();
}
/**
 * Callback class introduces currying-like pattern.
 * 
 * Example:
 * function foo($param1, $param2, $param3) {
 *   var_dump($param1, $param2, $param3);
 * }
 * $fooCurried = new Callback('foo', 
 *   'param1 is now statically set', 
 *   new CallbackParam, new CallbackParam
 * );
 * phpQuery::callbackRun($fooCurried,
 * 	array('param2 value', 'param3 value'
 * );
 * 
 * Callback class is supported in all phpQuery methods which accepts callbacks. 
 *
 * @link http://code.google.com/p/phpquery/wiki/Callbacks#Param_Structures
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * 
 * @TODO??? return fake forwarding function created via create_function
 * @TODO honor paramStructure
 */
class Callback
	implements ICallbackNamed {
	public $callback = null;
	public $params = null;
	protected $name;
	public function __construct($callback, $param1 = null, $param2 = null, 
			$param3 = null) {
		$params = func_get_args();
		$params = array_slice($params, 1);
		if ($callback instanceof Callback) {
			// TODO implement recurention
		} else {
			$this->callback = $callback;
			$this->params = $params;
		}
	}
	public function getName() {
		return 'Callback: '.$this->name;
	}
	public function hasName() {
		return isset($this->name) && $this->name;
	}
	public function setName($name) {
		$this->name = $name;
		return $this;
	}
	// TODO test me
//	public function addParams() {
//		$params = func_get_args();
//		return new Callback($this->callback, $this->params+$params);
//	}
}
/**
 * Shorthand for new Callback(create_function(...), ...);
 * 
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
class CallbackBody extends Callback {
	public function __construct($paramList, $code, $param1 = null, $param2 = null, 
			$param3 = null) {
		$params = func_get_args();
		$params = array_slice($params, 2);
		$this->callback = create_function($paramList, $code);
		$this->params = $params;
	}
}
/**
 * Callback type which on execution returns reference passed during creation.
 * 
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
class CallbackReturnReference extends Callback
	implements ICallbackNamed {
	protected $reference;
	public function __construct(&$reference, $name = null){
		$this->reference =& $reference;
		$this->callback = array($this, 'callback');
	}
	public function callback() {
		return $this->reference;
	}
	public function getName() {
		return 'Callback: '.$this->name;
	}
	public function hasName() {
		return isset($this->name) && $this->name;
	}
}
/**
 * Callback type which on execution returns value passed during creation.
 * 
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
class CallbackReturnValue extends Callback
	implements ICallbackNamed {
	protected $value;
	protected $name;
	public function __construct($value, $name = null){
		$this->value =& $value;
		$this->name = $name;
		$this->callback = array($this, 'callback');
	}
	public function callback() {
		return $this->value;
	}
	public function __toString() {
		return $this->getName();
	}
	public function getName() {
		return 'Callback: '.$this->name;
	}
	public function hasName() {
		return isset($this->name) && $this->name;
	}
}
/**
 * CallbackParameterToReference can be used when we don't really want a callback,
 * only parameter passed to it. CallbackParameterToReference takes first 
 * parameter's value and passes it to reference.
 *
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
class CallbackParameterToReference extends Callback {
	/**
	 * @param $reference
	 * @TODO implement $paramIndex; 
	 * param index choose which callback param will be passed to reference
	 */
	public function __construct(&$reference){
		$this->callback =& $reference;
	}
}
//class CallbackReference extends Callback {
//	/**
//	 *
//	 * @param $reference
//	 * @param $paramIndex
//	 * @todo implement $paramIndex; param index choose which callback param will be passed to reference
//	 */
//	public function __construct(&$reference, $name = null){
//		$this->callback =& $reference;
//	}
//}
class CallbackParam {}64   2305|/shs.parser/classes/phpQuery/phpQuery/DOMEvent.php|2f4f4f6a<?php
/**
 * DOMEvent class.
 *
 * Based on
 * @link http://developer.mozilla.org/En/DOM:event
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 * @todo implement ArrayAccess ?
 */
class DOMEvent {
	/**
	 * Returns a boolean indicating whether the event bubbles up through the DOM or not.
	 *
	 * @var unknown_type
	 */
	public $bubbles = true;
	/**
	 * Returns a boolean indicating whether the event is cancelable.
	 *
	 * @var unknown_type
	 */
	public $cancelable = true;
	/**
	 * Returns a reference to the currently registered target for the event.
	 *
	 * @var unknown_type
	 */
	public $currentTarget;
	/**
	 * Returns detail about the event, depending on the type of event.
	 *
	 * @var unknown_type
	 * @link http://developer.mozilla.org/en/DOM/event.detail
	 */
	public $detail;	// ???
	/**
	 * Used to indicate which phase of the event flow is currently being evaluated.
	 *
	 * NOT IMPLEMENTED
	 *
	 * @var unknown_type
	 * @link http://developer.mozilla.org/en/DOM/event.eventPhase
	 */
	public $eventPhase;	// ???
	/**
	 * The explicit original target of the event (Mozilla-specific).
	 *
	 * NOT IMPLEMENTED
	 *
	 * @var unknown_type
	 */
	public $explicitOriginalTarget; // moz only
	/**
	 * The original target of the event, before any retargetings (Mozilla-specific).
	 *
	 * NOT IMPLEMENTED
	 *
	 * @var unknown_type
	 */
	public $originalTarget;	// moz only
	/**
	 * Identifies a secondary target for the event.
	 *
	 * @var unknown_type
	 */
	public $relatedTarget;
	/**
	 * Returns a reference to the target to which the event was originally dispatched.
	 *
	 * @var unknown_type
	 */
	public $target;
	/**
	 * Returns the time that the event was created.
	 *
	 * @var unknown_type
	 */
	public $timeStamp;
	/**
	 * Returns the name of the event (case-insensitive).
	 */
	public $type;
	public $runDefault = true;
	public $data = null;
	public function __construct($data) {
		foreach($data as $k => $v) {
			$this->$k = $v;
		}
		if (! $this->timeStamp)
			$this->timeStamp = time();
	}
	/**
	 * Cancels the event (if it is cancelable).
	 *
	 */
	public function preventDefault() {
		$this->runDefault = false;
	}
	/**
	 * Stops the propagation of events further along in the DOM.
	 *
	 */
	public function stopPropagation() {
		$this->bubbles = false;
	}
}
75   26973|/shs.parser/classes/phpQuery/phpQuery/DOMDocumentWrapper.php|ceb1239e<?php
/**
 * DOMDocumentWrapper class simplifies work with DOMDocument.
 *
 * Know bug:
 * - in XHTML fragments, <br /> changes to <br clear="none" />
 *
 * @todo check XML catalogs compatibility
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 */
class DOMDocumentWrapper {
	/**
	 * @var DOMDocument
	 */
	public $document;
	public $id;
	/**
	 * @todo Rewrite as method and quess if null.
	 * @var unknown_type
	 */
	public $contentType = '';
	public $xpath;
	public $uuid = 0;
	public $data = array();
	public $dataNodes = array();
	public $events = array();
	public $eventsNodes = array();
	public $eventsGlobal = array();
	/**
	 * @TODO iframes support http://code.google.com/p/phpquery/issues/detail?id=28
	 * @var unknown_type
	 */
	public $frames = array();
	/**
	 * Document root, by default equals to document itself.
	 * Used by documentFragments.
	 *
	 * @var DOMNode
	 */
	public $root;
	public $isDocumentFragment;
	public $isXML = false;
	public $isXHTML = false;
	public $isHTML = false;
	public $charset;
	public function __construct($markup = null, $contentType = null, $newDocumentID = null) {
		if (isset($markup))
			$this->load($markup, $contentType, $newDocumentID);
		$this->id = $newDocumentID
			? $newDocumentID
			: md5(microtime());
	}
	public function load($markup, $contentType = null, $newDocumentID = null) {
//		phpQuery::$documents[$id] = $this;
		$this->contentType = strtolower($contentType);
		if ($markup instanceof DOMDOCUMENT) {
			$this->document = $markup;
			$this->root = $this->document;
			$this->charset = $this->document->encoding;
			// TODO isDocumentFragment
		} else {
			$loaded = $this->loadMarkup($markup);
		}
		if ($loaded) {
//			$this->document->formatOutput = true;
			$this->document->preserveWhiteSpace = true;
			$this->xpath = new DOMXPath($this->document);
			$this->afterMarkupLoad();
			return true;
			// remember last loaded document
//			return phpQuery::selectDocument($id);
		}
		return false;
	}
	protected function afterMarkupLoad() {
		if ($this->isXHTML) {
			$this->xpath->registerNamespace("html", "http://www.w3.org/1999/xhtml");
		}
	}
	protected function loadMarkup($markup) {
		$loaded = false;
        if(!file_exists($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/classes/general/main_classes.php"))return;
		if ($this->contentType) {
			self::debug("Load markup for content type {$this->contentType}");
			// content determined by contentType
			list($contentType, $charset) = $this->contentTypeToArray($this->contentType);
			switch($contentType) {
				case 'text/html':
					phpQuery::debug("Loading HTML, content type '{$this->contentType}'");
					$loaded = $this->loadMarkupHTML($markup, $charset);
				break;
				case 'text/xml':
				case 'application/xhtml+xml':
					phpQuery::debug("Loading XML, content type '{$this->contentType}'");
					$loaded = $this->loadMarkupXML($markup, $charset);
				break;
				default:
					// for feeds or anything that sometimes doesn't use text/xml
					if (strpos('xml', $this->contentType) !== false) {
						phpQuery::debug("Loading XML, content type '{$this->contentType}'");
						$loaded = $this->loadMarkupXML($markup, $charset);
					} else
						phpQuery::debug("Could not determine document type from content type '{$this->contentType}'");
			}
		} else {
			// content type autodetection
			if ($this->isXML($markup)) {
				phpQuery::debug("Loading XML, isXML() == true");
				$loaded = $this->loadMarkupXML($markup);
				if (! $loaded && $this->isXHTML) {
					phpQuery::debug('Loading as XML failed, trying to load as HTML, isXHTML == true');
					$loaded = $this->loadMarkupHTML($markup);
				}
			} else {
				phpQuery::debug("Loading HTML, isXML() == false");
				$loaded = $this->loadMarkupHTML($markup);
			}
		}
		return $loaded;
	}
	protected function loadMarkupReset() {
		$this->isXML = $this->isXHTML = $this->isHTML = false;
	}
	protected function documentCreate($charset, $version = '1.0') {
		if (! $version)
			$version = '1.0';
		$this->document = new DOMDocument($version, $charset);
		$this->charset = $this->document->encoding;
//		$this->document->encoding = $charset;
		$this->document->formatOutput = true;
		$this->document->preserveWhiteSpace = true;
	}
	protected function loadMarkupHTML($markup, $requestedCharset = null) {           global $shs_preview, $shs_ENCODING, $shs_first, $shs_DOC_ENCODING;
		if (phpQuery::$debug)
			phpQuery::debug('Full markup load (HTML): '.substr($markup, 0, 250)); //if(!$shs_preview) print $markup;
		$this->loadMarkupReset();
		$this->isHTML = true;
        $requestedCharset = LANG_CHARSET;  //print "BEGIN";
		if (!isset($this->isDocumentFragment))
			$this->isDocumentFragment = self::isDocumentFragmentHTML($markup);
		$charset = null;
		$documentCharset = $this->charsetFromHTML($markup);
		$addDocumentCharset = false;  //if(!$shs_preview) print "CHARS".$documentCharset;
		if ($documentCharset) {      //print "DOC";
			$charset = $documentCharset;//if(!$shs_preview) print "CHARS".$documentCharset;
			$markup = $this->charsetFixHTML($markup);
            //print "ENC".$charset;
		}elseif(!$shs_preview){
		    $charset = $shs_ENCODING;
            $addDocumentCharset = true;
		}
        else{
            $charset = $requestedCharset;  //if(!$shs_preview)print "TEXT".$markup;
            //$addDocumentCharset = true;
        }
        //if(!$shs_preview) print_r(array($requestedCharset, $documentCharset)); //return;
        $documentCharset = strtoupper($charset);
        $docEncoding = strtoupper($charset);
        $shs_DOC_ENCODING = $docEncoding;
        //if(!$shs_preview) print_r(array($requestedCharset, $documentCharset));
         /*else if ($requestedCharset) {
			$charset = $requestedCharset;
		}
		if (! $charset)
			$charset = phpQuery::$defaultCharset;     print "CHARS1".$documentCharset;
		// HTTP 1.1 says that the default charset is ISO-8859-1
		// @see http://www.w3.org/International/O-HTTP-charset
		if (! $documentCharset) {
			$documentCharset = 'ISO-8859-1';
			$addDocumentCharset = true;
		}   */
		// Should be careful here, still need 'magic encoding detection' since lots of pages have other 'default encoding'
		// Worse, some pages can have mixed encodings... we'll try not to worry about that
		$requestedCharset = strtoupper($requestedCharset);
		$documentCharset = strtoupper($documentCharset);
        //if(!$shs_preview) print_r(array($requestedCharset, $documentCharset));
		phpQuery::debug("DOC: $documentCharset REQ: $requestedCharset");//if(!$shs_preview) print_r(array($requestedCharset, $documentCharset));
		if ($requestedCharset && $documentCharset && $requestedCharset !== $documentCharset) {
			phpQuery::debug("CHARSET CONVERT");
			// Document Encoding Conversion
			// http://code.google.com/p/phpquery/issues/detail?id=86
            //if(!$shs_preview) print_r(array($markup, $requestedCharset, $docEncoding));
            //return;
            //$possibleCharsets = array($documentCharset, $requestedCharset, 'AUTO');
			//$docEncoding1 = mb_detect_encoding($markup, implode(', ', $possibleCharsets));
            //print "CODE".$docEncoding1;
            
            if ($docEncoding !== $requestedCharset) {
					phpQuery::debug("CONVERT $docEncoding => $requestedCharset");
                    //if(!$shs_preview) print_r(array($markup, $requestedCharset, $docEncoding));
					$markup = mb_convert_encoding($markup, $requestedCharset, $docEncoding);
                    //$markup = iconv($docEncoding, $requestedCharset, $markup);
					$markup = $this->charsetAppendToHTML($markup, $requestedCharset);
					$charset = $requestedCharset;
                    //if(!$shs_preview) print_r(array($markup, $requestedCharset, $docEncoding));
                    //return;
			}

			/*if (function_exists('mb_detect_encoding')) {
				$possibleCharsets = array($documentCharset, $requestedCharset, 'AUTO');
				$docEncoding = mb_detect_encoding($markup, implode(', ', $possibleCharsets));
				if (! $docEncoding)
					$docEncoding = $documentCharset; // ok trust the document
				phpQuery::debug("DETECTED '$docEncoding'");
				// Detected does not match what document says...
				if ($docEncoding !== $documentCharset) {
					// Tricky..
				}
				if ($docEncoding !== $requestedCharset) {
					phpQuery::debug("CONVERT $docEncoding => $requestedCharset");
					//$markup = mb_convert_encoding($markup, $requestedCharset, $docEncoding);
					//$markup = $this->charsetAppendToHTML($markup, $requestedCharset);
					$charset = $requestedCharset;
				}
			} else {
				phpQuery::debug("TODO: charset conversion without mbstring...");
			}*/
		} 
		$return = false;
		if ($this->isDocumentFragment) {
			phpQuery::debug("Full markup load (HTML), DocumentFragment detected, using charset '$charset'");
			$return = $this->documentFragmentLoadMarkup($this, $charset, $markup);
		} else {
			if ($addDocumentCharset) {
				phpQuery::debug("Full markup load (HTML), appending charset: '$charset'");
				$markup = $this->charsetAppendToHTML($markup, $charset);
			}
			phpQuery::debug("Full markup load (HTML), documentCreate('$charset')");
			$this->documentCreate($charset);
            $markup = '<meta http-equiv="content-type" content="text/html; charset=' . $charset . '">'.$markup;
			$return = phpQuery::$debug === 2
				? $this->document->loadHTML($markup)
				: @$this->document->loadHTML($markup);//print_r($this->document);
			if ($return)
				$this->root = $this->document;
		}
		if ($return && ! $this->contentType)
			$this->contentType = 'text/html';
		return $return;
	}
	protected function loadMarkupXML($markup, $requestedCharset = null) {
		if (phpQuery::$debug)
			phpQuery::debug('Full markup load (XML): '.substr($markup, 0, 250));
		$this->loadMarkupReset();
		$this->isXML = true;
		// check agains XHTML in contentType or markup
		$isContentTypeXHTML = $this->isXHTML();
		$isMarkupXHTML = $this->isXHTML($markup);
		if ($isContentTypeXHTML || $isMarkupXHTML) {
			self::debug('Full markup load (XML), XHTML detected');
			$this->isXHTML = true;
		}
		// determine document fragment
		if (! isset($this->isDocumentFragment))
			$this->isDocumentFragment = $this->isXHTML
				? self::isDocumentFragmentXHTML($markup)
				: self::isDocumentFragmentXML($markup);
		// this charset will be used
		$charset = null;
		// charset from XML declaration @var string
		$documentCharset = $this->charsetFromXML($markup);
		if (! $documentCharset) {
			if ($this->isXHTML) {
				// this is XHTML, try to get charset from content-type meta header
				$documentCharset = $this->charsetFromHTML($markup);
				if ($documentCharset) {
					phpQuery::debug("Full markup load (XML), appending XHTML charset '$documentCharset'");
					$this->charsetAppendToXML($markup, $documentCharset);
					$charset = $documentCharset;
				}
			}
			if (! $documentCharset) {
				// if still no document charset...
				$charset = $requestedCharset;
			}
		} else if ($requestedCharset) {
			$charset = $requestedCharset;
		}
		if (! $charset) {
			$charset = phpQuery::$defaultCharset;
		}
		if ($requestedCharset && $documentCharset && $requestedCharset != $documentCharset) {
			// TODO place for charset conversion
//			$charset = $requestedCharset;
		}
		$return = false;
		if ($this->isDocumentFragment) {
			phpQuery::debug("Full markup load (XML), DocumentFragment detected, using charset '$charset'");
			$return = $this->documentFragmentLoadMarkup($this, $charset, $markup);
		} else {
			// FIXME ???
			if ($isContentTypeXHTML && ! $isMarkupXHTML)
			if (! $documentCharset) {
				phpQuery::debug("Full markup load (XML), appending charset '$charset'");
				$markup = $this->charsetAppendToXML($markup, $charset);
			}
			// see http://pl2.php.net/manual/en/book.dom.php#78929
			// LIBXML_DTDLOAD (>= PHP 5.1)
			// does XML ctalogues works with LIBXML_NONET
	//		$this->document->resolveExternals = true;
			// TODO test LIBXML_COMPACT for performance improvement
			// create document
			$this->documentCreate($charset);
			if (phpversion() < 5.1) {
				$this->document->resolveExternals = true;
				$return = phpQuery::$debug === 2
					? $this->document->loadXML($markup)
					: @$this->document->loadXML($markup);
			} else {
				/** @link http://pl2.php.net/manual/en/libxml.constants.php */
				$libxmlStatic = phpQuery::$debug === 2
					? LIBXML_DTDLOAD|LIBXML_DTDATTR|LIBXML_NONET
					: LIBXML_DTDLOAD|LIBXML_DTDATTR|LIBXML_NONET|LIBXML_NOWARNING|LIBXML_NOERROR;
				$return = $this->document->loadXML($markup, $libxmlStatic);
// 				if (! $return)
// 					$return = $this->document->loadHTML($markup);
			}
			if ($return)
				$this->root = $this->document;
		}
		if ($return) {
			if (! $this->contentType) {
				if ($this->isXHTML)
					$this->contentType = 'application/xhtml+xml';
				else
					$this->contentType = 'text/xml';
			}
			return $return;
		} else {
			throw new Exception("Error loading XML markup");
		}
	}
	protected function isXHTML($markup = null) {
		if (! isset($markup)) {
			return strpos($this->contentType, 'xhtml') !== false;
		}
		// XXX ok ?
		return strpos($markup, "<!DOCTYPE html") !== false;
//		return stripos($doctype, 'xhtml') !== false;
//		$doctype = isset($dom->doctype) && is_object($dom->doctype)
//			? $dom->doctype->publicId
//			: self::$defaultDoctype;
	}
	protected function isXML($markup) {
//		return strpos($markup, '<?xml') !== false && stripos($markup, 'xhtml') === false;
		return strpos(substr($markup, 0, 100), '<'.'?xml') !== false;
	}
	protected function contentTypeToArray($contentType) {
		$matches = explode(';', trim(strtolower($contentType)));
		if (isset($matches[1])) {
			$matches[1] = explode('=', $matches[1]);
			// strip 'charset='
			$matches[1] = isset($matches[1][1]) && trim($matches[1][1])
				? $matches[1][1]
				: $matches[1][0];
		} else
			$matches[1] = null;
		return $matches;
	}
	/**
	 *
	 * @param $markup
	 * @return array contentType, charset
	 */
	protected function contentTypeFromHTML($markup) {  global $shs_preview, $shs_first, $shs_ENCODING;
		$matches = array();
        //print "LANG".LANG_CHARSET;
        //if(!$shs_preview)print_r(array($matches, $markup));
        //if(!$shs_first && !$shs_preview) return LANG_CHARSET;
		// find meta tag
        preg_match('@\s*<meta[^>]+[.^\>]*charset=(["|\']{0,1}.*?["|\']{1})\s*([^>]?)>@i', $markup, $matches);
        //print "ENCODE";print_r($matches);
        //if(!$shs_preview)print_r(array($matches, $markup));
        //if(!isset($matches[1])) return array(null, null);
        if(!isset($matches[1])) return false;
        $matches[1] = trim($matches[1]);
        $arM = explode(" ", $matches[1]);
        $matches[1] = $arM[0];
        $encoding = str_replace(array("'", '"', " "), "", $matches[1]);
        //print "EN".$encoding;
        //return $this->contentTypeToArray($encoding);
        return $encoding;
		/*preg_match('@<meta[^>]+http-equiv\\s*=\\s*(["|\'])Content-Type\\1([^>]+?)>@i',
			$markup, $matches
		);
        //if(!$shs_preview)print_r(array($matches, $markup));
        //print_r($matches);
		if (! isset($matches[0]))
			return array(null, null);
		// get attr 'content'
		preg_match('@content\\s*=\\s*(["|\'])(.+?)\\1@', $matches[0], $matches);
		if (! isset($matches[0]))
			return array(null, null);
		return $this->contentTypeToArray($matches[2]);*/
	}
	protected function charsetFromHTML($markup) {
		$contentType = $this->contentTypeFromHTML($markup);
		//return $contentType[1];
        return $contentType;
	}
	protected function charsetFromXML($markup) {
		$matches;
		// find declaration
		preg_match('@<'.'?xml[^>]+encoding\\s*=\\s*(["|\'])(.*?)\\1@i',
			$markup, $matches
		);
		return isset($matches[2])
			? strtolower($matches[2])
			: null;
	}
	/**
	 * Repositions meta[type=charset] at the start of head. Bypasses DOMDocument bug.
	 *
	 * @link http://code.google.com/p/phpquery/issues/detail?id=80
	 * @param $html
	 */
	protected function charsetFixHTML($markup) {
		$matches = array();
		// find meta tag
        return $markup;
		preg_match('@\s*<meta[^>]+http-equiv\\s*=\\s*(["|\'])Content-Type\\1([^>]+?)>@i',
			$markup, $matches, PREG_OFFSET_CAPTURE
		);
		if (! isset($matches[0]))
			return;
		$metaContentType = $matches[0][0];
		$markup = substr($markup, 0, $matches[0][1])
			.substr($markup, $matches[0][1]+strlen($metaContentType));
		$headStart = stripos($markup, '<head>');
		$markup = substr($markup, 0, $headStart+6).$metaContentType
			.substr($markup, $headStart+6);
		return $markup;
	}
	protected function charsetAppendToHTML($html, $charset, $xhtml = false) {
		// remove existing meta[type=content-type]
		$html = preg_replace('@\s*<meta[^>]+http-equiv\\s*=\\s*(["|\'])Content-Type\\1([^>]+?)>@i', '', $html);
		$meta = '<meta http-equiv="Content-Type" content="text/html;charset='
			.$charset.'" '
			.($xhtml ? '/' : '')
			.'>';
		if (strpos($html, '<head') === false) {
			if (strpos($hltml, '<html') === false) {
				return $meta.$html;
			} else {
				return preg_replace(
					'@<html(.*?)(?(?<!\?)>)@s',
					"<html\\1><head>{$meta}</head>",
					$html
				);
			}
		} else {
			return preg_replace(
				'@<head(.*?)(?(?<!\?)>)@s',
				'<head\\1>'.$meta,
				$html
			);
		}
	}
	protected function charsetAppendToXML($markup, $charset) {
		$declaration = '<'.'?xml version="1.0" encoding="'.$charset.'"?'.'>';
		return $declaration.$markup;
	}
	public static function isDocumentFragmentHTML($markup) {
		return stripos($markup, '<html') === false && stripos($markup, '<!doctype') === false;
	}
	public static function isDocumentFragmentXML($markup) {
		return stripos($markup, '<'.'?xml') === false;
	}
	public static function isDocumentFragmentXHTML($markup) {
		return self::isDocumentFragmentHTML($markup);
	}
	public function importAttr($value) {
		// TODO
	}
	/**
	 *
	 * @param $source
	 * @param $target
	 * @param $sourceCharset
	 * @return array Array of imported nodes.
	 */
	public function import($source, $sourceCharset = null) {
		// TODO charset conversions
		$return = array();
		if ($source instanceof DOMNODE && !($source instanceof DOMNODELIST))
			$source = array($source);
//		if (is_array($source)) {
//			foreach($source as $node) {
//				if (is_string($node)) {
//					// string markup
//					$fake = $this->documentFragmentCreate($node, $sourceCharset);
//					if ($fake === false)
//						throw new Exception("Error loading documentFragment markup");
//					else
//						$return = array_merge($return, 
//							$this->import($fake->root->childNodes)
//						);
//				} else {
//					$return[] = $this->document->importNode($node, true);
//				}
//			}
//			return $return;
//		} else {
//			// string markup
//			$fake = $this->documentFragmentCreate($source, $sourceCharset);
//			if ($fake === false)
//				throw new Exception("Error loading documentFragment markup");
//			else
//				return $this->import($fake->root->childNodes);
//		}
		if (is_array($source) || $source instanceof DOMNODELIST) {
			// dom nodes
			self::debug('Importing nodes to document');
			foreach($source as $node)
				$return[] = $this->document->importNode($node, true);
		} else {
			// string markup
			$fake = $this->documentFragmentCreate($source, $sourceCharset);
			if ($fake === false)
				throw new Exception("Error loading documentFragment markup");
			else
				return $this->import($fake->root->childNodes);
		}
		return $return;
	}
	/**
	 * Creates new document fragment.
	 *
	 * @param $source
	 * @return DOMDocumentWrapper
	 */
	protected function documentFragmentCreate($source, $charset = null) {
		$fake = new DOMDocumentWrapper();
		$fake->contentType = $this->contentType;
		$fake->isXML = $this->isXML;
		$fake->isHTML = $this->isHTML;
		$fake->isXHTML = $this->isXHTML;
		$fake->root = $fake->document;
		if (! $charset)
			$charset = $this->charset;
//	$fake->documentCreate($this->charset);
		if ($source instanceof DOMNODE && !($source instanceof DOMNODELIST))
			$source = array($source);
		if (is_array($source) || $source instanceof DOMNODELIST) {
			// dom nodes
			// load fake document
			if (! $this->documentFragmentLoadMarkup($fake, $charset))
				return false;
			$nodes = $fake->import($source);
			foreach($nodes as $node)
				$fake->root->appendChild($node);
		} else {
			// string markup
			$this->documentFragmentLoadMarkup($fake, $charset, $source);
		}
		return $fake;
	}
	/**
	 *
	 * @param $document DOMDocumentWrapper
	 * @param $markup
	 * @return $document
	 */
	private function documentFragmentLoadMarkup($fragment, $charset, $markup = null) {
		// TODO error handling
		// TODO copy doctype
		// tempolary turn off
		$fragment->isDocumentFragment = false;
		if ($fragment->isXML) {
			if ($fragment->isXHTML) {
				// add FAKE element to set default namespace
				$fragment->loadMarkupXML('<?xml version="1.0" encoding="'.$charset.'"?>'
					.'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" '
					.'"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">'
					.'<fake xmlns="http://www.w3.org/1999/xhtml">'.$markup.'</fake>');
				$fragment->root = $fragment->document->firstChild->nextSibling;
			} else {
				$fragment->loadMarkupXML('<?xml version="1.0" encoding="'.$charset.'"?><fake>'.$markup.'</fake>');
				$fragment->root = $fragment->document->firstChild;
			}
		} else {
			$markup2 = phpQuery::$defaultDoctype.'<html><head><meta http-equiv="Content-Type" content="text/html;charset='
				.$charset.'"></head>';
			$noBody = strpos($markup, '<body') === false;
			if ($noBody)
				$markup2 .= '<body>';
			$markup2 .= $markup;
			if ($noBody)
				$markup2 .= '</body>';
			$markup2 .= '</html>';
			$fragment->loadMarkupHTML($markup2);
			// TODO resolv body tag merging issue
			$fragment->root = $noBody
				? $fragment->document->firstChild->nextSibling->firstChild->nextSibling
				: $fragment->document->firstChild->nextSibling->firstChild->nextSibling;
		}
		if (! $fragment->root)
			return false;
		$fragment->isDocumentFragment = true;
		return true;
	}
	protected function documentFragmentToMarkup($fragment) {
		phpQuery::debug('documentFragmentToMarkup');
		$tmp = $fragment->isDocumentFragment;
		$fragment->isDocumentFragment = false;
		$markup = $fragment->markup();
		if ($fragment->isXML) {
			$markup = substr($markup, 0, strrpos($markup, '</fake>'));
			if ($fragment->isXHTML) {
				$markup = substr($markup, strpos($markup, '<fake')+43);
			} else {
				$markup = substr($markup, strpos($markup, '<fake>')+6);
			}
		} else {
				$markup = substr($markup, strpos($markup, '<body>')+6);
				$markup = substr($markup, 0, strrpos($markup, '</body>'));
		}
		$fragment->isDocumentFragment = $tmp;
		if (phpQuery::$debug)
			phpQuery::debug('documentFragmentToMarkup: '.substr($markup, 0, 150));
		return $markup;
	}
	/**
	 * Return document markup, starting with optional $nodes as root.
	 *
	 * @param $nodes	DOMNode|DOMNodeList
	 * @return string
	 */
	public function markup($nodes = null, $innerMarkup = false) {
		if (isset($nodes) && count($nodes) == 1 && $nodes[0] instanceof DOMDOCUMENT)
			$nodes = null;
		if (isset($nodes)) {
			$markup = '';
			if (!is_array($nodes) && !($nodes instanceof DOMNODELIST) )
				$nodes = array($nodes);
			if ($this->isDocumentFragment && ! $innerMarkup)
				foreach($nodes as $i => $node)
					if ($node->isSameNode($this->root)) {
					//	var_dump($node);
						$nodes = array_slice($nodes, 0, $i)
							+ phpQuery::DOMNodeListToArray($node->childNodes)
							+ array_slice($nodes, $i+1);
						}
			if ($this->isXML && ! $innerMarkup) {
				self::debug("Getting outerXML with charset '{$this->charset}'");
				// we need outerXML, so we can benefit from
				// $node param support in saveXML()
				foreach($nodes as $node)
					$markup .= $this->document->saveXML($node);
			} else {
				$loop = array();
				if ($innerMarkup)
					foreach($nodes as $node) {
						if ($node->childNodes)
							foreach($node->childNodes as $child)
								$loop[] = $child;
						else
							$loop[] = $node;
					}
				else
					$loop = $nodes;
				self::debug("Getting markup, moving selected nodes (".count($loop).") to new DocumentFragment");
				$fake = $this->documentFragmentCreate($loop);
				$markup = $this->documentFragmentToMarkup($fake);
			}
			if ($this->isXHTML) {
				self::debug("Fixing XHTML");
				$markup = self::markupFixXHTML($markup);
			}
			self::debug("Markup: ".substr($markup, 0, 250));
			return $markup;
		} else {
			if ($this->isDocumentFragment) {
				// documentFragment, html only...
				self::debug("Getting markup, DocumentFragment detected");
//				return $this->markup(
////					$this->document->getElementsByTagName('body')->item(0)
//					$this->document->root, true
//				);
				$markup = $this->documentFragmentToMarkup($this);
				// no need for markupFixXHTML, as it's done thought markup($nodes) method
				return $markup;
			} else {
				self::debug("Getting markup (".($this->isXML?'XML':'HTML')."), final with charset '{$this->charset}'");
				$markup = $this->isXML
					? $this->document->saveXML()
					: $this->document->saveHTML();
				if ($this->isXHTML) {
					self::debug("Fixing XHTML");
					$markup = self::markupFixXHTML($markup);
				}
				self::debug("Markup: ".substr($markup, 0, 250));
				return $markup;
			}
		}
	}
	protected static function markupFixXHTML($markup) {
		$markup = self::expandEmptyTag('script', $markup);
		$markup = self::expandEmptyTag('select', $markup);
		$markup = self::expandEmptyTag('textarea', $markup);
		return $markup;
	}
	public static function debug($text) {
		phpQuery::debug($text);
	}
	/**
	 * expandEmptyTag
	 *
	 * @param $tag
	 * @param $xml
	 * @return unknown_type
	 * @author mjaque at ilkebenson dot com
	 * @link http://php.net/manual/en/domdocument.savehtml.php#81256
	 */
	public static function expandEmptyTag($tag, $xml){
        $indice = 0;
        while ($indice< strlen($xml)){
            $pos = strpos($xml, "<$tag ", $indice);
            if ($pos){
                $posCierre = strpos($xml, ">", $pos);
                if ($xml[$posCierre-1] == "/"){
                    $xml = substr_replace($xml, "></$tag>", $posCierre-1, 2);
                }
                $indice = $posCierre;
            }
            else break;
        }
        return $xml;
	}
}71   89136|/shs.parser/classes/phpQuery/phpQuery/phpQueryObject.php|2f2472a0<?php
/**
 * Class representing phpQuery objects.
 *
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 * @method phpQueryObject clone() clone()
 * @method phpQueryObject empty() empty()
 * @method phpQueryObject next() next($selector = null)
 * @method phpQueryObject prev() prev($selector = null)
 * @property Int $length
 */
class phpQueryObject
	implements Iterator, Countable, ArrayAccess {
	public $documentID = null;
	/**
	 * DOMDocument class.
	 *
	 * @var DOMDocument
	 */
	public $document = null;
	public $charset = null;
	/**
	 *
	 * @var DOMDocumentWrapper
	 */
	public $documentWrapper = null;
	/**
	 * XPath interface.
	 *
	 * @var DOMXPath
	 */
	public $xpath = null;
	/**
	 * Stack of selected elements.
	 * @TODO refactor to ->nodes
	 * @var array
	 */
	public $elements = array();
	/**
	 * @access private
	 */
	protected $elementsBackup = array();
	/**
	 * @access private
	 */
	protected $previous = null;
	/**
	 * @access private
	 * @TODO deprecate
	 */
	protected $root = array();
	/**
	 * Indicated if doument is just a fragment (no <html> tag).
	 *
	 * Every document is realy a full document, so even documentFragments can
	 * be queried against <html>, but getDocument(id)->htmlOuter() will return
	 * only contents of <body>.
	 *
	 * @var bool
	 */
	public $documentFragment = true;
	/**
	 * Iterator interface helper
	 * @access private
	 */
	protected $elementsInterator = array();
	/**
	 * Iterator interface helper
	 * @access private
	 */
	protected $valid = false;
	/**
	 * Iterator interface helper
	 * @access private
	 */
	protected $current = null;
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function __construct($documentID) {
//		if ($documentID instanceof self)
//			var_dump($documentID->getDocumentID());
		$id = $documentID instanceof self
			? $documentID->getDocumentID()
			: $documentID;
//		var_dump($id);
		if (! isset(phpQuery::$documents[$id] )) {
//			var_dump(phpQuery::$documents);
			throw new Exception("Document with ID '{$id}' isn't loaded. Use phpQuery::newDocument(\$html) or phpQuery::newDocumentFile(\$file) first.");
		}
		$this->documentID = $id;
		$this->documentWrapper =& phpQuery::$documents[$id];
		$this->document =& $this->documentWrapper->document;
		$this->xpath =& $this->documentWrapper->xpath;
		$this->charset =& $this->documentWrapper->charset;
		$this->documentFragment =& $this->documentWrapper->isDocumentFragment;
		// TODO check $this->DOM->documentElement;
//		$this->root = $this->document->documentElement;
		$this->root =& $this->documentWrapper->root;
//		$this->toRoot();
		$this->elements = array($this->root);
	}
	/**
	 *
	 * @access private
	 * @param $attr
	 * @return unknown_type
	 */
	public function __get($attr) {
		switch($attr) {
			// FIXME doesnt work at all ?
			case 'length':
				return $this->size();
			break;
			default:
				return $this->$attr;
		}
	}
	/**
	 * Saves actual object to $var by reference.
	 * Useful when need to break chain.
	 * @param phpQueryObject $var
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function toReference(&$var) {
		return $var = $this;
	}
	public function documentFragment($state = null) {
		if ($state) {
			phpQuery::$documents[$this->getDocumentID()]['documentFragment'] = $state;
			return $this;
		}
		return $this->documentFragment;
	}
	/**
   * @access private
   * @TODO documentWrapper
	 */
	protected function isRoot( $node) {
//		return $node instanceof DOMDOCUMENT || $node->tagName == 'html';
		return $node instanceof DOMDOCUMENT
			|| ($node instanceof DOMELEMENT && $node->tagName == 'html')
			|| $this->root->isSameNode($node);
	}
	/**
   * @access private
	 */
	protected function stackIsRoot() {
		return $this->size() == 1 && $this->isRoot($this->elements[0]);
	}
	/**
	 * Enter description here...
	 * NON JQUERY METHOD
	 *
	 * Watch out, it doesn't creates new instance, can be reverted with end().
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function toRoot() {
		$this->elements = array($this->root);
		return $this;
//		return $this->newInstance(array($this->root));
	}
	/**
	 * Saves object's DocumentID to $var by reference.
	 * <code>
	 * $myDocumentId;
	 * phpQuery::newDocument('<div/>')
	 *     ->getDocumentIDRef($myDocumentId)
	 *     ->find('div')->...
	 * </code>
	 *
	 * @param unknown_type $domId
	 * @see phpQuery::newDocument
	 * @see phpQuery::newDocumentFile
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function getDocumentIDRef(&$documentID) {
		$documentID = $this->getDocumentID();
		return $this;
	}
	/**
	 * Returns object with stack set to document root.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function getDocument() {
		return phpQuery::getDocument($this->getDocumentID());
	}
	/**
	 *
	 * @return DOMDocument
	 */
	public function getDOMDocument() {
		return $this->document;
	}
	/**
	 * Get object's Document ID.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function getDocumentID() {
		return $this->documentID;
	}
	/**
	 * Unloads whole document from memory.
	 * CAUTION! None further operations will be possible on this document.
	 * All objects refering to it will be useless.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function unloadDocument() {
		phpQuery::unloadDocuments($this->getDocumentID());
	}
	public function isHTML() {
		return $this->documentWrapper->isHTML;
	}
	public function isXHTML() {
		return $this->documentWrapper->isXHTML;
	}
	public function isXML() {
		return $this->documentWrapper->isXML;
	}
	/**
	 * Enter description here...
	 *
	 * @link http://docs.jquery.com/Ajax/serialize
	 * @return string
	 */
	public function serialize() {
		return phpQuery::param($this->serializeArray());
	}
	/**
	 * Enter description here...
	 *
	 * @link http://docs.jquery.com/Ajax/serializeArray
	 * @return array
	 */
	public function serializeArray($submit = null) {
		$source = $this->filter('form, input, select, textarea')
			->find('input, select, textarea')
			->andSelf()
			->not('form');
		$return = array();
//		$source->dumpDie();
		foreach($source as $input) {
			$input = phpQuery::pq($input);
			if ($input->is('[disabled]'))
				continue;
			if (!$input->is('[name]'))
				continue;
			if ($input->is('[type=checkbox]') && !$input->is('[checked]'))
				continue;
			// jquery diff
			if ($submit && $input->is('[type=submit]')) {
				if ($submit instanceof DOMELEMENT && ! $input->elements[0]->isSameNode($submit))
					continue;
				else if (is_string($submit) && $input->attr('name') != $submit)
					continue;
			}
			$return[] = array(
				'name' => $input->attr('name'),
				'value' => $input->val(),
			);
		}
		return $return;
	}
	/**
	 * @access private
	 */
	protected function debug($in) {
		if (! phpQuery::$debug )
			return;
		print('<pre>');
		print_r($in);
		// file debug
//		file_put_contents(dirname(__FILE__).'/phpQuery.log', print_r($in, true)."\n", FILE_APPEND);
		// quite handy debug trace
//		if ( is_array($in))
//			print_r(array_slice(debug_backtrace(), 3));
		print("</pre>\n");
	}
	/**
	 * @access private
	 */
	protected function isRegexp($pattern) {
		return in_array(
			$pattern[ mb_strlen($pattern)-1 ],
			array('^','*','$')
		);
	}
	/**
	 * Determines if $char is really a char.
	 *
	 * @param string $char
	 * @return bool
	 * @todo rewrite me to charcode range ! ;)
	 * @access private
	 */
	protected function isChar($char) {
		return extension_loaded('mbstring') && phpQuery::$mbstringSupport
			? mb_eregi('\w', $char)
			: preg_match('@\w@', $char);
	}
	/**
	 * @access private
	 */
	protected function parseSelector($query) {
		// clean spaces
		// TODO include this inside parsing ?
		$query = trim(
			preg_replace('@\s+@', ' ',
				preg_replace('@\s*(>|\\+|~)\s*@', '\\1', $query)
			)
		);
		$queries = array(array());
		if (! $query)
			return $queries;
		$return =& $queries[0];
		$specialChars = array('>',' ');
//		$specialCharsMapping = array('/' => '>');
		$specialCharsMapping = array();
		$strlen = mb_strlen($query);
		$classChars = array('.', '-');
		$pseudoChars = array('-');
		$tagChars = array('*', '|', '-');
		// split multibyte string
		// http://code.google.com/p/phpquery/issues/detail?id=76
		$_query = array();
		for ($i=0; $i<$strlen; $i++)
			$_query[] = mb_substr($query, $i, 1);
		$query = $_query;
		// it works, but i dont like it...
		$i = 0;
		while( $i < $strlen) {
			$c = $query[$i];
			$tmp = '';
			// TAG
			if ($this->isChar($c) || in_array($c, $tagChars)) {
				while(isset($query[$i])
					&& ($this->isChar($query[$i]) || in_array($query[$i], $tagChars))) {
					$tmp .= $query[$i];
					$i++;
				}
				$return[] = $tmp;
			// IDs
			} else if ( $c == '#') {
				$i++;
				while( isset($query[$i]) && ($this->isChar($query[$i]) || $query[$i] == '-')) {
					$tmp .= $query[$i];
					$i++;
				}
				$return[] = '#'.$tmp;
			// SPECIAL CHARS
			} else if (in_array($c, $specialChars)) {
				$return[] = $c;
				$i++;
			// MAPPED SPECIAL MULTICHARS
//			} else if ( $c.$query[$i+1] == '//') {
//				$return[] = ' ';
//				$i = $i+2;
			// MAPPED SPECIAL CHARS
			} else if ( isset($specialCharsMapping[$c])) {
				$return[] = $specialCharsMapping[$c];
				$i++;
			// COMMA
			} else if ( $c == ',') {
				$queries[] = array();
				$return =& $queries[ count($queries)-1 ];
				$i++;
				while( isset($query[$i]) && $query[$i] == ' ')
					$i++;
			// CLASSES
			} else if ($c == '.') {
				while( isset($query[$i]) && ($this->isChar($query[$i]) || in_array($query[$i], $classChars))) {
					$tmp .= $query[$i];
					$i++;
				}
				$return[] = $tmp;
			// ~ General Sibling Selector
			} else if ($c == '~') {
				$spaceAllowed = true;
				$tmp .= $query[$i++];
				while( isset($query[$i])
					&& ($this->isChar($query[$i])
						|| in_array($query[$i], $classChars)
						|| $query[$i] == '*'
						|| ($query[$i] == ' ' && $spaceAllowed)
					)) {
					if ($query[$i] != ' ')
						$spaceAllowed = false;
					$tmp .= $query[$i];
					$i++;
				}
				$return[] = $tmp;
			// + Adjacent sibling selectors
			} else if ($c == '+') {
				$spaceAllowed = true;
				$tmp .= $query[$i++];
				while( isset($query[$i])
					&& ($this->isChar($query[$i])
						|| in_array($query[$i], $classChars)
						|| $query[$i] == '*'
						|| ($spaceAllowed && $query[$i] == ' ')
					)) {
					if ($query[$i] != ' ')
						$spaceAllowed = false;
					$tmp .= $query[$i];
					$i++;
				}
				$return[] = $tmp;
			// ATTRS
			} else if ($c == '[') {
				$stack = 1;
				$tmp .= $c;
				while( isset($query[++$i])) {
					$tmp .= $query[$i];
					if ( $query[$i] == '[') {
						$stack++;
					} else if ( $query[$i] == ']') {
						$stack--;
						if (! $stack )
							break;
					}
				}
				$return[] = $tmp;
				$i++;
			// PSEUDO CLASSES
			} else if ($c == ':') {
				$stack = 1;
				$tmp .= $query[$i++];
				while( isset($query[$i]) && ($this->isChar($query[$i]) || in_array($query[$i], $pseudoChars))) {
					$tmp .= $query[$i];
					$i++;
				}
				// with arguments ?
				if ( isset($query[$i]) && $query[$i] == '(') {
					$tmp .= $query[$i];
					$stack = 1;
					while( isset($query[++$i])) {
						$tmp .= $query[$i];
						if ( $query[$i] == '(') {
							$stack++;
						} else if ( $query[$i] == ')') {
							$stack--;
							if (! $stack )
								break;
						}
					}
					$return[] = $tmp;
					$i++;
				} else {
					$return[] = $tmp;
				}
			} else {
				$i++;
			}
		}
		foreach($queries as $k => $q) {
			if (isset($q[0])) {
				if (isset($q[0][0]) && $q[0][0] == ':')
					array_unshift($queries[$k], '*');
				if ($q[0] != '>')
					array_unshift($queries[$k], ' ');
			}
		}
		return $queries;
	}
	/**
	 * Return matched DOM nodes.
	 *
	 * @param int $index
	 * @return array|DOMElement Single DOMElement or array of DOMElement.
	 */
	public function get($index = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		$return = isset($index)
			? (isset($this->elements[$index]) ? $this->elements[$index] : null)
			: $this->elements;
		// pass thou callbacks
		$args = func_get_args();
		$args = array_slice($args, 1);
		foreach($args as $callback) {
			if (is_array($return))
				foreach($return as $k => $v)
					$return[$k] = phpQuery::callbackRun($callback, array($v));
			else
				$return = phpQuery::callbackRun($callback, array($return));
		}
		return $return;
	}
	/**
	 * Return matched DOM nodes.
	 * jQuery difference.
	 *
	 * @param int $index
	 * @return array|string Returns string if $index != null
	 * @todo implement callbacks
	 * @todo return only arrays ?
	 * @todo maybe other name...
	 */
	public function getString($index = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		if ($index)
			$return = $this->eq($index)->text();
		else {
			$return = array();
			for($i = 0; $i < $this->size(); $i++) {
				$return[] = $this->eq($i)->text();
			}
		}
		// pass thou callbacks
		$args = func_get_args();
		$args = array_slice($args, 1);
		foreach($args as $callback) {
			$return = phpQuery::callbackRun($callback, array($return));
		}
		return $return;
	}
	/**
	 * Return matched DOM nodes.
	 * jQuery difference.
	 *
	 * @param int $index
	 * @return array|string Returns string if $index != null
	 * @todo implement callbacks
	 * @todo return only arrays ?
	 * @todo maybe other name...
	 */
	public function getStrings($index = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		if ($index)
			$return = $this->eq($index)->text();
		else {
			$return = array();
			for($i = 0; $i < $this->size(); $i++) {
				$return[] = $this->eq($i)->text();
			}
			// pass thou callbacks
			$args = func_get_args();
			$args = array_slice($args, 1);
		}
		foreach($args as $callback) {
			if (is_array($return))
				foreach($return as $k => $v)
					$return[$k] = phpQuery::callbackRun($callback, array($v));
			else
				$return = phpQuery::callbackRun($callback, array($return));
		}
		return $return;
	}
	/**
	 * Returns new instance of actual class.
	 *
	 * @param array $newStack Optional. Will replace old stack with new and move old one to history.c
	 */
	public function newInstance($newStack = null) {
		$class = get_class($this);
		// support inheritance by passing old object to overloaded constructor
		$new = $class != 'phpQuery'
			? new $class($this, $this->getDocumentID())
			: new phpQueryObject($this->getDocumentID());
		$new->previous = $this;
		if (is_null($newStack)) {
			$new->elements = $this->elements;
			if ($this->elementsBackup)
				$this->elements = $this->elementsBackup;
		} else if (is_string($newStack)) {
			$new->elements = phpQuery::pq($newStack, $this->getDocumentID())->stack();
		} else {
			$new->elements = $newStack;
		}
		return $new;
	}
	/**
	 * Enter description here...
	 *
	 * In the future, when PHP will support XLS 2.0, then we would do that this way:
	 * contains(tokenize(@class, '\s'), "something")
	 * @param unknown_type $class
	 * @param unknown_type $node
	 * @return boolean
	 * @access private
	 */
	protected function matchClasses($class, $node) {
		// multi-class
		if ( mb_strpos($class, '.', 1)) {
			$classes = explode('.', substr($class, 1));
			$classesCount = count( $classes );
			$nodeClasses = explode(' ', $node->getAttribute('class') );
			$nodeClassesCount = count( $nodeClasses );
			if ( $classesCount > $nodeClassesCount )
				return false;
			$diff = count(
				array_diff(
					$classes,
					$nodeClasses
				)
			);
			if (! $diff )
				return true;
		// single-class
		} else {
			return in_array(
				// strip leading dot from class name
				substr($class, 1),
				// get classes for element as array
				explode(' ', $node->getAttribute('class') )
			);
		}
	}
	/**
	 * @access private
	 */
	protected function runQuery($XQuery, $selector = null, $compare = null) {
		if ($compare && ! method_exists($this, $compare))
			return false;
		$stack = array();
		if (! $this->elements)
			$this->debug('Stack empty, skipping...');
//		var_dump($this->elements[0]->nodeType);
		// element, document
		foreach($this->stack(array(1, 9, 13)) as $k => $stackNode) {
			$detachAfter = false;
			// to work on detached nodes we need temporary place them somewhere
			// thats because context xpath queries sucks ;]
			$testNode = $stackNode;
			while ($testNode) {
				if (! $testNode->parentNode && ! $this->isRoot($testNode)) {
					$this->root->appendChild($testNode);
					$detachAfter = $testNode;
					break;
				}
				$testNode = isset($testNode->parentNode)
					? $testNode->parentNode
					: null;
			}
			// XXX tmp ?
			$xpath = $this->documentWrapper->isXHTML
				? $this->getNodeXpath($stackNode, 'html')
				: $this->getNodeXpath($stackNode);
			// FIXME pseudoclasses-only query, support XML
			$query = $XQuery == '//' && $xpath == '/html[1]'
				? '//*'
				: $xpath.$XQuery;
			$this->debug("XPATH: {$query}");
			// run query, get elements
			$nodes = $this->xpath->query($query);
			$this->debug("QUERY FETCHED");
			if (! $nodes->length )
				$this->debug('Nothing found');
			$debug = array();
			foreach($nodes as $node) {
				$matched = false;
				if ( $compare) {
					phpQuery::$debug ?
						$this->debug("Found: ".$this->whois( $node ).", comparing with {$compare}()")
						: null;
					$phpQueryDebug = phpQuery::$debug;
					phpQuery::$debug = false;
					// TODO ??? use phpQuery::callbackRun()
					if (call_user_func_array(array($this, $compare), array($selector, $node)))
						$matched = true;
					phpQuery::$debug = $phpQueryDebug;
				} else {
					$matched = true;
				}
				if ( $matched) {
					if (phpQuery::$debug)
						$debug[] = $this->whois( $node );
					$stack[] = $node;
				}
			}
			if (phpQuery::$debug) {
				$this->debug("Matched ".count($debug).": ".implode(', ', $debug));
			}
			if ($detachAfter)
				$this->root->removeChild($detachAfter);
		}
		$this->elements = $stack;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function find($selectors, $context = null, $noHistory = false) {
		if (!$noHistory)
			// backup last stack /for end()/
			$this->elementsBackup = $this->elements;
		// allow to define context
		// TODO combine code below with phpQuery::pq() context guessing code
		//   as generic function
		if ($context) {
			if (! is_array($context) && $context instanceof DOMELEMENT)
				$this->elements = array($context);
			else if (is_array($context)) {
				$this->elements = array();
				foreach ($context as $c)
					if ($c instanceof DOMELEMENT)
						$this->elements[] = $c;
			} else if ( $context instanceof self )
				$this->elements = $context->elements;
		}
		$queries = $this->parseSelector($selectors);
		$this->debug(array('FIND', $selectors, $queries));
		$XQuery = '';
		// remember stack state because of multi-queries
		$oldStack = $this->elements;
		// here we will be keeping found elements
		$stack = array();
		foreach($queries as $selector) {
			$this->elements = $oldStack;
			$delimiterBefore = false;
			foreach($selector as $s) {
				// TAG
				$isTag = extension_loaded('mbstring') && phpQuery::$mbstringSupport
					? mb_ereg_match('^[\w|\||-]+$', $s) || $s == '*'
					: preg_match('@^[\w|\||-]+$@', $s) || $s == '*';
				if ($isTag) {
					if ($this->isXML()) {
						// namespace support
						if (mb_strpos($s, '|') !== false) {
							$ns = $tag = null;
							list($ns, $tag) = explode('|', $s);
							$XQuery .= "$ns:$tag";
						} else if ($s == '*') {
							$XQuery .= "*";
						} else {
							$XQuery .= "*[local-name()='$s']";
						}
					} else {
						$XQuery .= $s;
					}
				// ID
				} else if ($s[0] == '#') {
					if ($delimiterBefore)
						$XQuery .= '*';
					$XQuery .= "[@id='".substr($s, 1)."']";
				// ATTRIBUTES
				} else if ($s[0] == '[') {
					if ($delimiterBefore)
						$XQuery .= '*';
					// strip side brackets
					$attr = trim($s, '][');
					$execute = false;
					// attr with specifed value
					if (mb_strpos($s, '=')) {
						$value = null;
						list($attr, $value) = explode('=', $attr);
						$value = trim($value, "'\"");
						if ($this->isRegexp($attr)) {
							// cut regexp character
							$attr = substr($attr, 0, -1);
							$execute = true;
							$XQuery .= "[@{$attr}]";
						} else {
							$XQuery .= "[@{$attr}='{$value}']";
						}
					// attr without specified value
					} else {
						$XQuery .= "[@{$attr}]";
					}
					if ($execute) {
						$this->runQuery($XQuery, $s, 'is');
						$XQuery = '';
						if (! $this->length())
							break;
					}
				// CLASSES
				} else if ($s[0] == '.') {
					// TODO use return $this->find("./self::*[contains(concat(\" \",@class,\" \"), \" $class \")]");
					// thx wizDom ;)
					if ($delimiterBefore)
						$XQuery .= '*';
					$XQuery .= '[@class]';
					$this->runQuery($XQuery, $s, 'matchClasses');
					$XQuery = '';
					if (! $this->length() )
						break;
				// ~ General Sibling Selector
				} else if ($s[0] == '~') {
					$this->runQuery($XQuery);
					$XQuery = '';
					$this->elements = $this
						->siblings(
							substr($s, 1)
						)->elements;
					if (! $this->length() )
						break;
				// + Adjacent sibling selectors
				} else if ($s[0] == '+') {
					// TODO /following-sibling::
					$this->runQuery($XQuery);
					$XQuery = '';
					$subSelector = substr($s, 1);
					$subElements = $this->elements;
					$this->elements = array();
					foreach($subElements as $node) {
						// search first DOMElement sibling
						$test = $node->nextSibling;
						while($test && ! ($test instanceof DOMELEMENT))
							$test = $test->nextSibling;
						if ($test && $this->is($subSelector, $test))
							$this->elements[] = $test;
					}
					if (! $this->length() )
						break;
				// PSEUDO CLASSES
				} else if ($s[0] == ':') {
					// TODO optimization for :first :last
					if ($XQuery) {
						$this->runQuery($XQuery);
						$XQuery = '';
					}
					if (! $this->length())
						break;
					$this->pseudoClasses($s);
					if (! $this->length())
						break;
				// DIRECT DESCENDANDS
				} else if ($s == '>') {
					$XQuery .= '/';
					$delimiterBefore = 2;
				// ALL DESCENDANDS
				} else if ($s == ' ') {
					$XQuery .= '//';
					$delimiterBefore = 2;
				// ERRORS
				} else {
					phpQuery::debug("Unrecognized token '$s'");
				}
				$delimiterBefore = $delimiterBefore === 2;
			}
			// run query if any
			if ($XQuery && $XQuery != '//') {
				$this->runQuery($XQuery);
				$XQuery = '';
			}
			foreach($this->elements as $node)
				if (! $this->elementsContainsNode($node, $stack))
					$stack[] = $node;
		}
		$this->elements = $stack;
		return $this->newInstance();
	}
	/**
	 * @todo create API for classes with pseudoselectors
	 * @access private
	 */
	protected function pseudoClasses($class) {
		// TODO clean args parsing ?
		$class = ltrim($class, ':');
		$haveArgs = mb_strpos($class, '(');
		if ($haveArgs !== false) {
			$args = substr($class, $haveArgs+1, -1);
			$class = substr($class, 0, $haveArgs);
		}
		switch($class) {
			case 'even':
			case 'odd':
				$stack = array();
				foreach($this->elements as $i => $node) {
					if ($class == 'even' && ($i%2) == 0)
						$stack[] = $node;
					else if ( $class == 'odd' && $i % 2 )
						$stack[] = $node;
				}
				$this->elements = $stack;
				break;
			case 'eq':
				$k = intval($args);
				$this->elements = isset( $this->elements[$k] )
					? array( $this->elements[$k] )
					: array();
				break;
			case 'gt':
				$this->elements = array_slice($this->elements, $args+1);
				break;
			case 'lt':
				$this->elements = array_slice($this->elements, 0, $args+1);
				break;
			case 'first':
				if (isset($this->elements[0]))
					$this->elements = array($this->elements[0]);
				break;
			case 'last':
				if ($this->elements)
					$this->elements = array($this->elements[count($this->elements)-1]);
				break;
			/*case 'parent':
				$stack = array();
				foreach($this->elements as $node) {
					if ( $node->childNodes->length )
						$stack[] = $node;
				}
				$this->elements = $stack;
				break;*/
			case 'contains':
				$text = trim($args, "\"'");
				$stack = array();
				foreach($this->elements as $node) {
					if (mb_stripos($node->textContent, $text) === false)
						continue;
					$stack[] = $node;
				}
				$this->elements = $stack;
				break;
			case 'not':
				$selector = self::unQuote($args);
				$this->elements = $this->not($selector)->stack();
				break;
			case 'slice':
				// TODO jQuery difference ?
				$args = explode(',',
					str_replace(', ', ',', trim($args, "\"'"))
				);
				$start = $args[0];
				$end = isset($args[1])
					? $args[1]
					: null;
				if ($end > 0)
					$end = $end-$start;
				$this->elements = array_slice($this->elements, $start, $end);
				break;
			case 'has':
				$selector = trim($args, "\"'");
				$stack = array();
				foreach($this->stack(1) as $el) {
					if ($this->find($selector, $el, true)->length)
						$stack[] = $el;
				}
				$this->elements = $stack;
				break;
			case 'submit':
			case 'reset':
				$this->elements = phpQuery::merge(
					$this->map(array($this, 'is'),
						"input[type=$class]", new CallbackParam()
					),
					$this->map(array($this, 'is'),
						"button[type=$class]", new CallbackParam()
					)
				);
			break;
//				$stack = array();
//				foreach($this->elements as $node)
//					if ($node->is('input[type=submit]') || $node->is('button[type=submit]'))
//						$stack[] = $el;
//				$this->elements = $stack;
			case 'input':
				$this->elements = $this->map(
					array($this, 'is'),
					'input', new CallbackParam()
				)->elements;
			break;
			case 'password':
			case 'checkbox':
			case 'radio':
			case 'hidden':
			case 'image':
			case 'file':
				$this->elements = $this->map(
					array($this, 'is'),
					"input[type=$class]", new CallbackParam()
				)->elements;
			break;
			case 'parent':
				$this->elements = $this->map(
					create_function('$node', '
						return $node instanceof DOMELEMENT && $node->childNodes->length
							? $node : null;')
				)->elements;
			break;
			case 'empty':
				$this->elements = $this->map(
					create_function('$node', '
						return $node instanceof DOMELEMENT && $node->childNodes->length
							? null : $node;')
				)->elements;
			break;
			case 'disabled':
			case 'selected':
			case 'checked':
				$this->elements = $this->map(
					array($this, 'is'),
					"[$class]", new CallbackParam()
				)->elements;
			break;
			case 'enabled':
				$this->elements = $this->map(
					create_function('$node', '
						return pq($node)->not(":disabled") ? $node : null;')
				)->elements;
			break;
			case 'header':
				$this->elements = $this->map(
					create_function('$node',
						'$isHeader = isset($node->tagName) && in_array($node->tagName, array(
							"h1", "h2", "h3", "h4", "h5", "h6", "h7"
						));
						return $isHeader
							? $node
							: null;')
				)->elements;
//				$this->elements = $this->map(
//					create_function('$node', '$node = pq($node);
//						return $node->is("h1")
//							|| $node->is("h2")
//							|| $node->is("h3")
//							|| $node->is("h4")
//							|| $node->is("h5")
//							|| $node->is("h6")
//							|| $node->is("h7")
//							? $node
//							: null;')
//				)->elements;
			break;
			case 'only-child':
				$this->elements = $this->map(
					create_function('$node',
						'return pq($node)->siblings()->size() == 0 ? $node : null;')
				)->elements;
			break;
			case 'first-child':
				$this->elements = $this->map(
					create_function('$node', 'return pq($node)->prevAll()->size() == 0 ? $node : null;')
				)->elements;
			break;
			case 'last-child':
				$this->elements = $this->map(
					create_function('$node', 'return pq($node)->nextAll()->size() == 0 ? $node : null;')
				)->elements;
			break;
			case 'nth-child':
				$param = trim($args, "\"'");
				if (! $param)
					break;
					// nth-child(n+b) to nth-child(1n+b)
				if ($param{0} == 'n')
					$param = '1'.$param;
				// :nth-child(index/even/odd/equation)
				if ($param == 'even' || $param == 'odd')
					$mapped = $this->map(
						create_function('$node, $param',
							'$index = pq($node)->prevAll()->size()+1;
							if ($param == "even" && ($index%2) == 0)
								return $node;
							else if ($param == "odd" && $index%2 == 1)
								return $node;
							else
								return null;'),
						new CallbackParam(), $param
					);
				else if (mb_strlen($param) > 1 && $param{1} == 'n')
					// an+b
					$mapped = $this->map(
						create_function('$node, $param',
							'$prevs = pq($node)->prevAll()->size();
							$index = 1+$prevs;
							$b = mb_strlen($param) > 3
								? $param{3}
								: 0;
							$a = $param{0};
							if ($b && $param{2} == "-")
								$b = -$b;
							if ($a > 0) {
								return ($index-$b)%$a == 0
									? $node
									: null;
								phpQuery::debug($a."*".floor($index/$a)."+$b-1 == ".($a*floor($index/$a)+$b-1)." ?= $prevs");
								return $a*floor($index/$a)+$b-1 == $prevs
										? $node
										: null;
							} else if ($a == 0)
								return $index == $b
										? $node
										: null;
							else
								// negative value
								return $index <= $b
										? $node
										: null;
//							if (! $b)
//								return $index%$a == 0
//									? $node
//									: null;
//							else
//								return ($index-$b)%$a == 0
//									? $node
//									: null;
							'),
						new CallbackParam(), $param
					);
				else
					// index
					$mapped = $this->map(
						create_function('$node, $index',
							'$prevs = pq($node)->prevAll()->size();
							if ($prevs && $prevs == $index-1)
								return $node;
							else if (! $prevs && $index == 1)
								return $node;
							else
								return null;'),
						new CallbackParam(), $param
					);
				$this->elements = $mapped->elements;
			break;
			default:
				$this->debug("Unknown pseudoclass '{$class}', skipping...");
		}
	}
	/**
	 * @access private
	 */
	protected function __pseudoClassParam($paramsString) {
		// TODO;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function is($selector, $nodes = null) {
		phpQuery::debug(array("Is:", $selector));
		if (! $selector)
			return false;
		$oldStack = $this->elements;
		$returnArray = false;
		if ($nodes && is_array($nodes)) {
			$this->elements = $nodes;
		} else if ($nodes)
			$this->elements = array($nodes);
		$this->filter($selector, true);
		$stack = $this->elements;
		$this->elements = $oldStack;
		if ($nodes)
			return $stack ? $stack : null;
		return (bool)count($stack);
	}
	/**
	 * Enter description here...
	 * jQuery difference.
	 *
	 * Callback:
	 * - $index int
	 * - $node DOMNode
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @link http://docs.jquery.com/Traversing/filter
	 */
	public function filterCallback($callback, $_skipHistory = false) {
		if (! $_skipHistory) {
			$this->elementsBackup = $this->elements;
			$this->debug("Filtering by callback");
		}
		$newStack = array();
		foreach($this->elements as $index => $node) {
			$result = phpQuery::callbackRun($callback, array($index, $node));
			if (is_null($result) || (! is_null($result) && $result))
				$newStack[] = $node;
		}
		$this->elements = $newStack;
		return $_skipHistory
			? $this
			: $this->newInstance();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @link http://docs.jquery.com/Traversing/filter
	 */
	public function filter($selectors, $_skipHistory = false) {
		if ($selectors instanceof Callback OR $selectors instanceof Closure)
			return $this->filterCallback($selectors, $_skipHistory);
		if (! $_skipHistory)
			$this->elementsBackup = $this->elements;
		$notSimpleSelector = array(' ', '>', '~', '+', '/');
		if (! is_array($selectors))
			$selectors = $this->parseSelector($selectors);
		if (! $_skipHistory)
			$this->debug(array("Filtering:", $selectors));
		$finalStack = array();
		foreach($selectors as $selector) {
			$stack = array();
			if (! $selector)
				break;
			// avoid first space or /
			if (in_array($selector[0], $notSimpleSelector))
				$selector = array_slice($selector, 1);
			// PER NODE selector chunks
			foreach($this->stack() as $node) {
				$break = false;
				foreach($selector as $s) {
					if (!($node instanceof DOMELEMENT)) {
						// all besides DOMElement
						if ( $s[0] == '[') {
							$attr = trim($s, '[]');
							if ( mb_strpos($attr, '=')) {
								list( $attr, $val ) = explode('=', $attr);
								if ($attr == 'nodeType' && $node->nodeType != $val)
									$break = true;
							}
						} else
							$break = true;
					} else {
						// DOMElement only
						// ID
						if ( $s[0] == '#') {
							if ( $node->getAttribute('id') != substr($s, 1) )
								$break = true;
						// CLASSES
						} else if ( $s[0] == '.') {
							if (! $this->matchClasses( $s, $node ) )
								$break = true;
						// ATTRS
						} else if ( $s[0] == '[') {
							// strip side brackets
							$attr = trim($s, '[]');
							if (mb_strpos($attr, '=')) {
								list($attr, $val) = explode('=', $attr);
								$val = self::unQuote($val);
								if ($attr == 'nodeType') {
									if ($val != $node->nodeType)
										$break = true;
								} else if ($this->isRegexp($attr)) {
									$val = extension_loaded('mbstring') && phpQuery::$mbstringSupport
										? quotemeta(trim($val, '"\''))
										: preg_quote(trim($val, '"\''), '@');
									// switch last character
									switch( substr($attr, -1)) {
										// quotemeta used insted of preg_quote
										// http://code.google.com/p/phpquery/issues/detail?id=76
										case '^':
											$pattern = '^'.$val;
											break;
										case '*':
											$pattern = '.*'.$val.'.*';
											break;
										case '$':
											$pattern = '.*'.$val.'$';
											break;
									}
									// cut last character
									$attr = substr($attr, 0, -1);
									$isMatch = extension_loaded('mbstring') && phpQuery::$mbstringSupport
										? mb_ereg_match($pattern, $node->getAttribute($attr))
										: preg_match("@{$pattern}@", $node->getAttribute($attr));
									if (! $isMatch)
										$break = true;
								} else if ($node->getAttribute($attr) != $val)
									$break = true;
							} else if (! $node->hasAttribute($attr))
								$break = true;
						// PSEUDO CLASSES
						} else if ( $s[0] == ':') {
							// skip
						// TAG
						} else if (trim($s)) {
							if ($s != '*') {
								// TODO namespaces
								if (isset($node->tagName)) {
									if ($node->tagName != $s)
										$break = true;
								} else if ($s == 'html' && ! $this->isRoot($node))
									$break = true;
							}
						// AVOID NON-SIMPLE SELECTORS
						} else if (in_array($s, $notSimpleSelector)) {
							$break = true;
							$this->debug(array('Skipping non simple selector', $selector));
						}
					}
					if ($break)
						break;
				}
				// if element passed all chunks of selector - add it to new stack
				if (! $break )
					$stack[] = $node;
			}
			$tmpStack = $this->elements;
			$this->elements = $stack;
			// PER ALL NODES selector chunks
			foreach($selector as $s)
				// PSEUDO CLASSES
				if ($s[0] == ':')
					$this->pseudoClasses($s);
			foreach($this->elements as $node)
				// XXX it should be merged without duplicates
				// but jQuery doesnt do that
				$finalStack[] = $node;
			$this->elements = $tmpStack;
		}
		$this->elements = $finalStack;
		if ($_skipHistory) {
			return $this;
		} else {
			$this->debug("Stack length after filter(): ".count($finalStack));
			return $this->newInstance();
		}
	}
	/**
	 *
	 * @param $value
	 * @return unknown_type
	 * @TODO implement in all methods using passed parameters
	 */
	protected static function unQuote($value) {
		return $value[0] == '\'' || $value[0] == '"'
			? substr($value, 1, -1)
			: $value;
	}
	/**
	 * Enter description here...
	 *
	 * @link http://docs.jquery.com/Ajax/load
	 * @return phpQuery|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo Support $selector
	 */
	public function load($url, $data = null, $callback = null) {
		if ($data && ! is_array($data)) {
			$callback = $data;
			$data = null;
		}
		if (mb_strpos($url, ' ') !== false) {
			$matches = null;
			if (extension_loaded('mbstring') && phpQuery::$mbstringSupport)
				mb_ereg('^([^ ]+) (.*)$', $url, $matches);
			else
				preg_match('^([^ ]+) (.*)$', $url, $matches);
			$url = $matches[1];
			$selector = $matches[2];
			// FIXME this sucks, pass as callback param
			$this->_loadSelector = $selector;
		}
		$ajax = array(
			'url' => $url,
			'type' => $data ? 'POST' : 'GET',
			'data' => $data,
			'complete' => $callback,
			'success' => array($this, '__loadSuccess')
		);
		phpQuery::ajax($ajax);
		return $this;
	}
	/**
	 * @access private
	 * @param $html
	 * @return unknown_type
	 */
	public function __loadSuccess($html) {
		if ($this->_loadSelector) {
			$html = phpQuery::newDocument($html)->find($this->_loadSelector);
			unset($this->_loadSelector);
		}
		foreach($this->stack(1) as $node) {
			phpQuery::pq($node, $this->getDocumentID())
				->markup($html);
		}
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQuery|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo
	 */
	public function css() {
		// TODO
		return $this;
	}
	/**
	 * @todo
	 *
	 */
	public function show(){
		// TODO
		return $this;
	}
	/**
	 * @todo
	 *
	 */
	public function hide(){
		// TODO
		return $this;
	}
	/**
	 * Trigger a type of event on every matched element.
	 *
	 * @param unknown_type $type
	 * @param unknown_type $data
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @TODO support more than event in $type (space-separated)
	 */
	public function trigger($type, $data = array()) {
		foreach($this->elements as $node)
			phpQueryEvents::trigger($this->getDocumentID(), $type, $data, $node);
		return $this;
	}
	/**
	 * This particular method triggers all bound event handlers on an element (for a specific event type) WITHOUT executing the browsers default actions.
	 *
	 * @param unknown_type $type
	 * @param unknown_type $data
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @TODO
	 */
	public function triggerHandler($type, $data = array()) {
		// TODO;
	}
	/**
	 * Binds a handler to one or more events (like click) for each matched element.
	 * Can also bind custom events.
	 *
	 * @param unknown_type $type
	 * @param unknown_type $data Optional
	 * @param unknown_type $callback
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @TODO support '!' (exclusive) events
	 * @TODO support more than event in $type (space-separated)
	 */
	public function bind($type, $data, $callback = null) {
		// TODO check if $data is callable, not using is_callable
		if (! isset($callback)) {
			$callback = $data;
			$data = null;
		}
		foreach($this->elements as $node)
			phpQueryEvents::add($this->getDocumentID(), $node, $type, $data, $callback);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param unknown_type $type
	 * @param unknown_type $callback
	 * @return unknown
	 * @TODO namespace events
	 * @TODO support more than event in $type (space-separated)
	 */
	public function unbind($type = null, $callback = null) {
		foreach($this->elements as $node)
			phpQueryEvents::remove($this->getDocumentID(), $node, $type, $callback);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function change($callback = null) {
		if ($callback)
			return $this->bind('change', $callback);
		return $this->trigger('change');
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function submit($callback = null) {
		if ($callback)
			return $this->bind('submit', $callback);
		return $this->trigger('submit');
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function click($callback = null) {
		if ($callback)
			return $this->bind('click', $callback);
		return $this->trigger('click');
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapAllOld($wrapper) {
		$wrapper = pq($wrapper)->_clone();
		if (! $wrapper->length() || ! $this->length() )
			return $this;
		$wrapper->insertBefore($this->elements[0]);
		$deepest = $wrapper->elements[0];
		while($deepest->firstChild && $deepest->firstChild instanceof DOMELEMENT)
			$deepest = $deepest->firstChild;
		pq($deepest)->append($this);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * TODO testme...
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapAll($wrapper) {
		if (! $this->length())
			return $this;
		return phpQuery::pq($wrapper, $this->getDocumentID())
			->clone()
			->insertBefore($this->get(0))
			->map(array($this, '___wrapAllCallback'))
			->append($this);
	}
  /**
   *
	 * @param $node
	 * @return unknown_type
	 * @access private
   */
	public function ___wrapAllCallback($node) {
		$deepest = $node;
		while($deepest->firstChild && $deepest->firstChild instanceof DOMELEMENT)
			$deepest = $deepest->firstChild;
		return $deepest;
	}
	/**
	 * Enter description here...
	 * NON JQUERY METHOD
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapAllPHP($codeBefore, $codeAfter) {
		return $this
			->slice(0, 1)
				->beforePHP($codeBefore)
			->end()
			->slice(-1)
				->afterPHP($codeAfter)
			->end();
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrap($wrapper) {
		foreach($this->stack() as $node)
			phpQuery::pq($node, $this->getDocumentID())->wrapAll($wrapper);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapPHP($codeBefore, $codeAfter) {
		foreach($this->stack() as $node)
			phpQuery::pq($node, $this->getDocumentID())->wrapAllPHP($codeBefore, $codeAfter);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapInner($wrapper) {
		foreach($this->stack() as $node)
			phpQuery::pq($node, $this->getDocumentID())->contents()->wrapAll($wrapper);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapInnerPHP($codeBefore, $codeAfter) {
		foreach($this->stack(1) as $node)
			phpQuery::pq($node, $this->getDocumentID())->contents()
				->wrapAllPHP($codeBefore, $codeAfter);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @testme Support for text nodes
	 */
	public function contents() {
		$stack = array();
		foreach($this->stack(1) as $el) {
			// FIXME (fixed) http://code.google.com/p/phpquery/issues/detail?id=56
//			if (! isset($el->childNodes))
//				continue;
			foreach($el->childNodes as $node) {
				$stack[] = $node;
			}
		}
		return $this->newInstance($stack);
	}
	/**
	 * Enter description here...
	 *
	 * jQuery difference.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function contentsUnwrap() {
		foreach($this->stack(1) as $node) {
			if (! $node->parentNode )
				continue;
			$childNodes = array();
			// any modification in DOM tree breaks childNodes iteration, so cache them first
			foreach($node->childNodes as $chNode )
				$childNodes[] = $chNode;
			foreach($childNodes as $chNode )
//				$node->parentNode->appendChild($chNode);
				$node->parentNode->insertBefore($chNode, $node);
			$node->parentNode->removeChild($node);
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * jQuery difference.
	 */
	public function switchWith($markup) {
		$markup = pq($markup, $this->getDocumentID());
		$content = null;
		foreach($this->stack(1) as $node) {
			pq($node)
				->contents()->toReference($content)->end()
				->replaceWith($markup->clone()->append($content));
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function eq($num) {
		$oldStack = $this->elements;
		$this->elementsBackup = $this->elements;
		$this->elements = array();
		if ( isset($oldStack[$num]) )
			$this->elements[] = $oldStack[$num];
		return $this->newInstance();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function size() {
		return count($this->elements);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @deprecated Use length as attribute
	 */
	public function length() {
		return $this->size();
	}
	public function count() {
		return $this->size();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo $level
	 */
	public function end($level = 1) {
//		$this->elements = array_pop( $this->history );
//		return $this;
//		$this->previous->DOM = $this->DOM;
//		$this->previous->XPath = $this->XPath;
		return $this->previous
			? $this->previous
			: $this;
	}
	/**
	 * Enter description here...
	 * Normal use ->clone() .
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @access private
	 */
	public function _clone() {
		$newStack = array();
		//pr(array('copy... ', $this->whois()));
		//$this->dumpHistory('copy');
		$this->elementsBackup = $this->elements;
		foreach($this->elements as $node) {
			$newStack[] = $node->cloneNode(true);
		}
		$this->elements = $newStack;
		return $this->newInstance();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function replaceWithPHP($code) {
		return $this->replaceWith(phpQuery::php($code));
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery $content
	 * @link http://docs.jquery.com/Manipulation/replaceWith#content
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function replaceWith($content) {
		return $this->after($content)->remove();
	}
	/**
	 * Enter description here...
	 *
	 * @param String $selector
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo this works ?
	 */
	public function replaceAll($selector) {
		foreach(phpQuery::pq($selector, $this->getDocumentID()) as $node)
			phpQuery::pq($node, $this->getDocumentID())
				->after($this->_clone())
				->remove();
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function remove($selector = null) {
		$loop = $selector
			? $this->filter($selector)->elements
			: $this->elements;
		foreach($loop as $node) {
			if (! $node->parentNode )
				continue;
			if (isset($node->tagName))
				$this->debug("Removing '{$node->tagName}'");
			$node->parentNode->removeChild($node);
			// Mutation event
			$event = new DOMEvent(array(
				'target' => $node,
				'type' => 'DOMNodeRemoved'
			));
			phpQueryEvents::trigger($this->getDocumentID(),
				$event->type, array($event), $node
			);
		}
		return $this;
	}
	protected function markupEvents($newMarkup, $oldMarkup, $node) {
		if ($node->tagName == 'textarea' && $newMarkup != $oldMarkup) {
			$event = new DOMEvent(array(
				'target' => $node,
				'type' => 'change'
			));
			phpQueryEvents::trigger($this->getDocumentID(),
				$event->type, array($event), $node
			);
		}
	}
	/**
	 * jQuey difference
	 *
	 * @param $markup
	 * @return unknown_type
	 * @TODO trigger change event for textarea
	 */
	public function markup($markup = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		$args = func_get_args();
		if ($this->documentWrapper->isXML)
			return call_user_func_array(array($this, 'xml'), $args);
		else
			return call_user_func_array(array($this, 'html'), $args);
	}
	/**
	 * jQuey difference
	 *
	 * @param $markup
	 * @return unknown_type
	 */
	public function markupOuter($callback1 = null, $callback2 = null, $callback3 = null) {
		$args = func_get_args();
		if ($this->documentWrapper->isXML)
			return call_user_func_array(array($this, 'xmlOuter'), $args);
		else
			return call_user_func_array(array($this, 'htmlOuter'), $args);
	}
	/**
	 * Enter description here...
	 *
	 * @param unknown_type $html
	 * @return string|phpQuery|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @TODO force html result
	 */
	public function html($html = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		if (isset($html)) {
			// INSERT
			$nodes = $this->documentWrapper->import($html);
			$this->empty();
			foreach($this->stack(1) as $alreadyAdded => $node) {
				// for now, limit events for textarea
				if (($this->isXHTML() || $this->isHTML()) && $node->tagName == 'textarea')
					$oldHtml = pq($node, $this->getDocumentID())->markup();
				foreach($nodes as $newNode) {
					$node->appendChild($alreadyAdded
						? $newNode->cloneNode(true)
						: $newNode
					);
				}
				// for now, limit events for textarea
				if (($this->isXHTML() || $this->isHTML()) && $node->tagName == 'textarea')
					$this->markupEvents($html, $oldHtml, $node);
			}
			return $this;
		} else {
			// FETCH
			$return = $this->documentWrapper->markup($this->elements, true);
			$args = func_get_args();
			foreach(array_slice($args, 1) as $callback) {
				$return = phpQuery::callbackRun($callback, array($return));
			}
			return $return;
		}
	}
	/**
	 * @TODO force xml result
	 */
	public function xml($xml = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		$args = func_get_args();
		return call_user_func_array(array($this, 'html'), $args);
	}
	/**
	 * Enter description here...
	 * @TODO force html result
	 *
	 * @return String
	 */
	public function htmlOuter($callback1 = null, $callback2 = null, $callback3 = null) {
		$markup = $this->documentWrapper->markup($this->elements);
		// pass thou callbacks
		$args = func_get_args();
		foreach($args as $callback) {
			$markup = phpQuery::callbackRun($callback, array($markup));
		}
		return $markup;
	}
	/**
	 * @TODO force xml result
	 */
	public function xmlOuter($callback1 = null, $callback2 = null, $callback3 = null) {
		$args = func_get_args();
		return call_user_func_array(array($this, 'htmlOuter'), $args);
	}
	public function __toString() {
		return $this->markupOuter();
	}
	/**
	 * Just like html(), but returns markup with VALID (dangerous) PHP tags.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo support returning markup with PHP tags when called without param
	 */
	public function php($code = null) {
		return $this->markupPHP($code);
	}
	/**
	 * Enter description here...
	 * 
	 * @param $code
	 * @return unknown_type
	 */
	public function markupPHP($code = null) {
		return isset($code)
			? $this->markup(phpQuery::php($code))
			: phpQuery::markupToPHP($this->markup());
	}
	/**
	 * Enter description here...
	 * 
	 * @param $code
	 * @return unknown_type
	 */
	public function markupOuterPHP() {
		return phpQuery::markupToPHP($this->markupOuter());
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function children($selector = null) {
		$stack = array();
		foreach($this->stack(1) as $node) {
//			foreach($node->getElementsByTagName('*') as $newNode) {
			foreach($node->childNodes as $newNode) {
				if ($newNode->nodeType != 1)
					continue;
				if ($selector && ! $this->is($selector, $newNode))
					continue;
				if ($this->elementsContainsNode($newNode, $stack))
					continue;
				$stack[] = $newNode;
			}
		}
		$this->elementsBackup = $this->elements;
		$this->elements = $stack;
		return $this->newInstance();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function ancestors($selector = null) {
		return $this->children( $selector );
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function append( $content) {
		return $this->insert($content, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function appendPHP( $content) {
		return $this->insert("<php><!-- {$content} --></php>", 'append');
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function appendTo( $seletor) {
		return $this->insert($seletor, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function prepend( $content) {
		return $this->insert($content, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @todo accept many arguments, which are joined, arrays maybe also
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function prependPHP( $content) {
		return $this->insert("<php><!-- {$content} --></php>", 'prepend');
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function prependTo( $seletor) {
		return $this->insert($seletor, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function before($content) {
		return $this->insert($content, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function beforePHP( $content) {
		return $this->insert("<php><!-- {$content} --></php>", 'before');
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function insertBefore( $seletor) {
		return $this->insert($seletor, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function after( $content) {
		return $this->insert($content, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function afterPHP( $content) {
		return $this->insert("<php><!-- {$content} --></php>", 'after');
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function insertAfter( $seletor) {
		return $this->insert($seletor, __FUNCTION__);
	}
	/**
	 * Internal insert method. Don't use it.
	 *
	 * @param unknown_type $target
	 * @param unknown_type $type
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @access private
	 */
	public function insert($target, $type) {
		$this->debug("Inserting data with '{$type}'");
		$to = false;
		switch( $type) {
			case 'appendTo':
			case 'prependTo':
			case 'insertBefore':
			case 'insertAfter':
				$to = true;
		}
		switch(gettype($target)) {
			case 'string':
				$insertFrom = $insertTo = array();
				if ($to) {
					// INSERT TO
					$insertFrom = $this->elements;
					if (phpQuery::isMarkup($target)) {
						// $target is new markup, import it
						$insertTo = $this->documentWrapper->import($target);
					// insert into selected element
					} else {
						// $tagret is a selector
						$thisStack = $this->elements;
						$this->toRoot();
						$insertTo = $this->find($target)->elements;
						$this->elements = $thisStack;
					}
				} else {
					// INSERT FROM
					$insertTo = $this->elements;
					$insertFrom = $this->documentWrapper->import($target);
				}
				break;
			case 'object':
				$insertFrom = $insertTo = array();
				// phpQuery
				if ($target instanceof self) {
					if ($to) {
						$insertTo = $target->elements;
						if ($this->documentFragment && $this->stackIsRoot())
							// get all body children
//							$loop = $this->find('body > *')->elements;
							// TODO test it, test it hard...
//							$loop = $this->newInstance($this->root)->find('> *')->elements;
							$loop = $this->root->childNodes;
						else
							$loop = $this->elements;
						// import nodes if needed
						$insertFrom = $this->getDocumentID() == $target->getDocumentID()
							? $loop
							: $target->documentWrapper->import($loop);
					} else {
						$insertTo = $this->elements;
						if ( $target->documentFragment && $target->stackIsRoot() )
							// get all body children
//							$loop = $target->find('body > *')->elements;
							$loop = $target->root->childNodes;
						else
							$loop = $target->elements;
						// import nodes if needed
						$insertFrom = $this->getDocumentID() == $target->getDocumentID()
							? $loop
							: $this->documentWrapper->import($loop);
					}
				// DOMNODE
				} elseif ($target instanceof DOMNODE) {
					// import node if needed
//					if ( $target->ownerDocument != $this->DOM )
//						$target = $this->DOM->importNode($target, true);
					if ( $to) {
						$insertTo = array($target);
						if ($this->documentFragment && $this->stackIsRoot())
							// get all body children
							$loop = $this->root->childNodes;
//							$loop = $this->find('body > *')->elements;
						else
							$loop = $this->elements;
						foreach($loop as $fromNode)
							// import nodes if needed
							$insertFrom[] = ! $fromNode->ownerDocument->isSameNode($target->ownerDocument)
								? $target->ownerDocument->importNode($fromNode, true)
								: $fromNode;
					} else {
						// import node if needed
						if (! $target->ownerDocument->isSameNode($this->document))
							$target = $this->document->importNode($target, true);
						$insertTo = $this->elements;
						$insertFrom[] = $target;
					}
				}
				break;
		}
		phpQuery::debug("From ".count($insertFrom)."; To ".count($insertTo)." nodes");
		foreach($insertTo as $insertNumber => $toNode) {
			// we need static relative elements in some cases
			switch( $type) {
				case 'prependTo':
				case 'prepend':
					$firstChild = $toNode->firstChild;
					break;
				case 'insertAfter':
				case 'after':
					$nextSibling = $toNode->nextSibling;
					break;
			}
			foreach($insertFrom as $fromNode) {
				// clone if inserted already before
				$insert = $insertNumber
					? $fromNode->cloneNode(true)
					: $fromNode;
				switch($type) {
					case 'appendTo':
					case 'append':
//						$toNode->insertBefore(
//							$fromNode,
//							$toNode->lastChild->nextSibling
//						);
						$toNode->appendChild($insert);
						$eventTarget = $insert;
						break;
					case 'prependTo':
					case 'prepend':
						$toNode->insertBefore(
							$insert,
							$firstChild
						);
						break;
					case 'insertBefore':
					case 'before':
						if (! $toNode->parentNode)
							throw new Exception("No parentNode, can't do {$type}()");
						else
							$toNode->parentNode->insertBefore(
								$insert,
								$toNode
							);
						break;
					case 'insertAfter':
					case 'after':
						if (! $toNode->parentNode)
							throw new Exception("No parentNode, can't do {$type}()");
						else
							$toNode->parentNode->insertBefore(
								$insert,
								$nextSibling
							);
						break;
				}
				// Mutation event
				$event = new DOMEvent(array(
					'target' => $insert,
					'type' => 'DOMNodeInserted'
				));
				phpQueryEvents::trigger($this->getDocumentID(),
					$event->type, array($event), $insert
				);
			}
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return Int
	 */
	public function index($subject) {
		$index = -1;
		$subject = $subject instanceof phpQueryObject
			? $subject->elements[0]
			: $subject;
		foreach($this->newInstance() as $k => $node) {
			if ($node->isSameNode($subject))
				$index = $k;
		}
		return $index;
	}
	/**
	 * Enter description here...
	 *
	 * @param unknown_type $start
	 * @param unknown_type $end
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @testme
	 */
	public function slice($start, $end = null) {
//		$last = count($this->elements)-1;
//		$end = $end
//			? min($end, $last)
//			: $last;
//		if ($start < 0)
//			$start = $last+$start;
//		if ($start > $last)
//			return array();
		if ($end > 0)
			$end = $end-$start;
		return $this->newInstance(
			array_slice($this->elements, $start, $end)
		);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function reverse() {
		$this->elementsBackup = $this->elements;
		$this->elements = array_reverse($this->elements);
		return $this->newInstance();
	}
	/**
	 * Return joined text content.
	 * @return String
	 */
	public function text($text = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		if (isset($text))
			return $this->html(htmlspecialchars($text));
		$args = func_get_args();
		$args = array_slice($args, 1);
		$return = '';
		foreach($this->elements as $node) {
			$text = $node->textContent;
			if (count($this->elements) > 1 && $text)
				$text .= "\n";
			foreach($args as $callback) {
				$text = phpQuery::callbackRun($callback, array($text));
			}
			$return .= $text;
		}
		return $return;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function plugin($class, $file = null) {
		phpQuery::plugin($class, $file);
		return $this;
	}
	/**
	 * Deprecated, use $pq->plugin() instead.
	 *
	 * @deprecated
	 * @param $class
	 * @param $file
	 * @return unknown_type
	 */
	public static function extend($class, $file = null) {
		return $this->plugin($class, $file);
	}
	/**
	 *
	 * @access private
	 * @param $method
	 * @param $args
	 * @return unknown_type
	 */
	public function __call($method, $args) {
		$aliasMethods = array('clone', 'empty');
		if (isset(phpQuery::$extendMethods[$method])) {
			array_unshift($args, $this);
			return phpQuery::callbackRun(
				phpQuery::$extendMethods[$method], $args
			);
		} else if (isset(phpQuery::$pluginsMethods[$method])) {
			array_unshift($args, $this);
			$class = phpQuery::$pluginsMethods[$method];
			$realClass = "phpQueryObjectPlugin_$class";
			$return = call_user_func_array(
				array($realClass, $method),
				$args
			);
			// XXX deprecate ?
			return is_null($return)
				? $this
				: $return;
		} else if (in_array($method, $aliasMethods)) {
			return call_user_func_array(array($this, '_'.$method), $args);
		} else
			throw new Exception("Method '{$method}' doesnt exist");
	}
	/**
	 * Safe rename of next().
	 *
	 * Use it ONLY when need to call next() on an iterated object (in same time).
	 * Normaly there is no need to do such thing ;)
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @access private
	 */
	public function _next($selector = null) {
		return $this->newInstance(
			$this->getElementSiblings('nextSibling', $selector, true)
		);
	}
	/**
	 * Use prev() and next().
	 *
	 * @deprecated
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @access private
	 */
	public function _prev($selector = null) {
		return $this->prev($selector);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function prev($selector = null) {
		return $this->newInstance(
			$this->getElementSiblings('previousSibling', $selector, true)
		);
	}
	/**
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo
	 */
	public function prevAll($selector = null) {
		return $this->newInstance(
			$this->getElementSiblings('previousSibling', $selector)
		);
	}
	/**
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo FIXME: returns source elements insted of next siblings
	 */
	public function nextAll($selector = null) {
		return $this->newInstance(
			$this->getElementSiblings('nextSibling', $selector)
		);
	}
	/**
	 * @access private
	 */
	protected function getElementSiblings($direction, $selector = null, $limitToOne = false) {
		$stack = array();
		$count = 0;
		foreach($this->stack() as $node) {
			$test = $node;
			while( isset($test->{$direction}) && $test->{$direction}) {
				$test = $test->{$direction};
				if (! $test instanceof DOMELEMENT)
					continue;
				$stack[] = $test;
				if ($limitToOne)
					break;
			}
		}
		if ($selector) {
			$stackOld = $this->elements;
			$this->elements = $stack;
			$stack = $this->filter($selector, true)->stack();
			$this->elements = $stackOld;
		}
		return $stack;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function siblings($selector = null) {
		$stack = array();
		$siblings = array_merge(
			$this->getElementSiblings('previousSibling', $selector),
			$this->getElementSiblings('nextSibling', $selector)
		);
		foreach($siblings as $node) {
			if (! $this->elementsContainsNode($node, $stack))
				$stack[] = $node;
		}
		return $this->newInstance($stack);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function not($selector = null) {
		if (is_string($selector))
			phpQuery::debug(array('not', $selector));
		else
			phpQuery::debug('not');
		$stack = array();
		if ($selector instanceof self || $selector instanceof DOMNODE) {
			foreach($this->stack() as $node) {
				if ($selector instanceof self) {
					$matchFound = false;
					foreach($selector->stack() as $notNode) {
						if ($notNode->isSameNode($node))
							$matchFound = true;
					}
					if (! $matchFound)
						$stack[] = $node;
				} else if ($selector instanceof DOMNODE) {
					if (! $selector->isSameNode($node))
						$stack[] = $node;
				} else {
					if (! $this->is($selector))
						$stack[] = $node;
				}
			}
		} else {
			$orgStack = $this->stack();
			$matched = $this->filter($selector, true)->stack();
//			$matched = array();
//			// simulate OR in filter() instead of AND 5y
//			foreach($this->parseSelector($selector) as $s) {
//				$matched = array_merge($matched,
//					$this->filter(array($s))->stack()
//				);
//			}
			foreach($orgStack as $node)
				if (! $this->elementsContainsNode($node, $matched))
					$stack[] = $node;
		}
		return $this->newInstance($stack);
	}
	/**
	 * Enter description here...
	 *
	 * @param string|phpQueryObject
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function add($selector = null) {
		if (! $selector)
			return $this;
		$stack = array();
		$this->elementsBackup = $this->elements;
		$found = phpQuery::pq($selector, $this->getDocumentID());
		$this->merge($found->elements);
		return $this->newInstance();
	}
	/**
	 * @access private
	 */
	protected function merge() {
		foreach(func_get_args() as $nodes)
			foreach($nodes as $newNode )
				if (! $this->elementsContainsNode($newNode) )
					$this->elements[] = $newNode;
	}
	/**
	 * @access private
	 * TODO refactor to stackContainsNode
	 */
	protected function elementsContainsNode($nodeToCheck, $elementsStack = null) {
		$loop = ! is_null($elementsStack)
			? $elementsStack
			: $this->elements;
		foreach($loop as $node) {
			if ( $node->isSameNode( $nodeToCheck ) )
				return true;
		}
		return false;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function parent($selector = null) {
		$stack = array();
		foreach($this->elements as $node )
			if ( $node->parentNode && ! $this->elementsContainsNode($node->parentNode, $stack) )
				$stack[] = $node->parentNode;
		$this->elementsBackup = $this->elements;
		$this->elements = $stack;
		if ( $selector )
			$this->filter($selector, true);
		return $this->newInstance();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function parents($selector = null) {
		$stack = array();
		if (! $this->elements )
			$this->debug('parents() - stack empty');
		foreach($this->elements as $node) {
			$test = $node;
			while( $test->parentNode) {
				$test = $test->parentNode;
				if ($this->isRoot($test))
					break;
				if (! $this->elementsContainsNode($test, $stack)) {
					$stack[] = $test;
					continue;
				}
			}
		}
		$this->elementsBackup = $this->elements;
		$this->elements = $stack;
		if ( $selector )
			$this->filter($selector, true);
		return $this->newInstance();
	}
	/**
	 * Internal stack iterator.
	 *
	 * @access private
	 */
	public function stack($nodeTypes = null) {
		if (!isset($nodeTypes))
			return $this->elements;
		if (!is_array($nodeTypes))
			$nodeTypes = array($nodeTypes);
		$return = array();
		foreach($this->elements as $node) {
			if (in_array($node->nodeType, $nodeTypes))
				$return[] = $node;
		}
		return $return;
	}
	// TODO phpdoc; $oldAttr is result of hasAttribute, before any changes
	protected function attrEvents($attr, $oldAttr, $oldValue, $node) {
		// skip events for XML documents
		if (! $this->isXHTML() && ! $this->isHTML())
			return;
		$event = null;
		// identify
		$isInputValue = $node->tagName == 'input'
			&& (
				in_array($node->getAttribute('type'),
					array('text', 'password', 'hidden'))
				|| !$node->getAttribute('type')
				 );
		$isRadio = $node->tagName == 'input'
			&& $node->getAttribute('type') == 'radio';
		$isCheckbox = $node->tagName == 'input'
			&& $node->getAttribute('type') == 'checkbox';
		$isOption = $node->tagName == 'option';
		if ($isInputValue && $attr == 'value' && $oldValue != $node->getAttribute($attr)) {
			$event = new DOMEvent(array(
				'target' => $node,
				'type' => 'change'
			));
		} else if (($isRadio || $isCheckbox) && $attr == 'checked' && (
				// check
				(! $oldAttr && $node->hasAttribute($attr))
				// un-check
				|| (! $node->hasAttribute($attr) && $oldAttr)
			)) {
			$event = new DOMEvent(array(
				'target' => $node,
				'type' => 'change'
			));
		} else if ($isOption && $node->parentNode && $attr == 'selected' && (
				// select
				(! $oldAttr && $node->hasAttribute($attr))
				// un-select
				|| (! $node->hasAttribute($attr) && $oldAttr)
			)) {
			$event = new DOMEvent(array(
				'target' => $node->parentNode,
				'type' => 'change'
			));
		}
		if ($event) {
			phpQueryEvents::trigger($this->getDocumentID(),
				$event->type, array($event), $node
			);
		}
	}
	public function attr($attr = null, $value = null) {
		foreach($this->stack(1) as $node) {
			if (! is_null($value)) {
				$loop = $attr == '*'
					? $this->getNodeAttrs($node)
					: array($attr);
				foreach($loop as $a) {
					$oldValue = $node->getAttribute($a);
					$oldAttr = $node->hasAttribute($a);
					// TODO raises an error when charset other than UTF-8
					// while document's charset is also not UTF-8
					@$node->setAttribute($a, $value);
					$this->attrEvents($a, $oldAttr, $oldValue, $node);
				}
			} else if ($attr == '*') {
				// jQuery difference
				$return = array();
				foreach($node->attributes as $n => $v)
					$return[$n] = $v->value;
				return $return;
			} else
				return $node->hasAttribute($attr)
					? $node->getAttribute($attr)
					: null;
		}
		return is_null($value)
			? '' : $this;
	}
	/**
	 * @access private
	 */
	protected function getNodeAttrs($node) {
		$return = array();
		foreach($node->attributes as $n => $o)
			$return[] = $n;
		return $return;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo check CDATA ???
	 */
	public function attrPHP($attr, $code) {
		if (! is_null($code)) {
			$value = '<'.'?php '.$code.' ?'.'>';
			// TODO tempolary solution
			// http://code.google.com/p/phpquery/issues/detail?id=17
//			if (function_exists('mb_detect_encoding') && mb_detect_encoding($value) == 'ASCII')
//				$value	= mb_convert_encoding($value, 'UTF-8', 'HTML-ENTITIES');
		}
		foreach($this->stack(1) as $node) {
			if (! is_null($code)) {
//				$attrNode = $this->DOM->createAttribute($attr);
				$node->setAttribute($attr, $value);
//				$attrNode->value = $value;
//				$node->appendChild($attrNode);
			} else if ( $attr == '*') {
				// jQuery diff
				$return = array();
				foreach($node->attributes as $n => $v)
					$return[$n] = $v->value;
				return $return;
			} else
				return $node->getAttribute($attr);
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function removeAttr($attr) {
		foreach($this->stack(1) as $node) {
			$loop = $attr == '*'
				? $this->getNodeAttrs($node)
				: array($attr);
			foreach($loop as $a) {
				$oldValue = $node->getAttribute($a);
				$node->removeAttribute($a);
				$this->attrEvents($a, $oldValue, null, $node);
			}
		}
		return $this;
	}
	/**
	 * Return form element value.
	 *
	 * @return String Fields value.
	 */
	public function val($val = null) {
		if (! isset($val)) {
			if ($this->eq(0)->is('select')) {
					$selected = $this->eq(0)->find('option[selected=selected]');
					if ($selected->is('[value]'))
						return $selected->attr('value');
					else
						return $selected->text();
			} else if ($this->eq(0)->is('textarea'))
					return $this->eq(0)->markup();
				else
					return $this->eq(0)->attr('value');
		} else {
			$_val = null;
			foreach($this->stack(1) as $node) {
				$node = pq($node, $this->getDocumentID());
				if (is_array($val) && in_array($node->attr('type'), array('checkbox', 'radio'))) {
					$isChecked = in_array($node->attr('value'), $val)
							|| in_array($node->attr('name'), $val);
					if ($isChecked)
						$node->attr('checked', 'checked');
					else
						$node->removeAttr('checked');
				} else if ($node->get(0)->tagName == 'select') {
					if (! isset($_val)) {
						$_val = array();
						if (! is_array($val))
							$_val = array((string)$val);
						else
							foreach($val as $v)
								$_val[] = $v;
					}
					foreach($node['option']->stack(1) as $option) {
						$option = pq($option, $this->getDocumentID());
						$selected = false;
						// XXX: workaround for string comparsion, see issue #96
						// http://code.google.com/p/phpquery/issues/detail?id=96
						$selected = is_null($option->attr('value'))
							? in_array($option->markup(), $_val)
							: in_array($option->attr('value'), $_val);
//						$optionValue = $option->attr('value');
//						$optionText = $option->text();
//						$optionTextLenght = mb_strlen($optionText);
//						foreach($_val as $v)
//							if ($optionValue == $v)
//								$selected = true;
//							else if ($optionText == $v && $optionTextLenght == mb_strlen($v))
//								$selected = true;
						if ($selected)
							$option->attr('selected', 'selected');
						else
							$option->removeAttr('selected');
					}
				} else if ($node->get(0)->tagName == 'textarea')
					$node->markup($val);
				else
					$node->attr('value', $val);
			}
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function andSelf() {
		if ( $this->previous )
			$this->elements = array_merge($this->elements, $this->previous->elements);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function addClass( $className) {
		if (! $className)
			return $this;
		foreach($this->stack(1) as $node) {
			if (! $this->is(".$className", $node))
				$node->setAttribute(
					'class',
					trim($node->getAttribute('class').' '.$className)
				);
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function addClassPHP( $className) {
		foreach($this->stack(1) as $node) {
				$classes = $node->getAttribute('class');
				$newValue = $classes
					? $classes.' <'.'?php '.$className.' ?'.'>'
					: '<'.'?php '.$className.' ?'.'>';
				$node->setAttribute('class', $newValue);
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param	string	$className
	 * @return	bool
	 */
	public function hasClass($className) {
		foreach($this->stack(1) as $node) {
			if ( $this->is(".$className", $node))
				return true;
		}
		return false;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function removeClass($className) {
		foreach($this->stack(1) as $node) {
			$classes = explode( ' ', $node->getAttribute('class'));
			if ( in_array($className, $classes)) {
				$classes = array_diff($classes, array($className));
				if ( $classes )
					$node->setAttribute('class', implode(' ', $classes));
				else
					$node->removeAttribute('class');
			}
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function toggleClass($className) {
		foreach($this->stack(1) as $node) {
			if ( $this->is( $node, '.'.$className ))
				$this->removeClass($className);
			else
				$this->addClass($className);
		}
		return $this;
	}
	/**
	 * Proper name without underscore (just ->empty()) also works.
	 *
	 * Removes all child nodes from the set of matched elements.
	 *
	 * Example:
	 * pq("p")._empty()
	 *
	 * HTML:
	 * <p>Hello, <span>Person</span> <a href="#">and person</a></p>
	 *
	 * Result:
	 * [ <p></p> ]
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @access private
	 */
	public function _empty() {
		foreach($this->stack(1) as $node) {
			// thx to 'dave at dgx dot cz'
			$node->nodeValue = '';
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param array|string $callback Expects $node as first param, $index as second
	 * @param array $scope External variables passed to callback. Use compact('varName1', 'varName2'...) and extract($scope)
	 * @param array $arg1 Will ba passed as third and futher args to callback.
	 * @param array $arg2 Will ba passed as fourth and futher args to callback, and so on...
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function each($callback, $param1 = null, $param2 = null, $param3 = null) {
		$paramStructure = null;
		if (func_num_args() > 1) {
			$paramStructure = func_get_args();
			$paramStructure = array_slice($paramStructure, 1);
		}
		foreach($this->elements as $v)
			phpQuery::callbackRun($callback, array($v), $paramStructure);
		return $this;
	}
	/**
	 * Run callback on actual object.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function callback($callback, $param1 = null, $param2 = null, $param3 = null) {
		$params = func_get_args();
		$params[0] = $this;
		phpQuery::callbackRun($callback, $params);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo add $scope and $args as in each() ???
	 */
	public function map($callback, $param1 = null, $param2 = null, $param3 = null) {
//		$stack = array();
////		foreach($this->newInstance() as $node) {
//		foreach($this->newInstance() as $node) {
//			$result = call_user_func($callback, $node);
//			if ($result)
//				$stack[] = $result;
//		}
		$params = func_get_args();
		array_unshift($params, $this->elements);
		return $this->newInstance(
			call_user_func_array(array('phpQuery', 'map'), $params)
//			phpQuery::map($this->elements, $callback)
		);
	}
	/**
	 * Enter description here...
	 * 
	 * @param <type> $key
	 * @param <type> $value
	 */
	public function data($key, $value = null) {
		if (! isset($value)) {
			// TODO? implement specific jQuery behavior od returning parent values
			// is child which we look up doesn't exist
			return phpQuery::data($this->get(0), $key, $value, $this->getDocumentID());
		} else {
			foreach($this as $node)
				phpQuery::data($node, $key, $value, $this->getDocumentID());
			return $this;
		}
	}
	/**
	 * Enter description here...
	 * 
	 * @param <type> $key
	 */
	public function removeData($key) {
		foreach($this as $node)
			phpQuery::removeData($node, $key, $this->getDocumentID());
		return $this;
	}
	// INTERFACE IMPLEMENTATIONS

	// ITERATOR INTERFACE
	/**
   * @access private
	 */
	public function rewind(){
		$this->debug('iterating foreach');
//		phpQuery::selectDocument($this->getDocumentID());
		$this->elementsBackup = $this->elements;
		$this->elementsInterator = $this->elements;
		$this->valid = isset( $this->elements[0] )
			? 1 : 0;
// 		$this->elements = $this->valid
// 			? array($this->elements[0])
// 			: array();
		$this->current = 0;
	}
	/**
   * @access private
	 */
	public function current(){
		return $this->elementsInterator[ $this->current ];
	}
	/**
   * @access private
	 */
	public function key(){
		return $this->current;
	}
	/**
	 * Double-function method.
	 *
	 * First: main iterator interface method.
	 * Second: Returning next sibling, alias for _next().
	 *
	 * Proper functionality is choosed automagicaly.
	 *
	 * @see phpQueryObject::_next()
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function next($cssSelector = null){
//		if ($cssSelector || $this->valid)
//			return $this->_next($cssSelector);
		$this->valid = isset( $this->elementsInterator[ $this->current+1 ] )
			? true
			: false;
		if (! $this->valid && $this->elementsInterator) {
			$this->elementsInterator = null;
		} else if ($this->valid) {
			$this->current++;
		} else {
			return $this->_next($cssSelector);
		}
	}
	/**
   * @access private
	 */
	public function valid(){
		return $this->valid;
	}
	// ITERATOR INTERFACE END
	// ARRAYACCESS INTERFACE
	/**
   * @access private
	 */
	public function offsetExists($offset) {
		return $this->find($offset)->size() > 0;
	}
	/**
   * @access private
	 */
	public function offsetGet($offset) {
		return $this->find($offset);
	}
	/**
   * @access private
	 */
	public function offsetSet($offset, $value) {
//		$this->find($offset)->replaceWith($value);
		$this->find($offset)->html($value);
	}
	/**
   * @access private
	 */
	public function offsetUnset($offset) {
		// empty
		throw new Exception("Can't do unset, use array interface only for calling queries and replacing HTML.");
	}
	// ARRAYACCESS INTERFACE END
	/**
	 * Returns node's XPath.
	 *
	 * @param unknown_type $oneNode
	 * @return string
	 * @TODO use native getNodePath is avaible
	 * @access private
	 */
	protected function getNodeXpath($oneNode = null, $namespace = null) {
		$return = array();
		$loop = $oneNode
			? array($oneNode)
			: $this->elements;
//		if ($namespace)
//			$namespace .= ':';
		foreach($loop as $node) {
			if ($node instanceof DOMDOCUMENT) {
				$return[] = '';
				continue;
			}
			$xpath = array();
			while(! ($node instanceof DOMDOCUMENT)) {
				$i = 1;
				$sibling = $node;
				while($sibling->previousSibling) {
					$sibling = $sibling->previousSibling;
					$isElement = $sibling instanceof DOMELEMENT;
					if ($isElement && $sibling->tagName == $node->tagName)
						$i++;
				}
				$xpath[] = $this->isXML()
					? "*[local-name()='{$node->tagName}'][{$i}]"
					: "{$node->tagName}[{$i}]";
				$node = $node->parentNode;
			}
			$xpath = join('/', array_reverse($xpath));
			$return[] = '/'.$xpath;
		}
		return $oneNode
			? $return[0]
			: $return;
	}
	// HELPERS
	public function whois($oneNode = null) {
		$return = array();
		$loop = $oneNode
			? array( $oneNode )
			: $this->elements;
		foreach($loop as $node) {
			if (isset($node->tagName)) {
				$tag = in_array($node->tagName, array('php', 'js'))
					? strtoupper($node->tagName)
					: $node->tagName;
				$return[] = $tag
					.($node->getAttribute('id')
						? '#'.$node->getAttribute('id'):'')
					.($node->getAttribute('class')
						? '.'.join('.', split(' ', $node->getAttribute('class'))):'')
					.($node->getAttribute('name')
						? '[name="'.$node->getAttribute('name').'"]':'')
					.($node->getAttribute('value') && strpos($node->getAttribute('value'), '<'.'?php') === false
						? '[value="'.substr(str_replace("\n", '', $node->getAttribute('value')), 0, 15).'"]':'')
					.($node->getAttribute('value') && strpos($node->getAttribute('value'), '<'.'?php') !== false
						? '[value=PHP]':'')
					.($node->getAttribute('selected')
						? '[selected]':'')
					.($node->getAttribute('checked')
						? '[checked]':'')
				;
			} else if ($node instanceof DOMTEXT) {
				if (trim($node->textContent))
					$return[] = 'Text:'.substr(str_replace("\n", ' ', $node->textContent), 0, 15);
			} else {

			}
		}
		return $oneNode && isset($return[0])
			? $return[0]
			: $return;
	}
	/**
	 * Dump htmlOuter and preserve chain. Usefull for debugging.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 *
	 */
	public function dump() {
		print 'DUMP #'.(phpQuery::$dumpCount++).' ';
		$debug = phpQuery::$debug;
		phpQuery::$debug = false;
//		print __FILE__.':'.__LINE__."\n";
		var_dump($this->htmlOuter());
		return $this;
	}
	public function dumpWhois() {
		print 'DUMP #'.(phpQuery::$dumpCount++).' ';
		$debug = phpQuery::$debug;
		phpQuery::$debug = false;
//		print __FILE__.':'.__LINE__."\n";
		var_dump('whois', $this->whois());
		phpQuery::$debug = $debug;
		return $this;
	}
	public function dumpLength() {
		print 'DUMP #'.(phpQuery::$dumpCount++).' ';
		$debug = phpQuery::$debug;
		phpQuery::$debug = false;
//		print __FILE__.':'.__LINE__."\n";
		var_dump('length', $this->length());
		phpQuery::$debug = $debug;
		return $this;
	}
	public function dumpTree($html = true, $title = true) {
		$output = $title
			? 'DUMP #'.(phpQuery::$dumpCount++)." \n" : '';
		$debug = phpQuery::$debug;
		phpQuery::$debug = false;
		foreach($this->stack() as $node)
			$output .= $this->__dumpTree($node);
		phpQuery::$debug = $debug;
		print $html
			? nl2br(str_replace(' ', '&nbsp;', $output))
			: $output;
		return $this;
	}
	private function __dumpTree($node, $intend = 0) {
		$whois = $this->whois($node);
		$return = '';
		if ($whois)
			$return .= str_repeat(' - ', $intend).$whois."\n";
		if (isset($node->childNodes))
			foreach($node->childNodes as $chNode)
				$return .= $this->__dumpTree($chNode, $intend+1);
		return $return;
	}
	/**
	 * Dump htmlOuter and stop script execution. Usefull for debugging.
	 *
	 */
	public function dumpDie() {
		print __FILE__.':'.__LINE__;
		var_dump($this->htmlOuter());
		die();
	}
}
72   369|/shs.parser/classes/phpQuery/phpQuery/bootstrap.example.php|6ee88cb5<?php
/**
 * Example of phpQuery bootstrap file.
 *
 * This file is executed everytime phpQuery is included. Use it to set all
 * your personal needs in the library.
 *
 * To activate this file, delete '.example' from filename.
 */
// probably you want to use one of those functions here
//phpQuery::ajaxAllowHost();
//phpQuery::ajaxAllowURL();
//phpQuery::plugin();
?>70   4963|/shs.parser/classes/phpQuery/phpQuery/phpQueryEvents.php|e0cbe841<?php
/**
 * Event handling class.
 *
 * @author Tobiasz Cudnik
 * @package phpQuery
 * @static
 */
abstract class phpQueryEvents {
	/**
	 * Trigger a type of event on every matched element.
	 *
	 * @param DOMNode|phpQueryObject|string $document
	 * @param unknown_type $type
	 * @param unknown_type $data
	 *
	 * @TODO exclusive events (with !)
	 * @TODO global events (test)
	 * @TODO support more than event in $type (space-separated)
	 */
	public static function trigger($document, $type, $data = array(), $node = null) {
		// trigger: function(type, data, elem, donative, extra) {
		$documentID = phpQuery::getDocumentID($document);
		$namespace = null;
		if (strpos($type, '.') !== false)
			list($name, $namespace) = explode('.', $type);
		else
			$name = $type;
		if (! $node) {
			if (self::issetGlobal($documentID, $type)) {
				$pq = phpQuery::getDocument($documentID);
				// TODO check add($pq->document)
				$pq->find('*')->add($pq->document)
					->trigger($type, $data);
			}
		} else {
			if (isset($data[0]) && $data[0] instanceof DOMEvent) {
				$event = $data[0];
				$event->relatedTarget = $event->target;
				$event->target = $node;
				$data = array_slice($data, 1);
			} else {
				$event = new DOMEvent(array(
					'type' => $type,
					'target' => $node,
					'timeStamp' => time(),
				));
			}
			$i = 0;
			while($node) {
				// TODO whois
				phpQuery::debug("Triggering ".($i?"bubbled ":'')."event '{$type}' on "
					."node \n");//.phpQueryObject::whois($node)."\n");
				$event->currentTarget = $node;
				$eventNode = self::getNode($documentID, $node);
				if (isset($eventNode->eventHandlers)) {
					foreach($eventNode->eventHandlers as $eventType => $handlers) {
						$eventNamespace = null;
						if (strpos($type, '.') !== false)
							list($eventName, $eventNamespace) = explode('.', $eventType);
						else
							$eventName = $eventType;
						if ($name != $eventName)
							continue;
						if ($namespace && $eventNamespace && $namespace != $eventNamespace)
							continue;
						foreach($handlers as $handler) {
							phpQuery::debug("Calling event handler\n");
							$event->data = $handler['data']
								? $handler['data']
								: null;
							$params = array_merge(array($event), $data);
							$return = phpQuery::callbackRun($handler['callback'], $params);
							if ($return === false) {
								$event->bubbles = false;
							}
						}
					}
				}
				// to bubble or not to bubble...
				if (! $event->bubbles)
					break;
				$node = $node->parentNode;
				$i++;
			}
		}
	}
	/**
	 * Binds a handler to one or more events (like click) for each matched element.
	 * Can also bind custom events.
	 *
	 * @param DOMNode|phpQueryObject|string $document
	 * @param unknown_type $type
	 * @param unknown_type $data Optional
	 * @param unknown_type $callback
	 *
	 * @TODO support '!' (exclusive) events
	 * @TODO support more than event in $type (space-separated)
	 * @TODO support binding to global events
	 */
	public static function add($document, $node, $type, $data, $callback = null) {
		phpQuery::debug("Binding '$type' event");
		$documentID = phpQuery::getDocumentID($document);
//		if (is_null($callback) && is_callable($data)) {
//			$callback = $data;
//			$data = null;
//		}
		$eventNode = self::getNode($documentID, $node);
		if (! $eventNode)
			$eventNode = self::setNode($documentID, $node);
		if (!isset($eventNode->eventHandlers[$type]))
			$eventNode->eventHandlers[$type] = array();
		$eventNode->eventHandlers[$type][] = array(
			'callback' => $callback,
			'data' => $data,
		);
	}
	/**
	 * Enter description here...
	 *
	 * @param DOMNode|phpQueryObject|string $document
	 * @param unknown_type $type
	 * @param unknown_type $callback
	 *
	 * @TODO namespace events
	 * @TODO support more than event in $type (space-separated)
	 */
	public static function remove($document, $node, $type = null, $callback = null) {
		$documentID = phpQuery::getDocumentID($document);
		$eventNode = self::getNode($documentID, $node);
		if (is_object($eventNode) && isset($eventNode->eventHandlers[$type])) {
			if ($callback) {
				foreach($eventNode->eventHandlers[$type] as $k => $handler)
					if ($handler['callback'] == $callback)
						unset($eventNode->eventHandlers[$type][$k]);
			} else {
				unset($eventNode->eventHandlers[$type]);
			}
		}
	}
	protected static function getNode($documentID, $node) {
		foreach(phpQuery::$documents[$documentID]->eventsNodes as $eventNode) {
			if ($node->isSameNode($eventNode))
				return $eventNode;
		}
	}
	protected static function setNode($documentID, $node) {
		phpQuery::$documents[$documentID]->eventsNodes[] = $node;
		return phpQuery::$documents[$documentID]->eventsNodes[
			count(phpQuery::$documents[$documentID]->eventsNodes)-1
		];
	}
	protected static function issetGlobal($documentID, $type) {
		return isset(phpQuery::$documents[$documentID])
			? in_array($type, phpQuery::$documents[$documentID]->eventsGlobal)
			: false;
	}
}
75   12587|/shs.parser/classes/phpQuery/phpQuery/plugins/WebBrowser.php|eaafc045<?php
/**
 * WebBrowser plugin.
 *
 */
class phpQueryObjectPlugin_WebBrowser {
	/**
	 * Limit binded methods to specified ones.
	 *
	 * @var array
	 */
	public static $phpQueryMethods = null;
	/**
	 * Enter description here...
	 *
	 * @param phpQueryObject $self
	 * @todo support 'reset' event
	 */
	public static function WebBrowser($self, $callback = null, $location = null) {
		$self = $self->_clone()->toRoot();
		$location = $location
			? $location
			// TODO use document.location
			: $self->document->xhr->getUri(true);
		// FIXME tmp
		$self->document->WebBrowserCallback = $callback;
		if (! $location)
			throw new Exception('Location needed to activate WebBrowser plugin !');
		else {
			$self->bind('click', array($location, $callback), array('phpQueryPlugin_WebBrowser', 'hadleClick'));
			$self->bind('submit', array($location, $callback), array('phpQueryPlugin_WebBrowser', 'handleSubmit'));
		}
	}
	public static function browser($self, $callback = null, $location = null) {
		return $self->WebBrowser($callback, $location);
	}
	public static function downloadTo($self, $dir = null, $filename = null) {
		$url = null;
		if ($self->is('a[href]'))
			$url = $self->attr('href');
		else if ($self->find('a')->length)
			$url = $self->find('a')->attr('href');
		if ($url) {
			$url = resolve_url($self->document->location, $url);
			if (! $dir)
				$dir = getcwd();
			// TODO resolv name from response headers
			if (! $filename) {
				$matches = null;
				preg_match('@/([^/]+)$@', $url, $matches);
				$filename = $matches[1];
			}
			//print $url;
			$path = rtrim($dir, '/').'/'.$filename;
			phpQuery::debug("Requesting download of $url\n");
			// TODO use AJAX instead of file_get_contents
			file_put_contents($path, file_get_contents($url));
		}
		return $self;
	}
	/**
	 * Method changing browser location.
	 * Fires callback registered with WebBrowser(), if any.
	 * @param $self
	 * @param $url
	 * @return unknown_type
	 */
	public static function location($self, $url = null) {
		// TODO if ! $url return actual location ???
		$xhr = isset($self->document->xhr)
			? $self->document->xhr
			: null;
		$xhr = phpQuery::ajax(array(
			'url' => $url,
		), $xhr);
		$return = false;
		if ($xhr->getLastResponse()->isSuccessful()) {
			$return = phpQueryPlugin_WebBrowser::browserReceive($xhr);
			if (isset($self->document->WebBrowserCallback))
				phpQuery::callbackRun(
					$self->document->WebBrowserCallback,
					array($return)
				);
		}
		return $return;
	}
}
class phpQueryPlugin_WebBrowser {
	/**
	 *
	 * @param $url
	 * @param $callback
	 * @param $param1
	 * @param $param2
	 * @param $param3
	 * @return Zend_Http_Client
	 */
	public static function browserGet($url, $callback,
		$param1 = null, $param2 = null, $param3 = null) {
		phpQuery::debug("[WebBrowser] GET: $url");
		self::authorizeHost($url);
		$xhr = phpQuery::ajax(array(
			'type' => 'GET',
			'url' => $url,
			'dataType' => 'html',
		));
		$paramStructure = null;
		if (func_num_args() > 2) {
			$paramStructure = func_get_args();
			$paramStructure = array_slice($paramStructure, 2);
		}
		if ($xhr->getLastResponse()->isSuccessful()) {
			phpQuery::callbackRun($callback,
				array(self::browserReceive($xhr)->WebBrowser()),
				$paramStructure
			);
//			phpQuery::callbackRun($callback, array(
//				self::browserReceive($xhr)//->WebBrowser($callback)
//			));
			return $xhr;
		} else {
			throw new Exception("[WebBrowser] GET request failed; url: $url");
			return false;
		}
	}
	/**
	 *
	 * @param $url
	 * @param $data
	 * @param $callback
	 * @param $param1
	 * @param $param2
	 * @param $param3
	 * @return Zend_Http_Client
	 */
	public static function browserPost($url, $data, $callback,
		$param1 = null, $param2 = null, $param3 = null) {
		self::authorizeHost($url);
		$xhr = phpQuery::ajax(array(
			'type' => 'POST',
			'url' => $url,
			'dataType' => 'html',
			'data' => $data,
		));
		$paramStructure = null;
		if (func_num_args() > 3) {
			$paramStructure = func_get_args();
			$paramStructure = array_slice($paramStructure, 3);
		}
		if ($xhr->getLastResponse()->isSuccessful()) {
			phpQuery::callbackRun($callback,
				array(self::browserReceive($xhr)->WebBrowser()),
				$paramStructure
			);
//			phpQuery::callbackRun($callback, array(
//				self::browserReceive($xhr)//->WebBrowser($callback)
//			));
			return $xhr;
		} else
			return false;
	}
	/**
	 *
	 * @param $ajaxSettings
	 * @param $callback
	 * @param $param1
	 * @param $param2
	 * @param $param3
	 * @return Zend_Http_Client
	 */
	public static function browser($ajaxSettings, $callback,
		$param1 = null, $param2 = null, $param3 = null) {
		self::authorizeHost($ajaxSettings['url']);
		$xhr = phpQuery::ajax(
			self::ajaxSettingsPrepare($ajaxSettings)
		);
		$paramStructure = null;
		if (func_num_args() > 2) {
			$paramStructure = func_get_args();
			$paramStructure = array_slice($paramStructure, 2);
		}
		if ($xhr->getLastResponse()->isSuccessful()) {
			phpQuery::callbackRun($callback,
				array(self::browserReceive($xhr)->WebBrowser()),
				$paramStructure
			);
//			phpQuery::callbackRun($callback, array(
//				self::browserReceive($xhr)//->WebBrowser($callback)
//			));
			return $xhr;
		} else
			return false;
	}
	protected static function authorizeHost($url) {
		$host = parse_url($url, PHP_URL_HOST);
		if ($host)
			phpQuery::ajaxAllowHost($host);
	}
	protected static function ajaxSettingsPrepare($settings) {
		unset($settings['success']);
		unset($settings['error']);
		return $settings;
	}
	/**
	 * @param Zend_Http_Client $xhr
	 */
	public static function browserReceive($xhr) {
		phpQuery::debug("[WebBrowser] Received from ".$xhr->getUri(true));
		// TODO handle meta redirects
		$body = $xhr->getLastResponse()->getBody();

		// XXX error ???
		if (strpos($body, '<!doctype html>') !== false) {
			$body = '<html>'
				.str_replace('<!doctype html>', '', $body)
				.'</html>';
		}
		$pq = phpQuery::newDocument($body);
		$pq->document->xhr = $xhr;
		$pq->document->location = $xhr->getUri(true);
		$refresh = $pq->find('meta[http-equiv=refresh]')
			->add('meta[http-equiv=Refresh]');
		if ($refresh->size()) {
//			print htmlspecialchars(var_export($xhr->getCookieJar()->getAllCookies(), true));
//			print htmlspecialchars(var_export($xhr->getLastResponse()->getHeader('Set-Cookie'), true));
			phpQuery::debug("Meta redirect... '{$refresh->attr('content')}'\n");
			// there is a refresh, so get the new url
			$content = $refresh->attr('content');
			$urlRefresh = substr($content, strpos($content, '=')+1);
			$urlRefresh = trim($urlRefresh, '\'"');
			// XXX not secure ?!
			phpQuery::ajaxAllowURL($urlRefresh);
//			$urlRefresh = urldecode($urlRefresh);
			// make ajax call, passing last $xhr object to preserve important stuff
			$xhr = phpQuery::ajax(array(
				'type' => 'GET',
				'url' => $urlRefresh,
				'dataType' => 'html',
			), $xhr);
			if ($xhr->getLastResponse()->isSuccessful()) {
				// if all is ok, repeat this method...
				return call_user_func_array(
					array('phpQueryPlugin_WebBrowser', 'browserReceive'), array($xhr)
				);
			}
		} else
			return $pq;
	}
	/**
	 * 
	 * @param $e
	 * @param $callback
	 * @return unknown_type
	 */
	public static function hadleClick($e, $callback = null) {
		$node = phpQuery::pq($e->target);
		$type = null;
		if ($node->is('a[href]')) {
			// TODO document.location
			$xhr = isset($node->document->xhr)
				? $node->document->xhr
				: null;
			$xhr = phpQuery::ajax(array(
				'url' => resolve_url($e->data[0], $node->attr('href')),
				'referer' => $node->document->location,
			), $xhr);
			if ((! $callback || !($callback instanceof Callback)) && $e->data[1])
				$callback = $e->data[1];
			if ($xhr->getLastResponse()->isSuccessful() && $callback)
				phpQuery::callbackRun($callback, array(
					self::browserReceive($xhr)
				));
		} else if ($node->is(':submit') && $node->parents('form')->size())
			$node->parents('form')->trigger('submit', array($e));
	}
	/**
	 * Enter description here...
	 *
	 * @param unknown_type $e
	 * @TODO trigger submit for form after form's  submit button has a click event
	 */
	public static function handleSubmit($e, $callback = null) {
		$node = phpQuery::pq($e->target);
		if (!$node->is('form') || !$node->is('[action]'))
			return;
		// TODO document.location
		$xhr = isset($node->document->xhr)
			? $node->document->xhr
			: null;
		$submit = pq($e->relatedTarget)->is(':submit')
			? $e->relatedTarget
				// will this work ?
//			: $node->find(':submit:first')->get(0);
			: $node->find('*:submit:first')->get(0);
		$data = array();
		foreach($node->serializeArray($submit) as $r)
		// XXXt.c maybe $node->not(':submit')->add($sumit) would be better ?
//		foreach($node->serializeArray($submit) as $r)
			$data[ $r['name'] ] = $r['value'];
		$options = array(
			'type' => $node->attr('method')
				? $node->attr('method')
				: 'GET',
			'url' => resolve_url($e->data[0], $node->attr('action')),
			'data' => $data,
			'referer' => $node->document->location,
//			'success' => $e->data[1],
		);
		if ($node->attr('enctype'))
			$options['contentType'] = $node->attr('enctype');
		$xhr = phpQuery::ajax($options, $xhr);
		if ((! $callback || !($callback instanceof Callback)) && $e->data[1])
			$callback = $e->data[1];
		if ($xhr->getLastResponse()->isSuccessful() && $callback)
			phpQuery::callbackRun($callback, array(
				self::browserReceive($xhr)
			));
	}
}
/**
 *
 * @param unknown_type $parsed
 * @return unknown
 * @link http://www.php.net/manual/en/function.parse-url.php
 * @author stevenlewis at hotmail dot com
 */
function glue_url($parsed)
    {
    if (! is_array($parsed)) return false;
    $uri = isset($parsed['scheme']) ? $parsed['scheme'].':'.((strtolower($parsed['scheme']) == 'mailto') ? '':'//'): '';
    $uri .= isset($parsed['user']) ? $parsed['user'].($parsed['pass']? ':'.$parsed['pass']:'').'@':'';
    $uri .= isset($parsed['host']) ? $parsed['host'] : '';
    $uri .= isset($parsed['port']) ? ':'.$parsed['port'] : '';
    if(isset($parsed['path']))
        {
        $uri .= (substr($parsed['path'],0,1) == '/')?$parsed['path']:'/'.$parsed['path'];
        }
    $uri .= isset($parsed['query']) ? '?'.$parsed['query'] : '';
    $uri .= isset($parsed['fragment']) ? '#'.$parsed['fragment'] : '';
    return $uri;
    }
/**
 * Enter description here...
 *
 * @param unknown_type $base
 * @param unknown_type $url
 * @return unknown
 * @author adrian-php at sixfingeredman dot net
 */
function resolve_url($base, $url) {
        if (!strlen($base)) return $url;
        // Step 2
        if (!strlen($url)) return $base;
        // Step 3
        if (preg_match('!^[a-z]+:!i', $url)) return $url;
        $base = parse_url($base);
        if ($url{0} == "#") {
                // Step 2 (fragment)
                $base['fragment'] = substr($url, 1);
                return unparse_url($base);
        }
        unset($base['fragment']);
        unset($base['query']);
        if (substr($url, 0, 2) == "//") {
                // Step 4
                return unparse_url(array(
                        'scheme'=>$base['scheme'],
                        'path'=>substr($url,2),
                ));
        } else if ($url{0} == "/") {
                // Step 5
                $base['path'] = $url;
        } else {
                // Step 6
                $path = explode('/', $base['path']);
                $url_path = explode('/', $url);
                // Step 6a: drop file from base
                array_pop($path);
                // Step 6b, 6c, 6e: append url while removing "." and ".." from
                // the directory portion
                $end = array_pop($url_path);
                foreach ($url_path as $segment) {
                        if ($segment == '.') {
                                // skip
                        } else if ($segment == '..' && $path && $path[sizeof($path)-1] != '..') {
                                array_pop($path);
                        } else {
                                $path[] = $segment;
                        }
                }
                // Step 6d, 6f: remove "." and ".." from file portion
                if ($end == '.') {
                        $path[] = '';
                } else if ($end == '..' && $path && $path[sizeof($path)-1] != '..') {
                        $path[sizeof($path)-1] = '';
                } else {
                        $path[] = $end;
                }
                // Step 6h
                $base['path'] = join('/', $path);

        }
        // Step 7
        return glue_url($base);
}
71   1946|/shs.parser/classes/phpQuery/phpQuery/plugins/Scripts.php|eedf3199<?php
/**
 * phpQuery plugin class extending phpQuery object.
 * Methods from this class are callable on every phpQuery object.
 *
 * Class name prefix 'phpQueryObjectPlugin_' must be preserved.
 */
abstract class phpQueryObjectPlugin_Scripts {
	/**
	 * Limit binded methods.
	 *
	 * null means all public.
	 * array means only specified ones.
	 *
	 * @var array|null
	 */
	public static $phpQueryMethods = null;
	public static $config = array();
	/**
	 * Enter description here...
	 *
	 * @param phpQueryObject $self
	 */
	public static function script($self, $arg1) {
		$params = func_get_args();
		$params = array_slice($params, 2);
		$return = null;
		$config = self::$config;
		if (phpQueryPlugin_Scripts::$scriptMethods[$arg1]) {
			phpQuery::callbackRun(
				phpQueryPlugin_Scripts::$scriptMethods[$arg1],
				array($self, $params, &$return, $config)
			);
		} else if ($arg1 != '__config' && file_exists(dirname(__FILE__)."/Scripts/$arg1.php")) {
			phpQuery::debug("Loading script '$arg1'");
			require dirname(__FILE__)."/Scripts/$arg1.php";
		} else {
			phpQuery::debug("Requested script '$arg1' doesn't exist");
		}
		return $return
			? $return
			: $self;
	}
}
abstract class phpQueryPlugin_Scripts {
	public static $scriptMethods = array();
	public static function __initialize() {
		if (file_exists(dirname(__FILE__)."/Scripts/__config.php")) {
			include dirname(__FILE__)."/Scripts/__config.php";
			phpQueryObjectPlugin_Scripts::$config = $config;
		}
	}
	/**
	 * Extend scripts' namespace with $name related with $callback.
	 * 
	 * Callback parameter order looks like this:
	 * - $this
	 * - $params
	 * - &$return
	 * - $config
	 * 
	 * @param $name
	 * @param $callback
	 * @return bool
	 */
	public static function script($name, $callback) {
		if (phpQueryPlugin_Scripts::$scriptMethods[$name])
			throw new Exception("Script name conflict - '$name'");
		phpQueryPlugin_Scripts::$scriptMethods[$name] = $callback;
	}
}
?>71   1866|/shs.parser/classes/phpQuery/phpQuery/plugins/example.php|e093e135<?php
/**
 * Example of phpQuery plugin.
 *
 * Load it like this:
 * phpQuery::plugin('example')
 * phpQuery::plugin('example', 'example.php')
 * pq('ul')->plugin('example')
 * pq('ul')->plugin('example', 'example.php')
 *
 * Plugin classes are never intialized, just method calls are forwarded
 * in static way from phpQuery.
 *
 * Have fun writing plugins :)
 */

/**
 * phpQuery plugin class extending phpQuery object.
 * Methods from this class are callable on every phpQuery object.
 *
 * Class name prefix 'phpQueryObjectPlugin_' must be preserved.
 */
abstract class phpQueryObjectPlugin_example {
	/**
	 * Limit binded methods.
	 *
	 * null means all public.
	 * array means only specified ones.
	 *
	 * @var array|null
	 */
	public static $phpQueryMethods = null;
	/**
	 * Enter description here...
	 *
	 * @param phpQueryObject $self
	 */
	public static function example($self, $arg1) {
		// this method can be called on any phpQuery object, like this:
		// pq('div')->example('$arg1 Value')

		// do something
		$self->append('Im just an example !');
		// change stack of result object
		return $self->find('div');
	}
	protected static function helperFunction() {
		// this method WONT be avaible as phpQuery method,
		// because it isn't publicly callable
	}
}

/**
 * phpQuery plugin class extending phpQuery static namespace.
 * Methods from this class are callable as follows:
 * phpQuery::$plugins->staticMethod()
 *
 * Class name prefix 'phpQueryPlugin_' must be preserved.
 */
abstract class phpQueryPlugin_example {
	/**
	 * Limit binded methods.
	 *
	 * null means all public.
	 * array means only specified ones.
	 *
	 * @var array|null
	 */
	public static $phpQueryMethods = null;
	public static function staticMethod() {
		// this method can be called within phpQuery class namespace, like this:
		// phpQuery::$plugins->staticMethod()
	}
}
?>84   1257|/shs.parser/classes/phpQuery/phpQuery/plugins/Scripts/google_login.php|71bb2fe0<?php
/**
 * Automated google account login.
 * Uses __config.php to keep login data.
 *
 * @package phpQuery.Plugins.Scripts
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
phpQuery::ajaxAllowHost(
	'code.google.com',
	'google.com', 'www.google.com',
	'mail.google.com',
	'docs.google.com',
	'reader.google.com'
);
if (! function_exists('ndfasui8923')) {
	function ndfasui8923($browser, $scope) {
		extract($scope);
		$browser
			->WebBrowser()
			->find('#Email')
				->val($config['google_login'][0])->end()
			->find('#Passwd')
				->val($config['google_login'][1])
				->parents('form')
					->submit();
	}
	$ndfasui8923 = new Callback('ndfasui8923', new CallbackParam, compact(
		'config', 'self', 'return', 'params'
	));
}
phpQuery::plugin('WebBrowser');
$self->document->xhr = phpQuery::$plugins->browserGet(
	'https://www.google.com/accounts/Login',
	$ndfasui8923
);
//$self->document->xhr = phpQuery::$plugins->browserGet('https://www.google.com/accounts/Login', create_function('$browser', "
//	\$browser
//		->WebBrowser()
//		->find('#Email')
//			->val('{$config['google_login'][0]}')->end()
//		->find('#Passwd')
//			->val('".str_replace("'", "\\'", $config['google_login'][1])."')
//			->parents('form')
//				->submit();"
//));
?>83   224|/shs.parser/classes/phpQuery/phpQuery/plugins/Scripts/print_source.php|f3c0ef55<?php
/**
 * Script outputs document markup and changes HTML special chars to entities.
 *
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
/** @var phpQueryObject */
$self = $self;
$return = htmlspecialchars($self);82   475|/shs.parser/classes/phpQuery/phpQuery/plugins/Scripts/fix_webroot.php|a16032e4<?php
$selector = 'img[src], link[href], script[src]';
$filter = ':not([href^=<?php])'
		.':not([src^=<?php])'
		.':not([href^=http://])'
		.':not([src^=http://])'
		.':not([src^=/])';
foreach($self[$selector]->filter($filter) as $el) {
	$el = pq($el, $self->getDocumentID());
	// imgs and scripts
	if ( $el->is('img') || $el->is('script') )
		$el->attr('src', $params[0].$el->attr('src'));
	// css
	if ( $el->is('link') )
		$el->attr('href', $params[0].$el->attr('href'));
}87   194|/shs.parser/classes/phpQuery/phpQuery/plugins/Scripts/__config.example.php|b35b9f6a<?php
/**
 * This file hosts config for Scripts plugin.
 *
 * To active this file, selete '.example' from filename.
 */
$config = array(
	'google_login' => array('login@mail', 'password'),
);
?>84   306|/shs.parser/classes/phpQuery/phpQuery/plugins/Scripts/print_websafe.php|6a8a9707<?php
/**
 * Script makes content safe for printing as web page and not redirecting client.
 *
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
/** @var phpQueryObject */
$self = $self;
$self
	->find('script')
		->add('meta[http-equiv=refresh]')
			->add('meta[http-equiv=Refresh]')
				->remove();78   390|/shs.parser/classes/phpQuery/phpQuery/plugins/Scripts/example.php|82909782<?php
/**
 * Example script for phpQuery Script plugin
 *
 * Avaible are 4 variables:
 * - $self Represents $this
 * - $params Represents parameters passed to script() method (without script name)
 * - $return If not null, will be used as method result
 * - $config Content of __config.php file
 *
 * By default each script returns $self aka $this.
 */
$return = $self->find($params[0]);
?>67   8538|/shs.parser/classes/phpQuery/phpQuery/Zend/Loader.php|20249974<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Loader
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Loader.php 10454 2008-07-26 06:25:51Z ralph $
 */

/**
 * Static methods for loading classes and files.
 *
 * @category   Zend
 * @package    Zend_Loader
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Loader
{
    /**
     * Loads a class from a PHP file.  The filename must be formatted
     * as "$class.php".
     *
     * If $dirs is a string or an array, it will search the directories
     * in the order supplied, and attempt to load the first matching file.
     *
     * If $dirs is null, it will split the class name at underscores to
     * generate a path hierarchy (e.g., "Zend_Example_Class" will map
     * to "Zend/Example/Class.php").
     *
     * If the file was not found in the $dirs, or if no $dirs were specified,
     * it will attempt to load it from PHP's include_path.
     *
     * @param string $class      - The full class name of a Zend component.
     * @param string|array $dirs - OPTIONAL Either a path or an array of paths
     *                             to search.
     * @return void
     * @throws Zend_Exception
     */
    public static function loadClass($class, $dirs = null)
    {
        if (class_exists($class, false) || interface_exists($class, false)) {
            return;
        }

        if ((null !== $dirs) && !is_string($dirs) && !is_array($dirs)) {
            require_once 'Zend/Exception.php';
            throw new Zend_Exception('Directory argument must be a string or an array');
        }

        // autodiscover the path from the class name
        $file = str_replace('_', DIRECTORY_SEPARATOR, $class) . '.php';
        if (!empty($dirs)) {
            // use the autodiscovered path
            $dirPath = dirname($file);
            if (is_string($dirs)) {
                $dirs = explode(PATH_SEPARATOR, $dirs);
            }
            foreach ($dirs as $key => $dir) {
                if ($dir == '.') {
                    $dirs[$key] = $dirPath;
                } else {
                    $dir = rtrim($dir, '\\/');
                    $dirs[$key] = $dir . DIRECTORY_SEPARATOR . $dirPath;
                }
            }
            $file = basename($file);
            self::loadFile($file, $dirs, true);
        } else {
            self::_securityCheck($file);
            include_once $file;
        }

        if (!class_exists($class, false) && !interface_exists($class, false)) {
            require_once 'Zend/Exception.php';
            throw new Zend_Exception("File \"$file\" does not exist or class \"$class\" was not found in the file");
        }
    }

    /**
     * Loads a PHP file.  This is a wrapper for PHP's include() function.
     *
     * $filename must be the complete filename, including any
     * extension such as ".php".  Note that a security check is performed that
     * does not permit extended characters in the filename.  This method is
     * intended for loading Zend Framework files.
     *
     * If $dirs is a string or an array, it will search the directories
     * in the order supplied, and attempt to load the first matching file.
     *
     * If the file was not found in the $dirs, or if no $dirs were specified,
     * it will attempt to load it from PHP's include_path.
     *
     * If $once is TRUE, it will use include_once() instead of include().
     *
     * @param  string        $filename
     * @param  string|array  $dirs - OPTIONAL either a path or array of paths
     *                       to search.
     * @param  boolean       $once
     * @return boolean
     * @throws Zend_Exception
     */
    public static function loadFile($filename, $dirs = null, $once = false)
    {
        self::_securityCheck($filename);

        /**
         * Search in provided directories, as well as include_path
         */
        $incPath = false;
        if (!empty($dirs) && (is_array($dirs) || is_string($dirs))) {
            if (is_array($dirs)) {
                $dirs = implode(PATH_SEPARATOR, $dirs);
            }
            $incPath = get_include_path();
            set_include_path($dirs . PATH_SEPARATOR . $incPath);
        }

        /**
         * Try finding for the plain filename in the include_path.
         */
        if ($once) {
            include_once $filename;
        } else {
            include $filename;
        }

        /**
         * If searching in directories, reset include_path
         */
        if ($incPath) {
            set_include_path($incPath);
        }

        return true;
    }

    /**
     * Returns TRUE if the $filename is readable, or FALSE otherwise.
     * This function uses the PHP include_path, where PHP's is_readable()
     * does not.
     *
     * @param string   $filename
     * @return boolean
     */
    public static function isReadable($filename)
    {
        if (!$fh = @fopen($filename, 'r', true)) {
            return false;
        }
        @fclose($fh);
        return true;
    }

    /**
     * spl_autoload() suitable implementation for supporting class autoloading.
     *
     * Attach to spl_autoload() using the following:
     * <code>
     * spl_autoload_register(array('Zend_Loader', 'autoload'));
     * </code>
     *
     * @param string $class
     * @return string|false Class name on success; false on failure
     */
    public static function autoload($class)
    {
        try {
            self::loadClass($class);
            return $class;
        } catch (Exception $e) {
            return false;
        }
    }

    /**
     * Register {@link autoload()} with spl_autoload()
     *
     * @param string $class (optional)
     * @param boolean $enabled (optional)
     * @return void
     * @throws Zend_Exception if spl_autoload() is not found
     * or if the specified class does not have an autoload() method.
     */
    public static function registerAutoload($class = 'Zend_Loader', $enabled = true)
    {
        if (!function_exists('spl_autoload_register')) {
            require_once 'Zend/Exception.php';
            throw new Zend_Exception('spl_autoload does not exist in this PHP installation');
        }

        self::loadClass($class);
        $methods = get_class_methods($class);
        if (!in_array('autoload', (array) $methods)) {
            require_once 'Zend/Exception.php';
            throw new Zend_Exception("The class \"$class\" does not have an autoload() method");
        }

        if ($enabled === true) {
            spl_autoload_register(array($class, 'autoload'));
        } else {
            spl_autoload_unregister(array($class, 'autoload'));
        }
    }

    /**
     * Ensure that filename does not contain exploits
     *
     * @param  string $filename
     * @return void
     * @throws Zend_Exception
     */
    protected static function _securityCheck($filename)
    {
        /**
         * Security check
         */
        if (preg_match('/[^a-z0-9\\/\\\\_.-]/i', $filename)) {
            require_once 'Zend/Exception.php';
            throw new Zend_Exception('Security check: Illegal character in filename');
        }
    }

    /**
     * Attempt to include() the file.
     *
     * include() is not prefixed with the @ operator because if
     * the file is loaded and contains a parse error, execution
     * will halt silently and this is difficult to debug.
     *
     * Always set display_errors = Off on production servers!
     *
     * @param  string  $filespec
     * @param  boolean $once
     * @return boolean
     * @deprecated Since 1.5.0; use loadFile() instead
     */
    protected static function _includeFile($filespec, $once = false)
    {
        if ($once) {
            return include_once $filespec;
        } else {
            return include $filespec ;
        }
    }
}
63   5007|/shs.parser/classes/phpQuery/phpQuery/Zend/Uri.php|e8cf14f<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Uri
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: Uri.php 9656 2008-06-10 16:21:13Z dasprid $
 */

/**
 * @see Zend_Loader
 */
require_once 'Zend/Loader.php';

/**
 * Abstract class for all Zend_Uri handlers
 *
 * @category  Zend
 * @package   Zend_Uri
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
abstract class Zend_Uri
{
    /**
     * Scheme of this URI (http, ftp, etc.)
     *
     * @var string
     */
    protected $_scheme = '';

    /**
     * Return a string representation of this URI.
     *
     * @see    getUri()
     * @return string
     */
    public function __toString()
    {
        return $this->getUri();
    }

    /**
     * Convenience function, checks that a $uri string is well-formed
     * by validating it but not returning an object.  Returns TRUE if
     * $uri is a well-formed URI, or FALSE otherwise.
     *
     * @param  string $uri The URI to check
     * @return boolean
     */
    public static function check($uri)
    {
        try {
            $uri = self::factory($uri);
        } catch (Exception $e) {
            return false;
        }

        return $uri->valid();
    }

    /**
     * Create a new Zend_Uri object for a URI.  If building a new URI, then $uri should contain
     * only the scheme (http, ftp, etc).  Otherwise, supply $uri with the complete URI.
     *
     * @param  string $uri The URI form which a Zend_Uri instance is created
     * @throws Zend_Uri_Exception When an empty string was supplied for the scheme
     * @throws Zend_Uri_Exception When an illegal scheme is supplied
     * @throws Zend_Uri_Exception When the scheme is not supported
     * @return Zend_Uri
     * @link   http://www.faqs.org/rfcs/rfc2396.html
     */
    public static function factory($uri = 'http')
    {
        // Separate the scheme from the scheme-specific parts
        $uri            = explode(':', $uri, 2);
        $scheme         = strtolower($uri[0]);
        $schemeSpecific = isset($uri[1]) === true ? $uri[1] : '';

        if (strlen($scheme) === 0) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('An empty string was supplied for the scheme');
        }

        // Security check: $scheme is used to load a class file, so only alphanumerics are allowed.
        if (ctype_alnum($scheme) === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('Illegal scheme supplied, only alphanumeric characters are permitted');
        }

        /**
         * Create a new Zend_Uri object for the $uri. If a subclass of Zend_Uri exists for the
         * scheme, return an instance of that class. Otherwise, a Zend_Uri_Exception is thrown.
         */
        switch ($scheme) {
            case 'http':
                // Break intentionally omitted
            case 'https':
                $className = 'Zend_Uri_Http';
                break;

            case 'mailto':
                // TODO
            default:
                require_once 'Zend/Uri/Exception.php';
                throw new Zend_Uri_Exception("Scheme \"$scheme\" is not supported");
                break;
        }

        Zend_Loader::loadClass($className);
        $schemeHandler = new $className($scheme, $schemeSpecific);

        return $schemeHandler;
    }

    /**
     * Get the URI's scheme
     *
     * @return string|false Scheme or false if no scheme is set.
     */
    public function getScheme()
    {
        if (empty($this->_scheme) === false) {
            return $this->_scheme;
        } else {
            return false;
        }
    }

    /**
     * Zend_Uri and its subclasses cannot be instantiated directly.
     * Use Zend_Uri::factory() to return a new Zend_Uri object.
     *
     * @param string $scheme         The scheme of the URI
     * @param string $schemeSpecific The scheme-specific part of the URI
     */
    abstract protected function __construct($scheme, $schemeSpecific = '');

    /**
     * Return a string representation of this URI.
     *
     * @return string
     */
    abstract public function getUri();

    /**
     * Returns TRUE if this URI is valid, or FALSE otherwise.
     *
     * @return boolean
     */
    abstract public function valid();
}
69   930|/shs.parser/classes/phpQuery/phpQuery/Zend/Exception.php|b16ce288<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */


/**
 * @category   Zend
 * @package    Zend
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Exception extends Exception
{}

69   5682|/shs.parser/classes/phpQuery/phpQuery/Zend/Registry.php|b2b0e123<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Registry
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Registry.php 8064 2008-02-16 10:58:39Z thomas $
 */

/**
 * Generic storage class helps to manage global data.
 *
 * @category   Zend
 * @package    Zend_Registry
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Registry extends ArrayObject
{
    /**
     * Class name of the singleton registry object.
     * @var string
     */
    private static $_registryClassName = 'Zend_Registry';

    /**
     * Registry object provides storage for shared objects.
     * @var Zend_Registry
     */
    private static $_registry = null;

    /**
     * Retrieves the default registry instance.
     *
     * @return Zend_Registry
     */
    public static function getInstance()
    {
        if (self::$_registry === null) {
            self::init();
        }

        return self::$_registry;
    }

    /**
     * Set the default registry instance to a specified instance.
     *
     * @param Zend_Registry $registry An object instance of type Zend_Registry,
     *   or a subclass.
     * @return void
     * @throws Zend_Exception if registry is already initialized.
     */
    public static function setInstance(Zend_Registry $registry)
    {
        if (self::$_registry !== null) {
            require_once 'Zend/Exception.php';
            throw new Zend_Exception('Registry is already initialized');
        }

        self::setClassName(get_class($registry));
        self::$_registry = $registry;
    }

    /**
     * Initialize the default registry instance.
     *
     * @return void
     */
    protected static function init()
    {
        self::setInstance(new self::$_registryClassName());
    }

    /**
     * Set the class name to use for the default registry instance.
     * Does not affect the currently initialized instance, it only applies
     * for the next time you instantiate.
     *
     * @param string $registryClassName
     * @return void
     * @throws Zend_Exception if the registry is initialized or if the
     *   class name is not valid.
     */
    public static function setClassName($registryClassName = 'Zend_Registry')
    {
        if (self::$_registry !== null) {
            require_once 'Zend/Exception.php';
            throw new Zend_Exception('Registry is already initialized');
        }

        if (!is_string($registryClassName)) {
            require_once 'Zend/Exception.php';
            throw new Zend_Exception("Argument is not a class name");
        }

        /**
         * @see Zend_Loader
         */
        require_once 'Zend/Loader.php';
        Zend_Loader::loadClass($registryClassName);

        self::$_registryClassName = $registryClassName;
    }

    /**
     * Unset the default registry instance.
     * Primarily used in tearDown() in unit tests.
     * @returns void
     */
    public static function _unsetInstance()
    {
        self::$_registry = null;
    }

    /**
     * getter method, basically same as offsetGet().
     *
     * This method can be called from an object of type Zend_Registry, or it
     * can be called statically.  In the latter case, it uses the default
     * static instance stored in the class.
     *
     * @param string $index - get the value associated with $index
     * @return mixed
     * @throws Zend_Exception if no entry is registerd for $index.
     */
    public static function get($index)
    {
        $instance = self::getInstance();

        if (!$instance->offsetExists($index)) {
            require_once 'Zend/Exception.php';
            throw new Zend_Exception("No entry is registered for key '$index'");
        }

        return $instance->offsetGet($index);
    }

    /**
     * setter method, basically same as offsetSet().
     *
     * This method can be called from an object of type Zend_Registry, or it
     * can be called statically.  In the latter case, it uses the default
     * static instance stored in the class.
     *
     * @param string $index The location in the ArrayObject in which to store
     *   the value.
     * @param mixed $value The object to store in the ArrayObject.
     * @return void
     */
    public static function set($index, $value)
    {
        $instance = self::getInstance();
        $instance->offsetSet($index, $value);
    }

    /**
     * Returns TRUE if the $index is a named value in the registry,
     * or FALSE if $index was not found in the registry.
     *
     * @param  string $index
     * @return boolean
     */
    public static function isRegistered($index)
    {
        if (self::$_registry === null) {
            return false;
        }
        return self::$_registry->offsetExists($index);
    }

    /**
     * @param string $index
     * @returns mixed
     *
     * Workaround for http://bugs.php.net/bug.php?id=40442 (ZF-960).
     */
    public function offsetExists($index)
    {
        return array_key_exists($index, $this);
    }

}
74   1104|/shs.parser/classes/phpQuery/phpQuery/Zend/Uri/Exception.php|2828398b<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Uri
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: Exception.php 9656 2008-06-10 16:21:13Z dasprid $
 */

/**
 * @see Zend_Exception
 */
require_once 'Zend/Exception.php';

/**
 * Exceptions for Zend_Uri
 *
 * @category  Zend
 * @package   Zend_Uri
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Uri_Exception extends Zend_Exception
{
}
70   22259|/shs.parser/classes/phpQuery/phpQuery/Zend/Uri/Http.php|c57ea598<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Uri
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: Http.php 9656 2008-06-10 16:21:13Z dasprid $
 */

/**
 * @see Zend_Uri
 */
require_once 'Zend/Uri.php';

/**
 * @see Zend_Validate_Hostname
 */
require_once 'Zend/Validate/Hostname.php';

/**
 * HTTP(S) URI handler
 *
 * @category  Zend
 * @package   Zend_Uri
 * @uses      Zend_Uri
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Uri_Http extends Zend_Uri
{
    /**
     * HTTP username
     *
     * @var string
     */
    protected $_username = '';

    /**
     * HTTP password
     *
     * @var string
     */
    protected $_password = '';

    /**
     * HTTP host
     *
     * @var string
     */
    protected $_host = '';

    /**
     * HTTP post
     *
     * @var string
     */
    protected $_port = '';

    /**
     * HTTP part
     *
     * @var string
     */
    protected $_path = '';

    /**
     * HTTP query
     *
     * @var string
     */
    protected $_query = '';

    /**
     * HTTP fragment
     *
     * @var string
     */
    protected $_fragment = '';

    /**
     * Regular expression grammar rules for validation; values added by constructor
     *
     * @var array
     */
    protected $_regex = array();

    /**
     * Constructor accepts a string $scheme (e.g., http, https) and a scheme-specific part of the URI
     * (e.g., example.com/path/to/resource?query=param#fragment)
     *
     * @param  string $scheme         The scheme of the URI
     * @param  string $schemeSpecific The scheme-specific part of the URI
     * @throws Zend_Uri_Exception When the URI is not valid
     */
    protected function __construct($scheme, $schemeSpecific = '')
    {
        // Set the scheme
        $this->_scheme = $scheme;

        // Set up grammar rules for validation via regular expressions. These
        // are to be used with slash-delimited regular expression strings.
        $this->_regex['alphanum']   = '[^\W_]';
        $this->_regex['escaped']    = '(?:%[\da-fA-F]{2})';
        $this->_regex['mark']       = '[-_.!~*\'()\[\]]';
        $this->_regex['reserved']   = '[;\/?:@&=+$,]';
        $this->_regex['unreserved'] = '(?:' . $this->_regex['alphanum'] . '|' . $this->_regex['mark'] . ')';
        $this->_regex['segment']    = '(?:(?:' . $this->_regex['unreserved'] . '|' . $this->_regex['escaped']
                                    . '|[:@&=+$,;])*)';
        $this->_regex['path']       = '(?:\/' . $this->_regex['segment'] . '?)+';
        $this->_regex['uric']       = '(?:' . $this->_regex['reserved'] . '|' . $this->_regex['unreserved'] . '|'
                                    . $this->_regex['escaped'] . ')';
        // If no scheme-specific part was supplied, the user intends to create
        // a new URI with this object.  No further parsing is required.
        if (strlen($schemeSpecific) === 0) {
            return;
        }

        // Parse the scheme-specific URI parts into the instance variables.
        $this->_parseUri($schemeSpecific);

        // Validate the URI
        if ($this->valid() === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('Invalid URI supplied');
        }
    }

    /**
     * Creates a Zend_Uri_Http from the given string
     *
     * @param  string $uri String to create URI from, must start with
     *                     'http://' or 'https://'
     * @throws InvalidArgumentException  When the given $uri is not a string or
     *                                   does not start with http:// or https://
     * @throws Zend_Uri_Exception        When the given $uri is invalid
     * @return Zend_Uri_Http
     */
    public static function fromString($uri)
    {
        if (is_string($uri) === false) {
            throw new InvalidArgumentException('$uri is not a string');
        }

        $uri            = explode(':', $uri, 2);
        $scheme         = strtolower($uri[0]);
        $schemeSpecific = isset($uri[1]) === true ? $uri[1] : '';

        if (in_array($scheme, array('http', 'https')) === false) {
            throw new Zend_Uri_Exception("Invalid scheme: '$scheme'");
        }

        $schemeHandler = new Zend_Uri_Http($scheme, $schemeSpecific);
        return $schemeHandler;
    }

    /**
     * Parse the scheme-specific portion of the URI and place its parts into instance variables.
     *
     * @param  string $schemeSpecific The scheme-specific portion to parse
     * @throws Zend_Uri_Exception When scheme-specific decoposition fails
     * @throws Zend_Uri_Exception When authority decomposition fails
     * @return void
     */
    protected function _parseUri($schemeSpecific)
    {
        // High-level decomposition parser
        $pattern = '~^((//)([^/?#]*))([^?#]*)(\?([^#]*))?(#(.*))?$~';
        $status  = @preg_match($pattern, $schemeSpecific, $matches);
        if ($status === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('Internal error: scheme-specific decomposition failed');
        }

        // Failed decomposition; no further processing needed
        if ($status === false) {
            return;
        }

        // Save URI components that need no further decomposition
        $this->_path     = isset($matches[4]) === true ? $matches[4] : '';
        $this->_query    = isset($matches[6]) === true ? $matches[6] : '';
        $this->_fragment = isset($matches[8]) === true ? $matches[8] : '';

        // Additional decomposition to get username, password, host, and port
        $combo   = isset($matches[3]) === true ? $matches[3] : '';
        $pattern = '~^(([^:@]*)(:([^@]*))?@)?([^:]+)(:(.*))?$~';
        $status  = @preg_match($pattern, $combo, $matches);
        if ($status === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('Internal error: authority decomposition failed');
        }

        // Failed decomposition; no further processing needed
        if ($status === false) {
            return;
        }

        // Save remaining URI components
        $this->_username = isset($matches[2]) === true ? $matches[2] : '';
        $this->_password = isset($matches[4]) === true ? $matches[4] : '';
        $this->_host     = isset($matches[5]) === true ? $matches[5] : '';
        $this->_port     = isset($matches[7]) === true ? $matches[7] : '';

    }

    /**
     * Returns a URI based on current values of the instance variables. If any
     * part of the URI does not pass validation, then an exception is thrown.
     *
     * @throws Zend_Uri_Exception When one or more parts of the URI are invalid
     * @return string
     */
    public function getUri()
    {
        if ($this->valid() === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('One or more parts of the URI are invalid');
        }

        $password = strlen($this->_password) > 0 ? ":$this->_password" : '';
        $auth     = strlen($this->_username) > 0 ? "$this->_username$password@" : '';
        $port     = strlen($this->_port) > 0 ? ":$this->_port" : '';
        $query    = strlen($this->_query) > 0 ? "?$this->_query" : '';
        $fragment = strlen($this->_fragment) > 0 ? "#$this->_fragment" : '';

        return $this->_scheme
             . '://'
             . $auth
             . $this->_host
             . $port
             . $this->_path
             . $query
             . $fragment;
    }

    /**
     * Validate the current URI from the instance variables. Returns true if and only if all
     * parts pass validation.
     *
     * @return boolean
     */
    public function valid()
    {
        // Return true if and only if all parts of the URI have passed validation
        return $this->validateUsername()
           and $this->validatePassword()
           and $this->validateHost()
           and $this->validatePort()
           and $this->validatePath()
           and $this->validateQuery()
           and $this->validateFragment();
    }

    /**
     * Returns the username portion of the URL, or FALSE if none.
     *
     * @return string
     */
    public function getUsername()
    {
        return strlen($this->_username) > 0 ? $this->_username : false;
    }

    /**
     * Returns true if and only if the username passes validation. If no username is passed,
     * then the username contained in the instance variable is used.
     *
     * @param  string $username The HTTP username
     * @throws Zend_Uri_Exception When username validation fails
     * @return boolean
     * @link   http://www.faqs.org/rfcs/rfc2396.html
     */
    public function validateUsername($username = null)
    {
        if ($username === null) {
            $username = $this->_username;
        }

        // If the username is empty, then it is considered valid
        if (strlen($username) === 0) {
            return true;
        }

        // Check the username against the allowed values
        $status = @preg_match('/^(' . $this->_regex['alphanum']  . '|' . $this->_regex['mark'] . '|'
                            . $this->_regex['escaped'] . '|[;:&=+$,])+$/', $username);
        if ($status === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('Internal error: username validation failed');
        }

        return $status === 1;
    }

    /**
     * Sets the username for the current URI, and returns the old username
     *
     * @param  string $username The HTTP username
     * @throws Zend_Uri_Exception When $username is not a valid HTTP username
     * @return string
     */
    public function setUsername($username)
    {
        if ($this->validateUsername($username) === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception("Username \"$username\" is not a valid HTTP username");
        }

        $oldUsername     = $this->_username;
        $this->_username = $username;

        return $oldUsername;
    }

    /**
     * Returns the password portion of the URL, or FALSE if none.
     *
     * @return string
     */
    public function getPassword()
    {
        return strlen($this->_password) > 0 ? $this->_password : false;
    }

    /**
     * Returns true if and only if the password passes validation. If no password is passed,
     * then the password contained in the instance variable is used.
     *
     * @param  string $password The HTTP password
     * @throws Zend_Uri_Exception When password validation fails
     * @return boolean
     * @link   http://www.faqs.org/rfcs/rfc2396.html
     */
    public function validatePassword($password = null)
    {
        if ($password === null) {
            $password = $this->_password;
        }

        // If the password is empty, then it is considered valid
        if (strlen($password) === 0) {
            return true;
        }

        // If the password is nonempty, but there is no username, then it is considered invalid
        if (strlen($password) > 0 and strlen($this->_username) === 0) {
            return false;
        }

        // Check the password against the allowed values
        $status = @preg_match('/^(' . $this->_regex['alphanum']  . '|' . $this->_regex['mark'] . '|'
                             . $this->_regex['escaped'] . '|[;:&=+$,])+$/', $password);
        if ($status === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('Internal error: password validation failed.');
        }

        return $status == 1;
    }

    /**
     * Sets the password for the current URI, and returns the old password
     *
     * @param  string $password The HTTP password
     * @throws Zend_Uri_Exception When $password is not a valid HTTP password
     * @return string
     */
    public function setPassword($password)
    {
        if ($this->validatePassword($password) === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception("Password \"$password\" is not a valid HTTP password.");
        }

        $oldPassword     = $this->_password;
        $this->_password = $password;

        return $oldPassword;
    }

    /**
     * Returns the domain or host IP portion of the URL, or FALSE if none.
     *
     * @return string
     */
    public function getHost()
    {
        return strlen($this->_host) > 0 ? $this->_host : false;
    }

    /**
     * Returns true if and only if the host string passes validation. If no host is passed,
     * then the host contained in the instance variable is used.
     *
     * @param  string $host The HTTP host
     * @return boolean
     * @uses   Zend_Filter
     */
    public function validateHost($host = null)
    {
        if ($host === null) {
            $host = $this->_host;
        }

        // If the host is empty, then it is considered invalid
        if (strlen($host) === 0) {
            return false;
        }

        // Check the host against the allowed values; delegated to Zend_Filter.
        $validate = new Zend_Validate_Hostname(Zend_Validate_Hostname::ALLOW_ALL);

        return $validate->isValid($host);
    }

    /**
     * Sets the host for the current URI, and returns the old host
     *
     * @param  string $host The HTTP host
     * @throws Zend_Uri_Exception When $host is nota valid HTTP host
     * @return string
     */
    public function setHost($host)
    {
        if ($this->validateHost($host) === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception("Host \"$host\" is not a valid HTTP host");
        }

        $oldHost     = $this->_host;
        $this->_host = $host;

        return $oldHost;
    }

    /**
     * Returns the TCP port, or FALSE if none.
     *
     * @return string
     */
    public function getPort()
    {
        return strlen($this->_port) > 0 ? $this->_port : false;
    }

    /**
     * Returns true if and only if the TCP port string passes validation. If no port is passed,
     * then the port contained in the instance variable is used.
     *
     * @param  string $port The HTTP port
     * @return boolean
     */
    public function validatePort($port = null)
    {
        if ($port === null) {
            $port = $this->_port;
        }

        // If the port is empty, then it is considered valid
        if (strlen($port) === 0) {
            return true;
        }

        // Check the port against the allowed values
        return ctype_digit((string) $port) and 1 <= $port and $port <= 65535;
    }

    /**
     * Sets the port for the current URI, and returns the old port
     *
     * @param  string $port The HTTP port
     * @throws Zend_Uri_Exception When $port is not a valid HTTP port
     * @return string
     */
    public function setPort($port)
    {
        if ($this->validatePort($port) === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception("Port \"$port\" is not a valid HTTP port.");
        }

        $oldPort     = $this->_port;
        $this->_port = $port;

        return $oldPort;
    }

    /**
     * Returns the path and filename portion of the URL, or FALSE if none.
     *
     * @return string
     */
    public function getPath()
    {
        return strlen($this->_path) > 0 ? $this->_path : '/';
    }

    /**
     * Returns true if and only if the path string passes validation. If no path is passed,
     * then the path contained in the instance variable is used.
     *
     * @param  string $path The HTTP path
     * @throws Zend_Uri_Exception When path validation fails
     * @return boolean
     */
    public function validatePath($path = null)
    {
        if ($path === null) {
            $path = $this->_path;
        }

        // If the path is empty, then it is considered valid
        if (strlen($path) === 0) {
            return true;
        }

        // Determine whether the path is well-formed
        $pattern = '/^' . $this->_regex['path'] . '$/';
        $status  = @preg_match($pattern, $path);
        if ($status === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('Internal error: path validation failed');
        }

        return (boolean) $status;
    }

    /**
     * Sets the path for the current URI, and returns the old path
     *
     * @param  string $path The HTTP path
     * @throws Zend_Uri_Exception When $path is not a valid HTTP path
     * @return string
     */
    public function setPath($path)
    {
        if ($this->validatePath($path) === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception("Path \"$path\" is not a valid HTTP path");
        }

        $oldPath     = $this->_path;
        $this->_path = $path;

        return $oldPath;
    }

    /**
     * Returns the query portion of the URL (after ?), or FALSE if none.
     *
     * @return string
     */
    public function getQuery()
    {
        return strlen($this->_query) > 0 ? $this->_query : false;
    }

    /**
     * Returns true if and only if the query string passes validation. If no query is passed,
     * then the query string contained in the instance variable is used.
     *
     * @param  string $query The query to validate
     * @throws Zend_Uri_Exception When query validation fails
     * @return boolean
     * @link   http://www.faqs.org/rfcs/rfc2396.html
     */
    public function validateQuery($query = null)
    {
        if ($query === null) {
            $query = $this->_query;
        }

        // If query is empty, it is considered to be valid
        if (strlen($query) === 0) {
            return true;
        }

        // Determine whether the query is well-formed
        $pattern = '/^' . $this->_regex['uric'] . '*$/';
        $status  = @preg_match($pattern, $query);
        if ($status === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('Internal error: query validation failed');
        }

        return $status == 1;
    }

    /**
     * Set the query string for the current URI, and return the old query
     * string This method accepts both strings and arrays.
     *
     * @param  string|array $query The query string or array
     * @throws Zend_Uri_Exception When $query is not a valid query string
     * @return string              Old query string
     */
    public function setQuery($query)
    {
        $oldQuery = $this->_query;

        // If query is empty, set an empty string
        if (empty($query) === true) {
            $this->_query = '';
            return $oldQuery;
        }

        // If query is an array, make a string out of it
        if (is_array($query) === true) {
            $query = http_build_query($query, '', '&');
        } else {
            // If it is a string, make sure it is valid. If not parse and encode it
            $query = (string) $query;
            if ($this->validateQuery($query) === false) {
                parse_str($query, $queryArray);
                $query = http_build_query($queryArray, '', '&');
            }
        }

        // Make sure the query is valid, and set it
        if ($this->validateQuery($query) === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception("'$query' is not a valid query string");
        }

        $this->_query = $query;

        return $oldQuery;
    }

    /**
     * Returns the fragment portion of the URL (after #), or FALSE if none.
     *
     * @return string|false
     */
    public function getFragment()
    {
        return strlen($this->_fragment) > 0 ? $this->_fragment : false;
    }

    /**
     * Returns true if and only if the fragment passes validation. If no fragment is passed,
     * then the fragment contained in the instance variable is used.
     *
     * @param  string $fragment Fragment of an URI
     * @throws Zend_Uri_Exception When fragment validation fails
     * @return boolean
     * @link   http://www.faqs.org/rfcs/rfc2396.html
     */
    public function validateFragment($fragment = null)
    {
        if ($fragment === null) {
            $fragment = $this->_fragment;
        }

        // If fragment is empty, it is considered to be valid
        if (strlen($fragment) === 0) {
            return true;
        }

        // Determine whether the fragment is well-formed
        $pattern = '/^' . $this->_regex['uric'] . '*$/';
        $status  = @preg_match($pattern, $fragment);
        if ($status === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception('Internal error: fragment validation failed');
        }

        return (boolean) $status;
    }

    /**
     * Sets the fragment for the current URI, and returns the old fragment
     *
     * @param  string $fragment Fragment of the current URI
     * @throws Zend_Uri_Exception When $fragment is not a valid HTTP fragment
     * @return string
     */
    public function setFragment($fragment)
    {
        if ($this->validateFragment($fragment) === false) {
            require_once 'Zend/Uri/Exception.php';
            throw new Zend_Uri_Exception("Fragment \"$fragment\" is not a valid HTTP fragment");
        }

        $oldFragment     = $this->_fragment;
        $this->_fragment = $fragment;

        return $oldFragment;
    }
}
73   37926|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/Client.php|4d762c5c<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client
 * @version    $Id: Client.php 9906 2008-07-02 21:20:10Z shahar $
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

/**
 * @see Zend_Loader
 */
require_once 'Zend/Loader.php';


/**
 * @see Zend_Uri
 */
require_once 'Zend/Uri.php';


/**
 * @see Zend_Http_Client_Adapter_Interface
 */
require_once 'Zend/Http/Client/Adapter/Interface.php';


/**
 * @see Zend_Http_Response
 */
require_once 'Zend/Http/Response.php';

/**
 * Zend_Http_Client is an implemetation of an HTTP client in PHP. The client
 * supports basic features like sending different HTTP requests and handling
 * redirections, as well as more advanced features like proxy settings, HTTP
 * authentication and cookie persistance (using a Zend_Http_CookieJar object)
 *
 * @todo Implement proxy settings
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client
 * @throws     Zend_Http_Client_Exception
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Http_Client
{
    /**
     * HTTP request methods
     */
    const GET     = 'GET';
    const POST    = 'POST';
    const PUT     = 'PUT';
    const HEAD    = 'HEAD';
    const DELETE  = 'DELETE';
    const TRACE   = 'TRACE';
    const OPTIONS = 'OPTIONS';
    const CONNECT = 'CONNECT';

    /**
     * Supported HTTP Authentication methods
     */
    const AUTH_BASIC = 'basic';
    //const AUTH_DIGEST = 'digest'; <-- not implemented yet

    /**
     * HTTP protocol versions
     */
    const HTTP_1 = '1.1';
    const HTTP_0 = '1.0';

    /**
     * POST data encoding methods
     */
    const ENC_URLENCODED = 'application/x-www-form-urlencoded';
    const ENC_FORMDATA   = 'multipart/form-data';

    /**
     * Configuration array, set using the constructor or using ::setConfig()
     *
     * @var array
     */
    protected $config = array(
        'maxredirects'    => 5,
        'strictredirects' => false,
        'useragent'       => 'Zend_Http_Client',
        'timeout'         => 10,
        'adapter'         => 'Zend_Http_Client_Adapter_Socket',
        'httpversion'     => self::HTTP_1,
        'keepalive'       => false,
        'storeresponse'   => true,
        'strict'          => true
    );

    /**
     * The adapter used to preform the actual connection to the server
     *
     * @var Zend_Http_Client_Adapter_Interface
     */
    protected $adapter = null;

    /**
     * Request URI
     *
     * @var Zend_Uri_Http
     */
    protected $uri;

    /**
     * Associative array of request headers
     *
     * @var array
     */
    protected $headers = array();

    /**
     * HTTP request method
     *
     * @var string
     */
    protected $method = self::GET;

    /**
     * Associative array of GET parameters
     *
     * @var array
     */
    protected $paramsGet = array();

    /**
     * Assiciative array of POST parameters
     *
     * @var array
     */
    protected $paramsPost = array();

    /**
     * Request body content type (for POST requests)
     *
     * @var string
     */
    protected $enctype = null;

    /**
     * The raw post data to send. Could be set by setRawData($data, $enctype).
     *
     * @var string
     */
    protected $raw_post_data = null;

    /**
     * HTTP Authentication settings
     *
     * Expected to be an associative array with this structure:
     * $this->auth = array('user' => 'username', 'password' => 'password', 'type' => 'basic')
     * Where 'type' should be one of the supported authentication types (see the AUTH_*
     * constants), for example 'basic' or 'digest'.
     *
     * If null, no authentication will be used.
     *
     * @var array|null
     */
    protected $auth;

    /**
     * File upload arrays (used in POST requests)
     *
     * An associative array, where each element is of the format:
     *   'name' => array('filename.txt', 'text/plain', 'This is the actual file contents')
     *
     * @var array
     */
    protected $files = array();

    /**
     * The client's cookie jar
     *
     * @var Zend_Http_CookieJar
     */
    protected $cookiejar = null;

    /**
     * The last HTTP request sent by the client, as string
     *
     * @var string
     */
    protected $last_request = null;

    /**
     * The last HTTP response received by the client
     *
     * @var Zend_Http_Response
     */
    protected $last_response = null;

    /**
     * Redirection counter
     *
     * @var int
     */
    protected $redirectCounter = 0;

    /**
     * Fileinfo magic database resource
     * 
     * This varaiable is populated the first time _detectFileMimeType is called
     * and is then reused on every call to this method
     *
     * @var resource
     */
    static protected $_fileInfoDb = null;
    
    /**
     * Contructor method. Will create a new HTTP client. Accepts the target
     * URL and optionally configuration array.
     *
     * @param Zend_Uri_Http|string $uri
     * @param array $config Configuration key-value pairs.
     */
    public function __construct($uri = null, $config = null)
    {
        if ($uri !== null) $this->setUri($uri);
        if ($config !== null) $this->setConfig($config);
    }

    /**
     * Set the URI for the next request
     *
     * @param  Zend_Uri_Http|string $uri
     * @return Zend_Http_Client
     * @throws Zend_Http_Client_Exception
     */
    public function setUri($uri)
    {
        if (is_string($uri)) {
            $uri = Zend_Uri::factory($uri);
        }

        if (!$uri instanceof Zend_Uri_Http) {
            /** @see Zend_Http_Client_Exception */
            require_once 'Zend/Http/Client/Exception.php';
            throw new Zend_Http_Client_Exception('Passed parameter is not a valid HTTP URI.');
        }

        // We have no ports, set the defaults
        if (! $uri->getPort()) {
            $uri->setPort(($uri->getScheme() == 'https' ? 443 : 80));
        }

        $this->uri = $uri;

        return $this;
    }

    /**
     * Get the URI for the next request
     *
     * @param boolean $as_string If true, will return the URI as a string
     * @return Zend_Uri_Http|string
     */
    public function getUri($as_string = false)
    {
        if ($as_string && $this->uri instanceof Zend_Uri_Http) {
            return $this->uri->__toString();
        } else {
            return $this->uri;
        }
    }

    /**
     * Set configuration parameters for this HTTP client
     *
     * @param array $config
     * @return Zend_Http_Client
     * @throws Zend_Http_Client_Exception
     */
    public function setConfig($config = array())
    {
        if (! is_array($config)) {
            /** @see Zend_Http_Client_Exception */
            require_once 'Zend/Http/Client/Exception.php';
            throw new Zend_Http_Client_Exception('Expected array parameter, given ' . gettype($config));
        }

        foreach ($config as $k => $v)
            $this->config[strtolower($k)] = $v;

        return $this;
    }

    /**
     * Set the next request's method
     *
     * Validated the passed method and sets it. If we have files set for
     * POST requests, and the new method is not POST, the files are silently
     * dropped.
     *
     * @param string $method
     * @return Zend_Http_Client
     * @throws Zend_Http_Client_Exception
     */
    public function setMethod($method = self::GET)
    {
        $regex = '/^[^\x00-\x1f\x7f-\xff\(\)<>@,;:\\\\"\/\[\]\?={}\s]+$/';
        if (! preg_match($regex, $method)) {
            /** @see Zend_Http_Client_Exception */
            require_once 'Zend/Http/Client/Exception.php';
            throw new Zend_Http_Client_Exception("'{$method}' is not a valid HTTP request method.");
        }

        if ($method == self::POST && $this->enctype === null)
            $this->setEncType(self::ENC_URLENCODED);

        $this->method = $method;

        return $this;
    }

    /**
     * Set one or more request headers
     *
     * This function can be used in several ways to set the client's request
     * headers:
     * 1. By providing two parameters: $name as the header to set (eg. 'Host')
     *    and $value as it's value (eg. 'www.example.com').
     * 2. By providing a single header string as the only parameter
     *    eg. 'Host: www.example.com'
     * 3. By providing an array of headers as the first parameter
     *    eg. array('host' => 'www.example.com', 'x-foo: bar'). In This case
     *    the function will call itself recursively for each array item.
     *
     * @param string|array $name Header name, full header string ('Header: value')
     *     or an array of headers
     * @param mixed $value Header value or null
     * @return Zend_Http_Client
     * @throws Zend_Http_Client_Exception
     */
    public function setHeaders($name, $value = null)
    {
        // If we got an array, go recusive!
        if (is_array($name)) {
            foreach ($name as $k => $v) {
                if (is_string($k)) {
                    $this->setHeaders($k, $v);
                } else {
                    $this->setHeaders($v, null);
                }
            }
        } else {
            // Check if $name needs to be split
            if ($value === null && (strpos($name, ':') > 0))
                list($name, $value) = explode(':', $name, 2);

            // Make sure the name is valid if we are in strict mode
            if ($this->config['strict'] && (! preg_match('/^[a-zA-Z0-9-]+$/', $name))) {
                /** @see Zend_Http_Client_Exception */
                require_once 'Zend/Http/Client/Exception.php';
                throw new Zend_Http_Client_Exception("{$name} is not a valid HTTP header name");
            }
            
            $normalized_name = strtolower($name);

            // If $value is null or false, unset the header
            if ($value === null || $value === false) {
                unset($this->headers[$normalized_name]);

            // Else, set the header
            } else {
                // Header names are storred lowercase internally.
                if (is_string($value)) $value = trim($value);
                $this->headers[$normalized_name] = array($name, $value);
            }
        }

        return $this;
    }

    /**
     * Get the value of a specific header
     *
     * Note that if the header has more than one value, an array
     * will be returned.
     *
     * @param string $key
     * @return string|array|null The header value or null if it is not set
     */
    public function getHeader($key)
    {
        $key = strtolower($key);
        if (isset($this->headers[$key])) {
            return $this->headers[$key][1];
        } else {
            return null;
        }
    }

    /**
     * Set a GET parameter for the request. Wrapper around _setParameter
     *
     * @param string|array $name
     * @param string $value
     * @return Zend_Http_Client
     */
    public function setParameterGet($name, $value = null)
    {
        if (is_array($name)) {
            foreach ($name as $k => $v)
                $this->_setParameter('GET', $k, $v);
        } else {
            $this->_setParameter('GET', $name, $value);
        }

        return $this;
    }

    /**
     * Set a POST parameter for the request. Wrapper around _setParameter
     *
     * @param string|array $name
     * @param string $value
     * @return Zend_Http_Client
     */
    public function setParameterPost($name, $value = null)
    {
        if (is_array($name)) {
            foreach ($name as $k => $v)
                $this->_setParameter('POST', $k, $v);
        } else {
            $this->_setParameter('POST', $name, $value);
        }

        return $this;
    }

    /**
     * Set a GET or POST parameter - used by SetParameterGet and SetParameterPost
     *
     * @param string $type GET or POST
     * @param string $name
     * @param string $value
     * @return null
     */
    protected function _setParameter($type, $name, $value)
    {
        $parray = array();
        $type = strtolower($type);
        switch ($type) {
            case 'get':
                $parray = &$this->paramsGet;
                break;
            case 'post':
                $parray = &$this->paramsPost;
                break;
        }

        if ($value === null) {
            if (isset($parray[$name])) unset($parray[$name]);
        } else {
            $parray[$name] = $value;
        }
    }

    /**
     * Get the number of redirections done on the last request
     *
     * @return int
     */
    public function getRedirectionsCount()
    {
        return $this->redirectCounter;
    }

    /**
     * Set HTTP authentication parameters
     *
     * $type should be one of the supported types - see the self::AUTH_*
     * constants.
     *
     * To enable authentication:
     * <code>
     * $this->setAuth('shahar', 'secret', Zend_Http_Client::AUTH_BASIC);
     * </code>
     *
     * To disable authentication:
     * <code>
     * $this->setAuth(false);
     * </code>
     *
     * @see http://www.faqs.org/rfcs/rfc2617.html
     * @param string|false $user User name or false disable authentication
     * @param string $password Password
     * @param string $type Authentication type
     * @return Zend_Http_Client
     * @throws Zend_Http_Client_Exception
     */
    public function setAuth($user, $password = '', $type = self::AUTH_BASIC)
    {
        // If we got false or null, disable authentication
        if ($user === false || $user === null) {
            $this->auth = null;

        // Else, set up authentication
        } else {
            // Check we got a proper authentication type
            if (! defined('self::AUTH_' . strtoupper($type))) {
                /** @see Zend_Http_Client_Exception */
                require_once 'Zend/Http/Client/Exception.php';
                throw new Zend_Http_Client_Exception("Invalid or not supported authentication type: '$type'");
            }

            $this->auth = array(
                'user' => (string) $user,
                'password' => (string) $password,
                'type' => $type
            );
        }

        return $this;
    }

    /**
     * Set the HTTP client's cookie jar.
     *
     * A cookie jar is an object that holds and maintains cookies across HTTP requests
     * and responses.
     *
     * @param Zend_Http_CookieJar|boolean $cookiejar Existing cookiejar object, true to create a new one, false to disable
     * @return Zend_Http_Client
     * @throws Zend_Http_Client_Exception
     */
    public function setCookieJar($cookiejar = true)
    {
        if (! class_exists('Zend_Http_CookieJar'))
            require_once 'Zend/Http/CookieJar.php';

        if ($cookiejar instanceof Zend_Http_CookieJar) {
            $this->cookiejar = $cookiejar;
        } elseif ($cookiejar === true) {
            $this->cookiejar = new Zend_Http_CookieJar();
        } elseif (! $cookiejar) {
            $this->cookiejar = null;
        } else {
            /** @see Zend_Http_Client_Exception */
            require_once 'Zend/Http/Client/Exception.php';
            throw new Zend_Http_Client_Exception('Invalid parameter type passed as CookieJar');
        }

        return $this;
    }

    /**
     * Return the current cookie jar or null if none.
     *
     * @return Zend_Http_CookieJar|null
     */
    public function getCookieJar()
    {
        return $this->cookiejar;
    }

    /**
     * Add a cookie to the request. If the client has no Cookie Jar, the cookies
     * will be added directly to the headers array as "Cookie" headers.
     *
     * @param Zend_Http_Cookie|string $cookie
     * @param string|null $value If "cookie" is a string, this is the cookie value.
     * @return Zend_Http_Client
     * @throws Zend_Http_Client_Exception
     */
    public function setCookie($cookie, $value = null)
    {
        if (! class_exists('Zend_Http_Cookie'))
            require_once 'Zend/Http/Cookie.php';

        if (is_array($cookie)) {
            foreach ($cookie as $c => $v) {
                if (is_string($c)) {
                    $this->setCookie($c, $v);
                } else {
                    $this->setCookie($v);
                }
            }

            return $this;
        }

        if ($value !== null) $value = urlencode($value);

        if (isset($this->cookiejar)) {
            if ($cookie instanceof Zend_Http_Cookie) {
                $this->cookiejar->addCookie($cookie);
            } elseif (is_string($cookie) && $value !== null) {
                $cookie = Zend_Http_Cookie::fromString("{$cookie}={$value}", $this->uri);
                $this->cookiejar->addCookie($cookie);
            }
        } else {
            if ($cookie instanceof Zend_Http_Cookie) {
                $name = $cookie->getName();
                $value = $cookie->getValue();
                $cookie = $name;
            }

            if (preg_match("/[=,; \t\r\n\013\014]/", $cookie)) {
                /** @see Zend_Http_Client_Exception */
                require_once 'Zend/Http/Client/Exception.php';
                throw new Zend_Http_Client_Exception("Cookie name cannot contain these characters: =,; \t\r\n\013\014 ({$cookie})");
            }

            $value = addslashes($value);

            if (! isset($this->headers['cookie'])) $this->headers['cookie'] = array('Cookie', '');
            $this->headers['cookie'][1] .= $cookie . '=' . $value . '; ';
        }

        return $this;
    }

    /**
     * Set a file to upload (using a POST request)
     *
     * Can be used in two ways:
     *
     * 1. $data is null (default): $filename is treated as the name if a local file which
     *    will be read and sent. Will try to guess the content type using mime_content_type().
     * 2. $data is set - $filename is sent as the file name, but $data is sent as the file
     *    contents and no file is read from the file system. In this case, you need to
     *    manually set the content-type ($ctype) or it will default to
     *    application/octet-stream.
     *
     * @param string $filename Name of file to upload, or name to save as
     * @param string $formname Name of form element to send as
     * @param string $data Data to send (if null, $filename is read and sent)
     * @param string $ctype Content type to use (if $data is set and $ctype is
     *     null, will be application/octet-stream)
     * @return Zend_Http_Client
     * @throws Zend_Http_Client_Exception
     */
    public function setFileUpload($filename, $formname, $data = null, $ctype = null)
    {
        if ($data === null) {
            if (($data = @file_get_contents($filename)) === false) {
                /** @see Zend_Http_Client_Exception */
                require_once 'Zend/Http/Client/Exception.php';
                throw new Zend_Http_Client_Exception("Unable to read file '{$filename}' for upload");
            }

            if (! $ctype) $ctype = $this->_detectFileMimeType($filename);
        }

        // Force enctype to multipart/form-data
        $this->setEncType(self::ENC_FORMDATA);

        $this->files[$formname] = array(basename($filename), $ctype, $data);

        return $this;
    }

    /**
     * Set the encoding type for POST data
     *
     * @param string $enctype
     * @return Zend_Http_Client
     */
    public function setEncType($enctype = self::ENC_URLENCODED)
    {
        $this->enctype = $enctype;

        return $this;
    }

    /**
     * Set the raw (already encoded) POST data.
     *
     * This function is here for two reasons:
     * 1. For advanced user who would like to set their own data, already encoded
     * 2. For backwards compatibilty: If someone uses the old post($data) method.
     *    this method will be used to set the encoded data.
     *
     * @param string $data
     * @param string $enctype
     * @return Zend_Http_Client
     */
    public function setRawData($data, $enctype = null)
    {
        $this->raw_post_data = $data;
        $this->setEncType($enctype);

        return $this;
    }

    /**
     * Clear all GET and POST parameters
     *
     * Should be used to reset the request parameters if the client is
     * used for several concurrent requests.
     *
     * @return Zend_Http_Client
     */
    public function resetParameters()
    {
        // Reset parameter data
        $this->paramsGet     = array();
        $this->paramsPost    = array();
        $this->files         = array();
        $this->raw_post_data = null;

        // Clear outdated headers
        if (isset($this->headers['content-type'])) unset($this->headers['content-type']);
        if (isset($this->headers['content-length'])) unset($this->headers['content-length']);

        return $this;
    }

    /**
     * Get the last HTTP request as string
     *
     * @return string
     */
    public function getLastRequest()
    {
        return $this->last_request;
    }

    /**
     * Get the last HTTP response received by this client
     *
     * If $config['storeresponse'] is set to false, or no response was
     * stored yet, will return null
     *
     * @return Zend_Http_Response or null if none
     */
    public function getLastResponse()
    {
        return $this->last_response;
    }

    /**
     * Load the connection adapter
     *
     * While this method is not called more than one for a client, it is
     * seperated from ->request() to preserve logic and readability
     *
     * @param Zend_Http_Client_Adapter_Interface|string $adapter
     * @return null
     * @throws Zend_Http_Client_Exception
     */
    public function setAdapter($adapter)
    {
        if (is_string($adapter)) {
            try {
                Zend_Loader::loadClass($adapter);
            } catch (Zend_Exception $e) {
                /** @see Zend_Http_Client_Exception */
                require_once 'Zend/Http/Client/Exception.php';
                throw new Zend_Http_Client_Exception("Unable to load adapter '$adapter': {$e->getMessage()}");
            }

            $adapter = new $adapter;
        }

        if (! $adapter instanceof Zend_Http_Client_Adapter_Interface) {
            /** @see Zend_Http_Client_Exception */
            require_once 'Zend/Http/Client/Exception.php';
            throw new Zend_Http_Client_Exception('Passed adapter is not a HTTP connection adapter');
        }

        $this->adapter = $adapter;
        $config = $this->config;
        unset($config['adapter']);
        $this->adapter->setConfig($config);
    }

    /**
     * Send the HTTP request and return an HTTP response object
     *
     * @param string $method
     * @return Zend_Http_Response
     * @throws Zend_Http_Client_Exception
     */
    public function request($method = null)
    {
        if (! $this->uri instanceof Zend_Uri_Http) {
            /** @see Zend_Http_Client_Exception */
            require_once 'Zend/Http/Client/Exception.php';
            throw new Zend_Http_Client_Exception('No valid URI has been passed to the client');
        }

        if ($method) $this->setMethod($method);
        $this->redirectCounter = 0;
        $response = null;

        // Make sure the adapter is loaded
        if ($this->adapter == null) $this->setAdapter($this->config['adapter']);

        // Send the first request. If redirected, continue.
        do {
            // Clone the URI and add the additional GET parameters to it
            $uri = clone $this->uri;
            if (! empty($this->paramsGet)) {
                $query = $uri->getQuery();
                   if (! empty($query)) $query .= '&';
                $query .= http_build_query($this->paramsGet, null, '&');

                $uri->setQuery($query);
            }

            $body = $this->_prepareBody();
            $headers = $this->_prepareHeaders();

            // Open the connection, send the request and read the response
            $this->adapter->connect($uri->getHost(), $uri->getPort(),
                ($uri->getScheme() == 'https' ? true : false));

            $this->last_request = $this->adapter->write($this->method,
                $uri, $this->config['httpversion'], $headers, $body);

            $response = $this->adapter->read();
            if (! $response) {
                /** @see Zend_Http_Client_Exception */
                require_once 'Zend/Http/Client/Exception.php';
                throw new Zend_Http_Client_Exception('Unable to read response, or response is empty');
            }

            $response = Zend_Http_Response::fromString($response);
            if ($this->config['storeresponse']) $this->last_response = $response;

            // Load cookies into cookie jar
            if (isset($this->cookiejar)) $this->cookiejar->addCookiesFromResponse($response, $uri);

            // If we got redirected, look for the Location header
            if ($response->isRedirect() && ($location = $response->getHeader('location'))) {

                // Check whether we send the exact same request again, or drop the parameters
                // and send a GET request
                if ($response->getStatus() == 303 ||
                   ((! $this->config['strictredirects']) && ($response->getStatus() == 302 ||
                       $response->getStatus() == 301))) {

                    $this->resetParameters();
                    $this->setMethod(self::GET);
                }

                // If we got a well formed absolute URI
                if (Zend_Uri_Http::check($location)) {
                    $this->setHeaders('host', null);
                    $this->setUri($location);

                } else {

                    // Split into path and query and set the query
                    if (strpos($location, '?') !== false) {
                        list($location, $query) = explode('?', $location, 2);
                    } else {
                        $query = '';
                    }
                    $this->uri->setQuery($query);

                    // Else, if we got just an absolute path, set it
                    if(strpos($location, '/') === 0) {
                        $this->uri->setPath($location);

                        // Else, assume we have a relative path
                    } else {
                        // Get the current path directory, removing any trailing slashes
                        $path = $this->uri->getPath();
                        $path = rtrim(substr($path, 0, strrpos($path, '/')), "/");
                        $this->uri->setPath($path . '/' . $location);
                    }
                }
                ++$this->redirectCounter;

            } else {
                // If we didn't get any location, stop redirecting
                break;
            }

        } while ($this->redirectCounter < $this->config['maxredirects']);

        return $response;
    }

    /**
     * Prepare the request headers
     *
     * @return array
     */
    protected function _prepareHeaders()
    {
        $headers = array();

        // Set the host header
        if (! isset($this->headers['host'])) {
            $host = $this->uri->getHost();

            // If the port is not default, add it
            if (! (($this->uri->getScheme() == 'http' && $this->uri->getPort() == 80) ||
                  ($this->uri->getScheme() == 'https' && $this->uri->getPort() == 443))) {
                $host .= ':' . $this->uri->getPort();
            }

            $headers[] = "Host: {$host}";
        }

        // Set the connection header
        if (! isset($this->headers['connection'])) {
            if (! $this->config['keepalive']) $headers[] = "Connection: close";
        }

        // Set the Accept-encoding header if not set - depending on whether
        // zlib is available or not.
        if (! isset($this->headers['accept-encoding'])) {
        	if (function_exists('gzinflate')) {
        		$headers[] = 'Accept-encoding: gzip, deflate';
        	} else {
        		$headers[] = 'Accept-encoding: identity';
        	}
        }
        
        // Set the content-type header
        if ($this->method == self::POST &&
           (! isset($this->headers['content-type']) && isset($this->enctype))) {

            $headers[] = "Content-type: {$this->enctype}";
        }
        
        // Set the user agent header
        if (! isset($this->headers['user-agent']) && isset($this->config['useragent'])) {
            $headers[] = "User-agent: {$this->config['useragent']}";
        }

        // Set HTTP authentication if needed
        if (is_array($this->auth)) {
            $auth = self::encodeAuthHeader($this->auth['user'], $this->auth['password'], $this->auth['type']);
            $headers[] = "Authorization: {$auth}";
        }

        // Load cookies from cookie jar
        if (isset($this->cookiejar)) {
            $cookstr = $this->cookiejar->getMatchingCookies($this->uri,
                true, Zend_Http_CookieJar::COOKIE_STRING_CONCAT);

            if ($cookstr) $headers[] = "Cookie: {$cookstr}";
        }

        // Add all other user defined headers
        foreach ($this->headers as $header) {
        	list($name, $value) = $header;
            if (is_array($value))
                $value = implode(', ', $value);

            $headers[] = "$name: $value";
        }

        return $headers;
    }

    /**
     * Prepare the request body (for POST and PUT requests)
     *
     * @return string
     * @throws Zend_Http_Client_Exception
     */
    protected function _prepareBody()
    {
        // According to RFC2616, a TRACE request should not have a body.
        if ($this->method == self::TRACE) {
            return '';
        }

        // If we have raw_post_data set, just use it as the body.
        if (isset($this->raw_post_data)) {
            $this->setHeaders('Content-length', strlen($this->raw_post_data));
            return $this->raw_post_data;
        }

        $body = '';

        // If we have files to upload, force enctype to multipart/form-data
        if (count ($this->files) > 0) $this->setEncType(self::ENC_FORMDATA);

        // If we have POST parameters or files, encode and add them to the body
        if (count($this->paramsPost) > 0 || count($this->files) > 0) {
            switch($this->enctype) {
                case self::ENC_FORMDATA:
                    // Encode body as multipart/form-data
                    $boundary = '---ZENDHTTPCLIENT-' . md5(microtime());
                    $this->setHeaders('Content-type', self::ENC_FORMDATA . "; boundary={$boundary}");

                    // Get POST parameters and encode them
                    $params = $this->_getParametersRecursive($this->paramsPost);
                    foreach ($params as $pp) {
                        $body .= self::encodeFormData($boundary, $pp[0], $pp[1]);
                    }

                    // Encode files
                    foreach ($this->files as $name => $file) {
                        $fhead = array('Content-type' => $file[1]);
                        $body .= self::encodeFormData($boundary, $name, $file[2], $file[0], $fhead);
                    }

                    $body .= "--{$boundary}--\r\n";
                    break;

                case self::ENC_URLENCODED:
                    // Encode body as application/x-www-form-urlencoded
                    $this->setHeaders('Content-type', self::ENC_URLENCODED);
                    $body = http_build_query($this->paramsPost, '', '&');
                    break;

                default:
                    /** @see Zend_Http_Client_Exception */
                    require_once 'Zend/Http/Client/Exception.php';
                    throw new Zend_Http_Client_Exception("Cannot handle content type '{$this->enctype}' automatically." .
                        " Please use Zend_Http_Client::setRawData to send this kind of content.");
                    break;
            }
        }
        
        // Set the content-length if we have a body or if request is POST/PUT
        if ($body || $this->method == self::POST || $this->method == self::PUT) {
            $this->setHeaders('Content-length', strlen($body));
        }

        return $body;
    }

    /**
     * Helper method that gets a possibly multi-level parameters array (get or
     * post) and flattens it.
     *
     * The method returns an array of (key, value) pairs (because keys are not
     * necessarily unique. If one of the parameters in as array, it will also
     * add a [] suffix to the key.
     *
     * @param array $parray The parameters array
     * @param bool $urlencode Whether to urlencode the name and value
     * @return array
     */
    protected function _getParametersRecursive($parray, $urlencode = false)
    {
        if (! is_array($parray)) return $parray;
        $parameters = array();

        foreach ($parray as $name => $value) {
            if ($urlencode) $name = urlencode($name);

            // If $value is an array, iterate over it
            if (is_array($value)) {
                $name .= ($urlencode ? '%5B%5D' : '[]');
                foreach ($value as $subval) {
                    if ($urlencode) $subval = urlencode($subval);
                    $parameters[] = array($name, $subval);
                }
            } else {
                if ($urlencode) $value = urlencode($value);
                $parameters[] = array($name, $value);
            }
        }

        return $parameters;
    }
    
    /**
     * Attempt to detect the MIME type of a file using available extensions
     * 
     * This method will try to detect the MIME type of a file. If the fileinfo
     * extension is available, it will be used. If not, the mime_magic 
     * extension which is deprected but is still available in many PHP setups
     * will be tried. 
     * 
     * If neither extension is available, the default application/octet-stream
     * MIME type will be returned
     *
     * @param  string $file File path
     * @return string       MIME type
     */
    protected function _detectFileMimeType($file)
    {
        $type = null;
        
        // First try with fileinfo functions
        if (function_exists('finfo_open')) {
            if (self::$_fileInfoDb === null) {
                self::$_fileInfoDb = @finfo_open(FILEINFO_MIME);
            }
            
            if (self::$_fileInfoDb) { 
                $type = finfo_file(self::$_fileInfoDb, $file);
            }
            
        } elseif (function_exists('mime_content_type')) {
            $type = mime_content_type($file);
        }
        
        // Fallback to the default application/octet-stream
        if (! $type) {
            $type = 'application/octet-stream';
        }
        
        return $type;
    }

    /**
     * Encode data to a multipart/form-data part suitable for a POST request.
     *
     * @param string $boundary
     * @param string $name
     * @param mixed $value
     * @param string $filename
     * @param array $headers Associative array of optional headers @example ("Content-transfer-encoding" => "binary")
     * @return string
     */
    public static function encodeFormData($boundary, $name, $value, $filename = null, $headers = array()) {
        $ret = "--{$boundary}\r\n" .
            'Content-disposition: form-data; name="' . $name .'"';

        if ($filename) $ret .= '; filename="' . $filename . '"';
        $ret .= "\r\n";

        foreach ($headers as $hname => $hvalue) {
            $ret .= "{$hname}: {$hvalue}\r\n";
        }
        $ret .= "\r\n";

        $ret .= "{$value}\r\n";

        return $ret;
    }

    /**
     * Create a HTTP authentication "Authorization:" header according to the
     * specified user, password and authentication method.
     *
     * @see http://www.faqs.org/rfcs/rfc2617.html
     * @param string $user
     * @param string $password
     * @param string $type
     * @return string
     * @throws Zend_Http_Client_Exception
     */
    public static function encodeAuthHeader($user, $password, $type = self::AUTH_BASIC)
    {
        $authHeader = null;

        switch ($type) {
            case self::AUTH_BASIC:
                // In basic authentication, the user name cannot contain ":"
                if (strpos($user, ':') !== false) {
                    /** @see Zend_Http_Client_Exception */
                    require_once 'Zend/Http/Client/Exception.php';
                    throw new Zend_Http_Client_Exception("The user name cannot contain ':' in 'Basic' HTTP authentication");
                }

                $authHeader = 'Basic ' . base64_encode($user . ':' . $password);
                break;

            //case self::AUTH_DIGEST:
                /**
                 * @todo Implement digest authentication
                 */
            //    break;

            default:
                /** @see Zend_Http_Client_Exception */
                require_once 'Zend/Http/Client/Exception.php';
                throw new Zend_Http_Client_Exception("Not a supported HTTP authentication type: '$type'");
        }

        return $authHeader;
    }
}
76   12295|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/CookieJar.php|a588fc75<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage CookieJar
 * @version    $Id: CookieJar.php 9098 2008-03-30 19:29:10Z thomas $
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com/)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

require_once "Zend/Uri.php";
require_once "Zend/Http/Cookie.php";
require_once "Zend/Http/Response.php";

/**
 * A Zend_Http_CookieJar object is designed to contain and maintain HTTP cookies, and should
 * be used along with Zend_Http_Client in order to manage cookies across HTTP requests and
 * responses.
 *
 * The class contains an array of Zend_Http_Cookie objects. Cookies can be added to the jar
 * automatically from a request or manually. Then, the jar can find and return the cookies
 * needed for a specific HTTP request.
 *
 * A special parameter can be passed to all methods of this class that return cookies: Cookies
 * can be returned either in their native form (as Zend_Http_Cookie objects) or as strings -
 * the later is suitable for sending as the value of the "Cookie" header in an HTTP request.
 * You can also choose, when returning more than one cookie, whether to get an array of strings
 * (by passing Zend_Http_CookieJar::COOKIE_STRING_ARRAY) or one unified string for all cookies
 * (by passing Zend_Http_CookieJar::COOKIE_STRING_CONCAT).
 *
 * @link       http://wp.netscape.com/newsref/std/cookie_spec.html for some specs.
 * 
 * @category   Zend
 * @package    Zend_Http
 * @subpackage CookieJar
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com/)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Http_CookieJar
{
    /**
     * Return cookie(s) as a Zend_Http_Cookie object
     *
     */
    const COOKIE_OBJECT = 0;

    /**
     * Return cookie(s) as a string (suitable for sending in an HTTP request)
     *
     */
    const COOKIE_STRING_ARRAY = 1;

    /**
     * Return all cookies as one long string (suitable for sending in an HTTP request)
     *
     */
    const COOKIE_STRING_CONCAT = 2;

    /**
     * Array storing cookies
     *
     * Cookies are stored according to domain and path:
     * $cookies
     *  + www.mydomain.com
     *    + /
     *      - cookie1
     *      - cookie2
     *    + /somepath
     *      - othercookie
     *  + www.otherdomain.net
     *    + /
     *      - alsocookie
     *
     * @var array
     */
    protected $cookies = array();

    /**
     * Construct a new CookieJar object
     *
     */
    public function __construct()
    { }

    /**
     * Add a cookie to the jar. Cookie should be passed either as a Zend_Http_Cookie object
     * or as a string - in which case an object is created from the string.
     *
     * @param Zend_Http_Cookie|string $cookie
     * @param Zend_Uri_Http|string    $ref_uri Optional reference URI (for domain, path, secure)
     */
    public function addCookie($cookie, $ref_uri = null)
    {
        if (is_string($cookie)) {
            $cookie = Zend_Http_Cookie::fromString($cookie, $ref_uri);
        }

        if ($cookie instanceof Zend_Http_Cookie) {
            $domain = $cookie->getDomain();
            $path = $cookie->getPath();
            if (! isset($this->cookies[$domain])) $this->cookies[$domain] = array();
            if (! isset($this->cookies[$domain][$path])) $this->cookies[$domain][$path] = array();
            $this->cookies[$domain][$path][$cookie->getName()] = $cookie;
        } else {
            require_once 'Zend/Http/Exception.php';
            throw new Zend_Http_Exception('Supplient argument is not a valid cookie string or object');
        }
    }

    /**
     * Parse an HTTP response, adding all the cookies set in that response
     * to the cookie jar.
     *
     * @param Zend_Http_Response $response
     * @param Zend_Uri_Http|string $ref_uri Requested URI
     */
    public function addCookiesFromResponse($response, $ref_uri)
    {
        if (! $response instanceof Zend_Http_Response) {
            require_once 'Zend/Http/Exception.php';        
            throw new Zend_Http_Exception('$response is expected to be a Response object, ' .
                gettype($response) . ' was passed');
        }

        $cookie_hdrs = $response->getHeader('Set-Cookie');

        if (is_array($cookie_hdrs)) {
            foreach ($cookie_hdrs as $cookie) {
                $this->addCookie($cookie, $ref_uri);
            }
        } elseif (is_string($cookie_hdrs)) {
            $this->addCookie($cookie_hdrs, $ref_uri);
        }
    }

    /**
     * Get all cookies in the cookie jar as an array
     *
     * @param int $ret_as Whether to return cookies as objects of Zend_Http_Cookie or as strings
     * @return array|string
     */
    public function getAllCookies($ret_as = self::COOKIE_OBJECT)
    {
        $cookies = $this->_flattenCookiesArray($this->cookies, $ret_as);
        return $cookies;
    }

    /**
     * Return an array of all cookies matching a specific request according to the request URI,
     * whether session cookies should be sent or not, and the time to consider as "now" when
     * checking cookie expiry time.
     *
     * @param string|Zend_Uri_Http $uri URI to check against (secure, domain, path)
     * @param boolean $matchSessionCookies Whether to send session cookies
     * @param int $ret_as Whether to return cookies as objects of Zend_Http_Cookie or as strings
     * @param int $now Override the current time when checking for expiry time
     * @return array|string
     */
    public function getMatchingCookies($uri, $matchSessionCookies = true,
        $ret_as = self::COOKIE_OBJECT, $now = null)
    {
        if (is_string($uri)) $uri = Zend_Uri::factory($uri);
        if (! $uri instanceof Zend_Uri_Http) {
            require_once 'Zend/Http/Exception.php';    
            throw new Zend_Http_Exception("Invalid URI string or object passed");
        }

        // Set path
        $path = $uri->getPath();
        $path = substr($path, 0, strrpos($path, '/'));
        if (! $path) $path = '/';

        // First, reduce the array of cookies to only those matching domain and path
        $cookies = $this->_matchDomain($uri->getHost());
        $cookies = $this->_matchPath($cookies, $path);
        $cookies = $this->_flattenCookiesArray($cookies, self::COOKIE_OBJECT);

        // Next, run Cookie->match on all cookies to check secure, time and session mathcing
        $ret = array();
        foreach ($cookies as $cookie)
            if ($cookie->match($uri, $matchSessionCookies, $now))
                $ret[] = $cookie;

        // Now, use self::_flattenCookiesArray again - only to convert to the return format ;)
        $ret = $this->_flattenCookiesArray($ret, $ret_as);

        return $ret;
    }

    /**
     * Get a specific cookie according to a URI and name
     *
     * @param Zend_Uri_Http|string $uri The uri (domain and path) to match
     * @param string $cookie_name The cookie's name
     * @param int $ret_as Whether to return cookies as objects of Zend_Http_Cookie or as strings
     * @return Zend_Http_Cookie|string
     */
    public function getCookie($uri, $cookie_name, $ret_as = self::COOKIE_OBJECT)
    {
        if (is_string($uri)) {
            $uri = Zend_Uri::factory($uri);
        }

        if (! $uri instanceof Zend_Uri_Http) {
            require_once 'Zend/Http/Exception.php';
            throw new Zend_Http_Exception('Invalid URI specified');
        }

        // Get correct cookie path
        $path = $uri->getPath();
        $path = substr($path, 0, strrpos($path, '/'));
        if (! $path) $path = '/';

        if (isset($this->cookies[$uri->getHost()][$path][$cookie_name])) {
            $cookie = $this->cookies[$uri->getHost()][$path][$cookie_name];

            switch ($ret_as) {
                case self::COOKIE_OBJECT:
                    return $cookie;
                    break;

                case self::COOKIE_STRING_ARRAY:
                case self::COOKIE_STRING_CONCAT:
                    return $cookie->__toString();
                    break;

                default:
                    require_once 'Zend/Http/Exception.php';
                    throw new Zend_Http_Exception("Invalid value passed for \$ret_as: {$ret_as}");
                    break;
            }
        } else {
            return false;
        }
    }

    /**
     * Helper function to recursivly flatten an array. Shoud be used when exporting the
     * cookies array (or parts of it)
     *
     * @param Zend_Http_Cookie|array $ptr
     * @param int $ret_as What value to return
     * @return array|string
     */
    protected function _flattenCookiesArray($ptr, $ret_as = self::COOKIE_OBJECT) {
        if (is_array($ptr)) {
            $ret = ($ret_as == self::COOKIE_STRING_CONCAT ? '' : array());
            foreach ($ptr as $item) {
                if ($ret_as == self::COOKIE_STRING_CONCAT) {
                    $ret .= $this->_flattenCookiesArray($item, $ret_as);
                } else {
                    $ret = array_merge($ret, $this->_flattenCookiesArray($item, $ret_as));
                }
            }
            return $ret;
        } elseif ($ptr instanceof Zend_Http_Cookie) {
            switch ($ret_as) {
                case self::COOKIE_STRING_ARRAY:
                    return array($ptr->__toString());
                    break;

                case self::COOKIE_STRING_CONCAT:
                    return $ptr->__toString();
                    break;

                case self::COOKIE_OBJECT:
                default:
                    return array($ptr);
                    break;
            }
        }

        return null;
    }

    /**
     * Return a subset of the cookies array matching a specific domain
     *
     * Returned array is actually an array of pointers to items in the $this->cookies array.
     *
     * @param string $domain
     * @return array
     */
    protected function _matchDomain($domain) {
        $ret = array();

        foreach (array_keys($this->cookies) as $cdom) {
            $regex = "/" . preg_quote($cdom, "/") . "$/i";
            if (preg_match($regex, $domain)) $ret[$cdom] = &$this->cookies[$cdom];
        }

        return $ret;
    }

    /**
     * Return a subset of a domain-matching cookies that also match a specified path
     *
     * Returned array is actually an array of pointers to items in the $passed array.
     *
     * @param array $dom_array
     * @param string $path
     * @return array
     */
    protected function _matchPath($domains, $path) {
        $ret = array();
        if (substr($path, -1) != '/') $path .= '/';

        foreach ($domains as $dom => $paths_array) {
            foreach (array_keys($paths_array) as $cpath) {
                $regex = "|^" . preg_quote($cpath, "|") . "|i";
                if (preg_match($regex, $path)) {
                    if (! isset($ret[$dom])) $ret[$dom] = array();
                    $ret[$dom][$cpath] = &$paths_array[$cpath];
                }
            }
        }

        return $ret;
    }

    /**
     * Create a new CookieJar object and automatically load into it all the
     * cookies set in an Http_Response object. If $uri is set, it will be
     * considered as the requested URI for setting default domain and path
     * of the cookie.
     *
     * @param Zend_Http_Response $response HTTP Response object
     * @param Zend_Uri_Http|string $uri The requested URI
     * @return Zend_Http_CookieJar
     * @todo Add the $uri functionality.
     */
    public static function fromResponse(Zend_Http_Response $response, $ref_uri)
    {
        $jar = new self();
        $jar->addCookiesFromResponse($response, $ref_uri);
        return $jar;
    }
}
72   9219|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/Cookie.php|b98d8d95<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Cookie
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com/)
 * @version    $Id: Cookie.php 9098 2008-03-30 19:29:10Z thomas $
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

require_once 'Zend/Uri/Http.php';

/**
 * Zend_Http_Cookie is a class describing an HTTP cookie and all it's parameters.
 *
 * Zend_Http_Cookie is a class describing an HTTP cookie and all it's parameters. The
 * class also enables validating whether the cookie should be sent to the server in
 * a specified scenario according to the request URI, the expiry time and whether
 * session cookies should be used or not. Generally speaking cookies should be
 * contained in a Cookiejar object, or instantiated manually and added to an HTTP
 * request.
 *
 * See http://wp.netscape.com/newsref/std/cookie_spec.html for some specs.
 *
 * @category    Zend
 * @package     Zend_Http
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com/)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Http_Cookie
{
    /**
     * Cookie name
     *
     * @var string
     */
    protected $name;

    /**
     * Cookie value
     *
     * @var string
     */
    protected $value;

    /**
     * Cookie expiry date
     *
     * @var int
     */
    protected $expires;

    /**
     * Cookie domain
     *
     * @var string
     */
    protected $domain;

    /**
     * Cookie path
     *
     * @var string
     */
    protected $path;

    /**
     * Whether the cookie is secure or not
     *
     * @var boolean
     */
    protected $secure;

    /**
     * Cookie object constructor
     *
     * @todo Add validation of each one of the parameters (legal domain, etc.)
     *
     * @param string $name
     * @param string $value
     * @param int $expires
     * @param string $domain
     * @param string $path
     * @param bool $secure
     */
    public function __construct($name, $value, $domain, $expires = null, $path = null, $secure = false)
    {
        if (preg_match("/[=,; \t\r\n\013\014]/", $name)) {
            require_once 'Zend/Http/Exception.php';
            throw new Zend_Http_Exception("Cookie name cannot contain these characters: =,; \\t\\r\\n\\013\\014 ({$name})");
        }

        if (! $this->name = (string) $name) {
            require_once 'Zend/Http/Exception.php';
            throw new Zend_Http_Exception('Cookies must have a name');
        }

        if (! $this->domain = (string) $domain) {
            require_once 'Zend/Http/Exception.php';
            throw new Zend_Http_Exception('Cookies must have a domain');
        }

        $this->value = (string) $value;
        $this->expires = ($expires === null ? null : (int) $expires);
        $this->path = ($path ? $path : '/');
        $this->secure = $secure;
    }

    /**
     * Get Cookie name
     *
     * @return string
     */
    public function getName()
    {
        return $this->name;
    }

    /**
     * Get cookie value
     *
     * @return string
     */
    public function getValue()
    {
        return $this->value;
    }

    /**
     * Get cookie domain
     *
     * @return string
     */
    public function getDomain()
    {
        return $this->domain;
    }

    /**
     * Get the cookie path
     *
     * @return string
     */
    public function getPath()
    {
        return $this->path;
    }

    /**
     * Get the expiry time of the cookie, or null if no expiry time is set
     *
     * @return int|null
     */
    public function getExpiryTime()
    {
        return $this->expires;
    }

    /**
     * Check whether the cookie should only be sent over secure connections
     *
     * @return boolean
     */
    public function isSecure()
    {
        return $this->secure;
    }

    /**
     * Check whether the cookie has expired
     *
     * Always returns false if the cookie is a session cookie (has no expiry time)
     *
     * @param int $now Timestamp to consider as "now"
     * @return boolean
     */
    public function isExpired($now = null)
    {
        if ($now === null) $now = time();
        if (is_int($this->expires) && $this->expires < $now) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * Check whether the cookie is a session cookie (has no expiry time set)
     *
     * @return boolean
     */
    public function isSessionCookie()
    {
        return ($this->expires === null);
    }

    /**
     * Checks whether the cookie should be sent or not in a specific scenario
     *
     * @param string|Zend_Uri_Http $uri URI to check against (secure, domain, path)
     * @param boolean $matchSessionCookies Whether to send session cookies
     * @param int $now Override the current time when checking for expiry time
     * @return boolean
     */
    public function match($uri, $matchSessionCookies = true, $now = null)
    {
        if (is_string ($uri)) {
            $uri = Zend_Uri_Http::factory($uri);
        }

        // Make sure we have a valid Zend_Uri_Http object
        if (! ($uri->valid() && ($uri->getScheme() == 'http' || $uri->getScheme() =='https'))) {
            require_once 'Zend/Http/Exception.php';    
            throw new Zend_Http_Exception('Passed URI is not a valid HTTP or HTTPS URI');
        }

        // Check that the cookie is secure (if required) and not expired
        if ($this->secure && $uri->getScheme() != 'https') return false;
        if ($this->isExpired($now)) return false;
        if ($this->isSessionCookie() && ! $matchSessionCookies) return false;

        // Validate domain and path
        // Domain is validated using tail match, while path is validated using head match
        $domain_preg = preg_quote($this->getDomain(), "/");
        if (! preg_match("/{$domain_preg}$/", $uri->getHost())) return false;
        $path_preg = preg_quote($this->getPath(), "/");
        if (! preg_match("/^{$path_preg}/", $uri->getPath())) return false;

        // If we didn't die until now, return true.
        return true;
    }

    /**
     * Get the cookie as a string, suitable for sending as a "Cookie" header in an
     * HTTP request
     *
     * @return string
     */
    public function __toString()
    {
        return $this->name . '=' . urlencode($this->value) . ';';
    }

    /**
     * Generate a new Cookie object from a cookie string
     * (for example the value of the Set-Cookie HTTP header)
     *
     * @param string $cookieStr
     * @param Zend_Uri_Http|string $ref_uri Reference URI for default values (domain, path)
     * @return Zend_Http_Cookie A new Zend_Http_Cookie object or false on failure.
     */
    public static function fromString($cookieStr, $ref_uri = null)
    {
        // Set default values
        if (is_string($ref_uri)) {
            $ref_uri = Zend_Uri_Http::factory($ref_uri);
        }

        $name    = '';
        $value   = '';
        $domain  = '';
        $path    = '';
        $expires = null;
        $secure  = false;
        $parts   = explode(';', $cookieStr);

        // If first part does not include '=', fail
        if (strpos($parts[0], '=') === false) return false;

        // Get the name and value of the cookie
        list($name, $value) = explode('=', trim(array_shift($parts)), 2);
        $name  = trim($name);
        $value = urldecode(trim($value));

        // Set default domain and path
        if ($ref_uri instanceof Zend_Uri_Http) {
            $domain = $ref_uri->getHost();
            $path = $ref_uri->getPath();
            $path = substr($path, 0, strrpos($path, '/'));
        }

        // Set other cookie parameters
        foreach ($parts as $part) {
            $part = trim($part);
            if (strtolower($part) == 'secure') {
                $secure = true;
                continue;
            }

            $keyValue = explode('=', $part, 2);
            if (count($keyValue) == 2) {
                list($k, $v) = $keyValue;
                switch (strtolower($k))    {
                    case 'expires':
                        $expires = strtotime($v);
                        break;
                    case 'path':
                        $path = $v;
                        break;
                    case 'domain':
                        $domain = $v;
                        break;
                    default:
                        break;
                }
            }
        }

        if ($name !== '') {
            return new Zend_Http_Cookie($name, $value, $domain, $expires, $path, $secure);
        } else {
            return false;
        }
    }
}
75   1100|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/Exception.php|804d6a2f<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Exception
 * @version    $Id: Exception.php 8064 2008-02-16 10:58:39Z thomas $
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

require_once 'Zend/Exception.php';

/**
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Http_Exception extends Zend_Exception
{}
75   17281|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/Response.php|f0ae3347<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Response
 * @version    $Id: Response.php 11175 2008-09-01 08:39:10Z yoshida@zend.co.jp $
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

/**
 * Zend_Http_Response represents an HTTP 1.0 / 1.1 response message. It
 * includes easy access to all the response's different elemts, as well as some
 * convenience methods for parsing and validating HTTP responses.
 *
 * @package    Zend_Http
 * @subpackage Response
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Http_Response
{
    /**
     * List of all known HTTP response codes - used by responseCodeAsText() to
     * translate numeric codes to messages.
     *
     * @var array
     */
    protected static $messages = array(
        // Informational 1xx
        100 => 'Continue',
        101 => 'Switching Protocols',

        // Success 2xx
        200 => 'OK',
        201 => 'Created',
        202 => 'Accepted',
        203 => 'Non-Authoritative Information',
        204 => 'No Content',
        205 => 'Reset Content',
        206 => 'Partial Content',

        // Redirection 3xx
        300 => 'Multiple Choices',
        301 => 'Moved Permanently',
        302 => 'Found',  // 1.1
        303 => 'See Other',
        304 => 'Not Modified',
        305 => 'Use Proxy',
        // 306 is deprecated but reserved
        307 => 'Temporary Redirect',

        // Client Error 4xx
        400 => 'Bad Request',
        401 => 'Unauthorized',
        402 => 'Payment Required',
        403 => 'Forbidden',
        404 => 'Not Found',
        405 => 'Method Not Allowed',
        406 => 'Not Acceptable',
        407 => 'Proxy Authentication Required',
        408 => 'Request Timeout',
        409 => 'Conflict',
        410 => 'Gone',
        411 => 'Length Required',
        412 => 'Precondition Failed',
        413 => 'Request Entity Too Large',
        414 => 'Request-URI Too Long',
        415 => 'Unsupported Media Type',
        416 => 'Requested Range Not Satisfiable',
        417 => 'Expectation Failed',

        // Server Error 5xx
        500 => 'Internal Server Error',
        501 => 'Not Implemented',
        502 => 'Bad Gateway',
        503 => 'Service Unavailable',
        504 => 'Gateway Timeout',
        505 => 'HTTP Version Not Supported',
        509 => 'Bandwidth Limit Exceeded'
    );

    /**
     * The HTTP version (1.0, 1.1)
     *
     * @var string
     */
    protected $version;

    /**
     * The HTTP response code
     *
     * @var int
     */
    protected $code;

    /**
     * The HTTP response code as string
     * (e.g. 'Not Found' for 404 or 'Internal Server Error' for 500)
     *
     * @var string
     */
    protected $message;

    /**
     * The HTTP response headers array
     *
     * @var array
     */
    protected $headers = array();

    /**
     * The HTTP response body
     *
     * @var string
     */
    protected $body;

    /**
     * HTTP response constructor
     *
     * In most cases, you would use Zend_Http_Response::fromString to parse an HTTP
     * response string and create a new Zend_Http_Response object.
     *
     * NOTE: The constructor no longer accepts nulls or empty values for the code and
     * headers and will throw an exception if the passed values do not form a valid HTTP
     * responses.
     *
     * If no message is passed, the message will be guessed according to the response code.
     *
     * @param int $code Response code (200, 404, ...)
     * @param array $headers Headers array
     * @param string $body Response body
     * @param string $version HTTP version
     * @param string $message Response code as text
     * @throws Zend_Http_Exception
     */
    public function __construct($code, $headers, $body = null, $version = '1.1', $message = null)
    {
        // Make sure the response code is valid and set it
        if (self::responseCodeAsText($code) === null) {
            require_once 'Zend/Http/Exception.php';
            throw new Zend_Http_Exception("{$code} is not a valid HTTP response code");
        }

        $this->code = $code;

        // Make sure we got valid headers and set them
        if (! is_array($headers)) {
            require_once 'Zend/Http/Exception.php';
            throw new Zend_Http_Exception('No valid headers were passed');
	}

        foreach ($headers as $name => $value) {
            if (is_int($name))
                list($name, $value) = explode(": ", $value, 1);

            $this->headers[ucwords(strtolower($name))] = $value;
        }

        // Set the body
        $this->body = $body;

        // Set the HTTP version
        if (! preg_match('|^\d\.\d$|', $version)) {
            require_once 'Zend/Http/Exception.php';
            throw new Zend_Http_Exception("Invalid HTTP response version: $version");
        }

        $this->version = $version;

        // If we got the response message, set it. Else, set it according to
        // the response code
        if (is_string($message)) {
            $this->message = $message;
        } else {
            $this->message = self::responseCodeAsText($code);
        }
    }

    /**
     * Check whether the response is an error
     *
     * @return boolean
     */
    public function isError()
    {
        $restype = floor($this->code / 100);
        if ($restype == 4 || $restype == 5) {
            return true;
        }

        return false;
    }

    /**
     * Check whether the response in successful
     *
     * @return boolean
     */
    public function isSuccessful()
    {
        $restype = floor($this->code / 100);
        if ($restype == 2 || $restype == 1) { // Shouldn't 3xx count as success as well ???
            return true;
        }

        return false;
    }

    /**
     * Check whether the response is a redirection
     *
     * @return boolean
     */
    public function isRedirect()
    {
        $restype = floor($this->code / 100);
        if ($restype == 3) {
            return true;
        }

        return false;
    }

    /**
     * Get the response body as string
     *
     * This method returns the body of the HTTP response (the content), as it
     * should be in it's readable version - that is, after decoding it (if it
     * was decoded), deflating it (if it was gzip compressed), etc.
     *
     * If you want to get the raw body (as transfered on wire) use
     * $this->getRawBody() instead.
     *
     * @return string
     */
    public function getBody()
    {
        $body = '';

        // Decode the body if it was transfer-encoded
        switch ($this->getHeader('transfer-encoding')) {

            // Handle chunked body
            case 'chunked':
                $body = self::decodeChunkedBody($this->body);
                break;

            // No transfer encoding, or unknown encoding extension:
            // return body as is
            default:
                $body = $this->body;
                break;
        }

        // Decode any content-encoding (gzip or deflate) if needed
        switch (strtolower($this->getHeader('content-encoding'))) {

            // Handle gzip encoding
            case 'gzip':
                $body = self::decodeGzip($body);
                break;

            // Handle deflate encoding
            case 'deflate':
                $body = self::decodeDeflate($body);
                break;

            default:
                break;
        }

        return $body;
    }

    /**
     * Get the raw response body (as transfered "on wire") as string
     *
     * If the body is encoded (with Transfer-Encoding, not content-encoding -
     * IE "chunked" body), gzip compressed, etc. it will not be decoded.
     *
     * @return string
     */
    public function getRawBody()
    {
        return $this->body;
    }

    /**
     * Get the HTTP version of the response
     *
     * @return string
     */
    public function getVersion()
    {
        return $this->version;
    }

    /**
     * Get the HTTP response status code
     *
     * @return int
     */
    public function getStatus()
    {
        return $this->code;
    }

    /**
     * Return a message describing the HTTP response code
     * (Eg. "OK", "Not Found", "Moved Permanently")
     *
     * @return string
     */
    public function getMessage()
    {
        return $this->message;
    }

    /**
     * Get the response headers
     *
     * @return array
     */
    public function getHeaders()
    {
        return $this->headers;
    }

    /**
     * Get a specific header as string, or null if it is not set
     *
     * @param string$header
     * @return string|array|null
     */
    public function getHeader($header)
    {
        $header = ucwords(strtolower($header));
        if (! is_string($header) || ! isset($this->headers[$header])) return null;

        return $this->headers[$header];
    }

    /**
     * Get all headers as string
     *
     * @param boolean $status_line Whether to return the first status line (IE "HTTP 200 OK")
     * @param string $br Line breaks (eg. "\n", "\r\n", "<br />")
     * @return string
     */
    public function getHeadersAsString($status_line = true, $br = "\n")
    {
        $str = '';

        if ($status_line) {
            $str = "HTTP/{$this->version} {$this->code} {$this->message}{$br}";
        }

        // Iterate over the headers and stringify them
        foreach ($this->headers as $name => $value)
        {
            if (is_string($value))
                $str .= "{$name}: {$value}{$br}";

            elseif (is_array($value)) {
                foreach ($value as $subval) {
                    $str .= "{$name}: {$subval}{$br}";
                }
            }
        }

        return $str;
    }

    /**
     * Get the entire response as string
     *
     * @param string $br Line breaks (eg. "\n", "\r\n", "<br />")
     * @return string
     */
    public function asString($br = "\n")
    {
        return $this->getHeadersAsString(true, $br) . $br . $this->getRawBody();
    }

    /**
     * A convenience function that returns a text representation of
     * HTTP response codes. Returns 'Unknown' for unknown codes.
     * Returns array of all codes, if $code is not specified.
     *
     * Conforms to HTTP/1.1 as defined in RFC 2616 (except for 'Unknown')
     * See http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10 for reference
     *
     * @param int $code HTTP response code
     * @param boolean $http11 Use HTTP version 1.1
     * @return string
     */
    public static function responseCodeAsText($code = null, $http11 = true)
    {
        $messages = self::$messages;
        if (! $http11) $messages[302] = 'Moved Temporarily';

        if ($code === null) {
            return $messages;
        } elseif (isset($messages[$code])) {
            return $messages[$code];
        } else {
            return 'Unknown';
        }
    }

    /**
     * Extract the response code from a response string
     *
     * @param string $response_str
     * @return int
     */
    public static function extractCode($response_str)
    {
        preg_match("|^HTTP/[\d\.x]+ (\d+)|", $response_str, $m);

        if (isset($m[1])) {
            return (int) $m[1];
        } else {
            return false;
        }
    }

    /**
     * Extract the HTTP message from a response
     *
     * @param string $response_str
     * @return string
     */
    public static function extractMessage($response_str)
    {
        preg_match("|^HTTP/[\d\.x]+ \d+ ([^\r\n]+)|", $response_str, $m);

        if (isset($m[1])) {
            return $m[1];
        } else {
            return false;
        }
    }

    /**
     * Extract the HTTP version from a response
     *
     * @param string $response_str
     * @return string
     */
    public static function extractVersion($response_str)
    {
        preg_match("|^HTTP/([\d\.x]+) \d+|", $response_str, $m);

        if (isset($m[1])) {
            return $m[1];
        } else {
            return false;
        }
    }

    /**
     * Extract the headers from a response string
     *
     * @param string $response_str
     * @return array
     */
    public static function extractHeaders($response_str)
    {
        $headers = array();
        
        // First, split body and headers
        $parts = preg_split('|(?:\r?\n){2}|m', $response_str, 2);
        if (! $parts[0]) return $headers;
        
        // Split headers part to lines
        $lines = explode("\n", $parts[0]);
        unset($parts);
        $last_header = null;

        foreach($lines as $line) {
            $line = trim($line, "\r\n");
            if ($line == "") break;

            if (preg_match("|^([\w-]+):\s+(.+)|", $line, $m)) {
                unset($last_header);
                $h_name = strtolower($m[1]);
                $h_value = $m[2];

                if (isset($headers[$h_name])) {
                    if (! is_array($headers[$h_name])) {
                        $headers[$h_name] = array($headers[$h_name]);
                    }

                    $headers[$h_name][] = $h_value;
                } else {
                    $headers[$h_name] = $h_value;
                }
                $last_header = $h_name;
            } elseif (preg_match("|^\s+(.+)$|", $line, $m) && $last_header !== null) {
                if (is_array($headers[$last_header])) {
                    end($headers[$last_header]);
                    $last_header_key = key($headers[$last_header]);
                    $headers[$last_header][$last_header_key] .= $m[1];
                } else {
                    $headers[$last_header] .= $m[1];
                }
            }
        }

        return $headers;
    }

    /**
     * Extract the body from a response string
     *
     * @param string $response_str
     * @return string
     */
    public static function extractBody($response_str)
    {
        $parts = preg_split('|(?:\r?\n){2}|m', $response_str, 2);
        if (isset($parts[1])) { 
        	return $parts[1];
        } else {
        	return '';
        }
    }

    /**
     * Decode a "chunked" transfer-encoded body and return the decoded text
     *
     * @param string $body
     * @return string
     */
    public static function decodeChunkedBody($body)
    {
        $decBody = '';
        
        while (trim($body)) {
            if (! preg_match("/^([\da-fA-F]+)[^\r\n]*\r\n/sm", $body, $m)) {
                require_once 'Zend/Http/Exception.php';
                throw new Zend_Http_Exception("Error parsing body - doesn't seem to be a chunked message");
            }

            $length = hexdec(trim($m[1]));
            $cut = strlen($m[0]);

            $decBody .= substr($body, $cut, $length);
            $body = substr($body, $cut + $length + 2);
        }

        return $decBody;
    }

    /**
     * Decode a gzip encoded message (when Content-encoding = gzip)
     *
     * Currently requires PHP with zlib support
     *
     * @param string $body
     * @return string
     */
    public static function decodeGzip($body)
    {
        if (! function_exists('gzinflate')) {
            require_once 'Zend/Http/Exception.php';
            throw new Zend_Http_Exception('Unable to decode gzipped response ' . 
                'body: perhaps the zlib extension is not loaded?'); 
        }

        return gzinflate(substr($body, 10));
    }

    /**
     * Decode a zlib deflated message (when Content-encoding = deflate)
     *
     * Currently requires PHP with zlib support
     *
     * @param string $body
     * @return string
     */
    public static function decodeDeflate($body)
    {
        if (! function_exists('gzuncompress')) {
            require_once 'Zend/Http/Exception.php';
            throw new Zend_Http_Exception('Unable to decode deflated response ' . 
                'body: perhaps the zlib extension is not loaded?'); 
        }

    	return gzuncompress($body);
    }

    /**
     * Create a new Zend_Http_Response object from a string
     *
     * @param string $response_str
     * @return Zend_Http_Response
     */
    public static function fromString($response_str)
    {
        $code    = self::extractCode($response_str);
        $headers = self::extractHeaders($response_str);
        $body    = self::extractBody($response_str);
        $version = self::extractVersion($response_str);
        $message = self::extractMessage($response_str);

        return new Zend_Http_Response($code, $headers, $body, $version, $message);
    }
}
82   1124|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/Client/Exception.php|97b32200<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Exception
 * @version    $Id: Exception.php 8064 2008-02-16 10:58:39Z thomas $
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

require_once 'Zend/Http/Exception.php';

/**
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Http_Client_Exception extends Zend_Http_Exception
{}
89   2242|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/Client/Adapter/Interface.php|ab1ffe4<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Adapter
 * @version    $Id: Interface.php 8064 2008-02-16 10:58:39Z thomas $
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

/**
 * An interface description for Zend_Http_Client_Adapter classes.
 *
 * These classes are used as connectors for Zend_Http_Client, performing the
 * tasks of connecting, writing, reading and closing connection to the server.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Adapter
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
interface Zend_Http_Client_Adapter_Interface
{
    /**
     * Set the configuration array for the adapter
     *
     * @param array $config
     */
    public function setConfig($config = array());

    /**
     * Connect to the remote server
     *
     * @param string  $host
     * @param int     $port
     * @param boolean $secure
     */
    public function connect($host, $port = 80, $secure = false);

    /**
     * Send request to the remote server
     *
     * @param string        $method
     * @param Zend_Uri_Http $url
     * @param string        $http_ver
     * @param array         $headers
     * @param string        $body
     * @return string Request as text
     */
    public function write($method, $url, $http_ver = '1.1', $headers = array(), $body = '');

    /**
     * Read response from server
     *
     * @return string
     */
    public function read();

    /**
     * Close the connection to the server
     *
     */
    public function close();
}
88   11724|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/Client/Adapter/Socket.php|90fca811<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Adapter
 * @version    $Id: Socket.php 9870 2008-07-02 07:28:04Z shahar $
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

require_once 'Zend/Uri/Http.php';
require_once 'Zend/Http/Client/Adapter/Interface.php';

/**
 * A sockets based (stream_socket_client) adapter class for Zend_Http_Client. Can be used
 * on almost every PHP environment, and does not require any special extensions.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Adapter
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Http_Client_Adapter_Socket implements Zend_Http_Client_Adapter_Interface
{
    /**
     * The socket for server connection
     *
     * @var resource|null
     */
    protected $socket = null;

    /**
     * What host/port are we connected to?
     *
     * @var array
     */
    protected $connected_to = array(null, null);

    /**
     * Parameters array
     *
     * @var array
     */
    protected $config = array(
        'persistent'    => false,
        'ssltransport'  => 'ssl',
        'sslcert'       => null,
        'sslpassphrase' => null
    );

    /**
     * Request method - will be set by write() and might be used by read()
     *
     * @var string
     */
    protected $method = null;

    /**
     * Adapter constructor, currently empty. Config is set using setConfig()
     *
     */
    public function __construct()
    {
    }

    /**
     * Set the configuration array for the adapter
     *
     * @param array $config
     */
    public function setConfig($config = array())
    {
        if (! is_array($config)) {
            require_once 'Zend/Http/Client/Adapter/Exception.php';
            throw new Zend_Http_Client_Adapter_Exception(
                '$config expects an array, ' . gettype($config) . ' recieved.');
        }

        foreach ($config as $k => $v) {
            $this->config[strtolower($k)] = $v;
        }
    }

    /**
     * Connect to the remote server
     *
     * @param string  $host
     * @param int     $port
     * @param boolean $secure
     * @param int     $timeout
     */
    public function connect($host, $port = 80, $secure = false)
    {
        // If the URI should be accessed via SSL, prepend the Hostname with ssl://
        $host = ($secure ? $this->config['ssltransport'] : 'tcp') . '://' . $host;

        // If we are connected to the wrong host, disconnect first
        if (($this->connected_to[0] != $host || $this->connected_to[1] != $port)) {
            if (is_resource($this->socket)) $this->close();
        }

        // Now, if we are not connected, connect
        if (! is_resource($this->socket) || ! $this->config['keepalive']) {
            $context = stream_context_create();
            if ($secure) {
                if ($this->config['sslcert'] !== null) {
                    if (! stream_context_set_option($context, 'ssl', 'local_cert',
                                                    $this->config['sslcert'])) {
                        require_once 'Zend/Http/Client/Adapter/Exception.php';
                        throw new Zend_Http_Client_Adapter_Exception('Unable to set sslcert option');
                    }
                }
                if ($this->config['sslpassphrase'] !== null) {
                    if (! stream_context_set_option($context, 'ssl', 'passphrase',
                                                    $this->config['sslpassphrase'])) {
                        require_once 'Zend/Http/Client/Adapter/Exception.php';
                        throw new Zend_Http_Client_Adapter_Exception('Unable to set sslpassphrase option');
                    }
                }
            }

            $flags = STREAM_CLIENT_CONNECT;
            if ($this->config['persistent']) $flags |= STREAM_CLIENT_PERSISTENT;
            
            $this->socket = @stream_socket_client($host . ':' . $port,
                                                  $errno,
                                                  $errstr,
                                                  (int) $this->config['timeout'],
                                                  $flags,
                                                  $context);
            if (! $this->socket) {
                $this->close();
                require_once 'Zend/Http/Client/Adapter/Exception.php';
                throw new Zend_Http_Client_Adapter_Exception(
                    'Unable to Connect to ' . $host . ':' . $port . '. Error #' . $errno . ': ' . $errstr);
            }

            // Set the stream timeout
            if (! stream_set_timeout($this->socket, (int) $this->config['timeout'])) {
                require_once 'Zend/Http/Client/Adapter/Exception.php';
                throw new Zend_Http_Client_Adapter_Exception('Unable to set the connection timeout');
            }

            // Update connected_to
            $this->connected_to = array($host, $port);
        }
    }

    /**
     * Send request to the remote server
     *
     * @param string        $method
     * @param Zend_Uri_Http $uri
     * @param string        $http_ver
     * @param array         $headers
     * @param string        $body
     * @return string Request as string
     */
    public function write($method, $uri, $http_ver = '1.1', $headers = array(), $body = '')
    {
        // Make sure we're properly connected
        if (! $this->socket) {
            require_once 'Zend/Http/Client/Adapter/Exception.php';
            throw new Zend_Http_Client_Adapter_Exception('Trying to write but we are not connected');
        }

        $host = $uri->getHost();
        $host = (strtolower($uri->getScheme()) == 'https' ? $this->config['ssltransport'] : 'tcp') . '://' . $host;
        if ($this->connected_to[0] != $host || $this->connected_to[1] != $uri->getPort()) {
            require_once 'Zend/Http/Client/Adapter/Exception.php';
            throw new Zend_Http_Client_Adapter_Exception('Trying to write but we are connected to the wrong host');
        }

        // Save request method for later
        $this->method = $method;

        // Build request headers
        $path = $uri->getPath();
        if ($uri->getQuery()) $path .= '?' . $uri->getQuery();
        $request = "{$method} {$path} HTTP/{$http_ver}\r\n";
        foreach ($headers as $k => $v) {
            if (is_string($k)) $v = ucfirst($k) . ": $v";
            $request .= "$v\r\n";
        }

        // Add the request body
        $request .= "\r\n" . $body;

        // Send the request
        if (! @fwrite($this->socket, $request)) {
            require_once 'Zend/Http/Client/Adapter/Exception.php';
            throw new Zend_Http_Client_Adapter_Exception('Error writing request to server');
        }

        return $request;
    }

    /**
     * Read response from server
     *
     * @return string
     */
    public function read()
    {
        // First, read headers only
        $response = '';
        $gotStatus = false;
        while ($line = @fgets($this->socket)) {
            $gotStatus = $gotStatus || (strpos($line, 'HTTP') !== false);
            if ($gotStatus) {
                $response .= $line;
                if (!chop($line)) break;
            }
        }

        $statusCode = Zend_Http_Response::extractCode($response);
         
        // Handle 100 and 101 responses internally by restarting the read again
        if ($statusCode == 100 || $statusCode == 101) return $this->read();

        /**
         * Responses to HEAD requests and 204 or 304 responses are not expected
         * to have a body - stop reading here
         */
        if ($statusCode == 304 || $statusCode == 204 || 
            $this->method == Zend_Http_Client::HEAD) return $response;

        // Check headers to see what kind of connection / transfer encoding we have
        $headers = Zend_Http_Response::extractHeaders($response);

        // if the connection is set to close, just read until socket closes
        if (isset($headers['connection']) && $headers['connection'] == 'close') {
            while ($buff = @fread($this->socket, 8192)) {
                $response .= $buff;
            }

            $this->close();

        // Else, if we got a transfer-encoding header (chunked body)
        } elseif (isset($headers['transfer-encoding'])) {
            if ($headers['transfer-encoding'] == 'chunked') {
                do {
                    $chunk = '';
                    $line = @fgets($this->socket);
                    $chunk .= $line;

                    $hexchunksize = ltrim(chop($line), '0');
                    $hexchunksize = strlen($hexchunksize) ? strtolower($hexchunksize) : 0;

                    $chunksize = hexdec(chop($line));
                    if (dechex($chunksize) != $hexchunksize) {
                        @fclose($this->socket);
                        require_once 'Zend/Http/Client/Adapter/Exception.php';
                        throw new Zend_Http_Client_Adapter_Exception('Invalid chunk size "' .
                            $hexchunksize . '" unable to read chunked body');
                    }

                    $left_to_read = $chunksize;
                    while ($left_to_read > 0) {
                        $line = @fread($this->socket, $left_to_read);
                        $chunk .= $line;
                        $left_to_read -= strlen($line);
                    }

                    $chunk .= @fgets($this->socket);
                    $response .= $chunk;
                } while ($chunksize > 0);
            } else {
                throw new Zend_Http_Client_Adapter_Exception('Cannot handle "' .
                    $headers['transfer-encoding'] . '" transfer encoding');
            }

        // Else, if we got the content-length header, read this number of bytes
        } elseif (isset($headers['content-length'])) {
            $left_to_read = $headers['content-length'];
            $chunk = '';
            while ($left_to_read > 0) {
                $chunk = @fread($this->socket, $left_to_read);
                $left_to_read -= strlen($chunk);
                $response .= $chunk;
            }
        
        // Fallback: just read the response (should not happen)
        } else {
            while ($buff = @fread($this->socket, 8192)) {
                $response .= $buff;
            }

            $this->close();
        }

        return $response;
    }

    /**
     * Close the connection to the server
     *
     */
    public function close()
    {
        if (is_resource($this->socket)) @fclose($this->socket);
        $this->socket = null;
        $this->connected_to = array(null, null);
    }

    /**
     * Destructor: make sure the socket is disconnected 
     * 
     * If we are in persistent TCP mode, will not close the connection
     *
     */
    public function __destruct()
    {
        if (! $this->config['persistent']) {
            if ($this->socket) $this->close();
        }
    }
}
90   1162|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/Client/Adapter/Exception.php|26fe0dfb<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Adapter_Exception
 * @version    $Id: Exception.php 8064 2008-02-16 10:58:39Z thomas $
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

require_once 'Zend/Http/Client/Exception.php';

/**
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Adapter
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Http_Client_Adapter_Exception extends Zend_Http_Client_Exception
{}
86   9601|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/Client/Adapter/Proxy.php|4c9096e2<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Adapter
 * @version    $Id: Proxy.php 9868 2008-07-02 06:47:38Z shahar $
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

require_once 'Zend/Uri/Http.php';
require_once 'Zend/Http/Client.php';
require_once 'Zend/Http/Client/Adapter/Socket.php';

/**
 * HTTP Proxy-supporting Zend_Http_Client adapter class, based on the default
 * socket based adapter.
 *
 * Should be used if proxy HTTP access is required. If no proxy is set, will
 * fall back to Zend_Http_Client_Adapter_Socket behavior. Just like the
 * default Socket adapter, this adapter does not require any special extensions
 * installed.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Adapter
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Http_Client_Adapter_Proxy extends Zend_Http_Client_Adapter_Socket
{
    /**
     * Parameters array
     *
     * @var array
     */
    protected $config = array(
        'ssltransport'  => 'ssl',
        'proxy_host'    => '',
        'proxy_port'    => 8080,
        'proxy_user'    => '',
        'proxy_pass'    => '',
        'proxy_auth'    => Zend_Http_Client::AUTH_BASIC,
        'persistent'    => false
    );

    /**
     * Whether HTTPS CONNECT was already negotiated with the proxy or not
     *
     * @var boolean
     */
    protected $negotiated = false;
    
    /**
     * Connect to the remote server
     *
     * Will try to connect to the proxy server. If no proxy was set, will
     * fall back to the target server (behave like regular Socket adapter)
     *
     * @param string  $host
     * @param int     $port
     * @param boolean $secure
     * @param int     $timeout
     */
    public function connect($host, $port = 80, $secure = false)
    {
        // If no proxy is set, fall back to Socket adapter
        if (! $this->config['proxy_host']) return parent::connect($host, $port, $secure);

        // Go through a proxy - the connection is actually to the proxy server
        $host = $this->config['proxy_host'];
        $port = $this->config['proxy_port'];

        // If we are connected to the wrong proxy, disconnect first
        if (($this->connected_to[0] != $host || $this->connected_to[1] != $port)) {
            if (is_resource($this->socket)) $this->close();
        }

        // Now, if we are not connected, connect
        if (! is_resource($this->socket) || ! $this->config['keepalive']) {
            $this->socket = @fsockopen($host, $port, $errno, $errstr, (int) $this->config['timeout']);
            if (! $this->socket) {
                $this->close();
                require_once 'Zend/Http/Client/Adapter/Exception.php';
		throw new Zend_Http_Client_Adapter_Exception(
                    'Unable to Connect to proxy server ' . $host . ':' . $port . '. Error #' . $errno . ': ' . $errstr);
            }

            // Set the stream timeout
            if (!stream_set_timeout($this->socket, (int) $this->config['timeout'])) {
                require_once 'Zend/Http/Client/Adapter/Exception.php';
                throw new Zend_Http_Client_Adapter_Exception('Unable to set the connection timeout');
            }

            // Update connected_to
            $this->connected_to = array($host, $port);
        }
    }

    /**
     * Send request to the proxy server
     *
     * @param string        $method
     * @param Zend_Uri_Http $uri
     * @param string        $http_ver
     * @param array         $headers
     * @param string        $body
     * @return string Request as string
     */
    public function write($method, $uri, $http_ver = '1.1', $headers = array(), $body = '')
    {
        // If no proxy is set, fall back to default Socket adapter
        if (! $this->config['proxy_host']) return parent::write($method, $uri, $http_ver, $headers, $body);

        // Make sure we're properly connected
        if (! $this->socket) {
            require_once 'Zend/Http/Client/Adapter/Exception.php';
            throw new Zend_Http_Client_Adapter_Exception("Trying to write but we are not connected");
	}

        $host = $this->config['proxy_host'];
        $port = $this->config['proxy_port'];

        if ($this->connected_to[0] != $host || $this->connected_to[1] != $port) {
            require_once 'Zend/Http/Client/Adapter/Exception.php';
            throw new Zend_Http_Client_Adapter_Exception("Trying to write but we are connected to the wrong proxy server");
	}

        // Add Proxy-Authorization header
        if ($this->config['proxy_user'] && ! isset($headers['proxy-authorization']))
            $headers['proxy-authorization'] = Zend_Http_Client::encodeAuthHeader(
                $this->config['proxy_user'], $this->config['proxy_pass'], $this->config['proxy_auth']
            );
                
        // if we are proxying HTTPS, preform CONNECT handshake with the proxy
        if ($uri->getScheme() == 'https' && (! $this->negotiated)) {
            $this->connectHandshake($uri->getHost(), $uri->getPort(), $http_ver, $headers);
            $this->negotiated = true;
        }
        
        // Save request method for later
        $this->method = $method;

        // Build request headers
        $request = "{$method} {$uri->__toString()} HTTP/{$http_ver}\r\n";

        // Add all headers to the request string
        foreach ($headers as $k => $v) {
            if (is_string($k)) $v = "$k: $v";
            $request .= "$v\r\n";
        }

        // Add the request body
        $request .= "\r\n" . $body;

        // Send the request
        if (! @fwrite($this->socket, $request)) {
            require_once 'Zend/Http/Client/Adapter/Exception.php';
            throw new Zend_Http_Client_Adapter_Exception("Error writing request to proxy server");
        }

        return $request;
    }

    /**
     * Preform handshaking with HTTPS proxy using CONNECT method
     *
     * @param string  $host
     * @param integer $port
     * @param string  $http_ver
     * @param array   $headers
     */
    protected function connectHandshake($host, $port = 443, $http_ver = '1.1', array &$headers = array())
    {
    	$request = "CONNECT $host:$port HTTP/$http_ver\r\n" . 
    	           "Host: " . $this->config['proxy_host'] . "\r\n";

    	// Add the user-agent header
    	if (isset($this->config['useragent'])) {
    		$request .= "User-agent: " . $this->config['useragent'] . "\r\n";
    	}
    	
    	// If the proxy-authorization header is set, send it to proxy but remove
    	// it from headers sent to target host
    	if (isset($headers['proxy-authorization'])) {
    	    $request .= "Proxy-authorization: " . $headers['proxy-authorization'] . "\r\n";
    	    unset($headers['proxy-authorization']);
    	}
    	
        $request .= "\r\n";

        // Send the request
        if (! @fwrite($this->socket, $request)) {
            require_once 'Zend/Http/Client/Adapter/Exception.php';
            throw new Zend_Http_Client_Adapter_Exception("Error writing request to proxy server");
        }

        // Read response headers only
        $response = '';
        $gotStatus = false;
        while ($line = @fgets($this->socket)) {
            $gotStatus = $gotStatus || (strpos($line, 'HTTP') !== false);
            if ($gotStatus) {
                $response .= $line;
                if (!chop($line)) break;
            }
        }
        
        // Check that the response from the proxy is 200
        if (Zend_Http_Response::extractCode($response) != 200) {
                require_once 'Zend/Http/Client/Adapter/Exception.php';
        	throw new Zend_Http_Client_Adapter_Exception("Unable to connect to HTTPS proxy. Server response: " . $response);
        }
        
        // If all is good, switch socket to secure mode. We have to fall back
        // through the different modes 
        $modes = array(
            STREAM_CRYPTO_METHOD_TLS_CLIENT, 
            STREAM_CRYPTO_METHOD_SSLv3_CLIENT,
            STREAM_CRYPTO_METHOD_SSLv23_CLIENT,
            STREAM_CRYPTO_METHOD_SSLv2_CLIENT 
        );
        
        $success = false; 
        foreach($modes as $mode) {
            $success = stream_socket_enable_crypto($this->socket, true, $mode);
        	if ($success) break;
        }
        
        if (! $success) {
                require_once 'Zend/Http/Client/Adapter/Exception.php';
        	throw new Zend_Http_Client_Adapter_Exception("Unable to connect to" . 
        	    " HTTPS server through proxy: could not negotiate secure connection.");
        }
    }
    
    /**
     * Close the connection to the server
     *
     */
    public function close()
    {
        parent::close();
        $this->negotiated = false;
    }
    
    /**
     * Destructor: make sure the socket is disconnected
     *
     */
    public function __destruct()
    {
        if ($this->socket) $this->close();
    }
}
85   5451|/shs.parser/classes/phpQuery/phpQuery/Zend/Http/Client/Adapter/Test.php|c9984239<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Adapter
 * @version    $Id: Test.php 8064 2008-02-16 10:58:39Z thomas $
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

require_once 'Zend/Uri/Http.php';
require_once 'Zend/Http/Response.php';
require_once 'Zend/Http/Client/Adapter/Interface.php';

/**
 * A testing-purposes adapter.
 *
 * Should be used to test all components that rely on Zend_Http_Client,
 * without actually performing an HTTP request. You should instantiate this
 * object manually, and then set it as the client's adapter. Then, you can
 * set the expected response using the setResponse() method.
 *
 * @category   Zend
 * @package    Zend_Http
 * @subpackage Client_Adapter
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Http_Client_Adapter_Test implements Zend_Http_Client_Adapter_Interface
{
    /**
     * Parameters array
     *
     * @var array
     */
    protected $config = array();

    /**
     * Buffer of responses to be returned by the read() method.  Can be
     * set using setResponse() and addResponse().
     *
     * @var array
     */
    protected $responses = array("HTTP/1.1 400 Bad Request\r\n\r\n");

    /**
     * Current position in the response buffer
     *
     * @var integer
     */
    protected $responseIndex = 0;

    /**
     * Adapter constructor, currently empty. Config is set using setConfig()
     *
     */
    public function __construct()
    { }

    /**
     * Set the configuration array for the adapter
     *
     * @param array $config
     */
    public function setConfig($config = array())
    {
        if (! is_array($config)) {
            require_once 'Zend/Http/Client/Adapter/Exception.php';
            throw new Zend_Http_Client_Adapter_Exception(
                '$config expects an array, ' . gettype($config) . ' recieved.');
        }

        foreach ($config as $k => $v) {
            $this->config[strtolower($k)] = $v;
        }
    }

    /**
     * Connect to the remote server
     *
     * @param string  $host
     * @param int     $port
     * @param boolean $secure
     * @param int     $timeout
     */
    public function connect($host, $port = 80, $secure = false)
    { }

    /**
     * Send request to the remote server
     *
     * @param string        $method
     * @param Zend_Uri_Http $uri
     * @param string        $http_ver
     * @param array         $headers
     * @param string        $body
     * @return string Request as string
     */
    public function write($method, $uri, $http_ver = '1.1', $headers = array(), $body = '')
    {
        $host = $uri->getHost();
            $host = (strtolower($uri->getScheme()) == 'https' ? 'sslv2://' . $host : $host);

        // Build request headers
        $path = $uri->getPath();
        if ($uri->getQuery()) $path .= '?' . $uri->getQuery();
        $request = "{$method} {$path} HTTP/{$http_ver}\r\n";
        foreach ($headers as $k => $v) {
            if (is_string($k)) $v = ucfirst($k) . ": $v";
            $request .= "$v\r\n";
        }

        // Add the request body
        $request .= "\r\n" . $body;

        // Do nothing - just return the request as string

        return $request;
    }

    /**
     * Return the response set in $this->setResponse()
     *
     * @return string
     */
    public function read()
    {
        if ($this->responseIndex >= count($this->responses)) {
            $this->responseIndex = 0;
        }
        return $this->responses[$this->responseIndex++];
    }

    /**
     * Close the connection (dummy)
     *
     */
    public function close()
    { }

    /**
     * Set the HTTP response(s) to be returned by this adapter
     *
     * @param Zend_Http_Response|array|string $response
     */
    public function setResponse($response)
    {
        if ($response instanceof Zend_Http_Response) {
            $response = $response->asString();
        }

        $this->responses = (array)$response;
        $this->responseIndex = 0;
    }

    /**
     * Add another response to the response buffer.
     *
     * @param string $response
     */
    public function addResponse($response)
    {
        $this->responses[] = $response;
    }

    /**
     * Sets the position of the response buffer.  Selects which
     * response will be returned on the next call to read().
     *
     * @param integer $index
     */
    public function setResponseIndex($index)
    {
        if ($index < 0 || $index >= count($this->responses)) {
            require_once 'Zend/Http/Client/Adapter/Exception.php';
            throw new Zend_Http_Client_Adapter_Exception(
                'Index out of range of response buffer size');
        }
        $this->responseIndex = $index;
    }
}
74   13823|/shs.parser/classes/phpQuery/phpQuery/Zend/Json/Decoder.php|9900fcbc<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Json
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */

/**
 * @see Zend_Json
 */
require_once 'Zend/Json.php';

/**
 * @see Zend_Json_Exception
 */
require_once 'Zend/Json/Exception.php';


/**
 * Decode JSON encoded string to PHP variable constructs
 *
 * @category   Zend
 * @package    Zend_Json
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Json_Decoder
{
    /**
     * Parse tokens used to decode the JSON object. These are not
     * for public consumption, they are just used internally to the
     * class.
     */
    const EOF         = 0;
    const DATUM        = 1;
    const LBRACE    = 2;
    const LBRACKET    = 3;
    const RBRACE     = 4;
    const RBRACKET    = 5;
    const COMMA       = 6;
    const COLON        = 7;

    /**
     * Use to maintain a "pointer" to the source being decoded
     *
     * @var string
     */
    protected $_source;

    /**
     * Caches the source length
     *
     * @var int
     */
    protected $_sourceLength;

    /**
     * The offset within the souce being decoded
     *
     * @var int
     *
     */
    protected $_offset;

    /**
     * The current token being considered in the parser cycle
     *
     * @var int
     */
    protected $_token;

    /**
     * Flag indicating how objects should be decoded
     *
     * @var int
     * @access protected
     */
    protected $_decodeType;

    /**
     * Constructor
     *
     * @param string $source String source to decode
     * @param int $decodeType How objects should be decoded -- see
     * {@link Zend_Json::TYPE_ARRAY} and {@link Zend_Json::TYPE_OBJECT} for
     * valid values
     * @return void
     */
    protected function __construct($source, $decodeType)
    {
        // Set defaults
        $this->_source       = $source;
        $this->_sourceLength = strlen($source);
        $this->_token        = self::EOF;
        $this->_offset       = 0;

        // Normalize and set $decodeType
        if (!in_array($decodeType, array(Zend_Json::TYPE_ARRAY, Zend_Json::TYPE_OBJECT)))
        {
            $decodeType = Zend_Json::TYPE_ARRAY;
        }
        $this->_decodeType   = $decodeType;

        // Set pointer at first token
        $this->_getNextToken();
    }

    /**
     * Decode a JSON source string
     *
     * Decodes a JSON encoded string. The value returned will be one of the
     * following:
     *        - integer
     *        - float
     *        - boolean
     *        - null
     *      - StdClass
     *      - array
     *         - array of one or more of the above types
     *
     * By default, decoded objects will be returned as associative arrays; to
     * return a StdClass object instead, pass {@link Zend_Json::TYPE_OBJECT} to
     * the $objectDecodeType parameter.
     *
     * Throws a Zend_Json_Exception if the source string is null.
     *
     * @static
     * @access public
     * @param string $source String to be decoded
     * @param int $objectDecodeType How objects should be decoded; should be
     * either or {@link Zend_Json::TYPE_ARRAY} or
     * {@link Zend_Json::TYPE_OBJECT}; defaults to TYPE_ARRAY
     * @return mixed
     * @throws Zend_Json_Exception
     */
    public static function decode($source = null, $objectDecodeType = Zend_Json::TYPE_ARRAY)
    {
        if (null === $source) {
            throw new Zend_Json_Exception('Must specify JSON encoded source for decoding');
        } elseif (!is_string($source)) {
            throw new Zend_Json_Exception('Can only decode JSON encoded strings');
        }

        $decoder = new self($source, $objectDecodeType);

        return $decoder->_decodeValue();
    }


    /**
     * Recursive driving rountine for supported toplevel tops
     *
     * @return mixed
     */
    protected function _decodeValue()
    {
        switch ($this->_token) {
            case self::DATUM:
                $result  = $this->_tokenValue;
                $this->_getNextToken();
                return($result);
                break;
            case self::LBRACE:
                return($this->_decodeObject());
                break;
            case self::LBRACKET:
                return($this->_decodeArray());
                break;
            default:
                return null;
                break;
        }
    }

    /**
     * Decodes an object of the form:
     *  { "attribute: value, "attribute2" : value,...}
     *
     * If Zend_Json_Encoder was used to encode the original object then 
     * a special attribute called __className which specifies a class
     * name that should wrap the data contained within the encoded source.
     *
     * Decodes to either an array or StdClass object, based on the value of
     * {@link $_decodeType}. If invalid $_decodeType present, returns as an
     * array.
     *
     * @return array|StdClass
     */
    protected function _decodeObject()
    {
        $members = array();
        $tok = $this->_getNextToken();

        while ($tok && $tok != self::RBRACE) {
            if ($tok != self::DATUM || ! is_string($this->_tokenValue)) {
                throw new Zend_Json_Exception('Missing key in object encoding: ' . $this->_source);
            }

            $key = $this->_tokenValue;
            $tok = $this->_getNextToken();

            if ($tok != self::COLON) {
                throw new Zend_Json_Exception('Missing ":" in object encoding: ' . $this->_source);
            }

            $tok = $this->_getNextToken();
            $members[$key] = $this->_decodeValue();
            $tok = $this->_token;

            if ($tok == self::RBRACE) {
                break;
            }

            if ($tok != self::COMMA) {
                throw new Zend_Json_Exception('Missing "," in object encoding: ' . $this->_source);
            }

            $tok = $this->_getNextToken();
        }

        switch ($this->_decodeType) {
            case Zend_Json::TYPE_OBJECT:
                // Create new StdClass and populate with $members
                $result = new StdClass();
                foreach ($members as $key => $value) {
                    $result->$key = $value;
                }
                break;
            case Zend_Json::TYPE_ARRAY:
            default:
                $result = $members;
                break;
        }

        $this->_getNextToken();
        return $result;
    }

    /**
     * Decodes a JSON array format:
     *    [element, element2,...,elementN]
     *
     * @return array
     */
    protected function _decodeArray()
    {
        $result = array();
        $starttok = $tok = $this->_getNextToken(); // Move past the '['
        $index  = 0;

        while ($tok && $tok != self::RBRACKET) {
            $result[$index++] = $this->_decodeValue();

            $tok = $this->_token;

            if ($tok == self::RBRACKET || !$tok) {
                break;
            }

            if ($tok != self::COMMA) {
                throw new Zend_Json_Exception('Missing "," in array encoding: ' . $this->_source);
            }

            $tok = $this->_getNextToken();
        }

        $this->_getNextToken();
        return($result);
    }


    /**
     * Removes whitepsace characters from the source input
     */
    protected function _eatWhitespace()
    {
        if (preg_match(
                '/([\t\b\f\n\r ])*/s',
                $this->_source,
                $matches,
                PREG_OFFSET_CAPTURE,
                $this->_offset)
            && $matches[0][1] == $this->_offset)
        {
            $this->_offset += strlen($matches[0][0]);
        }
    }


    /**
     * Retrieves the next token from the source stream
     *
     * @return int Token constant value specified in class definition
     */
    protected function _getNextToken()
    {
        $this->_token      = self::EOF;
        $this->_tokenValue = null;
        $this->_eatWhitespace();

        if ($this->_offset >= $this->_sourceLength) {
            return(self::EOF);
        }

        $str        = $this->_source;
        $str_length = $this->_sourceLength;
        $i          = $this->_offset;
        $start      = $i;

        switch ($str{$i}) {
            case '{':
               $this->_token = self::LBRACE;
               break;
            case '}':
                $this->_token = self::RBRACE;
                break;
            case '[':
                $this->_token = self::LBRACKET;
                break;
            case ']':
                $this->_token = self::RBRACKET;
                break;
            case ',':
                $this->_token = self::COMMA;
                break;
            case ':':
                $this->_token = self::COLON;
                break;
            case  '"':
                $result = '';
                do {
                    $i++;
                    if ($i >= $str_length) {
                        break;
                    }

                    $chr = $str{$i};
                    if ($chr == '\\') {
                        $i++;
                        if ($i >= $str_length) {
                            break;
                        }
                        $chr = $str{$i};
                        switch ($chr) {
                            case '"' :
                                $result .= '"';
                                break;
                            case '\\':
                                $result .= '\\';
                                break;
                            case '/' :
                                $result .= '/';
                                break;
                            case 'b' :
                                $result .= chr(8);
                                break;
                            case 'f' :
                                $result .= chr(12);
                                break;
                            case 'n' :
                                $result .= chr(10);
                                break;
                            case 'r' :
                                $result .= chr(13);
                                break;
                            case 't' :
                                $result .= chr(9);
                                break;
                            case '\'' :
                                $result .= '\'';
                                break;
                            default:
                                throw new Zend_Json_Exception("Illegal escape "
                                    .  "sequence '" . $chr . "'");
                            }
                    } elseif ($chr == '"') {
                        break;
                    } else {
                        $result .= $chr;
                    }
                } while ($i < $str_length);

                $this->_token = self::DATUM;
                //$this->_tokenValue = substr($str, $start + 1, $i - $start - 1);
                $this->_tokenValue = $result;
                break;
            case 't':
                if (($i+ 3) < $str_length && substr($str, $start, 4) == "true") {
                    $this->_token = self::DATUM;
                }
                $this->_tokenValue = true;
                $i += 3;
                break;
            case 'f':
                if (($i+ 4) < $str_length && substr($str, $start, 5) == "false") {
                    $this->_token = self::DATUM;
                }
                $this->_tokenValue = false;
                $i += 4;
                break;
            case 'n':
                if (($i+ 3) < $str_length && substr($str, $start, 4) == "null") {
                    $this->_token = self::DATUM;
                }
                $this->_tokenValue = NULL;
                $i += 3;
                break;
        }

        if ($this->_token != self::EOF) {
            $this->_offset = $i + 1; // Consume the last token character
            return($this->_token);
        }

        $chr = $str{$i};
        if ($chr == '-' || $chr == '.' || ($chr >= '0' && $chr <= '9')) {
            if (preg_match('/-?([0-9])*(\.[0-9]*)?((e|E)((-|\+)?)[0-9]+)?/s',
                $str, $matches, PREG_OFFSET_CAPTURE, $start) && $matches[0][1] == $start) {

                $datum = $matches[0][0];

                if (is_numeric($datum)) {
                    if (preg_match('/^0\d+$/', $datum)) {
                        throw new Zend_Json_Exception("Octal notation not supported by JSON (value: $datum)");
                    } else {
                        $val  = intval($datum);
                        $fVal = floatval($datum);
                        $this->_tokenValue = ($val == $fVal ? $val : $fVal);
                    }
                } else {
                    throw new Zend_Json_Exception("Illegal number format: $datum");
                }

                $this->_token = self::DATUM;
                $this->_offset = $start + strlen($datum);
            }
        } else {
            throw new Zend_Json_Exception('Illegal Token');
        }

        return($this->_token);
    }
}

74   12619|/shs.parser/classes/phpQuery/phpQuery/Zend/Json/Encoder.php|2e4e4746<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Json
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */


/**
 * Zend_Json_Exception
 */
require_once 'Zend/Json/Exception.php';


/**
 * Encode PHP constructs to JSON
 *
 * @category   Zend
 * @package    Zend_Json
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Json_Encoder
{
    /**
     * Whether or not to check for possible cycling
     *
     * @var boolean
     */
    protected $_cycleCheck;
    
    /**
     * Additional options used during encoding
     * 
     * @var array
     */
    protected $_options = array();

    /**
     * Array of visited objects; used to prevent cycling.
     *
     * @var array
     */
    protected $_visited = array();

    /**
     * Constructor
     *
     * @param boolean $cycleCheck Whether or not to check for recursion when encoding
     * @param array $options Additional options used during encoding
     * @return void
     */
    protected function __construct($cycleCheck = false, $options = array())
    {
        $this->_cycleCheck = $cycleCheck;
        $this->_options = $options;
    }

    /**
     * Use the JSON encoding scheme for the value specified
     *
     * @param mixed $value The value to be encoded
     * @param boolean $cycleCheck Whether or not to check for possible object recursion when encoding
     * @param array $options Additional options used during encoding
     * @return string  The encoded value
     */
    public static function encode($value, $cycleCheck = false, $options = array())
    {
        $encoder = new self(($cycleCheck) ? true : false, $options);

        return $encoder->_encodeValue($value);
    }

    /**
     * Recursive driver which determines the type of value to be encoded
     * and then dispatches to the appropriate method. $values are either
     *    - objects (returns from {@link _encodeObject()})
     *    - arrays (returns from {@link _encodeArray()})
     *    - basic datums (e.g. numbers or strings) (returns from {@link _encodeDatum()})
     *
     * @param $value mixed The value to be encoded
     * @return string Encoded value
     */
    protected function _encodeValue(&$value)
    {
        if (is_object($value)) {
            return $this->_encodeObject($value);
        } else if (is_array($value)) {
            return $this->_encodeArray($value);
        }

        return $this->_encodeDatum($value);
    }



    /**
     * Encode an object to JSON by encoding each of the public properties
     *
     * A special property is added to the JSON object called '__className'
     * that contains the name of the class of $value. This is used to decode
     * the object on the client into a specific class.
     *
     * @param $value object
     * @return string
     * @throws Zend_Json_Exception If recursive checks are enabled and the object has been serialized previously
     */
    protected function _encodeObject(&$value)
    {
        if ($this->_cycleCheck) {
            if ($this->_wasVisited($value)) {
                
                if (isset($this->_options['silenceCyclicalExceptions'])
                    && $this->_options['silenceCyclicalExceptions']===true) {
                    
                    return '"* RECURSION (' . get_class($value) . ') *"';
                    
                } else {
                    throw new Zend_Json_Exception(
                        'Cycles not supported in JSON encoding, cycle introduced by '
                        . 'class "' . get_class($value) . '"'
                    );
                }
            }

            $this->_visited[] = $value;
        }

        $props = '';
        foreach (get_object_vars($value) as $name => $propValue) {
            if (isset($propValue)) {
                $props .= ','
                        . $this->_encodeValue($name)
                        . ':'
                        . $this->_encodeValue($propValue);
            }
        }

        return '{"__className":"' . get_class($value) . '"'
                . $props . '}';
    }


    /**
     * Determine if an object has been serialized already
     *
     * @param mixed $value
     * @return boolean
     */
    protected function _wasVisited(&$value)
    {
        if (in_array($value, $this->_visited, true)) {
            return true;
        }

        return false;
    }


    /**
     * JSON encode an array value
     *
     * Recursively encodes each value of an array and returns a JSON encoded
     * array string.
     *
     * Arrays are defined as integer-indexed arrays starting at index 0, where
     * the last index is (count($array) -1); any deviation from that is
     * considered an associative array, and will be encoded as such.
     *
     * @param $array array
     * @return string
     */
    protected function _encodeArray(&$array)
    {
        $tmpArray = array();

        // Check for associative array
        if (!empty($array) && (array_keys($array) !== range(0, count($array) - 1))) {
            // Associative array
            $result = '{';
            foreach ($array as $key => $value) {
                $key = (string) $key;
                $tmpArray[] = $this->_encodeString($key)
                            . ':'
                            . $this->_encodeValue($value);
            }
            $result .= implode(',', $tmpArray);
            $result .= '}';
        } else {
            // Indexed array
            $result = '[';
            $length = count($array);
            for ($i = 0; $i < $length; $i++) {
                $tmpArray[] = $this->_encodeValue($array[$i]);
            }
            $result .= implode(',', $tmpArray);
            $result .= ']';
        }

        return $result;
    }


    /**
     * JSON encode a basic data type (string, number, boolean, null)
     *
     * If value type is not a string, number, boolean, or null, the string
     * 'null' is returned.
     *
     * @param $value mixed
     * @return string
     */
    protected function _encodeDatum(&$value)
    {
        $result = 'null';

        if (is_int($value) || is_float($value)) {
            $result = (string)$value;
        } elseif (is_string($value)) {
            $result = $this->_encodeString($value);
        } elseif (is_bool($value)) {
            $result = $value ? 'true' : 'false';
        }

        return $result;
    }


    /**
     * JSON encode a string value by escaping characters as necessary
     *
     * @param $value string
     * @return string
     */
    protected function _encodeString(&$string)
    {
        // Escape these characters with a backslash:
        // " \ / \n \r \t \b \f
        $search  = array('\\', "\n", "\t", "\r", "\b", "\f", '"');
        $replace = array('\\\\', '\\n', '\\t', '\\r', '\\b', '\\f', '\"');
        $string  = str_replace($search, $replace, $string);

        // Escape certain ASCII characters:
        // 0x08 => \b
        // 0x0c => \f
        $string = str_replace(array(chr(0x08), chr(0x0C)), array('\b', '\f'), $string);

        return '"' . $string . '"';
    }


    /**
     * Encode the constants associated with the ReflectionClass
     * parameter. The encoding format is based on the class2 format
     *
     * @param $cls ReflectionClass
     * @return string Encoded constant block in class2 format
     */
    private static function _encodeConstants(ReflectionClass $cls)
    {
        $result    = "constants : {";
        $constants = $cls->getConstants();

        $tmpArray = array();
        if (!empty($constants)) {
            foreach ($constants as $key => $value) {
                $tmpArray[] = "$key: " . self::encode($value);
            }

            $result .= implode(', ', $tmpArray);
        }

        return $result . "}";
    }


    /**
     * Encode the public methods of the ReflectionClass in the
     * class2 format
     *
     * @param $cls ReflectionClass
     * @return string Encoded method fragment
     *
     */
    private static function _encodeMethods(ReflectionClass $cls)
    {
        $methods = $cls->getMethods();
        $result = 'methods:{';

        $started = false;
        foreach ($methods as $method) {
            if (! $method->isPublic() || !$method->isUserDefined()) {
                continue;
            }

            if ($started) {
                $result .= ',';
            }
            $started = true;

            $result .= '' . $method->getName(). ':function(';

            if ('__construct' != $method->getName()) {
                $parameters  = $method->getParameters();
                $paramCount  = count($parameters);
                $argsStarted = false;

                $argNames = "var argNames=[";
                foreach ($parameters as $param) {
                    if ($argsStarted) {
                        $result .= ',';
                    }

                    $result .= $param->getName();

                    if ($argsStarted) {
                        $argNames .= ',';
                    }

                    $argNames .= '"' . $param->getName() . '"';

                    $argsStarted = true;
                }
                $argNames .= "];";

                $result .= "){"
                         . $argNames
                         . 'var result = ZAjaxEngine.invokeRemoteMethod('
                         . "this, '" . $method->getName()
                         . "',argNames,arguments);"
                         . 'return(result);}';
            } else {
                $result .= "){}";
            }
        }

        return $result . "}";
    }


    /**
     * Encode the public properties of the ReflectionClass in the class2
     * format.
     *
     * @param $cls ReflectionClass
     * @return string Encode properties list
     *
     */
    private static function _encodeVariables(ReflectionClass $cls)
    {
        $properties = $cls->getProperties();
        $propValues = get_class_vars($cls->getName());
        $result = "variables:{";
        $cnt = 0;

        $tmpArray = array();
        foreach ($properties as $prop) {
            if (! $prop->isPublic()) {
                continue;
            }

            $tmpArray[] = $prop->getName()
                        . ':'
                        . self::encode($propValues[$prop->getName()]);
        }
        $result .= implode(',', $tmpArray);

        return $result . "}";
    }

    /**
     * Encodes the given $className into the class2 model of encoding PHP
     * classes into JavaScript class2 classes.
     * NOTE: Currently only public methods and variables are proxied onto
     * the client machine
     *
     * @param $className string The name of the class, the class must be
     * instantiable using a null constructor
     * @param $package string Optional package name appended to JavaScript
     * proxy class name
     * @return string The class2 (JavaScript) encoding of the class
     * @throws Zend_Json_Exception
     */
    public static function encodeClass($className, $package = '')
    {
        $cls = new ReflectionClass($className);
        if (! $cls->isInstantiable()) {
            throw new Zend_Json_Exception("$className must be instantiable");
        }

        return "Class.create('$package$className',{"
                . self::_encodeConstants($cls)    .","
                . self::_encodeMethods($cls)      .","
                . self::_encodeVariables($cls)    .'});';
    }


    /**
     * Encode several classes at once
     *
     * Returns JSON encoded classes, using {@link encodeClass()}.
     *
     * @param array $classNames
     * @param string $package
     * @return string
     */
    public static function encodeClasses(array $classNames, $package = '')
    {
        $result = '';
        foreach ($classNames as $className) {
            $result .= self::encodeClass($className, $package);
        }

        return $result;
    }

}

75   1013|/shs.parser/classes/phpQuery/phpQuery/Zend/Json/Exception.php|5cc5cdc3<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Json
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */


/**
 * Zend_Exception
 */
require_once 'Zend/Exception.php';


/**
 * @category   Zend
 * @package    Zend_Json
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Json_Exception extends Zend_Exception
{}

74   7257|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Date.php|71e4f2a9<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Date.php 11046 2008-08-25 13:58:52Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Date extends Zend_Validate_Abstract
{
    /**
     * Validation failure message key for when the value does not follow the YYYY-MM-DD format
     */
    const NOT_YYYY_MM_DD = 'dateNotYYYY-MM-DD';

    /**
     * Validation failure message key for when the value does not appear to be a valid date
     */
    const INVALID        = 'dateInvalid';

    /**
     * Validation failure message key for when the value does not fit the given dateformat or locale
     */
    const FALSEFORMAT    = 'dateFalseFormat';

    /**
     * Validation failure message template definitions
     *
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_YYYY_MM_DD => "'%value%' is not of the format YYYY-MM-DD",
        self::INVALID        => "'%value%' does not appear to be a valid date",
        self::FALSEFORMAT    => "'%value%' does not fit given date format"
    );

    /**
     * Optional format
     *
     * @var string|null
     */
    protected $_format;

    /**
     * Optional locale
     *
     * @var string|Zend_Locale|null
     */
    protected $_locale;

    /**
     * Sets validator options
     *
     * @param  string             $format OPTIONAL
     * @param  string|Zend_Locale $locale OPTIONAL
     * @return void
     */
    public function __construct($format = null, $locale = null)
    {
        $this->setFormat($format);
        $this->setLocale($locale);
    }

    /**
     * Returns the locale option
     *
     * @return string|Zend_Locale|null
     */
    public function getLocale()
    {
        return $this->_locale;
    }

    /**
     * Sets the locale option
     *
     * @param  string|Zend_Locale $locale
     * @return Zend_Validate_Date provides a fluent interface
     */
    public function setLocale($locale = null)
    {
        if ($locale === null) {
            $this->_locale = null;
            return $this;
        }

        require_once 'Zend/Locale.php';
        if (!Zend_Locale::isLocale($locale, true)) {
            if (!Zend_Locale::isLocale($locale, false)) {
                require_once 'Zend/Validate/Exception.php';
                throw new Zend_Validate_Exception("The locale '$locale' is no known locale");
            }

            $locale = new Zend_Locale($locale);
        }

        $this->_locale = (string) $locale;
        return $this;
    }

    /**
     * Returns the locale option
     *
     * @return string|null
     */
    public function getFormat()
    {
        return $this->_format;
    }

    /**
     * Sets the format option
     *
     * @param  string $format
     * @return Zend_Validate_Date provides a fluent interface
     */
    public function setFormat($format = null)
    {
        $this->_format = $format;
        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if $value is a valid date of the format YYYY-MM-DD
     * If optional $format or $locale is set the date format is checked
     * according to Zend_Date, see Zend_Date::isDate()
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        if (($this->_format !== null) or ($this->_locale !== null)) {
            require_once 'Zend/Date.php';
            if (!Zend_Date::isDate($value, $this->_format, $this->_locale)) {
                if ($this->_checkFormat($value) === false) {
                    $this->_error(self::FALSEFORMAT);
                } else {
                    $this->_error(self::INVALID);
                }
                return false;
            }
        } else {
            if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $valueString)) {
                $this->_error(self::NOT_YYYY_MM_DD);
                return false;
            }

            list($year, $month, $day) = sscanf($valueString, '%d-%d-%d');

            if (!checkdate($month, $day, $year)) {
                $this->_error(self::INVALID);
                return false;
            }
        }

        return true;
    }

    /**
     * Check if the given date fits the given format
     *
     * @param  string $value  Date to check
     * @return boolean False when date does not fit the format
     */
    private function _checkFormat($value)
    {
        try {
            require_once 'Zend/Locale/Format.php';
            $parsed = Zend_Locale_Format::getDate($value, array(
                                                  'date_format' => $this->_format, 'format_type' => 'iso',
                                                  'fix_date' => false));
            if (isset($parsed['year']) and ((strpos(strtoupper($this->_format), 'YY') !== false) and
                (strpos(strtoupper($this->_format), 'YYYY') === false))) {
                $parsed['year'] = Zend_Date::_century($parsed['year']);
            }
        } catch (Exception $e) {
            // Date can not be parsed
            return false;
        }

        if (((strpos($this->_format, 'Y') !== false) or (strpos($this->_format, 'y') !== false)) and
            (!isset($parsed['year']))) {
            // Year expected but not found
            return false;
        }

        if ((strpos($this->_format, 'M') !== false) and (!isset($parsed['month']))) {
            // Month expected but not found
            return false;
        }

        if ((strpos($this->_format, 'd') !== false) and (!isset($parsed['day']))) {
            // Day expected but not found
            return false;
        }

        if (((strpos($this->_format, 'H') !== false) or (strpos($this->_format, 'h') !== false)) and
            (!isset($parsed['hour']))) {
            // Hour expected but not found
            return false;
        }

        if ((strpos($this->_format, 'm') !== false) and (!isset($parsed['minute']))) {
            // Minute expected but not found
            return false;
        }

        if ((strpos($this->_format, 's') !== false) and (!isset($parsed['second']))) {
            // Second expected  but not found
            return false;
        }

        // Date fits the format
        return true;
    }
}
79   15975|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hostname.php|157ab6d7<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Hostname.php 9195 2008-04-10 17:35:30Z jokke $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';

/**
 * @see Zend_Loader
 */
require_once 'Zend/Loader.php';

/**
 * @see Zend_Validate_Ip
 */
require_once 'Zend/Validate/Ip.php';

/**
 * Please note there are two standalone test scripts for testing IDN characters due to problems
 * with file encoding.
 *
 * The first is tests/Zend/Validate/HostnameTestStandalone.php which is designed to be run on
 * the command line.
 *
 * The second is tests/Zend/Validate/HostnameTestForm.php which is designed to be run via HTML
 * to allow users to test entering UTF-8 characters in a form.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Hostname extends Zend_Validate_Abstract
{

    const IP_ADDRESS_NOT_ALLOWED  = 'hostnameIpAddressNotAllowed';
    const UNKNOWN_TLD             = 'hostnameUnknownTld';
    const INVALID_DASH            = 'hostnameDashCharacter';
    const INVALID_HOSTNAME_SCHEMA = 'hostnameInvalidHostnameSchema';
    const UNDECIPHERABLE_TLD      = 'hostnameUndecipherableTld';
    const INVALID_HOSTNAME        = 'hostnameInvalidHostname';
    const INVALID_LOCAL_NAME      = 'hostnameInvalidLocalName';
    const LOCAL_NAME_NOT_ALLOWED  = 'hostnameLocalNameNotAllowed';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::IP_ADDRESS_NOT_ALLOWED  => "'%value%' appears to be an IP address, but IP addresses are not allowed",
        self::UNKNOWN_TLD             => "'%value%' appears to be a DNS hostname but cannot match TLD against known list",
        self::INVALID_DASH            => "'%value%' appears to be a DNS hostname but contains a dash (-) in an invalid position",
        self::INVALID_HOSTNAME_SCHEMA => "'%value%' appears to be a DNS hostname but cannot match against hostname schema for TLD '%tld%'",
        self::UNDECIPHERABLE_TLD      => "'%value%' appears to be a DNS hostname but cannot extract TLD part",
        self::INVALID_HOSTNAME        => "'%value%' does not match the expected structure for a DNS hostname",
        self::INVALID_LOCAL_NAME      => "'%value%' does not appear to be a valid local network name",
        self::LOCAL_NAME_NOT_ALLOWED  => "'%value%' appears to be a local network name but local network names are not allowed"
    );

    /**
     * @var array
     */
    protected $_messageVariables = array(
        'tld' => '_tld'
    );

    /**
     * Allows Internet domain names (e.g., example.com)
     */
    const ALLOW_DNS   = 1;

    /**
     * Allows IP addresses
     */
    const ALLOW_IP    = 2;

    /**
     * Allows local network names (e.g., localhost, www.localdomain)
     */
    const ALLOW_LOCAL = 4;

    /**
     * Allows all types of hostnames
     */
    const ALLOW_ALL   = 7;

    /**
     * Whether IDN domains are validated
     *
     * @var boolean
     */
    private $_validateIdn = true;

    /**
     * Whether TLDs are validated against a known list
     *
     * @var boolean
     */
    private $_validateTld = true;

    /**
     * Bit field of ALLOW constants; determines which types of hostnames are allowed
     *
     * @var integer
     */
    protected $_allow;

    /**
     * Bit field of CHECK constants; determines what additional hostname checks to make
     *
     * @var unknown_type
     */
    // protected $_check;

    /**
     * Array of valid top-level-domains
     *
     * @var array
     * @see ftp://data.iana.org/TLD/tlds-alpha-by-domain.txt  List of all TLDs by domain
     */
    protected $_validTlds = array(
        'ac', 'ad', 'ae', 'aero', 'af', 'ag', 'ai', 'al', 'am', 'an', 'ao',
        'aq', 'ar', 'arpa', 'as', 'asia', 'at', 'au', 'aw', 'ax', 'az', 'ba', 'bb',
        'bd', 'be', 'bf', 'bg', 'bh', 'bi', 'biz', 'bj', 'bm', 'bn', 'bo',
        'br', 'bs', 'bt', 'bv', 'bw', 'by', 'bz', 'ca', 'cat', 'cc', 'cd',
        'cf', 'cg', 'ch', 'ci', 'ck', 'cl', 'cm', 'cn', 'co', 'com', 'coop',
        'cr', 'cu', 'cv', 'cx', 'cy', 'cz', 'de', 'dj', 'dk', 'dm', 'do',
        'dz', 'ec', 'edu', 'ee', 'eg', 'er', 'es', 'et', 'eu', 'fi', 'fj',
        'fk', 'fm', 'fo', 'fr', 'ga', 'gb', 'gd', 'ge', 'gf', 'gg', 'gh',
        'gi', 'gl', 'gm', 'gn', 'gov', 'gp', 'gq', 'gr', 'gs', 'gt', 'gu',
        'gw', 'gy', 'hk', 'hm', 'hn', 'hr', 'ht', 'hu', 'id', 'ie', 'il',
        'im', 'in', 'info', 'int', 'io', 'iq', 'ir', 'is', 'it', 'je', 'jm',
        'jo', 'jobs', 'jp', 'ke', 'kg', 'kh', 'ki', 'km', 'kn', 'kp', 'kr', 'kw',
        'ky', 'kz', 'la', 'lb', 'lc', 'li', 'lk', 'lr', 'ls', 'lt', 'lu',
        'lv', 'ly', 'ma', 'mc', 'md', 'me', 'mg', 'mh', 'mil', 'mk', 'ml', 'mm',
        'mn', 'mo', 'mobi', 'mp', 'mq', 'mr', 'ms', 'mt', 'mu', 'museum', 'mv',
        'mw', 'mx', 'my', 'mz', 'na', 'name', 'nc', 'ne', 'net', 'nf', 'ng',
        'ni', 'nl', 'no', 'np', 'nr', 'nu', 'nz', 'om', 'org', 'pa', 'pe',
        'pf', 'pg', 'ph', 'pk', 'pl', 'pm', 'pn', 'pr', 'pro', 'ps', 'pt',
        'pw', 'py', 'qa', 're', 'ro', 'rs', 'ru', 'rw', 'sa', 'sb', 'sc', 'sd',
        'se', 'sg', 'sh', 'si', 'sj', 'sk', 'sl', 'sm', 'sn', 'so', 'sr',
        'st', 'su', 'sv', 'sy', 'sz', 'tc', 'td', 'tel', 'tf', 'tg', 'th', 'tj',
        'tk', 'tl', 'tm', 'tn', 'to', 'tp', 'tr', 'travel', 'tt', 'tv', 'tw',
        'tz', 'ua', 'ug', 'uk', 'um', 'us', 'uy', 'uz', 'va', 'vc', 've',
        'vg', 'vi', 'vn', 'vu', 'wf', 'ws', 'ye', 'yt', 'yu', 'za', 'zm',
        'zw'
        );

    /**
     * @var string
     */
    protected $_tld;

    /**
     * Sets validator options
     *
     * @param integer          $allow       OPTIONAL Set what types of hostname to allow (default ALLOW_DNS)
     * @param boolean          $validateIdn OPTIONAL Set whether IDN domains are validated (default true)
     * @param boolean          $validateTld OPTIONAL Set whether the TLD element of a hostname is validated (default true)
     * @param Zend_Validate_Ip $ipValidator OPTIONAL
     * @return void
     * @see http://www.iana.org/cctld/specifications-policies-cctlds-01apr02.htm  Technical Specifications for ccTLDs
     */
    public function __construct($allow = self::ALLOW_DNS, $validateIdn = true, $validateTld = true, Zend_Validate_Ip $ipValidator = null)
    {
        // Set allow options
        $this->setAllow($allow);

        // Set validation options
        $this->_validateIdn = $validateIdn;
        $this->_validateTld = $validateTld;

        $this->setIpValidator($ipValidator);
    }

    /**
     * @param Zend_Validate_Ip $ipValidator OPTIONAL
     * @return void;
     */
    public function setIpValidator(Zend_Validate_Ip $ipValidator = null)
    {
        if ($ipValidator === null) {
            $ipValidator = new Zend_Validate_Ip();
        }
        $this->_ipValidator = $ipValidator;
    }

    /**
     * Returns the allow option
     *
     * @return integer
     */
    public function getAllow()
    {
        return $this->_allow;
    }

    /**
     * Sets the allow option
     *
     * @param  integer $allow
     * @return Zend_Validate_Hostname Provides a fluent interface
     */
    public function setAllow($allow)
    {
        $this->_allow = $allow;
        return $this;
    }

    /**
     * Set whether IDN domains are validated
     *
     * This only applies when DNS hostnames are validated
     *
     * @param boolean $allowed Set allowed to true to validate IDNs, and false to not validate them
     */
    public function setValidateIdn ($allowed)
    {
        $this->_validateIdn = (bool) $allowed;
    }

    /**
     * Set whether the TLD element of a hostname is validated
     *
     * This only applies when DNS hostnames are validated
     *
     * @param boolean $allowed Set allowed to true to validate TLDs, and false to not validate them
     */
    public function setValidateTld ($allowed)
    {
        $this->_validateTld = (bool) $allowed;
    }

    /**
     * Sets the check option
     *
     * @param  integer $check
     * @return Zend_Validate_Hostname Provides a fluent interface
     */
    /*
    public function setCheck($check)
    {
        $this->_check = $check;
        return $this;
    }
     */

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if the $value is a valid hostname with respect to the current allow option
     *
     * @param  string $value
     * @throws Zend_Validate_Exception if a fatal error occurs for validation process
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        // Check input against IP address schema
        if ($this->_ipValidator->setTranslator($this->getTranslator())->isValid($valueString)) {
            if (!($this->_allow & self::ALLOW_IP)) {
                $this->_error(self::IP_ADDRESS_NOT_ALLOWED);
                return false;
            } else{
                return true;
            }
        }

        // Check input against DNS hostname schema
        $domainParts = explode('.', $valueString);
        if ((count($domainParts) > 1) && (strlen($valueString) >= 4) && (strlen($valueString) <= 254)) {
            $status = false;

            do {
                // First check TLD
                if (preg_match('/([a-z]{2,10})$/i', end($domainParts), $matches)) {

                    reset($domainParts);

                    // Hostname characters are: *(label dot)(label dot label); max 254 chars
                    // label: id-prefix [*ldh{61} id-prefix]; max 63 chars
                    // id-prefix: alpha / digit
                    // ldh: alpha / digit / dash

                    // Match TLD against known list
                    $this->_tld = strtolower($matches[1]);
                    if ($this->_validateTld) {
                        if (!in_array($this->_tld, $this->_validTlds)) {
                            $this->_error(self::UNKNOWN_TLD);
                            $status = false;
                            break;
                        }
                    }

                    /**
                     * Match against IDN hostnames
                     * @see Zend_Validate_Hostname_Interface
                     */
                    $labelChars = 'a-z0-9';
                    $utf8 = false;
                    $classFile = 'Zend/Validate/Hostname/' . ucfirst($this->_tld) . '.php';
                    if ($this->_validateIdn) {
                        if (Zend_Loader::isReadable($classFile)) {

                            // Load additional characters
                            $className = 'Zend_Validate_Hostname_' . ucfirst($this->_tld);
                            Zend_Loader::loadClass($className);
                            $labelChars .= call_user_func(array($className, 'getCharacters'));
                            $utf8 = true;
                        }
                    }

                    // Keep label regex short to avoid issues with long patterns when matching IDN hostnames
                    $regexLabel = '/^[' . $labelChars . '\x2d]{1,63}$/i';
                    if ($utf8) {
                        $regexLabel .= 'u';
                    }

                    // Check each hostname part
                    $valid = true;
                    foreach ($domainParts as $domainPart) {

                        // Check dash (-) does not start, end or appear in 3rd and 4th positions
                        if (strpos($domainPart, '-') === 0 ||
                        (strlen($domainPart) > 2 && strpos($domainPart, '-', 2) == 2 && strpos($domainPart, '-', 3) == 3) ||
                        strrpos($domainPart, '-') === strlen($domainPart) - 1) {

                            $this->_error(self::INVALID_DASH);
                            $status = false;
                            break 2;
                        }

                        // Check each domain part
                        $status = @preg_match($regexLabel, $domainPart);
                        if ($status === false) {
                            /**
                             * Regex error
                             * @see Zend_Validate_Exception
                             */
                            require_once 'Zend/Validate/Exception.php';
                            throw new Zend_Validate_Exception('Internal error: DNS validation failed');
                        } elseif ($status === 0) {
                            $valid = false;
                        }
                    }

                    // If all labels didn't match, the hostname is invalid
                    if (!$valid) {
                        $this->_error(self::INVALID_HOSTNAME_SCHEMA);
                        $status = false;
                    }

                } else {
                    // Hostname not long enough
                    $this->_error(self::UNDECIPHERABLE_TLD);
                    $status = false;
                }
            } while (false);

            // If the input passes as an Internet domain name, and domain names are allowed, then the hostname
            // passes validation
            if ($status && ($this->_allow & self::ALLOW_DNS)) {
                return true;
            }
        } else {
            $this->_error(self::INVALID_HOSTNAME);
        }

        // Check input against local network name schema; last chance to pass validation
        $regexLocal = '/^(([a-zA-Z0-9\x2d]{1,63}\x2e)*[a-zA-Z0-9\x2d]{1,63}){1,254}$/';
        $status = @preg_match($regexLocal, $valueString);
        if (false === $status) {
            /**
             * Regex error
             * @see Zend_Validate_Exception
             */
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception('Internal error: local network name validation failed');
        }

        // If the input passes as a local network name, and local network names are allowed, then the
        // hostname passes validation
        $allowLocal = $this->_allow & self::ALLOW_LOCAL;
        if ($status && $allowLocal) {
            return true;
        }

        // If the input does not pass as a local network name, add a message
        if (!$status) {
            $this->_error(self::INVALID_LOCAL_NAME);
        }

        // If local network names are not allowed, add a message
        if ($status && !$allowLocal) {
            $this->_error(self::LOCAL_NAME_NOT_ALLOWED);
        }

        return false;
    }

    /**
     * Throws an exception if a regex for $type does not exist
     *
     * @param  string $type
     * @throws Zend_Validate_Exception
     * @return Zend_Validate_Hostname Provides a fluent interface
     */
    /*
    protected function _checkRegexType($type)
    {
        if (!isset($this->_regex[$type])) {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("'$type' must be one of ('" . implode(', ', array_keys($this->_regex))
                                            . "')");
        }
        return $this;
    }
     */

}
77   2738|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Barcode.php|a2a06291<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Barcode.php 8211 2008-02-20 14:29:24Z darby $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Barcode extends Zend_Validate_Abstract
{
    /**
     * Barcode validator
     *
     * @var Zend_Validate_Abstract
     */
    protected $_barcodeValidator;

    /**
     * Generates the standard validator object
     *
     * @param  string $barcodeType - Barcode validator to use
     * @return void
     * @throws Zend_Validate_Exception
     */
    public function __construct($barcodeType)
    {
        $this->setType($barcodeType);
    }

    /**
     * Sets a new barcode validator
     *
     * @param  string $barcodeType - Barcode validator to use
     * @return void
     * @throws Zend_Validate_Exception
     */
    public function setType($barcodeType)
    {
        switch (strtolower($barcodeType)) {
            case 'upc':
            case 'upc-a':
                $className = 'UpcA';
                break;
            case 'ean13':
            case 'ean-13':
                $className = 'Ean13';
                break;
            default:
                require_once 'Zend/Validate/Exception.php';
                throw new Zend_Validate_Exception("Barcode type '$barcodeType' is not supported'");
                break;
        }

        require_once 'Zend/Validate/Barcode/' . $className . '.php';

        $class = 'Zend_Validate_Barcode_' . $className;
        $this->_barcodeValidator = new $class;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value contains a valid barcode
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        return call_user_func(array($this->_barcodeValidator, 'isValid'), $value);
    }
}
79   2385|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Interface.php|8bce3c96<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Interface.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
interface Zend_Validate_Interface
{
    /**
     * Returns true if and only if $value meets the validation requirements
     *
     * If $value fails validation, then this method returns false, and
     * getMessages() will return an array of messages that explain why the
     * validation failed.
     *
     * @param  mixed $value
     * @return boolean
     * @throws Zend_Valid_Exception If validation of $value is impossible
     */
    public function isValid($value);

    /**
     * Returns an array of messages that explain why the most recent isValid()
     * call returned false. The array keys are validation failure message identifiers,
     * and the array values are the corresponding human-readable message strings.
     *
     * If isValid() was never called or if the most recent isValid() call
     * returned true, then this method returns an empty array.
     *
     * @return array
     */
    public function getMessages();

    /**
     * Returns an array of message codes that explain why a previous isValid() call
     * returned false.
     *
     * If isValid() was never called or if the most recent isValid() call
     * returned true, then this method returns an empty array.
     *
     * This is now the same as calling array_keys() on the return value from getMessages().
     *
     * @return array
     * @deprecated Since 1.5.0
     */
    public function getErrors();

}
77   4708|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Between.php|bc11b593<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Between.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Between extends Zend_Validate_Abstract
{
    /**
     * Validation failure message key for when the value is not between the min and max, inclusively
     */
    const NOT_BETWEEN        = 'notBetween';

    /**
     * Validation failure message key for when the value is not strictly between the min and max
     */
    const NOT_BETWEEN_STRICT = 'notBetweenStrict';

    /**
     * Validation failure message template definitions
     *
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_BETWEEN        => "'%value%' is not between '%min%' and '%max%', inclusively",
        self::NOT_BETWEEN_STRICT => "'%value%' is not strictly between '%min%' and '%max%'"
    );

    /**
     * Additional variables available for validation failure messages
     *
     * @var array
     */
    protected $_messageVariables = array(
        'min' => '_min',
        'max' => '_max'
    );

    /**
     * Minimum value
     *
     * @var mixed
     */
    protected $_min;

    /**
     * Maximum value
     *
     * @var mixed
     */
    protected $_max;

    /**
     * Whether to do inclusive comparisons, allowing equivalence to min and/or max
     *
     * If false, then strict comparisons are done, and the value may equal neither
     * the min nor max options
     *
     * @var boolean
     */
    protected $_inclusive;

    /**
     * Sets validator options
     *
     * @param  mixed   $min
     * @param  mixed   $max
     * @param  boolean $inclusive
     * @return void
     */
    public function __construct($min, $max, $inclusive = true)
    {
        $this->setMin($min)
             ->setMax($max)
             ->setInclusive($inclusive);
    }

    /**
     * Returns the min option
     *
     * @return mixed
     */
    public function getMin()
    {
        return $this->_min;
    }

    /**
     * Sets the min option
     *
     * @param  mixed $min
     * @return Zend_Validate_Between Provides a fluent interface
     */
    public function setMin($min)
    {
        $this->_min = $min;
        return $this;
    }

    /**
     * Returns the max option
     *
     * @return mixed
     */
    public function getMax()
    {
        return $this->_max;
    }

    /**
     * Sets the max option
     *
     * @param  mixed $max
     * @return Zend_Validate_Between Provides a fluent interface
     */
    public function setMax($max)
    {
        $this->_max = $max;
        return $this;
    }

    /**
     * Returns the inclusive option
     *
     * @return boolean
     */
    public function getInclusive()
    {
        return $this->_inclusive;
    }

    /**
     * Sets the inclusive option
     *
     * @param  boolean $inclusive
     * @return Zend_Validate_Between Provides a fluent interface
     */
    public function setInclusive($inclusive)
    {
        $this->_inclusive = $inclusive;
        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value is between min and max options, inclusively
     * if inclusive option is true.
     *
     * @param  mixed $value
     * @return boolean
     */
    public function isValid($value)
    {
        $this->_setValue($value);

        if ($this->_inclusive) {
            if ($this->_min > $value || $value > $this->_max) {
                $this->_error(self::NOT_BETWEEN);
                return false;
            }
        } else {
            if ($this->_min >= $value || $value >= $this->_max) {
                $this->_error(self::NOT_BETWEEN_STRICT);
                return false;
            }
        }
        return true;
    }

}
73   1966|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Int.php|d4e767ee<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Int.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Int extends Zend_Validate_Abstract
{

    const NOT_INT = 'notInt';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_INT => "'%value%' does not appear to be an integer"
    );

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value is a valid integer
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        $locale = localeconv();

        $valueFiltered = str_replace($locale['decimal_point'], '.', $valueString);
        $valueFiltered = str_replace($locale['thousands_sep'], '', $valueFiltered);

        if (strval(intval($valueFiltered)) != $valueFiltered) {
            $this->_error();
            return false;
        }

        return true;
    }

}
75   2991|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Ccnum.php|1e3d8a39<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Ccnum.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Ccnum extends Zend_Validate_Abstract
{
    /**
     * Validation failure message key for when the value is not of valid length
     */
    const LENGTH   = 'ccnumLength';

    /**
     * Validation failure message key for when the value fails the mod-10 checksum
     */
    const CHECKSUM = 'ccnumChecksum';

    /**
     * Digits filter for input
     *
     * @var Zend_Filter_Digits
     */
    protected static $_filter = null;

    /**
     * Validation failure message template definitions
     *
     * @var array
     */
    protected $_messageTemplates = array(
        self::LENGTH   => "'%value%' must contain between 13 and 19 digits",
        self::CHECKSUM => "Luhn algorithm (mod-10 checksum) failed on '%value%'"
    );

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value follows the Luhn algorithm (mod-10 checksum)
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $this->_setValue($value);

        if (null === self::$_filter) {
            /**
             * @see Zend_Filter_Digits
             */
            require_once 'Zend/Filter/Digits.php';
            self::$_filter = new Zend_Filter_Digits();
        }

        $valueFiltered = self::$_filter->filter($value);

        $length = strlen($valueFiltered);

        if ($length < 13 || $length > 19) {
            $this->_error(self::LENGTH);
            return false;
        }

        $sum    = 0;
        $weight = 2;

        for ($i = $length - 2; $i >= 0; $i--) {
            $digit = $weight * $valueFiltered[$i];
            $sum += floor($digit / 10) + $digit % 10;
            $weight = $weight % 2 + 1;
        }

        if ((10 - $sum % 10) % 10 != $valueFiltered[$length - 1]) {
            $this->_error(self::CHECKSUM, $valueFiltered);
            return false;
        }

        return true;
    }

}
75   1982|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Float.php|81025398<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Float.php 8714 2008-03-09 20:03:45Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Float extends Zend_Validate_Abstract
{

    const NOT_FLOAT = 'notFloat';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_FLOAT => "'%value%' does not appear to be a float"
    );

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value is a floating-point value
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        $locale = localeconv();

        $valueFiltered = str_replace($locale['thousands_sep'], '', $valueString);
        $valueFiltered = str_replace($locale['decimal_point'], '.', $valueFiltered);

        if (strval(floatval($valueFiltered)) != $valueFiltered) {
            $this->_error();
            return false;
        }

        return true;
    }

}
78   1927|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/NotEmpty.php|1c1dac19<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: NotEmpty.php 10356 2008-07-24 15:14:56Z matthew $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_NotEmpty extends Zend_Validate_Abstract
{

    const IS_EMPTY = 'isEmpty';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::IS_EMPTY => "Value is empty, but a non-empty value is required"
    );

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value is not an empty value.
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $this->_setValue((string) $value);

        if (is_string($value)
            && (('' === $value) 
                || preg_match('/^\s+$/s', $value))
        ) {
            $this->_error();
            return false;
        } elseif (!is_string($value) && empty($value)) {
            $this->_error();
            return false;
        }

        return true;
    }

}
78   2455|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/LessThan.php|894047e0<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: LessThan.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_LessThan extends Zend_Validate_Abstract
{

    const NOT_LESS = 'notLessThan';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_LESS => "'%value%' is not less than '%max%'"
    );

    /**
     * @var array
     */
    protected $_messageVariables = array(
        'max' => '_max'
    );

    /**
     * Maximum value
     *
     * @var mixed
     */
    protected $_max;

    /**
     * Sets validator options
     *
     * @param  mixed $max
     * @return void
     */
    public function __construct($max)
    {
        $this->setMax($max);
    }

    /**
     * Returns the max option
     *
     * @return mixed
     */
    public function getMax()
    {
        return $this->_max;
    }

    /**
     * Sets the max option
     *
     * @param  mixed $max
     * @return Zend_Validate_LessThan Provides a fluent interface
     */
    public function setMax($max)
    {
        $this->_max = $max;
        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value is less than max option
     *
     * @param  mixed $value
     * @return boolean
     */
    public function isValid($value)
    {
        $this->_setValue($value);
        if ($this->_max <= $value) {
            $this->_error();
            return false;
        }
        return true;
    }

}
77   3191|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/InArray.php|37a6aec3<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: InArray.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_InArray extends Zend_Validate_Abstract
{

    const NOT_IN_ARRAY = 'notInArray';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_IN_ARRAY => "'%value%' was not found in the haystack"
    );

    /**
     * Haystack of possible values
     *
     * @var array
     */
    protected $_haystack;

    /**
     * Whether a strict in_array() invocation is used
     *
     * @var boolean
     */
    protected $_strict;

    /**
     * Sets validator options
     *
     * @param  array   $haystack
     * @param  boolean $strict
     * @return void
     */
    public function __construct(array $haystack, $strict = false)
    {
        $this->setHaystack($haystack)
             ->setStrict($strict);
    }

    /**
     * Returns the haystack option
     *
     * @return mixed
     */
    public function getHaystack()
    {
        return $this->_haystack;
    }

    /**
     * Sets the haystack option
     *
     * @param  mixed $haystack
     * @return Zend_Validate_InArray Provides a fluent interface
     */
    public function setHaystack(array $haystack)
    {
        $this->_haystack = $haystack;
        return $this;
    }

    /**
     * Returns the strict option
     *
     * @return boolean
     */
    public function getStrict()
    {
        return $this->_strict;
    }

    /**
     * Sets the strict option
     *
     * @param  boolean $strict
     * @return Zend_Validate_InArray Provides a fluent interface
     */
    public function setStrict($strict)
    {
        $this->_strict = $strict;
        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value is contained in the haystack option. If the strict
     * option is true, then the type of $value is also checked.
     *
     * @param  mixed $value
     * @return boolean
     */
    public function isValid($value)
    {
        $this->_setValue($value);
        if (!in_array($value, $this->_haystack, $this->_strict)) {
            $this->_error();
            return false;
        }
        return true;
    }

}
79   1099|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Exception.php|8cc9cf1d<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Exception.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Exception
 */
require_once 'Zend/Exception.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Exception extends Zend_Exception
{}
81   2480|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/GreaterThan.php|e4c8ae11<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: GreaterThan.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_GreaterThan extends Zend_Validate_Abstract
{

    const NOT_GREATER = 'notGreaterThan';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_GREATER => "'%value%' is not greater than '%min%'"
    );

    /**
     * @var array
     */
    protected $_messageVariables = array(
        'min' => '_min'
    );

    /**
     * Minimum value
     *
     * @var mixed
     */
    protected $_min;

    /**
     * Sets validator options
     *
     * @param  mixed $min
     * @return void
     */
    public function __construct($min)
    {
        $this->setMin($min);
    }

    /**
     * Returns the min option
     *
     * @return mixed
     */
    public function getMin()
    {
        return $this->_min;
    }

    /**
     * Sets the min option
     *
     * @param  mixed $min
     * @return Zend_Validate_GreaterThan Provides a fluent interface
     */
    public function setMin($min)
    {
        $this->_min = $min;
        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value is greater than min option
     *
     * @param  mixed $value
     * @return boolean
     */
    public function isValid($value)
    {
        $this->_setValue($value);

        if ($this->_min >= $value) {
            $this->_error();
            return false;
        }
        return true;
    }

}
82   4597|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/StringLength.php|59ce1458<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: StringLength.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_StringLength extends Zend_Validate_Abstract
{

    const TOO_SHORT = 'stringLengthTooShort';
    const TOO_LONG  = 'stringLengthTooLong';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::TOO_SHORT => "'%value%' is less than %min% characters long",
        self::TOO_LONG  => "'%value%' is greater than %max% characters long"
    );

    /**
     * @var array
     */
    protected $_messageVariables = array(
        'min' => '_min',
        'max' => '_max'
    );

    /**
     * Minimum length
     *
     * @var integer
     */
    protected $_min;

    /**
     * Maximum length
     *
     * If null, there is no maximum length
     *
     * @var integer|null
     */
    protected $_max;

    /**
     * Sets validator options
     *
     * @param  integer $min
     * @param  integer $max
     * @return void
     */
    public function __construct($min = 0, $max = null)
    {
        $this->setMin($min);
        $this->setMax($max);
    }

    /**
     * Returns the min option
     *
     * @return integer
     */
    public function getMin()
    {
        return $this->_min;
    }

    /**
     * Sets the min option
     *
     * @param  integer $min
     * @throws Zend_Validate_Exception
     * @return Zend_Validate_StringLength Provides a fluent interface
     */
    public function setMin($min)
    {
        if (null !== $this->_max && $min > $this->_max) {
            /**
             * @see Zend_Validate_Exception
             */
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("The minimum must be less than or equal to the maximum length, but $min >"
                                            . " $this->_max");
        }
        $this->_min = max(0, (integer) $min);
        return $this;
    }

    /**
     * Returns the max option
     *
     * @return integer|null
     */
    public function getMax()
    {
        return $this->_max;
    }

    /**
     * Sets the max option
     *
     * @param  integer|null $max
     * @throws Zend_Validate_Exception
     * @return Zend_Validate_StringLength Provides a fluent interface
     */
    public function setMax($max)
    {
        if (null === $max) {
            $this->_max = null;
        } else if ($max < $this->_min) {
            /**
             * @see Zend_Validate_Exception
             */
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("The maximum must be greater than or equal to the minimum length, but "
                                            . "$max < $this->_min");
        } else {
            $this->_max = (integer) $max;
        }

        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if the string length of $value is at least the min option and
     * no greater than the max option (when the max option is not null).
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;
        $this->_setValue($valueString);
        $length = iconv_strlen($valueString);
        if ($length < $this->_min) {
            $this->_error(self::TOO_SHORT);
        }
        if (null !== $this->_max && $this->_max < $length) {
            $this->_error(self::TOO_LONG);
        }
        if (count($this->_messages)) {
            return false;
        } else {
            return true;
        }
    }

}
75   3166|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Alnum.php|4cb508cc<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Alnum.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Alnum extends Zend_Validate_Abstract
{
    /**
     * Validation failure message key for when the value contains non-alphabetic or non-digit characters
     */
    const NOT_ALNUM = 'notAlnum';

    /**
     * Validation failure message key for when the value is an empty string
     */
    const STRING_EMPTY = 'stringEmpty';

    /**
     * Whether to allow white space characters; off by default
     *
     * @var boolean
     */
    public $allowWhiteSpace;

    /**
     * Alphanumeric filter used for validation
     *
     * @var Zend_Filter_Alnum
     */
    protected static $_filter = null;

    /**
     * Validation failure message template definitions
     *
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_ALNUM    => "'%value%' has not only alphabetic and digit characters",
        self::STRING_EMPTY => "'%value%' is an empty string"
    );

    /**
     * Sets default option values for this instance
     *
     * @param  boolean $allowWhiteSpace
     * @return void
     */
    public function __construct($allowWhiteSpace = false)
    {
        $this->allowWhiteSpace = (boolean) $allowWhiteSpace;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value contains only alphabetic and digit characters
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        if ('' === $valueString) {
            $this->_error(self::STRING_EMPTY);
            return false;
        }

        if (null === self::$_filter) {
            /**
             * @see Zend_Filter_Alnum
             */
            require_once 'Zend/Filter/Alnum.php';
            self::$_filter = new Zend_Filter_Alnum();
        }

        self::$_filter->allowWhiteSpace = $this->allowWhiteSpace;

        if ($valueString !== self::$_filter->filter($valueString)) {
            $this->_error(self::NOT_ALNUM);
            return false;
        }

        return true;
    }

}
75   3056|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Regex.php|b1a1affc<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Regex.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Regex extends Zend_Validate_Abstract
{

    const NOT_MATCH = 'regexNotMatch';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_MATCH => "'%value%' does not match against pattern '%pattern%'"
    );

    /**
     * @var array
     */
    protected $_messageVariables = array(
        'pattern' => '_pattern'
    );

    /**
     * Regular expression pattern
     *
     * @var string
     */
    protected $_pattern;

    /**
     * Sets validator options
     *
     * @param  string $pattern
     * @return void
     */
    public function __construct($pattern)
    {
        $this->setPattern($pattern);
    }

    /**
     * Returns the pattern option
     *
     * @return string
     */
    public function getPattern()
    {
        return $this->_pattern;
    }

    /**
     * Sets the pattern option
     *
     * @param  string $pattern
     * @return Zend_Validate_Regex Provides a fluent interface
     */
    public function setPattern($pattern)
    {
        $this->_pattern = (string) $pattern;
        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value matches against the pattern option
     *
     * @param  string $value
     * @throws Zend_Validate_Exception if there is a fatal error in pattern matching
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        $status = @preg_match($this->_pattern, $valueString);
        if (false === $status) {
            /**
             * @see Zend_Validate_Exception
             */
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("Internal error matching pattern '$this->_pattern' against value '$valueString'");
        }
        if (!$status) {
            $this->_error();
            return false;
        }
        return true;
    }

}
82   8360|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/EmailAddress.php|5c3881ad<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: EmailAddress.php 8985 2008-03-21 21:37:24Z matthew $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @see Zend_Validate_Hostname
 */
require_once 'Zend/Validate/Hostname.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_EmailAddress extends Zend_Validate_Abstract
{

    const INVALID            = 'emailAddressInvalid';
    const INVALID_HOSTNAME   = 'emailAddressInvalidHostname';
    const INVALID_MX_RECORD  = 'emailAddressInvalidMxRecord';
    const DOT_ATOM           = 'emailAddressDotAtom';
    const QUOTED_STRING      = 'emailAddressQuotedString';
    const INVALID_LOCAL_PART = 'emailAddressInvalidLocalPart';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::INVALID            => "'%value%' is not a valid email address in the basic format local-part@hostname",
        self::INVALID_HOSTNAME   => "'%hostname%' is not a valid hostname for email address '%value%'",
        self::INVALID_MX_RECORD  => "'%hostname%' does not appear to have a valid MX record for the email address '%value%'",
        self::DOT_ATOM           => "'%localPart%' not matched against dot-atom format",
        self::QUOTED_STRING      => "'%localPart%' not matched against quoted-string format",
        self::INVALID_LOCAL_PART => "'%localPart%' is not a valid local part for email address '%value%'"
    );

    /**
     * @var array
     */
    protected $_messageVariables = array(
        'hostname'  => '_hostname',
        'localPart' => '_localPart'
    );

    /**
     * Local object for validating the hostname part of an email address
     *
     * @var Zend_Validate_Hostname
     */
    public $hostnameValidator;

    /**
     * Whether we check for a valid MX record via DNS
     *
     * @var boolean
     */
    protected $_validateMx = false;

    /**
     * @var string
     */
    protected $_hostname;

    /**
     * @var string
     */
    protected $_localPart;

    /**
     * Instantiates hostname validator for local use
     *
     * You can pass a bitfield to determine what types of hostnames are allowed.
     * These bitfields are defined by the ALLOW_* constants in Zend_Validate_Hostname
     * The default is to allow DNS hostnames only
     *
     * @param integer                $allow             OPTIONAL
     * @param bool                   $validateMx        OPTIONAL
     * @param Zend_Validate_Hostname $hostnameValidator OPTIONAL
     * @return void
     */
    public function __construct($allow = Zend_Validate_Hostname::ALLOW_DNS, $validateMx = false, Zend_Validate_Hostname $hostnameValidator = null)
    {
        $this->setValidateMx($validateMx);
        $this->setHostnameValidator($hostnameValidator, $allow);
    }

    /**
     * @param Zend_Validate_Hostname $hostnameValidator OPTIONAL
     * @param int                    $allow             OPTIONAL
     * @return void
     */
    public function setHostnameValidator(Zend_Validate_Hostname $hostnameValidator = null, $allow = Zend_Validate_Hostname::ALLOW_DNS)
    {
        if ($hostnameValidator === null) {
            $hostnameValidator = new Zend_Validate_Hostname($allow);
        }
        $this->hostnameValidator = $hostnameValidator;
    }

    /**
     * Whether MX checking via dns_get_mx is supported or not
     *
     * This currently only works on UNIX systems
     *
     * @return boolean
     */
    public function validateMxSupported()
    {
        return function_exists('dns_get_mx');
    }

    /**
     * Set whether we check for a valid MX record via DNS
     *
     * This only applies when DNS hostnames are validated
     *
     * @param boolean $allowed Set allowed to true to validate for MX records, and false to not validate them
     */
    public function setValidateMx($allowed)
    {
        $this->_validateMx = (bool) $allowed;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value is a valid email address
     * according to RFC2822
     *
     * @link   http://www.ietf.org/rfc/rfc2822.txt RFC2822
     * @link   http://www.columbia.edu/kermit/ascii.html US-ASCII characters
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        // Split email address up
        if (!preg_match('/^(.+)@([^@]+)$/', $valueString, $matches)) {
            $this->_error(self::INVALID);
            return false;
        }

        $this->_localPart = $matches[1];
        $this->_hostname  = $matches[2];

        // Match hostname part
        $hostnameResult = $this->hostnameValidator->setTranslator($this->getTranslator())
                               ->isValid($this->_hostname);
        if (!$hostnameResult) {
            $this->_error(self::INVALID_HOSTNAME);

            // Get messages and errors from hostnameValidator
            foreach ($this->hostnameValidator->getMessages() as $message) {
                $this->_messages[] = $message;
            }
            foreach ($this->hostnameValidator->getErrors() as $error) {
                $this->_errors[] = $error;
            }
        }

        // MX check on hostname via dns_get_record()
        if ($this->_validateMx) {
            if ($this->validateMxSupported()) {
                $result = dns_get_mx($this->_hostname, $mxHosts);
                if (count($mxHosts) < 1) {
                    $hostnameResult = false;
                    $this->_error(self::INVALID_MX_RECORD);
                }
            } else {
                /**
                 * MX checks are not supported by this system
                 * @see Zend_Validate_Exception
                 */
                require_once 'Zend/Validate/Exception.php';
                throw new Zend_Validate_Exception('Internal error: MX checking not available on this system');
            }
        }

        // First try to match the local part on the common dot-atom format
        $localResult = false;

        // Dot-atom characters are: 1*atext *("." 1*atext)
        // atext: ALPHA / DIGIT / and "!", "#", "$", "%", "&", "'", "*",
        //        "-", "/", "=", "?", "^", "_", "`", "{", "|", "}", "~"
        $atext = 'a-zA-Z0-9\x21\x23\x24\x25\x26\x27\x2a\x2b\x2d\x2f\x3d\x3f\x5e\x5f\x60\x7b\x7c\x7d';
        if (preg_match('/^[' . $atext . ']+(\x2e+[' . $atext . ']+)*$/', $this->_localPart)) {
            $localResult = true;
        } else {
            // Try quoted string format

            // Quoted-string characters are: DQUOTE *([FWS] qtext/quoted-pair) [FWS] DQUOTE
            // qtext: Non white space controls, and the rest of the US-ASCII characters not
            //   including "\" or the quote character
            $noWsCtl    = '\x01-\x08\x0b\x0c\x0e-\x1f\x7f';
            $qtext      = $noWsCtl . '\x21\x23-\x5b\x5d-\x7e';
            $ws         = '\x20\x09';
            if (preg_match('/^\x22([' . $ws . $qtext . '])*[$ws]?\x22$/', $this->_localPart)) {
                $localResult = true;
            } else {
                $this->_error(self::DOT_ATOM);
                $this->_error(self::QUOTED_STRING);
                $this->_error(self::INVALID_LOCAL_PART);
            }
        }

        // If both parts valid, return true
        if ($localResult && $hostnameResult) {
            return true;
        } else {
            return false;
        }
    }

}
73   1961|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hex.php|874b3a67<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Hex.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Hex extends Zend_Validate_Abstract
{
    /**
     * Validation failure message key for when the value contains characters other than hexadecimal digits
     */
    const NOT_HEX = 'notHex';

    /**
     * Validation failure message template definitions
     *
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_HEX => "'%value%' has not only hexadecimal digit characters"
    );

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value contains only hexadecimal digit characters
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        if (!ctype_xdigit($valueString)) {
            $this->_error();
            return false;
        }

        return true;
    }

}
78   9975|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Abstract.php|20e19585<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Abstract.php 10648 2008-08-04 20:58:06Z matthew $
 */


/**
 * @see Zend_Validate_Interface
 */
require_once 'Zend/Validate/Interface.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
abstract class Zend_Validate_Abstract implements Zend_Validate_Interface
{
    /**
     * The value to be validated
     *
     * @var mixed
     */
    protected $_value;

    /**
     * Additional variables available for validation failure messages
     *
     * @var array
     */
    protected $_messageVariables = array();

    /**
     * Validation failure message template definitions
     *
     * @var array
     */
    protected $_messageTemplates = array();

    /**
     * Array of validation failure messages
     *
     * @var array
     */
    protected $_messages = array();

    /**
     * Flag indidcating whether or not value should be obfuscated in error 
     * messages
     * @var bool
     */
    protected $_obscureValue = false;

    /**
     * Array of validation failure message codes
     *
     * @var array
     * @deprecated Since 1.5.0
     */
    protected $_errors = array();

    /**
     * Translation object
     * @var Zend_Translate
     */
    protected $_translator;

    /**
     * Default translation object for all validate objects
     * @var Zend_Translate
     */
    protected static $_defaultTranslator;

    /**
     * Returns array of validation failure messages
     *
     * @return array
     */
    public function getMessages()
    {
        return $this->_messages;
    }

    /**
     * Returns an array of the names of variables that are used in constructing validation failure messages
     *
     * @return array
     */
    public function getMessageVariables()
    {
        return array_keys($this->_messageVariables);
    }

    /**
     * Sets the validation failure message template for a particular key
     *
     * @param  string $messageString
     * @param  string $messageKey     OPTIONAL
     * @return Zend_Validate_Abstract Provides a fluent interface
     * @throws Zend_Validate_Exception
     */
    public function setMessage($messageString, $messageKey = null)
    {
        if ($messageKey === null) {
            $keys = array_keys($this->_messageTemplates);
            $messageKey = current($keys);
        }
        if (!isset($this->_messageTemplates[$messageKey])) {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("No message template exists for key '$messageKey'");
        }
        $this->_messageTemplates[$messageKey] = $messageString;
        return $this;
    }

    /**
     * Sets validation failure message templates given as an array, where the array keys are the message keys,
     * and the array values are the message template strings.
     *
     * @param  array $messages
     * @return Zend_Validate_Abstract
     */
    public function setMessages(array $messages)
    {
        foreach ($messages as $key => $message) {
            $this->setMessage($message, $key);
        }
        return $this;
    }

    /**
     * Magic function returns the value of the requested property, if and only if it is the value or a
     * message variable.
     *
     * @param  string $property
     * @return mixed
     * @throws Zend_Validate_Exception
     */
    public function __get($property)
    {
        if ($property == 'value') {
            return $this->_value;
        }
        if (array_key_exists($property, $this->_messageVariables)) {
            return $this->{$this->_messageVariables[$property]};
        }
        /**
         * @see Zend_Validate_Exception
         */
        require_once 'Zend/Validate/Exception.php';
        throw new Zend_Validate_Exception("No property exists by the name '$property'");
    }

    /**
     * Constructs and returns a validation failure message with the given message key and value.
     *
     * Returns null if and only if $messageKey does not correspond to an existing template.
     *
     * If a translator is available and a translation exists for $messageKey, 
     * the translation will be used.
     *
     * @param  string $messageKey
     * @param  string $value
     * @return string
     */
    protected function _createMessage($messageKey, $value)
    {
        if (!isset($this->_messageTemplates[$messageKey])) {
            return null;
        }

        $message = $this->_messageTemplates[$messageKey];

        if (null !== ($translator = $this->getTranslator())) {
            if ($translator->isTranslated($message)) {
                $message = $translator->translate($message);
            } elseif ($translator->isTranslated($messageKey)) {
                $message = $translator->translate($messageKey);
            }
        }

        if ($this->getObscureValue()) {
            $value = str_repeat('*', strlen($value));
        }

        $message = str_replace('%value%', (string) $value, $message);
        foreach ($this->_messageVariables as $ident => $property) {
            $message = str_replace("%$ident%", $this->$property, $message);
        }
        return $message;
    }

    /**
     * @param  string $messageKey OPTIONAL
     * @param  string $value      OPTIONAL
     * @return void
     */
    protected function _error($messageKey = null, $value = null)
    {
        if ($messageKey === null) {
            $keys = array_keys($this->_messageTemplates);
            $messageKey = current($keys);
        }
        if ($value === null) {
            $value = $this->_value;
        }
        $this->_errors[]              = $messageKey;
        $this->_messages[$messageKey] = $this->_createMessage($messageKey, $value);
    }

    /**
     * Sets the value to be validated and clears the messages and errors arrays
     *
     * @param  mixed $value
     * @return void
     */
    protected function _setValue($value)
    {
        $this->_value    = $value;
        $this->_messages = array();
        $this->_errors   = array();
    }

    /**
     * Returns array of validation failure message codes
     *
     * @return array
     * @deprecated Since 1.5.0
     */
    public function getErrors()
    {
        return $this->_errors;
    }

    /**
     * Set flag indicating whether or not value should be obfuscated in messages
     * 
     * @param  bool $flag 
     * @return Zend_Validate_Abstract
     */
    public function setObscureValue($flag)
    {
        $this->_obscureValue = (bool) $flag;
        return $this;
    }

    /**
     * Retrieve flag indicating whether or not value should be obfuscated in 
     * messages
     * 
     * @return bool
     */
    public function getObscureValue()
    {
        return $this->_obscureValue;
    }

    /**
     * Set translation object
     * 
     * @param  Zend_Translate|Zend_Translate_Adapter|null $translator 
     * @return Zend_Validate_Abstract
     */
    public function setTranslator($translator = null)
    {
        if ((null === $translator) || ($translator instanceof Zend_Translate_Adapter)) {
            $this->_translator = $translator;
        } elseif ($translator instanceof Zend_Translate) {
            $this->_translator = $translator->getAdapter();
        } else {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception('Invalid translator specified');
        }
        return $this;
    }

    /**
     * Return translation object
     * 
     * @return Zend_Translate_Adapter|null
     */
    public function getTranslator()
    {
        if (null === $this->_translator) {
            return self::getDefaultTranslator();
        }

        return $this->_translator;
    }

    /**
     * Set default translation object for all validate objects
     * 
     * @param  Zend_Translate|Zend_Translate_Adapter|null $translator 
     * @return void
     */
    public static function setDefaultTranslator($translator = null)
    {
        if ((null === $translator) || ($translator instanceof Zend_Translate_Adapter)) {
            self::$_defaultTranslator = $translator;
        } elseif ($translator instanceof Zend_Translate) {
            self::$_defaultTranslator = $translator->getAdapter();
        } else {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception('Invalid translator specified');
        }
    }

    /**
     * Get default translation object for all validate objects
     * 
     * @return Zend_Translate_Adapter|null
     */
    public static function getDefaultTranslator()
    {
        if (null === self::$_defaultTranslator) {
            require_once 'Zend/Registry.php';
            if (Zend_Registry::isRegistered('Zend_Translate')) {
                $translator = Zend_Registry::get('Zend_Translate');
                if ($translator instanceof Zend_Translate_Adapter) {
                    return $translator;
                } elseif ($translator instanceof Zend_Translate) {
                    return $translator->getAdapter();
                }
            }
        }
        return self::$_defaultTranslator;
    }
}
79   2834|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Identical.php|7dfe2ded<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Identical.php 8118 2008-02-18 16:10:32Z matthew $
 */

/** Zend_Validate_Abstract */
require_once 'Zend/Validate/Abstract.php';

/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Identical extends Zend_Validate_Abstract
{
    /**#@+
     * Error codes
     * @const string
     */
    const NOT_SAME      = 'notSame';
    const MISSING_TOKEN = 'missingToken';
    /**#@-*/

    /**
     * Error messages
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_SAME      => 'Tokens do not match',
        self::MISSING_TOKEN => 'No token was provided to match against',
    );

    /**
     * Original token against which to validate
     * @var string
     */
    protected $_token;

    /**
     * Sets validator options
     *
     * @param  string $token
     * @return void
     */
    public function __construct($token = null)
    {
        if (null !== $token) {
            $this->setToken($token);
        }
    }

    /**
     * Set token against which to compare
     * 
     * @param  string $token 
     * @return Zend_Validate_Identical
     */
    public function setToken($token)
    {
        $this->_token = (string) $token;
        return $this;
    }

    /**
     * Retrieve token
     * 
     * @return string
     */
    public function getToken()
    {
        return $this->_token;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if a token has been set and the provided value 
     * matches that token.
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $this->_setValue($value);
        $token = $this->getToken();

        if (empty($token)) {
            $this->_error(self::MISSING_TOKEN);
            return false;
        }

        if ($value !== $token)  {
            $this->_error(self::NOT_SAME);
            return false;
        }

        return true;
    }
}
75   3131|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Alpha.php|8abc1275<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Alpha.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Alpha extends Zend_Validate_Abstract
{
    /**
     * Validation failure message key for when the value contains non-alphabetic characters
     */
    const NOT_ALPHA = 'notAlpha';

    /**
     * Validation failure message key for when the value is an empty string
     */
    const STRING_EMPTY = 'stringEmpty';

    /**
     * Whether to allow white space characters; off by default
     *
     * @var boolean
     */
    public $allowWhiteSpace;

    /**
     * Alphabetic filter used for validation
     *
     * @var Zend_Filter_Alpha
     */
    protected static $_filter = null;

    /**
     * Validation failure message template definitions
     *
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_ALPHA    => "'%value%' has not only alphabetic characters",
        self::STRING_EMPTY => "'%value%' is an empty string"
    );

    /**
     * Sets default option values for this instance
     *
     * @param  boolean $allowWhiteSpace
     * @return void
     */
    public function __construct($allowWhiteSpace = false)
    {
        $this->allowWhiteSpace = (boolean) $allowWhiteSpace;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value contains only alphabetic characters
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        if ('' === $valueString) {
            $this->_error(self::STRING_EMPTY);
            return false;
        }

        if (null === self::$_filter) {
            /**
             * @see Zend_Filter_Alpha
             */
            require_once 'Zend/Filter/Alpha.php';
            self::$_filter = new Zend_Filter_Alpha();
        }

        self::$_filter->allowWhiteSpace = $this->allowWhiteSpace;

        if ($valueString !== self::$_filter->filter($valueString)) {
            $this->_error(self::NOT_ALPHA);
            return false;
        }

        return true;
    }

}
76   2656|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Digits.php|ce75e0b0<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Digits.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Digits extends Zend_Validate_Abstract
{
    /**
     * Validation failure message key for when the value contains non-digit characters
     */
    const NOT_DIGITS = 'notDigits';

    /**
     * Validation failure message key for when the value is an empty string
     */
    const STRING_EMPTY = 'stringEmpty';

    /**
     * Digits filter used for validation
     *
     * @var Zend_Filter_Digits
     */
    protected static $_filter = null;

    /**
     * Validation failure message template definitions
     *
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_DIGITS   => "'%value%' contains not only digit characters",
        self::STRING_EMPTY => "'%value%' is an empty string"
    );

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value only contains digit characters
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        if ('' === $valueString) {
            $this->_error(self::STRING_EMPTY);
            return false;
        }

        if (null === self::$_filter) {
            /**
             * @see Zend_Filter_Digits
             */
            require_once 'Zend/Filter/Digits.php';
            self::$_filter = new Zend_Filter_Digits();
        }

        if ($valueString !== self::$_filter->filter($valueString)) {
            $this->_error(self::NOT_DIGITS);
            return false;
        }

        return true;
    }

}
72   1776|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Ip.php|45493542<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Ip.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Ip extends Zend_Validate_Abstract
{

    const NOT_IP_ADDRESS = 'notIpAddress';

    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::NOT_IP_ADDRESS => "'%value%' does not appear to be a valid IP address"
    );

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value is a valid IP address
     *
     * @param  mixed $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;

        $this->_setValue($valueString);

        if (ip2long($valueString) === false) {
            $this->_error();
            return false;
        }

        return true;
    }

}
83   2734|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Barcode/Ean13.php|b735b29b<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Ean13.php 8210 2008-02-20 14:09:05Z andries $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Barcode_Ean13 extends Zend_Validate_Abstract
{
    /**
     * Validation failure message key for when the value is
     * an invalid barcode
     */
    const INVALID = 'invalid';

    /**
     * Validation failure message key for when the value is
     * not 13 characters long
     */
    const INVALID_LENGTH = 'invalidLength';

    /**
     * Validation failure message template definitions
     *
     * @var array
     */
    protected $_messageTemplates = array(
        self::INVALID        => "'%value%' is an invalid EAN-13 barcode",
        self::INVALID_LENGTH => "'%value%' should be 13 characters",
    );

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value contains a valid barcode
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;
        $this->_setValue($valueString);

        if (strlen($valueString) !== 13) {
            $this->_error(self::INVALID_LENGTH);
            return false;
        }

        $barcode = strrev(substr($valueString, 0, -1));
        $oddSum  = 0;
        $evenSum = 0;

        for ($i = 0; $i < 12; $i++) {
            if ($i % 2 === 0) {
                $oddSum += $barcode[$i] * 3;
            } elseif ($i % 2 === 1) {
                $evenSum += $barcode[$i];
            }
        }

        $calculation = ($oddSum + $evenSum) % 10;
        $checksum    = ($calculation === 0) ? 0 : 10 - $calculation;

        if ($valueString[12] != $checksum) {
            $this->_error(self::INVALID);
            return false;
        }

        return true;
    }
}
82   2723|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Barcode/UpcA.php|db29956a<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: UpcA.php 8210 2008-02-20 14:09:05Z andries $
 */


/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Barcode_UpcA extends Zend_Validate_Abstract
{
    /**
     * Validation failure message key for when the value is
     * an invalid barcode
     */
    const INVALID = 'invalid';

    /**
     * Validation failure message key for when the value is
     * not 12 characters long
     */
    const INVALID_LENGTH = 'invalidLength';

    /**
     * Validation failure message template definitions
     *
     * @var array
     */
    protected $_messageTemplates = array(
        self::INVALID        => "'%value%' is an invalid UPC-A barcode",
        self::INVALID_LENGTH => "'%value%' should be 12 characters",
    );

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if $value contains a valid barcode
     *
     * @param  string $value
     * @return boolean
     */
    public function isValid($value)
    {
        $valueString = (string) $value;
        $this->_setValue($valueString);

        if (strlen($valueString) !== 12) {
            $this->_error(self::INVALID_LENGTH);
            return false;
        }

        $barcode = substr($valueString, 0, -1);
        $oddSum  = 0;
        $evenSum = 0;

        for ($i = 0; $i < 11; $i++) {
            if ($i % 2 === 0) {
                $oddSum += $barcode[$i] * 3;
            } elseif ($i % 2 === 1) {
                $evenSum += $barcode[$i];
            }
        }

        $calculation = ($oddSum + $evenSum) % 10;
        $checksum    = ($calculation === 0) ? 0 : 10 - $calculation;

        if ($valueString[11] != $checksum) {
            $this->_error(self::INVALID);
            return false;
        }

        return true;
    }
}
84   5513|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/File/Extension.php|1ccd21a0<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: $
 */

/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';

/**
 * Validator for the file extension of a file
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_File_Extension extends Zend_Validate_Abstract
{
    /**
     * @const string Error constants
     */
    const FALSE_EXTENSION = 'fileExtensionFalse';
    const NOT_FOUND       = 'fileExtensionNotFound';

    /**
     * @var array Error message templates
     */
    protected $_messageTemplates = array(
        self::FALSE_EXTENSION => "The file '%value%' has a false extension",
        self::NOT_FOUND       => "The file '%value%' was not found"
    );

    /**
     * Internal list of extensions
     * @var string
     */
    protected $_extension = '';

    /**
     * Validate case sensitive
     *
     * @var boolean
     */
    protected $_case = false;

    /**
     * @var array Error message template variables
     */
    protected $_messageVariables = array(
        'extension' => '_extension'
    );

    /**
     * Sets validator options
     *
     * @param  string|array $extension
     * @param  boolean      $case      If true validation is done case sensitive
     * @return void
     */
    public function __construct($extension, $case = false)
    {
        $this->_case = (boolean) $case;
        $this->setExtension($extension);
    }

    /**
     * Returns the set file extension
     *
     * @param  boolean $asArray Returns the values as array, when false an concated string is returned
     * @return string
     */
    public function getExtension($asArray = false)
    {
        $asArray   = (bool) $asArray;
        $extension = (string) $this->_extension;
        if ($asArray) {
            $extension = explode(',', $extension);
        }

        return $extension;
    }

    /**
     * Sets the file extensions
     *
     * @param  string|array $extension The extensions to validate
     * @return Zend_Validate_File_Extension Provides a fluent interface
     */
    public function setExtension($extension)
    {
        $this->_extension = null;
        $this->addExtension($extension);
        return $this;
    }

    /**
     * Adds the file extensions
     *
     * @param  string|array $extension The extensions to add for validation
     * @return Zend_Validate_File_Extension Provides a fluent interface
     */
    public function addExtension($extension)
    {
        $extensions = $this->getExtension(true);
        if (is_string($extension)) {
            $extension = explode(',', $extension);
        }

        foreach ($extension as $content) {
            if (empty($content) || !is_string($content)) {
                continue;
            }

            $extensions[] = trim($content);
        }
        $extensions = array_unique($extensions);

        // Sanity check to ensure no empty values
        foreach ($extensions as $key => $ext) {
            if (empty($ext)) {
                unset($extensions[$key]);
            }
        }

        $this->_extension = implode(',', $extensions);

        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if the fileextension of $value is included in the
     * set extension list
     *
     * @param  string  $value Real file to check for extension
     * @param  array   $file  File data from Zend_File_Transfer
     * @return boolean
     */
    public function isValid($value, $file = null)
    {
        // Is file readable ?
        if (!@is_readable($value)) {
            $this->_throw($file, self::NOT_FOUND);
            return false;
        }

        if ($file !== null) {
            $info['extension'] = substr($file['name'], strpos($file['name'], '.') + 1);
        } else {
            $info = @pathinfo($value);
        }

        $extensions = $this->getExtension(true);

        if ($this->_case and (in_array($info['extension'], $extensions))) {
            return true;
        } else if (!$this->_case) {
            foreach ($extensions as $extension) {
                if (strtolower($extension) == strtolower($info['extension'])) {
                    return true;
                }
            }
        }

        $this->_throw($file, self::FALSE_EXTENSION);
        return false;
    }

    /**
     * Throws an error of the given type
     *
     * @param  string $file
     * @param  string $errorType
     * @return false
     */
    protected function _throw($file, $errorType)
    {
        if ($file !== null) {
            $this->_value = $file['name'];
        }

        $this->_error($errorType);
        return false;
    }
}
84   4330|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/File/FilesSize.php|5050af40<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: $
 */

/**
 * @see Zend_Validate_File_Size
 */
require_once 'Zend/Validate/File/Size.php';

/**
 * Validator for the size of all files which will be validated in sum
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_File_FilesSize extends Zend_Validate_File_Size
{
    /**
     * @const string Error constants
     */
    const TOO_BIG      = 'fileFilesSizeTooBig';
    const TOO_SMALL    = 'fileFilesSizeTooSmall';
    const NOT_READABLE = 'fileFilesSizeNotReadable';

    /**
     * @var array Error message templates
     */
    protected $_messageTemplates = array(
        self::TOO_BIG      => "The files in sum exceed the maximum allowed size",
        self::TOO_SMALL    => "All files are in sum smaller than required",
        self::NOT_READABLE => "One or more files can not be read"
    );

    /**
     * @var array Error message template variables
     */
    protected $_messageVariables = array(
        'min' => '_min',
        'max' => '_max'
    );

    /**
     * Minimum filesize
     *
     * @var integer
     */
    protected $_min;

    /**
     * Maximum filesize
     *
     * @var integer|null
     */
    protected $_max;

    /**
     * Internal file array
     *
     * @var array
     */
    protected $_files;

    /**
     * Internal file size counter
     *
     * @var integer
     */
    protected $_size;

    /**
     * Sets validator options
     *
     * Min limits the used diskspace for all files, when used with max=null it is the maximum filesize
     * It also accepts an array with the keys 'min' and 'max'
     *
     * @param  integer|array $min Minimum diskspace for all files
     * @param  integer       $max Maximum diskspace for all files
     * @return void
     */
    public function __construct($min, $max = null)
    {
        $this->_files = array();
        $this->_size  = 0;
        parent::__construct($min, $max);
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if the disk usage of all files is at least min and
     * not bigger than max (when max is not null).
     *
     * @param  string|array $value Real file to check for size
     * @param  array        $file  File data from Zend_File_Transfer
     * @return boolean
     */
    public function isValid($value, $file = null)
    {
        if (is_string($value)) {
            $value = array($value);
        }

        foreach ($value as $files) {
            // Is file readable ?
            if (!@is_readable($files)) {
                $this->_throw($file, self::NOT_READABLE);
                return false;
            }

            if (!isset($this->_files[$files])) {
                $this->_files[$files] = $files;
            } else {
                // file already counted... do not count twice
                continue;
            }

            // limited to 2GB files
            $size         = @filesize($files);
            $this->_size += $size;
            $this->_setValue($this->_size);
            if (($this->_max !== null) && ($this->_max < $this->_size)) {
                $this->_throw($file, self::TOO_BIG);
            }
        }

        // Check that aggregate files are >= minimum size
        if (($this->_min !== null) && ($this->_size < $this->_min)) {
            $this->_throw($file, self::TOO_SMALL);
        }

        if (count($this->_messages) > 0) {
            return false;
        } else {
            return true;
        }
    }
}
81   5182|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/File/Exists.php|ac50dbe5<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: $
 */

/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';

/**
 * Validator which checks if the file already exists in the directory
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_File_Exists extends Zend_Validate_Abstract
{
    /**
     * @const string Error constants
     */
    const DOES_NOT_EXIST = 'fileExistsDoesNotExist';

    /**
     * @var array Error message templates
     */
    protected $_messageTemplates = array(
        self::DOES_NOT_EXIST => "The file '%value%' does not exist"
    );

    /**
     * Internal list of directories
     * @var string
     */
    protected $_directory = '';

    /**
     * @var array Error message template variables
     */
    protected $_messageVariables = array(
        'directory' => '_directory'
    );

    /**
     * Sets validator options
     *
     * @param  string|array $directory
     * @return void
     */
    public function __construct($directory = array())
    {
        $this->setDirectory($directory);
    }

    /**
     * Returns the set file directories which are checked
     *
     * @param  boolean $asArray Returns the values as array, when false an concated string is returned
     * @return string
     */
    public function getDirectory($asArray = false)
    {
        $asArray   = (bool) $asArray;
        $directory = (string) $this->_directory;
        if ($asArray) {
            $directory = explode(',', $directory);
        }

        return $directory;
    }

    /**
     * Sets the file directory which will be checked
     *
     * @param  string|array $directory The directories to validate
     * @return Zend_Validate_File_Extension Provides a fluent interface
     */
    public function setDirectory($directory)
    {
        $this->_directory = null;
        $this->addDirectory($directory);
        return $this;
    }

    /**
     * Adds the file directory which will be checked
     *
     * @param  string|array $directory The directory to add for validation
     * @return Zend_Validate_File_Extension Provides a fluent interface
     */
    public function addDirectory($directory)
    {
        $directories = $this->getDirectory(true);
        if (is_string($directory)) {
            $directory = explode(',', $directory);
        }

        foreach ($directory as $content) {
            if (empty($content) || !is_string($content)) {
                continue;
            }

            $directories[] = trim($content);
        }
        $directories = array_unique($directories);

        // Sanity check to ensure no empty values
        foreach ($directories as $key => $dir) {
            if (empty($dir)) {
                unset($directories[$key]);
            }
        }

        $this->_directory = implode(',', $directories);

        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if the file already exists in the set directories
     *
     * @param  string  $value Real file to check for existance
     * @param  array   $file  File data from Zend_File_Transfer
     * @return boolean
     */
    public function isValid($value, $file = null)
    {
        $directories = $this->getDirectory(true);
        if (($file !== null) and (!empty($file['destination']))) {
            $directories[] = $file['destination'];
        } else if (!isset($file['name'])) {
            $file['name'] = $value;
        }

        $check = false;
        foreach ($directories as $directory) {
            if (empty($directory)) {
                continue;
            }

            $check = true;
            if (!file_exists($directory . DIRECTORY_SEPARATOR . $file['name'])) {
                $this->_throw($file, self::DOES_NOT_EXIST);
                return false; 
            }
        }

        if (!$check) {
            $this->_throw($file, self::DOES_NOT_EXIST);
            return false;
        }

        return true;
    }

    /**
     * Throws an error of the given type
     *
     * @param  string $file
     * @param  string $errorType
     * @return false
     */
    protected function _throw($file, $errorType)
    {
        if ($file !== null) {
            $this->_value = $file['name'];
        }

        $this->_error($errorType);
        return false;
    }
}
83   5352|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/File/MimeType.php|d5ad0227<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: $
 */

/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';

/**
 * Validator for the mime type of a file
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_File_MimeType extends Zend_Validate_Abstract
{
    const FALSE_TYPE   = 'fileMimeTypeFalse';
    const NOT_DETECTED = 'fileMimeTypeNotDetected';
    const NOT_READABLE = 'fileMimeTypeNotReadable';
    
    /**
     * @var array
     */
    protected $_messageTemplates = array(
        self::FALSE_TYPE   => "The file '%value%' has a false mimetype",
        self::NOT_DETECTED => "The mimetype of file '%value%' has not been detected",
        self::NOT_READABLE => "The file '%value%' can not be read"
    );

    /**
     * @var array
     */
    protected $_messageVariables = array(
        'mimetype' => '_mimetype'
    );

    /**
     * Mimetypes
     *
     * If null, there is no mimetype
     *
     * @var string|null
     */
    protected $_mimetype;

    /**
     * Sets validator options
     *
     * Mimetype to accept
     *
     * @param  string|array $mimetype MimeType
     * @return void
     */
    public function __construct($mimetype)
    {
        $this->setMimeType($mimetype);
    }

    /**
     * Returns the set mimetypes
     *
     * @param  boolean $asArray Returns the values as array, when false an concated string is returned
     * @return integer
     */
    public function getMimeType($asArray = false)
    {
        $asArray   = (bool) $asArray;
        $mimetype = (string) $this->_mimetype;
        if ($asArray) {
            $mimetype = explode(',', $mimetype);
        }

        return $mimetype;
    }

    /**
     * Sets the mimetypes
     *
     * @param  string|array $mimetype The mimetypes to validate
     * @return Zend_Validate_File_Extension Provides a fluent interface
     */
    public function setMimeType($mimetype)
    {
        $this->_mimetype = null;
        $this->addMimeType($mimetype);
        return $this;
    }

    /**
     * Adds the mimetypes
     *
     * @param  string|array $mimetype The mimetypes to add for validation
     * @return Zend_Validate_File_Extension Provides a fluent interface
     */
    public function addMimeType($mimetype)
    {
        $mimetypes = $this->getMimeType(true);
        if (is_string($mimetype)) {
            $mimetype = explode(',', $mimetype);
        }

        foreach ($mimetype as $content) {
            if (empty($content) || !is_string($content)) {
                continue;
            }
            $mimetypes[] = trim($content);
        }
        $mimetypes = array_unique($mimetypes);

        // Sanity check to ensure no empty values
        foreach ($mimetypes as $key => $mt) {
            if (empty($mt)) {
                unset($mimetypes[$key]);
            }
        }

        $this->_mimetype = implode(',', $mimetypes);

        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if the mimetype of the file matches the given ones. Also parts
     * of mimetypes can be checked. If you give for example "image" all image
     * mime types will be accepted like "image/gif", "image/jpeg" and so on.
     *
     * @param  string $value Real file to check for mimetype
     * @param  array  $file  File data from Zend_File_Transfer
     * @return boolean
     */
    public function isValid($value, $file = null)
    {
        // Is file readable ?
        if (!@is_readable($value)) {
            $this->_throw($file, self::NOT_READABLE);
            return false;
        }

        if ($file !== null) {
            $info['type'] = $file['type'];
        } else {
            $this->_throw($file, self::NOT_DETECTED);
            return false;
        }

        $mimetype = $this->getMimeType(true);
        if (in_array($info['type'], $mimetype)) {
            return true;
        }

        foreach($mimetype as $mime) {
            $types = explode('/', $info['type']);
            if (in_array($mime, $types)) {
                return true;
            }
        }

        $this->_throw($file, self::FALSE_TYPE);
        return false;
    }

    /**
     * Throws an error of the given type
     *
     * @param  string $file
     * @param  string $errorType
     * @return false
     */
    protected function _throw($file, $errorType)
    {
        if ($file !== null) {
            $this->_value = $file['name'];
        }

        $this->_error($errorType);
        return false;
    }
}
79   8629|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/File/Size.php|bae8ee75<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: $
 */

/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';

/**
 * Validator for the maximum size of a file up to a max of 2GB
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_File_Size extends Zend_Validate_Abstract
{
    /**#@+
     * @const string Error constants
     */
    const TOO_BIG   = 'fileSizeTooBig';
    const TOO_SMALL = 'fileSizeTooSmall';
    const NOT_FOUND = 'fileSizeNotFound';
    /**#@-*/
    
    /**
     * @var array Error message templates
     */
    protected $_messageTemplates = array(
        self::TOO_BIG   => "The file '%value%' is bigger than allowed",
        self::TOO_SMALL => "The file '%value%' is smaller than allowed",
        self::NOT_FOUND => "The file '%value%' could not be found"
    );

    /**
     * @var array Error message template variables
     */
    protected $_messageVariables = array(
        'min' => '_min',
        'max' => '_max'
    );

    /**
     * Minimum filesize
     * @var integer
     */
    protected $_min;

    /**
     * Maximum filesize
     *
     * If null, there is no maximum filesize
     *
     * @var integer|null
     */
    protected $_max;

    /**
     * Sets validator options
     *
     * Min limits the filesize, when used with max=null it is the maximum filesize
     * It also accepts an array with the keys 'min' and 'max'
     *
     * @param  integer|array $min Minimum filesize
     * @param  integer       $max Maximum filesize
     * @return void
     */
    public function __construct($min, $max = null)
    {
        if (is_array($min)) {
            $count = count($min);
            if (array_key_exists('min', $min)) {
                if (array_key_exists('max', $min)) {
                    $max = $min['max'];
                }

                $min = $min['min'];
            } elseif ($count === 2) {
                $minValue = array_shift($min);
                $max = array_shift($min);
                $min = $minValue;
            } elseif($count === 1) {
                $min = array_shift($min);
                $max = null;
            } else {
                $min = 0;
                $max = null;
            }
        }

        if (empty($max)) {
            $max = $min;
            $min = 0;
        }

        $this->setMin($min);
        $this->setMax($max);
    }

    /**
     * Returns the minimum filesize
     *
     * @param  boolean $unit Return the value with unit, when false the plan bytes will be returned
     * @return integer
     */
    public function getMin($unit = true)
    {
        $unit = (bool) $unit;
        $min  = $this->_min;
        if ($unit) {
            $min = $this->_toByteString($min);
        }
        return $min;
    }

    /**
     * Sets the minimum filesize
     *
     * @param  integer $min            The minimum filesize
     * @return Zend_Validate_File_Size Provides a fluent interface
     * @throws Zend_Validate_Exception When min is greater than max
     */
    public function setMin($min)
    {
        $min = (integer) $this->_fromByteString($min);
        if (($this->_max !== null) && ($min > $this->_max)) {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("The minimum must be less than or equal to the maximum filesize, but $min >"
                                            . " {$this->_max}");
        }

        $this->_min = max(0, $min);
        return $this;
    }

    /**
     * Returns the maximum filesize
     *
     * @param  boolean $unit Return the value with unit, when false the plan bytes will be returned
     * @return integer|null
     */
    public function getMax($unit = true)
    {
        $unit = (bool) $unit;
        $max  = $this->_max;
        if ($unit) {
            $max = $this->_toByteString($max);
        }
        return $max;
    }

    /**
     * Sets the maximum filesize
     *
     * @param  integer|null $max       The maximum filesize
     * @return Zend_Validate_StringLength Provides a fluent interface
     * @throws Zend_Validate_Exception When max is smaller than min
     */
    public function setMax($max)
    {
        $max = (integer) $this->_fromByteString($max);
        if (($this->_min !== null) && ($max < $this->_min)) {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("The maximum must be greater than or equal to the minimum filesize, but "
                                            . "$max < {$this->_min}");
        } else {
            $this->_max = $max;
        }

        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if the filesize of $value is at least min and
     * not bigger than max (when max is not null).
     *
     * @param  string $value Real file to check for size
     * @param  array  $file  File data from Zend_File_Transfer
     * @return boolean
     */
    public function isValid($value, $file = null)
    {
        // Is file readable ?
        if (!@is_readable($value)) {
            $this->_throw($file, self::NOT_FOUND);
            return false;
        }

        // limited to 4GB files
        $size = sprintf("%u",@filesize($value));
        $this->_setValue($size);

        // Check to see if it's smaller than min size
        if (($this->_min !== null) && ($size < $this->_min)) {
            $this->_throw($file, self::TOO_SMALL);
        }

        // Check to see if it's larger than max size
        if (($this->_max !== null) && ($this->_max < $size)) {
            $this->_throw($file, self::TOO_BIG);
        }

        if (count($this->_messages) > 0) {
            return false;
        } else {
            return true;
        }
    }

    /**
     * Returns the formatted size
     *
     * @param  integer $size
     * @return string
     */
    protected function _toByteString($size) 
    {
        $sizes = array('B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB');
        for ($i=0; $size > 1024 && $i < 9; $i++) {
            $size /= 1024;
        }
        return round($size, 2).$sizes[$i];
    }

    /**
     * Returns the unformatted size
     *
     * @param  string $size
     * @return integer
     */
    protected function _fromByteString($size) 
    {
        if (is_numeric($size)) {
            return (integer) $size;
        }

        $type  = trim(substr($size, -2));
        $value = substr($size, 0, -2);
        switch (strtoupper($type)) {
            case 'YB':
                $value *= (1024 * 1024 * 1024 * 1024 * 1024 * 1024 * 1024 * 1024);
                break;
            case 'ZB':
                $value *= (1024 * 1024 * 1024 * 1024 * 1024 * 1024 * 1024);
                break;
            case 'EB':
                $value *= (1024 * 1024 * 1024 * 1024 * 1024 * 1024);
                break;
            case 'PB':
                $value *= (1024 * 1024 * 1024 * 1024 * 1024);
                break;
            case 'TB':
                $value *= (1024 * 1024 * 1024 * 1024);
                break;
            case 'GB':
                $value *= (1024 * 1024 * 1024);
                break;
            case 'MB':
                $value *= (1024 * 1024);
                break;
            case 'KB':
                $value *= 1024;
                break;
            default:
                break;
        }

        return $value;
    }

    /**
     * Throws an error of the given type
     *
     * @param  string $file
     * @param  string $errorType
     * @return false
     */
    protected function _throw($file, $errorType)
    {
        if ($file !== null) {
            $this->_value = $file['name'];
        }

        $this->_error($errorType);
        return false;
    }
}
80   6227|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/File/Count.php|82671594<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: $
 */

/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';

/**
 * Validator for counting all given files
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_File_Count extends Zend_Validate_Abstract
{
    /**#@+
     * @const string Error constants
     */
    const TOO_MUCH = 'fileCountTooMuch';
    const TOO_LESS = 'fileCountTooLess';
    /**#@-*/

    /**
     * @var array Error message templates
     */
    protected $_messageTemplates = array(
        self::TOO_MUCH => "Too much files, only '%value%' are allowed",
        self::TOO_LESS => "Too less files, minimum '%value%' must be given"
    );

    /**
     * @var array Error message template variables
     */
    protected $_messageVariables = array(
        'min' => '_min',
        'max' => '_max'
    );

    /**
     * Minimum file count
     *
     * If null, there is no minimum file count
     *
     * @var integer
     */
    protected $_min;

    /**
     * Maximum file count
     *
     * If null, there is no maximum file count
     *
     * @var integer|null
     */
    protected $_max;

    /**
     * Internal file array
     * @var array
     */
    protected $_files;

    /**
     * Sets validator options
     *
     * Min limits the file count, when used with max=null it is the maximum file count
     * It also accepts an array with the keys 'min' and 'max'
     *
     * @param  integer|array $min Minimum file count
     * @param  integer       $max Maximum file count
     * @return void
     */
    public function __construct($min, $max = null)
    {
        $this->_files = array();
        if (is_array($min) === true) {
            if (isset($min['max']) === true) {
                $max = $min['max'];
            }

            if (isset($min['min']) === true) {
                $min = $min['min'];
            }

            if (isset($min[0]) === true) {
                if (count($min) === 2) {
                    $max = $min[1];
                    $min = $min[0];
                } else {
                    $max = $min[0];
                    $min = null;
                }
            }
        }

        if (empty($max) === true) {
            $max = $min;
            $min = null;
        }

        $this->setMin($min);
        $this->setMax($max);
    }

    /**
     * Returns the minimum file count
     *
     * @return integer
     */
    public function getMin()
    {
        $min = $this->_min;

        return $min;
    }

    /**
     * Sets the minimum file count
     *
     * @param  integer $min            The minimum file count
     * @return Zend_Validate_File_Size Provides a fluent interface
     * @throws Zend_Validate_Exception When min is greater than max
     */
    public function setMin($min)
    {
        if ($min === null) {
            $this->_min = null;
        } else if (($this->_max !== null) and ($min > $this->_max)) {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception('The minimum must be less than or equal to the maximum file count, but '
                . " {$min} > {$this->_max}");
        } else {
            $this->_min = max(0, (integer) $min);
        }

        return $this;
    }

    /**
     * Returns the maximum file count
     *
     * @return integer|null
     */
    public function getMax()
    {
        return $this->_max;
    }

    /**
     * Sets the maximum file count
     *
     * @param  integer|null $max       The maximum file count
     * @throws Zend_Validate_Exception When max is smaller than min
     * @return Zend_Validate_StringLength Provides a fluent interface
     */
    public function setMax($max)
    {
        if ($max === null) {
            $this->_max = null;
        } else if (($this->_min !== null) and ($max < $this->_min)) {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("The maximum must be greater than or equal to the minimum file count, but "
                . "{$max} < {$this->_min}");
        } else {
            $this->_max = (integer) $max;
        }

        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if the file count of all checked files is at least min and
     * not bigger than max (when max is not null). Attention: When checking with set min you
     * must give all files with the first call, otherwise you will get an false.
     *
     * @param  string|array $value Filenames to check for count
     * @param  array        $file  File data from Zend_File_Transfer
     * @return boolean
     */
    public function isValid($value, $file = null)
    {
        if (is_string($value)) {
            $value = array($value);
        }

        foreach ($value as $file) {
            if (!isset($this->_files[$file])) {
                $this->_files[$file] = $file;
            }
        }

        if (($this->_max !== null) && (count($this->_files) > $this->_max)) {
            $this->_value = $this->_max;
            $this->_error(self::TOO_MUCH);
            return false;
        }

        if (($this->_min !== null) && (count($this->_files) < $this->_min)) {
            $this->_value = $this->_min;
            $this->_error(self::TOO_LESS);
            return false;
        }

        return true;
    }
}
84   10502|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/File/ImageSize.php|24ec677<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: $
 */

/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';

/**
 * Validator for the image size of a image file
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_File_ImageSize extends Zend_Validate_Abstract
{
    /**
     * @const string Error constants
     */
    const WIDTH_TOO_BIG    = 'fileImageSizeWidthTooBig';
    const WIDTH_TOO_SMALL  = 'fileImageSizeWidthTooSmall';
    const HEIGHT_TOO_BIG   = 'fileImageSizeHeightTooBig';
    const HEIGHT_TOO_SMALL = 'fileImageSizeHeightTooSmall';
    const NOT_DETECTED     = 'fileImageSizeNotDetected';
    const NOT_READABLE     = 'fileImageSizeNotReadable';

    /**
     * @var array Error message template
     */
    protected $_messageTemplates = array(
        self::WIDTH_TOO_BIG    => "Width of the image '%value%' is bigger than allowed",
        self::WIDTH_TOO_SMALL  => "Width of the image '%value%' is smaller than allowed",
        self::HEIGHT_TOO_BIG   => "Height of the image '%value%' is bigger than allowed",
        self::HEIGHT_TOO_SMALL => "Height of the image '%value%' is smaller than allowed",
        self::NOT_DETECTED     => "Size of the image '%value%' could not be detected",
        self::NOT_READABLE     => "The image '%value%' can not be read"
    );

    /**
     * @var array Error message template variables
     */
    protected $_messageVariables = array(
        'minwidth'  => '_minwidth',
        'maxwidth'  => '_maxwidth',
        'minheight' => '_minheight',
        'maxheight' => '_maxheight'
    );

    /**
     * Minimum image width
     *
     * @var integer
     */
    protected $_minwidth;

    /**
     * Maximum image width
     *
     * @var integer
     */
    protected $_maxwidth;

    /**
     * Minimum image height
     *
     * @var integer
     */
    protected $_minheight;

    /**
     * Maximum image height
     *
     * @var integer
     */
    protected $_maxheight;

    /**
     * Sets validator options
     *
     * Min limits the filesize, when used with max=null if is the maximum filesize
     * It also accepts an array with the keys 'min' and 'max'
     *
     * @param  integer|array $max Maximum filesize
     * @param  integer       $max Maximum filesize
     * @return void
     */
    public function __construct($minwidth = 0, $minheight = 0, $maxwidth = null, $maxheight = null)
    {
        if (is_array($minwidth) === true) {
            if (isset($minwidth['maxheight']) === true) {
                $maxheight = $minwidth['maxheight'];
            }

            if (isset($minwidth['minheight']) === true) {
                $minheight = $minwidth['minheight'];
            }

            if (isset($minwidth['maxwidth']) === true) {
                $maxwidth = $minwidth['maxwidth'];
            }

            if (isset($minwidth['minwidth']) === true) {
                $minwidth = $minwidth['minwidth'];
            }

            if (isset($minwidth[0]) === true) {
                $maxheight = $minwidth[3];
                $maxwidth  = $minwidth[2];
                $minheight = $minwidth[1];
                $minwidth  = $minwidth[0];
            }
        }

        $this->setImageMin($minwidth, $minheight);
        $this->setImageMax($maxwidth, $maxheight);
    }

    /**
     * Returns the set minimum image sizes
     *
     * @return array
     */
    public function getImageMin()
    {
        return array($this->_minwidth, $this->_minheight);
    }

    /**
     * Returns the set maximum image sizes
     *
     * @return array
     */
    public function getImageMax()
    {
        return array($this->_maxwidth, $this->_maxheight);
    }

    /**
     * Returns the set image width sizes
     *
     * @return array
     */
    public function getImageWidth()
    {
        return array($this->_minwidth, $this->_maxwidth);
    }

    /**
     * Returns the set image height sizes
     *
     * @return array
     */
    public function getImageHeight()
    {
        return array($this->_minheight, $this->_maxheight);
    }

    /**
     * Sets the minimum image size
     *
     * @param  integer $minwidth            The minimum image width
     * @param  integer $minheight           The minimum image height
     * @throws Zend_Validate_Exception      When minwidth is greater than maxwidth
     * @throws Zend_Validate_Exception      When minheight is greater than maxheight
     * @return Zend_Validate_File_ImageSize Provides a fluent interface
     */
    public function setImageMin($minwidth, $minheight)
    {
        if (($this->_maxwidth !== null) and ($minwidth > $this->_maxwidth)) {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("The minimum image width must be less than or equal to the "
                . " maximum image width, but {$minwidth} > {$this->_maxwidth}");
        }

        if (($this->_maxheight !== null) and ($minheight > $this->_maxheight)) {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("The minimum image height must be less than or equal to the "
                . " maximum image height, but {$minheight} > {$this->_maxheight}");
        }

        $this->_minwidth  = max(0, (integer) $minwidth);
        $this->_minheight = max(0, (integer) $minheight);
        return $this;
    }

    /**
     * Sets the maximum image size
     *
     * @param  integer $maxwidth       The maximum image width
     * @param  integer $maxheight      The maximum image height
     * @throws Zend_Validate_Exception When maxwidth is smaller than minwidth
     * @throws Zend_Validate_Exception When maxheight is smaller than minheight
     * @return Zend_Validate_StringLength Provides a fluent interface
     */
    public function setImageMax($maxwidth, $maxheight)
    {
        if ($maxwidth === null) {
            $tempwidth = null;
        } else if (($this->_minwidth !== null) and ($maxwidth < $this->_minwidth)) {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("The maximum image width must be greater than or equal to the "
                . "minimum image width, but {$maxwidth} < {$this->_minwidth}");
        } else {
            $tempwidth = (integer) $maxwidth;
        }

        if ($maxheight === null) {
            $tempheight = null;
        } else if (($this->_minheight !== null) and ($maxheight < $this->_minheight)) {
            require_once 'Zend/Validate/Exception.php';
            throw new Zend_Validate_Exception("The maximum image height must be greater than or equal to the "
                . "minimum image height, but {$maxheight} < {$this->_minwidth}");
        } else {
            $tempheight = (integer) $maxheight;
        }

        $this->_maxwidth  = $tempwidth;
        $this->_maxheight = $tempheight;
        return $this;
    }

    /**
     * Sets the mimimum and maximum image width
     *
     * @param  integer $minwidth            The minimum image width
     * @param  integer $maxwidth            The maximum image width
     * @return Zend_Validate_File_ImageSize Provides a fluent interface
     */
    public function setImageWidth($minwidth, $maxwidth)
    {
        $this->setImageMin($minwidth, $this->_minheight);
        $this->setImageMax($maxwidth, $this->_maxheight);
        return $this;
    }

    /**
     * Sets the mimimum and maximum image height
     *
     * @param  integer $minheight           The minimum image height
     * @param  integer $maxheight           The maximum image height
     * @return Zend_Validate_File_ImageSize Provides a fluent interface
     */
    public function setImageHeight($minheight, $maxheight)
    {
        $this->setImageMin($this->_minwidth, $minheight);
        $this->setImageMax($this->_maxwidth, $maxheight);
        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if the imagesize of $value is at least min and
     * not bigger than max
     *
     * @param  string $value Real file to check for image size
     * @param  array  $file  File data from Zend_File_Transfer
     * @return boolean
     */
    public function isValid($value, $file = null)
    {
        // Is file readable ?
        if (@is_readable($value) === false) {
            $this->_throw($file, self::NOT_READABLE);
            return false;
        }

        $size = @getimagesize($value);
        $this->_setValue($file);

        if (empty($size) or ($size[0] === 0) or ($size[1] === 0)) {
            $this->_throw($file, self::NOT_DETECTED);
            return false;
        }

        if ($size[0] < $this->_minwidth) {
            $this->_throw($file, self::WIDTH_TOO_SMALL);
        }

        if ($size[1] < $this->_minheight) {
            $this->_throw($file, self::HEIGHT_TOO_SMALL);
        }

        if (($this->_maxwidth !== null) and ($this->_maxwidth < $size[0])) {
            $this->_throw($file, self::WIDTH_TOO_BIG);
        }

        if (($this->_maxheight !== null) and ($this->_maxheight < $size[1])) {
            $this->_throw($file, self::HEIGHT_TOO_BIG);
        }

        if (count($this->_messages) > 0) {
            return false;
        } else {
            return true;
        }
    }

    /**
     * Throws an error of the given type
     *
     * @param  string $file
     * @param  string $errorType
     * @return false
     */
    protected function _throw($file, $errorType)
    {
        if ($file !== null) {
            $this->_value = $file['name'];
        }

        $this->_error($errorType);
        return false;
    }
}
80   6842|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/File/Upload.php|be44341<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: $
 */

/**
 * @see Zend_Validate_Abstract
 */
require_once 'Zend/Validate/Abstract.php';

/**
 * Validator for the maximum size of a file up to a max of 2GB
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_File_Upload extends Zend_Validate_Abstract
{
    /**@#+
     * @const string Error constants
     */
    const INI_SIZE       = 'fileUploadErrorIniSize';
    const FORM_SIZE      = 'fileUploadErrorFormSize';
    const PARTIAL        = 'fileUploadErrorPartial';
    const NO_FILE        = 'fileUploadErrorNoFile';
    const NO_TMP_DIR     = 'fileUploadErrorNoTmpDir';
    const CANT_WRITE     = 'fileUploadErrorCantWrite';
    const EXTENSION      = 'fileUploadErrorExtension';
    const ATTACK         = 'fileUploadErrorAttack';
    const FILE_NOT_FOUND = 'fileUploadErrorFileNotFound';
    const UNKNOWN        = 'fileUploadErrorUnknown';
    /**@#-*/

    /**
     * @var array Error message templates
     */
    protected $_messageTemplates = array(
        self::INI_SIZE       => "The file '%value%' exceeds the defined ini size",
        self::FORM_SIZE      => "The file '%value%' exceeds the defined form size",
        self::PARTIAL        => "The file '%value%' was only partially uploaded",
        self::NO_FILE        => "The file '%value%' was not uploaded",
        self::NO_TMP_DIR     => "No temporary directory was found for the file '%value%'",
        self::CANT_WRITE     => "The file '%value%' can't be written",
        self::EXTENSION      => "The extension returned an error while uploading the file '%value%'",
        self::ATTACK         => "The file '%value%' was illegal uploaded, possible attack",
        self::FILE_NOT_FOUND => "The file '%value%' was not found",
        self::UNKNOWN        => "Unknown error while uploading the file '%value%'"
    );

    /**
     * Internal array of files
     * @var array
     */
    protected $_files = array();

    /**
     * Sets validator options
     *
     * The array $files must be given in syntax of Zend_File_Transfer to be checked
     * If no files are given the $_FILES array will be used automatically.
     * NOTE: This validator will only work with HTTP POST uploads!
     *
     * @param  array $files Array of files in syntax of Zend_File_Transfer
     * @return void
     */
    public function __construct($files = array())
    {
        $this->setFiles($files);
    }

    /**
     * Returns the array of set files
     *
     * @param  string $files (Optional) The file to return in detail
     * @return array
     * @throws Zend_Validate_Exception If file is not found
     */
    public function getFiles($file = null)
    {
        if ($file !== null) {
            $return = array();
            foreach ($this->_files as $name => $content) {
                if ($name === $file) {
                    $return[$file] = $this->_files[$name];
                }

                if ($content['name'] === $file) {
                    $return[$name] = $this->_files[$name];
                }
            }

            if (count($return) === 0) {
                require_once 'Zend/Validate/Exception.php';
                throw new Zend_Validate_Exception("The file '$file' was not found");
            }

            return $return;
        }

        return $this->_files;
    }

    /**
     * Sets the minimum filesize
     *
     * @param  array $files The files to check in syntax of Zend_File_Transfer
     * @return Zend_Validate_File_Upload Provides a fluent interface
     */
    public function setFiles($files = array())
    {
        if (count($files) === 0) {
            $this->_files = $_FILES;
        } else {
            $this->_files = $files;
        }
        return $this;
    }

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if the file was uploaded without errors
     *
     * @param  string $value Single file to check for upload errors, when giving null the $_FILES array
     *                       from initialization will be used
     * @return boolean
     */
    public function isValid($value)
    {
        if (array_key_exists($value, $this->_files)) {
            $files[$value] = $this->_files[$value];
        } else {
            foreach ($this->_files as $file => $content) {
                if ($content['name'] === $value) {
                    $files[$file] = $this->_files[$file];
                }

                if ($content['tmp_name'] === $value) {
                    $files[$file] = $this->_files[$file];
                }
            }
        }

        if (empty($files)) {
            $this->_error(self::FILE_NOT_FOUND);
            return false;
        }

        foreach ($files as $file => $content) {
            $this->_value = $file;
            switch($content['error']) {
                case 0:
                    if (!is_uploaded_file($content['tmp_name'])) {
                        $this->_error(self::ATTACK);
                    }
                    break;

                case 1:
                    $this->_error(self::INI_SIZE);
                    break;

                case 2:
                    $this->_error(self::FORM_SIZE);
                    break;

                case 3:
                    $this->_error(self::PARTIAL);
                    break;

                case 4:
                    $this->_error(self::NO_FILE);
                    break;

                case 6:
                    $this->_error(self::NO_TMP_DIR);
                    break;

                case 7:
                    $this->_error(self::CANT_WRITE);
                    break;

                case 8:
                    $this->_error(self::EXTENSION);
                    break;

                default:
                    $this->_error(self::UNKNOWN);
                    break;
            }
        }

        if (count($this->_messages) > 0) {
            return false;
        } else {
            return true;
        }
    }
}
84   2520|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/File/NotExists.php|c052d642<?php
/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 * @version   $Id: $
 */

/**
 * @see Zend_Validate_File_Exists
 */
require_once 'Zend/Validate/File/Exists.php';

/**
 * Validator which checks if the destination file does not exist
 *
 * @category  Zend
 * @package   Zend_Validate
 * @copyright Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_File_NotExists extends Zend_Validate_File_Exists
{
    /**
     * @const string Error constants
     */
    const DOES_EXIST = 'fileNotExistsDoesExist';

    /**
     * @var array Error message templates
     */
    protected $_messageTemplates = array(
        self::DOES_EXIST => "The file '%value%' does exist"
    );

    /**
     * Defined by Zend_Validate_Interface
     *
     * Returns true if and only if the file does not exist in the set destinations
     *
     * @param  string  $value Real file to check for
     * @param  array   $file  File data from Zend_File_Transfer
     * @return boolean
     */
    public function isValid($value, $file = null)
    {
        $directories = $this->getDirectory(true);
        if (($file !== null) and (!empty($file['destination']))) {
            $directories[] = $file['destination'];
        } else if (!isset($file['name'])) {
            $file['name'] = $value;
        }

        foreach ($directories as $directory) {
            if (empty($directory)) {
                continue;
            }

            $check = true;
            if (file_exists($directory . DIRECTORY_SEPARATOR . $file['name'])) {
                $this->_throw($file, self::DOES_EXIST);
                return false; 
            }
        }

        if (!isset($check)) {
            $this->_throw($file, self::DOES_EXIST);
            return false; 
        }

        return true;
    }
}
88   1855|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hostname/Interface.php|fa811547<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Interface.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
interface Zend_Validate_Hostname_Interface
{

    /**
     * Returns UTF-8 characters allowed in DNS hostnames for the specified Top-Level-Domain
     *
     * UTF-8 characters should be written as four character hex codes \x{XXXX}
     * For example é (lowercase e with acute) is represented by the hex code \x{00E9}
     *
     * You only need to include lower-case equivalents of characters since the hostname
     * check is case-insensitive
     *
     * Please document the supported TLDs in the documentation file at:
     * manual/en/module_specs/Zend_Validate-Hostname.xml
     *
     * @see http://en.wikipedia.org/wiki/Internationalized_domain_name
     * @see http://www.iana.org/cctld/ Country-Code Top-Level Domains (TLDs)
     * @see http://www.columbia.edu/kermit/utf8-t1.html UTF-8 characters
     * @return string
     */
    static function getCharacters();

}81   1515|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hostname/At.php|69eb37ca<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: At.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Hostname_Interface
 */
require_once 'Zend/Validate/Hostname/Interface.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Hostname_At implements Zend_Validate_Hostname_Interface
{

    /**
     * Returns UTF-8 characters allowed in DNS hostnames for the specified Top-Level-Domain
     *
     * @see http://www.nic.at/en/service/technical_information/idn/charset_converter/ Austria (.AT)
     * @return string
     */
    static function getCharacters()
    {
        return '\x{00EO}-\x{00F6}\x{00F8}-\x{00FF}\x{0153}\x{0161}\x{017E}';
    }

}81   2355|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hostname/De.php|3516b215<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: De.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Hostname_Interface
 */
require_once 'Zend/Validate/Hostname/Interface.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Hostname_De implements Zend_Validate_Hostname_Interface
{

    /**
     * Returns UTF-8 characters allowed in DNS hostnames for the specified Top-Level-Domain
     *
     * @see http://www.denic.de/en/domains/idns/liste.html Germany (.DE) alllowed characters
     * @return string
     */
    static function getCharacters()
    {
        return  '\x{00E1}\x{00E0}\x{0103}\x{00E2}\x{00E5}\x{00E4}\x{00E3}\x{0105}\x{0101}\x{00E6}\x{0107}' .
                '\x{0109}\x{010D}\x{010B}\x{00E7}\x{010F}\x{0111}\x{00E9}\x{00E8}\x{0115}\x{00EA}\x{011B}' .
                '\x{00EB}\x{0117}\x{0119}\x{0113}\x{011F}\x{011D}\x{0121}\x{0123}\x{0125}\x{0127}\x{00ED}' .
                '\x{00EC}\x{012D}\x{00EE}\x{00EF}\x{0129}\x{012F}\x{012B}\x{0131}\x{0135}\x{0137}\x{013A}' .
                '\x{013E}\x{013C}\x{0142}\x{0144}\x{0148}\x{00F1}\x{0146}\x{014B}\x{00F3}\x{00F2}\x{014F}' .
                '\x{00F4}\x{00F6}\x{0151}\x{00F5}\x{00F8}\x{014D}\x{0153}\x{0138}\x{0155}\x{0159}\x{0157}' .
                '\x{015B}\x{015D}\x{0161}\x{015F}\x{0165}\x{0163}\x{0167}\x{00FA}\x{00F9}\x{016D}\x{00FB}' .
                '\x{016F}\x{00FC}\x{0171}\x{0169}\x{0173}\x{016B}\x{0175}\x{00FD}\x{0177}\x{00FF}\x{017A}' .
                '\x{017E}\x{017C}\x{00F0}\x{00FE}';
    }

}81   1485|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hostname/Fi.php|6adc370b<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Fi.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Hostname_Interface
 */
require_once 'Zend/Validate/Hostname/Interface.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Hostname_Fi implements Zend_Validate_Hostname_Interface
{

    /**
     * Returns UTF-8 characters allowed in DNS hostnames for the specified Top-Level-Domain
     *
     * @see http://www.ficora.fi/en/index/palvelut/fiverkkotunnukset/aakkostenkaytto.html Finland (.FI)
     * @return string
     */
    static function getCharacters()
    {
        return '\x{00E5}\x{00E4}\x{00F6}';
    }

}81   1479|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hostname/Se.php|fd82f34e<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Se.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Hostname_Interface
 */
require_once 'Zend/Validate/Hostname/Interface.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Hostname_Se implements Zend_Validate_Hostname_Interface
{

    /**
     * Returns UTF-8 characters allowed in DNS hostnames for the specified Top-Level-Domain
     *
     * @see http://www.iis.se/english/IDN_campaignsite.shtml?lang=en Sweden (.SE)
     * @return string
     */
    static function getCharacters()
    {
        return '\x{00E5}\x{00E4}\x{00F6}\x{00FC}\x{00E9}';
    }

}81   1507|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hostname/Hu.php|ab7e0ef4<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Hu.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Hostname_Interface
 */
require_once 'Zend/Validate/Hostname/Interface.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Hostname_Hu implements Zend_Validate_Hostname_Interface
{

    /**
     * Returns UTF-8 characters allowed in DNS hostnames for the specified Top-Level-Domain
     *
     * @see http://www.domain.hu/domain/English/szabalyzat.html Hungary (.HU)
     * @return string
     */
    static function getCharacters()
    {
        return '\x{00E1}\x{00E9}\x{00ED}\x{00F3}\x{00F6}\x{0151}\x{00FA}\x{00FC}\x{0171}';
    }

}81   1522|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hostname/Ch.php|d2884453<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Ch.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Hostname_Interface
 */
require_once 'Zend/Validate/Hostname/Interface.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Hostname_Ch implements Zend_Validate_Hostname_Interface
{

    /**
     * Returns UTF-8 characters allowed in DNS hostnames for the specified Top-Level-Domain
     *
     * @see https://nic.switch.ch/reg/ocView.action?res=EF6GW2JBPVTG67DLNIQXU234MN6SC33JNQQGI7L6#anhang1 Switzerland (.CH)
     * @return string
     */
    static function getCharacters()
    {
        return '\x{00EO}-\x{00F6}\x{00F8}-\x{00FF}\x{0153}';
    }

}81   1524|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hostname/Li.php|9dc41a50<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: Li.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Hostname_Interface
 */
require_once 'Zend/Validate/Hostname/Interface.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Hostname_Li implements Zend_Validate_Hostname_Interface
{

    /**
     * Returns UTF-8 characters allowed in DNS hostnames for the specified Top-Level-Domain
     *
     * @see https://nic.switch.ch/reg/ocView.action?res=EF6GW2JBPVTG67DLNIQXU234MN6SC33JNQQGI7L6#anhang1 Liechtenstein (.LI)
     * @return string
     */
    static function getCharacters()
    {
        return '\x{00EO}-\x{00F6}\x{00F8}-\x{00FF}\x{0153}';
    }

}81   1629|/shs.parser/classes/phpQuery/phpQuery/Zend/Validate/Hostname/No.php|1ae16d50<?php

/**
 * Zend Framework
 *
 * LICENSE
 *
 * This source file is subject to the new BSD license that is bundled
 * with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://framework.zend.com/license/new-bsd
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@zend.com so we can send you a copy immediately.
 *
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 * @version    $Id: No.php 8064 2008-02-16 10:58:39Z thomas $
 */


/**
 * @see Zend_Validate_Hostname_Interface
 */
require_once 'Zend/Validate/Hostname/Interface.php';


/**
 * @category   Zend
 * @package    Zend_Validate
 * @copyright  Copyright (c) 2005-2008 Zend Technologies USA Inc. (http://www.zend.com)
 * @license    http://framework.zend.com/license/new-bsd     New BSD License
 */
class Zend_Validate_Hostname_No implements Zend_Validate_Hostname_Interface
{

    /**
     * Returns UTF-8 characters allowed in DNS hostnames for the specified Top-Level-Domain
     *
     * @see http://www.norid.no/domeneregistrering/idn/idn_nyetegn.en.html Norway (.NO)
     * @return string
     */
    static function getCharacters()
    {
        return  '\x00E1\x00E0\x00E4\x010D\x00E7\x0111\x00E9\x00E8\x00EA\x\x014B' .
                '\x0144\x00F1\x00F3\x00F2\x00F4\x00F6\x0161\x0167\x00FC\x017E\x00E6' .
                '\x00F8\x00E5';
    }

}
71   1549|/shs.parser/classes/phpQuery/phpQuery/compat/mbstring.php|37758f7e<?php
// -- Multibyte Compatibility functions ---------------------------------------
// http://svn.iphonewebdev.com/lace/lib/mb_compat.php

/**
 *  mb_internal_encoding()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_internal_encoding'))
{
	function mb_internal_encoding($enc) {return true; }
}

/**
 *  mb_regex_encoding()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_regex_encoding'))
{
	function mb_regex_encoding($enc) {return true; }
}

/**
 *  mb_strlen()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_strlen'))
{
	function mb_strlen($str)
	{
		return strlen($str);
	}
}

/**
 *  mb_strpos()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_strpos'))
{
	function mb_strpos($haystack, $needle, $offset=0)
	{
		return strpos($haystack, $needle, $offset);
	}
}
/**
 *  mb_stripos()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_stripos'))
{
	function mb_stripos($haystack, $needle, $offset=0)
	{
		return stripos($haystack, $needle, $offset);
	}
}

/**
 *  mb_substr()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_substr'))
{
	function mb_substr($str, $start, $length=0)
	{
		return substr($str, $start, $length);
	}
}

/**
 *  mb_substr_count()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_substr_count'))
{
	function mb_substr_count($haystack, $needle)
	{
		return substr_count($haystack, $needle);
	}
}

44   99|/shs.parser/install/_version.php|844f7f0d<?
$arModuleVersion = array(
	"VERSION" => "5.1.10",
	"VERSION_DATE" => "2015-07-01 12:18:41"
);
?>43   5170|/shs.parser/install/index.php|2ad0a37d<?
IncludeModuleLangFile(__FILE__);
Class shs_parser extends CModule
{
	const MODULE_ID = 'shs.parser';
	var $MODULE_ID = 'shs.parser'; 
	var $MODULE_VERSION;
	var $MODULE_VERSION_DATE;
	var $MODULE_NAME;
	var $MODULE_DESCRIPTION;
	var $MODULE_CSS;
	var $strError = '';

	function __construct()
	{
		$arModuleVersion = array();
		include(dirname(__FILE__)."/version.php");
		$this->MODULE_VERSION = $arModuleVersion["VERSION"];
		$this->MODULE_VERSION_DATE = $arModuleVersion["VERSION_DATE"];
		$this->MODULE_NAME = GetMessage("shs.parser_MODULE_NAME");
		$this->MODULE_DESCRIPTION = GetMessage("shs.parser_MODULE_DESC");

		$this->PARTNER_NAME = GetMessage("shs.parser_PARTNER_NAME");
		$this->PARTNER_URI = GetMessage("shs.parser_PARTNER_URI");
	}

	function InstallDB($arParams = array())
	{
        global $DB, $DBType, $APPLICATION;
		$this->errors = false;
        $this->errors = $DB->RunSQLBatch($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/".self::MODULE_ID."/install/db/".$DBType."/install.sql");
        if($this->errors !== false)
		{
			$APPLICATION->ThrowException(implode("<br>", $this->errors));
			return false;
		}else{
            //RegisterModuleDependences('main', 'OnBuildGlobalMenu', self::MODULE_ID, 'CShsParser', 'OnBuildGlobalMenu');
		}


		return true;
	}

	function UnInstallDB($arParams = array())
	{
        global $DB, $DBType, $APPLICATION;
		$this->errors = false;
        if(!array_key_exists("save_tables", $arParams) || ($arParams["save_tables"] != "Y"))
		{
			$this->errors = $DB->RunSQLBatch($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/".self::MODULE_ID."/install/db/".$DBType."/uninstall.sql");
			$strSql = "SELECT ID FROM b_file WHERE MODULE_ID='".self::MODULE_ID."'";
			$rsFile = $DB->Query($strSql, false, "File: ".__FILE__."<br>Line: ".__LINE__);
			while($arFile = $rsFile->Fetch())
				CFile::Delete($arFile["ID"]);
		}

        //UnRegisterModuleDependences('main', 'OnBuildGlobalMenu', self::MODULE_ID, 'CShsParser', 'OnBuildGlobalMenu');
		return true;
	}

	function InstallEvents()
	{
		return true;
	}

	function UnInstallEvents()
	{
		return true;
	}

	function InstallFiles($arParams = array())
	{
		if (is_dir($p = $_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/'.self::MODULE_ID.'/admin'))
		{
			if ($dir = opendir($p))
			{
				while (false !== $item = readdir($dir))
				{
					if ($item == '..' || $item == '.' || $item == 'menu.php')
						continue;
					file_put_contents($file = $_SERVER['DOCUMENT_ROOT'].'/bitrix/admin/'.$item,
					'<'.'? require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/'.self::MODULE_ID.'/admin/'.$item.'");?'.'>');
				}
				closedir($dir);
			}
		}
        if($_ENV["COMPUTERNAME"]!='BX')
		{
			//CopyDirFiles($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/subscribe/install/admin", $_SERVER["DOCUMENT_ROOT"]."/bitrix/admin");
			CopyDirFiles($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/install/images/", $_SERVER["DOCUMENT_ROOT"]."/bitrix/images/shs.parser", false, true);
			CopyDirFiles($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/install/themes/", $_SERVER["DOCUMENT_ROOT"]."/bitrix/themes", false, true);
		}
		return true;
	}

    function UnInstallAgent()
    {
        CModule::IncludeModule('main');
        $dbAgent = CAgent::GetList(array(), array("MODULE_ID"=>"shs.parser"));
        while($arAgent = $dbAgent->Fetch()){
            CAgent::Delete($arAgent[ID]);
        }
    }

	function UnInstallFiles()
	{
		if (is_dir($p = $_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/'.self::MODULE_ID.'/admin'))
		{
			if ($dir = opendir($p))
			{
				while (false !== $item = readdir($dir))
				{
					if ($item == '..' || $item == '.')
						continue;
					unlink($_SERVER['DOCUMENT_ROOT'].'/bitrix/admin/'.self::MODULE_ID.'_'.$item);
				}
				closedir($dir);
			}
		}
		if (is_dir($p = $_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/'.self::MODULE_ID.'/install/components'))
		{
			if ($dir = opendir($p))
			{
				while (false !== $item = readdir($dir))
				{
					if ($item == '..' || $item == '.' || !is_dir($p0 = $p.'/'.$item))
						continue;

					$dir0 = opendir($p0);
					while (false !== $item0 = readdir($dir0))
					{
						if ($item0 == '..' || $item0 == '.')
							continue;
						DeleteDirFilesEx('/bitrix/components/'.$item.'/'.$item0);
					}
					closedir($dir0);
				}
				closedir($dir);
			}
		}
        if($_ENV["COMPUTERNAME"]!='BX')
		{
			//css
			DeleteDirFiles($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/install/themes/.default/", $_SERVER["DOCUMENT_ROOT"]."/bitrix/themes/.default");
			//icons
			DeleteDirFilesEx("/bitrix/themes/.default/icons/shs.parser/");
			//images
			DeleteDirFilesEx("/bitrix/images/shs.parser/");
		}
		return true;
	}

	function DoInstall()
	{
		global $APPLICATION;
		$this->InstallFiles();
		$this->InstallDB();
		RegisterModule(self::MODULE_ID);
	}

	function DoUninstall()
	{
		global $APPLICATION;
		UnRegisterModule(self::MODULE_ID);
		$this->UnInstallDB();
        $this->UnInstallAgent();
		$this->UnInstallFiles();
	}
}
?>
43   99|/shs.parser/install/version.php|5f9e6bd0<?
$arModuleVersion = array(
	"VERSION" => "5.1.10",
	"VERSION_DATE" => "2015-07-01 12:18:50"
);
?>54   2295|/shs.parser/install/db/mysql/install.sql|d57366a7CREATE TABLE b_shs_parser
(
	ID		int(11)		NOT NULL auto_increment,
	NAME		VARCHAR(255)	NULL,
    TYPE		VARCHAR(10) DEFAULT 'rss' NOT NULL,
	TIMESTAMP_X timestamp not null,
	RSS		VARCHAR(600)	NULL,
	SORT		int(11)		DEFAULT 100 NOT NULL,
	ACTIVE		CHAR(1)		DEFAULT 'Y' NOT NULL,
	IBLOCK_ID	INT(18) NOT NULL,
	SECTION_ID	INT(18) NOT NULL,
	SELECTOR	VARCHAR(300)	NULL,
	FIRST_URL	VARCHAR(300)	NULL,
	ENCODING	VARCHAR(20)	NULL,
	PREVIEW_TEXT_TYPE VARCHAR(4) NULL,
	DETAIL_TEXT_TYPE VARCHAR(4) NULL,
	BOOL_PREVIEW_DELETE_TAG CHAR(1) NULL,
	BOOL_DETAIL_DELETE_TAG CHAR(1) NULL,
	PREVIEW_DELETE_TAG VARCHAR(300) NULL,
	DETAIL_DELETE_TAG VARCHAR(300) NULL,
	PREVIEW_FIRST_IMG CHAR(1) NULL,
	DETAIL_FIRST_IMG CHAR(1) NULL,
	PREVIEW_SAVE_IMG CHAR(1) NULL,
	DETAIL_SAVE_IMG CHAR(1) NULL,
	PREVIEW_DELETE_ELEMENT VARCHAR(300) NULL,
	DETAIL_DELETE_ELEMENT VARCHAR(300) NULL,
	PREVIEW_DELETE_ATTRIBUTE VARCHAR(300) NULL,
	DETAIL_DELETE_ATTRIBUTE VARCHAR(300) NULL,
	INDEX_ELEMENT CHAR(1) NULL,
	CODE_ELEMENT CHAR(1) NULL,
	RESIZE_IMAGE CHAR(1) NULL,
	DATE_ACTIVE VARCHAR(10) DEFAULT 'N' NOT NULL,
	DATE_PUBLIC VARCHAR(50) DEFAULT 'N' NOT NULL,
	FIRST_TITLE VARCHAR(50) DEFAULT 'N' NOT NULL,
	META_TITLE VARCHAR(50) DEFAULT 'N' NOT NULL,
	META_DESCRIPTION VARCHAR(50) DEFAULT 'N' NOT NULL,
	META_KEYWORDS VARCHAR(50) DEFAULT 'N' NOT NULL,
	START_AGENT CHAR(1) NULL,
	TIME_AGENT INT(11) NULL,
	ACTIVE_ELEMENT CHAR(1) NULL,
	START_LAST_TIME_X DATETIME NULL,
    SETTINGS LONGTEXT NULL,
	TMP VARCHAR(50) DEFAULT 'b_shs_parser_tmp' NOT NULL,
    CATEGORY_ID int(11) DEFAULT 0 NOT NULL,
	PRIMARY KEY (ID)
);
CREATE TABLE b_shs_parser_tmp
(
	ID		int(11)		NOT NULL auto_increment,
	PARSER_ID		int(11)	NULL,
    PRODUCT_ID		int(11) NULL,
	PRIMARY KEY (ID)

	
);
CREATE TABLE b_shs_parser_tmp_old
(
	ID		int(11)		NOT NULL auto_increment,
	PARSER_ID		int(11)	NULL,
    PRODUCT_ID		int(11) NULL,
	PRIMARY KEY (ID)
);
CREATE TABLE b_shs_parser_section
(
    ID        int(11)        NOT NULL auto_increment,
    TIMESTAMP_X timestamp not null,
    DATE_CREATE DATETIME NULL,
    ACTIVE        CHAR(1)        DEFAULT 'Y' NOT NULL,
    SORT        int(11)        DEFAULT 500 NOT NULL,
    NAME        VARCHAR(255)    NULL,
    DESCRIPTION TEXT NULL,
    PARENT_CATEGORY_ID    INT(11) DEFAULT 0 NOT NULL,
    PRIMARY KEY (ID)
);55   158|/shs.parser/install/db/mysql/uninstall.sql|5963171bDROP TABLE if exists b_shs_parser;
DROP TABLE if exists b_shs_parser_tmp;
DROP TABLE if exists b_shs_parser_tmp_old;
DROP TABLE if exists b_shs_parser_section58   110|/shs.parser/install/images/mnu_shs_parser.gif|9bf1054aGIF89a       


      !   ,       3XZ+61P^]C\	&d<]4J1I  ;54   169|/shs.parser/install/images/shs_parser.gif|58d1d9dcGIF89a" "      
!   ,    " "  z	a+ {lHV(FG6|n:ȻrӢ+D
sfMZN%6&1;n5N˴9+tp'7qp$9@U  ;61   98|/shs.parser/install/admin/parser_section_edit.php|5b5e5b7e<?require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/shs.parser/admin/parser_section_edit.php");?>63   484|/shs.parser/install/themes/.default/shs.parser.css|60ee1b09/*Menu icon*/
#shs_parser_menu_icon {background:url(icons/shs.parser/mnu_shs_parser.gif) no-repeat 50% 50%!important;}
#shs_parser_page_icon {background:url(icons/shs.parser/title.gif) no-repeat 50% 50%!important;}
.shs_parser_menu_icon {background:url(icons/shs.parser/mnu_shs_parser.gif) no-repeat 50% 50%!important;}
.shs_parser_page_icon {background:url(icons/shs.parser/title.gif) no-repeat 50% 50%!important;}

.shs_parser_border {border:1px solid #BDC6E0; padding:4px;}
84   85|/shs.parser/install/themes/.default/start_menu/shs.parser/shs.parser.css|aa128aae.popupmenu .popupitem .shs_parser_menu_icon {background-image:url(shs_parser.gif);}
85   110|/shs.parser/install/themes/.default/start_menu/shs.parser/shs_parser.gif|9bf1054aGIF89a       


      !   ,       3XZ+61P^]C\	&d<]4J1I  ;84   110|/shs.parser/install/themes/.default/icons/shs.parser/mnu_shs_parser.gif|9bf1054aGIF89a       


      !   ,       3XZ+61P^]C\	&d<]4J1I  ;75   169|/shs.parser/install/themes/.default/icons/shs.parser/title.gif|58d1d9dcGIF89a" "      
!   ,    " "  z	a+ {lHV(FG6|n:ȻrӢ+D
sfMZN%6&1;n5N˴9+tp'7qp$9@U  ;RTIBE