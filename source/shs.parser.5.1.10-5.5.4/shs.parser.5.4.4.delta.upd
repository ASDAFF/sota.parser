BITRIX41   1212|/shs.parser/updater5.4.4.php|58bd623<?
if(IsModuleInstalled('shs.parser'))
{
	if (is_dir(dirname(__FILE__).'/install/components'))
		$updater->CopyFiles("install/components", "components/");

	if (is_dir(dirname(__FILE__).'/install/js'))
		$updater->CopyFiles("install/js", "js/shs.parser/");
}


/* 

// 
// Sample database update
//


if($updater->CanUpdateDatabase())
{
	if($updater->TableExists("b_iblock_element_property"))
	{
		if(!$DB->IndexExists("b_iblock_element_property", array("VALUE_NUM", "IBLOCK_PROPERTY_ID")))
		{
			$updater->Query(array(
				"MySQL" => "CREATE INDEX ix_iblock_element_prop_num ON b_iblock_element_property(VALUE_NUM, IBLOCK_PROPERTY_ID)",
				"MSSQL" => "CREATE INDEX IX_B_IBLOCK_ELEMENT_PROPERTY_4 ON B_IBLOCK_ELEMENT_PROPERTY(VALUE_NUM, IBLOCK_PROPERTY_ID)",
				"Oracle" => "CREATE INDEX IX_IBLOCK_ELEMENT_PROP_NUM ON B_IBLOCK_ELEMENT_PROPERTY(VALUE_NUM, IBLOCK_PROPERTY_ID)",
			));
		}
        }
	if($updater->TableExists("b_iblock_property"))
	{
		if(!$DB->IndexExists("b_iblock_property", array("UPPER(\"CODE\")")))
		{
			$updater->Query(array(
				"Oracle" => "CREATE INDEX ix_iblock_property_2 ON B_IBLOCK_PROPERTY(UPPER(CODE))",
			));
		}
        }
}

*/
?>56   60080|/shs.parser/lang/ru/admin/parser_edit.php|596c73ce<?
$MESS ['parser_tab'] = "Парсер";
$MESS ['parser_settings_tab'] = "Дополнительные настройки";
$MESS ['parser_uniq_tab'] = "Обновление / Уникальность";
$MESS ['parser_save_error'] = "Ошибка сохранения парсера";
$MESS ['parser_title_add'] = "Добавление парсера";
$MESS ['parser_title_edit'] = "Редактирование парсера";
$MESS ['parser_list'] = "Список";
$MESS ['parser_list_title'] = "Список парсеров";
$MESS ['parser_add'] = "Добавить";
$MESS ['parser_copy'] = "Копировать";
$MESS ['parser_mnu_add'] = "Добавить новый парсер";
$MESS ['parser_mnu_copy'] = "Копировать парсер";
$MESS ['parser_delete'] = "Удалить";
$MESS ['parser_mnu_del_conf'] = "Удалить парсер?";
$MESS ['parser_mnu_del_conf'] = "Удалить парсер?";
$MESS ['parser_start'] = "Запустить";
$MESS ['parser_start_title'] = "Запустить парсер";
$MESS ['parser_stop'] = "Остановить";
$MESS ['parser_stop_title'] = "Остановить парсер";
$MESS ['parser_saved'] = "Парсер успешно сохранен.";
$MESS ['parser_act'] = "Активен:";
$MESS ['parser_name'] = "Название:";
$MESS ['parser_rss'] = "RSS канал:";
$MESS["parser_selector_preview_id_xml"] = "Селектор-атрибут, содержащий id товара:";
$MESS["parser_selector_id_xml_descr"] = "Если пусто, то товары выгружаться не будут. Например: id, [id]";
$MESS ['parser_rss_page'] = "URL страницы:";
$MESS ['parser_rss_catalog'] = "URL раздела каталога:";
$MESS ['parser_xml_catalog'] = "URL XML файла:";
$MESS ['parser_selector_catalog_xml_descr'] = "Например: offer. Далее все селектора в этой закладке идут относительно заданного параметра.";
$MESS ['parser_sort'] = "Сортировка:";
$MESS ['parser_iblock_id'] = "ID инфоблока:";
$MESS ['parser_iblock_id_catalog'] = "ID инфоблока-каталога:";
$MESS ['parser_section_id'] = "ID раздела:";
$MESS ['parser_selector'] = "Селектор контента:";
$MESS ['parser_selector_page'] = "Селектор новости на странице списка новостей:";
$MESS ['parser_selector_preview_catalog'] = "Селектор товара на странице каталога:";
$MESS ['parser_selector_preview_xml'] = "Селектор конкретного товара:";
$MESS ['parser_selector_detail_catalog'] = "Селектор товара на детальной странице:";
$MESS ['parser_first_url'] = "URL в rss ленте:";
$MESS ['parser_first_url_page'] = "URL на странице:";
$MESS ['parser_href_page'] = "Селектор ссылки:";
$MESS ['parser_href_descr_page'] = "Если ничего не задано, то переход по страницам будет осуществляться по первой найденной ссылке в селекторе списка новостей. Селектор указывается относительно селектора новости. <br/>Если селектор сам является ссылкой, то необходимо указать: a:parent";
$MESS ['parser_name_page'] = "Селектор наименования новости:";
$MESS ['parser_name_descr_page'] = "Если ничего не задано, то название новости будет браться, как текст селектора ссылки. Селектор указывается относительно селектора новости.";
$MESS ['parser_name_descr_xml'] = "Если наименование находится в атрибуте, то атрибут указываем в квадратных скобках, например: [name].";
$MESS ['parser_encoding'] = "Кодировка:";
$MESS ['parser_delete_tag'] = "Удалять все теги:";
$MESS ['parser_pagenavigation_tab'] = "Постраничная навигация";
$MESS ['parser_preview_tab'] = "Превью";
$MESS ['parser_selector_section_catalog'] = "Селектор одной категории:";
$MESS ['parser_attr_name_section_catalog'] = "Селектор-атрибут названия категории:";
$MESS ['parser_attr_category_descr'] = "Если пусто, то название берется из значения самой категории.";
$MESS ['parser_attr_id_section_catalog'] = "Селектор-атрибут, содержащий id категории:";
$MESS ['parser_attr_id_category_descr'] = "Если пусто, то категории не будут выгружаться. Например: categoryId, [id]";
$MESS ['parser_field_id_category_catalog'] = "Записывать id категории в:";
$MESS ['parser_field_id_category_descr'] = "Указывается поле, в которое будет записан id категории из xml.";
$MESS ['parser_attr_id_parrent_category_catalog'] = "Селектор-атрибут, содержащий id родительской категории:";
$MESS ['field_xml_id'] = "внешний код раздела";
$MESS ['field_ext'] = "пользовательское поле раздела";
$MESS ['parser_attr_id_parrent_category_descr'] = "Если пусто, то категории будут выгружаться без сохранения вложенности. Например: parent, [parentId]";
$MESS ['parser_selector_section_descr'] = "Указывается селектор одной категории. Если пусто, то категории товаров выгружаться не будут.";
$MESS ['parser_basic_settings_tab'] = "Основные настройки";
$MESS ['parser_detail_tab'] = "Детально";
$MESS ['parser_preview_delete_tag'] = "Удалять теги:";
$MESS ['parser_preview_delete_tag_descr'] = htmlspecialcharsEx('Пример: "<div>", "<p>", "<br>"');
$MESS ['parser_page_uniq'] = "Уникализация по:"; 
$MESS ['parser_page_uniq_url'] = "Урлу";
$MESS ['parser_page_uniq_name'] = "Названию";

$MESS ['parser_detail_delete_tag'] = "Удалять теги:";
$MESS ['parser_preview_text_type'] = "Тип поля:";
$MESS ['parser_detail_text_type'] = "Тип поля:";
$MESS ['parser_bool_preview_delete_tag'] = "Кроме следующих:";
$MESS ['parser_bool_detail_delete_tag'] = "Кроме следующих:";
$MESS ['parser_preview_delete_element'] = "Удалять элементы:";
$MESS ['parser_detail_delete_element'] = "Удалять элементы:";
$MESS ['parser_preview_delete_attribute'] = "Удалять атрибуты элементов:";
$MESS ['parser_detail_delete_attribute'] = "Удалять атрибуты элементов:";
$MESS ['parser_preview_first_img'] = "Первая картинка как превью:";
$MESS ['parser_detail_first_img'] = "Первая картинка как детальная:";
$MESS ['parser_preview_first_img_catalog'] = "Селектор-атрибут превью картинки:";
$MESS ['parser_preview_first_img_xml'] = "Селектор-атрибут превью картинки:";
$MESS ['parser_detail_first_img_catalog'] = "Селектор-атрибут детальной картинки:";
$MESS ['parser_detail_first_img_xml'] = "Селектор-атрибут детальной картинки:";
$MESS ['parser_preview_save_img'] = "Заменять пути/сохранять картинки на сервер:";
$MESS ['parser_detail_save_img'] = "Заменять пути/сохранять картинки на сервер:";
$MESS ['parser_index_element'] = "Индексировать элементы в поиске:";
$MESS ['parser_code_element'] = "Создавать символьный код из названия:";
$MESS ['parser_resize_image'] = "Использовать настройки инфоблока для обработки изображений:";
$MESS ['parser_create_sitemap'] = "По окончании создавать карту сайта:";
$MESS ['parser_meta_description'] = "Парсить мета-описание страниц:";
$MESS ['parser_meta_keywords'] = "Парсить ключевые слова страниц:";
$MESS ['parser_meta_description_text'] = "Описание страницы:";
$MESS ['parser_meta_keywords_text'] = "Ключевые слова:";
$MESS ['parser_meta_title'] = "Парсить заголовок страниц:";
$MESS ['parser_first_title'] = "Записывать ссылку на первоисточник:";
$MESS ['parser_meta_description'] = "Парсить мета-описание страниц:";
$MESS ['parser_meta_keywords'] = "Парсить ключевые слова страниц:";
$MESS ['parser_start_agent'] = "Запускать по агенту:";
$MESS ['parser_time_agent'] = "Периодичность запуска(в секундах):";
$MESS ['parser_active_element'] = "Создавать активные элементы:";
$MESS ['parser_start_last_time'] = "Время последнего запуска:";
$MESS ['parser_sleep'] = "Время задержки(сек):";
$MESS ['parser_sleep_descr'] = "Некоторые сайты осуществляют контроль активности, то есть, если количество обращений к сайту за единицу времени будет более установленного значения, то пользователь будет блокирован. Для обхода данной защиты установите временные задержки между обращениями парсера к сайту.:";

$MESS ['parser_sleep_descr_xml'] = "Некоторые сайты осуществляют контроль активности, то есть, если количество обращений к сайту за единицу времени будет более установленного значения, то пользователь будет блокирован. Для обхода данной защиты установите временные задержки между обращениями парсера к сайту. Актуальна только при удаленном размещении XML файла.";

$MESS ['parser_selector_descr'] = 'Полный путь к селектору контента обозначается аналогично JQuery. <br/>Примеры: div#simpleid div.content; div#simpleid div.content:eq(0); div#simpleid div.content[style="margin-top:30px"]:eq(1)';
$MESS ['parser_first_url_descr'] = 'Не обязательное поле. Применяется, если rss лента включает в себя информацию с различных источников. Это поле позволяет указать URL, по которому будет производиться парсинг. То есть парсинг будет осуществляться, если в rss ленте будут найдены совпадения по указанному урлу. Пример: 1с-bitrix.ru(без указания www и http)';
$MESS ['parser_first_url_descr_page'] = 'Не обязательное поле. Применяется, если страница включает в себя информацию с различных источников. Это поле позволяет указать URL, по которому будет производиться парсинг. То есть парсинг будет осуществляться, если на странице будут найдены совпадения по указанному урлу. Пример: 1с-bitrix.ru(без указания www и http)';


$MESS ['parser_encoding_descr'] = "Кодировка сайта, который собираемся парсить. Определяется автоматически. Если не определена, то будет учитываться именно установленное вами значение.";

$MESS ['parser_preview_first_img_descr'] = "Картинка для превью будет браться первой из описания. Если таковой нет, то будет произведен поиск по всем атрибутам rss элементов потока.";
$MESS ['parser_preview_save_img_descr'] = "Сохранять все картинки из описания на сервер и заменять их пути своими.";
$MESS ['parser_preview_delete_element_descr'] = 'Удаляет перечисленные элементы. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a, div.simpleclass:eq(5), div.simpleclass[align="left"]:eq(0)';
$MESS ['parser_preview_delete_attribute_descr'] = 'Удаляет перечисленные атрибуты элементов. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a[href]';

$MESS ['parser_detail_first_img_descr'] = "Картинка для превью будет браться первой из контента.";
$MESS ['parser_detail_save_img_descr'] = "Сохранять все картинки из описания на сервер и заменять их пути своими.";
$MESS ['parser_detail_delete_element_descr'] = 'Удаляет перечисленные элементы. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a, div.simpleclass:eq(5), div.simpleclass[align="left"]:eq(1)';
$MESS ['parser_detail_delete_attribute_descr'] = 'Удаляет перечисленные атрибуты элементов. Перечисление идет через запятую. <br/>Примеры: div.simpleclass a[href]';
$MESS["parser_category_select"] = "Выберите категорию парсера";
$MESS["parser_category_title"] = "Категория:";
$MESS ['parser_prop_id'] = "Выбор свойства из списка";
$MESS ['parser_date_type'] = "Выбор типа даты";
$MESS ['parser_date_public'] = "Записывать дату публикации:";
$MESS ['parser_date_active'] = "Устанавливать дату начала активности:";
$MESS ['parser_date_active_now'] = "Текущая дата";
$MESS ['parser_date_active_now_time'] = "Текущая дата и время";
$MESS ['parser_date_active_public'] = "Дата публикации в источнике";
$MESS ['parser_demo'] = "Модуль \"Парсер контента\" работает в демо-режиме.";

$MESS ['parser_type'] = "Тип парсера:";
$MESS ['parser_catalog_message'] = "Функционал парсинга каталога будет реализован в новом 2104 году! Следите за новостями и подписывайтесь на обновления модуля. Компания «Сотбит» работает для Вас.";

$MESS ['parser_pagenavigation_selector'] = "Селектор навигации:";
$MESS ['parser_pagenavigation_begin'] = "Начинать со страницы:";
$MESS ['parser_pagenavigation_one'] = "Селектор-атрибут пункта навигации:";
$MESS ['parser_pagenavigation_selector_descr'] = "Пример: .pagenavigation";
$MESS ['parser_pagenavigation_one_descr'] = "Задается относительно предыдущего параметра. Например: a[href]. Если поле пустое или нет атрибута, то по умолчанию a[href]. Если ссылка отсутствует и постраничная навигация отрабатывается скриптами, то необходимо воспользоваться блоком Работа с постраничной навигацией, расположенным ниже.";
$MESS ['parser_pagenavigation_delete'] = "Удалять элементы навигации:";
$MESS ['parser_preview_text_selector'] = "Селектор превью описания:";
$MESS ['parser_xml_text_selector'] = "Селектор-атрибут описания:";
$MESS ['parser_detail_text_selector'] = "Селектор детального описания:";
$MESS ['parser_selector_catalog_descr'] = "Пример: .catalog-section. Далее все селектора в этой закладке идут относительно заданного параметра ";
$MESS ['parser_selector_detail_catalog_descr'] = "Пример: .catalog-detail. Далее все селектора в этой закладке идут относительно заданного параметра ";
$MESS ['parser_preview_text_type_catalog'] = "Тип превью описания:";
$MESS ['parser_preview_delete_tag_catalog'] = "Удалять теги из описания:";
$MESS ['parser_preview_first_img_descr_catalog'] = "По умолчанию img:eq(0)[src]. Если картинка находится в другом элементе или атрибуте, то записываем, например: a:eq(0)[href]";
$MESS ['parser_preview_first_img_descr_xml'] = "Если картинки находится в атрибуте, то атрибут указываем в квадратных скобках, например: picture:eq(0), picture:eq(0)[src].";
$MESS ['parser_detail_first_img_descr_catalog'] = "По умолчанию img:eq(0)[src]. Если картинка находится в другом элементе или атрибуте, то записываем, например: a:eq(0)[href]. Также может возникнуть ситуация, когда селекторы детальной картинки могут отличаться в зависимости от ряда условия(одна картинка или их несколько). В этом случае перечисление селекторов идет через запятую.";
$MESS ['parser_detail_text_type_catalog'] = "Тип детального описания:";
$MESS ['parser_preview_price'] = "Селектор цены:";
$MESS ['parser_preview_price_xml'] = "Селектор-атрибут цены:";
$MESS ['parser_categoryId_catalog'] = "Селектор-атрибут категории товара:";
$MESS ['parser_selector_description_xml_descr'] = "Если описание находится в атрибуте, то атрибут указываем в квадратных скобках, например: description[name].";
$MESS ['parser_props_tab'] = "Свойства";
$MESS ['parser_preview_price_descr'] = "Если пустое, то селектор цены надо указывать на детальной странице товара. Если оба поля заполнены, то предпочтение отдается детальной странице.";
$MESS ['parser_preview_price_descr_xml'] = "Если цена находится в атрибуте, то атрибут указываем в квадратных скобках, например: [price].";
$MESS ['parser_price_type'] = "Тип цены:";
$MESS ['parser_currency'] = "Валюта:";
$MESS ['parser_catalog_tab'] = "Торговый каталог";
$MESS ['parser_catalog_koef'] = "Коэффициент единицы измерения:";
$MESS ['parser_measure'] = "Единица измерения:";

$MESS ['parser_href_catalog'] = "Селектор ссылки товара:";
$MESS ['parser_name_catalog'] = "Селектор названия товара:";
$MESS ['parser_name_catalog_xml'] = "Селектор-атрибут названия товара:";
$MESS ['parser_href_descr_catalog'] = "Если ничего не задано, то переход по страницам будет осуществляться по первой найденной ссылке в селекторе списка товаров. Селектор указывается относительно селектора товара.";
$MESS ['parser_categoryId_descr_catalog'] = "Айди категории, к которой будет прикреплен товар. Если айди находится в атрибуте, то атрибут указываем в квадратных скобках, например: [categoryId].";
$MESS ['parser_name_descr_catalog'] = "Если ничего не задано, то название товара будет браться, как текст селектора ссылки. Селектор указывается относительно селектора товара.";
$MESS ['parser_size_selector'] = "Парсинг размеров по селектору";

$MESS ['parser_size_length'] = "Длина, мм:";
$MESS ['parser_size_width'] = "Ширина, мм:";
$MESS ['parser_size_height'] = "Высота, мм:";
$MESS ['parser_size_weight'] = "Вес, гр:";
$MESS ['parser_selector_size_descr'] = "Парсинг размеров будет осуществляться по конкретным селекторам. Селектора идут относительно главного селектора товара. Также можно удалить лишние символы(двоеточие, точки с запятой и подобные). При удалении символы чередуются через запятую. Если необходимо удалить запятую, то дважды экранируем ее(\\\,).";

$MESS ['parser_size_find'] = "Парсинг размеров по названию";
$MESS ['parser_selector_find'] = "Селектор перечисления размеров:";
$MESS ['parser_find_size_descr'] = "Парсинг осуществляется по селектору перечисления размеров. И уже в нем осуществляется поиск размеров по конкретным названиям. Также можно удалить лишние символы(ед. измерения, двоеточия, точки с запятой и подобные). При удалении символы чередуются через запятую. Если необходимо удалить запятую, то дважды экранируем ее(\\\,).";

$MESS ['parser_more_image'] = "Доп. картинки";
$MESS ['parser_selector_more_image'] = "Селектор-атрибут перечисления доп. картинок:";
$MESS ['parser_selector_more_image_xml'] = "Селектор-атрибут перечисления доп. картинок:";
$MESS ['parser_selector_more_image_descr'] = "Пример: .image_list img[src]";
$MESS ['parser_selector_more_image_xml_descr'] = "Если картинки находится в атрибуте, то атрибут указываем в квадратных скобках, например: picture, picture[src].";

$MESS ['parser_selector_props'] = "Парсинг свойств из деталки по селектору";
$MESS ['parser_selector_props_xml'] = "Парсинг свойств по селектору";
$MESS ['parser_more_image_prop'] = "Свойство доп. картинок:";
$MESS ['parser_find_props'] = "Парсинг свойств из деталки по названию";
$MESS ['parser_find_props_xml'] = "Парсинг свойств и автоматическое создание";
$MESS ['parser_add_auto_props'] = "Автоматическое создание свойств:";
$MESS ['parser_add_auto_props_descr'] = "При включении несуществующие свойства будут создаваться автоматически, исходя из настроек ниже. ";
$MESS ['parser_selector_props_preview'] = 'Парсинг свойств из превью по селектору';
$MESS ['parser_find_props_preview'] = 'Парсинг свойств из превью по названию';
$MESS ['parser_selector_find_props'] = "Селектор перечисления свойств:";
$MESS ['parser_selector_find_props_xml'] = "Селектор перечисления свойств:";
$MESS ['parser_attr_auto_props'] = "Селектор-атрибут названия свойства:";
$MESS ['parser_attr_auto_props_descr'] = "Укажите селектор-атрибут, в котором находится название свойства.<br /><br />Если название свойства находится в атрибуте \"Селектор перечисления свойств:\", то укажите этот атрибут, например: [name]. <br /> Во всех остальных случаях укажите селектор и атрибут, например: value[name], или просто селектор, например: value<br /><br />
Если свойство или несколько свойств с таким названием существует, то текущее значение будет записано во все свойства. Поиск свойств по названию происходит среди свойств типа S - строка, N - числовое и L - список.";
$MESS ['parser_type_list'] = "[L]-список";
$MESS ['parser_selector_attr_value_auto_props'] = "Селектор-атрибут значения свойства:";
$MESS ['parser_selector_attr_value_auto_props_descr'] = "Если пусто, то значение свойства будет браться как текст из \"Селектор перечисления свойств.\"<br />Если значение свойства находиться в атрибуте \"Селектор перечисления свойств\", то укажите атрибут, например: [value]<br /><br />Во всех остальных случаях укажите селектор и атрибут, например: value, value_props[value]";

$MESS ['parser_uniq_descr_xml'] = "По умолчанию при выгрузке товаров заполняется внешний код XML_ID элемента, как md5(название+id элемента xml файла). Далее при обновлении уникализация осуществляется именно по внешнему коду. <br/><br /><b>Внимание! Если вы не хотите делать запись во внешний код и уникализировать по нему товар, то укажите, по какому полю производить уникализацию элементов. В этом случае внешний код XML_ID затираться не будет.</b>";

$MESS ['parser_type_string'] = "[S]-строка";
$MESS ['parser_category_description'] = "Категории";
$MESS ['parser_offer_description'] = "Товары";
$MESS ['parser_mode'] = "Режим парсера:";
$MESS ['parser_mode_descr'] = "При debug режиме осуществляется парсинг первых 3 страниц и 3 товаров каждой страницы. Debug режим необходим для отладки парсера. В рабочий режим парсер необходимо переводить, если вы полностью отладили и настроили парсинг!!!<br/><b>Работа парсера в демо-режиме ограничена и фактически аналогична работе парсера в debug режиме.</b>"; 

$MESS ['parser_header_uniq'] = "Проверка уникальности";
$MESS ['parser_uniq_update'] = "Обновлять товары";
$MESS ['parser_header_uniq_field'] = "Обновлять поля";
$MESS ['parser_header_uniq_field_preview_descr'] = "Превью описание:";
$MESS ['parser_header_uniq_field_detail_descr'] = "Детальное описание:";
$MESS ['parser_header_uniq_field_preview_img'] = "Превью картинка:";
$MESS ['parser_header_uniq_field_detail_img'] = "Детальное картинка:";
$MESS ['parser_header_uniq_field_price'] = "Цена:";
$MESS ['parser_header_uniq_field_name'] = "Наименование:";
$MESS ['parser_header_uniq_field_descr'] = "Отмеченные поля будут обновляться при обновлении товаров.";
$MESS ['parser_uniq_name'] = "По названию:";
$MESS ['parser_uniq_prop'] = "По свойству:";
//$MESS ['parser_uniq_descr'] = "По умолчанию уникальность элементов проверяется по md5 от названия элемента и урла первоисточника. Эти данные заносятся в XML_ID и далее уже по XML_ID проверяется уникальность. Вы можете изменить поля, по которым будет проверяться уникальность. Если выбрано несколько полей, то проверка уникальности будет по логике И. Если вы не хотите использовать поле XML_ID для проверки уникальности(как по умолчанию), то вам надо переопределить, по каким полям будет проверяться уникальность.";
$MESS ['parser_uniq_descr'] = "По умолчанию при выгрузке товаров заполняется внешний код XML_ID элемента, как md5(название+url страницы). Далее при обновлении уникализация осуществляется именно по внешнему коду. <br/><b>Внимание! Если вы не хотите делать запись во внешний код и уникализировать по нему товар, то укажите, по какому полю производить уникализацию элементов. В этом случае внешний код XML_ID затираться не будет.</b>";


$MESS ['parser_preview_from_detail'] = "Создавать превью картинку из детальной:";
$MESS ['parser_preview_from_detail_text'] = "Создавать превью описание из детального:";
$MESS ['parser_catalog_delete_symb'] = "Удалять символы:";
$MESS ['parser_delete_symb_descr'] = "Удаление символов позволяет удалять лишние символы из общего селектора свойства(названия ед. измерения, двоеточия, точки с запятой и подобное). Перечисление идет через запятую. Если необходжимо удалить саму запятую, то производим двойное экранирование(\\\,).";

$MESS ['parser_delete_symb_xml_descr'] = "Удаление символов позволяет удалять лишние символы из свойства(названия ед. измерения, двоеточия, точки с запятой и подобное). Перечисление идет через запятую. Если необходжимо удалить саму запятую, то производим двойное экранирование(\\\,).";
$MESS ['parser_delete_symb_descr_offer'] = "Удаление символов позволяет удалять лишние символы из общего селектора свойства(названия ед. измерения, двоеточия, точки с запятой и подобное). Перечисление идет через ||.<br><br>Также возможно указание регулярных выражений. Регулярка заключается в кавычки //. Пример: /(.)*/";

$MESS ['parser_delete_symb_descr_xml_offer'] = "Удаление символов позволяет удалять лишние символы из значения свойства(названия ед. измерения, двоеточия, точки с запятой и подобное). Перечисление идет через ||.<br><br>Также возможно указание регулярных выражений. Регулярка заключается в кавычки //. Пример: /(.)*/";

$MESS ['parser_header_uniq_field_more_img'] = "Доп. картинки:";
$MESS ['parser_cat_vat_id'] = "Ставка НДС:";
$MESS ['parser_cat_vat_included'] = "Включать НДС в цену:";
$MESS ['parser_proxy'] = "Прокси-сервер:";
$MESS ['parser_offer_parsing_selector_xml_name'] = "Селектор-атрибут наименования:";
$MESS ['parser_offer_parsing_selector_price_xml'] = "Селектор-атрибут цены:";
$MESS ['parser_proxy_descr'] = "Указывается прокси-сервер. Пример: 109.194.20.27:3128";
$MESS ['parser_header_uniq_field_param'] = "Параметры каталога:";
$MESS ['parser_header_uniq_field_props'] = "Свойства товара:";
$MESS ['parser_pagenavigation_end'] = "по страницу:";
$MESS ['parser_pagenavigation_begin_descr'] = "Если ничего не задано, то будет парсится весь раздел каталога.";
$MESS ['parser_404_error'] = "Парсить при возникновении 404 ошибки:";
$MESS ['parser_404_descr'] = "Некоторые сайты при переходе по страницам навигации отдают 404 ошибку из-за SEO заморочек. Именно для таких случаев и предназначен выше приведенный параметр.";
$MESS ['parser_logs_tab'] = "Логи";
$MESS ['parser_header_logs'] = "Включить логирование:";
$MESS ['parser_header_logs_download'] = "Скачать лог:"; 
$MESS ['parser_header_log_descr'] = "Производится логирование последней выгрузки. Лог записывается файл."; 
$MESS ['btn_stop_catalog'] = "Остановить";
$MESS ['parser_load_page'] = "Обработано страниц: ";    
$MESS ['parser_load_product'] = " Импортировано товаров: ";
$MESS ['parser_load_product_error'] = " Из них с ошибками: ";
$MESS ['parser_all_error'] = " Всего ошибок: ";
$MESS['parser_instructions'] = "Инструкция";
$MESS['parser_instructions_title'] = "Инструкция пользователя";
$MESS['parser_loading_end'] = "Загрузка завершена"; 

$MESS['parser_update_N'] = "Не обновлять";
$MESS['parser_update_Y'] = "Обновлять";
$MESS['parser_update_empty'] = "Обновлять пустое значение";

$MESS['parser_work_price'] = "Работа с ценами";

$MESS['parser_price_terms_no'] = "Без условия";
$MESS['parser_price_terms_up'] = "Если цена выше";
$MESS['parser_price_terms_down'] = "Если цена ниже";
$MESS['parser_price_updown_no'] = "Не изменять";
$MESS['parser_price_updown_up'] = "Увеличить";
$MESS['parser_price_updown_down'] = "Уменьшить";
$MESS['parser_price_percent'] = "Проценты";
$MESS['parser_price_abs_value'] = "Абсолютная величина";
$MESS['parser_price_updown'] = 'Изменять цену:';
$MESS['parser_price_terms'] = 'Условие изменения цены:';
$MESS['parser_price_type_value'] = 'Тип изменения:';
$MESS['parser_price_value'] = 'Величина изменения:';
$MESS['parser_convert_currency'] = 'Конвертировать в валюту:'; 
$MESS['parser_convert_no'] = 'Нет';
$MESS['parser_step'] = 'Количество товаров, выгружаемых за один шаг парсера:';
$MESS['parser_start_agent_descr'] = 'Рекомендуется запускать агенты из под крона.';
$MESS['parser_auth'] = 'Авторизация';
$MESS['parser_auth_active'] = 'Производить авторизацию на стороннем сайте:';
$MESS['parser_auth_url'] = 'URL авторизационной страницы:';
$MESS['parser_auth_url_descr'] = 'URL страницы, на которой происходит авторизация. Если пустое, то авторизация происходит на странице раздела.';
$MESS['parser_auth_url_xml_descr'] = 'URL страницы, на которой происходит авторизация.';
$MESS['parser_auth_selector'] = 'Селектор формы авторизации:';
$MESS['parser_auth_login'] = 'Логин:';
$MESS['parser_auth_login_name'] = 'Имя поля логина:';
$MESS['parser_auth_password'] = 'Пароль:';
$MESS['parser_auth_password_name'] = 'Имя поля пароля:';
$MESS['parser_auth_password_descr'] = 'Если форма авторизации стандартная, то по-умолчанию достаточно указать лишь логин и пароль. Если же для авторизации не используются такие типы полей, как text, password, то необходимо указать имена полей.';
$MESS['parser_auth_check'] = 'Проверить авторизацию';
$MESS['parser_work_price_num'] = 'Условие';
$MESS['parser_price_num_add'] = 'Добавить условие';
$MESS['parser_price_num_del'] = 'Удалить условие';
$MESS['parser_price_terms_delta'] = 'Если цена в промежутке';
$MESS['parser_price_from'] = 'От';
$MESS['parser_price_to'] = 'До';
$MESS['parser_auth_no'] = 'Неудачная авторизация. Ключи доступа не подходят.';
$MESS['parser_auth_ok'] = 'Авторизация прошла успешно. Ключи доступа актуальные.';
$MESS['parser_auth_error_selector'] = 'Селектор формы авторизации не определен.';
$MESS['parser_selector_find_descr'] = 'Если общий селектор отсутствует и перечисление идет через тег &lt;br&gt;, то пишем примерно следующее: .props br';
$MESS['parser_selector_find_xml_descr'] = 'Укажите селектор, который является контейнером для одного свойства. Например: param';
$MESS['type_add_auto_props'] = 'Выберите тип создаваемых свойств:';
$MESS['type_add_auto_props_description'] = 'Все созданные свойства будут иметь указанный тип. S - строка, L - список. Если свойство уже есть в системе, то оно не будет менять свой тип.';
$MESS['parser_detail_name'] = 'Селектор названия товара';
$MESS['parser_detail_name_descr'] = 'Если указан, то селектор названия товара в превьюшке будет игнорироваться.';

$MESS['parser_cat_price_offer'] = 'Цены только в инфоблоке торговых предложений:';
$MESS['parser_url_dop'] = 'Дополнительные урлы разделов:';
$MESS['parser_url_xml_dop'] = 'Дополнительные урлы XML файлов:';
$MESS['parser_add_section'] = "Создавать разделы из XML файла";
$MESS['parser_url_dop_descr'] = 'Поле предназначено для парса нескольких разделов одновременно. Каждый урл пишется с новой строки.';
$MESS['parser_url_dop_descr_xml'] = 'Поле предназначено для парса нескольких XML файлов одновременно. Каждый урл файла пишется с новой строки.';
$MESS['parser_add_section_descr'] = 'При включении парсер создаст категории внутри инфоблока и распределит товары согласно данным из XML.';
$MESS['parser_prop_default'] = "Значение по умолчанию";

$MESS ['parser_video_tab'] = "Видео-инструкции";
$MESS ['parser_video_catalog_descr'] = "Видео-урок: Парcер контента в режиме работы с каталогами. Сотбит. 1С-Битрикс.";
$MESS ['parser_video_xml_descr'] = "Видео-урок: Парcер контента в режиме работы с xml. Сотбит. 1С-Битрикс.";
$MESS ['parser_video_page_descr'] = "Видео-урок: Парcер контента в режиме работы с новостными страницами. Сотбит. 1С-Битрикс.";
$MESS ['parser_video_rss_descr'] = "Видео-урок: Парcер контента в режиме работы с rss лентами. Сотбит. 1С-Битрикс. ";

$MESS ['parser_price_format'] = "Формат цены(разделители):";
$MESS ['parser_price_format1'] = " тысячи ";
$MESS ['parser_price_format2'] = " копейки ";
$MESS ['parser_price_format_descr'] = "Заполняется в том случае, если цена состоит из тысяч и копеек со своими разделителями. В большинстве случаев можно оставлять пустым.";

$MESS["shs_parser_select_prop"] = "Выберите свойство";
$MESS["shs_parser_select_prop_new"] = "[Создать]";
$MESS["parser_iblock_id_descr"] = "При изменении инфоблока необходимо сохранить настройки.";
$MESS["parser_price_okrug"] = "Округление цены:";
$MESS["parser_price_okrug_no"] = "Не округлять";
$MESS["parser_price_okrug_up"] = "Округлять с указанной точностью";
$MESS["parser_price_okrug_ceil"] = "Округление в большую сторону до целого";
$MESS["parser_price_okrug_floor"] = "Округление в меньшую сторону до целого";
$MESS["parser_price_okrug_delta1"] = "до";
$MESS["parser_price_okrug_delta2"] = "знаков после запятой";
$MESS["parser_price_okrug_descr"] = "Округления до целых чисел точность(количество знаков после запятой) не учитывают.";

$MESS["shs_parser_select_prop_but"] = "Добавить";
$MESS["parser_prop_detail_preview_descr"] = "Внимание! Свойства, выгруженные с детальной страницы, являются приоритетными.";
$MESS["parser_prop_detail_preview_descr_file"] = "<br/><br/>При парсинге свойств по селектору возможен парсинг свойств типа файл(F). Для этого необходимо указать селектор элемента и атрибут, например: .instructions[href]<br><br>Также возможен парсинг свойств из атрибутов элементов: a[title], img[title].";
$MESS["parser_prop_detail_preview_descr_file_xml"] = "Если значение свойства находится непосредственно в селекторе, то пишем, например, следующее: param, если значение свойства находится в атрибуте, то например: param[title]";
$MESS["parser_offer_tab"] = "Торговые предложения";
$MESS["parser_offer_selector"] = "Главный селектор контейнера торговых предложений:";
$MESS["parser_offer_selector_item"] = "Селектор отдельного оффера:";
$MESS["parser_offer_table_desc"] = "Торговые предложения табличного вида";
$MESS["parser_offer_container_desc"] = "Торговые предложения из отдельного контейнера";
$MESS["parser_offer_load_no"] = "Не выгружать";
$MESS["parser_offer_load_table"] = "Выгружать из табличного вида";
$MESS["parser_offer_load"] = "Выгружать офферы:";
$MESS["parser_offer_selector_head"] = "Селектор блока шапки таблицы:";
$MESS["parser_offer_selector_head_th"] = "Селектор наименования параметра в шапке таблицы:";
$MESS["parser_offer_selector_head_th_descr"] = "Необходим, если поля и свойства определяются по названию. Относительно предыдущего поля. Пример: th, td";
$MESS["parser_offer_selector_item_td"] = "Селектор значения параметра в теле таблицы:";
$MESS["parser_offer_selector_item_td_descr"] = "Необходим, если поля и свойства определяются по названию. Считается относительно предыдущего поля. Пример: td";
$MESS["parser_offer_parsing_selector"] = "Парсинг полей и свойств по селектору";
$MESS["parser_offer_parsing_find"] = "Парсинг полей и свойств по названию";
$MESS["parser_offer_parsing_selector_name"] = "Наименование:";
$MESS["parser_offer_parsing_selector_price"] = "Цена:";
$MESS["parser_offer_load_descr"] = "После изменения параметра необходимо Применить настройки.";
$MESS["parser_offer_selector_descr"] = "Относительно селектора товара на детальной странице. Пример: table, .mainOfferTable";
$MESS["parser_offer_selector_head_descr"] = "Необходим, если поля и свойства определяются по названию. Считается относительно предыдущего параметра. Данный параметр необходим, если парсинг полей и свойств осуществляется по названию. Пример: thead tr, tr:eq(0)";
$MESS["parser_offer_selector_item_descr"] = "Считается относительно главного контейнера офферов. Пример: tbody tr, tr:eq(0)+tr";
$MESS["parser_offer_parsing_selector_prop"] = "Парсинг свойств по селектору";
$MESS["parser_offer_table_desc_1"] = "Артикул";
$MESS["parser_offer_table_desc_2"] = "Цвет";
$MESS["parser_offer_table_desc_3"] = "Формат, мм";
$MESS["parser_offer_table_desc_4"] = "Кол-во страниц";
$MESS["parser_offer_table_desc_5"] = "Кол-во языков";
$MESS["parser_offer_table_desc_6"] = "Плотность бумаги";
$MESS["parser_offer_table_desc_7"] = "Блок";
$MESS["parser_offer_table_desc_8"] = "Цена (без НДС), руб.";
$MESS["parser_offer_table_desc_9"] = "коричневый";
$MESS["parser_offer_table_desc_10"] = "70 г/м";
$MESS["parser_offer_table_desc_11"] = "шитый";
$MESS["parser_offer_table_desc_12"] = "А5";
$MESS["parser_offer_parsing_find_prop"] = "Парсинг свойств по названию";
$MESS["parser_header_element_action"] = "Действия над элементами";
$MESS["parser_element_action"] = "Что делать с товарами, присутствующими в предыдущей выгрузке и отсутствующими в текущей:";
$MESS["parser_offer_add_name"] = "Параметр уникализации офферов:";
$MESS["parser_default_props"] = "Значения свойств по умолчанию";
$MESS["parser_action_N"] = "ничего";
$MESS["parser_action_A"] = "деактивировать";
$MESS["parser_action_D"] = "удалить";
$MESS["parser_add_delete_symb_props"] = "Добавление/удаление символов полей и свойств";
$MESS["parser_SOTBIT_PARSER_NAME_E"] = "Название товара";
$MESS["parser_action_props_delete"] = "Удалить";
$MESS["parser_action_props_add_begin"] = "Добавить в начало";
$MESS["parser_action_props_add_end"] = "Добавить в конец";
$MESS["shs_parser_select_action_props"] = "Выберите действие";
$MESS["shs_parser_action_props_descr"] = htmlspecialchars("Укажите необходимые символы или слова, если вы хотите удалить/добавить их к указанному полю или свойству. Если необходимо записать пробел, то укажите его спец. символ: &nbsp;")."<br><br>Внимание! Действия возможны только над свойствами и полями типа Строка(S)";
$MESS["parser_element_action_descr"] = "Работает в том случае, если отмечена галочка Обновлять товары. Товары из предыдущей выгрузки сравниваются с товарами из текущей. На основании этого и производятся действия над элементами.";
$MESS["parser_offer_add_name_descr"] = "<b>Важный параметр!!! Особенности:</b><br>1. Указанные свойства добавляются в название оффера.<br>2. Если название оффера отсутствует, то название полностью будет состоять из значений указанных свойств.<br>3. По данному параметру происходит уникализации офферов.<br>4. Если ничего не указано, то уникальность будет определяться по названию оффера.";
$MESS["parser_offer_add_name_one_descr"] = "<b>Важный параметр!!! Особенности:</b><br>1. Указанные свойства добавляются в название оффера.<br>2. По данному параметру происходит уникализации офферов.";

$MESS["parser_offer_parsing_selector_name_descr"] = "Название торгового предложения. Может быть пустое, если отмечены свойства параметра уникализации. Тогда название будет состоять из значений указанных свойств.";
$MESS["parser_offer_parsing_selector_price_descr"] = "Если пусто, то цена будет браться из блока Превью или Детально";
$MESS["parser_offer_parsing_selector_price_xml_descr"] = "Если пусто, то цена будет браться из блока \"Основные настройки\"";
$MESS["parser_offer_load_one"] = "Офферы с одной характеристикой";
$MESS["parser_offer_load_container"] = "Офферы из отдельного контейнера";
$MESS["parser_offer_selector_item_xml_descr"] = "Считается относительно \"Селектор конкретного товара\"";
$MESS["parser_offer_one_selector"] = "Селектор контейнера отдельной характеристики оффера";
$MESS["parser_offer_one_selector_descr"] = "Фактически это селектор выбора характеристики оффера, который указан в Параметре уникализации. Пример: select option, #charect div.size";
$MESS["parser_offer_one_price_attr"] = "Атрибут цены";
$MESS["parser_offer_one_price_attr_descr"] = "Иногда цена записывается в атрибут предыдущего параметра. Например: data-price. Если ничего не задано, то цена будет браться из вкладок Превью или Детально.";
$MESS["parser_offer_one_price_attr_xml_descr"] = "Иногда цена записывается в атрибут предыдущего параметра. Например: data-price. Если ничего не задано, то цена будет браться из вкладок \"Основные настройки\".";
$MESS["parser_work_pagenavigation"] = "Работа с постраничной навигацией";
$MESS["parser_work_pagenavigation_var"] = "Переменная-параметр постраничной навигации";
$MESS["parser_work_pagenavigation_other_var"] = "Другие переменные-параметры";
$MESS["parser_work_pagenavigation_page_count"] = "Количество страниц навигации";
$MESS["parser_standart_pagenavigation"] = "Стандартная постраничная навигация";
$MESS["parser_work_pagenavigation_descr"] = "Данный блок предназначен, если стандартная навигация не работает(отсутствие ссылок href). В таком случае вы можете настроить постраничную навигацию самостоятельно.";
$MESS["parser_work_pagenavigation_var_descr"] = "Переменная в урле, отвечающая за постраничную навигацию. Пример: page, PAGE_1. Далее парсер сам будет подставлять значения к этой переменной. Например: page=1, page=2";
$MESS["parser_work_pagenavigation_other_var_descr"] = "Перечислить переменные и их значения, которые также отвечают за постраничную навигацию. Пример: set_filter=Y&back=1&ajax=Y";
$MESS["parser_work_pagenavigation_page_count_descr"] = "Данный параметр необходимо заполнять, если блок Стандартной навигации не заполнен и вы заранее знаете количество страниц.";
$MESS["parser_local_tab"] = "Сервисы";
$MESS["parser_loc_type"] = "Тип перевода";
$MESS["parser_loc_no"] = "Не переводить";
$MESS["parser_loc_yandex"] = "Яндекс.Переводчик";
$MESS["parser_loc_yandex_key"] = "Ключ от API Яндекс.Переводчик";
$MESS["parser_loc_yandex_key_descr"] = "Данный ключ вы можете получить совершенно бесплатно по адресу: <a target='_blank' href='https://tech.yandex.ru/keys/get/?service=trnsl'>https://tech.yandex.ru/keys/get/?service=trnsl</a>";
$MESS["parser_loc_yandex_lang"] = "Направление перевода";
$MESS["parser_loc_yandex_lang_descr"] = "Может задаваться одним из следующих способов:<br>
- В виде пары кодов языков («с какого»-«на какой»), разделенных дефисом. Например, en-ru обозначает перевод с английского на русский.<br>
- В виде кода конечного языка (например ru). В этом случае сервис пытается определить исходный язык автоматически.<br><br>
Ограничения:<br>
- Максимальный размер передаваемого текста составляет 10000 символов.
";
$MESS["parser_loc_fields"] = "Переводить поля";
$MESS["parser_loc_fields_name"] = "Название";
$MESS["parser_loc_fields_preview_text"] = "Превью текст";
$MESS["parser_loc_fields_detail_text"] = "Детальное описание";
$MESS["parser_loc_fields_props"] = "Свойства";
$MESS["parser_loc_type_head"] = "Перевод текста";
$MESS["parser_loc_uniq"] = "Отправлять уникальный текст в Яндекс";
$MESS["parser_loc_uniq_domain"] = "Выберите домен";
$MESS["shs_parser_loc_uniq_no"] = "Не отправлять";
$MESS["parser_loc_uniq_domain_descr"] = "Осуществляется отправка только детального описания при создании нового элемента. При обновлении товаров отправка не осуществляется.<br><br>
Разрешается добавлять не более 100 текстов в сутки, при этом размер текста должен быть в пределах от 500 до 32000 символов.
";
$MESS["parser_auth_type"] = "Тип авторизации:";
$MESS["parser_auth_type_form"] = "Стандартная авторизация через form";
$MESS["parser_auth_type_http"] = "HTTP-аутентификация";
$MESS["button_caption"] = "Выбрать";
$MESS["parser_mode_descr_xml"] = "При debug режиме осуществляется парсинг первых 30 элементов XML файла. Debug режим необходим для отладки парсера. В рабочий режим парсер необходимо переводить, если вы полностью отладили и настроили парсинг!!!
Работа парсера в демо-режиме ограничена и фактически аналогична работе парсера в debug режиме.";
$MESS["parser_load_section_add"] = "Создано разделов";
$MESS["parser_encoding_xml"] = "Кодировка XML файла, который собираемся парсить. Определяется автоматически. Если не определена, то будет учитываться именно установленное вами значение. ";
$MESS["parser_mode_descr_yml"] = "По умолчанию парсер настроен для парсинга файлов формата yml.";
$MESS["parser_offer_one_separator"] = "Разделитель:";
$MESS["parser_offer_one_separator_xml_descr"] = htmlspecialchars("Если офферы, находящиеся в контейнере(например: <param name=\"size\">L, M, XL, XXL</param>),  разделены знаком, то укажите этот знак.");
?>52   74295|/shs.parser/admin/parser_edit_xml.php|487d1cbd<?
use Bitrix\Seo\Engine;
use Bitrix\Main\Text\Converter;
use Bitrix\Main\Localization\Loc;
use Bitrix\Main\IO\Path;

\Bitrix\Main\Loader::includeModule('seo');
\Bitrix\Main\Loader::includeModule('socialservices');   
global $shs_IBLOCK_ID;
/***
****  
***/
$tabControl->BeginNextTab();
$arEncoding['reference'] = array('utf-8', 'windows-1251');
$arEncoding['reference_id'] = array('utf-8', 'windows-1251');
$arType['reference'] = array('html', 'text');
$arType['reference_id'] = array('html', 'text');
$arMode['reference'] = array('debug', 'work');
$arMode['reference_id'] = array('debug', 'work');
$arTypeAddAutoProps['reference'] = array(GetMessage("parser_type_string"), GetMessage("parser_type_list"));
$arTypeAddAutoProps['reference_id'] = array('S', 'L');
$arFieldWriteIdSection['reference'] = array(GetMessage("field_xml_id"), GetMessage("field_ext"));
$arFieldWriteIdSection['reference_id'] = array('XML_ID', 'EXT_FIELD');
if($shs_DEMO!=1)
{
    unset($arMode['reference'][1]);
    unset($arMode['reference_id'][1]);    
}


$arOfferLoad['reference'] = array(GetMessage("parser_offer_load_no"), GetMessage("parser_offer_load_container"), GetMessage("parser_offer_load_one"));
$arOfferLoad['reference_id'] = array('', 'table', 'one');


$arTypeParser['reference'] = array('rss', 'page', 'catalog', 'xml');
$arTypeParser['reference_id'] = array('rss', 'page', 'catalog', 'xml');

$arUpdate['reference'] = array(GetMessage("parser_update_N"), GetMessage("parser_update_Y"), GetMessage("parser_update_empty"));
$arUpdate['reference_id'] = array('N', 'Y', 'empty');

$arAction['reference'] = array(GetMessage("parser_action_N"), GetMessage("parser_action_A"), GetMessage("parser_action_D"));
$arAction['reference_id'] = array('N', 'A', 'D');

//$arPriceTerms['reference'] = array(GetMessage("parser_price_terms_no"), GetMessage("parser_price_terms_up"), GetMessage("parser_price_terms_down"));
//$arPriceTerms['reference_id'] = array('', 'up', 'down');

$arPriceTerms['reference'] = array(GetMessage("parser_price_terms_no"), GetMessage("parser_price_terms_delta"));
$arPriceTerms['reference_id'] = array('', 'delta');  

$arPriceUpDown['reference'] = array(GetMessage("parser_price_updown_no"), GetMessage("parser_price_updown_up"), GetMessage("parser_price_updown_down"));
$arPriceUpDown['reference_id'] = array('', 'up', 'down');

$arPriceValue['reference'] = array(GetMessage("parser_price_percent"), GetMessage("parser_price_abs_value"));
$arPriceValue['reference_id'] = array('percent', 'value');

$arAuthType['reference'] = array(GetMessage("parser_auth_type_form"), GetMessage("parser_auth_type_http"));
$arAuthType['reference_id'] = array('form', 'http');


$hideCatalog = false;
if($isCatalog && CModule::IncludeModule('catalog') && CModule::IncludeModule('currency')/* && (($shs_IBLOCK_ID && CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y", "ID"=>$shs_IBLOCK_ID))->Fetch()) || !$shs_IBLOCK_ID)*/)
{   
    $dbPriceType = CCatalogGroup::GetList(
        array("SORT" => "ASC"),
        array()
    );
      
    while ($arPriceTypes = $dbPriceType->Fetch())
    {
        $arPriceType["reference"][] = $arPriceTypes["NAME_LANG"];
        $arPriceType["reference_id"][] = $arPriceTypes["ID"];
    }
    $arConvertCurrency["reference"][] = GetMessage("parser_convert_no");
    $arConvertCurrency["reference_id"][] = "";
    
    $arPriceOkrug["reference"] = array(GetMessage("parser_price_okrug_no"), GetMessage("parser_price_okrug_up"), GetMessage("parser_price_okrug_ceil"), GetMessage("parser_price_okrug_floor"));
    $arPriceOkrug["reference_id"] = array("", "up", "ceil", "floor");
    
    $lcur = CCurrency::GetList(($by="name"), ($order1="asc"), LANGUAGE_ID);
    while($lcur_res = $lcur->Fetch())
    {
        $arCurrency["reference"][] = $lcur_res["FULL_NAME"];
        $arCurrency["reference_id"][] = $lcur_res["CURRENCY"];
        $arConvertCurrency["reference"][] = $lcur_res["FULL_NAME"];
        $arConvertCurrency["reference_id"][] = $lcur_res["CURRENCY"];
    }
    $info = CModule::CreateModuleObject('catalog');
    
    if(!CheckVersion("14.0.0", $info->MODULE_VERSION))
    {   
        $dbResultList = CCatalogMeasure::getList(array(), array(), false, false, array("ID", "CODE", "MEASURE_TITLE", "SYMBOL_INTL", "IS_DEFAULT"));
        while($arMeasure = $dbResultList->Fetch())
        {
            $arAllMeasure["reference_id"][] = $arMeasure["ID"];
            $arAllMeasure["reference"][] = $arMeasure["MEASURE_TITLE"];
        }
    }
     
    $arVATRef = CatalogGetVATArray(array(), true);

}else $hideCatalog = true;

/*
if(isset($arrPropDop))
{
    $arrPropField['REFERENCE'] = array_merge($arrPropField['REFERENCE'], $arrPropDop["REFERENCE"]);
    $arrPropField['REFERENCE_ID'] = array_merge($arrPropField['REFERENCE_ID'], $arrPropDop["REFERENCE_ID"]);    
}*/

$arrActionProps['REFERENCE'] = array(GetMessage("parser_action_props_delete"), GetMessage("parser_action_props_add_begin"), GetMessage("parser_action_props_add_end"));
$arrActionProps['REFERENCE_ID'] = array("delete", "add_b", "add_e");
    

$disabled = false;
unset($arrDateActive['REFERENCE'][2]);
unset($arrDateActive['REFERENCE_ID'][2]);
$arrDate = ParseDateTime($shs_START_LAST_TIME_X, "YYYY.MM.DD HH:MI:SS");
if($shs_TYPE)$disabled  = 'disabled=""';
?>
    <tr>
        <td><?echo GetMessage("parser_type")?></td>
        <td><?=SelectBoxFromArray('TYPE', $arTypeParser, $shs_TYPE?$shs_TYPE:$_GET["type"], "", $disabled);?>
        <?if($disabled):?><input type="hidden" name="TYPE" value="<?=$shs_TYPE?>" /><?endif;?>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
                <?=BeginNote();?>
                <?echo GetMessage("parser_mode_descr_yml")?>
                <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_mode")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][mode]', $arMode, $shs_SETTINGS["catalog"]["mode"]?$shs_SETTINGS["catalog"]["mode"]:"debug", "", "");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_mode_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_act")?></td>
        <td width="60%"><input type="checkbox" name="ACTIVE" value="Y"<?if($shs_ACTIVE == "Y" || !$ID) echo " checked"?>>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_sort")?></td>
        <td><input type="text" name="SORT" value="<?echo !$ID?"100":$shs_SORT;?>" size="4"></td>
    </tr>
    <?if(isset($arCategory) && !empty($arCategory)):?>
    <tr>
        <td><?echo GetMessage("parser_category_title")?></td>
        <td><?=SelectBoxFromArray('CATEGORY_ID', $arCategory, isset($shs_CATEGORY_ID)?$shs_CATEGORY_ID:$parentID, GetMessage("parser_category_select"), "id='category' style='width:262px'");?></td>
    </tr>
    <?endif;?>
    <tr>
        <td><span class="required">*</span><?echo GetMessage("parser_name")?></td>
        <td><input type="text" name="NAME" value="<?echo $shs_NAME;?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><span class="required">*</span><?echo GetMessage("parser_xml_catalog")?></td>
        <td><input style="style="float: left;" id="RSS" type="text" name="RSS" value="<?echo $shs_RSS;?>" size="80" maxlength="500"><span class="adm-btn" id="butoon_rss"><?=GetMessage("button_caption")?></span>
        <?
        CAdminFileDialog::ShowScript(Array
            (
                "event" => "OpenFileXml",
                "arResultDest" => Array("FUNCTION_NAME" => "OpenFileXmlResult"),
                "arPath" => Array(),
                "select" => 'F',
                "operation" => 'O',
                "showUploadTab" => true,
                "showAddToMenuTab" => false,
                "fileFilter" => '',
                "allowAllFiles" => true,
                "saveConfig" => true
            )
        );
        ?>
        <script>
            document.getElementById("butoon_rss").onclick = OpenFileXml;
            var OpenFileXmlResult = function(filename,path,site)
            {
                if(path != "/") path = path + "/";
                document.getElementById('RSS').value = path + filename;
            }
        </script>
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top"><?echo GetMessage("parser_url_xml_dop")?></td>
        <td style="vertical-align:top">
            <textarea style="float: left" id="URL_DOP" name="SETTINGS[catalog][url_dop]" cols="65" rows="5"><?=$shs_SETTINGS["catalog"]["url_dop"]?></textarea><span class="adm-btn" id="butoon_url_dop"><?=GetMessage("button_caption")?></span>
        <?
        CAdminFileDialog::ShowScript(Array
            (
                "event" => "OpenFileXmlUrlDop",
                "arResultDest" => Array("FUNCTION_NAME" => "OpenFileXmlUrlDopResult"),
                "arPath" => Array(),
                "select" => 'F',
                "operation" => 'O',
                "showUploadTab" => true,
                "showAddToMenuTab" => false,
                "fileFilter" => '',
                "allowAllFiles" => true,
                "saveConfig" => true
            )
        );
        ?>
        <script>
            document.getElementById("butoon_url_dop").onclick = OpenFileXmlUrlDop;
            function trim()
            {
                return this.replace(/^\n+|\n+$/g, '');
            }
            var OpenFileXmlUrlDopResult = function(filename,path,site)
            {
                var str = document.getElementById('URL_DOP').value;
                str = str.trim();
                if (path != "/") path = path + "/";
                document.getElementById('URL_DOP').value = str + "\n" + path + filename;
            }
        </script>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_url_dop_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><span class="required">*</span><?echo GetMessage("parser_iblock_id_catalog")?></td>
        <td><?=SelectBoxFromArray('IBLOCK_ID', $arIBlock, $shs_IBLOCK_ID, GetMessage("parser_iblock_id"), "id='iblock' style='width:262px' ");?>
            <?/*?><?if($disabled):?><input type="hidden" name="IBLOCK_ID" value="<?=$shs_IBLOCK_ID?>" /><?endif;*/?>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_iblock_id_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_add_section")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][add_parser_section]" value="Y"<?if($shs_SETTINGS['catalog']['add_parser_section'] == 'Y') echo " checked"?>>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_add_section_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_section_id")?></td>
        <td><?=SelectBoxFromArray('SECTION_ID', $arSection, $shs_SECTION_ID, GetMessage("parser_section_id"), "id='section' style='width:262px'");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_encoding")?></td>
        <td><?=SelectBoxFromArray('ENCODING', $arEncoding, $shs_ENCODING);?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_encoding_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_step")?></td>
        <td><input type="text" name="SETTINGS[catalog][step]" value="<?echo $shs_SETTINGS["catalog"]["step"]?$shs_SETTINGS["catalog"]["step"]:300;?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_start_last_time")?></td>
        <td><input type="text" disabled name="START_LAST_TIME_X" value="<?echo $arrDate[DD].'.'.$arrDate[MM].'.'.$arrDate[YYYY].' '.$arrDate[HH].':'.$arrDate[MI].':'.$arrDate[SS];?>" size="20"></td>
    </tr>      
<?
//********************
//  
//********************
$tabControl->BeginNextTab();
?>  
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_category_description")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_section_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_category]" value="<?echo isset($shs_SETTINGS["catalog"]["selector_category"])?$shs_SETTINGS["catalog"]["selector_category"]:"categories category";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_section_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
     <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_attr_name_section_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][attr_category]" value="<?echo isset($shs_SETTINGS["catalog"]["attr_category"])?$shs_SETTINGS["catalog"]["attr_category"]:"";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_attr_category_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_attr_id_section_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][attr_id_category]" value="<?echo isset($shs_SETTINGS["catalog"]["attr_id_category"])?$shs_SETTINGS["catalog"]["attr_id_category"]:"[id]";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_attr_id_category_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_attr_id_parrent_category_catalog")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][attr_id_parrent_category]" value="<?echo isset($shs_SETTINGS["catalog"]["attr_id_parrent_category"])?$shs_SETTINGS["catalog"]["attr_id_parrent_category"]:"[parentId]";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_attr_id_parrent_category_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_field_id_category_catalog")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][field_id_category]', $arFieldWriteIdSection, $shs_SETTINGS["catalog"]["field_id_category"]?$shs_SETTINGS["catalog"]["field_id_category"]:"XML_ID", "", "");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_field_id_category_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_offer_description")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_preview_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector]" value="<?echo isset($shs_SETTINGS["catalog"]["selector"])?$shs_SETTINGS["catalog"]["selector"]:"offers offer";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_catalog_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_preview_id_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][id_selector]" value="<?echo isset($shs_SETTINGS["catalog"]["id_selector"])?$shs_SETTINGS["catalog"]["id_selector"]:"[id]";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_id_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_categoryId_catalog")?></td>
        <td><input type="text" name="SETTINGS[catalog][id_section]" value="<?echo isset($shs_SETTINGS["catalog"]["id_section"])?$shs_SETTINGS["catalog"]["id_section"]:"categoryId";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_categoryId_descr_catalog")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_name_catalog_xml")?></td>
        <td><input type="text" name="SETTINGS[catalog][name]" value="<?echo isset($shs_SETTINGS["catalog"]["name"])?$shs_SETTINGS["catalog"]["name"]:"name";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_name_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>

    <tr>
        <td><?echo GetMessage("parser_preview_price_xml")?></td>
        <td><input type="text" name="SETTINGS[catalog][preview_price]" value="<?echo isset($shs_SETTINGS["catalog"]["preview_price"])?$shs_SETTINGS["catalog"]["preview_price"]:"price";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_price_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_xml_text_selector")?></td>
        <td><input type="text" name="SETTINGS[catalog][detail_text_selector]" value="<?echo isset($shs_SETTINGS["catalog"]["detail_text_selector"])?$shs_SETTINGS["catalog"]["detail_text_selector"]:"description";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_description_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_first_img_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][preview_picture]" value="<?echo isset($shs_SETTINGS["catalog"]["preview_picture"])?$shs_SETTINGS["catalog"]["preview_picture"]:"picture:eq(0)";?>" size="40" maxlength="255" /></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_detail_first_img_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][detail_picture]" value="<?echo isset($shs_SETTINGS["catalog"]["detail_picture"])?$shs_SETTINGS["catalog"]["detail_picture"]:"picture:eq(0)";?>" size="40" maxlength="255" /></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_preview_first_img_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
<?
//********************
//
//********************
$tabControl->BeginNextTab();
?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_more_image")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_more_image_prop")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][more_image_props]', $arrPropFile, $shs_SETTINGS["catalog"]["more_image_props"], GetMessage("parser_prop_id"), "class='image_props'");?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_selector_more_image_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][more_image]" value="<?echo isset($shs_SETTINGS["catalog"]["more_image"])?$shs_SETTINGS["catalog"]["more_image"]:"picture";?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_more_image_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading" id="header_selector_prop">
        <td colspan="2"><?echo GetMessage("parser_default_props")?></td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["default_prop"]) && !empty($shs_SETTINGS["catalog"]["default_prop"])):?>
    <?foreach($shs_SETTINGS["catalog"]["default_prop"] as $code=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%">
            <?if($arrPropDop['REFERENCE_TYPE'][$code]=="L"):
            ?>
            <?=SelectBoxFromArray('SETTINGS[catalog][default_prop]['.$code.']', $arrPropDop["LIST_VALUES"][$code], $shs_SETTINGS["catalog"]["default_prop"][$code], "", "");?>
            <?elseif($arrPropDop['USER_TYPE'][$code]=="directory"):?>
            <?=SelectBoxFromArray('SETTINGS[catalog][default_prop]['.$code.']', $arrPropDop["LIST_VALUES"][$code], $shs_SETTINGS["catalog"]["default_prop"][$code], "", "");?>
            <?else:?>
            <input type="text" <?if(!$shs_SETTINGS["catalog"]["default_prop"][$code]):?>placeholder="<?=GetMessage("parser_prop_default")?>"<?endif;?> name="SETTINGS[catalog][default_prop][<?=$code?>]" value="<?=$shs_SETTINGS["catalog"]["default_prop"][$code]?>" />
            <?endif?>
        </td>
    </tr>
    <?endforeach;?>
    <?endif;
    $arrPropDopDefault = $arrPropDop;
    unset($arrPropDopDefault['REFERENCE'][0]);
    unset($arrPropDopDefault['REFERENCE_ID'][0]);
    
    ?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDefault', $arrPropDopDefault, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadPropDefault" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr class="heading" id="header_selector_prop">
        <td colspan="2"><?echo GetMessage("parser_selector_props_xml")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_props_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["selector_prop"]) && !empty($shs_SETTINGS["catalog"]["selector_prop"])):?>
    <?foreach($shs_SETTINGS["catalog"]["selector_prop"] as $code=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%">
            <input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[catalog][selector_prop][<?=$code?>]" value="<?=$shs_SETTINGS["catalog"]["selector_prop"][$code]?>">
        </td>
    </tr>
    <?endforeach?>
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDop', $arrPropDop, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadDopProp" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr style="display:none">
        <td colspan="2"><input type="hidden" id="delete_selector_prop" name="SETTINGS[catalog][delete_selector_prop]" value="<?=$shs_SETTINGS["catalog"]["delete_selector_prop"]?>" /></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_prop_detail_preview_descr_file_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading" id="header_find_prop">
        <td colspan="2"><?echo GetMessage("parser_find_props_xml")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_add_auto_props")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][add_auto_props]" value="Y"<?if($shs_SETTINGS["catalog"]["add_auto_props"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_add_auto_props_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_find_props_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_find_props]" value="<?echo isset($shs_SETTINGS["catalog"]["selector_find_props"])?$shs_SETTINGS["catalog"]["selector_find_props"]:'param';?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_find_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_attr_auto_props")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][attr_auto_props]" value="<?echo isset($shs_SETTINGS["catalog"]["attr_auto_props"])?$shs_SETTINGS["catalog"]["attr_auto_props"]:'[name]';?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_attr_auto_props_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_attr_value_auto_props")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_attr_value_auto_props]" value="<?echo isset($shs_SETTINGS["catalog"]["selector_attr_value_auto_props"])?$shs_SETTINGS["catalog"]["selector_attr_value_auto_props"]:'';?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_attr_value_auto_props_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
   <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("type_add_auto_props")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][type_auto_props]', $arTypeAddAutoProps, $shs_SETTINGS["catalog"]["type_auto_props"]?$shs_SETTINGS["catalog"]["type_auto_props"]:"S", "", "");?></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("type_add_auto_props_description")?>
            <?=EndNote();?>
        </td>
    </tr>

    <tr class="tr_find_prop">
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_find_props_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_find_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr class="tr_find_prop">
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr style="display:none">
        <td colspan="2"><input type="hidden" id="delete_find_prop" name="SETTINGS[catalog][delete_find_prop]" value="<?=$shs_SETTINGS["catalog"]["delete_find_prop"]?>" /></td>
    </tr>
    <tr class="heading" id="header_find_prop">
        <td colspan="2"><?echo GetMessage("parser_add_delete_symb_props")?></td>
    </tr>
    <?if(isset($shs_SETTINGS["catalog"]["action_props_val"]) && !empty($shs_SETTINGS["catalog"]["action_props_val"])):?>
    <?foreach($shs_SETTINGS["catalog"]["action_props_val"] as $code=>$arVal):
        foreach($arVal as $i=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=($code=="SOTBIT_PARSER_NAME_E")?GetMessage("parser_SOTBIT_PARSER_NAME_E"):$arrPropDop['REFERENCE_CODE_NAME'][$code]?>&nbsp;<?if($code=="SOTBIT_PARSER_NAME_E"):?><?else:?>[<?=$code?>]<?endif;?>:</td>
        <td width="60%"><input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[catalog][action_props_val][<?=$code?>][]" value="<?=$val?>">&nbsp; <?=SelectBoxFromArray('SETTINGS[catalog][action_props]['.$code.']['.$i.']', $arrActionProps, $shs_SETTINGS["catalog"]["action_props"][$code][$i], GetMessage("shs_parser_select_action_props"), "");?> <a class="find_delete" href="#">Delete</a></td>
    </tr>
        <?endforeach;?>
    <?endforeach;?>
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropField', $arrPropField, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadPropField" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <tr class="tr_find_prop">
    <?
    ?>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("shs_parser_action_props_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    

<?
//********************
// 
//********************
if(!$hideCatalog):
$tabControl->BeginNextTab();
?>
    <?//if($isOfferCatalog):?>
    <tr>
        <td><?echo GetMessage("parser_cat_price_offer")?></td>
        <td><input class="bool-delete" type="checkbox" name="SETTINGS[catalog][cat_vat_price_offer]" value="Y"<?if($shs_SETTINGS["catalog"]["cat_vat_price_offer"] == "Y") echo " checked"?> /></td>
    </tr>
    <?//endif;?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_price_type")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][price_type]', $arPriceType, $shs_SETTINGS["catalog"]["price_type"]?$shs_SETTINGS["catalog"]["price_type"]:1, "", "");?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_cat_vat_id")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][cat_vat_id]', $arVATRef, $shs_SETTINGS["catalog"]["cat_vat_id"], "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_cat_vat_included")?></td>
        <td><input class="bool-delete" type="checkbox" name="SETTINGS[catalog][cat_vat_included]" value="Y"<?if($shs_SETTINGS["catalog"]["cat_vat_included"] == "Y") echo " checked"?> /></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_currency")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][currency]', $arCurrency, $shs_SETTINGS["catalog"]["currency"]?$shs_SETTINGS["catalog"]["currency"]:"RUB", "", "");?></td>
    </tr>
    <?if(isset($arAllMeasure)):?>
    <tr>
        <td><?echo GetMessage("parser_measure")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][measure]', $arAllMeasure, $shs_SETTINGS["catalog"]["measure"]?$shs_SETTINGS["catalog"]["measure"]:5, "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_catalog_koef")?></td>
        <td><input type="text" name="SETTINGS[catalog][koef]" value="<?echo $shs_SETTINGS["catalog"]["koef"]?$shs_SETTINGS["catalog"]["koef"]:1;?>" size="40" maxlength="250"></td>
    </tr>
    
    <?endif;?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_work_price")?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_convert_currency")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][convert_currency]', $arConvertCurrency, $shs_SETTINGS["catalog"]["convert_currency"], "", "");?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_price_okrug")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_okrug]', $arPriceOkrug, $shs_SETTINGS["catalog"]["price_okrug"], "", "style=\"width:115px\"");?> <?echo GetMessage("parser_price_okrug_delta1")?> <input type="text" name="SETTINGS[catalog][price_okrug_delta]" value="<?echo $shs_SETTINGS["catalog"]["price_okrug_delta"]?>" size="1" maxlength="1"> <?echo GetMessage("parser_price_okrug_delta2")?> </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_price_okrug_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_price_format")?></td>
        <td><?echo GetMessage("parser_price_format1")?><input type="text" name="SETTINGS[catalog][price_format1]" value="<?echo $shs_SETTINGS["catalog"]["price_format1"]?>" size="1" maxlength="250"><?echo GetMessage("parser_price_format2")?><input type="text" name="SETTINGS[catalog][price_format2]" value="<?echo $shs_SETTINGS["catalog"]["price_format2"]?>" size="1" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_price_format_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    $count = count($shs_SETTINGS["catalog"]["price_updown"])-1;
    if(is_set($shs_SETTINGS["catalog"]["price_updown"]) && is_array($shs_SETTINGS["catalog"]["price_updown"]) && count($shs_SETTINGS["catalog"]["price_updown"])>0){
    foreach($shs_SETTINGS["catalog"]["price_updown"] as $i=>$val):
    if($count==$i) $class="tr_add";
    else $class = "";
    ?>
    <tr class="heading <?=$class?>" data-num="<?=($i+1)?>">
        <td colspan="2"><?echo GetMessage("parser_work_price_num")?> <span><?=($i+1)?></span> <?if($count==$i):?><a href="#" style="font-size:12px;" class="add_usl"><?echo GetMessage("parser_price_num_add")?></a><?endif;?>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" style="font-size:12px;<?if($i==0):?>display:none<?endif;?>" class="del_usl"><?echo GetMessage("parser_price_num_del")?></a></td>
    </tr>
    <tr class="<?=$class?>">
        <td><?echo GetMessage("parser_price_updown")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_updown][]', $arPriceUpDown, $shs_SETTINGS["catalog"]["price_updown"][$i], "", "");?></td>
    </tr>
    <tr class="<?=$class?>">
        <td><?echo GetMessage("parser_price_terms")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_terms][]', $arPriceTerms, $shs_SETTINGS["catalog"]["price_terms"][$i], "", "");?> <?echo GetMessage("parser_price_from")?> <input type="text" name="SETTINGS[catalog][price_terms_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value"][$i];?>" size="10" maxlength="250"> <?echo GetMessage("parser_price_to")?> <input type="text" name="SETTINGS[catalog][price_terms_value_to][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value_to"][$i];?>" size="10" maxlength="250"></td>
    </tr>
    <tr class="<?=$class?>">
        <td><?echo GetMessage("parser_price_type_value")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_type_value][]', $arPriceValue, $shs_SETTINGS["catalog"]["price_type_value"][$i], "", "");?></td>
    </tr>
    <tr class="<?=$class?> <?if($class):?>tr_last<?endif;?>">
        <td><?echo GetMessage("parser_price_value")?></td>
        <td><input type="text" name="SETTINGS[catalog][price_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_value"][$i];?>" size="10" maxlength="250"></td>
    </tr>
    <?endforeach;
    }else{
    ?>
    <tr class="heading tr_add" data-num="1">
        <td colspan="2"><?echo GetMessage("parser_work_price_num")?> <span></span> <a href="#" style="font-size:12px;" class="add_usl"><?echo GetMessage("parser_price_num_add")?></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" style="font-size:12px;display:none" class="del_usl"><?echo GetMessage("parser_price_num_del")?></a></td>
    </tr>
    <tr class="tr_add">
        <td><?echo GetMessage("parser_price_updown")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_updown][]', $arPriceUpDown, $shs_SETTINGS["catalog"]["price_updown"], "", "");?></td>
    </tr>
    <tr class="tr_add">
        <td><?echo GetMessage("parser_price_terms")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_terms][]', $arPriceTerms, $shs_SETTINGS["catalog"]["price_terms"], "", "");?> <?echo GetMessage("parser_price_from")?> <input type="text" name="SETTINGS[catalog][price_terms_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value"];?>" size="10" maxlength="250"> <?echo GetMessage("parser_price_to")?> <input type="text" name="SETTINGS[catalog][price_terms_value_to][]" value="<?echo $shs_SETTINGS["catalog"]["price_terms_value_to"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr class="tr_add">
        <td><?echo GetMessage("parser_price_type_value")?></td>
        <td><?=SelectBoxFromArray('SETTINGS[catalog][price_type_value][]', $arPriceValue, $shs_SETTINGS["catalog"]["price_type_value"], "", "");?></td>
    </tr>
    <tr class="tr_add tr_last">
        <td><?echo GetMessage("parser_price_value")?></td>
        <td><input type="text" name="SETTINGS[catalog][price_value][]" value="<?echo $shs_SETTINGS["catalog"]["price_value"];?>" size="10" maxlength="250"></td>
    </tr>
    
    <?}?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_size_selector")?></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_length")?></td>
        <td><input type="text" name="SETTINGS[catalog][selector_product][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["LENGTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["LENGTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_width")?></td>
        <td><input type="text" name="SETTINGS[catalog][selector_product][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["WIDTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["WIDTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_height")?></td>
        <td><input type="text" name="SETTINGS[catalog][selector_product][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["HEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["HEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_size_weight")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_product][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product"]["WEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][selector_product_koef][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["selector_product_koef"]["WEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_selector_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_selector_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_selector_size_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_size_find")?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_selector_find")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][selector_find_size]" value="<?echo $shs_SETTINGS["catalog"]["selector_find_size"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_length")?></td>
        <td><input type="text" name="SETTINGS[catalog][find_product][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["LENGTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][LENGTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["LENGTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_width")?></td>
        <td><input type="text" name="SETTINGS[catalog][find_product][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["WIDTH"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][WIDTH]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["WIDTH"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td><?echo GetMessage("parser_size_height")?></td>
        <td><input type="text" name="SETTINGS[catalog][find_product][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["HEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][HEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["HEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_size_weight")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][find_product][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product"]["WEIGHT"];?>" size="40" maxlength="250"> X <input type="text" name="SETTINGS[catalog][find_product_koef][WEIGHT]" value="<?echo $shs_SETTINGS["catalog"]["find_product_koef"]["WEIGHT"];?>" size="10" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[catalog][catalog_delete_find_symb]" value="<?echo $shs_SETTINGS["catalog"]["catalog_delete_find_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_find_size_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
<?
endif;
?>
<?   
//********************
// 
//********************
if(!$hideCatalog):
$tabControl->BeginNextTab();
?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_load")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[offer][load]', $arOfferLoad, $shs_SETTINGS["offer"]["load"]?$shs_SETTINGS["offer"]["load"]:1, "", "");?></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_load_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["offer"]["load"]) && $shs_SETTINGS["offer"]["load"]=="one"):?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_one_selector")?>:</td>
        <td width="60%"><input type="text" name="SETTINGS[offer][one][selector]" value="<?echo $shs_SETTINGS["offer"]['one']["selector"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_one_selector_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_one_price_attr")?>:</td>
        <td width="60%"><input type="text" name="SETTINGS[offer][one][price]" value="<?echo $shs_SETTINGS["offer"]['one']["price"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_one_price_attr_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_one_separator")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][one][separator]" value="<?echo $shs_SETTINGS["offer"]['one']["separator"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_one_separator_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_add_name")?></td>
        <td width="60%">
        <?if(isset($arrPropDopOfferName)):?>
            <select name="SETTINGS[offer][add_name][]" class="add_name">
                <?foreach($arrPropDopOfferName["REFERENCE"] as $r=>$ref):?>
                <option <?if(is_array($shs_SETTINGS["offer"]["add_name"]) && in_array($arrPropDopOfferName["REFERENCE_ID"][$r], $shs_SETTINGS["offer"]["add_name"])):?>selected=""<?endif;?> value="<?=$arrPropDopOfferName["REFERENCE_ID"][$r]?>"><?=$ref?></option>
                <?endforeach?>
            </select>
        <?endif;?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_add_name_one_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][catalog_delete_selector_props_symb]" value="<?echo $shs_SETTINGS["offer"]["catalog_delete_selector_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_descr_xml_offer")?>
            <?=EndNote();?>
        </td>
    </tr> 
    <?endif;?>
    <?if(isset($shs_SETTINGS["offer"]["load"]) && $shs_SETTINGS["offer"]["load"]=="table"):?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_add_name")?></td>
        <td width="60%">
        <?if(isset($arrPropDopOfferName)):?>
            <select name="SETTINGS[offer][add_name][]" multiple="" class="add_name">
                <?foreach($arrPropDopOfferName["REFERENCE"] as $r=>$ref):?>
                <option <?if(is_array($shs_SETTINGS["offer"]["add_name"]) && in_array($arrPropDopOfferName["REFERENCE_ID"][$r], $shs_SETTINGS["offer"]["add_name"])):?>selected=""<?endif;?> value="<?=$arrPropDopOfferName["REFERENCE_ID"][$r]?>"><?=$ref?></option>
                <?endforeach?>
            </select>
        <?endif;?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_add_name_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_offer_container_desc")?></td>
    </tr><?/*?>
    <tr class="heading">
        <td colspan="2">
        <?/*=BeginNote();?>
        <table>
            <thead>
                <tr>
                    <th>
                        <?echo GetMessage("parser_offer_table_desc_1")?>
                    </th>
                    <th><?echo GetMessage("parser_offer_table_desc_2")?></th>
                    <th><?echo GetMessage("parser_offer_table_desc_3")?></th>
                    <th><?echo GetMessage("parser_offer_table_desc_4")?></th>
                    <th><?echo GetMessage("parser_offer_table_desc_5")?></th>
                    <th><?echo GetMessage("parser_offer_table_desc_6")?></th>
                    <th><?echo GetMessage("parser_offer_table_desc_7")?></th>
                    <th></th>
                    <th>
                            <?echo GetMessage("parser_offer_table_desc_8")?>
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr class="item_row">
                    <td>976886</td>
                    <td><?echo GetMessage("parser_offer_table_desc_9")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_12")?></td>
                    <td>416</td>
                    <td>8(RUS-GB-F-E-ARAB-D-H-PL)</td>
                    <td><?echo GetMessage("parser_offer_table_desc_10")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_11")?></td>
                    <td></td>
                    <td>100</td>
                </tr>
                <tr class="item_row">
                    <td>976886</td>
                    <td><?echo GetMessage("parser_offer_table_desc_9")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_12")?></td>
                    <td>416</td>
                    <td>8(RUS-GB-F-E-ARAB-D-H-PL)</td>
                    <td><?echo GetMessage("parser_offer_table_desc_10")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_11")?></td>
                    <td></td>
                    <td>100</td>
                </tr>
                <tr class="item_row">
                    <td>976886</td>
                    <td><?echo GetMessage("parser_offer_table_desc_9")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_12")?></td>
                    <td>416</td>
                    <td>8(RUS-GB-F-E-ARAB-D-H-PL)</td>
                    <td><?echo GetMessage("parser_offer_table_desc_10")?></td>
                    <td><?echo GetMessage("parser_offer_table_desc_11")?></td>
                    <td></td>
                    <td>100</td>
                </tr>
                </tbody>
            </table>
            <?=EndNote();*/?>
        <?/*?></td>
    </tr><?*/?>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_selector_item")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][selector_item]" value="<?echo $shs_SETTINGS["offer"]["selector_item"];?>" size="40" maxlength="250"></td>
    </tr>
    
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_selector_item_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_catalog_delete_symb")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][catalog_delete_selector_props_symb]" value="<?echo $shs_SETTINGS["offer"]["catalog_delete_selector_props_symb"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_delete_symb_descr_xml_offer")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_parsing_selector_xml_name")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][selector_name]" value="<?echo $shs_SETTINGS["offer"]["selector_name"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_parsing_selector_name_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td class="field-name" width="40%"><?echo GetMessage("parser_offer_parsing_selector_price_xml")?></td>
        <td width="60%"><input type="text" name="SETTINGS[offer][selector_price]" value="<?echo $shs_SETTINGS["offer"]["selector_price"];?>" size="40" maxlength="250"></td>
    </tr>
    <tr>
        <td class="field-name" width="40%"></td>
        <td width="60%">
            <?=BeginNote();?>
            <?echo GetMessage("parser_offer_parsing_selector_price_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["offer"]["selector_prop"]) && !empty($shs_SETTINGS["offer"]["selector_prop"])):?>
    <?foreach($shs_SETTINGS["offer"]["selector_prop"] as $code=>$val):
        $val = trim($val);
        if(!$val) continue 1;
    ?>
    <tr>
        <td width="40%"><?=$arrPropDopOffer['REFERENCE_CODE_NAME'][$code]?>&nbsp;[<?=$code?>]:</td>
        <td width="60%">
            <input type="text" size="40" data-code="<?=$code?>" name="SETTINGS[offer][selector_prop][<?=$code?>]" value="<?=$shs_SETTINGS["offer"]["selector_prop"][$code]?>">
            <a class="prop_delete" href="#">Delete</a>
        </td>
    </tr>
    <?endforeach?>
    <?endif;?>
    <tr>
        <td colspan="2" align="center">
            <?=SelectBoxFromArray('arrPropDopOffer', $arrPropDopOffer, "", GetMessage("shs_parser_select_prop"), "");?>
            <input type="submit" id="loadDopPropOffer" name="refresh" value="<?=GetMessage("shs_parser_select_prop_but")?>">
        </td>
    </tr>
    <?endif;?>
    
<?
endif;
?>   
<?
//********************
// 
//********************
$tabControl->BeginNextTab();
?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_active_element")?></td>
        <td width="60%"><input type="checkbox" name="ACTIVE_ELEMENT" value="Y"<?if($shs_ACTIVE_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_code_element")?></td>
        <td width="60%"><input type="checkbox" name="CODE_ELEMENT" value="Y"<?if($shs_CODE_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_index_element")?></td>
        <td width="60%"><input type="checkbox" name="INDEX_ELEMENT" value="Y"<?if($shs_INDEX_ELEMENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_resize_image")?></td>
        <td width="60%"><input type="checkbox" name="RESIZE_IMAGE" value="Y"<?if($shs_RESIZE_IMAGE == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_from_detail")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][img_preview_from_detail]" value="Y"<?if($shs_SETTINGS["catalog"]["img_preview_from_detail"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_preview_from_detail_text")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][text_preview_from_detail]" value="Y"<?if($shs_SETTINGS["catalog"]["text_preview_from_detail"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_date_active")?></td>
        <td width="60%"><input type="checkbox" name="DATE_ACTIVE" value="Y"<?if($shs_DATE_ACTIVE && $shs_DATE_ACTIVE != "N") echo " checked"?>> <?=SelectBoxFromArray('DATE_PROP_ACTIVE', $arrDateActive, $shs_DATE_ACTIVE, GetMessage("parser_date_type"), "id='prop-active' style='width:262px'");?></td>
    </tr>
    <?/*?><tr>
        <td width="40%"><?echo GetMessage("parser_date_public")?></td>
        <td width="60%"><input type="checkbox" name="DATE_PUBLIC" value="Y"<?if($shs_DATE_PUBLIC && $shs_DATE_PUBLIC != "N") echo " checked"?>> <?=SelectBoxFromArray('DATE_PROP_PUBLIC', $arrProp, $shs_DATE_PUBLIC, GetMessage("parser_prop_id"), "id='prop-date' style='width:262px' class='prop-iblock'");?></td>
    </tr><?*/?>

    <tr>
        <td width="40%"><?echo GetMessage("parser_start_agent")?></td>
        <td width="60%"><input type="checkbox" name="START_AGENT" value="Y"<?if($shs_START_AGENT == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_start_agent_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_time_agent")?></td>
        <td width="60%"><input type="text" size="40" name="TIME_AGENT" value="<?=$shs_TIME_AGENT?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_sleep")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][sleep]" value="<?=$shs_SETTINGS["catalog"]["sleep"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_sleep_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_proxy")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][proxy]" value="<?=$shs_SETTINGS["catalog"]["proxy"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_proxy_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
//********************
///
//********************
    $tabControl->BeginNextTab();
    ?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_uniq_update")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][active]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["active"] == "Y") echo " checked"?>></td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_header_uniq")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_uniq_name")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][uniq][name]" value="Y"<?if($shs_SETTINGS["catalog"]["uniq"]["name"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_uniq_prop")?></td>
        <td width="60%"><?=SelectBoxFromArray('SETTINGS[catalog][uniq][prop]', $arrProp, $shs_SETTINGS["catalog"]["uniq"]["prop"], GetMessage("parser_prop_id"), "id='style='width:262px' class='prop-iblock'");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_uniq_descr_xml")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_header_uniq_field")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_name")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][name]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["name"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_price")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][price]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["price"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_param")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][param]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["param"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_preview_descr")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][preview_descr]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["preview_descr"], "", "");?>
            <?/*?><input type="checkbox" name="SETTINGS[catalog][update][preview_descr]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["preview_descr"] == "Y") echo " checked"?>><?*/?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_detail_descr")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][detail_descr]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["detail_descr"], "", "");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_preview_img")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][preview_img]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["preview_img"], "", "");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_detail_img")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][update][detail_img]', $arUpdate, $shs_SETTINGS["catalog"]["update"]["detail_img"], "", "");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_more_img")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][more_img]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["more_img"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_uniq_field_props")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][update][props]" value="Y"<?if($shs_SETTINGS["catalog"]["update"]["props"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_header_uniq_field_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_header_element_action")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_element_action")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][uniq][action]', $arAction, $shs_SETTINGS["catalog"]["uniq"]["action"], "", "");?>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_element_action_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    //********************
    //
    //********************
    $tabControl->BeginNextTab();
    ?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_type")?></td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[catalog][auth][type]', $arAuthType, $shs_SETTINGS["catalog"]["auth"]["type"], "", "class='select_load'");?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_active")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][auth][active]" value="Y"<?if($shs_SETTINGS["catalog"]["auth"]["active"] == "Y") echo " checked"?>></td>
    </tr>
    <?if((isset($shs_SETTINGS["catalog"]["auth"]["type"]) && $shs_SETTINGS["catalog"]["auth"]["type"]=="form") || !isset($shs_SETTINGS["catalog"]["auth"]["type"])):?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_url")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][url]" value="<?=$shs_SETTINGS["catalog"]["auth"]["url"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_auth_url_xml_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_selector")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][selector]" value="<?=$shs_SETTINGS["catalog"]["auth"]["selector"]?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_login")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][login]" value="<?=$shs_SETTINGS["catalog"]["auth"]["login"]?>"> <?echo GetMessage("parser_auth_login_name")?> <input type="text" size="20" name="SETTINGS[catalog][auth][login_name]" value="<?=$shs_SETTINGS["catalog"]["auth"]["login_name"]?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_password")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][password]" value="<?=$shs_SETTINGS["catalog"]["auth"]["password"]?>"> <?echo GetMessage("parser_auth_password_name")?> <input type="text" size="20" name="SETTINGS[catalog][auth][password_name]" value="<?=$shs_SETTINGS["catalog"]["auth"]["password_name"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_auth_password_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?else:?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_login")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][login]" value="<?=$shs_SETTINGS["catalog"]["auth"]["login"]?>"></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_auth_password")?></td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[catalog][auth][password]" value="<?=$shs_SETTINGS["catalog"]["auth"]["password"]?>"></td>
    </tr>
    <?endif;?>
    <?if($shs_SETTINGS["catalog"]["auth"]["type"]=="form"):?>
    <tr>
        <td width="40%"></td>
        <td width="60%"><input type="button" size="40" id="auth" name="auth" data-href="<?=$APPLICATION->GetCurPageParam("auth=1", array("auth")); ?>" value="<?echo GetMessage('parser_auth_check')?>"></td>
    </tr>
    <?endif;?>
    <?
    //********************
    //
    //********************
    $tabControl->BeginNextTab();
    ?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_logs")?></td>
        <td width="60%"><input type="checkbox" name="SETTINGS[catalog][log]" value="Y"<?if($shs_SETTINGS["catalog"]["log"] == "Y") echo " checked"?>></td>
    </tr>
    <?
    $file_log = $_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$_GET["ID"].".txt";
    if(isset($_GET["ID"]) && file_exists($file_log)):?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_header_logs_download")?></td>
        <td width="60%"><a href="<?=$APPLICATION->GetCurPageParam("log_ID=".$_GET["ID"], array("log_ID"));?>">catalog_log_<?=$_GET["ID"]?>.txt  (<?=ceil(filesize($file_log)/1024)?> KB)</a></td>
    </tr>
    <?endif?>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_header_log_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?
    //********************
    //
    //********************
    $tabControl->BeginNextTab();
    ?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_type_head")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_type")?>:</td>
        <td width="60%">
            <?=SelectBoxFromArray('SETTINGS[loc][type]', $arLocType, $shs_SETTINGS["loc"]["type"], "", "class='select_load'");?>
        </td>
    </tr>
    <?if(isset($shs_SETTINGS["loc"]["type"]) && $shs_SETTINGS["loc"]["type"]=="yandex"):?>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_yandex_key")?>:</td>
        <td width="60%"><input type="text" size="40" name="SETTINGS[loc][yandex][key]" value="<?=$shs_SETTINGS["loc"]["yandex"]["key"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_yandex_key_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_yandex_lang")?>:</td>
        <td width="60%"><input type="text" size="20" name="SETTINGS[loc][yandex][lang]" value="<?=$shs_SETTINGS["loc"]["yandex"]["lang"]?>"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_yandex_lang_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_fields")?></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_name")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_name]" value="Y"<?if($shs_SETTINGS["loc"]["f_name"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_preview_text")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_preview_text]" value="Y"<?if($shs_SETTINGS["loc"]["f_preview_text"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_detail_text")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_detail_text]" value="Y"<?if($shs_SETTINGS["loc"]["f_detail_text"] == "Y") echo " checked"?>></td>
    </tr>
    <tr>
        <td width="40%"><?echo GetMessage("parser_loc_fields_props")?>:</td>
        <td width="60%"><input type="checkbox" name="SETTINGS[loc][f_props]" value="Y"<?if($shs_SETTINGS["loc"]["f_props"] == "Y") echo " checked"?>></td>
    </tr>
    <?endif;?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_loc_uniq")?></td>
    </tr>
    <?
    $engine = new Engine\Yandex();
    $arSettings = $engine->getSettings();
    $arDomains = \CSeoUtils::getDomainsList();
    
    foreach($arDomains as $key => $domain)
    {
        if(!isset($arSettings['SITES'][$domain['DOMAIN']]))
        {
            unset($arDomains[$key]);
        }
    }

    if(count($arDomains) <= 0)
    {
        $msg = new CAdminMessage(array(
            'MESSAGE' => Loc::getMessage('SHS_PARSER_SEO_YANDEX_ERROR'),
            'HTML' => 'Y'
        ));
    }else{
        $arrDomain['REFERENCE'][] =  Loc::getMessage('shs_parser_loc_uniq_no');
        $arrDomain['REFERENCE_ID'][] = "";
        foreach($arDomains as $domain)
        {   //printr($domain);
            $domainEnc = Converter::getHtmlConverter()->encode($domain['DOMAIN']);
            $arrDomain['REFERENCE'][] =  $domainEnc;
            $arrDomain['REFERENCE_ID'][] = $domainEnc;
        }
    }
    ?>
    <?if(count($arDomains) <= 0):?>
    <tr>
        <td colspan="2" align="center"><?echo $msg->Show();?></td>
    </tr>
    <?else:?>
    <tr>
        <td><?echo GetMessage("parser_loc_uniq_domain")?>:</td>
        <td><?=SelectBoxFromArray('SETTINGS[loc][uniq][domain]', $arrDomain, $shs_SETTINGS["loc"]["uniq"]["domain"], "", "");?></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <?=BeginNote();?>
            <?echo GetMessage("parser_loc_uniq_domain_descr")?>
            <?=EndNote();?>
        </td>
    </tr>
    <?endif?>
    <?
    //********************
    // 
    //********************
    $tabControl->BeginNextTab();
    ?>
    <tr class="heading">
        <td colspan="2"><?echo GetMessage("parser_video_xml_descr")?></td>
    </tr>
    <tr>
        <td align="center" colspan="2" width="100%"><iframe width="800" height="500" src="https://www.youtube.com/embed/oP8tT_n55BI" frameborder="0" allowfullscreen></iframe></td>
    </tr>
    <tr>
        <td align="center" colspan="2" width="100%"><iframe width="800" height="500" src="https://www.youtube.com/embed/HrnkiR-msnQ" frameborder="0" allowfullscreen></iframe></td>
    </tr>
<?
if(isset($_GET["log_ID"]) && isset($_GET["ID"])):
    if (ob_get_level()) {
      ob_end_clean();
    }
    $file = $file_log;
    header('Content-Description: File Transfer');
    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename=' . basename($file));
    header('Content-Transfer-Encoding: binary');
    header('Expires: 0');
    header('Cache-Control: must-revalidate');
    header('Pragma: public');
    header('Content-Length: ' . filesize($file));
    readfile($file);
    exit();
endif;
$tabControl->Buttons(
    array(
        "disabled"=>($POST_RIGHT<"W"),
        "back_url"=>"list_parser_admin.php?lang=".LANG,

    )
);
?>
<?echo bitrix_sessid_post();?>
<input type="hidden" name="lang" value="<?=LANG?>">
<?if($ID>0 && !$bCopy):?>
    <input type="hidden" name="ID" value="<?=$ID?>">
<?endif;?>
<input type="hidden" name="parent" value="<?=$parentID?>">
<?
$tabControl->End();
?>

<?
$tabControl->ShowWarnings("post_form", $message);
?>60   219682|/shs.parser/classes/general/main_classes.php|3b96c2e7<?
use Bitrix\Highloadblock as HL; 
use Bitrix\Main\Entity;
use Bitrix\Seo\Engine;
use Bitrix\Main\Text\Converter;
use Bitrix\Main\Localization\Loc;
use Bitrix\Main\IO\Path;

\Bitrix\Main\Loader::includeModule('seo');
\Bitrix\Main\Loader::includeModule('socialservices');

class SotbitContentParser extends SotbitXmlParser{
    
    /*public $id = false;
    public $rss;
    public $typeN;
    public $active;
    public $iblock_id;
    public $section_id;
    public $detail_dom;
    public $encoding;
    public $preview_delete_tag="";
    public $bool_preview_delete_tag="";
    public $detail_delete_tag="";
    public $bool_detail_delete_tag="";
    public $preview_first_img="";
    public $detail_first_img="";
    public $preview_save_img="";
    public $detail_save_img="";
    public $text = "";
    public $site = "";
    public $link = "";
    public $preview_delete_element="";
    public $detail_delete_element="";
    public $preview_delete_attribute="";
    public $detail_delete_attribute="";
    public $index_element="";
    public $resize_image="";
    public $meta_description="";
    public $meta_keywords="";
    public $meta_description_text="";
    public $meta_keywords_text="";
    public $agent = false;
    public $active_element = "Y";
    public $header_url;
    public $settings;
    public $countPage = 0;
    public $countItem = 0;
    public $stepStart = false;

    public $page;*/
    const TEST = 0;
    const DEFAULT_DEBUG_LIST = 3;
    const DEFAULT_DEBUG_ITEM = 3;
    public function __construct()
    {
       parent::__construct(); 
    }
    
    public function startParser($agent=false){
        global $DB, $shs_DEMO; //$agent = true;
        if($shs_DEMO==3) return;
        $this->createFolder();
        $this->createAlbum();
        if($this->active!="Y"){
          $result["ERROR"][] = GetMessage("parser_active_no");
          $this->errors[] = GetMessage("parser_active_no");
          if(!$agent)CAdminMessage::ShowMessage(GetMessage("parser_active_no"));
          return $result;
        }
        $parser = new ShsParserContent();
        $now = time()+CTimeZone::GetOffset();
        $arFieldsTime['START_LAST_TIME_X'] = date($DB->DateFormatToPHP(FORMAT_DATETIME), $now);
        $parser->Update($this->id, $arFieldsTime);
        $this->convetCyrillic($this->rss);
        if($this->meta_description!="N"){
            $propDescr = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->meta_description))->Fetch();
            if(!$propDescr){
                $result["ERROR"][] = GetMessage("parser_error_description");
                $this->errors[] = GetMessage("parser_error_description");
            }
        }
        if($this->meta_keywords!="N"){
            $propKey = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->meta_keywords))->Fetch();
            if(!$propKey){
                $result["ERROR"][] = GetMessage("parser_error_keywords");
                $this->errors[] = GetMessage("parser_error_keywords");
                //return $result;
            }
        }
        if($this->meta_title!="N"){
            $propKey = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->meta_title))->Fetch();
            if(!$propKey){
                $result["ERROR"][] = GetMessage("parser_error_title");
                $this->errors[] = GetMessage("parser_error_title");
                //return $result;
            }
        }
        if($this->first_title!="N"){
            $propFirst= CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->first_title))->Fetch();
            if(!$propFirst){
                $result["ERROR"][] = GetMessage("parser_error_first");
                $this->errors[] = GetMessage("parser_error_first");
                //return $result;
            }
        }
        if($this->date_public!="N"){
            $propDate= CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "CODE"=>$this->date_public))->Fetch();
            if(!$propDate){
                $result["ERROR"][] = GetMessage("parser_error_date");
                $this->errors[] = GetMessage("parser_error_date");
                //return $result;
            }
        }


        if(isset($result['ERROR']))
        {
            if(!$agent)foreach($result['ERROR'] as $error) CAdminMessage::ShowMessage($error);
            return false;
        }
        $this->agent = $agent;
        if($shs_DEMO==2) $this->settings["catalog"]["mode"] = "debug";


        if($_GET["begin"]){
            $this->auth(true);
            foreach(GetModuleEvents("shs.parser", "startPars", true) as $arEvent)
                ExecuteModuleEventEx($arEvent, array($this->id, &$this));
        }
        elseif($this->agent || $this->settings["catalog"]["mode"]=="debug"){
            $this->auth(true);
            foreach(GetModuleEvents("shs.parser", "startPars", true) as $arEvent)
                ExecuteModuleEventEx($arEvent, array($this->id, &$this));
        }
        
        if($this->typeN=="catalog")
        {
            $this->isCatalog();
            $this->getUniqElement();
            $this->isUpdateElement();
            $this->GetSortFields();
            $this->getArrayIblock();
            $this->DoPageNavigation();
            $this->CheckFields($this->settings["catalog"]);
            
            if(!$this->errors)$this->parseCatalog();
            else{    
                if(!$agent)foreach($this->errors as $error) CAdminMessage::ShowMessage($error);
                $this->SaveLog();
                return false;
            } 
            if($this->debugErrors && $this->settings["catalog"]["mode"]=="debug")
            {
                if(!$agent)foreach($this->debugErrors as $error) CAdminMessage::ShowMessage($error);
                $this->SaveLog();
                return false;
            }
            return true;
        }
        if ($this->typeN=="xml")
        {
            $this->isCatalog(); // 
            $this->getUniqElement(); // 
            $this->isUpdateElement(); //  
            $this->GetSortFields(); //       
            $this->getArrayIblock(); //  
            $this->CheckFields($this->settings["catalog"]); //     
            
            if(!$this->errors)parent::parseXmlCatalog();
            else{    
                if(!$agent)foreach($this->errors as $error) CAdminMessage::ShowMessage($error);
                $this->SaveLog();
                return false;
            } 
            if($this->debugErrors && $this->settings["catalog"]["mode"]=="debug")
            {
                if(!$agent)foreach($this->debugErrors as $error) CAdminMessage::ShowMessage($error);
                $this->SaveLog();
                return false;
            }
            return true;
        }

        $this->rss = str_replace(array('http://', 'www.', 'https://'), '', $this->rss);
        $arSite = explode('/', $this->rss);
        $level = explode('.', $arSite[0]);
        if(count($level)>=3) $this->rss = $this->rss;
        else $this->rss = 'www.'.$this->rss;
        $arSite = explode('/', $this->rss);
        $this->site = $arSite[0];
        $uri = preg_replace('/^(www\.){0,1}([a-zA-Z0-9-\.])+\//', '', $this->rss);
        $arPath = explode('?', $uri);
        $path = '/'.$arPath[0];
        $query = $arPath[1];   
        $arContent = $this->getContentsArray($this->site, 80, $path, $query);
        if(empty($arContent['title']) && empty($arContent['link'])){
            $arContent = $this->getContentsArray(str_replace("www.", "", $this->site), 80, $path, $query);
            if(empty($arContent['title']) && empty($arContent['link'])){
                $arContent = $this->getContentsArray("www.".$this->site, 80, $path, $query);
                if(empty($arContent['title']) && empty($arContent['link'])){
                    if(!$agent){
                        $result["ERROR"][] = GetMessage("parser_error");
                        $this->errors[] = GetMessage("parser_error");
                        //CAdminMessage::ShowMessage(GetMessage("parser_error"));
                        //return $result;
                    }
                    //return false;
                }
            }
        }
        if($this->errors)
        {
            if(!$agent)foreach($this->errors as $error) CAdminMessage::ShowMessage($error);
            if($this->typeN!="page")return false;
        }
        if(isset($result['ERROR']))
        {
            //if(!$agent)foreach($result['ERROR'] as $error) CAdminMessage::ShowMessage($error);
            if($this->typeN!="page")return false;
        }


        return $this->setContentIblock($arContent, $this->iblock_id, $this->section_id, $this->detail_dom, $this->encoding);
    }
    
    protected function convetCyrillic(&$url)
    {
        if(preg_match("/^\/{2}www/", $url))
        {
            $url = preg_replace("/^\/{2}www/", "www", $url);
        }
        
        $converter = new sotbit_idna_convert();
        $url = $converter->encode($url); 
    }
    
    private function setContentIblock($arContent=array(), $iblock_id=false, $section_id=false, $detail_dom="", $encoding="utf-8"){
        $first = false;
        global $shs_preview, $shs_first, $DB, $shs_DEMO;
        set_time_limit(0);
        $this->setDemo();
        /*if($this->first_url)
        {
            if($this->first_url && strpos($this->header_url, $this->first_url)===false && strpos($item['link'], $this->first_url)==false) continue;
        }
        else */ 
        $count = count($arContent['item']);
        $ci = 0;  
        //printr($arContent);
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $count."|".$ci);
        foreach($arContent['item'] as $i=>$item){
            $item['title'] = trim($item['title']);
            //if($this->sleep && $this->sleep>0)sleep($this->sleep);
            $this->link = $item['link'];
            $item['link'] = str_replace('http://', '', $item['link']);
            $this->convetCyrillic($item['link']);
            if(!isset($this->settings[$this->typeN]["uniq"]) || $this->settings[$this->typeN]["uniq"]=="name")
            {
                if($item['title'] && isset($this->settings['loc']["f_name"]) && $this->settings['loc']["f_name"]=="Y")
                {
                    $item['title'] = $this->locText($item['title']);        
                }
                $isElement = CIBlockElement::GetList(Array(), array("NAME"=>$item['title'], "SECTION_ID"=>$section_id, "IBLOCK_ID"=>$iblock_id), false, Array("nTopCount"=>1), array("ID"))->Fetch();
            }
            else{
                $md5 = md5($item['link']);
                $isElement = CIBlockElement::GetList(Array(), array("XML_ID"=>$md5, "SECTION_ID"=>$section_id, "IBLOCK_ID"=>$iblock_id), false, Array("nTopCount"=>1), array("ID"))->Fetch();
            }
            
            
            $ci++;
            if($isElement && !self::TEST && $shs_DEMO==1) continue;
            $first = true;
            $item['description'] = trim($item['description']);
            
            
            $fileHtml = new FileGetHtml();
            $this->date_public_text = $item["pubDate"];
            $proxy = $this->proxy;
            
            $data = $fileHtml->file_get_html($item['link'], $proxy, $this->auth, $this); 
            $this->header_url = $fileHtml->headerUrl;
            if($this->first_url && strpos($this->header_url, $this->first_url)===false && strpos($item['link'], $this->first_url)==false) continue;
            $shs_first = true;
            //preg_replace("/\<meta\s+charser=[\"|']{0,1}.+[\"|']{0,1}\s*\/{0,1}\>/ig")
            //print $data;
            $this->DeleteCharsetHtml5($data);
            $html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET);
            $shs_first = false;
            $this->first_title_text = $this->header_url;

            $this->getUrlSite();
            $DETAIL_TEXT = "";
            $this->text = "";

            $DETAIL_TEXT = $this->parserSelector($html, htmlspecialchars_decode(trim($detail_dom)));

            $el = new CIBlockElement;
            $shs_preview = true;
            if($this->preview_first_img=="Y") $PREVIEW_IMG = $this->parserFirstImg(phpQuery::newDocument($item['description']), "text/html;charset=".LANG_CHARSET);
            $shs_preview = false;
            if($this->detail_first_img=="Y") $DETAIL_IMG = $this->parserFirstImg(phpQuery::newDocument($DETAIL_TEXT), "text/html;charset=".LANG_CHARSET);
            
            $this->preview_delete_element = trim($this->preview_delete_element);
            $this->detail_delete_element = trim($this->detail_delete_element);
            $shs_preview = true;
            $preview_html = phpQuery::newDocument($item['description'], "text/html;charset=".LANG_CHARSET);
            $shs_preview = false;
            $detail_html = phpQuery::newDocument($DETAIL_TEXT, "text/html;charset=".LANG_CHARSET);
            if(!empty($this->preview_delete_element)){
                $preview_html = $this->deleteElementStart($preview_html, htmlspecialchars_decode($this->preview_delete_element));
            }
            if(!empty($this->detail_delete_element)){
                $detail_html = $this->deleteElementStart($detail_html, htmlspecialchars_decode($this->detail_delete_element));
            }
            if(!empty($this->preview_delete_attribute)){
                $preview_html = $this->deleteAttributeStart($preview_html, htmlspecialchars_decode($this->preview_delete_attribute));
            }
            if(!empty($this->detail_delete_attribute)){
                $detail_html = $this->deleteAttributeStart($detail_html, htmlspecialchars_decode($this->detail_delete_attribute));
            }
            
            
            
            
            $detail_html = $this->changeImgSrc($detail_html);
            $preview_html = $this->changeImgSrc($preview_html);

            if($this->preview_save_img=="Y") $item['description'] = $this->saveImgServer($preview_html);
            else $item['description'] = $preview_html->htmlOuter();
            if($this->detail_save_img=="Y") $DETAIL_TEXT = $this->saveImgServer($detail_html);
            else $DETAIL_TEXT = $detail_html->htmlOuter();
            $item['description'] = preg_replace("/\<meta(.)+\>{1}/", "", $item['description']);
            $DETAIL_TEXT = preg_replace("/\<meta(.)+\>{1}/", "", $DETAIL_TEXT);

            if($this->code_element=="Y")$code = $arProperty["CODE"] = CUtil::translit($item['title'], "ru", array(
                        "max_len" => 100,
                        "change_case" => 'L', // 'L' - toLower, 'U' - toUpper, false - do not change
                        "replace_space" => '_',
                        "replace_other" => '_',
                        "delete_repeat_replace" => true,
            ));
            if($this->date_public_text)$unix = strtotime($this->date_public_text);
            if($this->date_active=="NOW") $date_from = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "SHORT");
            elseif($this->date_active=="NOW_TIME") $date_from = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "FULL");
            elseif($this->date_active=="PUBLIC" && $unix) $date_from = ConvertTimeStamp($unix, "FULL");
            
            
            if(!empty($this->preview_delete_tag) && $this->bool_preview_delete_tag=="Y"){
                $item['description'] = strip_tags($item['description'], htmlspecialchars_decode($this->preview_delete_tag));
            }elseif($this->bool_preview_delete_tag=="Y") $item['description'] = strip_tags($item['description']);
            if(!empty($this->detail_delete_tag) && $this->bool_detail_delete_tag=="Y"){
                $DETAIL_TEXT = strip_tags($DETAIL_TEXT, htmlspecialchars_decode($this->detail_delete_tag));
            }elseif($this->bool_detail_delete_tag=="Y")
            {
                $DETAIL_TEXT = strip_tags($DETAIL_TEXT);
            }
            $item['description'] = trim($item['description']);
            $DETAIL_TEXT = trim($DETAIL_TEXT);
            
            if($item['title'] && isset($this->settings['loc']["f_name"]) && $this->settings['loc']["f_name"]=="Y" && $this->settings[$this->typeN]["uniq"]=="url")
            {
                $item['title'] = $this->locText($item['title']);        
            }
            if($item['description'] && isset($this->settings['loc']["f_preview_text"]) && $this->settings['loc']["f_preview_text"]=="Y")
            {
                $item['description'] = $this->locText($item['description'], $this->preview_text_type=="html"?"html":"plain");        
            }
            if($DETAIL_TEXT && isset($this->settings['loc']["f_detail_text"]) && $this->settings['loc']["f_detail_text"]=="Y")
            {   
                $DETAIL_TEXT = $this->locText($DETAIL_TEXT, $this->detail_text_type=="html"?"html":"plain", true);
            }

            $arLoadProductArray = Array(
                "MODIFIED_BY"    => 1, // ??????? ??????? ??????? ?????????????
                "IBLOCK_SECTION_ID" => $this->section_id,          // ??????? ????? ? ????? ???????
                "DATE_ACTIVE_FROM" => $date_from,
                "IBLOCK_ID"      => $this->iblock_id,
                "NAME"           => $item['title'],
                "ACTIVE"         => $this->active_element=="Y"?"Y":"N",            // ???????
                "PREVIEW_TEXT"   => $item['description'],
                "PREVIEW_TEXT_TYPE"  => $this->preview_text_type,
                "DETAIL_TEXT"    => $DETAIL_TEXT,
                "DETAIL_TEXT_TYPE"    => $this->detail_text_type,
                "CODE" => $code?$code:""
            );
            if(isset($md5))
            {
                $arLoadProductArray["XML_ID"] = $md5;
                unset($md5);    
            }
             

            if(empty($PREVIEW_IMG) && $this->preview_first_img=="Y") $PREVIEW_IMG = $this->filterSrc($this->parseImgFromRss($item));
            
            if($this->preview_first_img=="Y")
            {
                $this->convetCyrillic($PREVIEW_IMG);
                $arLoadProductArray['PREVIEW_PICTURE'] = CFile::MakeFileArray($PREVIEW_IMG);
            }
             
            if($this->detail_first_img=="Y")
            {
                $this->convetCyrillic($DETAIL_IMG);
                $arLoadProductArray['DETAIL_PICTURE'] = CFile::MakeFileArray($DETAIL_IMG);
            }
             
            if($this->date_public!="N" && $this->date_public_text)
            {
                $new_date = date($DB->DateFormatToPHP(FORMAT_DATETIME), $unix);
                $arLoadProductArray['PROPERTY_VALUES'][$this->date_public] = $new_date;
            }
            if($this->first_title!="N")$arLoadProductArray['PROPERTY_VALUES'][$this->first_title] = $this->first_title_text;
            if($this->meta_title!="N" && $this->meta_title_text)
            {
                if(isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"]=="Y")
                    $this->meta_title_text = $this->locText($this->meta_title_text);    
                $arLoadProductArray['PROPERTY_VALUES'][$this->meta_title] = $this->meta_title_text;    
            }
            if($this->meta_description!="N" && $this->meta_description)
            {
                if(isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"]=="Y")
                    $this->meta_description = $this->locText($this->meta_description);
                
                $arLoadProductArray['PROPERTY_VALUES'][$this->meta_description] = $this->meta_description_text;    
            }
            if($this->meta_keywords!="N" && $this->meta_keywords)
            {
                if(isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"]=="Y")
                    $this->meta_keywords = $this->locText($this->meta_keywords);
                
                $arLoadProductArray['PROPERTY_VALUES'][$this->meta_keywords] = $this->meta_keywords_text;    
            }
            
            
            $this->addSeoUniqYandex($arLoadProductArray);
            
            if($PRODUCT_ID = $el->Add($arLoadProductArray, false, $this->index_element=="Y"?true:false, $this->resize_image=="Y"?true:false)){
                $elem[]= ' '.$PRODUCT_ID;
            }
            elseif(!$this->agent){
                $result[ERROR][] = $el->LAST_ERROR;
            }

            $el = null;
            $isElement = null;
            if(isset($preview_html)){
                unset($preview_html);
            }
            if(isset($detail_html)){
                unset($detail_html);
            }
            unset($html);
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $count."|".$ci);
            unset($fileHtml);
            if(self::TEST || $shs_DEMO==2)break;
            if($this->sleep && $this->sleep>0)sleep($this->sleep);

        }
        unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt");
        if($elem){
            $message = implode(',', $elem);
            $message = GetMessage("parser_pars_el_ok").' '.$message.' '.GetMessage("parser_pars_create_ok");
        }
        if($first && !$this->agent){
            $result[SUCCESS][] = $message;
        }
        elseif(!$this->agent){
            $result[ERROR][] = GetMessage("parser_no");
        }
        if(!$this->agent)
        {
            if(isset($result[SUCCESS]) && count($result[SUCCESS])>0)
            {
                foreach($result['SUCCESS'] as $success) CAdminMessage::ShowMessage(array("MESSAGE"=>$success, "TYPE"=>"OK"));
            }
            if(isset($result[ERROR]) && count($result[ERROR])>0)
            {
                foreach($result['ERROR'] as $error) CAdminMessage::ShowMessage($error);
            }
        }
        return $result;
    }
    
    public function GetAuthForm($check=false)
    {   
        if(isset($this->settings[$this->typeN]["auth"]["type"]) && $this->settings[$this->typeN]["auth"]["type"]=="http")
        {
            if(isset($_POST["auth"]) && $_POST["auth"])
            {
                //printr($this);
                //$auth = new FileGetHtml();
                //$data = $auth->file_get_html($this->rss, $this->proxy, $this->auth, $this);
                //printr($auth);
            }
        
            return true;    
        }
        
        
        if(isset($this->settings[$this->typeN]["auth"]["active"]) && $this->settings[$this->typeN]["auth"]["active"]!="Y") return false;
        elseif(!isset($this->settings[$this->typeN]["auth"]["active"])) return false;
        elseif(isset($this->settings[$this->typeN]["auth"]["selector"]) && !$this->settings[$this->typeN]["auth"]["selector"])
        {
            $this->errors[] = GetMessage("parser_auth_error_selector");
            return false;    
        }
         
        
        $url = $this->settings[$this->typeN]["auth"]["url"]?$this->settings["catalog"]["auth"]["url"]:$this->rss;
        $form = $this->settings[$this->typeN]["auth"]["selector"];
        $proxy = $this->settings[$this->typeN]["proxy"];
        
        $auth = new FileGetHtml();
        $data = $auth->file_get_html($url, $proxy);
        $this->urlCatalog = $auth->headerUrl;
        $this->urlSite = $this->getCatalogUrlSite();
        
        $this->CheckAuthForm($data, $form, $proxy);
        
        if($check)if(isset($this->errors) && count(isset($this->errors))>0)
        {
            foreach($this->errors as $error)
            {
                if(isset($_POST["auth"]))CAdminMessage::ShowMessage($error);
            }
        }
        if($check)if(isset($this->success) && count(isset($this->success))>0)
        {
            foreach($this->success as $success)
            {
                if(isset($_POST["auth"]))CAdminMessage::ShowMessage(array("MESSAGE"=>$success, "TYPE"=>"OK"));    
            }
        }
            
    }
    
    public function CheckAuthform($data, $form, $proxy)
    {   
        $this->html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET); 
        //print pq($this->html)->html();
        $objForm = pq($this->html)->find($form);
        $url = $objForm->attr("action");
        $url = empty($url)?$this->urlCatalog:$this->getCatalogLink($url);
        
        $login = trim($this->settings[$this->typeN]["auth"]["login"]);
        $password = trim($this->settings[$this->typeN]["auth"]["password"]);
        foreach($this->html[$form." input"] as $input)
        {
            $name = trim(pq($input)->attr("name"));
            $value = trim(pq($input)->attr("value"));
            $type = trim(pq($input)->attr("type"));
            if(isset($this->settings[$this->typeN]["auth"]["password_name"]) && !empty($this->settings[$this->typeN]["auth"]["password_name"]) && $name==$this->settings[$this->typeN]["auth"]["password_name"])
            {
                //if($name==$this->settings[$this->type]["auth"]["password_name"])
                {
                    $arInput[$name] = $password;
                    continue;    
                }    
            }
            elseif(isset($this->settings[$this->typeN]["auth"]["login_name"]) && !empty($this->settings[$this->typeN]["auth"]["login_name"]) && $name==$this->settings[$this->typeN]["auth"]["login_name"])
            {
                //if($name==$this->settings[$this->type]["auth"]["login_name"])
                {
                    $arInput[$name] = $login;
                    continue;    
                }    
            }
            elseif($type=="password")
            {
                $arInput[$name] = $password;
                continue;        
            }
            elseif($type=="text" || $type=="email"){
                $arInput[$name] = $login;
                continue;    
            } 
            $arInput[$name] = $value;
        }
        if(isset($arInput))$this->doAuth($url, $arInput, $proxy);
        else{
            $this->errors[] = GetMessage("parser_auth_error_selector");    
        }
    }
    
    protected function doAuth($url, $arInput, $proxy)
    {
        $auth = new FileGetHtml();
        $data = $auth->auth($url, $proxy, $arInput, true);
        //if(isset($_POST["auth"]))
        $this->AdminAuth($data);
    }
    
    protected function AdminAuth($data)
    {
        $form = $this->settings[$this->typeN]["auth"]["selector"];
        $this->html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET);
        $passw = false;
        foreach($this->html[$form." input"] as $input)
        {
            $type = pq($input)->attr("type");
            if($type=="password")
            {
                $passw = true;    
            }
        } 
        
        if($passw)
            $this->errors[] = GetMessage("parser_auth_no");
        else
            $this->success[] = GetMessage("parser_auth_ok");
    }
    
    protected function DoPageNavigation()
    {
        $begin = $this->settings["catalog"]["pagenavigation_begin"];
        $end = $this->settings["catalog"]["pagenavigation_end"];
        $this->arPageNavigationDelta[0] = $begin;
        $this->arPageNavigationDelta[1] = $end;
    }

    protected function ValidatePageNavigation($n)
    {
        $n = strip_tags($n);
        $n = preg_replace("/\D/", "", $n);
        return $n;
    }
    //?????? ?? ????? ? ?????????
    protected function CheckPageNavigation($n)
    {
        if(!preg_match("/\d/", $n) || empty($n)) return false;
        if($this->currentPage>$n) return false;
        if($this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n>=$this->arPageNavigationDelta[0] && $n<=$this->arPageNavigationDelta[1]) return $n;
        }elseif($this->arPageNavigationDelta[0] && !$this->arPageNavigationDelta[1])
        {
            if($n>=$this->arPageNavigationDelta[0]) return $n;
        }elseif(!$this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[1]) return $n;
        }
        return false;
    }
    
    protected function CheckPageNavigationLess($n)
    {
        if(!preg_match("/\d/", $n) || empty($n)) return false;
        
        if($this->currentPage>$n) return false;

        if($this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[1]) return $n;
        }elseif(!$this->arPageNavigationDelta[1]) return true;
        return false;
    }

    protected function CheckValidatePageNavigation($n)
    {
        if($this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[0] && $n<=$this->arPageNavigationDelta[1]) return true;
        }elseif($this->arPageNavigationDelta[0] && !$this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[0] && $n<=100000) return true;
        }elseif(!$this->arPageNavigationDelta[0] && $this->arPageNavigationDelta[1])
        {
            if($n<=$this->arPageNavigationDelta[1]) return true;
        }
    }

    protected function CheckOnePageNavigation()
    {
        if($this->settings["catalog"]["pagenavigation_begin"]==1 && $this->settings["catalog"]["pagenavigation_end"]==1)
        {
            return true;
        }elseif(!$this->settings["catalog"]["pagenavigation_selector"] && (!isset($this->settings["catalog"]["pagenavigation_var"]) || !$this->settings["catalog"]["pagenavigation_var"])) return true;
        
        return false;
    }
    
    protected function CheckAlonePageNavigation($n)
    {   
        if(!empty($this->settings["catalog"]["pagenavigation_begin"]) && !empty($this->settings["catalog"]["pagenavigation_end"]) && $this->settings["catalog"]["pagenavigation_end"]==$this->settings["catalog"]["pagenavigation_begin"] && $n==$this->settings["catalog"]["pagenavigation_begin"])
        {
            return true;
        }
        
        return false;
    }

    protected function IsNumberPageNavigation()
    {
        if(!$this->settings["catalog"]["pagenavigation_begin"] && !$this->settings["catalog"]["pagenavigation_end"]) return false;
        else return true;
    }
    
    protected function DeleteLog()
    {
        if($this->agent)unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog".$this->id.".txt");    
    }
    
    protected function SaveLog()
    {
        if($this->settings["catalog"]["log"]=="Y" && isset($this->errors) && count($this->errors)>0)
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$this->id.".txt", print_r($this->errors, true), FILE_APPEND);
            
        if(!isset($this->errors)) $this->errors = array();
        $this->debugErrors = array_merge($this->debugErrors, $this->errors);
    }

    protected function isUpdateElement()
    {
        $this->updateActive = false;
        if($this->settings["catalog"]["update"]["active"])
        {
            unset($this->settings["catalog"]["update"]["active"]);
            $this->updateActive = true;
            foreach($this->settings["catalog"]["update"] as $id=>$val)
            {
                if($val=="Y" || $val=="empty") $this->isUpdate[$id] = $val;
            }
            if(!isset($this->isUpdate) || !$this->isUpdate) $this->isUpdate = false;
        }else  $this->isUpdate = false;
    }

    protected function getUniqElement()
    {
        //if($this->settings["catalog"]["update"]["active"]=="Y")
        {
            $this->uniqFields["NAME"] = "NAME";
            $this->uniqFields["LINK"] = "LINK";

            if($this->settings["catalog"]["uniq"]["prop"])
            {
                unset($this->uniqFields["LINK"]);
                unset($this->uniqFields["NAME"]);
                $prop = $this->settings["catalog"]["uniq"]["prop"];
                $this->uniqFields[$prop] = $prop;
            }
            if($this->settings["catalog"]["uniq"]["name"])
            {
                unset($this->uniqFields["LINK"]);
                unset($this->uniqFields["NAME"]);
                $this->uniqFields["NAME"] = "NAME";
            }
        }
    }
    
    protected function GetSortFields()
    {
        $this->arSortUpdate = array();
        $this->arEmptyUpdate = array();
        if($this->isUpdate)
        {
            foreach($this->isUpdate as $id=>$val)
            {
                if($val!="empty") continue;
                if($id=="preview_img") $this->arSortUpdate[] = "PREVIEW_PICTURE";
                elseif($id=="detail_img") $this->arSortUpdate[] = "DETAIL_PICTURE";
                elseif($id=="preview_descr") $this->arSortUpdate[] = "PREVIEW_TEXT";
                elseif($id=="detail_descr") $this->arSortUpdate[] = "DETAIL_TEXT";
            }
        }    
    }

    protected function checkUniq()
    {   
        if($this->elementUpdate) return $this->elementUpdate;
        if(!isset($this->arSortUpdate)) $this->arSortUpdate = array();
        
        if(isset($this->uniqFields["LINK"]) && $this->uniqFields["LINK"] && isset($this->arFields["NAME"]) && $this->arFields["NAME"])
        {
            $uniq = md5($this->arFields["NAME"].$this->arFields["LINK"]);
            $isElement = CIBlockElement::GetList(Array(), array("XML_ID"=>$uniq, "IBLOCK_ID"=>$this->iblock_id), false, Array("nTopCount"=>1), array_merge(array("ID"), $this->arSortUpdate))->Fetch();
            $this->elementUpdate = $isElement["ID"];
            if($isElement)
            {
                $this->arEmptyUpdate = $isElement;
                return $isElement["ID"];
            }
            else return false;
        }else{
            if($this->settings["catalog"]["uniq"]["prop"])
            {
                $prop = $this->settings["catalog"]["uniq"]["prop"];
                if($this->arFields["PROPERTY_VALUES"][$prop])$arFields["PROPERTY_".$prop] = $this->arFields["PROPERTY_VALUES"][$prop];
            }
            if($this->settings["catalog"]["uniq"]["name"])
            {
                $prop = $this->settings["catalog"]["uniq"]["prop"];
                if($this->arFields["NAME"])$arFields["NAME"] = $this->arFields["NAME"];
            }
            if(count($arFields)==count($this->uniqFields))$isElement = CIBlockElement::GetList(Array(), array_merge(array("IBLOCK_ID"=>$this->iblock_id), $arFields), false, Array("nTopCount"=>1), array_merge(array("ID"), $this->arSortUpdate))->Fetch();
            $this->elementUpdate = $isElement["ID"];
            if($isElement)
            {
                $this->arEmptyUpdate = $isElement;
                return $isElement["ID"];
            }
            else return false;
        }

        return false;
    }
    
    protected function checkOfferUniq()
    {
        if(isset($this->elementOfferUpdate)) return $this->elementOfferUpdate;
        
        $uniq = "offer#".md5($this->arFields["NAME"].$this->arFields["LINK"]);
        $isElement = CIBlockElement::GetList(Array(), array("XML_ID"=>$uniq, "IBLOCK_ID"=>$this->offerArray["IBLOCK_ID"]), false, Array("nTopCount"=>1), array("ID"))->Fetch();
        $this->elementOfferUpdate = $isElement["ID"];
        if($isElement) return $isElement["ID"];
        else return false;
    }
    
    protected function checkOfferUniqTable($arFields=array())
    {
        if(isset($this->elementOfferUpdate)) return $this->elementOfferUpdate;
        
        $uniq = "offer#".md5($this->arFields["LINK"].$arFields["NAME"]);
        $isElement = CIBlockElement::GetList(Array(), array("XML_ID"=>$uniq, "IBLOCK_ID"=>$this->offerArray["IBLOCK_ID"]), false, Array("nTopCount"=>1), array("ID"))->Fetch();
        $this->elementOfferUpdate = $isElement["ID"];
        if($isElement) return $isElement["ID"];
        else return false;
    }

    protected function isCatalog()
    {
        $this->isOfferCatalog = false;
        $this->isOfferParsing = false;
        $this->iblockOffer = 0;
        if(CModule::IncludeModule('catalog') && ($this->iblock_id && CCatalog::GetList(Array("name" => "asc"), Array("ACTIVE"=>"Y", "ID"=>$this->iblock_id))->Fetch()))
        {
            if($this->settings["catalog"]["preview_price"] || $this->settings["catalog"]["detail_price"])
            {
                $this->isCatalog = true;
            }else $this->isCatalog = false;
        }else $this->isCatalog = false;
        if(CModule::IncludeModule('catalog') && isset($this->settings["catalog"]["cat_vat_price_offer"]) && $this->settings["catalog"]["cat_vat_price_offer"]=="Y")
        {
            $arIblock = CCatalogSKU::GetInfoByIBlock($this->iblock_id);
            if(is_array($arIblock) && !empty($arIblock) && $arIblock["PRODUCT_IBLOCK_ID"]!=0 && $arIblock["SKU_PROPERTY_ID"]!=0)
            {
                $this->isOfferCatalog = true;
                $this->offerArray = $arIblock;
                $this->isCatalog = true;            
            }else $this->isOfferCatalog = false;    
        }
        if(CModule::IncludeModule('catalog') && isset($this->settings["offer"]["load"]) && $this->settings["offer"]["load"])
        {
            if(!isset($this->settings["catalog"]["cat_vat_price_offer"]) || isset($this->settings["catalog"]["cat_vat_price_offer"]) && $this->settings["catalog"]["cat_vat_price_offer"]!="Y")
            {
                $arIblock = CCatalogSKU::GetInfoByIBlock($this->iblock_id);
            }
            
            if(is_array($arIblock) && !empty($arIblock) && $arIblock["PRODUCT_IBLOCK_ID"]!=0 && $arIblock["SKU_PROPERTY_ID"]!=0 && $arIblock["IBLOCK_ID"])
            {
                $this->offerArray = $arIblock;
                $this->isCatalog = true;
                $this->isOfferParsing = true;
                if($arIblock["IBLOCK_ID"] && $arIblock["PRODUCT_IBLOCK_ID"])
                    $this->iblockOffer = $arIblock["IBLOCK_ID"];
                           
            }else $this->isOfferParsing = false; 
        }
        
        
    }

    protected function CheckFields($settings)
    {   
        if(preg_match("/\D/", $settings["pagenavigation_begin"]) && $settings["pagenavigation_begin"]!="")
        {
            $this->errors[] = GetMessage("parser_error_pagenavigation_begin");
        }
        if(preg_match("/\D/", $settings["pagenavigation_end"]) && $settings["pagenavigation_end"]!="")
        {
            $this->errors[] = GetMessage("parser_error_pagenavigation_end");
        }
        if(preg_match("/\D/", $settings["step"]))
        {
            $this->errors[] = GetMessage("parser_error_step");
        }
        
        if(is_array($settings["price_updown"]))
        {
            foreach($settings["price_updown"] as $i=>$val)
            {
                if($settings["price_updown"][$i])
                {
                    if($settings["price_terms"][$i] && !self::isFloat($settings["price_terms_value"][$i]))
                    {       
                        $this->errors[] = GetMessage("parser_error_price_terms_value");    
                    }
                    if($settings["price_terms"][$i] && !self::isFloat($settings["price_terms_value_to"][$i]))
                    {       
                        $this->errors[] = GetMessage("parser_error_price_terms_value");    
                    } 
                    if($settings["price_updown"][$i] && !self::isFloat($settings["price_value"][$i]))
                    {
                        $this->errors[] = GetMessage("parser_error_price_value");
                    }   
                }    
            }    
        }
        
        
        

        $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id));
        while ($prop_fields = $properties->GetNext())
        {
            $this->arProperties[$prop_fields["CODE"]] = $prop_fields;
        }
        
        if($this->iblockOffer)
        {
            $properties = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblockOffer));
            while ($prop_fields = $properties->GetNext())
            {
                $this->arPropertiesOffer[$prop_fields["CODE"]] = $prop_fields;
            }    
        }

        $this->arSelectorProduct = $this->getSelectorProduct();
        $this->arFindProduct = $this->getFindProduct();
        $this->arSelectorProperties = $this->getSelectorProperties();
        $this->arSelectorPropertiesOffer = $this->getSelectorPropertiesOffer();
        $this->arFindProperties = $this->getFindProperties();
        $this->arFindPropertiesOffer = $this->getFindPropertiesOffer();
        $this->arDubleFindProperties = $this->getFindDubleProperties();
        $this->arDubleFindPropertiesOffer = $this->getFindDublePropertiesOffer();
        
        $this->arSelectorPropertiesPreview = $this->getSelectorPropertiesPreview();
        $this->arFindPropertiesPreview = $this->getFindPropertiesPreview();
        $this->arDubleFindPropertiesPreview = $this->getFindDublePropertiesPreview();
        //printr($this->ArDubleFindProperties);
    }
    
    protected function isFloat($n)
    {
        if(preg_match("/^(?:\+|\-)?(?:(?:\d+)|(?:\d+\.)|(?:\.\d+)|(?:\d+\.\d+)){1}(?:e(?:\+|\-)?\d+)?$/i", $n)) return true;
        else return false;
    }


    protected function parseCatalog()
    {   
        set_time_limit(0);
        $this->ClearAjaxFiles();
        $this->DeleteLog();
        $this->checkActionBegin();
        $this->arUrl = array();
        if(isset($this->settings["catalog"]["url_dop"]) && !empty($this->settings["catalog"]["url_dop"]))$this->arUrl = explode("\r\n", $this->settings["catalog"]["url_dop"]);
        
        $this->arUrl = array_merge(array($this->rss), $this->arUrl);
        $this->arUrlSave = $this->arUrl;
        
        if(!$this->PageFromFile()) return false;
        $this->CalculateStep();
        if($this->settings["catalog"]["mode"]!="debug" && !$this->agent) $this->arUrlSave = array($this->rss);
        else $this->arUrlSave = $this->arUrl; 
        //if(!$this->connectCatalogPage($this->rss));
        //return;
        foreach($this->arUrlSave as $rss):
            $rss = trim($rss);
            if(empty($rss)) continue;
            $this->rss = $rss;
            $this->convetCyrillic($this->rss); 
            $this->connectCatalogPage($this->rss);
            if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && isset($this->errors) && count($this->errors)>0)
            {
                $this->SaveLog();
                unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt");
                return false;    
            }
        
            $this->parseCatalogNavigation($this->rss);
            $n = $this->currentPage;
            if(!$this->IsNumberPageNavigation())
            {   
                $this->parseCatalogProducts();
            }elseif($this->IsNumberPageNavigation() && $this->CheckPageNavigation($n))
            {   
                $this->parseCatalogProducts();
            }elseif($this->settings["catalog"]["mode"]!="debug" && !$this->agent)
            {
                $this->stepStart = true;
                $this->SavePrevPage($this->rss);    
            }
         
            $this->SaveCurrentPage($this->pagenavigation);
            if($this->stepStart)
            {
                if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
                    unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                $this->DeleteCopyPage();
            } 
            if((!$this->CheckOnePageNavigation() && $this->agent) || (!$this->CheckOnePageNavigation() && !$this->agent && $this->settings["catalog"]["mode"]=="debug"))$this->parseCatalogPages();
            if($this->CheckOnePageNavigation() && $this->stepStart)
            {
                if($this->IsEndSectionUrl())$this->ClearBufferStop();
                else $this->ClearBufferStep();
                return false;    
            }
        endforeach;
        
        $this->checkActionAgent();

        if($this->agent || $this->settings["catalog"]["mode"]=="debug"){
            foreach(GetModuleEvents("shs.parser", "EndPars", true) as $arEvent)
                ExecuteModuleEventEx($arEvent, array($this->id));
        }
    }
    
    protected function PageFromFile()
    {
        if($this->settings["catalog"]["mode"]=="debug" || $this->agent || $_GET["begin"]) return true;
        $prevPage = $prevElement = $currentPage = 0;
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt"))
            $prevPage = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt");
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt"))
            $prevElement = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt");
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt"))
            $currentPage = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt");
        
        if($prevPage)
        {
            $arPrevPage = explode("|", $prevPage);
            $arPrevElement = explode("|", $prevElement);
            $arCurrentPage = explode("|", $currentPage);    
        }else{
            $arPrevPage = array();
            $arCurrentPage = array();
        }
        
        if(isset($arPrevElement) && is_array($arPrevElement))foreach($arPrevElement as $i=>$p)
        {
            $p = trim($p);
            if(empty($p)) continue;
            $this->pagePrevElement[$p] = $p;
        }
        
        if(!$_GET["begin"] && !$prevPage) return true;
        
        if(isset($arPrevPage) && is_array($arPrevPage))foreach($arPrevPage as $i=>$p)
        {
            $p = trim($p);
            if(empty($p)) continue;
            $this->pagenavigationPrev[$p] = $p;
        }
        
        
        if(isset($arCurrentPage) && is_array($arCurrentPage))foreach($arCurrentPage as $p)
        {
            $p = trim($p);
            if(empty($p)) continue;
            $this->pagenavigation[$p] = $p;    
        }
        
        if(isset($this->pagenavigationPrev) && is_array($this->pagenavigationPrev))foreach($this->pagenavigationPrev as $i=>$v)
        {
            foreach($this->pagenavigation as $i1=>$v1)
            {
                if($v1==$v) unset($this->pagenavigation[$i1]);   
            }
        }
        
        if(isset($this->pagenavigation) && is_array($this->pagenavigation))foreach($this->pagenavigation as $p)
        {
            $isContinue = true;
            $this->rss = $p;
            break;
        }
        if(!$isContinue && !empty($this->pagenavigationPrev) && $this->IsEndSectionUrl())
        {
                 
            //if($this->IsEndSectionUrl())
            $this->ClearBufferStop();
            //else $this->ClearBufferStep();
            return false;
        }elseif(!$isContinue && !empty($this->pagenavigationPrev) && !$this->IsEndSectionUrl())
        {
            $isContinue = true;
            $this->rss = $this->GetUrlRss();        
        }
         
        $this->currentPage = count($this->pagenavigationPrev);
        if($this->IsNumberPageNavigation() && $this->CheckPageNavigation($this->currentPage))
        {
            
            $this->activeCurrentPage = $this->currentPage-$this->arPageNavigationDelta[0]+1;
        }elseif(!$this->IsNumberPageNavigation()) $this->activeCurrentPage = $this->currentPage;
        return true;
    }
    
    protected function IsEndSectionUrl()
    {
        if(!isset($this->settings["catalog"]["url_dop"]) || empty($this->settings["catalog"]["url_dop"]) || empty($this->arUrl)) return true;
        $count = 0;
        foreach($this->arUrl as $i=>$url)
        {
            if(isset($this->pagenavigationPrev[$url])) $count++;   
        }
        if($count==count($this->arUrl)) return true;
        else return false;
    }
    
    protected function GetUrlRss()
    {
        foreach($this->arUrl as $i=>$url)
        {
            if(isset($this->pagenavigationPrev[$url])) continue;
            return $url;
        }        
    }
    
    protected function ClearBufferStop()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            global $APPLICATION;
            //if(self::TEST==0)
            $APPLICATION->RestartBuffer();
            $this->checkActionAgent(false);
            foreach(GetModuleEvents("shs.parser", "EndPars", true) as $arEvent)
                ExecuteModuleEventEx($arEvent, array($this->id));

            die("stop");    
        }
    }
    
    protected function ClearBufferStep()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            global $APPLICATION;
            if(self::TEST==0)$APPLICATION->RestartBuffer();
            die();    
        }
    }

    protected function parseCatalogProducts()
    {
        $count = 0;
        
        $this->activeCurrentPage++;
        $this->SetCatalogElementsResult($this->activeCurrentPage);
        
        $element = $this->settings["catalog"]["selector"];

        if($this->preview_delete_element)$this->deleteCatalogElement($this->preview_delete_element, $element, $this->html[$element]);
        if($this->preview_delete_attribute)$this->deleteCatalogAttribute($this->preview_delete_attribute, $element, $this->html[$element]);
        $i = 0;
        $ci = 0;
        
        foreach($this->html[$element] as $el)
        {
            $count++;
        }

        if($this->settings["catalog"]["mode"]!="debug" && !$this->agent)
        {
            if($count>$this->settings["catalog"]["step"] && ($this->settings["catalog"]["mode"]!="debug" && !$this->agent))
                $countStep = $this->settings["catalog"]["step"];
            else{
                $this->stepStart = true;
                if($this->CheckOnePageNavigation() || $this->CheckAlonePageNavigation($this->currentPage)) $this->pagenavigation[$this->rss] = $this->rss;
                $this->SaveCurrentPage($this->pagenavigation);
                $this->SavePrevPage($this->sectionPage);
                $countStep = $count;
            }    
        }else{
            $countStep = $count;    
        }
            
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $countStep."|".$ci);    
        
        if($count==0)
        {
            $this->errors[] = GetMessage("parser_error_selector_notfound")."[".$element."]";
            $this->clearFields();
            //die();
        }

        foreach($this->html[$element] as $el)
        {
            $ci++;
            if($this->StepContinue($ci, $count)) continue;
            if ($this->typeN == "xml") $debug_item = parent::DEFAULT_DEBUG_ITEM;
            else $debug_item = self::DEFAULT_DEBUG_ITEM;
            if($i==$debug_item && $this->settings["catalog"]["mode"]=="debug") break;
            if($this->typeN=="catalog")
            {
               $this->parseCatalogProductElement($el); 
            }
            if($this->typeN=="xml")
            {
                parent::parseCatalogProductElementXml($el);
            }
            $i++;
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt", $countStep."|".$i);
            $this->CalculateStep($count);
            
        }
        unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt");
    }

    protected function parseCatalogProductElement(&$el)
    {
        $this->countItem++;
        if(!$this->parserCatalogPreview($el))
        {
            //$this->SaveLog();
            $this->SaveCatalogError();
            $this->clearFields();
            return false;    
        }

        $this->parserCatalogDetail();
        $this->parseCatalogSection();
        $this->parseCatalogMeta();
        $this->parseCatalogFirstUrl();
        $this->parseCatalogDate();
        $this->parseCatalogAllFields();


        $db_events = GetModuleEvents("shs.parser", "parserBeforeAddElementCatalog", true); //27.10.2015
        $error = false;
        foreach($db_events as $arEvent)
        {
            $bEventRes = ExecuteModuleEventEx($arEvent, array(&$this, &$el));
            if($bEventRes===false)
            {
                $error = true;
                break 1;
            }
        }

        if(!$error && !$error_isad) //27.10.2015
        {
            $this->AddElementCatalog();
            foreach(GetModuleEvents("shs.parser", "parserAfterAddElementCatalog", true) as $arEvent)
                ExecuteModuleEventEx($arEvent, array(&$this, &$el));
        }

        if($this->isCatalog && $this->elementID)
        {   
            /*if($this->boolOffer)
            {
                return true;    
            }*/
            
            
            
            if($this->isOfferCatalog && !$this->boolOffer)
            {                                  
                $this->AddElementOfferCatalog();
                $this->elementID = $this->elementOfferID;
                $this->elementUpdate = $this->elementOfferUpdate;
            }
            if($this->boolOffer)
            {
                $this->addProductPriceOffers();
            }else{
                
                $this->AddProductCatalog();
                $this->AddMeasureCatalog();
                $this->AddPriceCatalog();    
            }
            
        }/*else{
            $this->AddElementOfferCatalog();
            $this->AddProductCatalog();
            $this->AddMeasureCatalog();
            $this->AddPriceCatalog();    
        }*/

        $this->SetCatalogElementsResult();
        $this->clearFields();
        
    }
    
    protected function addProductPriceOffers()
    {
        if(isset($this->arOfferAll))
        {
            if(isset($this->arOfferAll["FIELDS"]) && !empty($this->arOfferAll["FIELDS"]))
            {
                foreach($this->arOfferAll["FIELDS"] as $i=>$field)
                {
                    $this->AddElementOfferCatalogTable($field);
                    $arPrice = $this->arOfferAll["PRICE"][$i];
                    $this->arPrice = $arPrice;
                    $this->AddProductCatalogOffer($field);
                    $this->AddMeasureCatalogOffer($field);
                    $this->AddPriceCatalogOffer($arPrice, $field);
                    
                    if(isset($this->elementOfferID))
                        unset($this->elementOfferID);
                        
                    if(isset($this->elementOfferUpdate))
                        unset($this->elementOfferUpdate);
                }
            }
        
            
        }
        
        //printr($this->arOfferAll);
    }
    
    protected function AddElementOfferCatalogTable($arFields)
    {
        if($this->checkOfferUniqTable($arFields) && !$this->isUpdate) return false;
        $el = new CIBlockElement;
        $isElement = $this->checkOfferUniqTable($arFields);
        $arFields["IBLOCK_ID"] = $this->iblockOffer;
        $arFields["PROPERTY_VALUES"][$this->offerArray["SKU_PROPERTY_ID"]] = $this->elementID; 
        if(!$isElement)
        {   

            $id = $el->Add($arFields, "N", $this->index_element, $this->resize_image);
            if(!$id)
            {   
                $this->errors[] = GetMessage("parser_offer_name").$arFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }else{
                $this->elementOfferID = $id;
                $this->addTmp($id);    
            } 
        }else{
            $this->elementOfferID = $isElement;
            $el->Update($isElement, $arFields);
            $this->addTmp($isElement);
        } 
       
        unset($el);    
    }
    
    protected function StepContinue($n, $count=0)
    {
        if($this->settings["catalog"]["mode"]=="debug" || $this->agent) return false;
        $step = (int)$this->settings["catalog"]["step"];
        if($step>$count && $count>0) return false;
        $file = 0;
        
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
        if($file)
        {
            $arFile = explode("|", $file);
            $countElement = (int)$arFile[0];
            $currentElement = (int)$arFile[1];    
        }else{
            return false;
        }

        if($currentElement>0 && $n<=$currentElement && $currentElement%$step==0) return true;
        else return false;    
    }
    
    protected function CalculateStep($count = 0)
    {           

        if($this->settings["catalog"]["mode"]=="debug" || $this->agent || $this->stepStart) return true;
        $step = $this->settings["catalog"]["step"];
        if($step>$count && $count>0)
        {
            $this->stepStart = true;
            return true;    
        }
        $file = 0;
        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))  
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
        if($file)
        {
            $arFile = explode("|", $file);
            $countElement = (int)$arFile[0];
            $currentElement = (int)$arFile[1];    
        }else{
            $countElement = $count;
            $currentElement = 0;   
        }
        if($countElement-$currentElement<=$step && $countElement>0 && $count==0)
        {
            $this->stepStart = true;
        }
         
        if($count==0) return true;
        $currentElement++;
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt", $countElement."|".$currentElement);
        if($currentElement%$step==0 && !$this->stepStart)
        {
            $this->clearFields();
            $this->ClearBufferStep();
        }
        
            
    }
    
    protected function SetCatalogElementsResult($page=false)
    {
        $file = 0;
        if(file_exists(($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt")))
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt");
        
        if($file)
        {
            $arFile = explode("|", $file);
            
            $countPage = (int)$arFile[1];
            $ciElement = (int)$arFile[2];
            $errorElement = (int)$arFile[3];
            $allError = (int)$arFile[4];
        }
        else{
            $countPage = 0;
            $ciElement = 0;
            $errorElement = 0;
            $allError = 0; 
        }
        
        if($page)
        {
            $countPage = $page;    
        }elseif(isset($this->elementID)){
            $ciElement++;
            if(isset($this->errors) && count($this->errors))$errorElement++;
            $this->SavePrevPageDetail($this->arFields["LINK"]);    
        }
        if(isset($this->errors) && count($this->errors)>0)$allError = $allError+count($this->errors);
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt", "|".$countPage."|".$ciElement."|".$errorElement."|".$allError."|".$this->countSection);
    }
    /*?????????? ? ????? ?????? ????????*/
    protected function SaveCatalogError()
    {
        $file = 0;
        if(file_exists(($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt")))
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt");
        
        if($file)
        {
            $arFile = explode("|", $file);
            
            $countPage = (int)$arFile[1];
            $ciElement = (int)$arFile[2];
            $errorElement = (int)$arFile[3];
            $allError = (int)$arFile[4];
        }
        else{
            $countPage = 0;
            $ciElement = 0;
            $errorElement = 0;
            $allError = 0; 
        }
        if(isset($this->elementID)){
            if(isset($this->errors) && count($this->errors))$errorElement++;
        }
        if(isset($this->errors) && count($this->errors)>0)$allError = $allError+count($this->errors);
        file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt", "|".$countPage."|".$ciElement."|".$errorElement."|".$allError."|".$this->countSection);    
    }
    /*???????? ??? ?????*/
    protected function parseCatalogAllFields()
    {
        if($this->updateActive && isset($this->settings["catalog"]["uniq"]["action"]) && $this->settings["catalog"]["uniq"]["action"]=="A")
            $this->arFields["ACTIVE"] = $this->active_element;
        
        if($this->checkUniq()) return false;
        $this->arFields["IBLOCK_ID"] = $this->iblock_id;
        $this->arFields["ACTIVE"] = $this->active_element;
        if($this->code_element=="Y")
        {
            $this->arFields["CODE"] = $this->getCodeElement($this->arFields["NAME"]);
        }

        if($this->uniqFields["LINK"])
        {
            $uniq = md5($this->arFields["NAME"].$this->arFields["LINK"]);
            $this->arFields["XML_ID"] = $uniq;
        }
        
        if($this->date_active=="NOW") $this->arFields["DATE_ACTIVE_FROM"] = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "SHORT");
        elseif($this->date_active=="NOW_TIME") $this->arFields["DATE_ACTIVE_FROM"] = ConvertTimeStamp(time() + CTimeZone::GetOffset(), "FULL");
        //elseif($this->date_active=="PUBLIC" && $unix) $this->arFields["DATE_ACTIVE_FROM"] = ConvertTimeStamp($unix, "FULL");
    }

    protected function AddElementCatalog()
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $el = new CIBlockElement;   
        $isElement = $this->checkUniq();
        $this->boolUpdate = true;

        if(!$isElement)
        {   
            $id = $el->Add($this->arFields, "N", $this->index_element, $this->resize_image);
            if(!$id)
            {   
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }else{
                $this->elementID = $id; 
                $this->addTmp($id);
                $this->addSeoUniqYandex($this->arFields);   
            } 
        }else{
             $this->clearFieldsUpdate();
             $this->elementID = $isElement;
             $el->Update($isElement, $this->arFields);
             $this->arFields["NAME"] = $this->elementName;
             $this->addTmp($isElement);
        }
        
        unset($el);
    }
    
    protected function AddElementOfferCatalog()
    {   
        if($this->elementUpdate && !$this->isUpdate) return false;
        $el = new CIBlockElement;  
        
        $isElement = $this->checkOfferUniq(); 
        if(!$isElement)
        {   
            $this->arOfferFields["XML_ID"] = "offer#".md5($this->arFields["NAME"].$this->arFields["LINK"]);
            $this->arOfferFields["NAME"] = $this->arFields["NAME"];
            $this->arOfferFields["IBLOCK_ID"] = $this->offerArray["IBLOCK_ID"];
            $this->arOfferFields["PROPERTY_VALUES"][$this->offerArray["SKU_PROPERTY_ID"]] = $this->elementID;
            
            $id = $el->Add($this->arOfferFields, "N", $this->index_element, $this->resize_image); 
            if(!$id)
            {   
                $this->errors[] = GetMessage("parser_offer_name").$this->arOfferFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }else{
                $this->elementOfferID = $id;
                $this->addTmp($id);    
            } 
        }else{
            $this->elementOfferID = $isElement;
            $this->addTmp($isElement);    
        } 
        
        /*else{
             $this->clearFieldsUpdate();

             $this->elementID = $isElement;
             $el->Update($isElement, $this->arOfferFields);
        }*/
        unset($el);
    }
    
    protected function addSeoUniqYandex($arFields)
    {
        if(isset($this->settings["loc"]["uniq"]["domain"]) && !empty($this->settings["loc"]["uniq"]["domain"]) && isset($arFields["DETAIL_TEXT"]) && !empty($arFields["DETAIL_TEXT"]) && strlen($arFields["DETAIL_TEXT"])>=500)
        {
            $textContent = $arFields["DETAIL_TEXT"];
            $engine = new Engine\Yandex();
            $domain = $this->settings["loc"]["uniq"]["domain"];
            try
            {
                $res = $engine->addOriginalText($textContent, $domain);
            }catch(Engine\YandexException $e)
            {   
                $this->errors[] = $e->getMessage();
            }
            
            unset($engine);
        }
    }
                           
    protected function clearFieldsUpdate()
    {

        $this->arEmptyUpdate["PREVIEW_TEXT"] = trim($this->arEmptyUpdate["PREVIEW_TEXT"]);
        $this->arEmptyUpdate["DETAIL_TEXT"] = trim($this->arEmptyUpdate["DETAIL_TEXT"]);
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"]))
        {
            unset($this->arFields["PROPERTY_VALUES"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["preview_descr"] || (in_array("PREVIEW_TEXT", $this->arSortUpdate) && !empty($this->arEmptyUpdate["PREVIEW_TEXT"]))))
        {
            unset($this->arFields["PREVIEW_TEXT"]);
            unset($this->arFields["PREVIEW_TEXT_TYPE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["detail_descr"] || (in_array("DETAIL_TEXT", $this->arSortUpdate) && !empty($this->arEmptyUpdate["DETAIL_TEXT"]))))
        {
            unset($this->arFields["DETAIL_TEXT"]);
            unset($this->arFields["DETAIL_TEXT_TYPE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["preview_img"] || (in_array("PREVIEW_PICTURE", $this->arSortUpdate) && !empty($this->arEmptyUpdate["PREVIEW_PICTURE"]))))
        {
            unset($this->arFields["PREVIEW_PICTURE"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["detail_img"] || (in_array("DETAIL_PICTURE", $this->arSortUpdate) && !empty($this->arEmptyUpdate["DETAIL_PICTURE"]))))
        {
            unset($this->arFields["DETAIL_PICTURE"]);
        }
        $this->elementName = $this->arFields["NAME"];
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["name"]))
        {
            unset($this->arFields["NAME"]);
        }
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"]))
        {
            unset($this->arPrice);
        }
        if($this->checkUniq())
        {
            $code = $this->settings["catalog"]["more_image_props"];
            unset($this->arFields["PROPERTY_VALUES"][$code]);
        }

    }
    
    protected function AddMeasureCatalogOffer()
    {
        if($this->elementOfferUpdate) return false;
        $info = CModule::CreateModuleObject('catalog');
        if(!CheckVersion("14.0.0", $info->MODULE_VERSION))
        {
            if($this->settings["catalog"]["koef"]>0)
            {
                $arMes = array("RATIO"=>$this->settings["catalog"]["koef"], "PRODUCT_ID"=>$this->elementOfferID);
                $str_CAT_MEASURE_RATIO = 1;
                $CAT_MEASURE_RATIO_ID = 0;
                $db_CAT_MEASURE_RATIO = CCatalogMeasureRatio::getList(array(), array("PRODUCT_ID" => $this->elementOfferID));
                if($ar_CAT_MEASURE_RATIO = $db_CAT_MEASURE_RATIO->Fetch())
                {
                    $str_CAT_MEASURE_RATIO = $ar_CAT_MEASURE_RATIO["RATIO"];
                    $CAT_MEASURE_RATIO_ID =  $ar_CAT_MEASURE_RATIO["ID"];
                }
                if($CAT_MEASURE_RATIO_ID>0)
                {
                    if(!CCatalogMeasureRatioAll::Update($CAT_MEASURE_RATIO_ID, $arMes))
                    {
                        $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_ratio");
                    }
                }
                else{
                    if(!CCatalogMeasureRatio::add($arMes))
                    {
                        $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_ratio");
                    }
                }
                
            }
        }
    }

    protected function AddMeasureCatalog()
    {
        if($this->elementUpdate) return false;
        $info = CModule::CreateModuleObject('catalog');
        if(!CheckVersion("14.0.0", $info->MODULE_VERSION))
        {
            if($this->settings["catalog"]["koef"]>0)
            {
                $arMes = array("RATIO"=>$this->settings["catalog"]["koef"], "PRODUCT_ID"=>$this->elementID);
                $str_CAT_MEASURE_RATIO = 1;
                $CAT_MEASURE_RATIO_ID = 0;
                $db_CAT_MEASURE_RATIO = CCatalogMeasureRatio::getList(array(), array("PRODUCT_ID" => $this->elementID));
                if($ar_CAT_MEASURE_RATIO = $db_CAT_MEASURE_RATIO->Fetch())
                {
                    $str_CAT_MEASURE_RATIO = $ar_CAT_MEASURE_RATIO["RATIO"];
                    $CAT_MEASURE_RATIO_ID =  $ar_CAT_MEASURE_RATIO["ID"];
                }
                if($CAT_MEASURE_RATIO_ID>0)
                {
                    if(!CCatalogMeasureRatioAll::Update($CAT_MEASURE_RATIO_ID, $arMes))
                    {
                        $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_ratio");
                    }    
                }
                else{
                    if(!CCatalogMeasureRatio::add($arMes))
                    {
                        $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_ratio");
                    }    
                }
                
            }
        }
    }

    protected function AddProductCatalog()
    {
        if($this->elementUpdate && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        $this->arProduct["MEASURE"] = $this->settings["catalog"]["measure"];
        $this->arProduct["VAT_ID"] = $this->settings["catalog"]["cat_vat_id"];
        $this->arProduct["VAT_INCLUDED"] = $this->settings["catalog"]["cat_vat_included"];
        $this->arProduct["ID"] = $this->elementID;

        $isElement = $this->elementUpdate;
        if(!$isElement)
        {
            if(!CCatalogProduct::Add($this->arProduct))
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_add_product");
            }
        }else{
            $this->UpdateProductCatalog($isElement);
        }

    }
    
    protected function AddProductCatalogOffer($arFields)
    {
        if($this->elementOfferUpdate && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        $this->arProduct["MEASURE"] = $this->settings["catalog"]["measure"];
        $this->arProduct["VAT_ID"] = $this->settings["catalog"]["cat_vat_id"];
        $this->arProduct["VAT_INCLUDED"] = $this->settings["catalog"]["cat_vat_included"];
        $this->arProduct["ID"] = $this->elementOfferID;

        $isElement = $this->elementOfferUpdate;
        if(!$isElement)
        {
            if(!CCatalogProduct::Add($this->arProduct))
            {
                $this->errors[] = $this->arFields["NAME"]." - ".$arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_add_product_offer");
            }
        }else{
            $this->UpdateProductCatalogOffer($isElement, $arFields);
        }

    }
    
    protected function UpdateProductCatalogOffer($productID, $arFields)
    {
        if(!$productID){
            $this->errors[] = $this->arFields["NAME"]."-".$arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_update_product_offer");
            return false;
        }
        CCatalogProduct::Update($productID, $this->arProduct);
    } 
    
    protected function UpdateProductCatalog($productID)
    {
        if(!$productID){
            $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_update_product");
            return false;
        }
        CCatalogProduct::Update($productID, $this->arProduct);
    }
    
    protected function AddProductCatalogOffers()
    {
        
    }
    
    protected function ConvertCurrency()
    {
        if($this->settings["catalog"]["convert_currency"])
        {
            $this->arPrice["CURRENCY"] = $this->settings["catalog"]["convert_currency"];
            $this->arPrice["PRICE"] = CCurrencyRates::ConvertCurrency($this->arPrice["PRICE"], $this->settings["catalog"]["currency"], $this->settings["catalog"]["convert_currency"]);    
        }    
    }
    
    protected function ChangePrice()
    {
        if(is_array($this->settings["catalog"]["price_updown"]) && count($this->settings["catalog"]["price_updown"])>0)
        {
            foreach($this->settings["catalog"]["price_updown"] as $i=>$val)
            {
                if($this->settings["catalog"]["price_updown"][$i] && $this->settings["catalog"]["price_value"][$i])
                {
                    if($this->settings["catalog"]["price_terms"][$i]=="delta")
                    {
                        if(empty($this->settings["catalog"]["price_terms_value"][$i]) && !empty($this->settings["catalog"]["price_terms_value_to"][$i]))
                        {
                            if($this->arPrice["PRICE"]>$this->settings["catalog"]["price_terms_value_to"][$i]) continue;
                        }
                        
                        if(!empty($this->settings["catalog"]["price_terms_value"][$i]) && empty($this->settings["catalog"]["price_terms_value_to"][$i]))
                        {
                            if($this->arPrice["PRICE"]<$this->settings["catalog"]["price_terms_value"][$i]) continue;
                        }

                        if(!empty($this->settings["catalog"]["price_terms_value"][$i]) && !empty($this->settings["catalog"]["price_terms_value_to"][$i]))
                        {
                            if($this->arPrice["PRICE"]<$this->settings["catalog"]["price_terms_value"][$i] || $this->arPrice["PRICE"]>$this->settings["catalog"]["price_terms_value_to"][$i]) continue;
                        }
                    }
                    if($this->settings["catalog"]["price_type_value"][$i]=="percent")
                    {
                        $delta = $this->arPrice["PRICE"]*$this->settings["catalog"]["price_value"][$i]/100; 
                    }else{
                        $delta = $this->settings["catalog"]["price_value"][$i]; 
                    }
                    if($this->settings["catalog"]["price_updown"][$i]=="up")
                    {   
                        $this->arPrice["PRICE"] += $delta;
                    }
                    elseif($this->settings["catalog"]["price_updown"][$i]=="down")
                    {    
                        $this->arPrice["PRICE"] -= $delta;
                    }
                    break;
                }
            }
        }else{
            if($this->settings["catalog"]["price_updown"] && $this->settings["catalog"]["price_value"])
            {   
                    if($this->settings["catalog"]["price_terms"]=="up" && $this->settings["catalog"]["price_terms_value"])
                    {
                        if($this->arPrice["PRICE"]<$this->settings["catalog"]["price_terms_value"]) return false;
                    }
                    if($this->settings["catalog"]["price_terms"]=="down" && $this->settings["catalog"]["price_terms_value"])
                    {
                        if($this->arPrice["PRICE"]>$this->settings["catalog"]["price_terms_value"]) return false;
                    }
            
                    if($this->settings["catalog"]["price_type_value"]=="percent")
                    {
                        $delta = $this->arPrice["PRICE"]*$this->settings["catalog"]["price_value"]/100; 
                    }else{
                        $delta = $this->settings["catalog"]["price_value"];
                    }
                    if($this->settings["catalog"]["price_updown"]=="up")
                    {
                        $this->arPrice["PRICE"] += $delta;
                    }
                    elseif($this->settings["catalog"]["price_updown"]=="down")
                    {
                        $this->arPrice["PRICE"] -= $delta;
                    }
            }    
        }

    }

    protected function AddPriceCatalog()
    {
        if($this->elementUpdate && (!$this->isUpdate || !$this->isUpdate["price"])) return false;

        if(!$this->arPrice || !$this->arPrice["PRICE"]) return false;
        $isElement = $this->elementUpdate;
        $this->arPrice["PRODUCT_ID"] = $this->elementID;
        $this->ChangePrice();
        $this->ConvertCurrency();
        $this->arPrice["PRICE"] = $this->parseCatalogPriceOkrug($this->arPrice["PRICE"]);
        $obPrice = new CPrice();
        if(!$isElement)
        {
            $price = $obPrice->Add($this->arPrice);
            if(!$price)
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_add_price").$obPrice->LAST_ERROR;
            }
        }else $this->UpdatePriceCatalog($isElement);

        unset($obPrice);
    }
    
    protected function AddPriceCatalogOffer($arPrice, $arFields)
    {
        if($this->elementOfferUpdate && (!$this->isUpdate || !$this->isUpdate["price"])) return false;
        if(!$this->arPrice || !$this->arPrice["PRICE"]) return false;
        $isElement = $this->elementOfferUpdate;
        $this->arPrice["PRODUCT_ID"] = $this->elementOfferID;
        $this->ChangePrice();
        $this->ConvertCurrency();

        $this->arPrice["PRICE"] = $this->parseCatalogPriceOkrug($this->arPrice["PRICE"]);

        $obPrice = new CPrice();
        if(!$isElement)
        {
            $price = $obPrice->Add($this->arPrice);
            if(!$price)
            {
                $this->errors[] = $this->arFields["NAME"]." - ".$arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_add_price_offer").$obPrice->LAST_ERROR;
            }
        }else $this->UpdatePriceCatalog($isElement);

        unset($obPrice);
    }

    protected function UpdatePriceCatalog($elementID)
    {
        if(!$elementID){
            $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."] ".GetMessage("parser_error_update_price");
            return false;
        }
        $res = CPrice::GetList(
            array(),
            array(
                "PRODUCT_ID" => $elementID,
                "CATALOG_GROUP_ID" => $this->arPrice["CATALOG_GROUP_ID"]
                )
        );

        if ($arr = $res->Fetch())
        {
            CPrice::Update($arr["ID"], $this->arPrice);
        }
    }

    protected function parserCatalogPreview(&$el)
    {
        foreach(GetModuleEvents("shs.parser", "parserCatalogPreview", true) as $arEvent)
            ExecuteModuleEventEx($arEvent, array($this->id, &$el, &$this->arFields));
        if(!$this->parseCatalogUrlPreview($el)) return false;
        $this->parseCatalogNamePreview($el);
        $this->parseCatalogPropertiesPreview($el);
        if($this->isCatalog)$this->parseCatalogPricePreview($el);
        $this->parseCatalogPreviewPicturePreview($el);
        $this->parseCatalogDescriptionPreview($el);

        return true;
    }

    protected function parserCatalogDetail()
    {

        if($this->checkUniq() && !$this->isUpdate) return false;
        $el = $this->parserCatalogDetailPage();
        foreach(GetModuleEvents("shs.parser", "parserCatalogDetail", true) as $arEvent)
            ExecuteModuleEventEx($arEvent, array($this->id, &$el, &$this->arFields));
        $this->parseCatalogNameDetail($el);
        $this->parseCatalogProperties($el);
        $this->parseCatalogDetailPicture($el);
        $this->parseCatalogDetailMorePhoto($el);
        if($this->isCatalog)$this->parseCatalogPriceDetail($el);
        $this->parseCatalogDescriptionDetail($el);
        $this->parserOffers($el);
    }
    
    protected function parserOffers($el)
    {
        $this->boolOffer = false;
        if($this->settings["offer"]["load"]=="table" && $this->isOfferParsing && isset($this->settings["offer"]["selector"]) && $this->settings["offer"]["selector"] && isset($this->settings["offer"]["selector_item"]) && $this->settings["offer"]["selector_item"])
        {
            //$this->arFields["NAME"] = htmlspecialchars_decode(trim(strip_tags(pq($el)->find($name)->html())));
           $offerItem = $this->settings["offer"]["selector"]." ".$this->settings["offer"]["selector_item"];
           $this->parserHeadTableOffer($el);

           foreach(pq($el)->find($offerItem) as $offer)
           {
                $this->boolOffer = true;
                if($this->parseOfferName($offer))
                {
                    $this->parseOfferPrice($offer);
                    $this->parseOfferProps($offer);
                    if(!$this->parseOfferGetUniq())
                    {
                        $this->deleteOfferFields();;
                        continue 1;
                    }

                }else
                    continue 1;

                $this->arOfferAll["FIELDS"][] = $this->arOffer;
                $this->arOfferAll["PRICE"][] = $this->arPriceOffer;

                $this->deleteOfferFields();
                    
           }
        }elseif($this->settings["offer"]["load"]=="one" && $this->isOfferParsing && isset($this->settings["offer"]["one"]["selector"]) && $this->settings["offer"]["one"]["selector"])
        {
            $offerItem = trim($this->settings["offer"]["one"]["selector"]);
            foreach(pq($el)->find($offerItem) as $offer)
            {    
                $this->boolOffer = true;
                if($this->parseOfferName($offer))
                {
                    $this->parseOfferPrice($offer);
                    $this->parseOfferProps($offer);
                    if(!$this->parseOfferGetUniq())
                    {
                        $this->deleteOfferFields();;
                        continue 1;
                    }

                }else
                    continue 1;

                $this->arOfferAll["FIELDS"][] = $this->arOffer;
                $this->arOfferAll["PRICE"][] = $this->arPriceOffer;

                $this->deleteOfferFields();
                    
            }    
        }
    
    }

    protected function deleteOfferFields()
    {
        if(isset($this->arOffer))
            unset($this->arOffer);
                    
        if(isset($this->arPriceOffer))
            unset($this->arPriceOffer);    
    }

    protected function parseOfferGetUniq()
    {
        if(isset($this->settings["offer"]["add_name"]) && !empty($this->settings["offer"]["add_name"]))
        {
            $strV = "";
            $bool = true;
            foreach($this->settings["offer"]["add_name"] as $v)
            {
                if(isset($this->arOffer["PROPERTY_VALUES"][$v]))
                {
                    
                    if(is_array($this->arOffer["PROPERTY_VALUES"][$v]))
                    {
                        
                        foreach($this->arOffer["PROPERTY_VALUES"][$v] as $val)
                        {
                            if($bool) $strV .= $val;
                            else $strV .= " / ".$val;
                            $bool = false;
                        }
                    }else{
                        $val = $this->arOffer["PROPERTY_VALUES"][$v];
                        if($bool) $strV .= $val;
                        else $strV .= " / ".$val;
                        $bool = false;   
                    }
                }
            }
            
            if(!isset($this->arOffer["NAME"]))
                $this->arOffer["NAME"] = "";
            if($strV)
                $strV =  " (".$strV.")";
            $this->arOffer["NAME"] .= $strV;
            

            if(!$this->arOffer["NAME"])
            {
                $this->errors[] = GetMessage("parser_error_name_notfound_offer");
                return false;    
            }
        }
        if($this->arOffer["NAME"])
        {
            $this->arOffer["XML_ID"] = "offer#".md5($this->arFields["LINK"].$this->arOffer["NAME"]);
        }
        return true;    
    }
    
    protected function parserHeadTableOffer($el)
    {
        if(isset($this->settings["offer"]["selector"]) && $this->settings["offer"]["selector"] && isset($this->settings["offer"]["selector_head"]) && $this->settings["offer"]["selector_head"] && isset($this->settings["offer"]["selector_head_th"]) && $this->settings["offer"]["selector_head_th"])
        {
            $offerHead = $this->settings["offer"]["selector"]." ".$this->settings["offer"]["selector_head"]." ".$this->settings["offer"]["selector_head_th"];
            $i = 0;
            foreach(pq($el)->find($offerHead) as $head)
            {
                $textHead = trim(strip_tags(pq($head)->html()));    
                
                $this->tableHeaderNumber[$textHead] = $i;
                $i++;
            }
        }
    }
    
    protected function parseOfferName($offer)
    {
        if(isset($this->settings["offer"]["selector_name"]) && $this->settings["offer"]["selector_name"])
        {
            
            $arr = $this->GetArraySrcAttr($this->settings["offer"]["selector_name"]);
            if (empty($arr["path"]) && !empty($arr["attr"]))
            {
                $name = trim(pq($offer)->attr($arr["attr"]));
            }
            else{
                if(empty($arr["attr"])){
                    $name = trim(strip_tags(pq($offer)->find($arr["path"])->html()));
                }
                elseif(!empty($arr["attr"]))
                {
                    $name = trim(pq($offer)->find($arr["path"])->attr($arr["attr"]));
                }
            } 
             
            $deleteSymb = $this->getOfferDeleteSelector();
            $name = str_replace($deleteSymb, "", $name);
            $this->arOffer["NAME"] = htmlspecialchars_decode($name);
            if(isset($this->settings["loc"]["f_name"]) && $this->settings["loc"]["f_name"]=="Y")
            {
                $this->arOffer["NAME"] = $this->locText($this->arOffer["NAME"]);    
            }   
        }elseif(isset($this->settings["offer"]["find_name"]) && $this->settings["offer"]["find_name"])
        {
            if(isset($this->settings["offer"]["selector_item_td"]) && $this->settings["offer"]["selector_item_td"])
            {
                $deleteSymb = $this->getOfferDeleteFind();
                $name = $this->settings["offer"]["find_name"];
                
                if(isset($this->tableHeaderNumber[$name]))
                {
                    $n = $this->tableHeaderNumber[$name];
                    $name = pq($offer)->find($this->settings["offer"]["selector_item_td"].":eq(".$n.")");
                    $this->arOffer["NAME"] = htmlspecialchars_decode(trim(strip_tags($name)));
                    $this->arOffer["NAME"] = str_replace($deleteSymb, "", $this->arOffer["NAME"]);
                    if(isset($this->settings["loc"]["f_name"]) && $this->settings["loc"]["f_name"]=="Y")
                    {
                        $this->arOffer["NAME"] = $this->locText($this->arOffer["NAME"]);
                    }
                    
                }
            }        
        }
        if(!isset($this->arOffer["NAME"]) && (!isset($this->settings["offer"]["add_name"]) || empty($this->settings["offer"]["add_name"])))
        {
            $this->errors[] = GetMessage("parser_error_name_notfound_offer");
            return false;
        }elseif(!isset($this->arOffer["NAME"]))
            $this->arOffer["NAME"] = $this->arFields["NAME"];     
        
        
        return true;
    }
    
    protected function getOfferDeleteSelector()
    {
        $deleteSymb = array();
        if($this->settings["offer"]["catalog_delete_selector_props_symb"])
        {
            $deleteSymb = explode("||", $this->settings["offer"]["catalog_delete_selector_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if(preg_match("/^\//", $symb) && preg_match("/\/$/", $symb))
                {
                    unset($deleteSymb[$i]);
                    continue;    
                }
            }
            
        }

        return $deleteSymb;
    }
    
    protected function getOfferDeleteSelectorRegular()
    {
        $deleteSymb = array();
        if($this->settings["offer"]["catalog_delete_selector_props_symb"])
        {
            $deleteSymb = explode("||", $this->settings["offer"]["catalog_delete_selector_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                
                if(!preg_match("/^\//", $symb) || !preg_match("/\/$/", $symb))
                {
                    unset($deleteSymb[$i]);
                    continue;    
                }
            }
            
        }

        return $deleteSymb;
    }

    protected function getOfferDeleteFind()
    {
        $deleteSymb = array();
        
        if($this->settings["offer"]["catalog_delete_selector_find_props_symb"])
        {
            $deleteSymb = explode("||", $this->settings["offer"]["catalog_delete_selector_find_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                
                if(preg_match("/^\//", $symb) && preg_match("/\/$/", $symb))
                {
                    unset($deleteSymb[$i]);
                    continue;    
                }
            }

        }
        
        return $deleteSymb;
    }
    
    protected function getOfferDeleteFindRegular()
    {
        $deleteSymb = array();
        if($this->settings["offer"]["catalog_delete_selector_find_props_symb"])
        {
            $deleteSymb = explode("||", $this->settings["offer"]["catalog_delete_selector_find_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                
                if(!preg_match("/^\//", $symb) || !preg_match("/\/$/", $symb))
                {
                    unset($deleteSymb[$i]);
                    continue;    
                }
            }

        }
        
        return $deleteSymb;
    }
    
    protected function parseOfferPrice($offer)
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"])) return false;
        if(isset($this->settings["offer"]["selector_price"]) && $this->settings["offer"]["selector_price"])
        {   
            $arr = $this->GetArraySrcAttr($this->settings["offer"]["selector_price"]);
            if (empty($arr["path"]) && !empty($arr["attr"]))
            {
                $price = trim(pq($offer)->attr($arr["attr"]));
            }
            else{
                if(empty($arr["attr"])){
                    $price = trim(strip_tags(pq($offer)->find($arr["path"])->html()));
                }
                elseif (!empty($arr["attr"]))
                {
                    $price = trim(pq($offer)->find($arr["path"])->attr($arr["attr"]));
                }
            }
            $price = $this->parseCatalogPriceFormat($price);
            //$price = $this->parseCatalogPriceOkrug($price);
            $this->arPriceOffer["PRICE"] = $price;
            $this->arPriceOffer["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
            $this->arPriceOffer["CURRENCY"] = $this->settings["catalog"]["currency"];
               
        }elseif(isset($this->settings["offer"]["find_price"]) && $this->settings["offer"]["find_price"])
        {
            if(isset($this->settings["offer"]["selector_item_td"]) && $this->settings["offer"]["selector_item_td"])
            {
                $name = $this->settings["offer"]["find_price"];
                if(isset($this->tableHeaderNumber[$name]))
                {
                    $n = $this->tableHeaderNumber[$name];
                    $price = pq($offer)->find($this->settings["offer"]["selector_item_td"].":eq(".$n.")");
                    $price = trim(strip_tags($price));
                    $price = $this->parseCatalogPriceFormat($price);
                    //$price = $this->parseCatalogPriceOkrug($price);
                    $this->arPriceOffer["PRICE"] = $price;
                    $this->arPriceOffer["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
                    $this->arPriceOffer["CURRENCY"] = $this->settings["catalog"]["currency"];
                }
            }        
        }elseif(isset($this->settings["offer"]["one"]["price"]) && $this->settings["offer"]["one"]["price"])
        {
            $attr = $this->settings["offer"]["one"]["price"];
            $price = pq($offer)->attr($attr);
            $price = trim(strip_tags($price));
            $this->arPriceOffer["PRICE"] = $price;
            $this->arPriceOffer["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
            $this->arPriceOffer["CURRENCY"] = $this->settings["catalog"]["currency"];
        }
        
        if(isset($this->arPrice["PRICE"]) && !empty($this->arPrice["PRICE"]) && (!isset($this->arPriceOffer["PRICE"]) || empty($this->arPriceOffer["PRICE"])))
        {
             $this->arPriceOffer["PRICE"] = $this->arPrice["PRICE"];
             $this->arPriceOffer["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
             $this->arPriceOffer["CURRENCY"] = $this->settings["catalog"]["currency"];    
        }
        
        if(!isset($this->arPriceOffer["PRICE"]))
        {
            $this->errors[] = GetMessage("parser_error_name_notfound_offer");
            return false;
        }
        return true;        
    }
    
    protected function parseOfferProps($offer, $nameOffer=false)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        if(isset($this->settings["offer"]["selector_prop"]) && !empty($this->settings["offer"]["find_prop"]))
        {
            $deleteSymb = $this->getOfferDeleteSelector();
            $deleteSymbRegular = $this->getOfferDeleteSelectorRegular();
            
            $arProperties = $this->arSelectorPropertiesOffer;
            
            foreach($arProperties as $code=>$val)
            {
                $arProp = $this->arPropertiesOffer[$code];
                if($arProp["PROPERTY_TYPE"]=="F")
                {
                    $this->parseCatalogPropFile($code, $offer);
                }else{
                    
                    $arr = $this->GetArraySrcAttr($this->settings["offer"]["selector_prop"][$code]);
                    if (empty($arr["path"]) && !empty($arr["attr"]))
                    {
                        $text = trim(pq($offer)->attr($arr["attr"]));
                    }
                    else{
                        if(empty($arr["attr"])){
                            $text = trim(strip_tags(pq($offer)->find($arr["path"])->html()));
                        }
                        elseif (!empty($arr["attr"]))
                        {
                            $text = trim(pq($offer)->find($arr["path"])->attr($arr["attr"]));
                        }
                    }
                    
                    if($arProp["USER_TYPE"]!="HTML")
                        $text = strip_tags($text);
                    $text = str_replace($deleteSymb, "", $text);
                    $text = preg_replace($deleteSymbRegular, "", $text);
                    $this->parseCatalogPropOffer($code, $val, $text);
                }

            }
                
        }
        if(isset($this->settings["offer"]["find_prop"]) && !empty($this->settings["offer"]["find_prop"]))
        {
            $deleteSymb = $this->getOfferDeleteFind();
            $deleteSymbRegular = $this->getOfferDeleteFindRegular();
            
            $arProperties = $this->arFindPropertiesOffer; 
            foreach($arProperties as $code=>$val)
            {
                $arProp = $this->arPropertiesOffer[$code];
                if(isset($this->tableHeaderNumber[$val]))
                {
                    $n = $this->tableHeaderNumber[$val];
                    $text = pq($offer)->find($this->settings["offer"]["selector_item_td"].":eq(".$n.")");
                    $text = str_replace($deleteSymb, "", $text);
                    $text = preg_replace($deleteSymbRegular, "", $text);
                    
                    $text1 = $text; 
                    if($arProp["USER_TYPE"]!="HTML")
                        $text1 = strip_tags($text);
                    if($this->CheckFindPropsOffer($code, $val, $text1))
                    {   
                        $this->parseCatalogPropOffer($code, $val, $text1);
                    }   
                }    
            }
        }
        
        if(isset($this->settings["offer"]["one"]["selector"]) && !empty($this->settings["offer"]["one"]["selector"]) && isset($this->settings["offer"]["add_name"]) && !empty($this->settings["offer"]["add_name"])) 
        {
            $arProperties = $this->settings["offer"]["add_name"];
            $deleteSymb = $this->getOfferDeleteSelector();
            $deleteSymbRegular = $this->getOfferDeleteSelectorRegular();
            foreach($arProperties as $code)
            {
                if($nameOffer === false)
                {
                    $text = pq($offer)->html();
                }
                elseif($nameOffer !== false)
                {
                    $text = $nameOffer;
                }
                $text = str_replace($deleteSymb, "", $text); 
                $text = preg_replace($deleteSymbRegular, "", $text);
                $text1 = $text; 
                $text1 = strip_tags($text); 
                $this->parseCatalogPropOffer($code, "", $text1);
                break 1;
            }    
        }      
    }

    protected function parseCatalogProperties(&$el)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $this->parseCatalogDefaultProperties($el);
        $this->parseCatalogSelectorProperties($el);
        $this->parseCatalogFindProperties($el);
        $this->AllDoProps();
        if($this->isCatalog)$this->parseCatalogFindProduct($el);
        if($this->isCatalog)$this->parseCatalogSelectorProduct($el);
    }

    protected function parseCatalogPropertiesPreview(&$el)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $this->parseCatalogSelectorPropertiesPreview($el);
        $this->parseCatalogFindPropertiesPreview($el);
        //$this->AllDoProps();
    }
    


    protected function AllDoProps()
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"])) return false;
        $isElement = $this->checkUniq();
        if($isElement)
        {
            $obElement = new CIBlockElement;
            $rsProperties = $obElement->GetProperty($this->iblock_id, $isElement, "sort", "asc");
            while($arProperty = $rsProperties->Fetch())
            {

                if(isset($this->arFields["PROPERTY_VALUES"][$arProperty["CODE"]]) || $arProperty["PROPERTY_TYPE"]=="F") continue;
                $this->arFields["PROPERTY_VALUES"][$arProperty["ID"]][$arProperty['PROPERTY_VALUE_ID']] = array(
                    "VALUE"=>$arProperty['VALUE'],
                    "DESCRIPTION"=>$arProperty["DESCRIPTION"]
                );
            }

        }
    }

    protected function clearFields()
    {
        unset($this->arFields);
        
        if($this->arProduct)
            unset($this->arProduct);
        if(isset($this->arPrice))
            unset($this->arPrice);
        unset($this->elementUpdate);
        if(isset($this->elementOfferUpdate))
            unset($this->elementOfferUpdate);
        unset($this->elementID);
        unset($this->detailHtml);
        unset($this->arEmptyUpdate);
        if(isset($this->arPhoto))
            unset($this->arPhoto);
        if(isset($this->arOfferAll))
            unset($this->arOfferAll);
        if(isset($this->elementName))
            unset($this->elementName);
        $this->SaveLog();
        //if($this->settings["catalog"]["mode"]!="debug")
         
        unset($this->errors); 
    }
    
    protected function clearHtml()
    {
        unset($this->html);
    }

    protected function getCodeElement($name)
    {
        $arFieldCode = $this->arrayIblock["FIELDS"]["CODE"]["DEFAULT_VALUE"];
        $CODE = CUtil::translit($name, "ru", array(
            "max_len" => $arFieldCode["TRANS_LEN"],
            "change_case" => $arFieldCode["TRANS_CASE"],
            "replace_space" => $arFieldCode["TRANS_SPACE"],
            "replace_other" => $arFieldCode["TRANS_OTHER"],
            "delete_repeat_replace" => $arFieldCode["TRANS_EAT"]=="Y"?true:false,
        ));
        
        $IBLOCK_ID = $this->arrayIblock['ID'];

        $arCodes = array();
        $rsCodeLike = CIBlockElement::GetList(array(), array(
                "IBLOCK_ID" => $IBLOCK_ID,
                "CODE" => $CODE."%",
        ), false, false, array("ID", "CODE"));
        while($ar = $rsCodeLike->Fetch())
            $arCodes[$ar["CODE"]] = $ar["ID"];

        if (array_key_exists($CODE, $arCodes))
        {
            $i = 1;
            while(array_key_exists($CODE."_".$i, $arCodes))
                $i++;

            return $CODE."_".$i;
        }
        else
        {
            return $CODE;
        }
    }

    protected function getArrayIblock()
    {
        $arIBlock = CIBlock::GetArrayByID($this->iblock_id);
        $this->arrayIblock = $arIBlock;
    }

    protected function parseCatalogSection()
    {
        if($this->checkUniq()) return false;
        $this->arFields["IBLOCK_SECTION_ID"] = $this->section_id;
    }

    protected function parseCatalogFindProduct(&$el)
    {
        $arProperties = $this->arFindProduct;
        if(!$arProperties) return false;
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        $find = $this->settings["catalog"]["selector_find_size"];
        if($this->settings["catalog"]["catalog_delete_find_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_find_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }

        foreach(pq($el)->find($find) as $prop)
        {
            $text = pq($prop)->html();
            $text = strip_tags($text);
            $text = str_replace($deleteSymb, "", $text);
            foreach($arProperties as $code=>$val)
            {
                //if(preg_match("/".$val."/", $text))
                if(strpos($text, $val)!==false)
                {
                    $text = str_replace($val, "", $text);
                    $text = trim($text);
                    
                    $text =  str_replace(",", ".", $text);
                    $text = preg_replace("/\.{1}$/", "", $text);
                    $text = preg_replace('/[^0-9.]/', "", $text);
                    
                    if(isset($this->settings["catalog"]["find_product_koef"][$code]) && !empty($this->settings["catalog"]["find_product_koef"][$code]))
                    {
                        $text = $text*$this->settings["catalog"]["find_product_koef"][$code];    
                    }
                    
                    $this->arProduct[$code] = $text;
                }
            }

        }
    }

    protected function parseCatalogSelectorProduct(&$el)
    {
        $arProperties = $this->arSelectorProduct;
        if(!$arProperties) return false;
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["param"])) return false;
        if($this->settings["catalog"]["catalog_delete_selector_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }
            }
        }

        foreach($arProperties as $code=>$val)
        {
            $text = pq($el)->find($this->settings["catalog"]["selector_product"][$code])->html();
            $text = strip_tags($text);
            $text = str_replace($deleteSymb, "", $text);
            $text = trim($text);
            
            $text =  str_replace(",", ".", $text);
            $text = preg_replace("/\.{1}$/", "", $text);
            $text = preg_replace('/[^0-9.]/', "", $text);
            
            if(isset($this->settings["catalog"]["selector_product_koef"][$code]) && !empty($this->settings["catalog"]["selector_product_koef"][$code]))
            {
                $text = $text*$this->settings["catalog"]["selector_product_koef"][$code];    
            }
            
            $this->arProduct[$code] = $text;
        }
    }

    protected function parseCatalogSelectorProperties(&$el)
    {
        $arProperties = $this->arSelectorProperties;
        if(!$arProperties) return false;
        if($this->settings["catalog"]["catalog_delete_selector_props_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }

        foreach($arProperties as $code=>$val)
        {
            $arProp = $this->arProperties[$code];
            if($arProp["PROPERTY_TYPE"]=="F")
            {
                $this->parseCatalogPropFile($code, $el);
            }else{
                $ar = $this->GetArraySrcAttr($this->settings["catalog"]["selector_prop"][$code]);
                $path = $ar["path"];
                $attr = $ar["attr"];
                if($attr)
                    $text = pq($el)->find($path)->attr($attr);
                else
                    $text = pq($el)->find($this->settings["catalog"]["selector_prop"][$code])->html();

                if($arProp["USER_TYPE"]!="HTML")
                    $text = strip_tags($text);
                $text = str_replace($deleteSymb, "", $text);
                $this->parseCatalogProp($code, $val, $text);
            }

        }
    }

    protected function parseCatalogSelectorPropertiesPreview(&$el)
    {
        $arProperties = $this->arSelectorPropertiesPreview;
        if(!$arProperties) return false;
        if($this->settings["catalog"]["catalog_delete_selector_props_symb_preview"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_props_symb_preview"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }
 
        foreach($arProperties as $code=>$val)
        {
            /*$text = pq($el)->find($this->settings["catalog"]["selector_prop_preview"][$code])->html();
            
            $arProp = $this->arProperties[$code];
            if($arProp["USER_TYPE"]!="HTML")
                $text = strip_tags($text);
            $text = str_replace($deleteSymb, "", $text);
            $this->parseCatalogProp($code, $val, $text);*/
            
            $arProp = $this->arProperties[$code];
            if($arProp["PROPERTY_TYPE"]=="F")
            {
                $this->parseCatalogPropFilePreview($code, $el);
            }else{
                $ar = $this->GetArraySrcAttr($this->settings["catalog"]["selector_prop_preview"][$code]);
                $path = $ar["path"];
                $attr = $ar["attr"];
                if($attr)
                    $text = pq($el)->find($path)->attr($attr);
                else
                    $text = pq($el)->find($this->settings["catalog"]["selector_prop_preview"][$code])->html();

                if($arProp["USER_TYPE"]!="HTML")
                    $text = strip_tags($text);
                $text = str_replace($deleteSymb, "", $text);
                $this->parseCatalogProp($code, $val, $text);
            }

        }
    }

    protected function parseCatalogFindProperties(&$el)
    {   
        $arProperties = $this->arFindProperties;
        if(!$arProperties) return false;
        $find = $this->settings["catalog"]["selector_find_props"];
        if($this->settings["catalog"]["catalog_delete_selector_find_props_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_find_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);  
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }
        $arFind = explode(",", $find);
        foreach($arFind as $vFind)
        {
            if(strpos($vFind, " br")!==false || strpos($vFind, "<br/>") || strpos($vFind, "<br />"))
            {
                $vFind = str_replace(array(" br", "<br/>", "<br />"), "", $vFind);
                $vFind = trim($vFind);
                $arBr = array("<br>", "<br/>", "<br />");
                
                foreach(pq($el)->find($vFind) as $prop)
                {
                    $text = pq($prop)->html();
                    $text = str_replace($arBr, "<br>", $text);
                    unset($arBr[1]);
                    unset($arBr[2]);
                    foreach($arBr as $br)
                    {
                        $arTextBr = explode($br, $text);
                        if(!empty($arTextBr) && count($arTextBr)>1)
                        {
                            foreach($arTextBr as $textBr)
                            {   
                                $textBr = strip_tags($textBr);
                                $textBr = str_replace($deleteSymb, "", $textBr); 
                                foreach($arProperties as $code=>$val)
                                {
                                    //if(preg_match("/".$val."/", $textBr))
                                    if($this->CheckFindProps($code, $val, $textBr))
                                    {
                                        $this->parseCatalogProp($code, $val, $textBr);
                                    }    
                                }
                                
                            }      
                        }
                    }
                    
                }
            }else
            {   
                foreach(pq($el)->find($vFind) as $prop)
                {
                    $text = pq($prop)->html();
                    //$text = strip_tags($text);
                    $text = str_replace($deleteSymb, "", $text);
                    $text1 = $text;

                    foreach($arProperties as $code=>$val)
                    {
                        //if(preg_match("/".$val."/", $text))
                        $text1 = $text;
                        $arProp = $this->arProperties[$code];
                        if($arProp["USER_TYPE"]!="HTML")
                            $text1 = strip_tags($text);
                        
                        if($this->CheckFindProps($code, $val, $text1))
                        {   
                            $this->parseCatalogProp($code, $val, $text1);
                        }
                    }
                }
            }
        }
    }

    protected function parseCatalogFindPropertiesPreview(&$el)
    {   
        $arProperties = $this->arFindPropertiesPreview;
        if(!$arProperties) return false;
        $find = $this->settings["catalog"]["selector_find_props_preview"];
        if($this->settings["catalog"]["catalog_delete_selector_find_props_symb_preview"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_find_props_symb_preview"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);  
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }
        $arFind = explode(",", $find);
        foreach($arFind as $vFind)
        {
            if(strpos($vFind, " br")!==false || strpos($vFind, "<br/>") || strpos($vFind, "<br />"))
            {
                $vFind = str_replace(array(" br", "<br/>", "<br />"), "", $vFind);
                $vFind = trim($vFind);
                $arBr = array("<br>", "<br/>", "<br />");
                
                foreach(pq($el)->find($vFind) as $prop)
                {
                    $text = pq($prop)->html();
                    $text = str_replace($arBr, "<br>", $text);
                    unset($arBr[1]);
                    unset($arBr[2]);
                    foreach($arBr as $br)
                    {
                        $arTextBr = explode($br, $text);
                        if(!empty($arTextBr) && count($arTextBr)>1)
                        {
                            foreach($arTextBr as $textBr)
                            {   
                                $textBr = strip_tags($textBr);
                                $textBr = str_replace($deleteSymb, "", $textBr); 
                                foreach($arProperties as $code=>$val)
                                {
                                    //if(preg_match("/".$val."/", $textBr))
                                    if($this->CheckFindPropsPreview($code, $val, $textBr))
                                    {
                                        $this->parseCatalogProp($code, $val, $textBr);
                                    }    
                                }
                                
                            }      
                        }
                    }
                    
                }
            }else
            {
                foreach(pq($el)->find($vFind) as $prop)
                {   
                    $text = pq($prop)->html();
                    //$text = strip_tags($text);
                    $text = str_replace($deleteSymb, "", $text);
                    $text1 = $text;
                    foreach($arProperties as $code=>$val)
                    {
                        //if(preg_match("/".$val."/", $text))
                        $text1 = $text;
                        $arProp = $this->arProperties[$code];
                        if($arProp["USER_TYPE"]!="HTML")
                            $text1 = strip_tags($text);
                        if($this->CheckFindPropsPreview($code, $val, $text1))
                        {   
                            $this->parseCatalogProp($code, $val, $text1);
                        }
                    }

                }    
            }    
        }
    }
    
    protected function parseCatalogDefaultProperties(&$el)
    {
        if(isset($this->settings["catalog"]["default_prop"]) && !empty($this->settings["catalog"]["default_prop"]))
        {
            foreach($this->settings["catalog"]["default_prop"] as $code=>$val)
            {
                if($val)$this->parseCatalogDefaultProp($code, $val);
            }
        }    
    }
    
    protected function CheckFindProps($code, $val, $text)
    {
        $arDubleProperties = $this->arDubleFindProperties;
        $bool = false;
        if(isset($arDubleProperties[$code]))
        {   
            foreach($arDubleProperties[$code] as $prop)
            {
                $v = $this->arFindProperties[$prop];
                //if(preg_match("/".$v."/", $text))
                if(strpos($text, $v)!==false)
                {
                    $bool  = true;    
                }
            }
            if($bool) return false;
        }
        
        //if(preg_match("/".$val."/", $text)) return true;
        if(strpos($text, $val)!==false) return true;
        else return false;
    }
    
    protected function CheckFindPropsOffer($code, $val, $text)
    {
        $arDubleProperties = $this->arDubleFindPropertiesOffer;
        $bool = false;
        if(isset($arDubleProperties[$code]))
        {   
            foreach($arDubleProperties[$code] as $prop)
            {
                $v = $this->arFindPropertiesOffer[$prop];
                //if(preg_match("/".$v."/", $text))
                if(strpos($text, $v)!==false)
                {
                    $bool  = true;
                }    
            }
            if($bool) return false;
        }
        
        return true;
    }
    
    protected function CheckFindPropsPreview($code, $val, $text)
    {
        $arDubleProperties = $this->arDubleFindPropertiesPreview;
        $bool = false;
        if(isset($arDubleProperties[$code]))
        {   
            foreach($arDubleProperties[$code] as $prop)
            {
                $v = $this->arFindPropertiesPreview[$prop];
                //if(preg_match("/".$v."/", $text))
                if(strpos($text, $v)!==false)
                {
                    $bool  = true;
                }    
            }
            if($bool) return false;
        }
        //if(preg_match("/".$val."/", $text)) return true;
        if(strpos($text, $val)!==false) return true;
        else return false;
    }

    protected function parseCatalogMeta()
    {
        if($this->checkUniq()) return false;
        if($this->meta_description!="N" || $this->meta_keywords!="N")
        {
            foreach($this->detailHtml["meta"] as $meta)
            {
                if($this->meta_description!="N" && strtolower(pq($meta)->attr("name"))=="description")
                {
                    $meta_text = pq($meta)->attr("content");
                    if(!$meta_text)$meta_text = pq($meta)->attr("value");
                    if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                        $meta_text = mb_convert_encoding($meta_text, LANG_CHARSET, "utf-8");
                    }
                    $this->arFields["PROPERTY_VALUES"][$this->meta_description] = strip_tags($meta_text);
                }elseif($this->meta_keywords!="N" && strtolower(pq($meta)->attr("name"))=="keywords")
                {
                    $meta_text = pq($meta)->attr("content");
                    if(!$meta_text)$meta_text = pq($meta)->attr("value");
                    if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                        $meta_text = mb_convert_encoding($meta_text, LANG_CHARSET, "utf-8");
                    }
                    $this->arFields["PROPERTY_VALUES"][$this->meta_keywords] = strip_tags($meta_text);
                }
                unset($meta_text);
            }
        }

        if($this->meta_title!="N")
        {
            $meta_title = pq($this->detailHtml["head:eq(0) title:eq(0)"])->text();
            $meta_title = strip_tags($meta_title);
            if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                $meta_title = mb_convert_encoding($meta_title, LANG_CHARSET, "utf-8");
            }
            $this->arFields["PROPERTY_VALUES"][$this->meta_title] = $meta_title;
        }

    }

    protected function parseCatalogFirstUrl()
    {
        if($this->checkUniq()) return false;
        if($this->first_title!="N")
        {
            $this->arFields["PROPERTY_VALUES"][$this->first_title] = $this->arFields["LINK"];
        }
    }

    protected function parseCatalogDate()
    {

    }

    protected function parseCatalogPropFile($code, $el)
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"])) return false;
        /*$ar = $this->GetArraySrcAttr($this->settings["catalog"]["selector_prop"][$code]);
        $file = $ar["path"];
        $attr = $ar["attr"];*/
        $n = 0;

        $isElement = $this->checkUniq();

        foreach(pq($el)->find($file) as $f)
        {
            /*if(!empty($attr)) 
            {
                $src = pq($f)->attr($attr);
            }
            elseif(empty($attr)) 
            {
                $src = pq($f)->html();
                $src = strip_tags(pq($f)->html());
            }*/
            $descr = strip_tags(pq($f)->html());
            $src = $this->parseCaralogFilterSrc($src);
            $src = $this->getCatalogLink($src);
            $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["VALUE"] = CFile::MakeFileArray($src);
            $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["DESCRIPTION"] = $descr;
            $n++;
        }
        if($isElement)
        {
            $arFiles = $this->arFields["PROPERTY_VALUES"][$code];
            unset($this->arFields["PROPERTY_VALUES"][$code]);
            $obElement = new CIBlockElement;
            $rsProperties = $obElement->GetProperty($this->iblock_id, $isElement, "sort", "asc",  Array("CODE"=>$code));
            while($arProperty = $rsProperties->Fetch())
            {
                $arFiles[$arProperty["PROPERTY_VALUE_ID"]] = array(
                        "tmp_name" => "",
                        "del" => "Y",
                );
            }
            CIBlockElement::SetPropertyValueCode($isElement, $code, $arFiles);
            unset($obElement);
        }
    }
    
    protected function parseCatalogPropFilePreview($code, $el)
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"])) return false;
        $ar = $this->GetArraySrcAttr($this->settings["catalog"]["selector_prop_preview"][$code]);
        $file = $ar["path"];
        $attr = $ar["attr"];
        $n = 0;

        $isElement = $this->checkUniq();

        foreach(pq($el)->find($file) as $f)
        {
            $src = pq($f)->attr($attr);
            $descr = strip_tags(pq($f)->html());
            $src = $this->parseCaralogFilterSrc($src);
            $src = $this->getCatalogLink($src);
            $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["VALUE"] = CFile::MakeFileArray($src);
            $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["DESCRIPTION"] = $descr;
            $n++;
        }
        
        if($isElement)
        {
            $arFiles = $this->arFields["PROPERTY_VALUES"][$code];
            unset($this->arFields["PROPERTY_VALUES"][$code]);
            $obElement = new CIBlockElement;
            $rsProperties = $obElement->GetProperty($this->iblock_id, $isElement, "sort", "asc",  Array("CODE"=>$code));
            while($arProperty = $rsProperties->Fetch())
            {
                $arFiles[$arProperty["PROPERTY_VALUE_ID"]] = array(
                        "tmp_name" => "",
                        "del" => "Y",
                );
            }
            CIBlockElement::SetPropertyValueCode($isElement, $code, $arFiles);
            unset($obElement);
        }
    }

    public function parseCatalogProp($code, $val, $text)
    {
        //$text = str_replace($val, "", $text);
        
        $val = preg_quote($val, "/");
        $text = preg_replace("/(".$val.")/", "", $text, 1);
        
        $val = trim($text);
        
        if(empty($val)) return false;
        $val = html_entity_decode($val);
        $arProp = $this->arProperties[$code];
        //$default = $this->settings["catalog"]["default_prop"][$code];
        
        if($arProp["PROPERTY_TYPE"]!="N" && isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"])
            $val = $this->locText($val, $arProp["USER_TYPE"]=="HTML"?"html":"plain");
        
        if($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }elseif($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsDirectory($arProp, $code, $val);;
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsDirectory($arProp, $code, $val);;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y")
        {
            $val = $this->actionFieldProps($code, $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y")
        {
            $val = $this->actionFieldProps($code, $val);
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;
        }
        elseif($arProp["PROPERTY_TYPE"]=="N")
        {
            $val =  str_replace(",", ".", $val);
            $val = preg_replace("/\.{1}$/", "", $val);
            $val = preg_replace('/[^0-9.]/', "", $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;    

        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsL($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsL($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]!="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsE($arProp, $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]=="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsE($arProp, $code, $val);
        }
    }

    public function parseCatalogPropOffer($code, $val, $text)
    {
        //$text = str_replace($val, "", $text);
        
        $val = preg_quote($val, "/");
        $text = preg_replace("/(".$val.")/", "", $text, 1);
        
        $val = trim($text);
        
        if(empty($val)) return false;
        $val = html_entity_decode($val);
        $arProp = $this->arPropertiesOffer[$code];
        
        if($arProp["PROPERTY_TYPE"]!="N" && isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"])
            $val = $this->locText($val, $arProp["USER_TYPE"]=="HTML"?"html":"plain");
        
        //$default = $this->settings["catalog"]["default_prop"][$code];
        if($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }elseif($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code]["n0"] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arOffer["PROPERTY_VALUES"][$code] = $this->CheckPropsDirectory($arProp, $code, $val);;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arOffer["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsDirectory($arProp, $code, $val);;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code]["n0"] = $val;
        }
        elseif($arProp["PROPERTY_TYPE"]=="N")
        {
            $val =  str_replace(",", ".", $val);
            $val = preg_replace("/\.{1}$/", "", $val);
            $val = preg_replace('/[^0-9.]/', "", $val);
            $this->arOffer["PROPERTY_VALUES"][$code] = $val;    
            
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code] = $this->CheckPropsLOffer($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arOffer["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsLOffer($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]!="Y")
        {   
            $this->arOffer["PROPERTY_VALUES"][$code] = $this->CheckPropsE($arProp, $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]=="Y")
        {   
            $this->arOffer["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsE($arProp, $code, $val);
        }
    }
    
    public function parseCatalogDefaultProp($code, $val)
    {
        $val = trim($val);
        $arProp = $this->arProperties[$code];
        if(empty($val)) return false;
        if($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $val;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="N")
        {
            $val =  str_replace(",", ".", $val);
            $val = preg_replace("/\.{1}$/", "", $val);
            $val = preg_replace('/[^0-9.]/', "", $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;    

        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]!="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsE($arProp, $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]=="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsE($arProp, $code, $val);
        }
    }

    public function CheckPropsDirectory($arProp, $code, $val)
    {
        $element_xml_id = Cutil::translit($val, 'ru', array('change_case' => 'U'));
        $element_xml_id = self::GetCleanCode($element_xml_id);
        
        $this->getDirectoryValues($arProp);
        $nameTable = $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"];
        if(!empty($this->arDirectory[$nameTable]))
        {
            if(isset($this->arDirectory[$nameTable][$element_xml_id]) && $this->arDirectory[$nameTable][$element_xml_id])
            {
                return  $element_xml_id;
            }else{
                $hlblock = Bitrix\Highloadblock\HighloadBlockTable::getList(array(
                    "filter" => array(
                    "TABLE_NAME" => $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"],
                )))->fetch();
                $arFields = array(
                        "UF_XML_ID" => $element_xml_id,
                        "UF_NAME" => $val,
                );
                $entity = Bitrix\Highloadblock\HighloadBlockTable::compileEntity($hlblock);
                $entity_data_class = $entity->getDataClass();
                $entity_data_class::add($arFields);
                return $element_xml_id;    
            }    
        }
    }
    
    public function GetCleanCode($code) {

        if(is_numeric($code[0])) {
            $code = 'N'.$code;
        }

        return $code;
    }
    
    public function getDirectoryValues($arProp)
    {
        $nameTable = $arProp["USER_TYPE_SETTINGS"]["TABLE_NAME"];
        if(isset($this->arDirectory[$nameTable])) return false;
        $directorySelect = array("*");
        $directoryOrder = array();
        $entityGetList = array(
            'select' => $directorySelect,
            'order' => $directoryOrder
        );
        $arProperty = array();
        $highBlock = \Bitrix\Highloadblock\HighloadBlockTable::getList(array("filter" => array('TABLE_NAME' => $nameTable)))->fetch();
        $entity = \Bitrix\Highloadblock\HighloadBlockTable::compileEntity($highBlock);
        $entityDataClass = $entity->getDataClass();
        $propEnums = $entityDataClass::getList($entityGetList);
        $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE"][] = GetMessage("parser_prop_default");
        $arrPropDop["LIST_VALUES"][$arProp["CODE"]]["REFERENCE_ID"][] = "";
        while ($oneEnum = $propEnums->fetch())
        {
            $arProperty[$oneEnum["UF_XML_ID"]] = $oneEnum["UF_XML_ID"];
        } 
        $this->arDirectory[$nameTable] = $arProperty;
    }
    
    public function CheckPropsE($arProp, $code, $val)
    {
        $IBLOCK_ID = $arProp["LINK_IBLOCK_ID"];

        $rsProp = CIBlockElement::GetList(Array(), array("IBLOCK_ID"=>$IBLOCK_ID, "%NAME"=>$val), false, false, array("ID", "NAME"));
        while($arIsProp = $rsProp->Fetch())
        {
            $arIsProp["NAME"] = mb_strtolower($arIsProp["NAME"], LANG_CHARSET); 
            $val0 = mb_strtolower($val, LANG_CHARSET);
            if($val0==$arIsProp["NAME"])
            {
                $isProp = $arIsProp["ID"];
            }
        }
        
        if($isProp) return $isProp;
        else{
            $codeText = CUtil::translit($val, "ru", array(
                        "max_len" => 100,
                        "change_case" => 'L', // 'L' - toLower, 'U' - toUpper, false - do not change
                        "replace_space" => '_',
                        "replace_other" => '_',
                        "delete_repeat_replace" => true,
            ));
            $arFields = array(
                "NAME"=>$val,
                "ACTIVE" => "Y",
                "IBLOCK_ID" => $IBLOCK_ID,
                "CODE" => $codeText
            );
            $el = new CIBlockElement;
            $id = $el->Add($arFields);
            if(!$id)
            {
                $this->errors[] = GetMessage("error_add_prop_e").$this->arFields["NAME"]."[".$this->arFields["LINK"]."] - ".$el->LAST_ERROR;
            }
            unset($el);
            return $id;
        }
    }

    public function CheckPropsL($id, $code, $val)
    {
        $res2 = CIBlockProperty::GetPropertyEnum(
            $id,
            array(),
            array("IBLOCK_ID" => $this->iblock_id, "VALUE" => $val)
        );

        if ($arRes2 = $res2->Fetch())
        {
            $kz = $arRes2["ID"];
        }
        else
        {
            $tmpid = md5(uniqid(""));
            $kz = CIBlockPropertyEnum::Add(
                array(
                "PROPERTY_ID" => $id,
                "VALUE" => $val,
                "TMP_ID" => $tmpid
            )
            );

        }

        return $kz;
    }
    
    public function CheckPropsLOffer($id, $code, $val)
    {
        $res2 = CIBlockProperty::GetPropertyEnum(
            $id,
            array(),
            array("IBLOCK_ID" => $this->iblockOffer, "VALUE" => $val)
        );

        if ($arRes2 = $res2->Fetch())
        {
            $kz = $arRes2["ID"];
        }
        else
        {
            $tmpid = md5(uniqid(""));
            $kz = CIBlockPropertyEnum::Add(
                array(
                "PROPERTY_ID" => $id,
                "VALUE" => $val,
                "TMP_ID" => $tmpid
            )
            );

        }

        return $kz;
    }

    public function getFindProduct()
    {
        if(isset($this->settings["catalog"]["find_product"]) && !empty($this->settings["catalog"]["find_product"]))foreach($this->settings["catalog"]["find_product"] as $i=>$prop)
        {
            $prop = trim($prop);
            if(!empty($prop))
            {
                $arProps[$i] = $prop;
            }
        }
        if(!$arProps) return false;
        return $arProps;
    }

    public function getSelectorProduct()
    {
        if(isset($this->settings["catalog"]["selector_product"]) && !empty($this->settings["catalog"]["selector_product"]))foreach($this->settings["catalog"]["selector_product"] as $i=>$prop)
        {
            $prop = trim($prop);
            if(!empty($prop))
            {
                $arProps[$i] = $prop;
            }
        }
        if(!$arProps) return false;
        return $arProps;
    }
    
    public function getFindDubleProperties()
    {
        $arFindProps = $this->arFindProperties;
        if(!empty($arFindProps))foreach($arFindProps as $code=>$prop)
        {
            foreach($arFindProps as $code1=>$prop1)
            {
                if(strpos($prop1, $prop)!==false && $code1!=$code && $prop1!=$prop)
                {
                    $arDubleProps[$code][] = $code1;
                }
            }        
        }
        if(isset($arDubleProps)) return $arDubleProps;
        else return false;    
    }

    public function getFindDublePropertiesOffer()
    {
        $arFindProps = $this->arFindPropertiesOffer;
        if(!empty($arFindProps))foreach($arFindProps as $code=>$prop)
        {
            foreach($arFindProps as $code1=>$prop1)
            {
                if(strpos($prop1, $prop)!==false && $code1!=$code && $prop1!=$prop)
                {
                    $arDubleProps[$code][] = $code1;
                }    
            }
        }
        if(isset($arDubleProps)) return $arDubleProps;
        else return false;    
    }
    
    protected function getFindDublePropertiesPreview()
    {
        $arFindProps = $this->arFindPropertiesPreview;
        if(!empty($arFindProps))foreach($arFindProps as $code=>$prop)
        {
            foreach($arFindProps as $code1=>$prop1)
            {
                if(strpos($prop1, $prop)!==false && $code1!=$code && $prop1!=$prop)
                {
                    $arDubleProps[$code][] = $code1;
                }    
            }        
        }
        if(isset($arDubleProps)) return $arDubleProps;
        else return false;    
    }

    protected function getFindProperties()
    {
        if(isset($this->settings["catalog"]["find_prop"]) && !empty($this->settings["catalog"]["find_prop"]))
        {
            foreach($this->settings["catalog"]["find_prop"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!isset($arProps)) return false;
            return $arProps;
        }
        return false;        
    }
    
    protected function getFindPropertiesOffer()
    {
        if(isset($this->settings["offer"]["find_prop"]) && !empty($this->settings["offer"]["find_prop"]))
        {
            foreach($this->settings["offer"]["find_prop"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!isset($arProps)) return false;
            return $arProps;
        }
        return false;        
    }
    
    protected function getFindPropertiesPreview()
    {
        if(isset($this->settings["catalog"]["find_prop_preview"]) && !empty($this->settings["catalog"]["find_prop_preview"]))
        {
            foreach($this->settings["catalog"]["find_prop_preview"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!isset($arProps)) return false;
            return $arProps;
        }
        return false;
        
    }

    protected function getSelectorProperties()
    {
        if(isset($this->settings["catalog"]["selector_prop"]) && !empty($this->settings["catalog"]["selector_prop"]))
        {
            $arProps = false;
            foreach($this->settings["catalog"]["selector_prop"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!$arProps) return false;
            return $arProps;    
        }
        
        return false;

    }
    
    protected function getSelectorPropertiesOffer()
    {
        if(isset($this->settings["offer"]["selector_prop"]) && !empty($this->settings["offer"]["selector_prop"]))
        {
            $arProps = false;
            foreach($this->settings["offer"]["selector_prop"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!$arProps) return false;
            return $arProps;    
        }
        
        return false;
    }
    
    protected function getSelectorPropertiesPreview()
    {
        if(isset($this->settings["catalog"]["selector_prop_preview"]) && !empty($this->settings["catalog"]["selector_prop_preview"]))
        {
            $arProps = false;
            foreach($this->settings["catalog"]["selector_prop_preview"] as $i=>$prop)
            {
                $prop = trim($prop);
                if(!empty($prop))
                {
                    $arProps[$i] = $prop;
                }
            }
            if(!$arProps) return false;
            return $arProps;    
        }
        return false;
    }

    protected function parseCatalogDetailMorePhoto(&$el)
    {
        if($this->settings["catalog"]["more_image_props"])
        {
            if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["more_img"])) return false;
            $code = $this->settings["catalog"]["more_image_props"];
            $ar = $this->GetArraySrcAttr($this->settings["catalog"]["more_image"]);
            $image = $ar["path"];
            $attr = $ar["attr"];
            $n = 0;

            $isElement = $this->checkUniq();
            foreach(pq($el)->find($image) as $img)
            {   
                if(!empty($attr))
                {
                    $src = pq($img)->attr($attr);
                    $src = $this->parseSelectorStyle($attr, $src);
                }
                elseif(empty($attr))
                {
                    $src = strip_tags(pq($img)->html());
                }
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                if(isset($this->arPhoto[$src])) continue 1;
                $this->arPhoto[$src] = 1;
                $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["VALUE"] = CFile::MakeFileArray($src);
                $this->arFields["PROPERTY_VALUES"][$code]["n".$n]["DESCRIPTION"] = "";
                $n++;
            }
            if($isElement)
            {
                $arImages = $this->arFields["PROPERTY_VALUES"][$code];
                unset($this->arFields["PROPERTY_VALUES"][$code]);
                $obElement = new CIBlockElement;
                $rsProperties = $obElement->GetProperty($this->iblock_id, $isElement, "sort", "asc",  Array("CODE"=>$code));
                while($arProperty = $rsProperties->Fetch())
                {
                    $arImages[$arProperty["PROPERTY_VALUE_ID"]] = array(
                        "tmp_name" => "",
                        "del" => "Y",
                    );
                }
                CIBlockElement::SetPropertyValueCode($isElement, $code, $arImages);
                unset($obElement);
            }

        }



    }

    protected function parserCatalogDetailPage()
    {
        $this->catalogSleep();
        $this->detailFileHtml = new FileGetHtml();
        $this->detailPage = $this->fileHtml->file_get_html($this->arFields["LINK"], $this->settings["catalog"]["proxy"], $this->auth, $this);  
        $this->DeleteCharsetHtml5($this->detailPage);
        $this->detailHttpCode = $this->fileHtml->httpCode;
        if($this->detailHttpCode!=200 && $this->detailHttpCode!=301 && $this->detailHttpCode!=302 && $this->detailHttpCode!=303)
        {
            $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."]".GetMessage("parser_error_connect")."[".$this->detailHttpCode."]";
            //return false;
        }
        $this->detailHtml = phpQuery::newDocument($this->detailPage, "text/html;charset=".LANG_CHARSET);
        $this->base = $this->GetMetaBase($this->detailHtml);
        //if($this->detail_delete_element)$this->deleteCatalogElement($this->detail_delete_element, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        //if($this->detail_delete_attribute)$this->deleteCatalogAttribute($this->detail_delete_attribute, $this->detail_dom, $this->detailHtml[$this->detail_dom]);

        foreach($this->detailHtml[$this->detail_dom] as $detail)
        {
            return $detail;
        }
        $this->errors[] = GetMessage("parser_error_selecto_detail_notfound");


    }

    protected function parseCatalogUrlPreview($el)
    {   
        if($this->settings["catalog"]["href"]=="a:parent")
        {
            $p = pq($el)->attr("href");        
        }else{
            $url = $this->settings["catalog"]["href"]?$this->settings["catalog"]["href"]:"a:eq(0)";
            $this->settings["catalog"]["href"] = $url;
            $p = pq($el)->find($url)->attr("href");    
        }
        if(!$p)
        { 
            $this->errors[] = GetMessage("parser_error_href_notfound");
            return false;
        }

        $p = $this->getCatalogLink($p);
        //$this->convetCyrillic($p);
        $this->arFields["LINK"] = $p;
        if(isset($this->pagePrevElement[$p])) return false;
        return true;
    }

    protected function parseCatalogNamePreview($el)
    {
        if(isset($this->settings["catalog"]["detail_name"]) && $this->settings["catalog"]["detail_name"]) return false;
        $name = $this->settings["catalog"]["name"]?$this->settings["catalog"]["name"]:$this->settings["catalog"]["href"];
        $ar = $this->GetArraySrcAttr($name); 
        $img = $ar["path"];
        $attr = $ar["attr"];
        if (empty($attr)){
            $this->arFields["NAME"] = trim(htmlspecialchars_decode(trim(strip_tags(pq($el)->find($img)->html()))));
        }
        elseif (!empty($attr)){
            $this->arFields["NAME"] = trim(htmlspecialchars_decode(trim(strip_tags(pq($el)->find($img)->attr($attr)))));
        }
        
        if($this->arFields["NAME"])
        {
            $this->arFields["NAME"] = $this->actionFieldProps("SOTBIT_PARSER_NAME_E", $this->arFields["NAME"]);
            if(isset($this->settings["loc"]["f_name"]) && $this->settings["loc"]["f_name"]=="Y")
            {
                $this->arFields["NAME"] = $this->locText($this->arFields["NAME"]);    
            }
            
        }
        
        if(!$this->arFields["NAME"])
        {
            $this->errors[] = GetMessage("parser_error_name_notfound");
            return false;
        }
    }
    
    protected function actionFieldProps($code, $val)
    {
        if(isset($this->settings["catalog"]["action_props_val"][$code]) && $this->settings["catalog"]["action_props_val"][$code])
        {
            foreach($this->settings["catalog"]["action_props_val"][$code] as $i=>$v)
            {   
                {   
                    if($this->settings["catalog"]["action_props"][$code][$i]=="") continue 1;
                    if($this->settings["catalog"]["action_props"][$code][$i]=="delete")
                    {
                        $val = str_replace($v, "", $val);    
                    }
                    if($this->settings["catalog"]["action_props"][$code][$i]=="add_b")
                    {
                        $val = $v.$val;    
                    }
                    if($this->settings["catalog"]["action_props"][$code][$i]=="add_e")
                    {
                        $val = $val.$v;    
                    }    
                }
            }
                    
        }
        return trim($val);
    }
    
    protected function parseCatalogNameDetail($el)
    {
        if($this->detail_delete_element)$this->deleteCatalogElement($this->detail_delete_element, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        if($this->detail_delete_attribute)$this->deleteCatalogAttribute($this->detail_delete_attribute, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        
        if(!isset($this->settings["catalog"]["detail_name"]) || !$this->settings["catalog"]["detail_name"]) return false;
        $name = $this->settings["catalog"]["detail_name"];

        $this->arFields["NAME"] = htmlspecialchars_decode(trim(strip_tags(pq($el)->find($name)->html())));
        if($this->arFields["NAME"])
        {
            $this->arFields["NAME"] = $this->actionFieldProps("SOTBIT_PARSER_NAME_E", $this->arFields["NAME"]);
            if(isset($this->settings["loc"]["f_name"]) && $this->settings["loc"]["f_name"]=="Y")
            {
                $this->arFields["NAME"] = $this->locText($this->arFields["NAME"]);
            }
        }
        if(!$this->arFields["NAME"])
        {
            $this->errors[] = GetMessage("parser_error_name_notfound");
            return false;
        }
    }
    
    protected function parseCatalogPriceFormat($price)
    {
        $price = trim($price);
        
        if(isset($this->settings["catalog"]["price_format1"]) && $this->settings["catalog"]["price_format1"] && isset($this->settings["catalog"]["price_format2"]) && $this->settings["catalog"]["price_format2"])
        {
            $price = str_replace($this->settings["catalog"]["price_format1"], "", $price);
            $price = str_replace($this->settings["catalog"]["price_format2"], ".", $price);
        }
        else $price = str_replace(",", ".", $price);
        
        $price = preg_replace("/\.{1}$/", "", $price);
        $price = preg_replace('/[^0-9.]/', "", $price);
        return $price;
    }
    
    protected function parseCatalogPriceOkrug($price)
    {   
        $price = trim($price);
        if($price)
        {
            if(isset($this->settings["catalog"]["price_okrug"]))
            {
                if($this->settings["catalog"]["price_okrug"]=="up")
                {
                    if(!isset($this->settings["catalog"]["price_okrug_delta"]) || !$this->settings["catalog"]["price_okrug_delta"])
                        $delta = 0;
                    else
                        $delta = $this->settings["catalog"]["price_okrug_delta"];
                        
                    $price = round($price, $delta);
                }elseif($this->settings["catalog"]["price_okrug"]=="ceil")
                {
                    $price = ceil($price);    
                }elseif($this->settings["catalog"]["price_okrug"]=="floor")
                {
                    $price = floor($price);    
                }
            }
        }
        
        return $price;
    }

    protected function parseCatalogPricePreview(&$el)
    {
        if($this->settings["catalog"]["preview_price"])
        {
            if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"])) return false;
            $price = $this->settings["catalog"]["preview_price"];
            $price = $this->GetArraySrcAttr($price);
            $path = $price["path"];
            $attr = $price["attr"];
            if (empty($attr)) $price = strip_tags(pq($el)->find($path)->html());
            elseif(!empty($attr)) $price = trim(pq($el)->find($path)->attr($attr));
            $price = $this->parseCatalogPriceFormat($price);
            //$price = $this->parseCatalogPriceOkrug($price);
            
            $this->arPrice["PRICE"] = $price;
            $this->arPrice["PRICE"] = trim($this->arPrice["PRICE"]);
            if(!$this->arPrice["PRICE"])
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."]".GetMessage("parser_error_price_notfound");
                unset($this->arPrice["PRICE"]);
                return false;
            }
            $this->arPrice["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
            $this->arPrice["CURRENCY"] = $this->settings["catalog"]["currency"];
        }

    }

    protected function parseCatalogPriceDetail(&$el)
    {

        if($this->settings["catalog"]["detail_price"])
        {
            if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["price"])) return false;
            $price = $this->settings["catalog"]["detail_price"];
            $price = strip_tags(pq($el)->find($price)->html());
            $price = $this->parseCatalogPriceFormat($price);
            //$price = $this->parseCatalogPriceOkrug($price);
            
            $this->arPrice["PRICE"] = $price;
            $this->arPrice["PRICE"] = trim($this->arPrice["PRICE"]);
            if(!$this->arPrice["PRICE"])
            {
                $this->errors[] = $this->arFields["NAME"]."[".$this->arFields["LINK"]."]".GetMessage("parser_error_price_notfound");
                unset($this->arPrice["PRICE"]);
                return false;
            }
            $this->arPrice["CATALOG_GROUP_ID"] = $this->settings["catalog"]["price_type"];
            $this->arPrice["CURRENCY"] = $this->settings["catalog"]["currency"];
        }

    }

    protected function parseCatalogDescriptionPreview(&$el)
    {
        if($this->checkUniq() && (!$this->isUpdate || $this->isUpdate["preview_descr"]=="N")) return false;
        if($this->settings["catalog"]["preview_text_selector"] && $this->settings["catalog"]["text_preview_from_detail"]!="Y")
        {
            $preview = $this->settings["catalog"]["preview_text_selector"];
            foreach(pq($el)->find($preview." img") as $img)
            {
                $src = pq($img)->attr("src");
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                $this->parseCatalogSaveImgServer($img, $src);
            }

            if($this->bool_preview_delete_tag=="Y")$preview_text = strip_tags(pq($el)->find($preview)->html(), htmlspecialcharsBack($this->preview_delete_tag));
            else $preview_text = pq($el)->find($preview)->html();
            
            
            $preview_text = trim($preview_text);
            if(isset($this->settings["loc"]["f_preview_text"]) && $this->settings["loc"]["f_preview_text"]=="Y")
            {
                $preview_text = $this->locText($preview_text, $this->preview_text_type=="html"?"html":"plain");    
            }
            
            $this->arFields["PREVIEW_TEXT"] = trim($preview_text);
            $this->arFields["PREVIEW_TEXT_TYPE"] = $this->preview_text_type;
        }
    }

    protected function parseCatalogDescriptionDetail(&$el)
    {
        //if($this->detail_delete_element)$this->deleteCatalogElement($this->detail_delete_element, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        //if($this->detail_delete_attribute)$this->deleteCatalogAttribute($this->detail_delete_attribute, $this->detail_dom, $this->detailHtml[$this->detail_dom]);
        if($this->checkUniq() && (!$this->isUpdate || (!$this->isUpdate["detail_descr"] && (!$this->isUpdate["preview_descr"] && !$this->settings["catalog"]["text_preview_from_detail"]!="Y")))) return false;
        if($this->settings["catalog"]["detail_text_selector"])
        {
            $detail = $this->settings["catalog"]["detail_text_selector"];
            $arDetail = explode(",", $detail);
            $detail_text = "";
            if($arDetail && !empty($arDetail))
            {
                foreach($arDetail as $detail)
                {
                    $detail = trim($detail);
                    if(!$detail) continue 1;

                    foreach(pq($el)->find($detail." img") as $img)
                    {
                        $src = pq($img)->attr("src");
                        $src = $this->parseCaralogFilterSrc($src);
                        $src = $this->getCatalogLink($src);
                        $this->parseCatalogSaveImgServer($img, $src);
                    }

                    if($this->bool_detail_delete_tag=="Y")$detail_text .= strip_tags(pq($el)->find($detail)->html(), htmlspecialcharsBack($this->detail_delete_tag));
                    else $detail_text .= pq($el)->find($detail)->html();

                }
            }

            /*foreach(pq($el)->find($detail." img") as $img)
            {
                $src = pq($img)->attr("src");
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                $this->parseCatalogSaveImgServer($img, $src);
            }
            if($this->bool_detail_delete_tag=="Y")$detail_text = strip_tags(pq($el)->find($detail)->html(), htmlspecialcharsBack($this->detail_delete_tag));
            else $detail_text = pq($el)->find($detail)->html();*/
            $detail_text = trim($detail_text);
            if(isset($this->settings["loc"]["f_detail_text"]) && $this->settings["loc"]["f_detail_text"]=="Y")
            {
                $detail_text = $this->locText($detail_text, $this->detail_text_type=="html"?"html":"plain");    
            }
            $this->arFields["DETAIL_TEXT"] = $detail_text;
            $this->arFields["DETAIL_TEXT_TYPE"] = $this->detail_text_type;
            if($this->settings["catalog"]["text_preview_from_detail"]=="Y")
            {
                $this->arFields["PREVIEW_TEXT"] = $this->arFields["DETAIL_TEXT"];
                $this->arFields["PREVIEW_TEXT_TYPE"] = $this->arFields["DETAIL_TEXT_TYPE"];
            }
        }
    }

    public function parseCatalogDetailPicture(&$el) //27.10.2015
    {   
        if($this->checkUniq() && (!$this->isUpdate || (!$this->isUpdate["detail_img"] && (!$this->isUpdate["preview_img"] && !$this->settings["catalog"]["img_preview_from_detail"]!="Y")))) return false;
        if($this->settings["catalog"]["detail_picture"])
        {    
            $arSelPic = explode(",", $this->settings["catalog"]["detail_picture"]);

            foreach($arSelPic as $sel)
            {
                $sel = trim($sel);
                if(empty($sel)) continue;
                $ar = $this->GetArraySrcAttr($sel); 
                $img = $ar["path"];
                $attr = $ar["attr"];
                if(!empty($attr))
                {
                    $src = pq($el)->find($img)->attr($attr);
                    $src = $this->parseSelectorStyle($attr, $src);  
                }
                elseif(empty($attr))
                {
                    $src = pq($el)->find($img)->text();  
                }
                /*
                **????? ??? ??????? base64 ????????? ????????
                **$data = base64_decode(preg_replace('#^data:image/\w+;base64,#i', '', $data));
                **file_put_contents('image.png', $data);
                */
                
                $src = $this->parseCaralogFilterSrc($src);
                $src = $this->getCatalogLink($src);
                foreach(GetModuleEvents("shs.parser", "ParserDetailPicture", true) as $arEvent) //27.10.2015
                    ExecuteModuleEventEx($arEvent, array(&$this, $src));
                if(!self::CheckImage($src)) continue;
                $this->arPhoto[$src] = 1;
                //$src = str_replace("cdn.", "", $src);
                $this->arFields["DETAIL_PICTURE"] = CFile::MakeFileArray($src);

                if($this->settings["catalog"]["img_preview_from_detail"]=="Y")
                {
                    $this->arFields["PREVIEW_PICTURE"] = $this->arFields["DETAIL_PICTURE"];
                }
            }

        }
    }

    protected function CheckImage($src)
    {
        if(!empty($src) && preg_match("/(jpeg|jpg|gif|png|JPEG|JPG|GIF|PNG)$/", $src))
        {
            return true;
        }else return false;
    }

    public function parseCatalogPreviewPicturePreview(&$el) //27.10.2015
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["preview_img"])) return false;
        if($this->settings["catalog"]["preview_picture"] && $this->settings["catalog"]["img_preview_from_detail"]!="Y")
        {   
            $ar = $this->GetArraySrcAttr($this->settings["catalog"]["preview_picture"]);
            $img = $ar["path"];
            $attr = $ar["attr"];
            if(!empty($attr)) 
            {
                $src = pq($el)->find($img)->attr($attr);
                $src = $this->parseSelectorStyle($attr, $src);
            }
            elseif(empty($attr))
            {
                $src = pq($el)->find($img)->text();
            }
            $src = $this->parseCaralogFilterSrc($src);
            $src = $this->getCatalogLink($src);
            foreach(GetModuleEvents("shs.parser", "ParserPreviewPicture", true) as $arEvent) //27.10.2015
                    ExecuteModuleEventEx($arEvent, array(&$this, $src));
            //$src = str_replace("cdn.", "", $src);
            if(!self::CheckImage($src)) return;
            $this->arFields["PREVIEW_PICTURE"] = CFile::MakeFileArray($src);
        }
    }

    protected function parseSelectorStyle($attr, $src)
    {
        if($attr=="style" && $src)
        {
            preg_match("/url\(([^)]*)\)/", $src, $matches);
            if(isset($matches[1]) && $matches[1])
            {
                $src = str_replace(array('"', "'"), "", $matches[1]);
            }
        }

        return $src;
    }

    protected function parseCatalogSaveImgServer($img, $src){
        
        $arImg = CFile::MakeFileArray($src);
        
        if(isset($this->albumID) && $this->albumID)
            $this->addAlbumCollection($arImg, $img);
        else{
            $fid = CFile::SaveFile($arImg, "shs.parser");
            pq($img)->attr('src', CFile::GetPath($fid));    
        }
        

    }
    
    protected function createAlbum()
    {   
        CModule::IncludeModule("fileman");
        CMedialib::Init();
        $arCollections = CMedialibCollection::GetList(array('arOrder'=>Array('NAME'=>'ASC'),'arFilter' => array('ACTIVE' => 'Y', "NAME"=>"SOTBIT_PARSER")));
        if(!$arCollections)
        {
            $this->albumID = CMedialibCollection::Edit(array("arFields" => array("NAME"=>"SOTBIT_PARSER")));    
        }else
            $this->albumID = $arCollections[0]["ID"];
    }
    
    protected function addAlbumCollection($arImg, $img)
    {
        $res = CMedialibItem::Edit(array(
                'file' => $arImg,
                'arFields' => array(
                    'ID' => 0,
                    'NAME' => $arImg["name"],
                    'DESCRIPTION' => "",
                    'KEYWORDS' => ""
                ),
                'arCollections' => array($this->albumID)
        ));
        if($res)
        {
            pq($img)->attr('src', $res['PATH']);    
        }
    }

    public function parseCaralogFilterSrc($src){
        $src = preg_replace('/#.+/', '', $src);
        $src = preg_replace('/\?.+/', '', $src);
        $countPoint = substr_count($src, ".");
        if($countPoint>=2 && preg_match("/^\/{2}/", $src) && !preg_match("/^\/{2}www\./", $src) && !preg_match("/http:\//", $src) && !preg_match("/https:\//", $src))
            $src = preg_replace("/^\/{2}/", "http://", $src);
        //$src = str_replace('http:/', 'http://', $src); 
        $src = str_replace('//', '/', $src);
        $src = str_replace('http:/', 'http://', $src);
        $src = str_replace('https:/', 'https://', $src);
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src) || preg_match("/https:\//", $src))
        {
            if(preg_match("/https:\//", $src))
                $src = preg_replace("/^\/{2}/", "https://", $src);
            elseif(preg_match("/http:\//", $src) || preg_match("/www\./", $src))
                $src = preg_replace("/^\/{2}/", "http://", $src);
        }
        
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src) || preg_match("/https:\//", $src))
        {
            if(preg_match("/https:\//", $src))
                $src = preg_replace("/^\/{1}/", "https://", $src);
            elseif(preg_match("/http:\//", $src) || preg_match("/www\./", $src))
                $src = preg_replace("/^\/{1}/", "http://", $src);    
        }
        
        //$src = str_replace('//', '/', $src);
        return $src;
    }

    protected function GetArraySrcAttr($path)
    {
        $ar["path"] = $image = preg_replace('#\[[^\[]+$#','',$path);
        preg_match('#\[[^\[]+$#', $path, $matches);
        $ar["attr"] = $attr = str_replace(array("[", "]"), "", $matches[0]);
        return $ar;
    }

    protected function parseCatalogPages()
    {
        global $zis; 
        foreach($this->pagenavigation as $id=>$page)
        {
            $this->clearHtml();
            
            try{
                if(isset($this->pagenavigationPrev[$page]) || isset($this->pagenavigationPrev[$id]) || empty($page)) continue;
            }catch(Exception $e)
            {
                continue;    
            } 

            
            $zis++;
           
            if($this->currentPage>=self::DEFAULT_DEBUG_LIST && $this->settings["catalog"]["mode"]=="debug") return;
            $this->connectCatalogPage($page);
            $this->parseCatalogNavigation($page);
            if($this->IsNumberPageNavigation() && $this->CheckPageNavigation($id))
            {
                $this->parseCatalogProducts();
            }elseif(!$this->IsNumberPageNavigation())
            {
                $this->parseCatalogProducts();
            }

            $i++;

        }
        foreach($this->pagenavigationPrev as $i=>$v)
        {
            foreach($this->pagenavigation as $i1=>$v1)
            {
                if($v1==$v) unset($this->pagenavigation[$i1]);
            }
        }
        
        if(count($this->pagenavigation)>0)
        {
            $this->parseCatalogPages();
        }

    }
    
    protected function SaveCopyPage()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt", $this->page);
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt", $this->fileHtml->headerUrl);   
        }     
    }
    
    protected function DeleteCopyPage()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt"))
        {
            unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt");
            unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt"); 
        }
    }
    
    protected function GetCopyPage()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt"))
        {
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_page".$this->id.".txt");
            $this->httpCode = 200;
            return $file;  
        }
        $this->httpCode = 0;
        return false;
    }
    
    protected function GetCopyUrl()
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt"))
        {
            $file = file_get_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_copy_url".$this->id.".txt");
            return $file;  
        }
        $this->httpCode = 0;
        return false;     
    }
    
    protected function connectCatalogPage($page)
    {
        $this->catalogSleep();
        $this->sectionPage = $page;
        $this->fileHtml = new FileGetHtml();
        $this->page = $this->GetCopyPage();
        if(!$this->page)
        {   
            if (parent::ValidateUrl($page) === true)
            {
                $this->page = $this->fileHtml->file_get_html($page, $this->settings["catalog"]["proxy"], $this->auth, $this);
            }
            elseif (parent::ValidateUrl($page) === false) 
            {
                $this->page = $this->fileHtml->file_get_local_html($page);
            }
        }else{
            $this->fileHtml->httpCode = 200;
            $this->fileHtml->headerUrl = $this->GetCopyUrl();    
        }
        $this->DeleteCharsetHtml5($this->page);
        $this->SaveCopyPage();
        $this->httpCode = $this->fileHtml->httpCode;
        if($this->httpCode!=200 && $this->httpCode!=301 && $this->httpCode!=302 && $this->httpCode!=303)
        {   
            {   
                
                $this->errors[] = "[".$page."]".GetMessage("parser_error_connect")."[".$this->httpCode."]";
                //if($this->agent || $this->settings["catalog"]["mode"]=="debug")
                {   
                    $this->SaveLog();
                    unset($this->errors);
                }
                
                if($this->settings["catalog"]["404"]!="Y")
                {
                    if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
                    {
                        $this->stepStart = 1;
                        $this->SavePrevPage($page);
                        if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
                            unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                        $this->DeleteCopyPage();
                        $this->activeCurrentPage++;
                        $this->SetCatalogElementsResult($this->activeCurrentPage);
                        $this->clearFields();
                        $this->ClearBufferStep();
                    }
                    
                    return false;    
                }
            }
        }

        $this->currentPage++;
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")$this->SavePrevPage($page);
        //if($page==$this->rss)
        {
            $this->urlCatalog = $this->fileHtml->headerUrl;
            $this->urlSite = $this->getCatalogUrlSite();
        }
        
        return true;
    }

    protected function catalogSleep()
    {
        $sleep = $this->settings["catalog"]["sleep"];
        if($sleep)
        {
            sleep($sleep);
        }
    }
    
    protected function SavePrevPage($page)
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && $this->stepStart)
        {
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt", $page."|", FILE_APPEND);  
        }  
    }
    
    protected function SavePrevPageDetail($page)
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug")
        {
            file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt", $page."|", FILE_APPEND);  
        }  
    }
    
    protected function SaveCurrentPage($arPage)
    {
        if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && $this->stepStart)
        {    
            $page = implode("|", $arPage);
            if(!empty($arPage))file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt", $page."|"); 
            elseif($this->IsEndSectionUrl()) file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt", "");
            else file_put_contents($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt", "0");   
        }
            
    }
    
    protected function ClearAjaxFiles()
    {
        if(!$this->agent && $_GET["begin"])
        {
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_page".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_prev_element".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_parser_current_page".$this->id.".txt"); 
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/catalog_log_".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser".$this->id.".txt");  
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt"); 
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/loc".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/loc".$this->id.".txt"); 

        }elseif($this->agent)
        {
            if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/loc".$this->id.".txt"))unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/loc".$this->id.".txt");
        }
           
    }
    
    protected function checkActionBegin()
    {
        //if($this->updateActive && isset($this->settings["catalog"]["uniq"]["action"]) && $this->settings["catalog"]["uniq"]["action"]!="N")
        {
            if((!$this->agent && $_GET["begin"]) || $this->agent)
            {
                
                $filterValues = array("PARSER_ID"=>$this->id);
                $arr = array(
                    "select" => array('ID'),
                    "filter" => $filterValues
                );
                
                if($this->tmp=="b_shs_parser_tmp" || !$this->tmp)
                {
                    $rsData = ShsParserTmpTable::GetList($arr);
                    
                    while($arData = $rsData->Fetch())
                    {
                        ShsParserTmpTable::Delete($arData["ID"]);
                    }        
                }elseif($this->tmp=="b_shs_parser_tmp_old")
                {
                    $rsData = ShsParserTmpOldTable::GetList($arr);
                    
                    while($arData = $rsData->Fetch())
                    {
                        ShsParserTmpOldTable::Delete($arData["ID"]);    
                    }
                }
                
            }
        }
            
    }
    
    protected function checkActionAgent($agent = true)
    {
        if((($this->agent && $agent) || !$agent) && $this->updateActive && isset($this->settings["catalog"]["uniq"]["action"]) && $this->settings["catalog"]["uniq"]["action"]!="N")
        {   
            $filterValues = array("PARSER_ID"=>$this->id);
            $arr = array(
                "select" => array('ID', "PRODUCT_ID"),
                "filter" => $filterValues
            );
            if($this->tmp=="b_shs_parser_tmp" || !$this->tmp)
            {
                $rsData = ShsParserTmpTable::GetList($arr);
                
                while($arData = $rsData->Fetch())
                {
                    $arProd[$arData["PRODUCT_ID"]] = $arData["PRODUCT_ID"];    
                }
                
                $rsDataOld = ShsParserTmpOldTable::GetList($arr);

                while($arDataOld = $rsDataOld->Fetch())
                {
                    $arProdOld[$arDataOld["PRODUCT_ID"]] = $arDataOld["PRODUCT_ID"];    
                }
                
                if(isset($arProdOld) && !empty($arProdOld))
                {
                    foreach($arProdOld as $p)
                    {
                        if(!isset($arProd[$p]))
                            $this->doProductAction($p);
                    }
                }
                $parser = new ShsParserContent();
                $arFields['TMP'] = "b_shs_parser_tmp_old";
                $parser->Update($this->id, $arFields); 
                unset($parser);
            }elseif($this->tmp=="b_shs_parser_tmp_old")
            {
                $rsData = ShsParserTmpOldTable::GetList($arr);
                
                while($arData = $rsData->Fetch())
                {
                    $arProd[$arData["PRODUCT_ID"]] = $arData["PRODUCT_ID"];
                }
                
                $rsDataOld = ShsParserTmpTable::GetList($arr);
                
                while($arDataOld = $rsDataOld->Fetch())
                {
                    $arProdOld[$arDataOld["PRODUCT_ID"]] = $arDataOld["PRODUCT_ID"];    
                }
                
                if(isset($arProdOld) && !empty($arProdOld))
                {
                    foreach($arProdOld as $p)
                    {
                        if(!isset($arProd[$p]))
                            $this->doProductAction($p);
                    }
                }
                $parser = new ShsParserContent();
                $arFields['TMP'] = "b_shs_parser_tmp";
                $parser->Update($this->id, $arFields);
                unset($parser);
            }    
        }
    }
    
    protected function doProductAction($ID)
    {
        if($this->settings["catalog"]["uniq"]["action"]=="D")
        {
            CIBlockElement::Delete($ID);
        }elseif($this->settings["catalog"]["uniq"]["action"]=="A")
        {
            $el = new CIBlockElement;
            $res = $el->Update($ID, array("ACTIVE"=>"N"));
            unset($el);
        }
    }
    
    protected function addTmp($ID)
    {   
        if(/*!$this->debug && */$ID && $this->updateActive && isset($this->settings["catalog"]["uniq"]["action"]) && $this->settings["catalog"]["uniq"]["action"]!="N")
        {
            $arFields["PARSER_ID"] = $this->id;
            $arFields["PRODUCT_ID"] = $ID;
            if($this->tmp=="b_shs_parser_tmp" || !$this->tmp)
            {   
                ShsParserTmpTable::add($arFields);    
            }elseif($this->tmp=="b_shs_parser_tmp_old")
            {   
                ShsParserTmpOldTable::add($arFields);    
            }
        }    
    }

    protected function getCatalogUrlSite(){
        if(preg_match("/http:/", $this->rss))
        {
            $url = str_replace("http://", "", $this->rss);
            $url = preg_replace("/\/.*/", "", $url);
            $url = "http://".$url;
        }elseif(preg_match("/https:/", $this->rss))
        {
            $url = str_replace("https://", "", $this->rss);
            $url = preg_replace("/\/.*/", "", $url);
            $url = "https://".$url;    
        }
        else{
            $url = preg_replace("/\/.*/", "", $this->rss);
        }
        return $url;
    }

    protected function searchCatalogNavigation()
    {

    }

    protected function parseCatalogNavigation($pageHref)
    {   
        $this->html = phpQuery::newDocument($this->page, "text/html;charset=".LANG_CHARSET);
        $this->base = $this->GetMetaBase($this->html);

        if($this->settings["catalog"]["pagenavigation_selector"])
        {
            $this->deleteCatalogElement($this->settings["catalog"]["pagenavigation_delete"], $this->settings["catalog"]["pagenavigation_selector"]);

            if(!$this->settings["catalog"]["pagenavigation_one"])
                $this->settings["catalog"]["pagenavigation_one"] = "a[href]";

            $arPath = $this->GetArraySrcAttr($this->settings["catalog"]["pagenavigation_one"]);
            $attr = $arPath["attr"]?$arPath["attr"]:"href";
            $element = $this->settings["catalog"]["pagenavigation_selector"]." ".$arPath["path"];

            unset($this->pagenavigation[$pageHref]);
            unset($this->pagenavigation[$this->currentPage]);
            $this->pagenavigationPrev[$pageHref] = $pageHref;


            foreach($this->html[$element] as $page)
            {

                $p = pq($page)->attr($attr);
                $p = $this->getCatalogLink($p);
                $p1 = $p."\\r\\n";
                $n = pq($page)->text();
                $n = $this->ValidatePageNavigation($n);

                if(!$p || empty($p) || (isset($this->settings["catalog"]["pagenavigation_var"]) && $this->settings["catalog"]["pagenavigation_var"]))
                {
                    if(isset($this->settings["catalog"]["pagenavigation_var"]) && $this->settings["catalog"]["pagenavigation_var"])
                    {   
                        $nV = (int)$this->settings["catalog"]["pagenavigation_page_count"];
                        $pV = $this->settings["catalog"]["pagenavigation_var"];
                        $other = $this->settings["catalog"]["pagenavigation_other_var"];
                        
                        $req = $pV."=".$n;
                        if($other)
                            $req .= "&".$other;
                            
                        $p = $this->getUrlPageNavigation($req, $pV);
                    }
                    else continue 1;    
                }
                  
                //$this->convetCyrillic($p);
                
                if(isset($this->pagenavigationPrev[$p])) continue;
                
                if($this->IsNumberPageNavigation())
                {   
                    if(!$this->CheckValidatePageNavigation($n) && !$this->CheckPageNavigation($n)) continue;

                    if(($this->currentPage+5)<$n)continue;
                    if($this->CheckPageNavigation($n))
                    {   
                        if(isset($this->pagenavigationPrev[$p])) continue;
                        if(isset($this->pagenavigationPrev[$n])) continue;
                        $this->pagenavigation[$n] = $p;
                    }elseif($this->CheckPageNavigationLess($n)){
                        if(isset($this->pagenavigationPrev[$p])) continue;
                        if(isset($this->pagenavigationPrev[$n])) continue;
                        $this->pagenavigation[$n] = $p;
                    } else{

                    }
                }else{

                    $this->pagenavigation[$p] = $p;
                }

            }
            return true;
        }elseif(isset($this->settings["catalog"]["pagenavigation_var"]) && $this->settings["catalog"]["pagenavigation_var"] && isset($this->settings["catalog"]["pagenavigation_page_count"]) && $this->settings["catalog"]["pagenavigation_page_count"])
        {
            $n = (int)$this->settings["catalog"]["pagenavigation_page_count"];
            $p = $this->settings["catalog"]["pagenavigation_var"];
            $other = $this->settings["catalog"]["pagenavigation_other_var"];
            for($i=2; $i<=$n;$i++)
            {
                $req = $p."=".$i;
                if($other)
                    $req .= "&".$other;
                $page = $this->getUrlPageNavigation($req, $p, $other);
                $this->pagenavigation[$page] = $page;
            }
            return true;    
        }
         
        return false;



    }
    
    protected function locText($text="", $format="plain", $test = false)
    {
        global $APPLICATION;
        if(isset($this->settings["loc"]["type"]) && $this->settings["loc"]["type"] && $text)
        {
            if($this->settings["loc"]["type"]=="yandex")
            {   
                $key = $this->settings["loc"]["yandex"]["key"];
                $lang = $this->settings["loc"]["yandex"]["lang"];
                $text0 = $text;
                $charset = strtolower(SITE_CHARSET);
                if($charset!="utf-8")
                {
                     $text = $APPLICATION->ConvertCharset($text, $charset, "utf-8");    
                }
                $text = urlencode($text);
                $url = "https://translate.yandex.net/api/v1.5/tr/translate?key=".$key."&text=".$text."&lang=".$lang."&format=".$format;
                $ch = curl_init();
                //curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_URL, "https://translate.yandex.net/api/v1.5/tr/translate");
                curl_setopt($ch, CURLOPT_POST, true);
                curl_setopt($ch, CURLOPT_POSTFIELDS, "key=".$key."&text=".$text."&lang=".$lang."&format=".$format);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($ch, CURLOPT_TIMEOUT, 60);
                
                $arrorLoc[401] = GetMessage("shs_parser_loc_401");
                $arrorLoc[402] = GetMessage("shs_parser_loc_402");
                $arrorLoc[403] = GetMessage("shs_parser_loc_403");
                $arrorLoc[404] = GetMessage("shs_parser_loc_404");
                $arrorLoc[413] = GetMessage("shs_parser_loc_413");
                $arrorLoc[422] = GetMessage("shs_parser_loc_422");
                $arrorLoc[501] = GetMessage("shs_parser_loc_501");
                $data = curl_exec($ch);
                $xml = new CDataXML();
                $xml->LoadString($data);
                $arData = $xml->GetArray();
                
                if(isset($arData["Translation"]["#"]["text"]["0"]["#"]))
                {
                    $data = $arData["Translation"]["#"]["text"]["0"]["#"];
                    $charset = strtolower(SITE_CHARSET);
                    if($charset!="utf-8")
                    {
                         $APPLICATION->ConvertCharset($data, "utf-8", $charset);    
                    }
                    
                }elseif(isset($arData["Error"]["@"]["code"]))
                {
                    $httpCode = $arData["Error"]["@"]["code"];
                    $this->errors[] = $arrorLoc[$httpCode];
                    $data = $text0;
                }else
                    $data = $text0;
                unset($xml);
                unset($arData);
                unset($arrorLoc);
                curl_close($ch);
                return $data;
            }    
        }        
    }

    protected function deleteCatalogElement($element, $parentElement=false, $dom=false)
    {
        if($parentElement)
        {
            $arElement = explode(",", $element);
            $parentElement = trim($parentElement);
            $element = "";
            foreach($arElement as $i=>$el)
            {
                $el = trim($el);
                if(empty($el)){
                    unset($arElement[$i]);
                    continue 1;
                }
                $element.=$parentElement." ".$el;
                if(($i+1)!=count($arElement))$element.=",";
            }
        } 
        pq($element)->remove();
    }

    protected function deleteCatalogAttribute($element, $parentElement=false, $dom=false)
    {
        if($parentElement)
        {
            $arElement = explode(",", $element);
            $parentElement = trim($parentElement);
            $element = "";
            foreach($arElement as $i=>$el)
            {
                $el = trim($el);
                if(empty($el)){
                    unset($arElement[$i]);
                    continue;
                }

                preg_match('#\[[^\[]+$#', $el, $matches);
                $el = preg_replace('#\[[^\[]+$#','',$el);
                $attr = str_replace(array("[", "]"), "", $matches[0]);

                $element = $parentElement." ".$el;
                pq($element)->removeAttr($attr);
            }
        }

    }
    
    protected function DeleteParam($url="", $p="", $other="")
    {
        if(empty($url) || empty($p)) return false;
        
        $url = str_replace($other, "", $url);
        $reg = "/\?".$p."\=(\d)/";
        $url = preg_replace($reg, "", $url);
        $reg = "/".$p."\=(\d)/";
        $url = preg_replace($reg, "", $url);
        
        $url = str_replace("?&", "?", $url);
        $url = str_replace("&&", "&", $url);
        $url = str_replace("/&", "/?", $url);
        $url = preg_replace("/\?{1}$/", "", $url);
        
        return $url;
            
    }
    
    protected function getUrlPageNavigation($url="", $p="", $other="")
    {
        $url = trim($url);
        $p = trim($p);
        
        if(empty($url) || empty($p)) return false;
        
        $this->urlCatalog = $this->DeleteParam($this->urlCatalog, $p, $other);


        if(preg_match("/\/{1}$/", $this->urlCatalog))
        {
            $url = $this->urlCatalog."?".$url;
        }elseif(!preg_match("/\/{1}$/", $this->urlCatalog) && !preg_match("/\?/", $this->urlCatalog))
        {
            $url = $this->urlCatalog."?".$url;
        }
        elseif(preg_match("/\?/", $this->urlCatalog))
        {
            $url = $this->urlCatalog."&".$url;
        }
        return $url;
    }

    protected function getCatalogLink($url)
    {
        $url = trim($url);

        
        if(empty($url)) return false;
        elseif(preg_match("/^\/{2}www/", $url))
        {
            $url = preg_replace("/^\/{2}www/", "www", $url);
        }
        elseif(preg_match('/^http:/', $url) || preg_match('/www\./', $url) || preg_match('/^https:/', $url))
        {
            $url = $url;
        }elseif(preg_match("/^\//", $url))
        {   
            $url = $this->urlSite.$url;
        }elseif(!preg_match("/^\//", $url) && preg_match("/\/{1}$/", $this->urlCatalog))
        {
            if($this->base) $url = $this->base.$url;
            else $url = $this->urlCatalog.$url;
        }
        elseif(!preg_match("/^\?/", $url) && !preg_match("/^\//", $url) && !preg_match("/\/{1}$/", $this->urlCatalog))
        {   
            //$site
            if($this->base)
            {
                if(!preg_match("/\/{1}$/", $this->base))
                    $this->base = $this->base."/";
                $url = $this->base.$url;    
            }else{
                $uri = preg_replace('#/[^/]+$#','',$this->urlCatalog);
                $url = $uri."/".$url;    
            }

        }elseif(preg_match("/\?/", $url) && preg_match("/\?/", $this->urlCatalog))
        {   
            if(preg_match("/^\?/", $url))
            {
                $uri = preg_replace("/\?.+/", "", $this->urlCatalog);
                $url = $uri.$url;
            }else{
                $uri = preg_replace('#/[^/]+$#','',$this->urlCatalog);
                $url = $uri."/".$url;    
            }
        }

        $this->convetCyrillic($url);
        //$url = $this->deletePointUrl($url);
        return $url;
    }

    public function deletePointUrl($url)
    {
        $count = substr_count($url, "../");
        if($count>0)
        {
            for($i=0;$i<$count;$i++)
            {
                $url = preg_replace("/[-\w]+\/\.{2}\//", "", $url);
            }
        }
        return $url;
    }

    public function DeleteCharsetHtml5(&$data)
    {
        $data = preg_replace("/\s*<meta\s+charset=[\"|']{0,1}.+?[\"|']{0,1}\s*\/{0,1}\>/i", "", $data);
    }
    
    public function parserSelector(&$html, $selector, $nextSelector=0){
        global $shs_DOC_ENCODING;
        phpQuery::selectDocument($html);
        if($nextSelector==0 && $this->meta_description!="N")foreach($html['meta'] as $meta){
            if(strtolower(pq($meta)->attr("name"))=="description"){
                $this->meta_description_text = pq($meta)->attr("content");
                if(!$this->meta_description_text)$this->meta_description_text = pq($meta)->attr("value");
                if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) $this->meta_description_text = mb_convert_encoding($this->meta_description_text, LANG_CHARSET, "utf-8");
                if($this->meta_description_text)
                {
                    $this->meta_description_text = strip_tags($this->meta_description_text);
                    break;
                }

            }
        }
        if($nextSelector==0 && $this->meta_keywords!="N")foreach($html['meta'] as $meta){
            if(strtolower(pq($meta)->attr("name"))=="keywords"){
                $this->meta_keywords_text = pq($meta)->attr("content");
                if(!$this->meta_keywords_text)$this->meta_keywords_text = pq($meta)->attr("value");
                if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) $this->meta_keywords_text = mb_convert_encoding($this->meta_keywords_text, LANG_CHARSET, "utf-8");
                if($this->meta_keywords_text)
                {
                    $this->meta_keywords_text = strip_tags($this->meta_keywords_text);
                    break;
                }

            }
        }
        if($nextSelector==0 && $this->meta_title!="N")
        {
            $this->meta_title_text = pq($html['title'])->text();
            $this->meta_title_text = strip_tags($this->meta_title_text);
            if(strtoupper(LANG_CHARSET)=="WINDOWS-1251"/* && strtoupper(LANG_CHARSET)!=strtoupper($shs_DOC_ENCODING)*/) {
                //$this->meta_title_text = mb_convert_encoding($this->meta_title_text, LANG_CHARSET, $shs_DOC_ENCODING);
                $this->meta_title_text = mb_convert_encoding($this->meta_title_text, LANG_CHARSET, "utf-8");
            }
        }


        if(empty($selector)) return $html->htmlOuter();
        else
        {
          $out = '<meta http-equiv="Content-Type" content="text/html;charset='.LANG_CHARSET.'">'.pq($selector)->html();
          return $out;
        }


    }

    public function changeImgSrc($html){
        phpQuery::selectDocument($html);
        $site = $this->getUrlSite();
        foreach($html["img"] as $img){
          $src = $this->filterSrc(pq($img)->attr("src"));
          if(!preg_match('/^http:/', $img->getAttribute('src')) && !preg_match('/^https:/', $img->getAttribute('src')) && !preg_match('/^www/', $img->getAttribute('src')) && !preg_match('/^\/{2}/', $img->getAttribute('src'))){
            if(preg_match("/^\/{1}/", $src))$src = $site.$src;
            else $src = $site."/".$src;
            $img->setAttribute('src', $src);
          }else{
            $img->setAttribute('src', $src);
          }
        }
        return $html;
    }

    public function parserFirstImg($html){
        phpQuery::selectDocument($html);
        $site = $this->getUrlSite();
        foreach($html["img"] as $img){
          $first_img = $this->filterSrc(pq($img)->attr("src"));
          if(!preg_match('/^http:/', $first_img) && !preg_match('/^www/', $first_img) && !preg_match('/^https:/', $first_img)){

            if(preg_match("/^\/{1}/", $first_img))$first_img = $site.$first_img;
            else $first_img = $site."/".$first_img;
            $arWidth = getimagesize($first_img);
            if($arWidth[0]<40) continue;
            return $first_img;
          }else{
            $arWidth = getimagesize($first_img);
            if($arWidth[0]<40) continue;
            return $first_img;
          }
        }
        return $first_img;
    }

    public function saveImgServer($html){
        foreach($html["img"] as $img){
            $arImg = CFile::MakeFileArray(pq($img)->attr("src"));
            
            if(isset($this->albumID) && $this->albumID)
                $this->addAlbumCollection($arImg, $img);
            else{
                $fid = CFile::SaveFile($arImg, "shs.parser");
                $img->setAttribute('src', CFile::GetPath($fid));    
            }
            /*$fid = CFile::SaveFile($arImg, "shs.parser");
            $img->setAttribute('src', CFile::GetPath($fid));*/
        }
        return $html->htmlOuter();
    }

    public function deleteElementStart(&$html, $selector_delete_element){
        phpQuery::selectDocument($html);
        $arElements = explode(',', $selector_delete_element);
        foreach($arElements as $selector){
          if(empty($selector)) continue;
          $selector = trim($selector);
          $html[$selector]->remove();
        }
        return $html;
    }

    public function deleteElements(&$html, $selector, $nextSelector=0){
        $arSelector = $this->arraySelector($selector);
        $n = 0;
        if(!isset($arSelector[$nextSelector])){
          $html->outertext = "";
          return;
        }
        if(strpos($arSelector[$nextSelector], '[')!==false && preg_match("/\[[0-9]{1,3}\]/", $arSelector[$nextSelector])){
            $sel = $arSelector[$nextSelector];
            $arSelector[$nextSelector] = preg_replace('/\[[0-9]{1,3}\]/', '', $sel);
            preg_match_all('/\[[0-9]{1,3}\]/', $sel, $matches);
            $n = str_replace(array('[', ']'), "", $matches[0][0]);
            $item = $html->find($arSelector[$nextSelector], $n);
            if(gettype($item)=="NULL"){
                return false;
            }
            $data = $this->deleteElements($item, $selector, $nextSelector+1);

        }else{
            foreach($html->find($arSelector[$nextSelector]) as $item){
                $data = $this->deleteElements($item, $selector, $nextSelector+1);
            }
        }

    }

    public function deleteAttributeStart(&$html, $selector_delete_attribute){

        $arElements = explode(',', $selector_delete_attribute);

        foreach($arElements as $selector){
          if(empty($selector)) continue;
          preg_match('/\[[a-zA-Z]+\]$/', $selector, $attribute);
          $attributes = str_replace(array(']', '['), "", $attribute[0]);
          $selector = preg_replace('/\[[a-zA-Z]+\]$/', "", trim($selector));
          $this->deleteAttributes($html, trim($selector), $attributes);
        }
        return $html;
    }

    public function deleteAttributes(&$html, $selector, $attribute, $nextSelector=0){
        phpQuery::selectDocument($html);
        pq($selector)->removeAttr($attribute);
    }
    
    
    
    protected function getPageRssLink($url, $path, $site)
    {
        $url = trim($url);
        $urlCatalog = $site.$path;
        /*if(empty($url)) return false;
        elseif(preg_match("/^\/{2}www/", $url))
        {
            $url = preg_replace("/^\/{2}www/", "www", $url);
        }
        elseif(preg_match('/^http:/', $url) || preg_match('/www\./', $url) || preg_match('/^https:/', $url))
        {
            $url = $url;
        }elseif(preg_match("/^\//", $url))
        {
            $url = $site.$url;
        }elseif(!preg_match("/^\//", $url) && preg_match("/\/{1}$/", $urlCatalog))
        {    
            
            if($this->base)$url = $this->base.$url;
            else $url = $urlCatalog.$url;
        }
        elseif(!preg_match("/\?/", $url) && !preg_match("/^\//", $url) && !preg_match("/\/{1}$/", $urlCatalog))
        {   
            //$site
            if($this->base) $url = $this->base.$url;
            else{
                $uri = preg_replace('#/[^/]+$#','',$urlCatalog);
                $url = $uri."/".$url;    
            }
        }elseif(preg_match("/\?/", $url) && preg_match("/\?/", $urlCatalog))
        {   
            if(preg_match("/^\?/", $url))
            {
                $uri = preg_replace("/\?.+/", "", $urlCatalog);
                $url = $uri.$url;    
            }else{
                $uri = preg_replace('#/[^/]+$#','',$urlCatalog);
                $url = $uri."/".$url;
            }
        }*/
        
        if(empty($url)) return false;
        elseif(preg_match("/^\/{2}www/", $url))
        {
            $url = preg_replace("/^\/{2}www/", "www", $url);
        }
        elseif(preg_match('/^http:/', $url) || preg_match('/www\./', $url) || preg_match('/^https:/', $url))
        {
            $url = $url;
        }elseif(preg_match("/^\//", $url))
        {   
            $url = $site.$url;
        }elseif(!preg_match("/^\//", $url) && preg_match("/\/{1}$/", $urlCatalog))
        {
            if($this->base) $url = $this->base.$url;
            else $url = $urlCatalog.$url;
        }
        elseif(!preg_match("/^\?/", $url) && !preg_match("/^\//", $url) && !preg_match("/\/{1}$/", $urlCatalog))
        {   
            //$site
            if($this->base)
            {
                if(!preg_match("/\/{1}$/", $this->base))
                    $this->base = $this->base."/";
                $url = $this->base.$url;    
            }else{
                $uri = preg_replace('#/[^/]+$#','',$urlCatalog);
                $url = $uri."/".$url;    
            }

        }elseif(preg_match("/\?/", $url) && preg_match("/\?/", $urlCatalog))
        {   
            if(preg_match("/^\?/", $url))
            {
                $uri = preg_replace("/\?.+/", "", $urlCatalog);
                $url = $uri.$url;
            }else{
                $uri = preg_replace('#/[^/]+$#','',$urlCatalog);
                $url = $uri."/".$url;    
            }
        }
        
        
        //$this->convetCyrillic($url);
        return $url;
    }

    public function getContentsArray($site='', $port=80, $path='', $query=''){
        if(!$this->typeN || $this->typeN=="rss")
        {   
            $arContent = CIBlockRSS::GetNewsEx($site, $port, $path, $query);
            
            return CIBlockRSS::FormatArray($arContent);
        }elseif($this->typeN=="page")
        {
            $url = $site.$path;
            if($query)$url = $url."?".$query;
            $fileHtml = new FileGetHtml();
            $data = $fileHtml->file_get_html($url, $this->proxy, $this->auth, $this);
            $this->header_url = $url = $fileHtml->headerUrl;
            $this->DeleteCharsetHtml5($data);
            $html = phpQuery::newDocument($data, "text/html;charset=".LANG_CHARSET);
            $dom = htmlspecialcharsBack(trim($this->settings["page"]["selector"]));
            $href = htmlspecialcharsBack(trim($this->settings["page"]["href"]));
            $name = htmlspecialcharsBack(trim($this->settings["page"]["name"]));
            $href = $href?$href:"a:eq(0)";
            $name = $name?$name:$href;
            $this->base = $this->GetMetaBase($html);
            $i = 0;
            $site = $this->getUrlSite();
            foreach($html[$dom] as $val)
            {
                $strName =  strip_tags(pq($val)->find($name)->html());

                if($name=="a:parent")$strHref =  $strName =  strip_tags(pq($val)->html());
                else $strName =  strip_tags(pq($val)->find($name)->html());

                //$strHref =  mb_strtolower(pq($val)->find($href)->attr("href"));
                if($href=="a:parent")$strHref =  pq($val)->attr("href");
                else $strHref =  pq($val)->find($href)->attr("href");

                /*if(!preg_match('/^http:/', $strHref) && !preg_match('/^www/', $strHref) && !preg_match('/^\/{2}/', $strHref))
                {
                    if(preg_match('/^\//', $strHref))$strHref = $site.$strHref;
                    else $strHref = $site.$path.$strHref;
                }*/
                $strHref = $this->getPageRssLink($strHref, $path, $site);
                if(empty($strName)) $this->errors[] = GetMessage("parser_error_noname");
                if(empty($strHref)) $this->errors[] = GetMessage("parser_error_nohref");
                if(empty($strName) || empty($strHref)) continue;

                $arContent["item"][$i]["title"] = $strName;
                $arContent["item"][$i]["link"] = $strHref;
                $arContent["item"][$i]["description"] = pq($val)->html();
                $i++;
            }     
            if($i>0)
            {
                $arContent['title'] = $site;
                $arContent['link'] = $site;
                return  $arContent;
            }
        }
    }
    
    public function getMetaBase($html)
    {
        if(isset($this->base)) unset($this->base);
        if($this->typeN == "catalog")
        {
            $base = pq($html)->find("base:eq(0)")->attr("href");    
        }
        elseif ($this->typeN == "xml")
        {
            $base = mb_detect_encoding($html, "auto");
        }
        return $base;
    }

    public function getUrlSite(){
        $this->header_url = strtolower($this->header_url);
        $site = str_replace(array('http://', "https://", 'www.', "HTTP://", "WWW."), "", $this->header_url);
        $site = preg_replace('/\/(.)+/', '', $site);
        $arLevel = explode(".", $site);
        if(preg_match("/https:\//", $this->header_url))
        {
            if(count($arLevel)==2) return 'https://www.'.$site;
            else return 'https://'.$site;    
        }else{
            if(count($arLevel)==2) return 'http://www.'.$site;
            else return 'http://'.$site;    
        }
        
    }

    public function filterSrc($src){
        $src = preg_replace('/#.+/', '', $src);
        $src = preg_replace('/\?.+/', '', $src);
        //$src = str_replace('http:/', 'http://', $src);
        $src = str_replace('//', '/', $src);
        $src = str_replace('http:/', 'http://', $src);
        $src = str_replace('https:/', 'https://', $src);
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src) || preg_match("/https:\//", $src))
        {
            if(preg_match("/https:\//", $src))
                $src = preg_replace("/^\/{2}/", "https://", $src);
            elseif(preg_match("/http:\//", $src) || preg_match("/www\./", $src))
                $src = preg_replace("/^\/{2}/", "http://", $src);
        }
        //$src = preg_replace("/^\/{2}/", "http://", $src);
        if(preg_match("/www\./", $src) || preg_match("/http:\//", $src) || preg_match("/https:\//", $src))
        {
            if(preg_match("/https:\//", $src))
                $src = preg_replace("/^\/{1}/", "https://", $src);
            elseif(preg_match("/http:\//", $src) || preg_match("/www\./", $src))
                $src = preg_replace("/^\/{1}/", "http://", $src);    
        }
        //$src = str_replace('//', '/', $src);
        return $src;
    }

    public function parseImgFromRss($arItem){
        foreach($arItem as $item){
            if(is_array($item)) $preview = $this->parseImgFromRss($item);
            elseif(preg_match("/^(http:)(.)+(jpg|JPG|gif|GIF|png|PNG|JPEG|jpeg)$/", $item, $match) || preg_match("/^(https:)(.)+(jpg|JPG|gif|GIF|png|PNG|JPEG|jpeg)$/", $item, $match)){
              $preview = $match[0];
              break;
            }
        }
        return $preview;
    }

    public function arraySelector($selector, $debug=0){
        $bool = false;
        $selector = trim($selector);
        $arSel = explode(' ', $selector);
        $newArSel = array();
        $selStr = "";
        foreach($arSel as $i=>$val){
          if(preg_match('/\[/', $val) && preg_match('/\]/', $val) && !$bool) $newArSel[] = $val;
          elseif(!preg_match('/\[/', $val) && !preg_match('/\]/', $val) && !$bool) $newArSel[] = $val;
          elseif(preg_match('/\[/', $val) && !preg_match('/\]/', $val)){
            $bool = true;
            $selStr .= $val;
          }elseif(!preg_match('/\[/', $val) && !preg_match('/\]/', $val) && $bool){
            $selStr .= " ".$val;
          }elseif(preg_match('/\]/', $val) && $bool){
            $selStr .= " ".$val;
            $bool = false;
            $newArSel[] = $selStr;
            $selStr = "";
          }
        }
        return $newArSel;
    }
}
?>63   42736|/shs.parser/classes/general/main_classes_xml.php|63cb5c34<?
use Bitrix\Highloadblock as HL; 
use Bitrix\Main\Entity;
use Bitrix\Seo\Engine;
use Bitrix\Main\Text\Converter;
use Bitrix\Main\Localization\Loc;
use Bitrix\Main\IO\Path;

\Bitrix\Main\Loader::includeModule('seo');
\Bitrix\Main\Loader::includeModule('socialservices');

class SotbitXmlParser{
    
    public $id = false;
    public $rss;
    public $typeN;
    public $active;
    public $iblock_id;
    public $section_id;
    public $detail_dom;
    public $encoding;
    public $preview_delete_tag="";
    public $bool_preview_delete_tag="";
    public $detail_delete_tag="";
    public $bool_detail_delete_tag="";
    public $preview_first_img="";
    public $detail_first_img="";
    public $preview_save_img="";
    public $detail_save_img="";
    public $text = "";
    public $site = "";
    public $link = "";
    public $preview_delete_element="";
    public $detail_delete_element="";
    public $preview_delete_attribute="";
    public $detail_delete_attribute="";
    public $index_element="";
    public $resize_image="";
    public $meta_description="";
    public $meta_keywords="";
    public $meta_description_text="";
    public $meta_keywords_text="";
    public $agent = false;
    public $active_element = "Y";
    public $header_url;
    public $settings;
    public $countPage = 0;
    public $countItem = 0;
    public $stepStart = false;
    public $countSection = 0;

    public $page;
    const TEST = 0;
    const DEFAULT_DEBUG_ITEM = 30;
    public function __construct()
    {
        global $zis, $shs_ID, $shs_TYPE, $shs_ACTIVE, $shs_IBLOCK_ID, $shs_RSS, $shs_SECTION_ID, $shs_SELECTOR, $shs_ENCODING, $shs_PREVIEW_DELETE_TAG, $shs_PREVIEW_TEXT_TYPE, $shs_DETAIL_TEXT_TYPE, $shs_BOOL_PREVIEW_DELETE_TAG,$shs_PREVIEW_FIRST_IMG, $shs_PREVIEW_SAVE_IMG, $shs_DETAIL_DELETE_TAG, $shs_BOOL_DETAIL_DELETE_TAG,$shs_DETAIL_FIRST_IMG, $shs_DETAIL_SAVE_IMG, $shs_PREVIEW_DELETE_ELEMENT, $shs_DETAIL_DELETE_ELEMENT, $shs_PREVIEW_DELETE_ATTRIBUTE, $shs_DETAIL_DELETE_ATTRIBUTE, $shs_INDEX_ELEMENT, $shs_CODE_ELEMENT, $shs_RESIZE_IMAGE, $shs_META_DESCRIPTION, $shs_META_KEYWORDS, $shs_ACTIVE_ELEMENT, $shs_FIRST_TITLE, $shs_DATE_PUBLIC, $shs_FIRST_URL, $shs_DATE_ACTIVE, $shs_META_TITLE, $shs_SETTINGS, $shs_TMP;
        $this->id = $shs_ID;
        $this->typeN = $shs_TYPE;
        $this->rss = $shs_RSS;
        $this->active = $shs_ACTIVE;
        $this->iblock_id = $shs_IBLOCK_ID;
        $this->section_id = $shs_SECTION_ID;
        $this->detail_dom = $shs_SELECTOR;
        $this->first_url = trim($shs_FIRST_URL);
        $this->encoding = $shs_ENCODING;
        $this->preview_text_type = $shs_PREVIEW_TEXT_TYPE;
        $this->detail_text_type = $shs_DETAIL_TEXT_TYPE;
        $this->preview_delete_tag = $shs_PREVIEW_DELETE_TAG;
        $this->detail_delete_tag = $shs_DETAIL_DELETE_TAG;
        $this->bool_preview_delete_tag = $shs_BOOL_PREVIEW_DELETE_TAG;
        $this->bool_detail_delete_tag = $shs_BOOL_DETAIL_DELETE_TAG;
        $this->preview_first_img = $shs_PREVIEW_FIRST_IMG;
        $this->detail_first_img = $shs_DETAIL_FIRST_IMG;
        $this->preview_save_img = $shs_PREVIEW_SAVE_IMG;
        $this->detail_save_img = $shs_DETAIL_SAVE_IMG;
        $this->preview_delete_element = $shs_PREVIEW_DELETE_ELEMENT;
        $this->detail_delete_element = $shs_DETAIL_DELETE_ELEMENT;
        $this->preview_delete_attribute = $shs_PREVIEW_DELETE_ATTRIBUTE;
        $this->detail_delete_attribute = $shs_DETAIL_DELETE_ATTRIBUTE;
        $this->index_element = ($shs_INDEX_ELEMENT=="Y")?true:false;
        $this->code_element = $shs_CODE_ELEMENT;
        $this->resize_image = ($shs_RESIZE_IMAGE=="Y")?true:false;
        $this->meta_title = $shs_META_TITLE;
        $this->meta_description = $shs_META_DESCRIPTION;
        $this->meta_keywords = $shs_META_KEYWORDS;
        $this->active_element = $shs_ACTIVE_ELEMENT;
        $this->first_title = $shs_FIRST_TITLE;
        $this->date_public = $shs_DATE_PUBLIC;
        $this->date_active = $shs_DATE_ACTIVE;
        $this->tmp = $shs_TMP;
        $this->settings = unserialize(base64_decode($shs_SETTINGS));
        $this->header_url = "";
        $this->sleep = (int)$this->settings[$this->typeN]["sleep"];
        $this->proxy = (int)$this->settings[$this->typeN]["proxy"];
        $this->errors = array();
        $this->auth = $this->settings[$this->typeN]["auth"]["active"]?true:false;
        $this->currentPage = 0;
        $this->activeCurrentPage = 0;
        $this->debugErrors = array();
        $this->stepStart = false;
        $this->pagePrevElement = array();
        $this->pagenavigationPrev = array();
        $this->pagenavigation = array();
            
    }

    protected function parseXmlCatalog()
    {   
        set_time_limit(0);
        $this->ClearAjaxFiles(); 
        $this->DeleteLog(); 
        $this->checkActionBegin(); 
        $this->arUrl = array(); 
        if(isset($this->settings["catalog"]["url_dop"]) && !empty($this->settings["catalog"]["url_dop"]))$this->arUrl = explode("\r\n", $this->settings["catalog"]["url_dop"]);
        
        $this->arUrl = array_merge(array($this->rss), $this->arUrl);
        $this->arUrlSave = $this->arUrl;
        
        if(!$this->PageFromFile()) return false; 
        $this->CalculateStep();
        if($this->settings["catalog"]["mode"]!="debug" && !$this->agent) $this->arUrlSave = array($this->rss);
        else $this->arUrlSave = $this->arUrl; 
        //if(!$this->connectCatalogPage($this->rss));
        //return;
        foreach($this->arUrlSave as $rss):
            $rss = trim($rss);
            if(empty($rss)) continue;
            $this->rss = $rss;
            $this->convetCyrillic($this->rss);
            $this->connectCatalogPage($this->rss);
            
            if(!$this->agent && $this->settings["catalog"]["mode"]!="debug" && isset($this->errors) && count($this->errors)>0)
            {
                $this->SaveLog();
                unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_copy_page".$this->id.".txt");
                return false;    
            }
            if ($this->parseCatalogSectionXml($this->rss) === false)
            {
                if ($this->settings["catalog"]["add_parser_section"] == "Y")
                {
                    $this->SaveLog();
                    return false; 
                }   
            }
            $n = $this->currentPage;
            $this->parseCatalogProducts();
            if($this->settings["catalog"]["mode"]!="debug" && !$this->agent)
            {
                $this->stepStart = true;
                $this->SavePrevPage($this->rss);    
            }
         
            $this->SaveCurrentPage($this->pagenavigation);
            if($this->stepStart)
            {
                if(file_exists($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt"))
                    unlink($_SERVER["DOCUMENT_ROOT"].BX_ROOT."/modules/shs.parser/include/count_parser_catalog_step".$this->id.".txt");
                $this->DeleteCopyPage();
            } 
            if((!$this->CheckOnePageNavigation() && $this->agent) || (!$this->CheckOnePageNavigation() && !$this->agent && $this->settings["catalog"]["mode"]=="debug"))$this->parseCatalogPages();
            if($this->CheckOnePageNavigation() && $this->stepStart)
            {
                if($this->IsEndSectionUrl())$this->ClearBufferStop();
                else $this->ClearBufferStep();
                return false;    
            }
        endforeach;
        
        $this->checkActionAgent();
    }
 
    protected function parseCatalogProductElementXml(&$el)
    {
        $this->countItem++;
        $this->parseCatalogSection();
        if(!$this->parserCatalogPreviewXml($el))
        {
            $this->SaveCatalogError();
            $this->clearFields();
            return false;    
        }

        /*$this->parserCatalogDetail();
        $this->parseCatalogSection();
        $this->parseCatalogMeta();
        $this->parseCatalogFirstUrl();*/
        $this->parseCatalogDate();
        $this->parseCatalogAllFields();


        $db_events = GetModuleEvents("shs.parser", "parserBeforeAddElementXml", true);
        $error = false;
        foreach($db_events as $arEvent)
        {
            $bEventRes = ExecuteModuleEventEx($arEvent, array(&$this, &$el));
            if($bEventRes===false)
            {
                $error = true;
                break 1;
            }
        }

        if(!$error && !$error_isad)
        {
            $this->AddElementCatalog();
            foreach(GetModuleEvents("shs.parser", "parserAfterAddElementXml", true) as $arEvent)
                ExecuteModuleEventEx($arEvent, array(&$this, &$el));
        }

        if($this->isCatalog && $this->elementID)
        {   
            /*if($this->isOfferCatalog && !$this->boolOffer)
            {                                  
                $this->AddElementOfferCatalog();
                $this->elementID = $this->elementOfferID;
                $this->elementUpdate = $this->elementOfferUpdate;
            }*/
            if($this->boolOffer)
            {
                $this->addProductPriceOffers();
            }else{
                
                $this->AddProductCatalog();
                $this->AddMeasureCatalog();
                $this->AddPriceCatalog();    
            }
            
        }/*else{
            $this->AddElementOfferCatalog();
            $this->AddProductCatalog();
            $this->AddMeasureCatalog();
            $this->AddPriceCatalog();    
        }*/

        $this->SetCatalogElementsResult();
        $this->clearFields();
        
    }

    protected function parserCatalogPreviewXml(&$el)
    {
        if(!$this->parseCatalogIdElement($el)) return false;
        $this->parseCatalogNamePreview($el);
        //$this->parseCatalogPropertiesPreview($el);
        if($this->isCatalog)$this->parseCatalogPricePreview($el);
        if ($this->settings["catalog"]["add_parser_section"] == "Y") $this->parseCatalogParrentSection($el);
        $this->parseCatalogPreviewPicturePreview($el);
        $this->parseCatalogDetailPicture($el);
        $this->parseCatalogDescriptionXml($el);
        $this->parseCatalogDetailMorePhoto($el);
        $this->parseCatalogPropertiesXml($el);
        $this->parserOffersXml($el);
        
        return true;
    }
    
    protected function parserOffersXml($el)
    {
        $this->boolOffer = false;
        if($this->settings["offer"]["load"]=="table" && $this->isOfferParsing && isset($this->settings["offer"]["selector_item"]) && $this->settings["offer"]["selector_item"])
        {
            $this->parserOffersXmlTable($el);
        }elseif($this->settings["offer"]["load"]=="one" && $this->isOfferParsing && isset($this->settings["offer"]["one"]["selector"]) && $this->settings["offer"]["one"]["selector"])
        {
            $this->parserOffersOne($el);
        }
    
    }
    
    protected function parserOffersXmlTable(&$el)
    {
       $offerItem = $this->settings["offer"]["selector_item"];

       foreach(pq($el)->find($offerItem) as $offer)
       {
            $this->boolOffer = true;
            if($this->parseOfferName($offer))
            {
                $this->parseOfferPrice($offer);
                $this->parseOfferPropsXml($offer);
                if(!$this->parseOfferGetUniq())
                {
                    $this->deleteOfferFields();;
                    continue 1;
                }

            }else
                continue 1;

            $this->arOfferAll["FIELDS"][] = $this->arOffer;
            $this->arOfferAll["PRICE"][] = $this->arPriceOffer;

            $this->deleteOfferFields();
                
       }
    }
    
    protected function parserOffersOne(&$el)
    {
        $offerItem = trim($this->settings["offer"]["one"]["selector"]);
        foreach(pq($el)->find($offerItem) as $offer)
        {
            if (empty($this->settings["offer"]["one"]["separator"])){   
                $this->boolOffer = true;
                if($this->parseOfferNameOneXml($offer))
                {
                    $this->parseOfferPrice($offer);
                    $this->parseOfferProps($offer);
                    if(!$this->parseOfferGetUniq())
                    {
                        $this->deleteOfferFields();;
                        continue 1;
                    }

                }else
                    continue 1;

                $this->arOfferAll["FIELDS"][] = $this->arOffer;
                $this->arOfferAll["PRICE"][] = $this->arPriceOffer;
                $this->deleteOfferFields(); 
            }
            elseif(!empty($this->settings["offer"]["one"]["separator"])){
                if(is_array($arrOffers = $this->GetArrayNameOffes($offer)))
                {
                    foreach($arrOffers as $nameOffer)
                    {
                        if(empty($nameOffer)) continue 1;
                        $this->boolOffer = true;
                        if($this->parseOfferNameOneXml($offer, $nameOffer))
                        {
                            $this->parseOfferPrice($offer);
                            $this->parseOfferProps($offer, $nameOffer);
                            if(!$this->parseOfferGetUniq())
                            {
                                $this->deleteOfferFields();;
                                continue 1;
                            }
                        }else
                            continue 1;
                        $this->arOfferAll["FIELDS"][] = $this->arOffer;
                        $this->arOfferAll["PRICE"][] = $this->arPriceOffer;
                        $this->deleteOfferFields();
                    }
                }   
            } 
        }
    }

    protected function parseOfferNameOneXml($offer, $nameOffer=false)
    {
        if(!empty($this->settings["offer"]["one"]["selector"]) && !empty($this->settings["offer"]["add_name"]))
        {
            if ($nameOffer === false)
            {
                $arr = $this->GetArraySrcAttr($this->settings["offer"]["selector_name"]);
                if (empty($arr["path"]) && !empty($arr["attr"]))
                {
                    $name = trim(pq($offer)->attr($arr["attr"]));
                }
                else{
                    if(empty($arr["attr"])){
                        $name = trim(strip_tags(pq($offer)->find($arr["path"])->html()));
                    }
                    elseif(!empty($arr["attr"]))
                    {
                        $name = trim(pq($offer)->find($arr["path"])->attr($arr["attr"]));
                    }
                } 
            } 
            elseif ($nameOffer !== false)
            {
                $name =  $nameOffer;  
            } 
            $deleteSymb = $this->getOfferDeleteSelector();
            $name = str_replace($deleteSymb, "", $name);
            $this->arOffer["NAME"] = htmlspecialchars_decode($name);
            if(isset($this->settings["loc"]["f_name"]) && $this->settings["loc"]["f_name"]=="Y")
            {
                $this->arOffer["NAME"] = $this->locText($this->arOffer["NAME"]);    
            }
        }
        if(!isset($this->arOffer["NAME"]) && (!isset($this->settings["offer"]["add_name"]) || empty($this->settings["offer"]["add_name"])))
        {
            $this->errors[] = GetMessage("parser_error_name_notfound_offer");
            return false;
        }elseif(!isset($this->arOffer["NAME"]))
            $this->arOffer["NAME"] = $this->arFields["NAME"];     
        
        return true;
        
    }
    
    protected function GetArrayNameOffes($offer)
    {
        $arr = $this->GetArraySrcAttr($this->settings["offer"]["selector_name"]);
        if(empty($arr["path"]) && !empty($arr["attr"]))
        {
            $name = trim(pq($offer)->attr($arr["attr"]));
        }
        else{
            if(empty($arr["attr"])){
                $name = trim(strip_tags(pq($offer)->find($arr["path"])->html()));
            }
            elseif(!empty($arr["attr"]))
            {
                $name = trim(pq($offer)->find($arr["path"])->attr($arr["attr"]));
            }
        } 
        
        $arrName = explode($this->settings["offer"]["one"]["separator"], $name);
        for($i = 0; $i < count($arrName); $i++)
        {
            $arrName[$i] = trim($arrName[$i]);
        }
        return $arrName;
    }
    
    protected function parseOfferPropsXml($offer)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        if(isset($this->settings["offer"]["selector_prop"]) && !empty($this->settings["offer"]["selector_item"]))
        {
            $deleteSymb = $this->getOfferDeleteSelector();
            $deleteSymbRegular = $this->getOfferDeleteSelectorRegular();
            
            $arProperties = $this->arSelectorPropertiesOffer;
            
            foreach($arProperties as $code=>$val)
            {
                $arProp = $this->arPropertiesOffer[$code];
                if($arProp["PROPERTY_TYPE"]=="F")
                {
                    $this->parseCatalogPropFile($code, $offer);
                }else{
                    
                    $arr = $this->GetArraySrcAttr($this->settings["offer"]["selector_prop"][$code]);
                    if (empty($arr["path"]) && !empty($arr["attr"]))
                    {
                        $text = trim(pq($offer)->attr($arr["attr"]));
                    }
                    else{
                        if(empty($arr["attr"])){
                            $text = trim(strip_tags(pq($offer)->find($arr["path"])->html()));
                        }
                        elseif (!empty($arr["attr"]))
                        {
                            $text = trim(pq($offer)->find($arr["path"])->attr($arr["attr"]));
                        }
                    }
                    if($arProp["USER_TYPE"]!="HTML")
                        $text = strip_tags($text);
                    $text = str_replace($deleteSymb, "", $text);
                    $text = preg_replace($deleteSymbRegular, "", $text);
                    $this->parseCatalogPropOffer($code, $val, $text);
                }

            }
                
        }
    }
    
    protected function parseCatalogPropertiesXml(&$el)
    {
        if($this->checkUniq() && !$this->isUpdate) return false;
        $this->parseCatalogDefaultProperties($el);
        $this->parseCatalogSelectorProperties($el);
        $this->parseCatalogAutoProps($el);
        $this->parseCatalogAutoPropsAdd();
        $this->AllDoProps();
        if($this->isCatalog)$this->parseCatalogFindProduct($el);
        if($this->isCatalog)$this->parseCatalogSelectorProduct($el);
    }

    protected function parseCatalogAutoProps(&$el)
    {
        if($this->checkUniq() && (!$this->isUpdate || !$this->isUpdate["props"])) return false;
        elseif (($this->settings["catalog"]["add_auto_props"] != "Y") && empty($this->settings["catalog"]["selector_find_props"]) && empty($this->settings["catalog"]["attr_auto_props"])) return false;
        $props = $this->settings["catalog"]["selector_find_props"];
        $props_name = $this->GetArraySrcAttr($this->settings["catalog"]["attr_auto_props"]);
        $arr_val = $this->GetArraySrcAttr($this->settings["catalog"]["selector_attr_value_auto_props"]);
        
        foreach(pq($el)->find($props) as $property)
        {
            $isset_props = false;
            
            if(empty($props_name["path"])){
                $name = trim(pq($property)->attr($props_name["attr"])); //name props
            }
            else{
                if(empty($props_name["attr"]))
                {
                    $name = trim(strip_tags(pq($property)->find($props_name["path"])->html()));
                }
                elseif(!empty($props_name["attr"]))
                {
                    $name = trim(pq($property)->find($props_name["path"])->attr($props_name["attr"]));
                }
            }
               
            if (empty($name)) continue 1;
            
            if (empty($arr_val["path"]) && empty($arr_val["attr"]))
            {
                $value = trim(pq($property)->text());
            }
            elseif(empty($arr_val["path"]) && !empty($arr_val["attr"]))
            {
                $value = trim(pq($property)->attr($arr_val["attr"]));
            }
            else
            {
                if(empty($arr_val["attr"]))
                {
                    $value = strip_tags(trim(pq($property)->find($arr_val["path"])->html()));
                }
                elseif(!empty($arr_val["attr"]))
                {
                    $value = trim(pq($property)->find($arr_val["path"])->attr($arr_val["attr"]));
                }
            }
            
            $isset_props = $this->issetPropsForName($name);
            if (!$isset_props)
            {
                $error = $this->addAutoProps($name);
                if ($error !== false)
                {
                    $db_props = CIBlockProperty::GetByID($error, $this->iblock_id, false);
                    $code_props = $db_props->GetNext();
                    if(!isset($this->arProperties[$code_props["CODE"]]) || empty($this->arProperties[$code_props["CODE"]]))
                    {
                        $this->arProperties[$code_props["CODE"]] = $code_props;
                    }
                    if (!isset($this->arPropertiesParseAuto[$code_props["CODE"]]) || empty($this->arPropertiesParseAuto[$code_props["CODE"]]))
                    {
                        $this->arPropertiesParseAuto[$code_props["CODE"]] = $value;
                    }
                }
            }
            if($isset_props)
            {
                foreach($isset_props as $code => $props)
                {
                    if(!isset($this->arProperties[$code]) || empty($this->arProperties[$code]))
                    {
                        $this->arProperties[$code] = $props;
                    }
                    if (!isset($this->arPropertiesParseAuto[$code]) || empty($this->arPropertiesParseAuto[$code]))
                    {
                        $this->arPropertiesParseAuto[$code] = $value;
                    }
                }
            }
           
        }
        
    }
    
    protected function parseCatalogAutoPropsAdd()
    {
        $arProperties = $this->arPropertiesParseAuto;
        if(!$arProperties) return false;
        if($this->settings["catalog"]["catalog_delete_selector_find_props_symb"])
        {
            $deleteSymb = explode(",", $this->settings["catalog"]["catalog_delete_selector_find_props_symb"]);

            foreach($deleteSymb as $i=>&$symb)
            {
                $symb = trim($symb);
                $symb = htmlspecialcharsBack($symb);
                if(empty($symb))
                {
                    unset($deleteSymb[$i]);
                    continue;
                }
                if($symb=="\\\\")
                {
                    $deleteSymb[$i] = ",";
                }

            }
        }
        foreach($arProperties as $code => $value)
        {
            $arProp = $this->arProperties[$code];
            if(($arProp["PROPERTY_TYPE"] == "S") || ($arProp["PROPERTY_TYPE"] == "L") || ($arProp["PROPERTY_TYPE"] == "N")) 
            {   
                $text = $value;
                if($arProp["USER_TYPE"]!="HTML")
                    $text = strip_tags($value);
                $text = str_replace($deleteSymb, "", $text);
                $this->parseCatalogPropAuto($code, $text);
            }
        }
    }
    
    public function parseCatalogPropAuto($code, $val)
    {
        if(empty($code)) return false;
        $val = html_entity_decode($val);
        $arProp = $this->arProperties[$code];
        //$default = $this->settings["catalog"]["default_prop"][$code];
        
        if($arProp["PROPERTY_TYPE"]!="N" && isset($this->settings["loc"]["f_props"]) && $this->settings["loc"]["f_props"])
            $val = $this->locText($val, $arProp["USER_TYPE"]=="HTML"?"html":"plain");
        
        if($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }elseif($arProp["USER_TYPE"]=="HTML" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = Array("VALUE" => Array ("TEXT" => $val, "TYPE" => "html"));
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsDirectory($arProp, $code, $val);;
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y" && $arProp["USER_TYPE"]=="directory")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsDirectory($arProp, $code, $val);;    
        }
        elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]!="Y")
        {
            $val = $this->actionFieldProps($code, $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;
        }elseif($arProp["PROPERTY_TYPE"]=="S" && $arProp["MULTIPLE"]=="Y")
        {
            $val = $this->actionFieldProps($code, $val);
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $val;
        }
        elseif($arProp["PROPERTY_TYPE"]=="N")
        {
            $val =  str_replace(",", ".", $val);
            $val = preg_replace("/\.{1}$/", "", $val);
            $val = preg_replace('/[^0-9.]/', "", $val);
            $this->arFields["PROPERTY_VALUES"][$code] = $val;    

        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]!="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsL($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="L" && $arProp["MULTIPLE"]=="Y")
        {
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsL($arProp["ID"], $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]!="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code] = $this->CheckPropsE($arProp, $code, $val);
        }elseif($arProp["PROPERTY_TYPE"]=="E" && $arProp["MULTIPLE"]=="Y")
        {   
            $this->arFields["PROPERTY_VALUES"][$code]["n0"] = $this->CheckPropsE($arProp, $code, $val);
        }
    }
    
    protected function addAutoProps($setting) //add auto props
    {
        if (empty($setting)) return false;
        $CODE = strtoupper(CUtil::translit($setting, "ru", array(
                        "max_len" => 100,
                        "change_case" => 'S', // 'L' - toLower, 'U' - toUpper, false - do not change
                        "replace_space" => '_',
                        "replace_other" => '_',
                        "delete_repeat_replace" => true,
          )));
        $arFields = Array(
          "NAME" => $setting,
          "ACTIVE" => "Y",
          "SORT" => "100",
          "CODE" => $CODE,
          "PROPERTY_TYPE" => $this->settings["catalog"]["type_auto_props"],
          "IBLOCK_ID" => $this->iblock_id
          );
          $ibp = new CIBlockProperty;
          $PropID = $ibp->Add($arFields);
          if ($PropID) return $PropID;
          else 
          {
              $this->errors[] = "[".$setting."]".$ibp->LAST_ERROR;
              return false;
          }
    }
    
    protected function issetPropsForName($name) //search props for name
    {
        if (empty($name)) return true;
        $property = CIBlockProperty::GetList(Array("sort"=>"asc", "name"=>"asc"), Array("ACTIVE"=>"Y", "IBLOCK_ID"=>$this->iblock_id, "?PROPERTY_TYPE" => "S || N || L", "NAME" => $name));
        $prors = array();
        while($prop = $property->Fetch())
        {
             $prors[$prop["CODE"]] = $prop;
        }
        if($property)
        {
            return $prors;
        }
        if(!$property) return false;
    }
  
    protected function parseCatalogIdElement($el)
    {   
        $id_element = $this->settings["catalog"]["id_selector"];
        
        $ar = $this->GetArraySrcAttr($id_element);
        $selector = $ar["path"];
        $attr = $ar["attr"];
        if (empty($id_element)) return false;
        if ($selector == "")
        {
            $p = trim(pq($el)->attr($attr));
        }
        else{
            if(!empty($attr)) 
            {
                $p = trim(pq($el)->find($selector)->attr($attr)); 
            }
            elseif(empty($attr))
            {
                $p = strip_tags((pq($el)->find($selector)->html())); 
            }
        }
        if(!$p)
        { 
            $this->errors[] = GetMessage("parser_error_id_element_notfound");
            return false;
        }
        $this->arFields["LINK"] = $p;
        return true;
    }
    
    protected function parseCatalogParrentSection(&$el)
    {
        if (($this->settings["catalog"]["add_parser_section"] == "N") || empty($this->settings["catalog"]["id_section"])) return false;
        $ar = $this->GetArraySrcAttr($this->settings["catalog"]["id_section"]);
        $selector = $ar["path"];
        $attr = $ar["attr"];
        
        if($selector == ""){
            $parrent_id = trim(pq($el)->attr($attr));
        }
        else
        {
            if(empty($attr)) $parrent_id = trim(strip_tags(pq($el)->find($selector)->html()));
            elseif(!empty($attr)) $parrent_id = trim(pq($el)->find($selector)->attr());
        }
        /*$parrent_id = trim($this->settings["catalog"]["id_section"]);
        $parrent_id = trim(pq($el)->find($parrent_id)->text());*/
        if(empty($parrent_id)) return false;
        elseif (!empty($parrent_id)) $parrent_id = $this->issetSectionCatalog($parrent_id);
        if($parrent_id !== false)
        {
            $this->arFields["IBLOCK_SECTION_ID"] = $parrent_id;
        }
    }

    protected function parseCatalogSectionXml($pageHref)
    {   
        $this->html = phpQuery::newDocument($this->page);
        $this->base = $this->GetMetaBase($this->html);
        if ($this->settings["catalog"]["add_parser_section"] !== "Y") return false;
        if (empty($this->settings['catalog']['selector_category']))
        {   
            $this->errors[] = GetMessage("parser_no_selector_category");
            return false;
        }
        $arr = $this->GetArrSectionXml();
        if ($arr !== false)
        {
            $new_section_arr = $this->GetTreeArrSectionXml($arr);
        }
        if(is_array($new_section_arr))
        {
            if($this->settings["catalog"]["field_id_category"] == "EXT_FIELD")
            {
                $this->AddExtFieldSection();
            }
            $this->addAllSectionXml($new_section_arr);
        }
    }
    
    protected function GetArrSectionXml()
    {
        if(empty($this->settings['catalog']['selector_category'])) return false;
        
        $arr_section = $this->html->find($this->settings['catalog']['selector_category']);
        $arr = array();
        $arr_id = $this->GetArraySrcAttr($this->settings['catalog']["attr_id_category"]);
        $arr_name = $this->GetArraySrcAttr($this->settings['catalog']["attr_category"]);
        $arr_parent = $this->GetArraySrcAttr($this->settings['catalog']["attr_id_parrent_category"]);
        
        
        foreach ($arr_section as $el_section)
        {
            if ($arr_id['path'] == "")
            {
                $section_id = trim(pq($el_section)->attr($arr_id['attr']));
            } 
            else{
                if(!empty($arr_id['attr'])) $section_id = trim(pq($el_section)->find($arr_id['path'])->attr($arr_id['attr']));
                elseif(empty($arr_id['attr']))
                {
                    $section_id = trim(pq($el_section)->find($arr_id['path'])->html());
                    $section_id = trim(strip_tags($section_id));
                }
            }  
            if (empty($section_id))
            {
                continue 1; 
            }
            if ($arr_parent["path"] == "") 
            {
                $parentId = trim(pq($el_section)->attr($arr_parent["attr"]));
            }
            else{
                if (!empty($arr_parent["attr"])) $parentId = trim(pq($el_section)->find($arr_parent["path"])->attr($arr_parent["attr"]));
                elseif(empty($arr_parent["attr"])) {
                    $parentId = trim(pq($el_section)->find($arr_parent["path"])->html());
                    $parentId = trim(strip_tags($parentId));
                }
                 
            }
            if (!isset($parentId) || empty($parentId)) $parentId = 0;
            
            if(empty($this->settings['catalog']["attr_category"]))
            {
                $arr[$section_id]['text'] = strip_tags(trim(pq($el_section)->html()));
            }
            elseif(!empty($this->settings['catalog']["attr_category"]))
            {
                if (!empty($arr_name['attr'])) 
                {
                    $arr[$section_id]['text'] = trim(pq($el_section)->find($arr_name["path"])->attr($arr_name["attr"]));
                }
                elseif(empty($arr_name['attr']))
                {
                    $arr[$section_id]['text'] = strip_tags(trim(pq($el_section)->find($arr_name["path"])->html()));
                }
            }
            $arr[$section_id]['parentId'] = $parentId;
        }
        
        ksort($arr);
        return $arr;
    }
    
    protected function GetTreeArrSectionXml($arr)
    {
        if (!is_array($arr)) return false;
        
        $new_section_arr = array();
        foreach ($arr as $key => $value) 
        {
            if (!isset($new_section_arr[$value['parentId']]) || empty($new_section_arr[$value['parentId']]))
                $new_section_arr[$value['parentId']]['text'] = $arr[$value['parentId']]['text']; 
        }
        
        foreach ($arr as $k => $v)
        {
            $new_section_arr[$v['parentId']][$k]['text'] = $v['text'];
        }
        ksort($new_section_arr);
        return $new_section_arr;
    }
    
    protected function addAllSectionXml($arr)
    {                    
        if (empty($arr)) return false;
        foreach ($arr as $id => $val)
        {
            $section_title =  $arr[$id]['text'];
            if (empty($section_title) && ($id != 0))
            {
                continue;
            } 
            elseif ($id == 0) $parrent_section = $this->section_id;
            elseif ($id != 0) $parrent_section = $this->issetSectionCatalog($id); 
            
            if (($this->issetSectionCatalog($id) === false) && ($id != 0))
            {
                $this->addSectionXlm(array("id_section" => $id, "text_section" => $section_title, "id_parrent" => $parrent_section));
            }
            foreach ($val as $key => $text)
            {  
                if($key !== "text")
                {
                   if (($this->issetSectionCatalog($key) === false) && $parrent_section !== false)
                   {
                       $this->addSectionXlm(array("id_section" => $key, "text_section" => $text["text"], "id_parrent" => $parrent_section));
                   } 
                }
            }           
        }
    }
    
    protected function addSectionXlm($settings)
    {
        if (empty($settings) || !is_array($settings)) return false;
        $new_section = new CIBlockSection;
        $arFields = $this->GetArrFieldsSection($settings);
        $ID = $new_section->Add($arFields);
        if ($ID !== false)
        {   
            $this->countSection ++; 
        } 
        elseif ($ID === false)
        {
            $this->errors[] = $new_section->LAST_ERROR;
        } 
    }
    
    protected function GetArrFieldsSection($settings)
    {
        $code = $this->GetCodeSection($settings["text_section"]);
         $arFields = Array(
              "ACTIVE" => "Y",
              "CODE" => $code,
              "IBLOCK_SECTION_ID" => $settings["id_parrent"],
              "IBLOCK_ID" => $this->iblock_id,
              "NAME" => $settings["text_section"],
              "DESCRIPTION" => GetMessage("parser_add_category_description"),
              "DESCRIPTION_TYPE" => "text"
        );
        if ($this->settings["catalog"]["field_id_category"] == "XML_ID")
        {
            $arFields["XML_ID"] = "shs_".md5($this->rss)."_".$settings["id_section"];
        }
        elseif ($this->settings["catalog"]["field_id_category"] == "EXT_FIELD")
        {
            $arFields["UF_SHS_PARSER"] = "shs_".md5($this->rss)."_".$settings["id_section"];
        }
        return $arFields;
    }
    
    protected function GetCodeSection($settings)
    {
        $code = CUtil::translit($settings, "ru", array("max_len" => 100, "change_case" => 'L', "replace_space" => '_', "replace_other" => '_', "delete_repeat_replace" => true));
        $db_section = CIBlockSection::GetList(Array("SORT"=>"ASC"), array("%CODE" => $code, "IBLOCK_ID" => $this->iblock_id) , false, Array("ID"), false);
        $i = 0;
        while($res = $db_section->Fetch())
        {
            $i++;
        }
        if($i == 0) return $code;
        else return $code."_".$i++;
    }
    
    protected function AddExtFieldSection()
    {
        $arFields = Array(
            "ENTITY_ID" => "IBLOCK_".$this->iblock_id."_SECTION",
            "FIELD_NAME" => "UF_SHS_PARSER",
            "USER_TYPE_ID" => "string",
            "EDIT_FORM_LABEL" => Array("ru"=>GetMessage("EDIT_FORM_LABEL_RU"), "en"=>GetMessage("EDIT_FORM_LABEL_EN"))
            );
        $obUserField  = new CUserTypeEntity;
        $obUserField->Add($arFields);
    }
    
    protected function issetSectionCatalog($settings)
    {                       
        if (empty($settings)) return false;
        $arFilter = $this->GetArrFilterSection($settings);
        if (!is_array($arFilter)) return false;
        $db_section = CIBlockSection::GetList(Array("SORT"=>"ASC"), $arFilter, false, Array("ID", "XML_ID", "UF_SHS_PARSER"), false);
        $id_section = $db_section->Fetch();
        if ($id_section) return $id_section["ID"];
        else return false;
    }
    
    protected function GetArrFilterSection($settings)
    {
        if ($this->settings["catalog"]["field_id_category"] == "XML_ID")
        {
            $arFilter = Array('IBLOCK_ID'=>$this->iblock_id, '=XML_ID'=>"shs_".md5($this->rss)."_".$settings);  
        }
        elseif ($this->settings["catalog"]["field_id_category"] == "EXT_FIELD") 
        {
            $arFilter = Array('IBLOCK_ID'=>$this->iblock_id, '=UF_SHS_PARSER'=>"shs_".md5($this->rss)."_".$settings);  
        }
        return $arFilter;
    }
    
    protected function parseCatalogDescriptionXml(&$el)
    {
        if($this->checkUniq() && (!$this->isUpdate || (!$this->isUpdate["detail_descr"] && (!$this->isUpdate["preview_descr"] && !$this->settings["catalog"]["text_preview_from_detail"]!="Y")))) return false;
        if($this->settings["catalog"]["detail_text_selector"])
        {
            $detail = $this->settings["catalog"]["detail_text_selector"];
            
            $arDetail = explode(",", $detail);
            $detail_text = "";
            if($arDetail && !empty($arDetail))
            {
                foreach($arDetail as $detail)
                {
                    $detail = trim($detail);
                    if(!$detail) continue 1;

                    foreach(pq($el)->find($detail." img") as $img)
                    {
                        $src = pq($img)->attr("src");
                        $src = $this->parseCaralogFilterSrc($src);
                        $src = $this->getCatalogLink($src);
                        $this->parseCatalogSaveImgServer($img, $src);
                    }
                    
                    $arr = $this->GetArraySrcAttr($detail);
                    $path = $arr["path"];
                    $attr = $arr["attr"];
                    if(empty($attr))
                        $detail_text .= pq($el)->find($path)->html();
                    elseif(!empty($attr))
                        $detail_text .= pq($el)->find($path)->attr($attr);

                }
            }

            $detail_text = trim($detail_text);
            if(isset($this->settings["loc"]["f_detail_text"]) && $this->settings["loc"]["f_detail_text"]=="Y")
            {
                $detail_text = $this->locText($detail_text, $this->detail_text_type=="html"?"html":"plain");    
            }
            $this->arFields["DETAIL_TEXT"] = $detail_text;
            $this->arFields["DETAIL_TEXT_TYPE"] = $this->detail_text_type;
            if($this->settings["catalog"]["text_preview_from_detail"]=="Y")
            {
                $this->arFields["PREVIEW_TEXT"] = $this->arFields["DETAIL_TEXT"];
                $this->arFields["PREVIEW_TEXT_TYPE"] = $this->arFields["DETAIL_TEXT_TYPE"];
            }
        }
    }
    
    protected function ValidateUrl($url)
    {
        if (preg_match("/^(http|https)?(:\/\/)?([A-Z0-9][A-Z0-9_-]*(?:.[A-Z0-9][A-Z0-9_-]*)+):?(d+)?\/?/Diu", $url))
        {
           return true; 
        }
        else 
        {
            return false;
        }
    }

}
?>43   98|/shs.parser/install/version.php|661f5e08<?
$arModuleVersion = array(
	"VERSION" => "5.4.4",
	"VERSION_DATE" => "2016-02-17 21:48:15"
);
?>RTIBE